{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:google-vision/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:google-vision/server/googlevision.js","meteor://ðŸ’»app/packages/rocketchat:google-vision/server/models/Messages.js"],"names":["Meteor","startup","RocketChat","settings","add","type","group","section","enableQuery","_id","value","multiline","hidden","blocked","GoogleVision","storage","Npm","require","vision","storageClient","visionClient","enabled","get","serviceAccount","key","JSON","parse","credentials","e","callbacks","blockUnsafeImages","bind","priority","MEDIUM","remove","annotate","incCallCount","count","currentMonth","Date","getMonth","maxMonthlyCalls","set","models","Settings","update","$inc","message","file","Uploads","findOne","indexOf","store","GoogleStorage","bucket","bucketFile","path","results","wrapAsync","detectSafeSearch","adult","FileUpload","getStore","deleteById","user","Users","findOneById","u","Notifications","notifyUser","Random","id","rid","ts","msg","TAPi18n","__","language","Error","console","error","visionTypes","push","length","detect","bindEnvironment","Messages","setGoogleVisionData","getAnnotations","trace","stack","visionData","_visionData","index","hasOwnProperty","concat","messageId","updateObj","$set"],"mappings":"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","file":"/packages/rocketchat_google-vision.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.add('GoogleVision_Enable', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tpublic: true,\n\t\tenableQuery: { _id: 'FileUpload_Storage_Type', value: 'GoogleCloudStorage' }\n\t});\n\tRocketChat.settings.add('GoogleVision_ServiceAccount', '', {\n\t\ttype: 'string',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tmultiline: true,\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Max_Monthly_Calls', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Current_Month', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\thidden: true\n\t});\n\tRocketChat.settings.add('GoogleVision_Current_Month_Calls', 0, {\n\t\ttype: 'int',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tblocked: true\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Document', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Faces', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Landmarks', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Labels', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Logos', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Properties', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_SafeSearch', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n\tRocketChat.settings.add('GoogleVision_Block_Adult_Images', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: [{ _id: 'GoogleVision_Enable', value: true }, { _id: 'GoogleVision_Type_SafeSearch', value: true }]\n\t});\n\tRocketChat.settings.add('GoogleVision_Type_Similar', false, {\n\t\ttype: 'boolean',\n\t\tgroup: 'FileUpload',\n\t\tsection: 'Google Vision',\n\t\tenableQuery: { _id: 'GoogleVision_Enable', value: true }\n\t});\n});\n","class GoogleVision {\n\tconstructor() {\n\t\tthis.storage = Npm.require('@google-cloud/storage');\n\t\tthis.vision = Npm.require('@google-cloud/vision');\n\t\tthis.storageClient = {};\n\t\tthis.visionClient = {};\n\t\tthis.enabled = RocketChat.settings.get('GoogleVision_Enable');\n\t\tthis.serviceAccount = {};\n\t\tRocketChat.settings.get('GoogleVision_Enable', (key, value) => {\n\t\t\tthis.enabled = value;\n\t\t});\n\t\tRocketChat.settings.get('GoogleVision_ServiceAccount', (key, value) => {\n\t\t\ttry {\n\t\t\t\tthis.serviceAccount = JSON.parse(value);\n\t\t\t\tthis.storageClient = this.storage({ credentials: this.serviceAccount });\n\t\t\t\tthis.visionClient = this.vision({ credentials: this.serviceAccount });\n\t\t\t} catch (e) {\n\t\t\t\tthis.serviceAccount = {};\n\t\t\t}\n\t\t});\n\t\tRocketChat.settings.get('GoogleVision_Block_Adult_Images', (key, value) => {\n\t\t\tif (value) {\n\t\t\t\tRocketChat.callbacks.add('beforeSaveMessage', this.blockUnsafeImages.bind(this), RocketChat.callbacks.priority.MEDIUM, 'googlevision-blockunsafe');\n\t\t\t} else {\n\t\t\t\tRocketChat.callbacks.remove('beforeSaveMessage', 'googlevision-blockunsafe');\n\t\t\t}\n\t\t});\n\t\tRocketChat.callbacks.add('afterFileUpload', this.annotate.bind(this));\n\t}\n\n\tincCallCount(count) {\n\t\tconst currentMonth = new Date().getMonth();\n\t\tconst maxMonthlyCalls = RocketChat.settings.get('GoogleVision_Max_Monthly_Calls') || 0;\n\t\tif (maxMonthlyCalls > 0) {\n\t\t\tif (RocketChat.settings.get('GoogleVision_Current_Month') !== currentMonth) {\n\t\t\t\tRocketChat.settings.set('GoogleVision_Current_Month', currentMonth);\n\t\t\t\tif (count > maxMonthlyCalls) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else if (count + (RocketChat.settings.get('GoogleVision_Current_Month_Calls') || 0) > maxMonthlyCalls) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\tRocketChat.models.Settings.update({ _id: 'GoogleVision_Current_Month_Calls' }, { $inc: { value: count } });\n\t\treturn true;\n\t}\n\n\tblockUnsafeImages(message) {\n\t\tif (this.enabled && this.serviceAccount && message && message.file && message.file._id) {\n\t\t\tconst file = RocketChat.models.Uploads.findOne({ _id: message.file._id });\n\t\t\tif (file && file.type && file.type.indexOf('image') !== -1 && file.store === 'GoogleCloudStorage:Uploads' && file.GoogleStorage) {\n\t\t\t\tif (this.incCallCount(1)) {\n\t\t\t\t\tconst bucket = this.storageClient.bucket(RocketChat.settings.get('FileUpload_GoogleStorage_Bucket'));\n\t\t\t\t\tconst bucketFile = bucket.file(file.GoogleStorage.path);\n\t\t\t\t\tconst results = Meteor.wrapAsync(this.visionClient.detectSafeSearch, this.visionClient)(bucketFile);\n\t\t\t\t\tif (results && results.adult === true) {\n\t\t\t\t\t\tFileUpload.getStore('Uploads').deleteById(file._id);\n\t\t\t\t\t\tconst user = RocketChat.models.Users.findOneById(message.u && message.u._id);\n\t\t\t\t\t\tif (user) {\n\t\t\t\t\t\t\tRocketChat.Notifications.notifyUser(user._id, 'message', {\n\t\t\t\t\t\t\t\t_id: Random.id(),\n\t\t\t\t\t\t\t\trid: message.rid,\n\t\t\t\t\t\t\t\tts: new Date,\n\t\t\t\t\t\t\t\tmsg: TAPi18n.__('Adult_images_are_not_allowed', {}, user.language)\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthrow new Meteor.Error('GoogleVisionError: Image blocked');\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error('Google Vision: Usage limit exceeded');\n\t\t\t\t}\n\t\t\t\treturn message;\n\t\t\t}\n\t\t}\n\t}\n\n\tannotate({ message }) {\n\t\tconst visionTypes = [];\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Document')) {\n\t\t\tvisionTypes.push('document');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Faces')) {\n\t\t\tvisionTypes.push('faces');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Landmarks')) {\n\t\t\tvisionTypes.push('landmarks');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Labels')) {\n\t\t\tvisionTypes.push('labels');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Logos')) {\n\t\t\tvisionTypes.push('logos');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Properties')) {\n\t\t\tvisionTypes.push('properties');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_SafeSearch')) {\n\t\t\tvisionTypes.push('safeSearch');\n\t\t}\n\t\tif (RocketChat.settings.get('GoogleVision_Type_Similar')) {\n\t\t\tvisionTypes.push('similar');\n\t\t}\n\t\tif (this.enabled && this.serviceAccount && visionTypes.length > 0 && message.file && message.file._id) {\n\t\t\tconst file = RocketChat.models.Uploads.findOne({ _id: message.file._id });\n\t\t\tif (file && file.type && file.type.indexOf('image') !== -1 && file.store === 'GoogleCloudStorage:Uploads' && file.GoogleStorage) {\n\t\t\t\tif (this.incCallCount(visionTypes.length)) {\n\t\t\t\t\tconst bucket = this.storageClient.bucket(RocketChat.settings.get('FileUpload_GoogleStorage_Bucket'));\n\t\t\t\t\tconst bucketFile = bucket.file(file.GoogleStorage.path);\n\t\t\t\t\tthis.visionClient.detect(bucketFile, visionTypes, Meteor.bindEnvironment((error, results) => {\n\t\t\t\t\t\tif (!error) {\n\t\t\t\t\t\t\tRocketChat.models.Messages.setGoogleVisionData(message._id, this.getAnnotations(visionTypes, results));\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.trace('GoogleVision error: ', error.stack);\n\t\t\t\t\t\t}\n\t\t\t\t\t}));\n\t\t\t\t} else {\n\t\t\t\t\tconsole.error('Google Vision: Usage limit exceeded');\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tgetAnnotations(visionTypes, visionData) {\n\t\tif (visionTypes.length === 1) {\n\t\t\tconst _visionData = {};\n\t\t\t_visionData[`${ visionTypes[0] }`] = visionData;\n\t\t\tvisionData = _visionData;\n\t\t}\n\t\tconst results = {};\n\t\tfor (const index in visionData) {\n\t\t\tif (visionData.hasOwnProperty(index)) {\n\t\t\t\tswitch (index) {\n\t\t\t\t\tcase 'faces':\n\t\t\t\t\tcase 'landmarks':\n\t\t\t\t\tcase 'labels':\n\t\t\t\t\tcase 'similar':\n\t\t\t\t\tcase 'logos':\n\t\t\t\t\t\tresults[index] = (results[index] || []).concat(visionData[index] || []);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'safeSearch':\n\t\t\t\t\t\tresults['safeSearch'] = visionData['safeSearch'];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 'properties':\n\t\t\t\t\t\tresults['colors'] = visionData[index]['colors'];\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn results;\n\t}\n}\n\nRocketChat.GoogleVision = new GoogleVision;\n","RocketChat.models.Messages.setGoogleVisionData = function(messageId, visionData) {\n\tconst updateObj = {};\n\tfor (const index in visionData) {\n\t\tif (visionData.hasOwnProperty(index)) {\n\t\t\tupdateObj[`attachments.0.${ index }`] = visionData[index];\n\t\t}\n\t}\n\n\treturn this.update({ _id: messageId }, { $set: updateObj });\n};\n"]}