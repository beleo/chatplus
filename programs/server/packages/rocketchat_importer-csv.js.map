{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:importer-csv/server.js","meteor://ðŸ’»app/packages/rocketchat:importer-csv/main.js"],"names":["Importer","CSV","name","descriptionI18N","mimeType","logger","debug","csvParser","Npm","require","messages","Map","prepare","dataURI","sentContentType","fileName","uriResult","RocketChatFile","dataURIParse","zip","AdmZip","Buffer","image","zipEntries","getEntries","tempChannels","tempUsers","tempMessages","entry","entryName","indexOf","isDirectory","toLowerCase","updateProgress","ProgressStep","PREPARING_CHANNELS","parsedChannels","getData","toString","map","c","id","trim","replace","creator","isPrivate","members","split","m","PREPARING_USERS","parsedUsers","u","username","email","item","channelName","msgGroupData","get","set","msgs","e","warn","ts","text","usersId","collection","insert","importRecord","_id","users","findOne","updateRecord","length","addCountToTotal","channelsId","channels","PREPARING_MESSAGES","messagesCount","channel","messagesMap","Base","getBSONSize","MaxBSONSize","getBSONSafeArraysFromAnArray","forEach","splitMsg","i","messagesId","entries","error","ERROR","getProgress","selectionUsers","SelectionUser","selectionChannels","SelectionChannel","selectionMessages","count","USER_SELECTION","Selection","startImport","importSelection","started","Date","now","user","user_id","do_import","update","$set","channel_id","startedByUserId","Meteor","userId","defer","IMPORTING_USERS","runAsUser","existantUser","RocketChat","models","Users","findOneByEmailAddress","findOneByUsername","rocketId","$addToSet","importIds","Accounts","createUser","password","toUpperCase","call","joinDefaultChannelsSilenced","setName","addCountCompleted","IMPORTING_CHANNELS","existantRoom","Rooms","findOneByName","creatorId","roomInfo","rid","cname","push","keys","ch","csvChannel","getChannelFromName","values","msg","getUserFromUsername","IMPORTING_MESSAGES","room","findOneById","fields","usernames","t","timestamps","isNaN","parseInt","suffix","undefined","msgObj","sendMessage","FINISHING","DONE","timeTook","log","getSelection","addImporter","warnings","href"],"mappings":"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","file":"/packages/rocketchat_importer-csv.js","sourcesContent":["/* globals Importer */\n\nImporter.CSV = class ImporterCSV extends Importer.Base {\n\tconstructor(name, descriptionI18N, mimeType) {\n\t\tsuper(name, descriptionI18N, mimeType);\n\t\tthis.logger.debug('Constructed a new CSV Importer.');\n\n\t\tthis.csvParser = Npm.require('csv-parse/lib/sync');\n\t\tthis.messages = new Map();\n\t}\n\n\tprepare(dataURI, sentContentType, fileName) {\n\t\tsuper.prepare(dataURI, sentContentType, fileName);\n\n\t\tconst uriResult = RocketChatFile.dataURIParse(dataURI);\n\t\tconst zip = new this.AdmZip(new Buffer(uriResult.image, 'base64'));\n\t\tconst zipEntries = zip.getEntries();\n\n\t\tlet tempChannels = [];\n\t\tlet tempUsers = [];\n\t\tconst tempMessages = new Map();\n\t\tfor (const entry of zipEntries) {\n\t\t\tthis.logger.debug(`Entry: ${ entry.entryName }`);\n\n\t\t\t//Ignore anything that has `__MACOSX` in it's name, as sadly these things seem to mess everything up\n\t\t\tif (entry.entryName.indexOf('__MACOSX') > -1) {\n\t\t\t\tthis.logger.debug(`Ignoring the file: ${ entry.entryName }`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Directories are ignored, since they are \"virtual\" in a zip file\n\t\t\tif (entry.isDirectory) {\n\t\t\t\tthis.logger.debug(`Ignoring the directory entry: ${ entry.entryName }`);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Parse the channels\n\t\t\tif (entry.entryName.toLowerCase() === 'channels.csv') {\n\t\t\t\tsuper.updateProgress(Importer.ProgressStep.PREPARING_CHANNELS);\n\t\t\t\tconst parsedChannels = this.csvParser(entry.getData().toString());\n\t\t\t\ttempChannels = parsedChannels.map((c) => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\tid: c[0].trim().replace('.', '_'),\n\t\t\t\t\t\tname: c[0].trim(),\n\t\t\t\t\t\tcreator: c[1].trim(),\n\t\t\t\t\t\tisPrivate: c[2].trim().toLowerCase() === 'private' ? true : false,\n\t\t\t\t\t\tmembers: c[3].trim().split(';').map((m) => m.trim())\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Parse the users\n\t\t\tif (entry.entryName.toLowerCase() === 'users.csv') {\n\t\t\t\tsuper.updateProgress(Importer.ProgressStep.PREPARING_USERS);\n\t\t\t\tconst parsedUsers = this.csvParser(entry.getData().toString());\n\t\t\t\ttempUsers = parsedUsers.map((u) => { return { id: u[0].trim().replace('.', '_'), username: u[0].trim(), email: u[1].trim(), name: u[2].trim() }; });\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t//Parse the messages\n\t\t\tif (entry.entryName.indexOf('/') > -1) {\n\t\t\t\tconst item = entry.entryName.split('/'); //random/messages.csv\n\t\t\t\tconst channelName = item[0]; //random\n\t\t\t\tconst msgGroupData = item[1].split('.')[0]; //2015-10-04\n\n\t\t\t\tif (!tempMessages.get(channelName)) {\n\t\t\t\t\ttempMessages.set(channelName, new Map());\n\t\t\t\t}\n\n\t\t\t\tlet msgs = [];\n\n\t\t\t\ttry {\n\t\t\t\t\tmsgs = this.csvParser(entry.getData().toString());\n\t\t\t\t} catch (e) {\n\t\t\t\t\tthis.logger.warn(`The file ${ entry.entryName } contains invalid syntax`, e);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\ttempMessages.get(channelName).set(msgGroupData, msgs.map((m) => { return { username: m[0], ts: m[1], text: m[2] }; }));\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t}\n\n\t\t// Insert the users record, eventually this might have to be split into several ones as well\n\t\t// if someone tries to import a several thousands users instance\n\t\tconst usersId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'users', 'users': tempUsers });\n\t\tthis.users = this.collection.findOne(usersId);\n\t\tsuper.updateRecord({ 'count.users': tempUsers.length });\n\t\tsuper.addCountToTotal(tempUsers.length);\n\n\t\t// Insert the channels records.\n\t\tconst channelsId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'channels', 'channels': tempChannels });\n\t\tthis.channels = this.collection.findOne(channelsId);\n\t\tsuper.updateRecord({ 'count.channels': tempChannels.length });\n\t\tsuper.addCountToTotal(tempChannels.length);\n\n\t\t// Save the messages records to the import record for `startImport` usage\n\t\tsuper.updateProgress(Importer.ProgressStep.PREPARING_MESSAGES);\n\t\tlet messagesCount = 0;\n\t\tfor (const [channel, messagesMap] of tempMessages.entries()) {\n\t\t\tif (!this.messages.get(channel)) {\n\t\t\t\tthis.messages.set(channel, new Map());\n\t\t\t}\n\n\t\t\tfor (const [msgGroupData, msgs] of messagesMap.entries()) {\n\t\t\t\tmessagesCount += msgs.length;\n\t\t\t\tsuper.updateRecord({ 'messagesstatus': `${ channel }/${ msgGroupData }` });\n\n\t\t\t\tif (Importer.Base.getBSONSize(msgs) > Importer.Base.MaxBSONSize) {\n\t\t\t\t\tImporter.Base.getBSONSafeArraysFromAnArray(msgs).forEach((splitMsg, i) => {\n\t\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'messages', 'name': `${ channel }/${ msgGroupData }.${ i }`, 'messages': splitMsg });\n\t\t\t\t\t\tthis.messages.get(channel).set(`${ msgGroupData }.${ i }`, this.collection.findOne(messagesId));\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\tconst messagesId = this.collection.insert({ 'import': this.importRecord._id, 'importer': this.name, 'type': 'messages', 'name': `${ channel }/${ msgGroupData }`, 'messages': msgs });\n\t\t\t\t\tthis.messages.get(channel).set(msgGroupData, this.collection.findOne(messagesId));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tsuper.updateRecord({ 'count.messages': messagesCount, 'messagesstatus': null });\n\t\tsuper.addCountToTotal(messagesCount);\n\n\t\t//Ensure we have at least a single user, channel, or message\n\t\tif (tempUsers.length === 0 && tempChannels.length === 0 && messagesCount === 0) {\n\t\t\tthis.logger.error('No users, channels, or messages found in the import file.');\n\t\t\tsuper.updateProgress(Importer.ProgressStep.ERROR);\n\t\t\treturn super.getProgress();\n\t\t}\n\n\t\tconst selectionUsers = tempUsers.map((u) => new Importer.SelectionUser(u.id, u.username, u.email, false, false, true));\n\t\tconst selectionChannels = tempChannels.map((c) => new Importer.SelectionChannel(c.id, c.name, false, true, c.isPrivate));\n\t\tconst selectionMessages = this.importRecord.count.messages;\n\n\t\tsuper.updateProgress(Importer.ProgressStep.USER_SELECTION);\n\t\treturn new Importer.Selection(this.name, selectionUsers, selectionChannels, selectionMessages);\n\t}\n\n\tstartImport(importSelection) {\n\t\tsuper.startImport(importSelection);\n\t\tconst started = Date.now();\n\n\t\t//Ensure we're only going to import the users that the user has selected\n\t\tfor (const user of importSelection.users) {\n\t\t\tfor (const u of this.users.users) {\n\t\t\t\tif (u.id === user.user_id) {\n\t\t\t\t\tu.do_import = user.do_import;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.collection.update({ _id: this.users._id }, { $set: { 'users': this.users.users }});\n\n\t\t//Ensure we're only importing the channels the user has selected.\n\t\tfor (const channel of importSelection.channels) {\n\t\t\tfor (const c of this.channels.channels) {\n\t\t\t\tif (c.id === channel.channel_id) {\n\t\t\t\t\tc.do_import = channel.do_import;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\tconst startedByUserId = Meteor.userId();\n\t\tMeteor.defer(() => {\n\t\t\tsuper.updateProgress(Importer.ProgressStep.IMPORTING_USERS);\n\t\t\t//Import the users\n\t\t\tfor (const u of this.users.users) {\n\t\t\t\tif (!u.do_import) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\tlet existantUser = RocketChat.models.Users.findOneByEmailAddress(u.email);\n\n\t\t\t\t\t//If we couldn't find one by their email address, try to find an existing user by their username\n\t\t\t\t\tif (!existantUser) {\n\t\t\t\t\t\texistantUser = RocketChat.models.Users.findOneByUsername(u.username);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (existantUser) {\n\t\t\t\t\t\t//since we have an existing user, let's try a few things\n\t\t\t\t\t\tu.rocketId = existantUser._id;\n\t\t\t\t\t\tRocketChat.models.Users.update({ _id: u.rocketId }, { $addToSet: { importIds: u.id } });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst userId = Accounts.createUser({ email: u.email, password: Date.now() + u.name + u.email.toUpperCase() });\n\t\t\t\t\t\tMeteor.runAsUser(userId, () => {\n\t\t\t\t\t\t\tMeteor.call('setUsername', u.username, {joinDefaultChannelsSilenced: true});\n\t\t\t\t\t\t\tRocketChat.models.Users.setName(userId, u.name);\n\t\t\t\t\t\t\tRocketChat.models.Users.update({ _id: userId }, { $addToSet: { importIds: u.id } });\n\t\t\t\t\t\t\tu.rocketId = userId;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.collection.update({ _id: this.users._id }, { $set: { 'users': this.users.users }});\n\n\t\t\t//Import the channels\n\t\t\tsuper.updateProgress(Importer.ProgressStep.IMPORTING_CHANNELS);\n\t\t\tfor (const c of this.channels.channels) {\n\t\t\t\tif (!c.do_import) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\tconst existantRoom = RocketChat.models.Rooms.findOneByName(c.name);\n\t\t\t\t\t//If the room exists or the name of it is 'general', then we don't need to create it again\n\t\t\t\t\tif (existantRoom || c.name.toUpperCase() === 'GENERAL') {\n\t\t\t\t\t\tc.rocketId = c.name.toUpperCase() === 'GENERAL' ? 'GENERAL' : existantRoom._id;\n\t\t\t\t\t\tRocketChat.models.Rooms.update({ _id: c.rocketId }, { $addToSet: { importIds: c.id } });\n\t\t\t\t\t} else {\n\t\t\t\t\t\t//Find the rocketchatId of the user who created this channel\n\t\t\t\t\t\tlet creatorId = startedByUserId;\n\t\t\t\t\t\tfor (const u of this.users.users) {\n\t\t\t\t\t\t\tif (u.username === c.creator && u.do_import) {\n\t\t\t\t\t\t\t\tcreatorId = u.rocketId;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//Create the channel\n\t\t\t\t\t\tMeteor.runAsUser(creatorId, () => {\n\t\t\t\t\t\t\tconst roomInfo = Meteor.call(c.isPrivate ? 'createPrivateGroup' : 'createChannel', c.name, c.members);\n\t\t\t\t\t\t\tc.rocketId = roomInfo.rid;\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tRocketChat.models.Rooms.update({ _id: c.rocketId }, { $addToSet: { importIds: c.id } });\n\t\t\t\t\t}\n\n\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.collection.update({ _id: this.channels._id }, { $set: { 'channels': this.channels.channels }});\n\n\t\t\t//If no channels file, collect channel map from DB for message-only import\n\t\t\tif (this.channels.channels.length === 0) {\n\t\t\t\tfor (const cname of this.messages.keys()) {\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tconst existantRoom = RocketChat.models.Rooms.findOneByName(cname);\n\t\t\t\t\t\tif (existantRoom || cname.toUpperCase() === 'GENERAL') {\n\t\t\t\t\t\t\tthis.channels.channels.push({\n\t\t\t\t\t\t\t\tid: cname.replace('.', '_'),\n\t\t\t\t\t\t\t\tname: cname,\n\t\t\t\t\t\t\t\trocketId: (cname.toUpperCase() === 'GENERAL' ? 'GENERAL' : existantRoom._id),\n\t\t\t\t\t\t\t\tdo_import: true\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t//If no users file, collect user map from DB for message-only import\n\t\t\tif (this.users.users.length === 0) {\n\t\t\t\tfor (const [ch, messagesMap] of this.messages.entries()) {\n\t\t\t\t\tconst csvChannel = this.getChannelFromName(ch);\n\t\t\t\t\tif (!csvChannel || !csvChannel.do_import) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\t\tfor (const msgs of messagesMap.values()) {\n\t\t\t\t\t\t\tfor (const msg of msgs.messages) {\n\t\t\t\t\t\t\t\tif (!this.getUserFromUsername(msg.username)) {\n\t\t\t\t\t\t\t\t\tconst user = RocketChat.models.Users.findOneByUsername(msg.username);\n\t\t\t\t\t\t\t\t\tif (user) {\n\t\t\t\t\t\t\t\t\t\tthis.users.users.push({\n\t\t\t\t\t\t\t\t\t\t\trocketId: user._id,\n\t\t\t\t\t\t\t\t\t\t\tusername: user.username\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\n\t\t\t//Import the Messages\n\t\t\tsuper.updateProgress(Importer.ProgressStep.IMPORTING_MESSAGES);\n\t\t\tfor (const [ch, messagesMap] of this.messages.entries()) {\n\t\t\t\tconst csvChannel = this.getChannelFromName(ch);\n\t\t\t\tif (!csvChannel || !csvChannel.do_import) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst room = RocketChat.models.Rooms.findOneById(csvChannel.rocketId, { fields: { usernames: 1, t: 1, name: 1 } });\n\t\t\t\tMeteor.runAsUser(startedByUserId, () => {\n\t\t\t\t\tconst timestamps = {};\n\t\t\t\t\tfor (const [msgGroupData, msgs] of messagesMap.entries()) {\n\t\t\t\t\t\tsuper.updateRecord({ 'messagesstatus': `${ ch }/${ msgGroupData }.${ msgs.messages.length }` });\n\t\t\t\t\t\tfor (const msg of msgs.messages) {\n\t\t\t\t\t\t\tif (isNaN(new Date(parseInt(msg.ts)))) {\n\t\t\t\t\t\t\t\tthis.logger.warn(`Timestamp on a message in ${ ch }/${ msgGroupData } is invalid`);\n\t\t\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst creator = this.getUserFromUsername(msg.username);\n\t\t\t\t\t\t\tif (creator) {\n\t\t\t\t\t\t\t\tlet suffix = '';\n\t\t\t\t\t\t\t\tif (timestamps[msg.ts] === undefined) {\n\t\t\t\t\t\t\t\t\ttimestamps[msg.ts] = 1;\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tsuffix = `-${ timestamps[msg.ts] }`;\n\t\t\t\t\t\t\t\t\ttimestamps[msg.ts] += 1;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tconst msgObj = {\n\t\t\t\t\t\t\t\t\t_id: `csv-${ csvChannel.id }-${ msg.ts }${ suffix }`,\n\t\t\t\t\t\t\t\t\tts: new Date(parseInt(msg.ts)),\n\t\t\t\t\t\t\t\t\tmsg: msg.text,\n\t\t\t\t\t\t\t\t\trid: room._id,\n\t\t\t\t\t\t\t\t\tu: {\n\t\t\t\t\t\t\t\t\t\t_id: creator._id,\n\t\t\t\t\t\t\t\t\t\tusername: creator.username\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\tRocketChat.sendMessage(creator, msgObj, room, true);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tsuper.addCountCompleted(1);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tsuper.updateProgress(Importer.ProgressStep.FINISHING);\n\t\t\tsuper.updateProgress(Importer.ProgressStep.DONE);\n\t\t\tconst timeTook = Date.now() - started;\n\t\t\tthis.logger.log(`CSV Import took ${ timeTook } milliseconds.`);\n\t\t});\n\n\t\treturn super.getProgress();\n\t}\n\n\tgetSelection() {\n\t\tconst selectionUsers = this.users.users.map((u) => new Importer.SelectionUser(u.id, u.username, u.email, false, false, true));\n\t\tconst selectionChannels = this.channels.channels.map((c) => new Importer.SelectionChannel(c.id, c.name, false, true, c.isPrivate));\n\t\tconst selectionMessages = this.importRecord.count.messages;\n\n\t\treturn new Importer.Selection(this.name, selectionUsers, selectionChannels, selectionMessages);\n\t}\n\n\tgetChannelFromName(channelName) {\n\t\tfor (const ch of this.channels.channels) {\n\t\t\tif (ch.name === channelName) {\n\t\t\t\treturn ch;\n\t\t\t}\n\t\t}\n\t}\n\n\tgetUserFromUsername(username) {\n\t\tfor (const u of this.users.users) {\n\t\t\tif (u.username === username) {\n\t\t\t\treturn RocketChat.models.Users.findOneById(u.rocketId, { fields: { username: 1 }});\n\t\t\t}\n\t\t}\n\t}\n};\n","/* globals Importer */\n\nImporter.addImporter('csv', Importer.CSV, {\n\tname: 'CSV',\n\twarnings: [{\n\t\ttext: 'Importer_CSV_Information',\n\t\thref: 'https://rocket.chat/docs/administrator-guides/import/csv/'\n\t}],\n\tmimeType: 'application/zip'\n});\n"]}