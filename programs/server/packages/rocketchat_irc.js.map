{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:irc/server/settings.js","meteor://ðŸ’»app/packages/rocketchat:irc/server/server.js"],"names":["Meteor","startup","RocketChat","settings","addGroup","add","type","i18nLabel","i18nDescription","alert","section","net","module","watch","require","v","Lru","IRC_AVAILABILITY","get","MESSAGE_CACHE_SIZE","ircReceiveMessageCache","ircSendMessageCache","IRC_PORT","IRC_HOST","ircClientMap","bind","f","g","bindEnvironment","self","args","apply","async","wrapAsync","IrcClient","loginReq","user","_id","ircPort","ircHost","msgBuf","isConnected","isDistroyed","socket","Socket","setNoDelay","setEncoding","setKeepAlive","onConnect","onClose","onTimeout","onError","onReceiveRawMessage","on","isJoiningRoom","receiveMemberListBuf","pendingJoinRoomBuf","successLoginMessageRegex","failedLoginMessageRegex","receiveMessageRegex","receiveMemberListRegex","endMemberListRegex","addMemberToRoomRegex","removeMemberFromRoomRegex","quitMemberRegex","connect","loginCb","initRoomList","disconnect","destroy","console","log","yellow","username","write","name","messageBuf","forEach","msg","arguments","data","toString","split","line","trim","indexOf","replace","matchResult","exec","onReceiveMessage","onReceiveMemberList","onEndMemberList","onAddMemberToRoom","onRemoveMemberFromRoom","onQuitMember","onSuccessLoginMessage","onFailedLoginMessage","allowed","source","target","content","now","Date","timestamp","getTime","cacheKey","join","set","createUserWhenNotExist","room","models","Rooms","findOneByName","substring","createDirectRoomWhenNotExist","message","ts","sendMessage","roomName","members","concat","newMembers","findOneByNameAndType","oldMembers","usernames","appendMembers","_","difference","removeMembers","member","removeUsernamesById","addUsernamesById","shift","joinRoom","t","sendRawMessage","slice","push","u","roomsCursor","findByTypeContainingUsername","fields","rooms","fetch","leaveRoom","getMemberList","addUsernameByName","removeUsernameByName","removeUsernameFromAll","users","update","$set","status","findOne","call","email","pass","rid","sort","upsert","$setOnInsert","msgs","Subscriptions","$and","open","unread","userMentions","groupMentions","getByUid","uid","create","login","ircClient","IrcLoginer","IrcSender","findOneById","IrcRoomJoiner","IrcRoomLeaver","IrcLogoutCleanUper","callbacks","priority","LOW"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,OAAOC,OAAP,CAAe,YAAW;AACzBC,YAAWC,QAAX,CAAoBC,QAApB,CAA6B,KAA7B,EAAoC,YAAW;AAE9C;AACA,OAAKC,GAAL,CAAS,aAAT,EAAwB,KAAxB,EAA+B;AAC9BC,SAAM,SADwB;AAE9BC,cAAW,SAFmB;AAG9BC,oBAAiB,aAHa;AAI9BC,UAAO;AAJuB,GAA/B,EAH8C,CAU9C;;AACA,OAAKJ,GAAL,CAAS,UAAT,EAAqB,kBAArB,EAAyC;AACxCC,SAAM,QADkC;AAExCC,cAAW,MAF6B;AAGxCC,oBAAiB;AAHuB,GAAzC,EAX8C,CAiB9C;;AACA,OAAKH,GAAL,CAAS,UAAT,EAAqB,IAArB,EAA2B;AAC1BC,SAAM,KADoB;AAE1BC,cAAW,MAFe;AAG1BC,oBAAiB;AAHS,GAA3B,EAlB8C,CAwB9C;;AACA,OAAKH,GAAL,CAAS,wBAAT,EAAmC,GAAnC,EAAwC;AACvCC,SAAM,KADiC;AAEvCC,cAAW,oBAF4B;AAGvCC,oBAAiB;AAHsB,GAAxC,EAzB8C,CA+B9C;;AACA,OAAKE,OAAL,CAAa,qBAAb,EAAoC,YAAW;AAC9C,QAAKL,GAAL,CAAS,wBAAT,EAAmC,qDAAnC,EAA0F;AACzFC,UAAM,QADmF;AAEzFC,eAAW,kBAF8E;AAGzFC,qBAAiB;AAHwE,IAA1F;AAKA,QAAKH,GAAL,CAAS,uBAAT,EAAkC,yBAAlC,EAA6D;AAC5DC,UAAM,QADsD;AAE5DC,eAAW,cAFiD;AAG5DC,qBAAiB;AAH2C,IAA7D;AAKA,QAAKH,GAAL,CAAS,0BAAT,EAAqC,mCAArC,EAA0E;AACzEC,UAAM,QADmE;AAEzEC,eAAW,iBAF8D;AAGzEC,qBAAiB;AAHwD,IAA1E;AAKA,QAAKH,GAAL,CAAS,6BAAT,EAAwC,+BAAxC,EAAyE;AACxEC,UAAM,QADkE;AAExEC,eAAW,yBAF6D;AAGxEC,qBAAiB;AAHuD,IAAzE;AAKA,QAAKH,GAAL,CAAS,yBAAT,EAAoC,kCAApC,EAAwE;AACvEC,UAAM,QADiE;AAEvEC,eAAW,uBAF4D;AAGvEC,qBAAiB;AAHsD,IAAxE;AAKA,QAAKH,GAAL,CAAS,2BAAT,EAAsC,2BAAtC,EAAmE;AAClEC,UAAM,QAD4D;AAElEC,eAAW,cAFuD;AAGlEC,qBAAiB;AAHiD,IAAnE;AAKA,QAAKH,GAAL,CAAS,gCAAT,EAA2C,2BAA3C,EAAwE;AACvEC,UAAM,QADiE;AAEvEC,eAAW,eAF4D;AAGvEC,qBAAiB;AAHsD,IAAxE;AAKA,QAAKH,GAAL,CAAS,sBAAT,EAAiC,uBAAjC,EAA0D;AACzDC,UAAM,QADmD;AAEzDC,eAAW,kBAF8C;AAGzDC,qBAAiB;AAHwC,IAA1D;AAKA,GAzCD;AA2CA,EA3ED;AA4EA,CA7ED,uH;;;;;;;;;;;;;;;;;ACAA,IAAIG,YAAJ;AAAQC,OAAOC,KAAP,CAAaC,QAAQ,KAAR,CAAb,EAA4B;AAAA,sBAASC,CAAT,EAAW;AAACJ,QAAII,CAAJ;AAAM;AAAlB,CAA5B,EAAgD,CAAhD;AAAmD,IAAIC,YAAJ;AAAQJ,OAAOC,KAAP,CAAaC,QAAQ,WAAR,CAAb,EAAkC;AAAA,sBAASC,CAAT,EAAW;AAACC,QAAID,CAAJ;AAAM;AAAlB,CAAlC,EAAsD,CAAtD;AAGnE;AACA;AAEA;AACA,IAAME,mBAAmBf,WAAWC,QAAX,CAAoBe,GAApB,CAAwB,aAAxB,CAAzB,C,CAEA;;AACA,IAAMC,qBAAqBjB,WAAWC,QAAX,CAAoBe,GAApB,CAAwB,wBAAxB,CAA3B;AACA,IAAME,yBAAyBJ,IAAIG,kBAAJ,CAA/B,C,CAAuD;;AACvD,IAAME,sBAAsBL,IAAIG,kBAAJ,CAA5B,C,CAAoD;AAEpD;;AACA,IAAMG,WAAWpB,WAAWC,QAAX,CAAoBe,GAApB,CAAwB,UAAxB,CAAjB;AACA,IAAMK,WAAWrB,WAAWC,QAAX,CAAoBe,GAApB,CAAwB,UAAxB,CAAjB;AAEA,IAAMM,eAAe,EAArB,C,CAEA;AACA;;AAEA,IAAMC,OAAO,UAASC,CAAT,EAAY;AACxB,KAAMC,IAAI3B,OAAO4B,eAAP,CAAuB,UAACC,IAAD;AAAA,oCAAUC,IAAV;AAAUA,OAAV;AAAA;;AAAA,SAAmBJ,EAAEK,KAAF,CAAQF,IAAR,EAAcC,IAAd,CAAnB;AAAA,EAAvB,CAAV;AACA,QAAO,YAAkB;AAAA,qCAANA,IAAM;AAANA,OAAM;AAAA;;AAAEH,sBAAE,IAAF,SAAWG,IAAX;AAAmB,EAA9C;AACA,CAHD;;AAKA,IAAME,QAAQ,UAACN,CAAD;AAAA,oCAAOI,IAAP;AAAOA,MAAP;AAAA;;AAAA,QAAgB9B,OAAOiC,SAAP,CAAiBP,CAAjB,mBAAuBI,IAAvB,CAAhB;AAAA,CAAd;;IAEMI,S;AACL,oBAAYC,QAAZ,EAAsB;AAAA;AACrB,OAAKA,QAAL,GAAgBA,QAAhB;AAEA,OAAKC,IAAL,GAAY,KAAKD,QAAL,CAAcC,IAA1B;AACAZ,eAAa,KAAKY,IAAL,CAAUC,GAAvB,IAA8B,IAA9B;AACA,OAAKC,OAAL,GAAehB,QAAf;AACA,OAAKiB,OAAL,GAAehB,QAAf;AACA,OAAKiB,MAAL,GAAc,EAAd;AAEA,OAAKC,WAAL,GAAmB,KAAnB;AACA,OAAKC,WAAL,GAAmB,KAAnB;AACA,OAAKC,MAAL,GAAc,IAAIhC,IAAIiC,MAAR,EAAd;AACA,OAAKD,MAAL,CAAYE,UAAZ;AACA,OAAKF,MAAL,CAAYG,WAAZ,CAAwB,OAAxB;AACA,OAAKH,MAAL,CAAYI,YAAZ,CAAyB,IAAzB;AACA,OAAKC,SAAL,GAAiBvB,KAAK,KAAKuB,SAAV,CAAjB;AACA,OAAKC,OAAL,GAAexB,KAAK,KAAKwB,OAAV,CAAf;AACA,OAAKC,SAAL,GAAiBzB,KAAK,KAAKyB,SAAV,CAAjB;AACA,OAAKC,OAAL,GAAe1B,KAAK,KAAK0B,OAAV,CAAf;AACA,OAAKC,mBAAL,GAA2B3B,KAAK,KAAK2B,mBAAV,CAA3B;AACA,OAAKT,MAAL,CAAYU,EAAZ,CAAe,MAAf,EAAuB,KAAKD,mBAA5B;AACA,OAAKT,MAAL,CAAYU,EAAZ,CAAe,OAAf,EAAwB,KAAKJ,OAA7B;AACA,OAAKN,MAAL,CAAYU,EAAZ,CAAe,SAAf,EAA0B,KAAKH,SAA/B;AACA,OAAKP,MAAL,CAAYU,EAAZ,CAAe,OAAf,EAAwB,KAAKF,OAA7B;AAEA,OAAKG,aAAL,GAAqB,KAArB;AACA,OAAKC,oBAAL,GAA4B,EAA5B;AACA,OAAKC,kBAAL,GAA0B,EAA1B;AAEA,OAAKC,wBAAL,GAAgC,oDAAhC;AACA,OAAKC,uBAAL,GAA+B,mDAA/B;AACA,OAAKC,mBAAL,GAA2B,sDAA3B;AACA,OAAKC,sBAAL,GAA8B,yDAA9B;AACA,OAAKC,kBAAL,GAA0B,qDAA1B;AACA,OAAKC,oBAAL,GAA4B,uDAA5B;AACA,OAAKC,yBAAL,GAAiC,4DAAjC;AACA,OAAKC,eAAL,GAAuB,kDAAvB;AACA;;qBAEDC,O;mBAAQC,O,EAAS;AAChB,QAAKA,OAAL,GAAeA,OAAf;AACA,QAAKvB,MAAL,CAAYsB,OAAZ,CAAoB,KAAK3B,OAAzB,EAAkC,KAAKC,OAAvC,EAAgD,KAAKS,SAArD;AACA,QAAKmB,YAAL;AACA;;;;;qBAEDC,U;wBAAa;AACZ,QAAK1B,WAAL,GAAmB,IAAnB;AACA,QAAKC,MAAL,CAAY0B,OAAZ;AACA;;;;;qBAEDrB,S;uBAAY;AAAA;;AACXsB,WAAQC,GAAR,CAAY,sBAAsBC,MAAlC,EAA0C,KAAKpC,IAAL,CAAUqC,QAApD,EAA8D,kBAA9D;AACA,QAAK9B,MAAL,CAAY+B,KAAZ,WAA2B,KAAKtC,IAAL,CAAUqC,QAArC;AACA,QAAK9B,MAAL,CAAY+B,KAAZ,WAA2B,KAAKtC,IAAL,CAAUqC,QAArC,cAAwD,KAAKrC,IAAL,CAAUuC,IAAlE,WAHW,CAIX;;AACA,QAAKlC,WAAL,GAAmB,IAAnB;AACA,OAAMmC,aAAa,KAAKpC,MAAxB;AACAoC,cAAWC,OAAX,CAAmB;AAAA,WAAO,MAAKlC,MAAL,CAAY+B,KAAZ,CAAkBI,GAAlB,CAAP;AAAA,IAAnB;AACA;;;;;qBAED7B,O;qBAAU;AACTqB,WAAQC,GAAR,CAAY,oBAAoBC,MAAhC,EAAwC,KAAKpC,IAAL,CAAUqC,QAAlD,EAA4D,mBAA5D;AACA,QAAKhC,WAAL,GAAmB,KAAnB;;AACA,OAAI,KAAKC,WAAT,EAAsB;AACrB,WAAOlB,aAAa,KAAKY,IAAL,CAAUC,GAAvB,CAAP;AACA,IAFD,MAEO;AACN,SAAK4B,OAAL;AACA;AACD;;;;;qBAEDf,S;uBAAY;AACXoB,WAAQC,GAAR,CAAY,sBAAsBC,MAAlC,EAA0C,KAAKpC,IAAL,CAAUqC,QAApD,EAA8D,qBAA9D,EAAqFM,SAArF;AACA;;;;;qBAED5B,O;qBAAU;AACTmB,WAAQC,GAAR,CAAY,oBAAoBC,MAAhC,EAAwC,KAAKpC,IAAL,CAAUqC,QAAlD,EAA4D,mBAA5D,EAAiFM,SAAjF;AACA;;;;;qBAED3B,mB;+BAAoB4B,I,EAAM;AAAA;;AACzBA,UAAOA,KAAKC,QAAL,GAAgBC,KAAhB,CAAsB,IAAtB,CAAP;AAEAF,QAAKH,OAAL,CAAa,gBAAQ;AACpBM,WAAOA,KAAKC,IAAL,EAAP;AACAd,YAAQC,GAAR,OAAiB,OAAKhC,OAAtB,SAAmC,OAAKD,OAAxC,SAAsD6C,IAAtD,EAFoB,CAIpB;;AACA,QAAIA,KAAKE,OAAL,CAAa,MAAb,MAAyB,CAA7B,EAAgC;AAC/B,YAAK1C,MAAL,CAAY+B,KAAZ,CAAkBS,KAAKG,OAAL,CAAa,QAAb,EAAuB,OAAvB,CAAlB;;AACA;AACA;;AACD,QAAIC,cAAc,OAAK5B,mBAAL,CAAyB6B,IAAzB,CAA8BL,IAA9B,CAAlB;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKE,gBAAL,CAAsBF,YAAY,CAAZ,CAAtB,EAAsCA,YAAY,CAAZ,CAAtC,EAAsDA,YAAY,CAAZ,CAAtD;;AACA;AACA;;AACDA,kBAAc,OAAK3B,sBAAL,CAA4B4B,IAA5B,CAAiCL,IAAjC,CAAd;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKG,mBAAL,CAAyBH,YAAY,CAAZ,CAAzB,EAAyCA,YAAY,CAAZ,EAAeL,KAAf,CAAqB,GAArB,CAAzC;;AACA;AACA;;AACDK,kBAAc,OAAK1B,kBAAL,CAAwB2B,IAAxB,CAA6BL,IAA7B,CAAd;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKI,eAAL,CAAqBJ,YAAY,CAAZ,CAArB;;AACA;AACA;;AACDA,kBAAc,OAAKzB,oBAAL,CAA0B0B,IAA1B,CAA+BL,IAA/B,CAAd;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKK,iBAAL,CAAuBL,YAAY,CAAZ,CAAvB,EAAuCA,YAAY,CAAZ,CAAvC;;AACA;AACA;;AACDA,kBAAc,OAAKxB,yBAAL,CAA+ByB,IAA/B,CAAoCL,IAApC,CAAd;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKM,sBAAL,CAA4BN,YAAY,CAAZ,CAA5B,EAA4CA,YAAY,CAAZ,CAA5C;;AACA;AACA;;AACDA,kBAAc,OAAKvB,eAAL,CAAqBwB,IAArB,CAA0BL,IAA1B,CAAd;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKO,YAAL,CAAkBP,YAAY,CAAZ,CAAlB;;AACA;AACA;;AACDA,kBAAc,OAAK9B,wBAAL,CAA8B+B,IAA9B,CAAmCL,IAAnC,CAAd;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKQ,qBAAL;;AACA;AACA;;AACDR,kBAAc,OAAK7B,uBAAL,CAA6B8B,IAA7B,CAAkCL,IAAlC,CAAd;;AACA,QAAII,WAAJ,EAAiB;AAChB,YAAKS,oBAAL;;AACA;AACA;AACD,IAjDD;AAkDA;;;;;qBAEDD,qB;mCAAwB;AACvBzB,WAAQC,GAAR,CAAY,kCAAkCC,MAA9C;;AACA,OAAI,KAAKN,OAAT,EAAkB;AACjB,SAAKA,OAAL,CAAa,IAAb,EAAmB,KAAK/B,QAAxB;AACA;AACD;;;;;qBAED6D,oB;kCAAuB;AACtB1B,WAAQC,GAAR,CAAY,iCAAiCC,MAA7C;AACA,QAAKrC,QAAL,CAAc8D,OAAd,GAAwB,KAAxB;AACA,QAAK7B,UAAL;;AACA,OAAI,KAAKF,OAAT,EAAkB;AACjB,SAAKA,OAAL,CAAa,IAAb,EAAmB,KAAK/B,QAAxB;AACA;AACD;;;;;qBAEDsD,gB;4BAAiBS,M,EAAQC,M,EAAQC,O,EAAS;AACzC,OAAMC,MAAM,IAAIC,IAAJ,EAAZ;AACA,OAAMC,YAAYF,IAAIG,OAAJ,EAAlB;AACA,OAAIC,WAAW,CAACP,MAAD,EAASC,MAAT,EAAiBC,OAAjB,EAA0BM,IAA1B,CAA+B,GAA/B,CAAf;AACApC,WAAQC,GAAR,CAAY,oCAAoCC,MAAhD,EAAwD,MAAxD,EAAgEiC,QAAhE,EAA0E,QAA1E,EAAoFpF,oBAAoBH,GAApB,CAAwBuF,QAAxB,CAApF,EAAuH,KAAvH,EAA8HF,YAAY,IAA1I;;AACA,OAAIlF,oBAAoBH,GAApB,CAAwBuF,QAAxB,IAAqCF,YAAY,IAArD,EAA4D;AAC3D;AACA,IAFD,MAEO;AACNlF,wBAAoBsF,GAApB,CAAwBF,QAAxB,EAAkCF,SAAlC;AACA;;AACDjC,WAAQC,GAAR,CAAY,6BAA6BC,MAAzC,EAAiD,SAAjD,EAA4D0B,MAA5D,EAAoE,SAApE,EAA+EC,MAA/E,EAAuF,UAAvF,EAAmGC,OAAnG;AACAF,YAAS,KAAKU,sBAAL,CAA4BV,MAA5B,CAAT;AACA,OAAIW,aAAJ;;AACA,OAAIV,OAAO,CAAP,MAAc,GAAlB,EAAuB;AACtBU,WAAO3G,WAAW4G,MAAX,CAAkBC,KAAlB,CAAwBC,aAAxB,CAAsCb,OAAOc,SAAP,CAAiB,CAAjB,CAAtC,CAAP;AACA,IAFD,MAEO;AACNJ,WAAO,KAAKK,4BAAL,CAAkChB,MAAlC,EAA0C,KAAK9D,IAA/C,CAAP;AACA;;AACD,OAAM+E,UAAU;AAAErC,SAAKsB,OAAP;AAAgBgB,QAAIf;AAApB,IAAhB;AACAI,mBAAeP,OAAOzB,QAAtB,GAAmC8B,SAAnC;AACAnF,0BAAuBuF,GAAvB,CAA2BF,QAA3B,EAAqC,IAArC;AACAnC,WAAQC,GAAR,CAAY,uCAAuCC,MAAnD,EAA2D,MAA3D,EAAmEiC,QAAnE;AACAvG,cAAWmH,WAAX,CAAuBnB,MAAvB,EAA+BiB,OAA/B,EAAwCN,IAAxC;AACA;;;;;qBAEDnB,mB;+BAAoB4B,Q,EAAUC,O,EAAS;AACtC,QAAKhE,oBAAL,CAA0B+D,QAA1B,IAAsC,KAAK/D,oBAAL,CAA0B+D,QAA1B,EAAoCE,MAApC,CAA2CD,OAA3C,CAAtC;AACA;;;;;qBAED5B,e;2BAAgB2B,Q,EAAU;AAAA;;AACzB,OAAMG,aAAa,KAAKlE,oBAAL,CAA0B+D,QAA1B,CAAnB;AACAhD,WAAQC,GAAR,CAAY,4BAA4BC,MAAxC,EAAgD,OAAhD,EAAyD8C,QAAzD,EAAmE,UAAnE,EAA+EG,WAAWf,IAAX,CAAgB,GAAhB,CAA/E;AACA,OAAMG,OAAO3G,WAAW4G,MAAX,CAAkBC,KAAlB,CAAwBW,oBAAxB,CAA6CJ,QAA7C,EAAuD,GAAvD,CAAb;;AACA,OAAI,CAACT,IAAL,EAAW;AACV;AACA;;AACD,OAAMc,aAAad,KAAKe,SAAxB;;AACA,OAAMC,gBAAgBC,EAAEC,UAAF,CAAaN,UAAb,EAAyBE,UAAzB,CAAtB;;AACA,OAAMK,gBAAgBF,EAAEC,UAAF,CAAaJ,UAAb,EAAyBF,UAAzB,CAAtB;;AACAI,iBAAchD,OAAd,CAAsB;AAAA,WAAU,OAAK+B,sBAAL,CAA4BqB,MAA5B,CAAV;AAAA,IAAtB;AACA/H,cAAW4G,MAAX,CAAkBC,KAAlB,CAAwBmB,mBAAxB,CAA4CrB,KAAKxE,GAAjD,EAAsD2F,aAAtD;AACA9H,cAAW4G,MAAX,CAAkBC,KAAlB,CAAwBoB,gBAAxB,CAAyCtB,KAAKxE,GAA9C,EAAmDwF,aAAnD;AAEA,QAAKvE,aAAL,GAAqB,KAArB;AACAgE,cAAW,KAAK9D,kBAAL,CAAwB4E,KAAxB,EAAX;;AACA,OAAId,QAAJ,EAAc;AACb,SAAKe,QAAL,CAAc;AACbC,QAAG,GADU;AAEb3D,WAAM2C;AAFO,KAAd;AAIA;AACD;;;;;qBAEDiB,c;0BAAezD,G,EAAK;AACnBR,WAAQC,GAAR,CAAY,2BAA2BC,MAAvC,EAA+CM,IAAI0D,KAAJ,CAAU,CAAV,EAAa,CAAC,CAAd,CAA/C;;AACA,OAAI,KAAK/F,WAAT,EAAsB;AACrB,SAAKE,MAAL,CAAY+B,KAAZ,CAAkBI,GAAlB;AACA,IAFD,MAEO;AACN,SAAKtC,MAAL,CAAYiG,IAAZ,CAAiB3D,GAAjB;AACA;AACD;;;;;qBAEDuC,W;uBAAYR,I,EAAMM,O,EAAS;AAC1B7C,WAAQC,GAAR,CAAY,wBAAwBC,MAApC,EAA4C,WAA5C,EAAyD2C,QAAQuB,CAAR,CAAUjE,QAAnE;AACA,OAAI0B,SAAS,EAAb;;AACA,OAAIU,KAAKyB,CAAL,KAAW,GAAf,EAAoB;AACnBnC,mBAAcU,KAAKlC,IAAnB;AACA,IAFD,MAEO,IAAIkC,KAAKyB,CAAL,KAAW,GAAf,EAAoB;AAC1B,QAAMV,YAAYf,KAAKe,SAAvB;AACAA,cAAU/C,OAAV,CAAkB,gBAAQ;AACzB,SAAIsC,QAAQuB,CAAR,CAAUjE,QAAV,KAAuBE,IAA3B,EAAiC;AAChCwB,eAASxB,IAAT;AACA;AACA;AACD,KALD;AAMA;;AACD,OAAM8B,WAAW,CAAC,KAAKrE,IAAL,CAAUqC,QAAX,EAAqB0B,MAArB,EAA6BgB,QAAQrC,GAArC,EAA0C4B,IAA1C,CAA+C,GAA/C,CAAjB;AACApC,WAAQC,GAAR,CAAY,oCAAoCC,MAAhD,EAAwD,MAAxD,EAAgEiC,QAAhE,EAA0E,KAA1E,EAAiFU,QAAQC,EAAR,CAAWZ,OAAX,EAAjF;AACAnF,uBAAoBsF,GAApB,CAAwBF,QAAxB,EAAkCU,QAAQC,EAAR,CAAWZ,OAAX,EAAlC;AACA,OAAM1B,mBAAkBqB,MAAlB,UAA+BgB,QAAQrC,GAAvC,SAAN;AACA,QAAKyD,cAAL,CAAoBzD,GAApB;AACA;;;;;qBAEDX,Y;0BAAe;AAAA;;AACd,OAAMwE,cAAczI,WAAW4G,MAAX,CAAkBC,KAAlB,CAAwB6B,4BAAxB,CAAqD,GAArD,EAA0D,KAAKxG,IAAL,CAAUqC,QAApE,EAA8E;AAAEoE,YAAQ;AAAElE,WAAM,CAAR;AAAW2D,QAAG;AAAd;AAAV,IAA9E,CAApB;AACA,OAAMQ,QAAQH,YAAYI,KAAZ,EAAd;AACAD,SAAMjE,OAAN,CAAc;AAAA,WAAQ,OAAKwD,QAAL,CAAcxB,IAAd,CAAR;AAAA,IAAd;AACA;;;;;qBAEDwB,Q;oBAASxB,I,EAAM;AACd,OAAIA,KAAKyB,CAAL,KAAW,GAAX,IAAkBzB,KAAKlC,IAAL,KAAc,SAApC,EAA+C;AAC9C;AACA;;AACD,OAAI,KAAKrB,aAAT,EAAwB;AACvB,WAAO,KAAKE,kBAAL,CAAwBiF,IAAxB,CAA6B5B,KAAKlC,IAAlC,CAAP;AACA;;AACDL,WAAQC,GAAR,CAAY,qBAAqBC,MAAjC,EAAyC,WAAzC,EAAsDqC,KAAKlC,IAA3D,EAAiE,qBAAjE,EAAwF,KAAKnB,kBAAL,CAAwBkD,IAAxB,CAA6B,GAA7B,CAAxF;AACA,OAAM5B,iBAAgB+B,KAAKlC,IAArB,SAAN;AACA,QAAKpB,oBAAL,CAA0BsD,KAAKlC,IAA/B,IAAuC,EAAvC;AACA,QAAK4D,cAAL,CAAoBzD,GAApB;AACA,QAAKxB,aAAL,GAAqB,IAArB;AACA;;;;;qBAED0F,S;qBAAUnC,I,EAAM;AACf,OAAIA,KAAKyB,CAAL,KAAW,GAAf,EAAoB;AACnB;AACA;;AACD,OAAMxD,iBAAgB+B,KAAKlC,IAArB,SAAN;AACA,QAAK4D,cAAL,CAAoBzD,GAApB;AACA;;;;;qBAEDmE,a;yBAAcpC,I,EAAM;AACnB,OAAIA,KAAKyB,CAAL,KAAW,GAAf,EAAoB;AACnB;AACA;;AACD,OAAMxD,kBAAiB+B,KAAKlC,IAAtB,SAAN;AACA,QAAKpB,oBAAL,CAA0BsD,KAAKlC,IAA/B,IAAuC,EAAvC;AACA,QAAK4D,cAAL,CAAoBzD,GAApB;AACA;;;;;qBAEDc,iB;6BAAkBqC,M,EAAQX,Q,EAAU;AACnC,OAAI,KAAKlF,IAAL,CAAUqC,QAAV,KAAuBwD,MAA3B,EAAmC;AAClC;AACA;;AACD3D,WAAQC,GAAR,CAAY,8BAA8BC,MAA1C,EAAkD,WAAlD,EAA+D8C,QAA/D,EAAyE,SAAzE,EAAoFW,MAApF;AACA,QAAKrB,sBAAL,CAA4BqB,MAA5B;AACA/H,cAAW4G,MAAX,CAAkBC,KAAlB,CAAwBmC,iBAAxB,CAA0C5B,QAA1C,EAAoDW,MAApD;AACA;;;;;qBAEDpC,sB;kCAAuBoC,M,EAAQX,Q,EAAU;AACxChD,WAAQC,GAAR,CAAY,mCAAmCC,MAA/C,EAAuD,WAAvD,EAAoE8C,QAApE,EAA8E,SAA9E,EAAyFW,MAAzF;AACA/H,cAAW4G,MAAX,CAAkBC,KAAlB,CAAwBoC,oBAAxB,CAA6C7B,QAA7C,EAAuDW,MAAvD;AACA;;;;;qBAEDnC,Y;wBAAamC,M,EAAQ;AACpB3D,WAAQC,GAAR,CAAY,wBAAwBC,MAApC,EAA4C,WAA5C,EAAyDyD,MAAzD;AACA/H,cAAW4G,MAAX,CAAkBC,KAAlB,CAAwBqC,qBAAxB,CAA8CnB,MAA9C;AACAjI,UAAOqJ,KAAP,CAAaC,MAAb,CAAoB;AAAE3E,UAAMsD;AAAR,IAApB,EAAsC;AAAEsB,UAAM;AAAEC,aAAQ;AAAV;AAAR,IAAtC;AACA;;;;;qBAED5C,sB;kCAAuBjC,I,EAAM;AAC5B,OAAMvC,OAAOpC,OAAOqJ,KAAP,CAAaI,OAAb,CAAqB;AAAE9E;AAAF,IAArB,CAAb;;AACA,OAAIvC,IAAJ,EAAU;AACT,WAAOA,IAAP;AACA;;AACDkC,WAAQC,GAAR,CAAY,8BAA8BC,MAA1C,EAAkD,WAAlD,EAA+DG,IAA/D;AACA3E,UAAO0J,IAAP,CAAY,cAAZ,EAA4B;AAC3BC,WAAWhF,IAAX,oBAD2B;AAE3BiF,UAAM,YAFqB;AAG3BjF;AAH2B,IAA5B;AAKA3E,UAAOqJ,KAAP,CAAaC,MAAb,CAAoB;AAAE3E;AAAF,IAApB,EAA8B;AAC7B4E,UAAM;AACLC,aAAQ,QADH;AAEL/E,eAAUE;AAFL;AADuB,IAA9B;AAMA,UAAO3E,OAAOqJ,KAAP,CAAaI,OAAb,CAAqB;AAAE9E;AAAF,IAArB,CAAP;AACA;;;;;qBAEDuC,4B;wCAA6BhB,M,EAAQC,M,EAAQ;AAC5C7B,WAAQC,GAAR,CAAY,yCAAyCC,MAArD,EAA6D,SAA7D,EAAwE0B,MAAxE,EAAgF,SAAhF,EAA2FC,MAA3F;AACA,OAAM0D,MAAM,CAAC3D,OAAO7D,GAAR,EAAa8D,OAAO9D,GAApB,EAAyByH,IAAzB,GAAgCpD,IAAhC,CAAqC,EAArC,CAAZ;AACA,OAAML,MAAM,IAAIC,IAAJ,EAAZ;AACApG,cAAW4G,MAAX,CAAkBC,KAAlB,CAAwBgD,MAAxB,CAA+B;AAAE1H,SAAKwH;AAAP,IAA/B,EAA4C;AAC3CN,UAAM;AACL3B,gBAAW,CAAC1B,OAAOzB,QAAR,EAAkB0B,OAAO1B,QAAzB;AADN,KADqC;AAI3CuF,kBAAc;AACb1B,QAAG,GADU;AAEb2B,WAAM,CAFO;AAGb7C,SAAIf;AAHS;AAJ6B,IAA5C;AAUAnG,cAAW4G,MAAX,CAAkBoD,aAAlB,CAAgCH,MAAhC,CAAuC;AAAEF,YAAF;AAAOM,UAAM,CAAC;AAAE,cAAShE,OAAO9D;AAAlB,KAAD;AAAb,IAAvC,EAA+E;AAC9E2H,kBAAc;AACbrF,WAAMuB,OAAOzB,QADA;AAEb6D,QAAG,GAFU;AAGb8B,WAAM,KAHO;AAIb3J,YAAO,KAJM;AAKb4J,aAAQ,CALK;AAMbC,mBAAc,CAND;AAObC,oBAAe,CAPF;AAQb7B,QAAG;AAAErG,WAAK8D,OAAO9D,GAAd;AAAmBoC,gBAAU0B,OAAO1B;AAApC;AARU;AADgE,IAA/E;AAWA,UAAO;AAAE6D,OAAG,GAAL;AAAUjG,SAAKwH;AAAf,IAAP;AACA;;;;;;;;AAGF3H,UAAUsI,QAAV,GAAqB,UAASC,GAAT,EAAc;AAClC,QAAOjJ,aAAaiJ,GAAb,CAAP;AACA,CAFD;;AAIAvI,UAAUwI,MAAV,GAAmB,UAASC,KAAT,EAAgB;AAClC,KAAIA,MAAMvI,IAAN,IAAc,IAAlB,EAAwB;AACvB,SAAOuI,KAAP;AACA;;AACD,KAAI,EAAEA,MAAMvI,IAAN,CAAWC,GAAX,IAAkBb,YAApB,CAAJ,EAAuC;AACtC,MAAMoJ,YAAY,IAAI1I,SAAJ,CAAcyI,KAAd,CAAlB;AACA,SAAO3I,MAAM4I,UAAU3G,OAAhB,CAAP;AACA;;AACD,QAAO0G,KAAP;AACA,CATD;;AAWA,SAASE,UAAT,CAAoBF,KAApB,EAA2B;AAC1BrG,SAAQC,GAAR,CAAY,0BAA0BC,MAAtC,EAA8CmG,KAA9C;AACA,QAAOzI,UAAUwI,MAAV,CAAiBC,KAAjB,CAAP;AACA;;AAGD,SAASG,SAAT,CAAmB3D,OAAnB,EAA4B;AAC3B,KAAMxC,OAAOwC,QAAQuB,CAAR,CAAUjE,QAAvB;AACA,KAAM8B,YAAYY,QAAQC,EAAR,CAAWZ,OAAX,EAAlB;AACA,KAAMC,gBAAe9B,IAAf,GAAwB4B,SAA9B;;AACA,KAAInF,uBAAuBF,GAAvB,CAA2BuF,QAA3B,CAAJ,EAA0C;AACzC,SAAOU,OAAP;AACA;;AACD,KAAMN,OAAO3G,WAAW4G,MAAX,CAAkBC,KAAlB,CAAwBgE,WAAxB,CAAoC5D,QAAQ0C,GAA5C,EAAiD;AAAEhB,UAAQ;AAAElE,SAAM,CAAR;AAAWiD,cAAW,CAAtB;AAAyBU,MAAG;AAA5B;AAAV,EAAjD,CAAb;AACA,KAAMsC,YAAY1I,UAAUsI,QAAV,CAAmBrD,QAAQuB,CAAR,CAAUrG,GAA7B,CAAlB;AACAuI,WAAUvD,WAAV,CAAsBR,IAAtB,EAA4BM,OAA5B;AACA,QAAOA,OAAP;AACA;;AAGD,SAAS6D,aAAT,CAAuB5I,IAAvB,EAA6ByE,IAA7B,EAAmC;AAClC,KAAM+D,YAAY1I,UAAUsI,QAAV,CAAmBpI,KAAKC,GAAxB,CAAlB;AACAuI,WAAUvC,QAAV,CAAmBxB,IAAnB;AACA,QAAOA,IAAP;AACA;;AAGD,SAASoE,aAAT,CAAuB7I,IAAvB,EAA6ByE,IAA7B,EAAmC;AAClC,KAAM+D,YAAY1I,UAAUsI,QAAV,CAAmBpI,KAAKC,GAAxB,CAAlB;AACAuI,WAAU5B,SAAV,CAAoBnC,IAApB;AACA,QAAOA,IAAP;AACA;;AAED,SAASqE,kBAAT,CAA4B9I,IAA5B,EAAkC;AACjC,KAAMwI,YAAY1I,UAAUsI,QAAV,CAAmBpI,KAAKC,GAAxB,CAAlB;AACAuI,WAAUxG,UAAV;AACA,QAAOhC,IAAP;AACA,C,CAED;AACA;AAEA;;;AACA,IAAInB,qBAAqB,IAAzB,EAA+B;AAC9Bf,YAAWiL,SAAX,CAAqB9K,GAArB,CAAyB,qBAAzB,EAAgDwK,UAAhD,EAA4D3K,WAAWiL,SAAX,CAAqBC,QAArB,CAA8BC,GAA1F,EAA+F,aAA/F;AACAnL,YAAWiL,SAAX,CAAqB9K,GAArB,CAAyB,mBAAzB,EAA8CyK,SAA9C,EAAyD5K,WAAWiL,SAAX,CAAqBC,QAArB,CAA8BC,GAAvF,EAA4F,YAA5F;AACAnL,YAAWiL,SAAX,CAAqB9K,GAArB,CAAyB,gBAAzB,EAA2C2K,aAA3C,EAA0D9K,WAAWiL,SAAX,CAAqBC,QAArB,CAA8BC,GAAxF,EAA6F,iBAA7F;AACAnL,YAAWiL,SAAX,CAAqB9K,GAArB,CAAyB,qBAAzB,EAAgD2K,aAAhD,EAA+D9K,WAAWiL,SAAX,CAAqBC,QAArB,CAA8BC,GAA7F,EAAkG,gCAAlG;AACAnL,YAAWiL,SAAX,CAAqB9K,GAArB,CAAyB,iBAAzB,EAA4C4K,aAA5C,EAA2D/K,WAAWiL,SAAX,CAAqBC,QAArB,CAA8BC,GAAzF,EAA8F,iBAA9F;AACAnL,YAAWiL,SAAX,CAAqB9K,GAArB,CAAyB,oBAAzB,EAA+C6K,kBAA/C,EAAmEhL,WAAWiL,SAAX,CAAqBC,QAArB,CAA8BC,GAAjG,EAAsG,cAAtG;AACA,yH","file":"/packages/rocketchat_irc.js","sourcesContent":["Meteor.startup(function() {\n\tRocketChat.settings.addGroup('IRC', function() {\n\n\t\t// Is this thing on?\n\t\tthis.add('IRC_Enabled', false, {\n\t\t\ttype: 'boolean',\n\t\t\ti18nLabel: 'Enabled',\n\t\t\ti18nDescription: 'IRC_Enabled',\n\t\t\talert: 'IRC Support is a work in progress. Use on a production system is not recommended at this time.'\n\t\t});\n\n\t\t// The IRC host server to talk to\n\t\tthis.add('IRC_Host', 'irc.freenode.net', {\n\t\t\ttype: 'string',\n\t\t\ti18nLabel: 'Host',\n\t\t\ti18nDescription: 'IRC_Hostname'\n\t\t});\n\n\t\t// The port to connect on the remote server\n\t\tthis.add('IRC_Port', 6667, {\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Port',\n\t\t\ti18nDescription: 'IRC_Port'\n\t\t});\n\n\t\t// Cache size of the messages we send the host IRC server\n\t\tthis.add('IRC_Message_Cache_Size', 200, {\n\t\t\ttype: 'int',\n\t\t\ti18nLabel: 'Message Cache Size',\n\t\t\ti18nDescription: 'IRC_Message_Cache_Size'\n\t\t});\n\n\t\t// Expandable box for modifying regular expressions for IRC interaction\n\t\tthis.section('Regular_Expressions', function() {\n\t\t\tthis.add('IRC_RegEx_successLogin', 'Welcome to the freenode Internet Relay Chat Network', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Login Successful',\n\t\t\t\ti18nDescription: 'IRC_Login_Success'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_failedLogin', 'You have not registered', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Login Failed',\n\t\t\t\ti18nDescription: 'IRC_Login_Fail'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_receiveMessage', '^:(\\S+)!~\\S+ PRIVMSG (\\S+) :(.+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Private Message',\n\t\t\t\ti18nDescription: 'IRC_Private_Message'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_receiveMemberList', '^:\\S+ \\d+ \\S+ = #(\\S+) :(.*)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Channel User List Start',\n\t\t\t\ti18nDescription: 'IRC_Channel_Users'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_endMemberList', '^.+#(\\S+) :End of \\/NAMES list.$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Channel User List End',\n\t\t\t\ti18nDescription: 'IRC_Channel_Users_End'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_addMemberToRoom', '^:(\\S+)!~\\S+ JOIN #(\\S+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Join Channel',\n\t\t\t\ti18nDescription: 'IRC_Channel_Join'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_removeMemberFromRoom', '^:(\\S+)!~\\S+ PART #(\\S+)$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Leave Channel',\n\t\t\t\ti18nDescription: 'IRC_Channel_Leave'\n\t\t\t});\n\t\t\tthis.add('IRC_RegEx_quitMember', '^:(\\S+)!~\\S+ QUIT .*$', {\n\t\t\t\ttype: 'string',\n\t\t\t\ti18nLabel: 'Quit IRC Session',\n\t\t\t\ti18nDescription: 'IRC_Quit'\n\t\t\t});\n\t\t});\n\n\t});\n});\n","import net from 'net';\nimport Lru from 'lru-cache';\n\n///////\n// Assign values\n\n//Package availability\nconst IRC_AVAILABILITY = RocketChat.settings.get('IRC_Enabled');\n\n// Cache prep\nconst MESSAGE_CACHE_SIZE = RocketChat.settings.get('IRC_Message_Cache_Size');\nconst ircReceiveMessageCache = Lru(MESSAGE_CACHE_SIZE);//eslint-disable-line\nconst ircSendMessageCache = Lru(MESSAGE_CACHE_SIZE);//eslint-disable-line\n\n// IRC server\nconst IRC_PORT = RocketChat.settings.get('IRC_Port');\nconst IRC_HOST = RocketChat.settings.get('IRC_Host');\n\nconst ircClientMap = {};\n\n//////\n// Core functionality\n\nconst bind = function(f) {\n\tconst g = Meteor.bindEnvironment((self, ...args) => f.apply(self, args));\n\treturn function(...args) { g(this, ...args); };\n};\n\nconst async = (f, ...args) => Meteor.wrapAsync(f)(...args);\n\nclass IrcClient {\n\tconstructor(loginReq) {\n\t\tthis.loginReq = loginReq;\n\n\t\tthis.user = this.loginReq.user;\n\t\tircClientMap[this.user._id] = this;\n\t\tthis.ircPort = IRC_PORT;\n\t\tthis.ircHost = IRC_HOST;\n\t\tthis.msgBuf = [];\n\n\t\tthis.isConnected = false;\n\t\tthis.isDistroyed = false;\n\t\tthis.socket = new net.Socket;\n\t\tthis.socket.setNoDelay;\n\t\tthis.socket.setEncoding('utf-8');\n\t\tthis.socket.setKeepAlive(true);\n\t\tthis.onConnect = bind(this.onConnect);\n\t\tthis.onClose = bind(this.onClose);\n\t\tthis.onTimeout = bind(this.onTimeout);\n\t\tthis.onError = bind(this.onError);\n\t\tthis.onReceiveRawMessage = bind(this.onReceiveRawMessage);\n\t\tthis.socket.on('data', this.onReceiveRawMessage);\n\t\tthis.socket.on('close', this.onClose);\n\t\tthis.socket.on('timeout', this.onTimeout);\n\t\tthis.socket.on('error', this.onError);\n\n\t\tthis.isJoiningRoom = false;\n\t\tthis.receiveMemberListBuf = {};\n\t\tthis.pendingJoinRoomBuf = [];\n\n\t\tthis.successLoginMessageRegex = /RocketChat.settings.get('IRC_RegEx_successLogin');/;\n\t\tthis.failedLoginMessageRegex = /RocketChat.settings.get('IRC_RegEx_failedLogin');/;\n\t\tthis.receiveMessageRegex = /RocketChat.settings.get('IRC_RegEx_receiveMessage');/;\n\t\tthis.receiveMemberListRegex = /RocketChat.settings.get('IRC_RegEx_receiveMemberList');/;\n\t\tthis.endMemberListRegex = /RocketChat.settings.get('IRC_RegEx_endMemberList');/;\n\t\tthis.addMemberToRoomRegex = /RocketChat.settings.get('IRC_RegEx_addMemberToRoom');/;\n\t\tthis.removeMemberFromRoomRegex = /RocketChat.settings.get('IRC_RegEx_removeMemberFromRoom');/;\n\t\tthis.quitMemberRegex = /RocketChat.settings.get('IRC_RegEx_quitMember');/;\n\t}\n\n\tconnect(loginCb) {\n\t\tthis.loginCb = loginCb;\n\t\tthis.socket.connect(this.ircPort, this.ircHost, this.onConnect);\n\t\tthis.initRoomList();\n\t}\n\n\tdisconnect() {\n\t\tthis.isDistroyed = true;\n\t\tthis.socket.destroy();\n\t}\n\n\tonConnect() {\n\t\tconsole.log('[irc] onConnect -> '.yellow, this.user.username, 'connect success.');\n\t\tthis.socket.write(`NICK ${ this.user.username }\\r\\n`);\n\t\tthis.socket.write(`USER ${ this.user.username } 0 * :${ this.user.name }\\r\\n`);\n\t\t// message order could not make sure here\n\t\tthis.isConnected = true;\n\t\tconst messageBuf = this.msgBuf;\n\t\tmessageBuf.forEach(msg => this.socket.write(msg));\n\t}\n\n\tonClose() {\n\t\tconsole.log('[irc] onClose -> '.yellow, this.user.username, 'connection close.');\n\t\tthis.isConnected = false;\n\t\tif (this.isDistroyed) {\n\t\t\tdelete ircClientMap[this.user._id];\n\t\t} else {\n\t\t\tthis.connect();\n\t\t}\n\t}\n\n\tonTimeout() {\n\t\tconsole.log('[irc] onTimeout -> '.yellow, this.user.username, 'connection timeout.', arguments);\n\t}\n\n\tonError() {\n\t\tconsole.log('[irc] onError -> '.yellow, this.user.username, 'connection error.', arguments);\n\t}\n\n\tonReceiveRawMessage(data) {\n\t\tdata = data.toString().split('\\n');\n\n\t\tdata.forEach(line => {\n\t\t\tline = line.trim();\n\t\t\tconsole.log(`[${ this.ircHost }:${ this.ircPort }]:`, line);\n\n\t\t\t// Send heartbeat package to irc server\n\t\t\tif (line.indexOf('PING') === 0) {\n\t\t\t\tthis.socket.write(line.replace('PING :', 'PONG '));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet matchResult = this.receiveMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onReceiveMessage(matchResult[1], matchResult[2], matchResult[3]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.receiveMemberListRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onReceiveMemberList(matchResult[1], matchResult[2].split(' '));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.endMemberListRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onEndMemberList(matchResult[1]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.addMemberToRoomRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onAddMemberToRoom(matchResult[1], matchResult[2]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.removeMemberFromRoomRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onRemoveMemberFromRoom(matchResult[1], matchResult[2]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.quitMemberRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onQuitMember(matchResult[1]);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.successLoginMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onSuccessLoginMessage();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmatchResult = this.failedLoginMessageRegex.exec(line);\n\t\t\tif (matchResult) {\n\t\t\t\tthis.onFailedLoginMessage();\n\t\t\t\treturn;\n\t\t\t}\n\t\t});\n\t}\n\n\tonSuccessLoginMessage() {\n\t\tconsole.log('[irc] onSuccessLoginMessage -> '.yellow);\n\t\tif (this.loginCb) {\n\t\t\tthis.loginCb(null, this.loginReq);\n\t\t}\n\t}\n\n\tonFailedLoginMessage() {\n\t\tconsole.log('[irc] onFailedLoginMessage -> '.yellow);\n\t\tthis.loginReq.allowed = false;\n\t\tthis.disconnect();\n\t\tif (this.loginCb) {\n\t\t\tthis.loginCb(null, this.loginReq);\n\t\t}\n\t}\n\n\tonReceiveMessage(source, target, content) {\n\t\tconst now = new Date;\n\t\tconst timestamp = now.getTime();\n\t\tlet cacheKey = [source, target, content].join(',');\n\t\tconsole.log('[irc] ircSendMessageCache.get -> '.yellow, 'key:', cacheKey, 'value:', ircSendMessageCache.get(cacheKey), 'ts:', timestamp - 1000);\n\t\tif (ircSendMessageCache.get(cacheKey) > (timestamp - 1000)) {\n\t\t\treturn;\n\t\t} else {\n\t\t\tircSendMessageCache.set(cacheKey, timestamp);\n\t\t}\n\t\tconsole.log('[irc] onReceiveMessage -> '.yellow, 'source:', source, 'target:', target, 'content:', content);\n\t\tsource = this.createUserWhenNotExist(source);\n\t\tlet room;\n\t\tif (target[0] === '#') {\n\t\t\troom = RocketChat.models.Rooms.findOneByName(target.substring(1));\n\t\t} else {\n\t\t\troom = this.createDirectRoomWhenNotExist(source, this.user);\n\t\t}\n\t\tconst message = { msg: content, ts: now };\n\t\tcacheKey = `${ source.username }${ timestamp }`;\n\t\tircReceiveMessageCache.set(cacheKey, true);\n\t\tconsole.log('[irc] ircReceiveMessageCache.set -> '.yellow, 'key:', cacheKey);\n\t\tRocketChat.sendMessage(source, message, room);\n\t}\n\n\tonReceiveMemberList(roomName, members) {\n\t\tthis.receiveMemberListBuf[roomName] = this.receiveMemberListBuf[roomName].concat(members);\n\t}\n\n\tonEndMemberList(roomName) {\n\t\tconst newMembers = this.receiveMemberListBuf[roomName];\n\t\tconsole.log('[irc] onEndMemberList -> '.yellow, 'room:', roomName, 'members:', newMembers.join(','));\n\t\tconst room = RocketChat.models.Rooms.findOneByNameAndType(roomName, 'c');\n\t\tif (!room) {\n\t\t\treturn;\n\t\t}\n\t\tconst oldMembers = room.usernames;\n\t\tconst appendMembers = _.difference(newMembers, oldMembers);\n\t\tconst removeMembers = _.difference(oldMembers, newMembers);\n\t\tappendMembers.forEach(member => this.createUserWhenNotExist(member));\n\t\tRocketChat.models.Rooms.removeUsernamesById(room._id, removeMembers);\n\t\tRocketChat.models.Rooms.addUsernamesById(room._id, appendMembers);\n\n\t\tthis.isJoiningRoom = false;\n\t\troomName = this.pendingJoinRoomBuf.shift();\n\t\tif (roomName) {\n\t\t\tthis.joinRoom({\n\t\t\t\tt: 'c',\n\t\t\t\tname: roomName\n\t\t\t});\n\t\t}\n\t}\n\n\tsendRawMessage(msg) {\n\t\tconsole.log('[irc] sendRawMessage -> '.yellow, msg.slice(0, -2));\n\t\tif (this.isConnected) {\n\t\t\tthis.socket.write(msg);\n\t\t} else {\n\t\t\tthis.msgBuf.push(msg);\n\t\t}\n\t}\n\n\tsendMessage(room, message) {\n\t\tconsole.log('[irc] sendMessage -> '.yellow, 'userName:', message.u.username);\n\t\tlet target = '';\n\t\tif (room.t === 'c') {\n\t\t\ttarget = `#${ room.name }`;\n\t\t} else if (room.t === 'd') {\n\t\t\tconst usernames = room.usernames;\n\t\t\tusernames.forEach(name => {\n\t\t\t\tif (message.u.username !== name) {\n\t\t\t\t\ttarget = name;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tconst cacheKey = [this.user.username, target, message.msg].join(',');\n\t\tconsole.log('[irc] ircSendMessageCache.set -> '.yellow, 'key:', cacheKey, 'ts:', message.ts.getTime());\n\t\tircSendMessageCache.set(cacheKey, message.ts.getTime());\n\t\tconst msg = `PRIVMSG ${ target } :${ message.msg }\\r\\n`;\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tinitRoomList() {\n\t\tconst roomsCursor = RocketChat.models.Rooms.findByTypeContainingUsername('c', this.user.username, { fields: { name: 1, t: 1 }});\n\t\tconst rooms = roomsCursor.fetch();\n\t\trooms.forEach(room => this.joinRoom(room));\n\t}\n\n\tjoinRoom(room) {\n\t\tif (room.t !== 'c' || room.name === 'general') {\n\t\t\treturn;\n\t\t}\n\t\tif (this.isJoiningRoom) {\n\t\t\treturn this.pendingJoinRoomBuf.push(room.name);\n\t\t}\n\t\tconsole.log('[irc] joinRoom -> '.yellow, 'roomName:', room.name, 'pendingJoinRoomBuf:', this.pendingJoinRoomBuf.join(','));\n\t\tconst msg = `JOIN #${ room.name }\\r\\n`;\n\t\tthis.receiveMemberListBuf[room.name] = [];\n\t\tthis.sendRawMessage(msg);\n\t\tthis.isJoiningRoom = true;\n\t}\n\n\tleaveRoom(room) {\n\t\tif (room.t !== 'c') {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = `PART #${ room.name }\\r\\n`;\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tgetMemberList(room) {\n\t\tif (room.t !== 'c') {\n\t\t\treturn;\n\t\t}\n\t\tconst msg = `NAMES #${ room.name }\\r\\n`;\n\t\tthis.receiveMemberListBuf[room.name] = [];\n\t\tthis.sendRawMessage(msg);\n\t}\n\n\tonAddMemberToRoom(member, roomName) {\n\t\tif (this.user.username === member) {\n\t\t\treturn;\n\t\t}\n\t\tconsole.log('[irc] onAddMemberToRoom -> '.yellow, 'roomName:', roomName, 'member:', member);\n\t\tthis.createUserWhenNotExist(member);\n\t\tRocketChat.models.Rooms.addUsernameByName(roomName, member);\n\t}\n\n\tonRemoveMemberFromRoom(member, roomName) {\n\t\tconsole.log('[irc] onRemoveMemberFromRoom -> '.yellow, 'roomName:', roomName, 'member:', member);\n\t\tRocketChat.models.Rooms.removeUsernameByName(roomName, member);\n\t}\n\n\tonQuitMember(member) {\n\t\tconsole.log('[irc] onQuitMember ->'.yellow, 'username:', member);\n\t\tRocketChat.models.Rooms.removeUsernameFromAll(member);\n\t\tMeteor.users.update({ name: member }, { $set: { status: 'offline' }});\n\t}\n\n\tcreateUserWhenNotExist(name) {\n\t\tconst user = Meteor.users.findOne({ name });\n\t\tif (user) {\n\t\t\treturn user;\n\t\t}\n\t\tconsole.log('[irc] createNotExistUser ->'.yellow, 'userName:', name);\n\t\tMeteor.call('registerUser', {\n\t\t\temail: `${ name }@rocketchat.org`,\n\t\t\tpass: 'rocketchat',\n\t\t\tname\n\t\t});\n\t\tMeteor.users.update({ name }, {\n\t\t\t$set: {\n\t\t\t\tstatus: 'online',\n\t\t\t\tusername: name\n\t\t\t}\n\t\t});\n\t\treturn Meteor.users.findOne({ name });\n\t}\n\n\tcreateDirectRoomWhenNotExist(source, target) {\n\t\tconsole.log('[irc] createDirectRoomWhenNotExist -> '.yellow, 'source:', source, 'target:', target);\n\t\tconst rid = [source._id, target._id].sort().join('');\n\t\tconst now = new Date();\n\t\tRocketChat.models.Rooms.upsert({ _id: rid}, {\n\t\t\t$set: {\n\t\t\t\tusernames: [source.username, target.username]\n\t\t\t},\n\t\t\t$setOnInsert: {\n\t\t\t\tt: 'd',\n\t\t\t\tmsgs: 0,\n\t\t\t\tts: now\n\t\t\t}\n\t\t});\n\t\tRocketChat.models.Subscriptions.upsert({ rid, $and: [{ 'u._id': target._id}]}, {\n\t\t\t$setOnInsert: {\n\t\t\t\tname: source.username,\n\t\t\t\tt: 'd',\n\t\t\t\topen: false,\n\t\t\t\talert: false,\n\t\t\t\tunread: 0,\n\t\t\t\tuserMentions: 0,\n\t\t\t\tgroupMentions: 0,\n\t\t\t\tu: { _id: target._id, username: target.username }}\n\t\t});\n\t\treturn { t: 'd', _id: rid };\n\t}\n}\n\nIrcClient.getByUid = function(uid) {\n\treturn ircClientMap[uid];\n};\n\nIrcClient.create = function(login) {\n\tif (login.user == null) {\n\t\treturn login;\n\t}\n\tif (!(login.user._id in ircClientMap)) {\n\t\tconst ircClient = new IrcClient(login);\n\t\treturn async(ircClient.connect);\n\t}\n\treturn login;\n};\n\nfunction IrcLoginer(login) {\n\tconsole.log('[irc] validateLogin -> '.yellow, login);\n\treturn IrcClient.create(login);\n}\n\n\nfunction IrcSender(message) {\n\tconst name = message.u.username;\n\tconst timestamp = message.ts.getTime();\n\tconst cacheKey = `${ name }${ timestamp }`;\n\tif (ircReceiveMessageCache.get(cacheKey)) {\n\t\treturn message;\n\t}\n\tconst room = RocketChat.models.Rooms.findOneById(message.rid, { fields: { name: 1, usernames: 1, t: 1 }});\n\tconst ircClient = IrcClient.getByUid(message.u._id);\n\tircClient.sendMessage(room, message);\n\treturn message;\n}\n\n\nfunction IrcRoomJoiner(user, room) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.joinRoom(room);\n\treturn room;\n}\n\n\nfunction IrcRoomLeaver(user, room) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.leaveRoom(room);\n\treturn room;\n}\n\nfunction IrcLogoutCleanUper(user) {\n\tconst ircClient = IrcClient.getByUid(user._id);\n\tircClient.disconnect();\n\treturn user;\n}\n\n//////\n// Make magic happen\n\n// Only proceed if the package has been enabled\nif (IRC_AVAILABILITY === true) {\n\tRocketChat.callbacks.add('beforeValidateLogin', IrcLoginer, RocketChat.callbacks.priority.LOW, 'irc-loginer');\n\tRocketChat.callbacks.add('beforeSaveMessage', IrcSender, RocketChat.callbacks.priority.LOW, 'irc-sender');\n\tRocketChat.callbacks.add('beforeJoinRoom', IrcRoomJoiner, RocketChat.callbacks.priority.LOW, 'irc-room-joiner');\n\tRocketChat.callbacks.add('beforeCreateChannel', IrcRoomJoiner, RocketChat.callbacks.priority.LOW, 'irc-room-joiner-create-channel');\n\tRocketChat.callbacks.add('beforeLeaveRoom', IrcRoomLeaver, RocketChat.callbacks.priority.LOW, 'irc-room-leaver');\n\tRocketChat.callbacks.add('afterLogoutCleanUp', IrcLogoutCleanUper, RocketChat.callbacks.priority.LOW, 'irc-clean-up');\n}\n"]}