{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:mentions/server.js","meteor://ðŸ’»app/packages/rocketchat:mentions/Mentions.js","meteor://ðŸ’»app/packages/rocketchat:mentions/MentionsServer.js"],"names":["MentionsServer","module","watch","require","v","mention","pattern","RocketChat","settings","get","messageMaxAll","getUsers","usernames","Meteor","users","find","username","$in","_","unique","fields","_id","fetch","getChannel","rid","models","Rooms","findOneById","getChannels","channels","name","t","callbacks","add","message","execute","priority","HIGH","exportDefault","useRealName","me","replaceUsers","str","replace","userMentionRegex","match","includes","mentionObj","findWhere","mentions","temp","replaceChannels","channelMentionRegex","getUserMentions","getChannelMentions","parse","msg","html","trim","m","_me","p","_pattern","s","_useRealName","RegExp","export","Mentions","args","getUsersByMentions","mentionsAll","userMentions","forEach","substr","push","allChannel","length","getChannelbyMentions","map","c","_getUsers","_getChannels","_getChannel","_messageMaxAll"],"mappings":"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","file":"/packages/rocketchat_mentions.js","sourcesContent":["import MentionsServer from './MentionsServer';\nconst mention = new MentionsServer({\n\tpattern: () => RocketChat.settings.get('UTF8_Names_Validation'),\n\tmessageMaxAll: () => RocketChat.settings.get('Message_MaxAll'),\n\tgetUsers: (usernames) => Meteor.users.find({ username: {$in: _.unique(usernames)}}, { fields: {_id: true, username: true }}).fetch(),\n\tgetChannel: (rid) => RocketChat.models.Rooms.findOneById(rid),\n\tgetChannels: (channels) => RocketChat.models.Rooms.find({ name: {$in: _.unique(channels)}, t: 'c'\t}, { fields: {_id: 1, name: 1 }}).fetch()\n});\nRocketChat.callbacks.add('beforeSaveMessage', (message) => mention.execute(message), RocketChat.callbacks.priority.HIGH, 'mentions');\n","/*\n* Mentions is a named function that will process Mentions\n* @param {Object} message - The message object\n*/\nimport _ from 'underscore';\nexport default class {\n\tconstructor({pattern, useRealName, me}) {\n\t\tthis.pattern = pattern;\n\t\tthis.useRealName = useRealName;\n\t\tthis.me = me;\n\t}\n\tset me(m) {\n\t\tthis._me = m;\n\t}\n\tget me() {\n\t\treturn typeof this._me === 'function' ? this._me() : this._me;\n\t}\n\tset pattern(p) {\n\t\tthis._pattern = p;\n\t}\n\tget pattern() {\n\t\treturn typeof this._pattern === 'function' ? this._pattern() : this._pattern;\n\t}\n\tset useRealName(s) {\n\t\tthis._useRealName = s;\n\t}\n\tget useRealName() {\n\t\treturn typeof this._useRealName === 'function' ? this._useRealName() : this._useRealName;\n\t}\n\tget userMentionRegex() {\n\t\treturn new RegExp(`@(${ this.pattern })`, 'gm');\n\t}\n\tget channelMentionRegex() {\n\t\treturn new RegExp(`#(${ this.pattern })`, 'gm');\n\t}\n\treplaceUsers(str, message, me) {\n\t\treturn str.replace(this.userMentionRegex, (match, username) => {\n\t\t\tif (['all', 'here'].includes(username)) {\n\t\t\t\treturn `<a class=\"mention-link mention-link-me mention-link-all background-attention-color\">${ match }</a>`;\n\t\t\t}\n\n\t\t\tconst mentionObj = _.findWhere(message.mentions, {username});\n\t\t\tif (message.temp == null && mentionObj == null) {\n\t\t\t\treturn match;\n\t\t\t}\n\t\t\tconst name = this.useRealName && mentionObj && mentionObj.name;\n\n\t\t\treturn `<a class=\"mention-link ${ username === me ? 'mention-link-me background-primary-action-color':'' }\" data-username=\"${ username }\" title=\"${ name ? username : '' }\">${ name || match }</a>`;\n\t\t});\n\t}\n\treplaceChannels(str, message) {\n\t\t//since apostrophe escaped contains # we need to unescape it\n\t\treturn str.replace(/&#39;/g, '\\'').replace(this.channelMentionRegex, (match, name) => {\n\t\t\tif (message.temp == null && _.findWhere(message.channels, {name}) == null) {\n\t\t\t\treturn match;\n\t\t\t}\n\t\t\treturn `<a class=\"mention-link\" data-channel=\"${ name }\">${ match }</a>`;\n\t\t});\n\t}\n\tgetUserMentions(str) {\n\t\treturn str.match(this.userMentionRegex) || [];\n\t}\n\tgetChannelMentions(str) {\n\t\treturn str.match(this.channelMentionRegex) || [];\n\t}\n\tparse(message) {\n\t\tlet msg = (message && message.html) || '';\n\t\tif (!msg.trim()) {\n\t\t\treturn message;\n\t\t}\n\t\tmsg = this.replaceUsers(msg, message, this.me);\n\t\tmsg = this.replaceChannels(msg, message, this.me);\n\t\tmessage.html = msg;\n\t\treturn message;\n\t}\n}\n","/*\n* Mentions is a named function that will process Mentions\n* @param {Object} message - The message object\n*/\nimport Mentions from './Mentions';\nexport default class MentionsServer extends Mentions {\n\tconstructor(args) {\n\t\tsuper(args);\n\t\tthis.messageMaxAll = args.messageMaxAll;\n\t\tthis.getChannel = args.getChannel;\n\t\tthis.getChannels = args.getChannels;\n\t\tthis.getUsers = args.getUsers;\n\t}\n\tset getUsers(m) {\n\t\tthis._getUsers = m;\n\t}\n\tget getUsers() {\n\t\treturn typeof this._getUsers === 'function' ? this._getUsers : () => this._getUsers;\n\t}\n\tset getChannels(m) {\n\t\tthis._getChannels = m;\n\t}\n\tget getChannels() {\n\t\treturn typeof this._getChannels === 'function' ? this._getChannels : () => this._getChannels;\n\t}\n\tset getChannel(m) {\n\t\tthis._getChannel = m;\n\t}\n\tget getChannel() {\n\t\treturn typeof this._getChannel === 'function' ? this._getChannel : () => this._getChannel;\n\t}\n\tset messageMaxAll(m) {\n\t\tthis._messageMaxAll = m;\n\t}\n\tget messageMaxAll() {\n\t\treturn typeof this._messageMaxAll === 'function' ? this._messageMaxAll() : this._messageMaxAll;\n\t}\n\tgetUsersByMentions({msg, rid}) {\n\t\tlet mentions = this.getUserMentions(msg);\n\t\tconst mentionsAll = [];\n\t\tconst userMentions = [];\n\n\t\tmentions.forEach((m) => {\n\t\t\tconst mention = m.trim().substr(1);\n\t\t\tif (mention !== 'all' && mention !== 'here') {\n\t\t\t\treturn userMentions.push(mention);\n\t\t\t}\n\t\t\tif (mention === 'all') {\n\t\t\t\tconst messageMaxAll = this.messageMaxAll;\n\t\t\t\tconst allChannel = this.getChannel(rid);\n\t\t\t\tif (messageMaxAll !== 0 && allChannel.usernames.length >= messageMaxAll) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tmentionsAll.push({\n\t\t\t\t_id: mention,\n\t\t\t\tusername: mention\n\t\t\t});\n\t\t});\n\t\tmentions = userMentions.length ? this.getUsers(userMentions) : [];\n\t\treturn [...mentionsAll, ...mentions];\n\t}\n\tgetChannelbyMentions({msg}) {\n\t\tconst channels = this.getChannelMentions(msg);\n\t\treturn this.getChannels(channels.map(c => c.trim().substr(1)));\n\t}\n\texecute(message) {\n\t\tconst mentionsAll = this.getUsersByMentions(message);\n\t\tconst channels = this.getChannelbyMentions(message);\n\n\t\tmessage.mentions = mentionsAll;\n\n\t\tmessage.channels = channels;\n\t\treturn message;\n\t}\n}\n"]}