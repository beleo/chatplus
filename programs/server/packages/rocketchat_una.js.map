{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat_una/common.coffee","meteor://ðŸ’»app/common.coffee.js","meteor://ðŸ’»app/packages/rocketchat_una/startup.coffee"],"names":["Una","UnaOnCreateUser","config","serverURL","authorizePath","tokenPath","identityPath","scope","addAutopublishFields","forLoggedInUser","forOtherUsers","CustomOAuth","options","user","ref","ref1","ref2","ref3","services","una","profile_display_name","username","replace","name","Meteor","isServer","startup","data","RocketChat","models","Settings","find","_id","observe","added","record","settings","get","configure","changed","buttonLabelText","buttonColor","buttonLabelColor","clientId","secret","loginStyle","siteName","ServiceConfiguration","configurations","upsert","service","$set","callbacks","add","priority","HIGH","Tracker","autorun","type","group","section","i18nLabel","persistent","values","key"],"mappings":"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","file":"/packages/rocketchat_una.js","sourcesContent":["# UNA OAuth2\n\nconfig =\n\tserverURL: ''\n\tauthorizePath: '/m/oauth2/auth/'\n\ttokenPath: '/m/oauth2/token/'\n\tidentityPath: '/m/oauth2/api/me/'\n\tscope: 'basic'\n\taddAutopublishFields:\n\t\tforLoggedInUser: ['services.una']\n\t\tforOtherUsers: ['services.una.name']\n\nUna = new CustomOAuth 'una', config\n\nclass UnaOnCreateUser\n\tconstructor: (options, user) ->\n\t\tif user.services?.una?.profile_display_name?\n\t\t\tuser.username = user.services.una.profile_display_name.replace(/[^A-Za-z0-9]/g, '.').replace(/\\.+/g, '.').replace(/(^\\.)|(\\.$)/g, '')\n\t\t\tuser.name = user.services.una.profile_display_name\n\t\telse if user.services?.una?.name?\n\t\t\tuser.username = user.services.una.name\n\t\treturn user\n\nif Meteor.isServer\n\tMeteor.startup ->\n\t\tRocketChat.models.Settings.find({ _id: 'Accounts_OAuth_UNA_URL' }).observe\n\t\t\tadded: (record) ->\n\t\t\t\tconfig.serverURL = RocketChat.settings.get 'Accounts_OAuth_UNA_URL'\n\t\t\t\tUna.configure config\n\t\t\tchanged: (record) ->\n\t\t\t\tconfig.serverURL = RocketChat.settings.get 'Accounts_OAuth_UNA_URL'\n\t\t\t\tUna.configure config\n\n\t\tif RocketChat.settings.get 'Accounts_OAuth_UNA_URL'\n\t\t\tdata =\n\t\t\t\tbuttonLabelText: RocketChat.settings.get 'Accounts_OAuth_UNA_button_label_text'\n\t\t\t\tbuttonColor: RocketChat.settings.get 'Accounts_OAuth_UNA_button_color'\n\t\t\t\tbuttonLabelColor: RocketChat.settings.get 'Accounts_OAuth_UNA_button_label_color'\n\t\t\t\tclientId: RocketChat.settings.get 'Accounts_OAuth_UNA_id'\n\t\t\t\tsecret: RocketChat.settings.get 'Accounts_OAuth_UNA_secret'\n\t\t\t\tloginStyle: RocketChat.settings.get 'Accounts_OAuth_UNA_login_style'\n\t\t\t\tsiteName: RocketChat.settings.get 'Accounts_OAuth_UNA_Site_Name'\n\n\t\t\tServiceConfiguration.configurations.upsert {service: 'una'}, $set: data\n\n\tRocketChat.callbacks.add 'beforeCreateUser', UnaOnCreateUser, RocketChat.callbacks.priority.HIGH\nelse\n\tMeteor.startup ->\n\t\tTracker.autorun ->\n\n\t\t\tif RocketChat.settings.get 'Accounts_OAuth_UNA_URL'\n\t\t\t\tconfig.serverURL = RocketChat.settings.get 'Accounts_OAuth_UNA_URL'\n\t\t\t\tUna.configure config\n\n","var Una, UnaOnCreateUser, config;\n\nconfig = {\n  serverURL: '',\n  authorizePath: '/m/oauth2/auth/',\n  tokenPath: '/m/oauth2/token/',\n  identityPath: '/m/oauth2/api/me/',\n  scope: 'basic',\n  addAutopublishFields: {\n    forLoggedInUser: ['services.una'],\n    forOtherUsers: ['services.una.name']\n  }\n};\n\nUna = new CustomOAuth('una', config);\n\nUnaOnCreateUser = (function() {\n  function UnaOnCreateUser(options, user) {\n    var ref, ref1, ref2, ref3;\n    if (((ref = user.services) != null ? (ref1 = ref.una) != null ? ref1.profile_display_name : void 0 : void 0) != null) {\n      user.username = user.services.una.profile_display_name.replace(/[^A-Za-z0-9]/g, '.').replace(/\\.+/g, '.').replace(/(^\\.)|(\\.$)/g, '');\n      user.name = user.services.una.profile_display_name;\n    } else if (((ref2 = user.services) != null ? (ref3 = ref2.una) != null ? ref3.name : void 0 : void 0) != null) {\n      user.username = user.services.una.name;\n    }\n    return user;\n  }\n\n  return UnaOnCreateUser;\n\n})();\n\nif (Meteor.isServer) {\n  Meteor.startup(function() {\n    var data;\n    RocketChat.models.Settings.find({\n      _id: 'Accounts_OAuth_UNA_URL'\n    }).observe({\n      added: function(record) {\n        config.serverURL = RocketChat.settings.get('Accounts_OAuth_UNA_URL');\n        return Una.configure(config);\n      },\n      changed: function(record) {\n        config.serverURL = RocketChat.settings.get('Accounts_OAuth_UNA_URL');\n        return Una.configure(config);\n      }\n    });\n    if (RocketChat.settings.get('Accounts_OAuth_UNA_URL')) {\n      data = {\n        buttonLabelText: RocketChat.settings.get('Accounts_OAuth_UNA_button_label_text'),\n        buttonColor: RocketChat.settings.get('Accounts_OAuth_UNA_button_color'),\n        buttonLabelColor: RocketChat.settings.get('Accounts_OAuth_UNA_button_label_color'),\n        clientId: RocketChat.settings.get('Accounts_OAuth_UNA_id'),\n        secret: RocketChat.settings.get('Accounts_OAuth_UNA_secret'),\n        loginStyle: RocketChat.settings.get('Accounts_OAuth_UNA_login_style'),\n        siteName: RocketChat.settings.get('Accounts_OAuth_UNA_Site_Name')\n      };\n      return ServiceConfiguration.configurations.upsert({\n        service: 'una'\n      }, {\n        $set: data\n      });\n    }\n  });\n  RocketChat.callbacks.add('beforeCreateUser', UnaOnCreateUser, RocketChat.callbacks.priority.HIGH);\n} else {\n  Meteor.startup(function() {\n    return Tracker.autorun(function() {\n      if (RocketChat.settings.get('Accounts_OAuth_UNA_URL')) {\n        config.serverURL = RocketChat.settings.get('Accounts_OAuth_UNA_URL');\n        return Una.configure(config);\n      }\n    });\n  });\n}\n","RocketChat.settings.add 'Accounts_OAuth_UNA_URL', '', { type: 'string', group: 'OAuth', public: true, section: 'UNA', i18nLabel: 'URL' }\nRocketChat.settings.add 'Accounts_OAuth_UNA_Site_Name', 'UNA', { type: 'string', group: 'OAuth', public: true, section: 'UNA', i18nLabel: 'Site_Name' }\nRocketChat.settings.add 'Accounts_OAuth_UNA', false, { type: 'boolean', group: 'OAuth', section: 'UNA', i18nLabel: 'Accounts_OAuth_Custom_Enable' }\nRocketChat.settings.add 'Accounts_OAuth_UNA_id', '', { type: 'string', group: 'OAuth', section: 'UNA', i18nLabel: 'Accounts_OAuth_Custom_id' }\nRocketChat.settings.add 'Accounts_OAuth_UNA_secret', '', { type: 'string', group: 'OAuth', section: 'UNA', i18nLabel: 'Accounts_OAuth_Custom_Secret' }\nRocketChat.settings.add 'Accounts_OAuth_UNA_login_style', 'redirect', { type: 'select' , group: 'OAuth', section: \"UNA\", i18nLabel: 'Accounts_OAuth_Custom_Login_Style', persistent: true, values: [ { key: 'redirect', i18nLabel: 'Redirect' }, { key: 'popup', i18nLabel: 'Popup' }, { key: '', i18nLabel: 'Default' } ] }\nRocketChat.settings.add 'Accounts_OAuth_UNA_button_label_text', '', { type: 'string' , group: 'OAuth', section: \"UNA\", i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Text', persistent: true }\nRocketChat.settings.add 'Accounts_OAuth_UNA_button_label_color', '#FFFFFF', { type: 'string' , group: 'OAuth', section: \"UNA\", i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Color', persistent: true }\nRocketChat.settings.add 'Accounts_OAuth_UNA_button_color', '#13679A', { type: 'string', group: 'OAuth', section: 'UNA', i18nLabel: 'Accounts_OAuth_Custom_Button_Color', persistent: true }\n"]}