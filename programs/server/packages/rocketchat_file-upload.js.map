{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:file-upload/globalFileRestrictions.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/lib/FileUploadBase.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/FileUpload.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/proxy.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/lib/requests.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/_configUploadStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/AmazonS3.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/FileSystem.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GoogleStorage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/GridFS.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/config/Slingshot_DEPRECATED.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/sendFileMessage.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/methods/getS3FileUrl.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/server/startup/settings.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/AmazonS3/server.js","meteor://ðŸ’»app/packages/rocketchat:file-upload/ufs/GoogleStorage/server.js"],"names":["filesize","module","watch","require","v","slingShotConfig","authorize","file","userId","Meteor","Error","RocketChat","fileUploadIsValidContentType","type","TAPi18n","__","maxFileSize","settings","get","size","maxSize","allowedFileTypes","Slingshot","fileRestrictions","FileUpload","validateFileUpload","Match","test","rid","String","user","room","models","Rooms","findOneById","directMessageAllow","fileUploadAllowed","authz","canAccessRoom","reason","language","t","parseInt","key","value","UploadFS","config","defaultStorePermissions","StorePermissions","insert","doc","message_id","indexOf","update","hasPermission","remove","FileUploadBase","store","meta","id","Random","getProgress","getFileName","name","start","callback","handler","Uploader","data","onError","err","onComplete","fileData","_","pick","url","replace","absoluteUrl","options","onProgress","progress","stop","export","FileUploadClass","fs","stream","mime","Future","Object","assign","handlers","configureUploadsStore","split","pop","stores","getStores","defaultUploads","collection","Uploads","model","filter","Filter","onCheck","getPath","_id","onValidate","uploadsOnValidate","defaultAvatars","Avatars","avatarsOnValidate","onFinishUpload","avatarsOnFinishUpload","avatarTransformWrite","readStream","writeStream","RocketChatFile","enabled","pipe","height","width","Info","GraphicsMagick","alpha","gm","background","resize","gravity","crop","extent","tempFilePath","getTempFilePath","future","setFormat","write","bindEnvironment","console","error","lstatSync","getCollection","direct","$set","return","wait","uploadsTransformWrite","fileId","undefined","identify","format","Orientation","includes","autoOrient","tmpFile","fut","Users","oldAvatar","findOneByName","username","deleteFile","updateFileNameById","addExtensionTo","lookup","ext","extension","RegExp","getStore","modelName","storageType","handlerName","getStoreByName","req","res","next","writeHead","end","getModelFromName","_store","delete","deleteById","deleteByName","fileName","streamOrBuffer","cb","create","token","createToken","createWriteStream","Buffer","writeFileSync","call","e","http","URL","logger","Logger","WebApp","connectHandlers","stack","unshift","route","handle","storesPath","debug","method","parsedUrl","parse","path","pathname","substr","length","regExp","match","exec","findOne","instanceId","InstanceStatus","instance","extraInformation","host","process","env","INSTANCE_IP","isDocker","port","hostname","originalUrl","proxy","request","proxy_res","Cookies","protectedFiles","use","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","public","sandstorm","rawCookies","uid","cookie","headers","query","rc_uid","rc_token","findOneByIdAndLoginToken","setHeader","configStore","debounce","log","fileUrl","getRedirectURL","AmazonS3Uploads","AmazonS3Avatars","configure","Bucket","Acl","AWSAccessKeyId","AWSSecretAccessKey","URLExpiryTimeSpan","Region","SignatureVersion","ForcePathStyle","BucketURL","connection","accessKeyId","secretAccessKey","signatureVersion","s3ForcePathStyle","params","ACL","region","endpoint","FileSystemUploads","filePath","getFilePath","stat","wrapAsync","isFile","encodeURIComponent","uploadedAt","toUTCString","getReadStream","FileSystemAvatars","reqModifiedHeader","createFileSystemStore","GoogleCloudStorageUploads","GoogleCloudStorageAvatars","bucket","accessId","secret","credentials","client_email","private_key","zlib","util","ExtractRange","bytes_read","Transform","inherits","prototype","_transform","chunk","enc","newchunk","slice","push","getByteRange","header","matches","readFromGridFS","storeName","rs","ws","PassThrough","forEach","on","onReadError","emit","accept","transformRead","range","out_of_range","createGzip","createDeflate","onRead","collectionName","configureSlingshot","acl","accessKey","secretKey","cdn","bucketUrl","_directives","isEmpty","metaContext","upload","AmazonS3","insertFileInit","createDirective","S3Storage","message","createGoogleStorageDirective","GoogleAccessId","GoogleSecretKey","GoogleStorage","GoogleCloud","methods","roomId","msgData","check","avatar","Optional","emoji","alias","groupable","Boolean","msg","updateFileComplete","omit","attachment","title","description","title_link","title_link_download","image_url","image_type","image_size","image_dimensions","audio_url","audio_type","audio_size","video_url","video_type","video_size","ts","Date","attachments","defer","callbacks","run","getS3FileUrl","addGroup","add","i18nDescription","values","i18nLabel","section","enableQuery","multiline","AmazonS3Store","S3","extend","httpOptions","timeout","agent","classOptions","s3","Key","Expires","getSignedUrl","deleteObject","Range","getObject","createReadStream","getWriteStream","event","listener","nextTick","removeListener","putObject","Body","ContentType","ContentDisposition","Store","GoogleStorageStore","gcStorage","gcs","googleCloudStorage","action","responseDisposition","expires","now","gzip","metadata","contentType","contentDisposition"],"mappings":"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","file":"/packages/rocketchat_file-upload.js","sourcesContent":["/* globals Slingshot */\n\nimport filesize from 'filesize';\n\nconst slingShotConfig = {\n\tauthorize(file/*, metaContext*/) {\n\t\t//Deny uploads if user is not logged in.\n\t\tif (!this.userId) {\n\t\t\tthrow new Meteor.Error('login-required', 'Please login before posting files');\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('error-invalid-file-type'));\n\t\t}\n\n\t\tconst maxFileSize = RocketChat.settings.get('FileUpload_MaxFileSize');\n\n\t\tif (maxFileSize && maxFileSize < file.size) {\n\t\t\tthrow new Meteor.Error(TAPi18n.__('File_exceeds_allowed_size_of_bytes', { size: filesize(maxFileSize) }));\n\t\t}\n\n\t\treturn true;\n\t},\n\tmaxSize: 0,\n\tallowedFileTypes: null\n};\n\nSlingshot.fileRestrictions('rocketchat-uploads', slingShotConfig);\nSlingshot.fileRestrictions('rocketchat-uploads-gs', slingShotConfig);\n","/* globals FileUpload:true */\n/* exported FileUpload */\n\nimport filesize from 'filesize';\n\nlet maxFileSize = 0;\n\nFileUpload = {\n\tvalidateFileUpload(file) {\n\t\tif (!Match.test(file.rid, String)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tconst room = RocketChat.models.Rooms.findOneById(file.rid);\n\t\tconst directMessageAllow = RocketChat.settings.get('FileUpload_Enabled_Direct');\n\t\tconst fileUploadAllowed = RocketChat.settings.get('FileUpload_Enabled');\n\n\t\tif (RocketChat.authz.canAccessRoom(room, user) !== true) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!fileUploadAllowed) {\n\t\t\tconst reason = TAPi18n.__('FileUpload_Disabled', user.language);\n\t\t\tthrow new Meteor.Error('error-file-upload-disabled', reason);\n\t\t}\n\n\t\tif (!directMessageAllow && room.t === 'd') {\n\t\t\tconst reason = TAPi18n.__('File_not_allowed_direct_messages', user.language);\n\t\t\tthrow new Meteor.Error('error-direct-message-file-upload-not-allowed', reason);\n\t\t}\n\n\t\tif (file.size > maxFileSize) {\n\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t}, user.language);\n\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t}\n\n\t\tif (parseInt(maxFileSize) > 0) {\n\t\t\tif (file.size > maxFileSize) {\n\t\t\t\tconst reason = TAPi18n.__('File_exceeds_allowed_size_of_bytes', {\n\t\t\t\t\tsize: filesize(maxFileSize)\n\t\t\t\t}, user.language);\n\t\t\t\tthrow new Meteor.Error('error-file-too-large', reason);\n\t\t\t}\n\t\t}\n\n\t\tif (!RocketChat.fileUploadIsValidContentType(file.type)) {\n\t\t\tconst reason = TAPi18n.__('File_type_is_not_accepted', user.language);\n\t\t\tthrow new Meteor.Error('error-invalid-file-type', reason);\n\t\t}\n\n\t\treturn true;\n\t}\n};\n\nRocketChat.settings.get('FileUpload_MaxFileSize', function(key, value) {\n\tmaxFileSize = value;\n});\n","/* globals FileUploadBase:true, UploadFS */\n/* exported FileUploadBase */\n\nUploadFS.config.defaultStorePermissions = new UploadFS.StorePermissions({\n\tinsert(userId, doc) {\n\t\treturn userId || (doc && doc.message_id && doc.message_id.indexOf('slack-') === 0); // allow inserts from slackbridge (message_id = slack-timestamp-milli)\n\t},\n\tupdate(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t},\n\tremove(userId, doc) {\n\t\treturn RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', doc.rid) || (RocketChat.settings.get('Message_AllowDeleting') && userId === doc.userId);\n\t}\n});\n\n\nFileUploadBase = class FileUploadBase {\n\tconstructor(store, meta, file) {\n\t\tthis.id = Random.id();\n\t\tthis.meta = meta;\n\t\tthis.file = file;\n\t\tthis.store = store;\n\t}\n\n\tgetProgress() {\n\n\t}\n\n\tgetFileName() {\n\t\treturn this.meta.name;\n\t}\n\n\tstart(callback) {\n\t\tthis.handler = new UploadFS.Uploader({\n\t\t\tstore: this.store,\n\t\t\tdata: this.file,\n\t\t\tfile: this.meta,\n\t\t\tonError: (err) => {\n\t\t\t\treturn callback(err);\n\t\t\t},\n\t\t\tonComplete: (fileData) => {\n\t\t\t\tconst file = _.pick(fileData, '_id', 'type', 'size', 'name', 'identify', 'description');\n\n\t\t\t\tfile.url = fileData.url.replace(Meteor.absoluteUrl(), '/');\n\t\t\t\treturn callback(null, file, this.store.options.name);\n\t\t\t}\n\t\t});\n\n\t\tthis.handler.onProgress = (file, progress) => {\n\t\t\tthis.onProgress(progress);\n\t\t};\n\n\t\treturn this.handler.start();\n\t}\n\n\tonProgress() {}\n\n\tstop() {\n\t\treturn this.handler.stop();\n\t}\n};\n","/* globals UploadFS */\n\nimport fs from 'fs';\nimport stream from 'stream';\nimport mime from 'mime-type/with-db';\nimport Future from 'fibers/future';\n\nObject.assign(FileUpload, {\n\thandlers: {},\n\n\tconfigureUploadsStore(store, name, options) {\n\t\tconst type = name.split(':').pop();\n\t\tconst stores = UploadFS.getStores();\n\t\tdelete stores[name];\n\n\t\treturn new UploadFS.store[store](Object.assign({\n\t\t\tname\n\t\t}, options, FileUpload[`default${ type }`]()));\n\t},\n\n\tdefaultUploads() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Uploads.model,\n\t\t\tfilter: new UploadFS.Filter({\n\t\t\t\tonCheck: FileUpload.validateFileUpload\n\t\t\t}),\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/uploads/${ file.rid }/${ file.userId }/${ file._id }`;\n\t\t\t},\n\t\t\t// transformWrite: FileUpload.uploadsTransformWrite\n\t\t\tonValidate: FileUpload.uploadsOnValidate\n\t\t};\n\t},\n\n\tdefaultAvatars() {\n\t\treturn {\n\t\t\tcollection: RocketChat.models.Avatars.model,\n\t\t\t// filter: new UploadFS.Filter({\n\t\t\t// \tonCheck: FileUpload.validateFileUpload\n\t\t\t// }),\n\t\t\t// transformWrite: FileUpload.avatarTransformWrite,\n\t\t\tgetPath(file) {\n\t\t\t\treturn `${ RocketChat.settings.get('uniqueID') }/avatars/${ file.userId }`;\n\t\t\t},\n\t\t\tonValidate: FileUpload.avatarsOnValidate,\n\t\t\tonFinishUpload: FileUpload.avatarsOnFinishUpload\n\t\t};\n\t},\n\n\tavatarTransformWrite(readStream, writeStream/*, fileId, file*/) {\n\t\tif (RocketChatFile.enabled === false || RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn readStream.pipe(writeStream);\n\t\t}\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst width = height;\n\t\treturn (file => RocketChat.Info.GraphicsMagick.enabled ? file: file.alpha('remove'))(RocketChatFile.gm(readStream).background('#FFFFFF')).resize(width, `${ height }^`).gravity('Center').crop(width, height).extent(width, height).stream('jpeg').pipe(writeStream);\n\t},\n\n\tavatarsOnValidate(file) {\n\t\tif (RocketChatFile.enabled === false || RocketChat.settings.get('Accounts_AvatarResize') !== true) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tempFilePath = UploadFS.getTempFilePath(file._id);\n\n\t\tconst height = RocketChat.settings.get('Accounts_AvatarSize');\n\t\tconst width = height;\n\t\tconst future = new Future();\n\n\t\t(file => RocketChat.Info.GraphicsMagick.enabled ? file: file.alpha('remove'))(RocketChatFile.gm(tempFilePath).background('#FFFFFF')).resize(width, `${ height }^`).gravity('Center').crop(width, height).extent(width, height).setFormat('jpeg').write(tempFilePath, Meteor.bindEnvironment(err => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t}\n\t\t\tconst size = fs.lstatSync(tempFilePath).size;\n\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\tfuture.return();\n\t\t}));\n\t\treturn future.wait();\n\t},\n\n\tuploadsTransformWrite(readStream, writeStream, fileId, file) {\n\t\tif (RocketChatFile.enabled === false || !/^image\\/.+/.test(file.type)) {\n\t\t\treturn readStream.pipe(writeStream);\n\t\t}\n\n\t\tlet stream = undefined;\n\n\t\tconst identify = function(err, data) {\n\t\t\tif (err) {\n\t\t\t\treturn stream.pipe(writeStream);\n\t\t\t}\n\n\t\t\tfile.identify = {\n\t\t\t\tformat: data.format,\n\t\t\t\tsize: data.size\n\t\t\t};\n\n\t\t\tif (data.Orientation && !['', 'Unknown', 'Undefined'].includes(data.Orientation)) {\n\t\t\t\tRocketChatFile.gm(stream).autoOrient().stream().pipe(writeStream);\n\t\t\t} else {\n\t\t\t\tstream.pipe(writeStream);\n\t\t\t}\n\t\t};\n\n\t\tstream = RocketChatFile.gm(readStream).identify(identify).stream();\n\t},\n\n\tuploadsOnValidate(file) {\n\t\tif (RocketChatFile.enabled === false || !/^image\\/((x-windows-)?bmp|p?jpeg|png)$/.test(file.type)) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst tmpFile = UploadFS.getTempFilePath(file._id);\n\n\t\tconst fut = new Future();\n\n\t\tconst identify = Meteor.bindEnvironment((err, data) => {\n\t\t\tif (err != null) {\n\t\t\t\tconsole.error(err);\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tfile.identify = {\n\t\t\t\tformat: data.format,\n\t\t\t\tsize: data.size\n\t\t\t};\n\n\t\t\tif ([null, undefined, '', 'Unknown', 'Undefined'].includes(data.Orientation)) {\n\t\t\t\treturn fut.return();\n\t\t\t}\n\n\t\t\tRocketChatFile.gm(tmpFile).autoOrient().write(tmpFile, Meteor.bindEnvironment((err) => {\n\t\t\t\tif (err != null) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tconst size = fs.lstatSync(tmpFile).size;\n\t\t\t\tthis.getCollection().direct.update({_id: file._id}, {$set: {size}});\n\t\t\t\tfut.return();\n\t\t\t}));\n\t\t});\n\n\t\tRocketChatFile.gm(tmpFile).identify(identify);\n\n\t\treturn fut.wait();\n\t},\n\n\tavatarsOnFinishUpload(file) {\n\t\t// update file record to match user's username\n\t\tconst user = RocketChat.models.Users.findOneById(file.userId);\n\t\tconst oldAvatar = RocketChat.models.Avatars.findOneByName(user.username);\n\t\tif (oldAvatar) {\n\t\t\tRocketChat.models.Avatars.deleteFile(oldAvatar._id);\n\t\t}\n\t\tRocketChat.models.Avatars.updateFileNameById(file._id, user.username);\n\t\t// console.log('upload finished ->', file);\n\t},\n\n\taddExtensionTo(file) {\n\t\tif (mime.lookup(file.name) === file.type) {\n\t\t\treturn file;\n\t\t}\n\n\t\tconst ext = mime.extension(file.type);\n\t\tif (ext && false === new RegExp(`\\.${ ext }$`, 'i').test(file.name)) {\n\t\t\tfile.name = `${ file.name }.${ ext }`;\n\t\t}\n\n\t\treturn file;\n\t},\n\n\tgetStore(modelName) {\n\t\tconst storageType = RocketChat.settings.get('FileUpload_Storage_Type');\n\t\tconst handlerName = `${ storageType }:${ modelName }`;\n\n\t\treturn this.getStoreByName(handlerName);\n\t},\n\n\tgetStoreByName(handlerName) {\n\t\tif (this.handlers[handlerName] == null) {\n\t\t\tconsole.error(`Upload handler \"${ handlerName }\" does not exists`);\n\t\t}\n\t\treturn this.handlers[handlerName];\n\t},\n\n\tget(file, req, res, next) {\n\t\tconst store = this.getStoreByName(file.store);\n\t\tif (store && store.get) {\n\t\t\treturn store.get(file, req, res, next);\n\t\t}\n\t\tres.writeHead(404);\n\t\tres.end();\n\t}\n});\n\n\nexport class FileUploadClass {\n\tconstructor({ name, model, store, get, insert, getStore }) {\n\t\tthis.name = name;\n\t\tthis.model = model || this.getModelFromName();\n\t\tthis._store = store || UploadFS.getStore(name);\n\t\tthis.get = get;\n\n\t\tif (insert) {\n\t\t\tthis.insert = insert;\n\t\t}\n\n\t\tif (getStore) {\n\t\t\tthis.getStore = getStore;\n\t\t}\n\n\t\tFileUpload.handlers[name] = this;\n\t}\n\n\tgetStore() {\n\t\treturn this._store;\n\t}\n\n\tget store() {\n\t\treturn this.getStore();\n\t}\n\n\tset store(store) {\n\t\tthis._store = store;\n\t}\n\n\tgetModelFromName() {\n\t\treturn RocketChat.models[this.name.split(':')[1]];\n\t}\n\n\tdelete(fileId) {\n\t\tif (this.store && this.store.delete) {\n\t\t\tthis.store.delete(fileId);\n\t\t}\n\n\t\treturn this.model.deleteFile(fileId);\n\t}\n\n\tdeleteById(fileId) {\n\t\tconst file = this.model.findOneById(fileId);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tdeleteByName(fileName) {\n\t\tconst file = this.model.findOneByName(fileName);\n\n\t\tif (!file) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst store = FileUpload.getStoreByName(file.store);\n\n\t\treturn store.delete(file._id);\n\t}\n\n\tinsert(fileData, streamOrBuffer, cb) {\n\t\tconst fileId = this.store.create(fileData);\n\t\tconst token = this.store.createToken(fileId);\n\t\tconst tmpFile = UploadFS.getTempFilePath(fileId);\n\n\t\ttry {\n\t\t\tif (streamOrBuffer instanceof stream) {\n\t\t\t\tstreamOrBuffer.pipe(fs.createWriteStream(tmpFile));\n\t\t\t} else if (streamOrBuffer instanceof Buffer) {\n\t\t\t\tfs.writeFileSync(tmpFile, streamOrBuffer);\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid file type');\n\t\t\t}\n\n\t\t\tconst file = Meteor.call('ufsComplete', fileId, this.name, token);\n\n\t\t\tif (cb) {\n\t\t\t\tcb(null, file);\n\t\t\t}\n\n\t\t\treturn file;\n\t\t} catch (e) {\n\t\t\tif (cb) {\n\t\t\t\tcb(e);\n\t\t\t} else {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t}\n\t}\n}\n","/* globals UploadFS, InstanceStatus */\n\nimport http from 'http';\nimport URL from 'url';\n\nconst logger = new Logger('UploadProxy');\n\nWebApp.connectHandlers.stack.unshift({\n\troute: '',\n\thandle: Meteor.bindEnvironment(function(req, res, next) {\n\t\t// Quick check to see if request should be catch\n\t\tif (req.url.indexOf(UploadFS.config.storesPath) === -1) {\n\t\t\treturn next();\n\t\t}\n\n\t\tlogger.debug('Upload URL:', req.url);\n\n\t\tif (req.method !== 'POST') {\n\t\t\treturn next();\n\t\t}\n\n\t\t// Remove store path\n\t\tconst parsedUrl = URL.parse(req.url);\n\t\tconst path = parsedUrl.pathname.substr(UploadFS.config.storesPath.length + 1);\n\n\t\t// Get store\n\t\tconst regExp = new RegExp('^\\/([^\\/\\?]+)\\/([^\\/\\?]+)$');\n\t\tconst match = regExp.exec(path);\n\n\t\t// Request is not valid\n\t\tif (match === null) {\n\t\t\tres.writeHead(400);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get store\n\t\tconst store = UploadFS.getStore(match[1]);\n\t\tif (!store) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\t// Get file\n\t\tconst fileId = match[2];\n\t\tconst file = store.getCollection().findOne({_id: fileId});\n\t\tif (file === undefined) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (file.instanceId === InstanceStatus.id()) {\n\t\t\tlogger.debug('Correct instance');\n\t\t\treturn next();\n\t\t}\n\n\t\t// Proxy to other instance\n\t\tconst instance = InstanceStatus.getCollection().findOne({_id: file.instanceId});\n\n\t\tif (instance == null) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\n\t\tif (instance.extraInformation.host === process.env.INSTANCE_IP && RocketChat.isDocker() === false) {\n\t\t\tinstance.extraInformation.host = 'localhost';\n\t\t}\n\n\t\tlogger.debug('Wrong instance, proxing to:', `${ instance.extraInformation.host }:${ instance.extraInformation.port }`);\n\n\t\tconst options = {\n\t\t\thostname: instance.extraInformation.host,\n\t\t\tport: instance.extraInformation.port,\n\t\t\tpath: req.originalUrl,\n\t\t\tmethod: 'POST'\n\t\t};\n\n\t\tconst proxy = http.request(options, function(proxy_res) {\n\t\t\tproxy_res.pipe(res, {\n\t\t\t\tend: true\n\t\t\t});\n\t\t});\n\n\t\treq.pipe(proxy, {\n\t\t\tend: true\n\t\t});\n\t})\n});\n","/* globals FileUpload, WebApp */\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nWebApp.connectHandlers.use(`${ __meteor_runtime_config__.ROOT_URL_PATH_PREFIX }/file-upload/`,\tfunction(req, res, next) {\n\n\tconst match = /^\\/([^\\/]+)\\/(.*)/.exec(req.url);\n\n\tif (match[1]) {\n\t\tconst file = RocketChat.models.Uploads.findOneById(match[1]);\n\n\t\tif (file) {\n\t\t\tif (!Meteor.settings.public.sandstorm && protectedFiles) {\n\t\t\t\tlet rawCookies;\n\t\t\t\tlet token;\n\t\t\t\tlet uid;\n\t\t\t\tconst cookie = new Cookies();\n\n\t\t\t\tif (req.headers && req.headers.cookie != null) {\n\t\t\t\t\trawCookies = req.headers.cookie;\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\tuid = cookie.get('rc_uid', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (rawCookies != null) {\n\t\t\t\t\ttoken = cookie.get('rc_token', rawCookies);\n\t\t\t\t}\n\n\t\t\t\tif (uid == null) {\n\t\t\t\t\tuid = req.query.rc_uid;\n\t\t\t\t\ttoken = req.query.rc_token;\n\t\t\t\t}\n\n\t\t\t\tif (!(uid && token && RocketChat.models.Users.findOneByIdAndLoginToken(uid, token))) {\n\t\t\t\t\tres.writeHead(403);\n\t\t\t\t\tres.end();\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tres.setHeader('Content-Security-Policy', 'default-src \\'none\\'');\n\n\t\t\treturn FileUpload.get(file, req, res, next);\n\t\t}\n\t}\n\n\tres.writeHead(404);\n\tres.end();\n\treturn;\n});\n","/* globals UploadFS */\n\nimport './AmazonS3.js';\nimport './FileSystem.js';\nimport './GoogleStorage.js';\nimport './GridFS.js';\nimport './Slingshot_DEPRECATED.js';\n\nconst configStore = _.debounce(() => {\n\tconst store = RocketChat.settings.get('FileUpload_Storage_Type');\n\n\tif (store) {\n\t\tconsole.log('Setting default file store to', store);\n\t\tUploadFS.getStores().Avatars = UploadFS.getStore(`${ store }:Avatars`);\n\t\tUploadFS.getStores().Uploads = UploadFS.getStore(`${ store }:Uploads`);\n\t}\n}, 1000);\n\nRocketChat.settings.get(/^FileUpload_/, configStore);\n","/* globals FileUpload */\n\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/AmazonS3/server.js';\n\nconst get = function(file, req, res) {\n\tconst fileUrl = this.store.getRedirectURL(file);\n\n\tif (fileUrl) {\n\t\tres.setHeader('Location', fileUrl);\n\t\tres.writeHead(302);\n\t}\n\tres.end();\n};\n\nconst AmazonS3Uploads = new FileUploadClass({\n\tname: 'AmazonS3:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst AmazonS3Avatars = new FileUploadClass({\n\tname: 'AmazonS3:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst Bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst Acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst AWSAccessKeyId = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst AWSSecretAccessKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\tconst Region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst SignatureVersion = RocketChat.settings.get('FileUpload_S3_SignatureVersion');\n\tconst ForcePathStyle = RocketChat.settings.get('FileUpload_S3_ForcePathStyle');\n\t// const CDN = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst BucketURL = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tif (!Bucket || !AWSAccessKeyId || !AWSSecretAccessKey) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\taccessKeyId: AWSAccessKeyId,\n\t\t\tsecretAccessKey: AWSSecretAccessKey,\n\t\t\tsignatureVersion: SignatureVersion,\n\t\t\ts3ForcePathStyle: ForcePathStyle,\n\t\t\tparams: {\n\t\t\t\tBucket,\n\t\t\t\tACL: Acl\n\t\t\t},\n\t\t\tregion: Region\n\t\t},\n\t\tURLExpiryTimeSpan\n\t};\n\n\tif (BucketURL) {\n\t\tconfig.connection.endpoint = BucketURL;\n\t}\n\n\tAmazonS3Uploads.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Uploads.name, config);\n\tAmazonS3Avatars.store = FileUpload.configureUploadsStore('AmazonS3', AmazonS3Avatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_S3_/, configure);\n","/* globals FileUpload, UploadFS */\n\nimport fs from 'fs';\nimport { FileUploadClass } from '../lib/FileUpload';\n\nconst FileSystemUploads = new FileUploadClass({\n\tname: 'FileSystem:Uploads',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`);\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\nconst FileSystemAvatars = new FileUploadClass({\n\tname: 'FileSystem:Avatars',\n\t// store setted bellow\n\n\tget(file, req, res) {\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader) {\n\t\t\tif (reqModifiedHeader === (file.uploadedAt && file.uploadedAt.toUTCString())) {\n\t\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\t\tres.writeHead(304);\n\t\t\t\tres.end();\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\tconst filePath = this.store.getFilePath(file._id, file);\n\n\t\ttry {\n\t\t\tconst stat = Meteor.wrapAsync(fs.stat)(filePath);\n\n\t\t\tif (stat && stat.isFile()) {\n\t\t\t\tfile = FileUpload.addExtensionTo(file);\n\t\t\t\tres.setHeader('Content-Disposition', 'inline');\n\t\t\t\tres.setHeader('Last-Modified', file.uploadedAt.toUTCString());\n\t\t\t\tres.setHeader('Content-Type', file.type);\n\t\t\t\tres.setHeader('Content-Length', file.size);\n\n\t\t\t\tthis.store.getReadStream(file._id, file).pipe(res);\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tres.writeHead(404);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t}\n});\n\n\nconst createFileSystemStore = _.debounce(function() {\n\tconst options = {\n\t\tpath: RocketChat.settings.get('FileUpload_FileSystemPath') //'/tmp/uploads/photos',\n\t};\n\n\tFileSystemUploads.store = FileUpload.configureUploadsStore('Local', FileSystemUploads.name, options);\n\tFileSystemAvatars.store = FileUpload.configureUploadsStore('Local', FileSystemAvatars.name, options);\n\n\t// DEPRECATED backwards compatibililty (remove)\n\tUploadFS.getStores()['fileSystem'] = UploadFS.getStores()[FileSystemUploads.name];\n}, 500);\n\nRocketChat.settings.get('FileUpload_FileSystemPath', createFileSystemStore);\n","/* globals FileUpload */\n\nimport { FileUploadClass } from '../lib/FileUpload';\nimport '../../ufs/GoogleStorage/server.js';\n\n\nconst get = function(file, req, res) {\n\tthis.store.getRedirectURL(file, (err, fileUrl) => {\n\t\tif (err) {\n\t\t\tconsole.error(err);\n\t\t}\n\n\t\tif (fileUrl) {\n\t\t\tres.setHeader('Location', fileUrl);\n\t\t\tres.writeHead(302);\n\t\t}\n\t\tres.end();\n\t});\n};\n\nconst GoogleCloudStorageUploads = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Uploads',\n\tget\n\t// store setted bellow\n});\n\nconst GoogleCloudStorageAvatars = new FileUploadClass({\n\tname: 'GoogleCloudStorage:Avatars',\n\tget\n\t// store setted bellow\n});\n\nconst configure = _.debounce(function() {\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\tconst URLExpiryTimeSpan = RocketChat.settings.get('FileUpload_S3_URLExpiryTimeSpan');\n\n\tif (!bucket || !accessId || !secret) {\n\t\treturn;\n\t}\n\n\tconst config = {\n\t\tconnection: {\n\t\t\tcredentials: {\n\t\t\t\tclient_email: accessId,\n\t\t\t\tprivate_key: secret\n\t\t\t}\n\t\t},\n\t\tbucket,\n\t\tURLExpiryTimeSpan\n\t};\n\n\tGoogleCloudStorageUploads.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageUploads.name, config);\n\tGoogleCloudStorageAvatars.store = FileUpload.configureUploadsStore('GoogleStorage', GoogleCloudStorageAvatars.name, config);\n}, 500);\n\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, configure);\n","/* globals FileUpload, UploadFS */\nimport stream from 'stream';\nimport zlib from 'zlib';\nimport util from 'util';\n\nimport { FileUploadClass } from '../lib/FileUpload';\nimport { Cookies } from 'meteor/ostrio:cookies';\n\nconst cookie = new Cookies();\n\nconst logger = new Logger('FileUpload');\n\nfunction ExtractRange(options) {\n\tif (!(this instanceof ExtractRange)) {\n\t\treturn new ExtractRange(options);\n\t}\n\n\tthis.start = options.start;\n\tthis.stop = options.stop;\n\tthis.bytes_read = 0;\n\n\tstream.Transform.call(this, options);\n}\nutil.inherits(ExtractRange, stream.Transform);\n\n\nExtractRange.prototype._transform = function(chunk, enc, cb) {\n\tif (this.bytes_read > this.stop) {\n\t\t// done reading\n\t\tthis.end();\n\t} else if (this.bytes_read + chunk.length < this.start) {\n\t\t// this chunk is still before the start byte\n\t} else {\n\t\tlet start;\n\t\tlet stop;\n\n\t\tif (this.start <= this.bytes_read) {\n\t\t\tstart = 0;\n\t\t} else {\n\t\t\tstart = this.start - this.bytes_read;\n\t\t}\n\t\tif ((this.stop - this.bytes_read + 1) < chunk.length) {\n\t\t\tstop = this.stop - this.bytes_read + 1;\n\t\t} else {\n\t\t\tstop = chunk.length;\n\t\t}\n\t\tconst newchunk = chunk.slice(start, stop);\n\t\tthis.push(newchunk);\n\t}\n\tthis.bytes_read += chunk.length;\n\tcb();\n};\n\n\nconst getByteRange = function(header) {\n\tif (header) {\n\t\tconst matches = header.match(/(\\d+)-(\\d+)/);\n\t\tif (matches) {\n\t\t\treturn {\n\t\t\t\tstart: parseInt(matches[1], 10),\n\t\t\t\tstop: parseInt(matches[2], 10)\n\t\t\t};\n\t\t}\n\t}\n\treturn null;\n};\n\n\n// code from: https://github.com/jalik/jalik-ufs/blob/master/ufs-server.js#L310\nconst readFromGridFS = function(storeName, fileId, file, headers, req, res) {\n\tconst store = UploadFS.getStore(storeName);\n\tconst rs = store.getReadStream(fileId, file);\n\tconst ws = new stream.PassThrough();\n\n\t[rs, ws].forEach(stream => stream.on('error', function(err) {\n\t\tstore.onReadError.call(store, err, fileId, file);\n\t\tres.end();\n\t}));\n\n\tws.on('close', function() {\n\t\t// Close output stream at the end\n\t\tws.emit('end');\n\t});\n\n\tconst accept = req.headers['accept-encoding'] || '';\n\n\t// Transform stream\n\tstore.transformRead(rs, ws, fileId, file, req, headers);\n\tconst range = getByteRange(req.headers.range);\n\tlet out_of_range = false;\n\tif (range) {\n\t\tout_of_range = (range.start > file.size) || (range.stop <= range.start) || (range.stop > file.size);\n\t}\n\n\t// Compress data using gzip\n\tif (accept.match(/\\bgzip\\b/) && range === null) {\n\t\theaders['Content-Encoding'] = 'gzip';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createGzip()).pipe(res);\n\t} else if (accept.match(/\\bdeflate\\b/) && range === null) {\n\t\t// Compress data using deflate\n\t\theaders['Content-Encoding'] = 'deflate';\n\t\tdelete headers['Content-Length'];\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(zlib.createDeflate()).pipe(res);\n\t} else if (range && out_of_range) {\n\t\t// out of range request, return 416\n\t\tdelete headers['Content-Length'];\n\t\tdelete headers['Content-Type'];\n\t\tdelete headers['Content-Disposition'];\n\t\tdelete headers['Last-Modified'];\n\t\theaders['Content-Range'] = `bytes */${ file.size }`;\n\t\tres.writeHead(416, headers);\n\t\tres.end();\n\t} else if (range) {\n\t\theaders['Content-Range'] = `bytes ${ range.start }-${ range.stop }/${ file.size }`;\n\t\tdelete headers['Content-Length'];\n\t\theaders['Content-Length'] = range.stop - range.start + 1;\n\t\tres.writeHead(206, headers);\n\t\tlogger.debug('File upload extracting range');\n\t\tws.pipe(new ExtractRange({ start: range.start, stop: range.stop })).pipe(res);\n\t} else {\n\t\tres.writeHead(200, headers);\n\t\tws.pipe(res);\n\t}\n};\n\nconst onRead = function(fileId, file, req, res) {\n\tif (RocketChat.settings.get('FileUpload_ProtectFiles')) {\n\t\tlet uid;\n\t\tlet token;\n\n\t\tif (req && req.headers && req.headers.cookie) {\n\t\t\tconst rawCookies = req.headers.cookie;\n\n\t\t\tif (rawCookies) {\n\t\t\t\tuid = cookie.get('rc_uid', rawCookies) ;\n\t\t\t\ttoken = cookie.get('rc_token', rawCookies);\n\t\t\t}\n\t\t}\n\n\t\tif (!uid) {\n\t\t\tuid = req.query.rc_uid;\n\t\t\ttoken = req.query.rc_token;\n\t\t}\n\n\t\tif (!uid || !token || !RocketChat.models.Users.findOneByIdAndLoginToken(uid, token)) {\n\t\t\tres.writeHead(403);\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tres.setHeader('content-disposition', `attachment; filename=\"${ encodeURIComponent(file.name) }\"`);\n\treturn true;\n};\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Uploads', {\n\tcollectionName: 'rocketchat_uploads',\n\tonRead\n});\n\n// DEPRECATED: backwards compatibility (remove)\nUploadFS.getStores()['rocketchat_uploads'] = UploadFS.getStores()['GridFS:Uploads'];\n\nFileUpload.configureUploadsStore('GridFS', 'GridFS:Avatars', {\n\tcollectionName: 'rocketchat_avatars',\n\tonRead\n});\n\n\nnew FileUploadClass({\n\tname: 'GridFS:Uploads',\n\n\tget(file, req, res) {\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst headers = {\n\t\t\t'Content-Disposition': `attachment; filename*=UTF-8''${ encodeURIComponent(file.name) }`,\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t}\n});\n\nnew FileUploadClass({\n\tname: 'GridFS:Avatars',\n\n\tget(file, req, res) {\n\t\tconst reqModifiedHeader = req.headers['if-modified-since'];\n\t\tif (reqModifiedHeader && reqModifiedHeader === (file.uploadedAt && file.uploadedAt.toUTCString())) {\n\t\t\tres.setHeader('Last-Modified', reqModifiedHeader);\n\t\t\tres.writeHead(304);\n\t\t\tres.end();\n\t\t\treturn;\n\t\t}\n\t\tfile = FileUpload.addExtensionTo(file);\n\t\tconst headers = {\n\t\t\t'Cache-Control': 'public, max-age=0',\n\t\t\t'Expires': '-1',\n\t\t\t'Content-Disposition': 'inline',\n\t\t\t'Last-Modified': file.uploadedAt.toUTCString(),\n\t\t\t'Content-Type': file.type,\n\t\t\t'Content-Length': file.size\n\t\t};\n\t\treturn readFromGridFS(file.store, file._id, file, headers, req, res);\n\t}\n});\n","/* globals Slingshot, FileUpload */\n\nconst configureSlingshot = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_S3_Bucket');\n\tconst acl = RocketChat.settings.get('FileUpload_S3_Acl');\n\tconst accessKey = RocketChat.settings.get('FileUpload_S3_AWSAccessKeyId');\n\tconst secretKey = RocketChat.settings.get('FileUpload_S3_AWSSecretAccessKey');\n\tconst cdn = RocketChat.settings.get('FileUpload_S3_CDN');\n\tconst region = RocketChat.settings.get('FileUpload_S3_Region');\n\tconst bucketUrl = RocketChat.settings.get('FileUpload_S3_BucketURL');\n\n\tdelete Slingshot._directives['rocketchat-uploads'];\n\n\tif (type === 'AmazonS3' && !_.isEmpty(bucket) && !_.isEmpty(accessKey) && !_.isEmpty(secretKey)) {\n\t\tif (Slingshot._directives['rocketchat-uploads']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads'];\n\t\t}\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tAmazonS3: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'AmazonS3:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t},\n\t\t\tAWSAccessKeyId: accessKey,\n\t\t\tAWSSecretAccessKey: secretKey\n\t\t};\n\n\t\tif (!_.isEmpty(acl)) {\n\t\t\tconfig.acl = acl;\n\t\t}\n\n\t\tif (!_.isEmpty(cdn)) {\n\t\t\tconfig.cdn = cdn;\n\t\t}\n\n\t\tif (!_.isEmpty(region)) {\n\t\t\tconfig.region = region;\n\t\t}\n\n\t\tif (!_.isEmpty(bucketUrl)) {\n\t\t\tconfig.bucketUrl = bucketUrl;\n\t\t}\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads', Slingshot.S3Storage, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring S3 ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', configureSlingshot);\nRocketChat.settings.get(/^FileUpload_S3_/, configureSlingshot);\n\n\n\nconst createGoogleStorageDirective = _.debounce(() => {\n\tconst type = RocketChat.settings.get('FileUpload_Storage_Type');\n\tconst bucket = RocketChat.settings.get('FileUpload_GoogleStorage_Bucket');\n\tconst accessId = RocketChat.settings.get('FileUpload_GoogleStorage_AccessId');\n\tconst secret = RocketChat.settings.get('FileUpload_GoogleStorage_Secret');\n\n\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\n\tif (type === 'GoogleCloudStorage' && !_.isEmpty(secret) && !_.isEmpty(accessId) && !_.isEmpty(bucket)) {\n\t\tif (Slingshot._directives['rocketchat-uploads-gs']) {\n\t\t\tdelete Slingshot._directives['rocketchat-uploads-gs'];\n\t\t}\n\n\t\tconst config = {\n\t\t\tbucket,\n\t\t\tGoogleAccessId: accessId,\n\t\t\tGoogleSecretKey: secret,\n\t\t\tkey(file, metaContext) {\n\t\t\t\tconst id = Random.id();\n\t\t\t\tconst path = `${ RocketChat.settings.get('uniqueID') }/uploads/${ metaContext.rid }/${ this.userId }/${ id }`;\n\n\t\t\t\tconst upload = {\n\t\t\t\t\t_id: id,\n\t\t\t\t\trid: metaContext.rid,\n\t\t\t\t\tGoogleStorage: {\n\t\t\t\t\t\tpath\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tRocketChat.models.Uploads.insertFileInit(this.userId, 'GoogleCloudStorage:Uploads', file, upload);\n\n\t\t\t\treturn path;\n\t\t\t}\n\t\t};\n\n\t\ttry {\n\t\t\tSlingshot.createDirective('rocketchat-uploads-gs', Slingshot.GoogleCloud, config);\n\t\t} catch (e) {\n\t\t\tconsole.error('Error configuring GoogleCloudStorage ->', e.message);\n\t\t}\n\t}\n}, 500);\n\nRocketChat.settings.get('FileUpload_Storage_Type', createGoogleStorageDirective);\nRocketChat.settings.get(/^FileUpload_GoogleStorage_/, createGoogleStorageDirective);\n","Meteor.methods({\n\t'sendFileMessage'(roomId, store, file, msgData = {}) {\n\t\tif (!Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\n\t\tconst room = Meteor.call('canAccessRoom', roomId, Meteor.userId());\n\n\t\tif (!room) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcheck(msgData, {\n\t\t\tavatar: Match.Optional(String),\n\t\t\temoji: Match.Optional(String),\n\t\t\talias: Match.Optional(String),\n\t\t\tgroupable: Match.Optional(Boolean),\n\t\t\tmsg: Match.Optional(String)\n\t\t});\n\n\t\tRocketChat.models.Uploads.updateFileComplete(file._id, Meteor.userId(), _.omit(file, '_id'));\n\n\t\tconst fileUrl = `/file-upload/${ file._id }/${ file.name }`;\n\n\t\tconst attachment = {\n\t\t\ttitle: file.name,\n\t\t\ttype: 'file',\n\t\t\tdescription: file.description,\n\t\t\ttitle_link: fileUrl,\n\t\t\ttitle_link_download: true\n\t\t};\n\n\t\tif (/^image\\/.+/.test(file.type)) {\n\t\t\tattachment.image_url = fileUrl;\n\t\t\tattachment.image_type = file.type;\n\t\t\tattachment.image_size = file.size;\n\t\t\tif (file.identify && file.identify.size) {\n\t\t\t\tattachment.image_dimensions = file.identify.size;\n\t\t\t}\n\t\t} else if (/^audio\\/.+/.test(file.type)) {\n\t\t\tattachment.audio_url = fileUrl;\n\t\t\tattachment.audio_type = file.type;\n\t\t\tattachment.audio_size = file.size;\n\t\t} else if (/^video\\/.+/.test(file.type)) {\n\t\t\tattachment.video_url = fileUrl;\n\t\t\tattachment.video_type = file.type;\n\t\t\tattachment.video_size = file.size;\n\t\t}\n\n\t\tconst user = Meteor.user();\n\t\tlet msg = Object.assign({\n\t\t\t_id: Random.id(),\n\t\t\trid: roomId,\n\t\t\tts: new Date(),\n\t\t\tmsg: '',\n\t\t\tfile: {\n\t\t\t\t_id: file._id,\n\t\t\t\tname: file.name,\n\t\t\t\ttype: file.type\n\t\t\t},\n\t\t\tgroupable: false,\n\t\t\tattachments: [attachment]\n\t\t}, msgData);\n\n\t\tmsg = Meteor.call('sendMessage', msg);\n\n\t\tMeteor.defer(() => RocketChat.callbacks.run('afterFileUpload', { user, room, message: msg }));\n\n\t\treturn msg;\n\t}\n});\n","/* globals UploadFS */\n\nlet protectedFiles;\n\nRocketChat.settings.get('FileUpload_ProtectFiles', function(key, value) {\n\tprotectedFiles = value;\n});\n\nMeteor.methods({\n\tgetS3FileUrl(fileId) {\n\t\tif (protectedFiles && !Meteor.userId()) {\n\t\t\tthrow new Meteor.Error('error-invalid-user', 'Invalid user', { method: 'sendFileMessage' });\n\t\t}\n\t\tconst file = RocketChat.models.Uploads.findOneById(fileId);\n\n\t\treturn UploadFS.getStore('AmazonS3:Uploads').getRedirectURL(file);\n\t}\n});\n","RocketChat.settings.addGroup('FileUpload', function() {\n\tthis.add('FileUpload_Enabled', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MaxFileSize', 2097152, {\n\t\ttype: 'int',\n\t\tpublic: true\n\t});\n\n\tthis.add('FileUpload_MediaTypeWhiteList', 'image/*,audio/*,video/*,application/zip,application/x-rar-compressed,application/pdf,text/plain,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document', {\n\t\ttype: 'string',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_MediaTypeWhiteListDescription'\n\t});\n\n\tthis.add('FileUpload_ProtectFiles', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true,\n\t\ti18nDescription: 'FileUpload_ProtectFilesDescription'\n\t});\n\n\tthis.add('FileUpload_Storage_Type', 'GridFS', {\n\t\ttype: 'select',\n\t\tvalues: [{\n\t\t\tkey: 'GridFS',\n\t\t\ti18nLabel: 'GridFS'\n\t\t}, {\n\t\t\tkey: 'AmazonS3',\n\t\t\ti18nLabel: 'AmazonS3'\n\t\t}, {\n\t\t\tkey: 'GoogleCloudStorage',\n\t\t\ti18nLabel: 'GoogleCloudStorage'\n\t\t}, {\n\t\t\tkey: 'FileSystem',\n\t\t\ti18nLabel: 'FileSystem'\n\t\t}],\n\t\tpublic: true\n\t});\n\n\tthis.section('Amazon S3', function() {\n\t\tthis.add('FileUpload_S3_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Acl', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSAccessKeyId', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_AWSSecretAccessKey', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_CDN', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_Region', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_BucketURL', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'Override_URL_to_which_files_are_uploaded_This_url_also_used_for_downloads_unless_a_CDN_is_given.'\n\t\t});\n\t\tthis.add('FileUpload_S3_SignatureVersion', 'v4', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_ForcePathStyle', false, {\n\t\t\ttype: 'boolean',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_S3_URLExpiryTimeSpan', 120, {\n\t\t\ttype: 'int',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'AmazonS3'\n\t\t\t},\n\t\t\ti18nDescription: 'FileUpload_S3_URLExpiryTimeSpan_Description'\n\t\t});\n\t});\n\n\tthis.section('Google Cloud Storage', function() {\n\t\tthis.add('FileUpload_GoogleStorage_Bucket', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_AccessId', '', {\n\t\t\ttype: 'string',\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t\tthis.add('FileUpload_GoogleStorage_Secret', '', {\n\t\t\ttype: 'string',\n\t\t\tmultiline: true,\n\t\t\tprivate: true,\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'GoogleCloudStorage'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.section('File System', function() {\n\t\tthis.add('FileUpload_FileSystemPath', '', {\n\t\t\ttype: 'string',\n\t\t\tenableQuery: {\n\t\t\t\t_id: 'FileUpload_Storage_Type',\n\t\t\t\tvalue: 'FileSystem'\n\t\t\t}\n\t\t});\n\t});\n\n\tthis.add('FileUpload_Enabled_Direct', true, {\n\t\ttype: 'boolean',\n\t\tpublic: true\n\t});\n});\n","import {_} from 'meteor/underscore';\nimport {UploadFS} from 'meteor/jalik:ufs';\nimport S3 from 'aws-sdk/clients/s3';\nimport stream from 'stream';\n\n/**\n * AmazonS3 store\n * @param options\n * @constructor\n */\nexport class AmazonS3Store extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\t// Default options\n\t\t// options.secretAccessKey,\n\t\t// options.accessKeyId,\n\t\t// options.region,\n\t\t// options.sslEnabled // optional\n\n\t\toptions = _.extend({\n\t\t\thttpOptions: {\n\t\t\t\ttimeout: 6000,\n\t\t\t\tagent: false\n\t\t\t}\n\t\t}, options);\n\n\t\tsuper(options);\n\n\t\tconst classOptions = options;\n\n\t\tconst s3 = new S3(options.connection);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.AmazonS3) {\n\t\t\t\treturn file.AmazonS3.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.s3) {\n\t\t\t\treturn file.s3.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tExpires: classOptions.URLExpiryTimeSpan\n\t\t\t};\n\n\t\t\treturn s3.getSignedUrl('getObject', params);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.AmazonS3 = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\ts3.deleteObject(params, (err, data) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst params = {\n\t\t\t\tKey: this.getPath(file)\n\t\t\t};\n\n\t\t\tif (options.start && options.end) {\n\t\t\t\tparams.Range = `${ options.start } - ${ options.end }`;\n\t\t\t}\n\n\t\t\treturn s3.getObject(params).createReadStream();\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\tconst writeStream = new stream.PassThrough();\n\t\t\twriteStream.length = file.size;\n\n\t\t\twriteStream.on('newListener', (event, listener) => {\n\t\t\t\tif (event === 'finish') {\n\t\t\t\t\tprocess.nextTick(() => {\n\t\t\t\t\t\twriteStream.removeListener(event, listener);\n\t\t\t\t\t\twriteStream.on('real_finish', listener);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\n\t\t\ts3.putObject({\n\t\t\t\tKey: this.getPath(file),\n\t\t\t\tBody: writeStream,\n\t\t\t\tContentType: file.type,\n\t\t\t\tContentDisposition: `inline; filename=${ file.name }`\n\n\t\t\t}, (error) => {\n\t\t\t\tif (error) {\n\t\t\t\t\tconsole.error(error);\n\t\t\t\t}\n\n\t\t\t\twriteStream.emit('real_finish');\n\t\t\t});\n\n\t\t\treturn writeStream;\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.AmazonS3 = AmazonS3Store;\n","import {UploadFS} from 'meteor/jalik:ufs';\nimport gcStorage from '@google-cloud/storage';\n\n/**\n * GoogleStorage store\n * @param options\n * @constructor\n */\nexport class GoogleStorageStore extends UploadFS.Store {\n\n\tconstructor(options) {\n\t\tsuper(options);\n\n\t\tconst gcs = gcStorage(options.connection);\n\t\tthis.bucket = gcs.bucket(options.bucket);\n\n\t\toptions.getPath = options.getPath || function(file) {\n\t\t\treturn file._id;\n\t\t};\n\n\t\tthis.getPath = function(file) {\n\t\t\tif (file.GoogleStorage) {\n\t\t\t\treturn file.GoogleStorage.path;\n\t\t\t}\n\t\t\t// Compatibility\n\t\t\t// TODO: Migration\n\t\t\tif (file.googleCloudStorage) {\n\t\t\t\treturn file.googleCloudStorage.path + file._id;\n\t\t\t}\n\t\t};\n\n\t\tthis.getRedirectURL = function(file, callback) {\n\t\t\tconst params = {\n\t\t\t\taction: 'read',\n\t\t\t\tresponseDisposition: 'inline',\n\t\t\t\texpires: Date.now()+this.options.URLExpiryTimeSpan*1000\n\t\t\t};\n\n\t\t\tthis.bucket.file(this.getPath(file)).getSignedUrl(params, callback);\n\t\t};\n\n\t\t/**\n\t\t * Creates the file in the collection\n\t\t * @param file\n\t\t * @param callback\n\t\t * @return {string}\n\t\t */\n\t\tthis.create = function(file, callback) {\n\t\t\tcheck(file, Object);\n\n\t\t\tif (file._id == null) {\n\t\t\t\tfile._id = Random.id();\n\t\t\t}\n\n\t\t\tfile.GoogleStorage = {\n\t\t\t\tpath: this.options.getPath(file)\n\t\t\t};\n\n\t\t\tfile.store = this.options.name; // assign store to file\n\t\t\treturn this.getCollection().insert(file, callback);\n\t\t};\n\n\t\t/**\n\t\t * Removes the file\n\t\t * @param fileId\n\t\t * @param callback\n\t\t */\n\t\tthis.delete = function(fileId, callback) {\n\t\t\tconst file = this.getCollection().findOne({_id: fileId});\n\t\t\tthis.bucket.file(this.getPath(file)).delete(function(err, data) {\n\t\t\t\tif (err) {\n\t\t\t\t\tconsole.error(err);\n\t\t\t\t}\n\n\t\t\t\tcallback && callback(err, data);\n\t\t\t});\n\t\t};\n\n\t\t/**\n\t\t * Returns the file read stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getReadStream = function(fileId, file, options = {}) {\n\t\t\tconst config = {};\n\n\t\t\tif (options.start != null) {\n\t\t\t\tconfig.start = options.start;\n\t\t\t}\n\n\t\t\tif (options.end != null) {\n\t\t\t\tconfig.end = options.end;\n\t\t\t}\n\n\t\t\treturn this.bucket.file(this.getPath(file)).createReadStream(config);\n\t\t};\n\n\t\t/**\n\t\t * Returns the file write stream\n\t\t * @param fileId\n\t\t * @param file\n\t\t * @param options\n\t\t * @return {*}\n\t\t */\n\t\tthis.getWriteStream = function(fileId, file/*, options*/) {\n\t\t\treturn this.bucket.file(this.getPath(file)).createWriteStream({\n\t\t\t\tgzip: false,\n\t\t\t\tmetadata: {\n\t\t\t\t\tcontentType: file.type,\n\t\t\t\t\tcontentDisposition: `inline; filename=${ file.name }`\n\t\t\t\t\t// metadata: {\n\t\t\t\t\t// \tcustom: 'metadata'\n\t\t\t\t\t// }\n\t\t\t\t}\n\t\t\t});\n\t\t};\n\t}\n}\n\n// Add store to UFS namespace\nUploadFS.store.GoogleStorage = GoogleStorageStore;\n"]}