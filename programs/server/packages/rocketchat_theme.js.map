{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:theme/server/server.js","meteor://ðŸ’»app/packages/rocketchat:theme/server/variables.js"],"names":["less","module","watch","require","v","Autoprefixer","crypto","logger","Logger","methods","stop_rendering","type","WebApp","rawConnectHandlers","use","req","res","next","path","url","split","prefix","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","css","RocketChat","theme","getCss","hash","createHash","update","digest","setHeader","write","end","calculateClientHash","WebAppHashing","manifest","includeFilter","runtimeConfigOverride","trim","themeManifestItem","_","find","item","push","cacheable","where","size","length","call","variables","packageCallbacks","files","customCSS","settings","add","addGroup","onload","Meteor","bindEnvironment","key","value","initialLoad","startup","process","emit","refresh","compileDelayed","debounce","compile","bind","onAfterInitialLoad","get","name","replace","content","getVariablesAsLess","map","Assets","getText","join","options","compress","plugins","start","Date","now","render","err","data","console","log","updateById","setTimeout","addColor","section","properties","config","group","editor","addVariable","persist","allowedTypes","property","addPublicColor","addPublicFont","getVariablesAsObject","Object","keys","reduce","obj","variable","addPackageAsset","cb","reg","colors","match","color","forEach","test","majorColors","minorColors","code","multiline"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,aAAJ;AAASC,OAAOC,KAAP,CAAaC,QAAQ,MAAR,CAAb,EAA6B;AAAA,sBAASC,CAAT,EAAW;AAACJ,SAAKI,CAAL;AAAO;AAAnB,CAA7B,EAAkD,CAAlD;AAAqD,IAAIC,qBAAJ;AAAiBJ,OAAOC,KAAP,CAAaC,QAAQ,wBAAR,CAAb,EAA+C;AAAA,sBAASC,CAAT,EAAW;AAACC,iBAAaD,CAAb;AAAe;AAA3B,CAA/C,EAA4E,CAA5E;AAA+E,IAAIE,eAAJ;AAAWL,OAAOC,KAAP,CAAaC,QAAQ,QAAR,CAAb,EAA+B;AAAA,sBAASC,CAAT,EAAW;AAACE,WAAOF,CAAP;AAAS;AAArB,CAA/B,EAAsD,CAAtD;AAMzK,IAAMG,SAAS,IAAIC,MAAJ,CAAW,kBAAX,EAA+B;AAC7CC,UAAS;AACRC,kBAAgB;AACfC,SAAM;AADS;AADR;AADoC,CAA/B,CAAf;AAQAC,OAAOC,kBAAP,CAA0BC,GAA1B,CAA8B,UAASC,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AACtD,KAAMC,OAAOH,IAAII,GAAJ,CAAQC,KAAR,CAAc,GAAd,EAAmB,CAAnB,CAAb;AACA,KAAMC,SAASC,0BAA0BC,oBAA1B,IAAkD,EAAjE;;AACA,KAAIL,SAAaG,MAAb,6BAA8CH,SAAaG,MAAb,eAAlD,EAAoF;AACnF,MAAMG,MAAMC,WAAWC,KAAX,CAAiBC,MAAjB,EAAZ;AACA,MAAMC,OAAOtB,OAAOuB,UAAP,CAAkB,MAAlB,EAA0BC,MAA1B,CAAiCN,GAAjC,EAAsCO,MAAtC,CAA6C,KAA7C,CAAb;AACAf,MAAIgB,SAAJ,CAAc,cAAd,EAA8B,yBAA9B;AACAhB,MAAIgB,SAAJ,CAAc,MAAd,SAA2BJ,IAA3B;AACAZ,MAAIiB,KAAJ,CAAUT,GAAV;AACA,SAAOR,IAAIkB,GAAJ,EAAP;AACA,EAPD,MAOO;AACN,SAAOjB,MAAP;AACA;AACD,CAbD;AAeA,IAAMkB,sBAAsBC,cAAcD,mBAA1C;;AAEAC,cAAcD,mBAAd,GAAoC,UAASE,QAAT,EAAmBC,aAAnB,EAAkCC,qBAAlC,EAAyD;AAC5F,KAAMf,MAAMC,WAAWC,KAAX,CAAiBC,MAAjB,EAAZ;;AACA,KAAIH,IAAIgB,IAAJ,OAAe,EAAnB,EAAuB;AACtB,MAAMZ,OAAOtB,OAAOuB,UAAP,CAAkB,MAAlB,EAA0BC,MAA1B,CAAiCN,GAAjC,EAAsCO,MAAtC,CAA6C,KAA7C,CAAb;;AACA,MAAIU,oBAAoBC,EAAEC,IAAF,CAAON,QAAP,EAAiB,UAASO,IAAT,EAAe;AACvD,UAAOA,KAAK1B,IAAL,KAAc,eAArB;AACA,GAFuB,CAAxB;;AAGA,MAAIuB,qBAAqB,IAAzB,EAA+B;AAC9BA,uBAAoB,EAApB;AACAJ,YAASQ,IAAT,CAAcJ,iBAAd;AACA;;AACDA,oBAAkBvB,IAAlB,GAAyB,eAAzB;AACAuB,oBAAkB9B,IAAlB,GAAyB,KAAzB;AACA8B,oBAAkBK,SAAlB,GAA8B,IAA9B;AACAL,oBAAkBM,KAAlB,GAA0B,QAA1B;AACAN,oBAAkBtB,GAAlB,mBAAuCS,IAAvC;AACAa,oBAAkBO,IAAlB,GAAyBxB,IAAIyB,MAA7B;AACAR,oBAAkBb,IAAlB,GAAyBA,IAAzB;AACA;;AACD,QAAOO,oBAAoBe,IAApB,CAAyB,IAAzB,EAA+Bb,QAA/B,EAAyCC,aAAzC,EAAwDC,qBAAxD,CAAP;AACA,CApBD;;AAsBAd,WAAWC,KAAX,GAAmB;AAClB,mBAAc;AAAA;;AAAA;AACb,OAAKyB,SAAL,GAAiB,EAAjB;AACA,OAAKC,gBAAL,GAAwB,EAAxB;AACA,OAAKC,KAAL,GAAa,CAAC,oBAAD,CAAb;AACA,OAAKC,SAAL,GAAiB,EAAjB;AACA7B,aAAW8B,QAAX,CAAoBC,GAApB,CAAwB,KAAxB,EAA+B,EAA/B;AACA/B,aAAW8B,QAAX,CAAoBE,QAApB,CAA6B,QAA7B;AACAhC,aAAW8B,QAAX,CAAoBG,MAApB,CAA2B,KAA3B,EAAkCC,OAAOC,eAAP,CAAuB,UAACC,GAAD,EAAMC,KAAN,EAAaC,WAAb,EAA6B;AACrF,OAAI,CAACA,WAAL,EAAkB;AACjBJ,WAAOK,OAAP,CAAe,YAAW;AACzBC,aAAQC,IAAR,CAAa,SAAb,EAAwB;AACvBC,eAAS;AADc,MAAxB;AAGA,KAJD;AAKA;AACD,GARiC,CAAlC;AASA,OAAKC,cAAL,GAAsB1B,EAAE2B,QAAF,CAAWV,OAAOC,eAAP,CAAuB,KAAKU,OAAL,CAAaC,IAAb,CAAkB,IAAlB,CAAvB,CAAX,EAA4D,GAA5D,CAAtB;AACAZ,SAAOK,OAAP,CAAe,YAAM;AACpBvC,cAAW8B,QAAX,CAAoBiB,kBAApB,CAAuC,YAAM;AAC5C/C,eAAW8B,QAAX,CAAoBkB,GAApB,CAAwB,UAAxB,EAAoCd,OAAOC,eAAP,CAAuB,UAACC,GAAD,EAAMC,KAAN,EAAgB;AAC1E,SAAID,QAAQ,kBAAR,IAA8BC,SAAS,IAA3C,EAAiD;AAChD,YAAKR,SAAL,GAAiBQ,KAAjB;AACA,MAFD,MAEO;AACN,UAAMY,OAAOb,IAAIc,OAAJ,CAAY,gBAAZ,EAA8B,EAA9B,CAAb;;AACA,UAAI,MAAKxB,SAAL,CAAeuB,IAAf,KAAwB,IAA5B,EAAkC;AACjC,aAAKvB,SAAL,CAAeuB,IAAf,EAAqBZ,KAArB,GAA6BA,KAA7B;AACA;AACD;;AAED,WAAKM,cAAL;AACA,KAXmC,CAApC;AAYA,IAbD;AAcA,GAfD;AAgBA;;AAlCiB,kBAoClBE,OApCkB;AAAA,qBAoCR;AAAA;;AACT,OAAIM,UAAU,CAAC,KAAKC,kBAAL,EAAD,CAAd;;AAEA,wBAAQhC,IAAR,kDAAgB,KAAKQ,KAAL,CAAWyB,GAAX,CAAe,UAACJ,IAAD;AAAA,WAAUK,OAAOC,OAAP,CAAeN,IAAf,CAAV;AAAA,IAAf,CAAhB;;AAEA,yBAAQ7B,IAAR,mDAAgB,KAAKO,gBAAL,CAAsB0B,GAAtB,CAA0B;AAAA,WAAQJ,MAAR;AAAA,IAA1B,CAAhB;;AAEAE,WAAQ/B,IAAR,CAAa,KAAKS,SAAlB;AACAsB,aAAUA,QAAQK,IAAR,CAAa,IAAb,CAAV;AACA,OAAMC,UAAU;AACfC,cAAU,IADK;AAEfC,aAAS,CAAC,IAAI/E,YAAJ,EAAD;AAFM,IAAhB;AAIA,OAAMgF,QAAQC,KAAKC,GAAL,EAAd;AACA,UAAOvF,KAAKwF,MAAL,CAAYZ,OAAZ,EAAqBM,OAArB,EAA8B,UAASO,GAAT,EAAcC,IAAd,EAAoB;AACxDnF,WAAOG,cAAP,CAAsB4E,KAAKC,GAAL,KAAaF,KAAnC;;AACA,QAAII,OAAO,IAAX,EAAiB;AAChB,YAAOE,QAAQC,GAAR,CAAYH,GAAZ,CAAP;AACA;;AACDhE,eAAW8B,QAAX,CAAoBsC,UAApB,CAA+B,KAA/B,EAAsCH,KAAKlE,GAA3C;AACA,WAAOmC,OAAOK,OAAP,CAAe,YAAW;AAChC,YAAOL,OAAOmC,UAAP,CAAkB,YAAW;AACnC,aAAO7B,QAAQC,IAAR,CAAa,SAAb,EAAwB;AAC9BC,gBAAS;AADqB,OAAxB,CAAP;AAGA,MAJM,EAIJ,GAJI,CAAP;AAKA,KANM,CAAP;AAOA,IAbM,CAAP;AAcA;;AAhEiB;AAAA;;AAAA,kBAkElB4B,QAlEkB;AAAA,oBAkETrB,IAlES,EAkEHZ,KAlEG,EAkEIkC,OAlEJ,EAkEaC,UAlEb,EAkEyB;AAC1C,OAAMC,SAAS;AACdC,WAAO,QADO;AAEdxF,UAAM,OAFQ;AAGdyF,YAAQ,OAHM;AAId,cAAQ,IAJM;AAKdH,0BALc;AAMdD;AANc,IAAf;AASA,UAAOvE,WAAW8B,QAAX,CAAoBC,GAApB,kBAAwCkB,IAAxC,EAAiDZ,KAAjD,EAAwDoC,MAAxD,CAAP;AACA;;AA7EiB;AAAA;;AAAA,kBA+ElBG,WA/EkB;AAAA,uBA+EN1F,IA/EM,EA+EA+D,IA/EA,EA+EMZ,KA/EN,EA+EakC,OA/Eb,EA+EsE;AAAA,OAAhDM,OAAgD,uEAAtC,IAAsC;AAAA,OAAhCF,MAAgC;AAAA,OAAxBG,YAAwB;AAAA,OAAVC,QAAU;AACvF,QAAKrD,SAAL,CAAeuB,IAAf,IAAuB;AACtB/D,cADsB;AAEtBmD;AAFsB,IAAvB;;AAIA,OAAIwC,OAAJ,EAAa;AACZ,QAAMJ,SAAS;AACdC,YAAO,QADO;AAEdxF,eAFc;AAGdyF,aAAQA,UAAUzF,IAHJ;AAIdqF,qBAJc;AAKd,eAAU,IALI;AAMdO,+BANc;AAOdC;AAPc,KAAf;AASA,WAAO/E,WAAW8B,QAAX,CAAoBC,GAApB,YAAkC7C,IAAlC,SAA4C+D,IAA5C,EAAqDZ,KAArD,EAA4DoC,MAA5D,CAAP;AACA;AAED;;AAjGiB;AAAA;;AAAA,kBAmGlBO,cAnGkB;AAAA,0BAmGH/B,IAnGG,EAmGGZ,KAnGH,EAmGUkC,OAnGV,EAmG+C;AAAA,OAA5BI,MAA4B,uEAAnB,OAAmB;AAAA,OAAVI,QAAU;AAChE,UAAO,KAAKH,WAAL,CAAiB,OAAjB,EAA0B3B,IAA1B,EAAgCZ,KAAhC,EAAuCkC,OAAvC,EAAgD,IAAhD,EAAsDI,MAAtD,EAA8D,CAAC,OAAD,EAAU,YAAV,CAA9D,EAAuFI,QAAvF,CAAP;AACA;;AArGiB;AAAA;;AAAA,kBAuGlBE,aAvGkB;AAAA,yBAuGJhC,IAvGI,EAuGEZ,KAvGF,EAuGS;AAC1B,UAAO,KAAKuC,WAAL,CAAiB,MAAjB,EAAyB3B,IAAzB,EAA+BZ,KAA/B,EAAsC,OAAtC,EAA+C,IAA/C,CAAP;AACA;;AAzGiB;AAAA;;AAAA,kBA2GlB6C,oBA3GkB;AAAA,kCA2GK;AAAA;;AACtB,UAAOC,OAAOC,IAAP,CAAY,KAAK1D,SAAjB,EAA4B2D,MAA5B,CAAmC,UAACC,GAAD,EAAMrC,IAAN,EAAe;AACxDqC,QAAIrC,IAAJ,IAAY,OAAKvB,SAAL,CAAeuB,IAAf,EAAqBZ,KAAjC;AACA,WAAOiD,GAAP;AACA,IAHM,EAGJ,EAHI,CAAP;AAIA;;AAhHiB;AAAA;;AAAA,kBAkHlBlC,kBAlHkB;AAAA,gCAkHG;AAAA;;AACpB,UAAO+B,OAAOC,IAAP,CAAY,KAAK1D,SAAjB,EAA4B2B,GAA5B,CAAgC,UAACJ,IAAD,EAAU;AAChD,QAAMsC,WAAW,OAAK7D,SAAL,CAAeuB,IAAf,CAAjB;AACA,iBAAYA,IAAZ,UAAuBsC,SAASlD,KAAhC;AACA,IAHM,EAGJmB,IAHI,CAGC,IAHD,CAAP;AAIA;;AAvHiB;AAAA;;AAAA,kBAyHlBgC,eAzHkB;AAAA,2BAyHFC,EAzHE,EAyHE;AACnB,QAAK9D,gBAAL,CAAsBP,IAAtB,CAA2BqE,EAA3B;AACA,UAAO,KAAK9C,cAAL,EAAP;AACA;;AA5HiB;AAAA;;AAAA,kBA8HlBzC,MA9HkB;AAAA,oBA8HT;AACR,UAAOF,WAAW8B,QAAX,CAAoBkB,GAApB,CAAwB,KAAxB,KAAkC,EAAzC;AACA;;AAhIiB;AAAA;;AAAA;AAAA,MAAnB,8G;;;;;;;;;;;;;;;;;;;;;ACpDA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AAEA,IAAM0C,MAAM,6BAAZ;AAEA,IAAMC,SAAS,2CAAIrC,OAAOC,OAAP,CAAe,sCAAf,EAAuDqC,KAAvD,CAA6DF,GAA7D,CAAJ,GAAuErC,GAAvE,CAA2E,iBAAS;AAAA,oBAC5EwC,MAAMlG,KAAN,CAAY,IAAZ,CAD4E;AAAA;AAAA,KAC3FsD,IAD2F;AAAA,KACrFZ,KADqF;;AAElG,QAAO,CAACY,KAAKC,OAAL,CAAa,IAAb,EAAmB,EAAnB,CAAD,EAAyBb,MAAMa,OAAN,CAAc,GAAd,EAAmB,EAAnB,CAAzB,CAAP;AACA,CAHc,CAAf;AAKAyC,OAAOG,OAAP,CAAe,gBAAmB;AAAA;AAAA,KAAjB1D,GAAiB;AAAA,KAAZyD,KAAY;;AACjC,KAAI,MAAME,IAAN,CAAWF,KAAX,CAAJ,EAAuB;AAAA,qBACJA,MAAMD,KAAN,CAAY,iBAAZ,CADI;AAAA;AAAA,MACbvD,KADa;;AAEtB,SAAOrC,WAAWC,KAAX,CAAiB+E,cAAjB,CAAgC5C,GAAhC,EAAqCC,KAArC,EAA4C,QAA5C,EAAsD,YAAtD,CAAP;AACA;;AACDrC,YAAWC,KAAX,CAAiB+E,cAAjB,CAAgC5C,GAAhC,EAAqCyD,KAArC,EAA4C,QAA5C;AACA,CAND;AAQA,IAAMG,cAAa;AAClB,6BAA4B,SADV;AAElB,6BAA4B,SAFV;AAGlB,uBAAsB,SAHJ;AAIlB,yBAAwB,SAJN;AAIiB;AACnC,+BAA8B,SALZ;AAMlB,yBAAwB,SANN;AAOlB,2BAA0B,SAPR;AAQlB,oBAAmB,SARD;AASlB,kBAAiB,SATC;AAUlB,kBAAiB,SAVC;AAWlB,gBAAe,SAXG;AAYlB,oBAAmB,SAZD;AAalB,oBAAmB;AAbD,CAAnB,C,CAgBA;;AACA,IAAMC,cAAa;AAClB,8BAA6B,kBADX;AAElB,wBAAuB,uBAFL;AAGlB,oBAAmB,uBAHD;AAIlB,oBAAmB,uBAJD;AAKlB,2BAA0B,qBALR;AAMlB,kBAAiB,gBANC;AAOlB,gBAAe,gBAPG;AAQlB,gBAAe,cARG;AASlB,mBAAkB;AATA,CAAnB,C,CAYA;;AACAd,OAAOC,IAAP,CAAYY,WAAZ,EAAyBF,OAAzB,CAAiC,UAAC1D,GAAD,EAAS;AACzC,KAAMC,QAAQ2D,YAAY5D,GAAZ,CAAd;AACApC,YAAWC,KAAX,CAAiB+E,cAAjB,CAAgC5C,GAAhC,EAAqCC,KAArC,EAA4C,YAA5C;AACA,CAHD;AAKA8C,OAAOC,IAAP,CAAYa,WAAZ,EAAyBH,OAAzB,CAAiC,UAAC1D,GAAD,EAAS;AACzC,KAAMC,QAAQ4D,YAAY7D,GAAZ,CAAd;AACApC,YAAWC,KAAX,CAAiB+E,cAAjB,CAAgC5C,GAAhC,EAAqCC,KAArC,EAA4C,oBAA5C,EAAkE,YAAlE;AACA,CAHD;AAKArC,WAAWC,KAAX,CAAiBgF,aAAjB,CAA+B,kBAA/B,EAAmD,+KAAnD;AAEAjF,WAAW8B,QAAX,CAAoBC,GAApB,CAAwB,kBAAxB,EAA4C,EAA5C,EAAgD;AAC/C2C,QAAO,QADwC;AAE/CxF,OAAM,MAFyC;AAG/CgH,OAAM,UAHyC;AAI/CC,YAAW,IAJoC;AAK/C5B,UAAS,YALsC;AAM/C,WAAQ;AANuC,CAAhD,mH","file":"/packages/rocketchat_theme.js","sourcesContent":["/* globals WebAppHashing */\n\nimport less from 'less';\nimport Autoprefixer from 'less-plugin-autoprefix';\nimport crypto from 'crypto';\n\nconst logger = new Logger('rocketchat:theme', {\n\tmethods: {\n\t\tstop_rendering: {\n\t\t\ttype: 'info'\n\t\t}\n\t}\n});\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n\tconst path = req.url.split('?')[0];\n\tconst prefix = __meteor_runtime_config__.ROOT_URL_PATH_PREFIX || '';\n\tif (path === `${ prefix }/__cordova/theme.css` || path === `${ prefix }/theme.css`) {\n\t\tconst css = RocketChat.theme.getCss();\n\t\tconst hash = crypto.createHash('sha1').update(css).digest('hex');\n\t\tres.setHeader('Content-Type', 'text/css; charset=UTF-8');\n\t\tres.setHeader('ETag', `\"${ hash }\"`);\n\t\tres.write(css);\n\t\treturn res.end();\n\t} else {\n\t\treturn next();\n\t}\n});\n\nconst calculateClientHash = WebAppHashing.calculateClientHash;\n\nWebAppHashing.calculateClientHash = function(manifest, includeFilter, runtimeConfigOverride) {\n\tconst css = RocketChat.theme.getCss();\n\tif (css.trim() !== '') {\n\t\tconst hash = crypto.createHash('sha1').update(css).digest('hex');\n\t\tlet themeManifestItem = _.find(manifest, function(item) {\n\t\t\treturn item.path === 'app/theme.css';\n\t\t});\n\t\tif (themeManifestItem == null) {\n\t\t\tthemeManifestItem = {};\n\t\t\tmanifest.push(themeManifestItem);\n\t\t}\n\t\tthemeManifestItem.path = 'app/theme.css';\n\t\tthemeManifestItem.type = 'css';\n\t\tthemeManifestItem.cacheable = true;\n\t\tthemeManifestItem.where = 'client';\n\t\tthemeManifestItem.url = `/theme.css?${ hash }`;\n\t\tthemeManifestItem.size = css.length;\n\t\tthemeManifestItem.hash = hash;\n\t}\n\treturn calculateClientHash.call(this, manifest, includeFilter, runtimeConfigOverride);\n};\n\nRocketChat.theme = new class {\n\tconstructor() {\n\t\tthis.variables = {};\n\t\tthis.packageCallbacks = [];\n\t\tthis.files = ['server/colors.less'];\n\t\tthis.customCSS = '';\n\t\tRocketChat.settings.add('css', '');\n\t\tRocketChat.settings.addGroup('Layout');\n\t\tRocketChat.settings.onload('css', Meteor.bindEnvironment((key, value, initialLoad) => {\n\t\t\tif (!initialLoad) {\n\t\t\t\tMeteor.startup(function() {\n\t\t\t\t\tprocess.emit('message', {\n\t\t\t\t\t\trefresh: 'client'\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}\n\t\t}));\n\t\tthis.compileDelayed = _.debounce(Meteor.bindEnvironment(this.compile.bind(this)), 100);\n\t\tMeteor.startup(() => {\n\t\t\tRocketChat.settings.onAfterInitialLoad(() => {\n\t\t\t\tRocketChat.settings.get(/^theme-./, Meteor.bindEnvironment((key, value) => {\n\t\t\t\t\tif (key === 'theme-custom-css' && value != null) {\n\t\t\t\t\t\tthis.customCSS = value;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst name = key.replace(/^theme-[a-z]+-/, '');\n\t\t\t\t\t\tif (this.variables[name] != null) {\n\t\t\t\t\t\t\tthis.variables[name].value = value;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.compileDelayed();\n\t\t\t\t}));\n\t\t\t});\n\t\t});\n\t}\n\n\tcompile() {\n\t\tlet content = [this.getVariablesAsLess()];\n\n\t\tcontent.push(...this.files.map((name) => Assets.getText(name)));\n\n\t\tcontent.push(...this.packageCallbacks.map(name => name()));\n\n\t\tcontent.push(this.customCSS);\n\t\tcontent = content.join('\\n');\n\t\tconst options = {\n\t\t\tcompress: true,\n\t\t\tplugins: [new Autoprefixer()]\n\t\t};\n\t\tconst start = Date.now();\n\t\treturn less.render(content, options, function(err, data) {\n\t\t\tlogger.stop_rendering(Date.now() - start);\n\t\t\tif (err != null) {\n\t\t\t\treturn console.log(err);\n\t\t\t}\n\t\t\tRocketChat.settings.updateById('css', data.css);\n\t\t\treturn Meteor.startup(function() {\n\t\t\t\treturn Meteor.setTimeout(function() {\n\t\t\t\t\treturn process.emit('message', {\n\t\t\t\t\t\trefresh: 'client'\n\t\t\t\t\t});\n\t\t\t\t}, 200);\n\t\t\t});\n\t\t});\n\t}\n\n\taddColor(name, value, section, properties) {\n\t\tconst config = {\n\t\t\tgroup: 'Colors',\n\t\t\ttype: 'color',\n\t\t\teditor: 'color',\n\t\t\tpublic: true,\n\t\t\tproperties,\n\t\t\tsection\n\t\t};\n\n\t\treturn RocketChat.settings.add(`theme-color-${ name }`, value, config);\n\t}\n\n\taddVariable(type, name, value, section, persist = true, editor, allowedTypes, property) {\n\t\tthis.variables[name] = {\n\t\t\ttype,\n\t\t\tvalue\n\t\t};\n\t\tif (persist) {\n\t\t\tconst config = {\n\t\t\t\tgroup: 'Layout',\n\t\t\t\ttype,\n\t\t\t\teditor: editor || type,\n\t\t\t\tsection,\n\t\t\t\t'public': true,\n\t\t\t\tallowedTypes,\n\t\t\t\tproperty\n\t\t\t};\n\t\t\treturn RocketChat.settings.add(`theme-${ type }-${ name }`, value, config);\n\t\t}\n\n\t}\n\n\taddPublicColor(name, value, section, editor = 'color', property) {\n\t\treturn this.addVariable('color', name, value, section, true, editor, ['color', 'expression'], property);\n\t}\n\n\taddPublicFont(name, value) {\n\t\treturn this.addVariable('font', name, value, 'Fonts', true);\n\t}\n\n\tgetVariablesAsObject() {\n\t\treturn Object.keys(this.variables).reduce((obj, name) => {\n\t\t\tobj[name] = this.variables[name].value;\n\t\t\treturn obj;\n\t\t}, {});\n\t}\n\n\tgetVariablesAsLess() {\n\t\treturn Object.keys(this.variables).map((name) => {\n\t\t\tconst variable = this.variables[name];\n\t\t\treturn `@${ name }: ${ variable.value };`;\n\t\t}).join('\\n');\n\t}\n\n\taddPackageAsset(cb) {\n\t\tthis.packageCallbacks.push(cb);\n\t\treturn this.compileDelayed();\n\t}\n\n\tgetCss() {\n\t\treturn RocketChat.settings.get('css') || '';\n\t}\n\n};\n","\n// TODO: Define registers/getters/setters for packages to work with established\n// \t\t\theirarchy of colors instead of making duplicate definitions\n// TODO: Settings pages to show simple separation of major/minor/addon colors\n// TODO: Get major colours as swatches for minor colors in minicolors plugin\n// TODO: Minicolors settings to use rgb for alphas, hex otherwise\n// TODO: Add setting toggle to use defaults for minor colours and hide settings\n\n// New colors, used for shades on solid backgrounds\n// Defined range of transparencies reduces random colour variances\n// Major colors form the core of the scheme\n// Names changed to reflect usage, comments show pre-refactor names\n\nconst reg = /--(rc-color-.*?): (.*?);/igm;\n\nconst colors = [...Assets.getText('client/imports/general/variables.css').match(reg)].map(color => {\n\tconst [name, value] = color.split(': ');\n\treturn [name.replace('--', ''), value.replace(';', '')];\n});\n\ncolors.forEach(([key, color]) => \t{\n\tif (/var/.test(color)) {\n\t\tconst [, value] = color.match(/var\\(--(.*?)\\)/i);\n\t\treturn RocketChat.theme.addPublicColor(key, value, 'Colors', 'expression');\n\t}\n\tRocketChat.theme.addPublicColor(key, color, 'Colors');\n});\n\nconst majorColors= {\n\t'content-background-color': '#FFFFFF',\n\t'primary-background-color': '#04436A',\n\t'primary-font-color': '#444444',\n\t'primary-action-color': '#13679A', // was action-buttons-color\n\t'secondary-background-color': '#F4F4F4',\n\t'secondary-font-color': '#A0A0A0',\n\t'secondary-action-color': '#DDDDDD',\n\t'component-color': '#EAEAEA',\n\t'success-color': '#4dff4d',\n\t'pending-color': '#FCB316',\n\t'error-color': '#BC2031',\n\t'selection-color': '#02ACEC',\n\t'attention-color': '#9C27B0'\n};\n\n// Minor colours implement major colours by default, but can be overruled\nconst minorColors= {\n\t'tertiary-background-color': '@component-color',\n\t'tertiary-font-color': '@transparent-lightest',\n\t'link-font-color': '@primary-action-color',\n\t'info-font-color': '@secondary-font-color',\n\t'custom-scrollbar-color': '@transparent-darker',\n\t'status-online': '@success-color',\n\t'status-away': '@pending-color',\n\t'status-busy': '@error-color',\n\t'status-offline': '@transparent-darker'\n};\n\n// Bulk-add settings for color scheme\nObject.keys(majorColors).forEach((key) => {\n\tconst value = majorColors[key];\n\tRocketChat.theme.addPublicColor(key, value, 'Old Colors');\n});\n\nObject.keys(minorColors).forEach((key) => {\n\tconst value = minorColors[key];\n\tRocketChat.theme.addPublicColor(key, value, 'Old Colors (minor)', 'expression');\n});\n\nRocketChat.theme.addPublicFont('body-font-family', '-apple-system, BlinkMacSystemFont, Roboto, \\'Helvetica Neue\\', Arial, sans-serif, \\'Apple Color Emoji\\', \\'Segoe UI\\', \\'Segoe UI Emoji\\', \\'Segoe UI Symbol\\', \\'Meiryo UI\\'');\n\nRocketChat.settings.add('theme-custom-css', '', {\n\tgroup: 'Layout',\n\ttype: 'code',\n\tcode: 'text/css',\n\tmultiline: true,\n\tsection: 'Custom CSS',\n\tpublic: true\n});\n\n"]}