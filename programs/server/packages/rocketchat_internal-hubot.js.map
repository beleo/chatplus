{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:internal-hubot/hubot.js","meteor://ðŸ’»app/packages/rocketchat:internal-hubot/settings.js"],"names":["CoffeeScript","Npm","require","register","Hubot","DEBUG","InternalHubot","sendHelper","Meteor","bindEnvironment","robot","envelope","strings","map","length","string","shift","err","console","error","logger","Response","prototype","priv","adapter","Robot","loadAdapter","bind","f","g","self","args","apply","Array","from","hear","respond","enter","leave","topic","catchAll","user","users","findOne","username","name","fields","regex","callback","RocketChatAdapter","send","log","blue","room","id","RocketChat","sendMessage","msg","_id","emote","rid","u","message","private","call","action","to","reply","str","play","run","emit","brain","mergeData","close","Adapter","InternalHubotReceiver","models","Rooms","findOneById","t","InternalHubotUser","User","InternalHubotTextMessage","TextMessage","receive","HubotScripts","modulesToLoad","customPath","settings","get","load","__meteor_bootstrap__","serverDir","split","path","scriptsToLoad","forEach","scriptFile","s","trim","fn","default","parseHelp","green","e","red","init","_","debounce","alias","callbacks","add","priority","LOW","remove","startup","Settings","findByIds","observe","changed","addGroup","type","i18nLabel","i18nDescription"],"mappings":"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","file":"/packages/rocketchat_internal-hubot.js","sourcesContent":["/* globals __meteor_bootstrap__ */\nconst CoffeeScript = Npm.require('coffee-script');\nCoffeeScript.register();\nconst Hubot = Npm.require('hubot');\n// Start a hubot, connected to our chat room.\n// 'use strict'\n// Log messages?\nconst DEBUG = false;\n\nlet InternalHubot = {};\n\nconst sendHelper = Meteor.bindEnvironment((robot, envelope, strings, map) =>{\n\twhile (strings.length > 0) {\n\t\tconst string = strings.shift();\n\t\tif (typeof(string) === 'function') {\n\t\t\tstring();\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tmap(string);\n\t\t\t} catch (err) {\n\t\t\t\tif (DEBUG) { console.error(`Hubot error: ${ err }`); }\n\t\t\t\trobot.logger.error(`RocketChat send error: ${ err }`);\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Monkey-patch Hubot to support private messages\nHubot.Response.prototype.priv = (...strings) => this.robot.adapter.priv(this.envelope, ...strings);\n\n// More monkey-patching\nHubot.Robot.prototype.loadAdapter = () => {}; // disable\n\n// grrrr, Meteor.bindEnvironment doesn't preserve `this` apparently\nconst bind = function(f) {\n\tconst g = Meteor.bindEnvironment((self, ...args) => f.apply(self, args));\n\treturn function(...args) { return g(this, ...Array.from(args)); };\n};\n\nclass Robot extends Hubot.Robot {\n\tconstructor(...args) {\n\t\tsuper(...(args || []));\n\t\tthis.hear = bind(this.hear);\n\t\tthis.respond = bind(this.respond);\n\t\tthis.enter = bind(this.enter);\n\t\tthis.leave = bind(this.leave);\n\t\tthis.topic = bind(this.topic);\n\t\tthis.error = bind(this.error);\n\t\tthis.catchAll = bind(this.catchAll);\n\t\tthis.user = Meteor.users.findOne({username: this.name}, {fields: {username: 1}});\n\t}\n\tloadAdapter() { return false; }\n\thear(regex, callback) { return super.hear(regex, Meteor.bindEnvironment(callback)); }\n\trespond(regex, callback) { return super.respond(regex, Meteor.bindEnvironment(callback)); }\n\tenter(callback) { return super.enter(Meteor.bindEnvironment(callback)); }\n\tleave(callback) { return super.leave(Meteor.bindEnvironment(callback)); }\n\ttopic(callback) { return super.topic(Meteor.bindEnvironment(callback)); }\n\terror(callback) { return super.error(Meteor.bindEnvironment(callback)); }\n\tcatchAll(callback) { return super.catchAll(Meteor.bindEnvironment(callback)); }\n}\n\nclass RocketChatAdapter extends Hubot.Adapter {\n\t// Public: Raw method for sending data back to the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each message to send.\n\t//\n\t// Returns nothing.\n\tsend(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> send'.blue); }\n\t\t// console.log envelope, strings\n\t\treturn sendHelper(this.robot, envelope, strings, string => {\n\t\t\tif (DEBUG) { console.log(`send ${ envelope.room }: ${ string } (${ envelope.user.id })`); }\n\t\t\treturn RocketChat.sendMessage(InternalHubot.user, { msg: string }, { _id: envelope.room });\n\t\t});\n\t}\n\n\t// Public: Raw method for sending emote data back to the chat source.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each message to send.\n\t//\n\t// Returns nothing.\n\temote(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> emote'.blue); }\n\t\treturn sendHelper(this.robot, envelope, strings, string => {\n\t\t\tif (DEBUG) { console.log(`emote ${ envelope.rid }: ${ string } (${ envelope.u.username })`); }\n\t\t\tif (envelope.message.private) { return this.priv(envelope, `*** ${ string } ***`); }\n\t\t\treturn Meteor.call('sendMessage', {\n\t\t\t\tmsg: string,\n\t\t\t\trid: envelope.rid,\n\t\t\t\taction: true\n\t\t\t}\n\t\t\t);\n\t\t});\n\t}\n\n\t// Priv: our extension -- send a PM to user\n\tpriv(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> priv'.blue); }\n\t\treturn sendHelper(this.robot, envelope, strings, function(string) {\n\t\t\tif (DEBUG) { console.log(`priv ${ envelope.room }: ${ string } (${ envelope.user.id })`); }\n\t\t\treturn Meteor.call('sendMessage', {\n\t\t\t\tu: {\n\t\t\t\t\tusername: 'rocketbot'\n\t\t\t\t},\n\t\t\t\tto: `${ envelope.user.id }`,\n\t\t\t\tmsg: string,\n\t\t\t\trid: envelope.room\n\t\t\t});\n\t\t});\n\t}\n\n\t// Public: Raw method for building a reply and sending it back to the chat\n\t// source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more Strings for each reply to send.\n\t//\n\t// Returns nothing.\n\treply(envelope, ...strings) {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> reply'.blue); }\n\t\tif (envelope.message.private) {\n\t\t\treturn this.priv(envelope, ...strings);\n\t\t} else {\n\t\t\treturn this.send(envelope, ...strings.map(str => `${ envelope.user.name }: ${ str }`));\n\t\t}\n\t}\n\n\t// Public: Raw method for setting a topic on the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One more more Strings to set as the topic.\n\t//\n\t// Returns nothing.\n\ttopic(/*envelope, ...strings*/) {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> topic'.blue); }\n\t}\n\n\t// Public: Raw method for playing a sound in the chat source. Extend this.\n\t//\n\t// envelope - A Object with message, room and user details.\n\t// strings  - One or more strings for each play message to send.\n\t//\n\t// Returns nothing\n\tplay(/*envelope, ...strings*/) {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> play'.blue); }\n\t}\n\n\t// Public: Raw method for invoking the bot to run. Extend this.\n\t//\n\t// Returns nothing.\n\trun() {\n\t\tif (DEBUG) { console.log('ROCKETCHATADAPTER -> run'.blue); }\n\t\tthis.robot.emit('connected');\n\t\treturn this.robot.brain.mergeData({});\n\t}\n\t// @robot.brain.emit 'loaded'\n\n\t// Public: Raw method for shutting the bot down. Extend this.\n\t//\n\t// Returns nothing.\n\tclose() {\n\t\tif (DEBUG) { return console.log('ROCKETCHATADAPTER -> close'.blue); }\n\t}\n}\n\nconst InternalHubotReceiver = (message) => {\n\tif (DEBUG) { console.log(message); }\n\tif (message.u.username !== InternalHubot.name) {\n\t\tconst room = RocketChat.models.Rooms.findOneById(message.rid);\n\n\t\tif (room.t === 'c') {\n\t\t\tconst InternalHubotUser = new Hubot.User(message.u.username, {room: message.rid});\n\t\t\tconst InternalHubotTextMessage = new Hubot.TextMessage(InternalHubotUser, message.msg, message._id);\n\t\t\tInternalHubot.adapter.receive(InternalHubotTextMessage);\n\t\t}\n\t}\n\treturn message;\n};\n\nclass HubotScripts {\n\tconstructor(robot) {\n\t\tconst modulesToLoad = [\n\t\t\t'hubot-help/src/help.coffee'\n\t\t];\n\t\tconst customPath = RocketChat.settings.get('InternalHubot_PathToLoadCustomScripts');\n\t\tHubotScripts.load(`${ __meteor_bootstrap__.serverDir }/npm/node_modules/meteor/rocketchat_internal-hubot/node_modules/`, modulesToLoad, robot);\n\t\tHubotScripts.load(customPath, RocketChat.settings.get('InternalHubot_ScriptsToLoad').split(',') || [], robot);\n\t}\n\n\tstatic load(path, scriptsToLoad, robot) {\n\t\tif (!path || !scriptsToLoad) {\n\t\t\treturn;\n\t\t}\n\t\tscriptsToLoad.forEach(scriptFile => {\n\t\t\ttry {\n\t\t\t\tscriptFile = s.trim(scriptFile);\n\t\t\t\tif (scriptFile === '') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t// delete require.cache[require.resolve(path+scriptFile)];\n\t\t\t\tconst fn = Npm.require(path + scriptFile);\n\t\t\t\tif (typeof(fn) === 'function') {\n\t\t\t\t\tfn(robot);\n\t\t\t\t} else {\n\t\t\t\t\tfn.default(robot);\n\t\t\t\t}\n\t\t\t\trobot.parseHelp(path + scriptFile);\n\t\t\t\tconsole.log(`Loaded ${ scriptFile }`.green);\n\t\t\t} catch (e) {\n\t\t\t\tconsole.log(`Can't load ${ scriptFile }`.red);\n\t\t\t\tconsole.log(e);\n\t\t\t}\n\t\t});\n\t}\n}\n\nconst init = _.debounce(Meteor.bindEnvironment(() => {\n\tif (RocketChat.settings.get('InternalHubot_Enabled')) {\n\t\tInternalHubot = new Robot(null, null, false, RocketChat.settings.get('InternalHubot_Username'));\n\t\tInternalHubot.alias = 'bot';\n\t\tInternalHubot.adapter = new RocketChatAdapter(InternalHubot);\n\t\tnew HubotScripts(InternalHubot);\n\t\tInternalHubot.run();\n\t\treturn RocketChat.callbacks.add('afterSaveMessage', InternalHubotReceiver, RocketChat.callbacks.priority.LOW, 'InternalHubot');\n\t} else {\n\t\tInternalHubot = {};\n\t\treturn RocketChat.callbacks.remove('afterSaveMessage', 'InternalHubot');\n\t}\n}), 1000);\n\nMeteor.startup(function() {\n\tinit();\n\tRocketChat.models.Settings.findByIds([ 'InternalHubot_Username', 'InternalHubot_Enabled', 'InternalHubot_ScriptsToLoad', 'InternalHubot_PathToLoadCustomScripts']).observe({\n\t\tchanged() {\n\t\t\treturn init();\n\t\t}\n\t});\n\t// TODO useful when we have the ability to invalidate `require` cache\n\t// RocketChat.RateLimiter.limitMethod('reloadInternalHubot', 1, 5000, {\n\t// \tuserId(/*userId*/) { return true; }\n\t// });\n\t// Meteor.methods({\n\t// \treloadInternalHubot: () => init()\n\t// });\n});\n","RocketChat.settings.addGroup('InternalHubot', function() {\n\tthis.add('InternalHubot_Enabled', false, { type: 'boolean', i18nLabel: 'Enabled' });\n\tthis.add('InternalHubot_Username', 'rocket.cat', { type: 'string', i18nLabel: 'Username', i18nDescription: 'InternalHubot_Username_Description' });\n\tthis.add('InternalHubot_ScriptsToLoad', '', { type: 'string'});\n\tthis.add('InternalHubot_PathToLoadCustomScripts', '', { type: 'string' });\n\t// this.add('InternalHubot_reload', 'reloadInternalHubot', {\n\t// \ttype: 'action',\n\t// \tactionText: 'reload'\n\t// });\n});\n"]}