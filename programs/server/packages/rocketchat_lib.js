(function () {

/* Imports */
var Meteor = Package.meteor.Meteor;
var global = Package.meteor.global;
var meteorEnv = Package.meteor.meteorEnv;
var RateLimiter = Package['rate-limit'].RateLimiter;
var WebApp = Package.webapp.WebApp;
var WebAppInternals = Package.webapp.WebAppInternals;
var main = Package.webapp.main;
var ReactiveVar = Package['reactive-var'].ReactiveVar;
var ReactiveDict = Package['reactive-dict'].ReactiveDict;
var Accounts = Package['accounts-base'].Accounts;
var ECMAScript = Package.ecmascript.ECMAScript;
var Random = Package.random.Random;
var check = Package.check.check;
var Match = Package.check.Match;
var Tracker = Package.tracker.Tracker;
var Deps = Package.tracker.Deps;
var DDPRateLimiter = Package['ddp-rate-limiter'].DDPRateLimiter;
var _ = Package.underscore._;
var MongoInternals = Package.mongo.MongoInternals;
var Mongo = Package.mongo.Mongo;
var OAuth = Package.oauth.OAuth;
var Oauth = Package.oauth.Oauth;
var s = Package['underscorestring:underscore.string'].s;
var CollectionHooks = Package['matb33:collection-hooks'].CollectionHooks;
var ServiceConfiguration = Package['service-configuration'].ServiceConfiguration;
var Streamer = Package['rocketchat:streamer'].Streamer;
var Logger = Package['rocketchat:logger'].Logger;
var SystemLogger = Package['rocketchat:logger'].SystemLogger;
var LoggerManager = Package['rocketchat:logger'].LoggerManager;
var CustomOAuth = Package['rocketchat:custom-oauth'].CustomOAuth;
var FlowRouter = Package['kadira:flow-router'].FlowRouter;
var meteorInstall = Package.modules.meteorInstall;
var meteorBabelHelpers = Package['babel-runtime'].meteorBabelHelpers;
var Promise = Package.promise.Promise;
var Symbol = Package['ecmascript-runtime-server'].Symbol;
var Map = Package['ecmascript-runtime-server'].Map;
var Set = Package['ecmascript-runtime-server'].Set;

/* Package-scope variables */
var RocketChat, name, RocketChatTabBar;

var require = meteorInstall({"node_modules":{"meteor":{"rocketchat:lib":{"lib":{"core.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/core.js                                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var EventEmitter = void 0;                                                                                             // 1
module.watch(require("wolfy87-eventemitter"), {                                                                        // 1
  "default": function (v) {                                                                                            // 1
    EventEmitter = v;                                                                                                  // 1
  }                                                                                                                    // 1
}, 0);                                                                                                                 // 1
RocketChat = new EventEmitter(); /*                                                                                    // 2
                                 * Kick off the global namespace for RocketChat.                                       //
                                 * @namespace RocketChat                                                               //
                                 */                                                                                    //
RocketChat.models = {};                                                                                                // 7
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getURL.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/getURL.js                                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.getURL = function (path) {                                                                                  // 1
	var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},                                    // 1
	    _ref$cdn = _ref.cdn,                                                                                              // 1
	    cdn = _ref$cdn === undefined ? true : _ref$cdn,                                                                   // 1
	    _ref$full = _ref.full,                                                                                            // 1
	    full = _ref$full === undefined ? false : _ref$full;                                                               // 1
                                                                                                                       //
	var cdnPrefix = _.rtrim(_.trim(RocketChat.settings.get('CDN_PREFIX') || ''), '/');                                    // 2
                                                                                                                       //
	var pathPrefix = _.rtrim(_.trim(__meteor_runtime_config__.ROOT_URL_PATH_PREFIX || ''), '/');                          // 3
                                                                                                                       //
	var basePath = void 0;                                                                                                // 5
                                                                                                                       //
	var finalPath = _.ltrim(_.trim(path), '/');                                                                           // 7
                                                                                                                       //
	if (cdn && cdnPrefix !== '') {                                                                                        // 9
		basePath = cdnPrefix + pathPrefix;                                                                                   // 10
	} else if (full || Meteor.isCordova) {                                                                                // 11
		return Meteor.absoluteUrl(finalPath);                                                                                // 12
	} else {                                                                                                              // 13
		basePath = pathPrefix;                                                                                               // 14
	}                                                                                                                     // 15
                                                                                                                       //
	return basePath + "/" + finalPath;                                                                                    // 17
};                                                                                                                     // 18
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settings.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/settings.js                                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/*                                                                                                                     // 2
* RocketChat.settings holds all packages settings                                                                      //
* @namespace RocketChat.settings                                                                                       //
*/RocketChat.settings = {                                                                                              //
	callbacks: {},                                                                                                        // 7
	regexCallbacks: {},                                                                                                   // 8
	ts: new Date(),                                                                                                       // 9
	get: function (_id, callback) {                                                                                       // 10
		if (callback != null) {                                                                                              // 11
			RocketChat.settings.onload(_id, callback);                                                                          // 12
                                                                                                                       //
			if (!Meteor.settings) {                                                                                             // 13
				return;                                                                                                            // 14
			}                                                                                                                   // 15
                                                                                                                       //
			if (_id === '*') {                                                                                                  // 16
				return Object.keys(Meteor.settings).forEach(function (key) {                                                       // 17
					var value = Meteor.settings[key];                                                                                 // 18
					callback(key, value);                                                                                             // 19
				});                                                                                                                // 20
			}                                                                                                                   // 21
                                                                                                                       //
			if (_.isRegExp(_id) && Meteor.settings) {                                                                           // 22
				return Object.keys(Meteor.settings).forEach(function (key) {                                                       // 23
					if (!_id.test(key)) {                                                                                             // 24
						return;                                                                                                          // 25
					}                                                                                                                 // 26
                                                                                                                       //
					var value = Meteor.settings[key];                                                                                 // 27
					callback(key, value);                                                                                             // 28
				});                                                                                                                // 29
			}                                                                                                                   // 30
                                                                                                                       //
			return Meteor.settings[_id] != null && callback(_id, Meteor.settings[_id]);                                         // 31
		} else {                                                                                                             // 32
			if (!Meteor.settings) {                                                                                             // 33
				return;                                                                                                            // 34
			}                                                                                                                   // 35
                                                                                                                       //
			if (_.isRegExp(_id)) {                                                                                              // 36
				return Object.keys(Meteor.settings).reduce(function (items, key) {                                                 // 37
					var value = Meteor.settings[key];                                                                                 // 38
                                                                                                                       //
					if (_id.test(key)) {                                                                                              // 39
						items.push({                                                                                                     // 40
							key: key,                                                                                                       // 41
							value: value                                                                                                    // 42
						});                                                                                                              // 40
					}                                                                                                                 // 44
                                                                                                                       //
					return items;                                                                                                     // 45
				}, []);                                                                                                            // 46
			}                                                                                                                   // 47
                                                                                                                       //
			return Meteor.settings && Meteor.settings[_id];                                                                     // 48
		}                                                                                                                    // 49
	},                                                                                                                    // 50
	set: function (_id, value, callback) {                                                                                // 51
		return Meteor.call('saveSetting', _id, value, callback);                                                             // 52
	},                                                                                                                    // 53
	batchSet: function (settings, callback) {                                                                             // 54
		// async -> sync                                                                                                     // 55
		// http://daemon.co.za/2012/04/simple-async-with-only-underscore/                                                    // 56
		var save = function (setting) {                                                                                      // 57
			return function (callback) {                                                                                        // 58
				return Meteor.call('saveSetting', setting._id, setting.value, setting.editor, callback);                           // 59
			};                                                                                                                  // 60
		};                                                                                                                   // 61
                                                                                                                       //
		var actions = _.map(settings, function (setting) {                                                                   // 62
			return save(setting);                                                                                               // 62
		});                                                                                                                  // 62
                                                                                                                       //
		return _(actions).reduceRight(_.wrap, function (err, success) {                                                      // 63
			return callback(err, success);                                                                                      // 63
		})();                                                                                                                // 63
	},                                                                                                                    // 64
	load: function (key, value, initialLoad) {                                                                            // 65
		['*', key].forEach(function (item) {                                                                                 // 66
			if (RocketChat.settings.callbacks[item]) {                                                                          // 67
				RocketChat.settings.callbacks[item].forEach(function (callback) {                                                  // 68
					return callback(key, value, initialLoad);                                                                         // 68
				});                                                                                                                // 68
			}                                                                                                                   // 69
		});                                                                                                                  // 70
		Object.keys(RocketChat.settings.regexCallbacks).forEach(function (cbKey) {                                           // 71
			var cbValue = RocketChat.settings.regexCallbacks[cbKey];                                                            // 72
                                                                                                                       //
			if (!cbValue.regex.test(key)) {                                                                                     // 73
				return;                                                                                                            // 74
			}                                                                                                                   // 75
                                                                                                                       //
			cbValue.callbacks.forEach(function (callback) {                                                                     // 76
				return callback(key, value, initialLoad);                                                                          // 76
			});                                                                                                                 // 76
		});                                                                                                                  // 77
	},                                                                                                                    // 78
	onload: function (key, callback) {                                                                                    // 79
		// if key is '*'                                                                                                     // 80
		// 	for key, value in Meteor.settings                                                                                // 81
		// 		callback key, value, false                                                                                      // 82
		// else if Meteor.settings?[_id]?                                                                                    // 83
		// 	callback key, Meteor.settings[_id], false                                                                        // 84
		var keys = [].concat(key);                                                                                           // 85
		keys.forEach(function (k) {                                                                                          // 86
			if (_.isRegExp(k)) {                                                                                                // 87
				RocketChat.settings.regexCallbacks[name = k.source] = RocketChat.settings.regexCallbacks[name = k.source] || {     // 88
					regex: k,                                                                                                         // 89
					callbacks: []                                                                                                     // 90
				};                                                                                                                 // 88
				RocketChat.settings.regexCallbacks[k.source].callbacks.push(callback);                                             // 92
			} else {                                                                                                            // 93
				RocketChat.settings.callbacks[k] = RocketChat.settings.callbacks[k] || [];                                         // 94
				RocketChat.settings.callbacks[k].push(callback);                                                                   // 95
			}                                                                                                                   // 96
		});                                                                                                                  // 97
	}                                                                                                                     // 98
};                                                                                                                     // 6
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"callbacks.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/callbacks.js                                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/*                                                                                                                     // 1
* Callback hooks provide an easy way to add extra steps to common operations.                                          //
* @namespace RocketChat.callbacks                                                                                      //
*/RocketChat.callbacks = {};                                                                                           //
                                                                                                                       //
if (Meteor.isServer) {                                                                                                 // 8
	RocketChat.callbacks.showTime = true;                                                                                 // 9
	RocketChat.callbacks.showTotalTime = true;                                                                            // 10
} else {                                                                                                               // 11
	RocketChat.callbacks.showTime = false;                                                                                // 12
	RocketChat.callbacks.showTotalTime = false;                                                                           // 13
} /*                                                                                                                   // 14
  * Callback priorities                                                                                                //
  */                                                                                                                   //
                                                                                                                       //
RocketChat.callbacks.priority = {                                                                                      // 21
	HIGH: -1000,                                                                                                          // 22
	MEDIUM: 0,                                                                                                            // 23
	LOW: 1000                                                                                                             // 24
}; /*                                                                                                                  // 21
   * Add a callback function to a hook                                                                                 //
   * @param {String} hook - The name of the hook                                                                       //
   * @param {Function} callback - The callback function                                                                //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.callbacks.add = function (hook, callback, priority, id) {                                                   // 34
	if (priority == null) {                                                                                               // 35
		priority = RocketChat.callbacks.priority.MEDIUM;                                                                     // 36
	}                                                                                                                     // 37
                                                                                                                       //
	if (!_.isNumber(priority)) {                                                                                          // 38
		priority = RocketChat.callbacks.priority.MEDIUM;                                                                     // 39
	}                                                                                                                     // 40
                                                                                                                       //
	callback.priority = priority;                                                                                         // 41
	callback.id = id || Random.id();                                                                                      // 42
	RocketChat.callbacks[hook] = RocketChat.callbacks[hook] || [];                                                        // 43
                                                                                                                       //
	if (RocketChat.callbacks.showTime === true) {                                                                         // 44
		var err = new Error();                                                                                               // 45
		callback.stack = err.stack;                                                                                          // 46
	}                                                                                                                     // 47
                                                                                                                       //
	if (RocketChat.callbacks[hook].find(function (cb) {                                                                   // 48
		return cb.id === callback.id;                                                                                        // 48
	})) {                                                                                                                 // 48
		return;                                                                                                              // 49
	}                                                                                                                     // 50
                                                                                                                       //
	RocketChat.callbacks[hook].push(callback);                                                                            // 51
}; /*                                                                                                                  // 52
   * Remove a callback from a hook                                                                                     //
   * @param {string} hook - The name of the hook                                                                       //
   * @param {string} id - The callback's id                                                                            //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.callbacks.remove = function (hookName, id) {                                                                // 61
	RocketChat.callbacks[hookName] = _.reject(RocketChat.callbacks[hookName], function (callback) {                       // 62
		return callback.id === id;                                                                                           // 62
	});                                                                                                                   // 62
}; /*                                                                                                                  // 63
   * Successively run all of a hook's callbacks on an item                                                             //
   * @param {String} hook - The name of the hook                                                                       //
   * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                            //
   * @param {Object} [constant] - An optional constant that will be passed along to each callback                      //
   * @returns {Object} Returns the item after it's been through all the callbacks for this hook                        //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.callbacks.run = function (hook, item, constant) {                                                           // 74
	var callbacks = RocketChat.callbacks[hook];                                                                           // 75
                                                                                                                       //
	if (callbacks && callbacks.length) {                                                                                  // 76
		var totalTime = 0;                                                                                                   // 77
                                                                                                                       //
		var result = _.sortBy(callbacks, function (callback) {                                                               // 78
			return callback.priority || RocketChat.callbacks.priority.MEDIUM;                                                   // 79
		}).reduce(function (result, callback) {                                                                              // 80
			var time = 0;                                                                                                       // 81
                                                                                                                       //
			if (RocketChat.callbacks.showTime === true || RocketChat.callbacks.showTotalTime === true) {                        // 82
				time = Date.now();                                                                                                 // 83
			}                                                                                                                   // 84
                                                                                                                       //
			var callbackResult = callback(result, constant);                                                                    // 85
                                                                                                                       //
			if (RocketChat.callbacks.showTime === true || RocketChat.callbacks.showTotalTime === true) {                        // 86
				var currentTime = Date.now() - time;                                                                               // 87
				totalTime += currentTime;                                                                                          // 88
                                                                                                                       //
				if (RocketChat.callbacks.showTime === true) {                                                                      // 89
					if (Meteor.isServer) {                                                                                            // 90
						RocketChat.statsTracker.timing('callbacks.time', currentTime, ["hook:" + hook, "callback:" + callback.id]);      // 91
					} else {                                                                                                          // 92
						var stack = callback.stack && typeof callback.stack.split === 'function' && callback.stack.split('\n');          // 93
						stack = stack && stack[2] && (stack[2].match(/\(.+\)/) || [])[0];                                                // 94
						console.log(String(currentTime), hook, callback.id, stack);                                                      // 95
					}                                                                                                                 // 96
				}                                                                                                                  // 97
			}                                                                                                                   // 98
                                                                                                                       //
			return typeof callbackResult === 'undefined' ? result : callbackResult;                                             // 99
		}, item);                                                                                                            // 100
                                                                                                                       //
		if (RocketChat.callbacks.showTotalTime === true) {                                                                   // 101
			if (Meteor.isServer) {                                                                                              // 102
				RocketChat.statsTracker.timing('callbacks.totalTime', totalTime, ["hook:" + hook]);                                // 103
			} else {                                                                                                            // 104
				console.log(hook + ":", totalTime);                                                                                // 105
			}                                                                                                                   // 106
		}                                                                                                                    // 107
                                                                                                                       //
		return result;                                                                                                       // 108
	} else {                                                                                                              // 109
		return item;                                                                                                         // 110
	}                                                                                                                     // 111
}; /*                                                                                                                  // 112
   * Successively run all of a hook's callbacks on an item, in async mode (only works on server)                       //
   * @param {String} hook - The name of the hook                                                                       //
   * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                            //
   * @param {Object} [constant] - An optional constant that will be passed along to each callback                      //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.callbacks.runAsync = function (hook, item, constant) {                                                      // 122
	var callbacks = RocketChat.callbacks[hook];                                                                           // 123
                                                                                                                       //
	if (Meteor.isServer && callbacks && callbacks.length) {                                                               // 124
		Meteor.defer(function () {                                                                                           // 125
			_.sortBy(callbacks, function (callback) {                                                                           // 126
				return callback.priority || RocketChat.callbacks.priority.MEDIUM;                                                  // 126
			}).forEach(function (callback) {                                                                                    // 126
				return callback(item, constant);                                                                                   // 126
			});                                                                                                                 // 126
		});                                                                                                                  // 127
	} else {                                                                                                              // 128
		return item;                                                                                                         // 129
	}                                                                                                                     // 130
};                                                                                                                     // 131
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"fileUploadRestrictions.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/fileUploadRestrictions.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.fileUploadMediaWhiteList = function () {                                                                    // 1
	var mediaTypeWhiteList = RocketChat.settings.get('FileUpload_MediaTypeWhiteList');                                    // 2
                                                                                                                       //
	if (!mediaTypeWhiteList || mediaTypeWhiteList === '*') {                                                              // 4
		return;                                                                                                              // 5
	}                                                                                                                     // 6
                                                                                                                       //
	return _.map(mediaTypeWhiteList.split(','), function (item) {                                                         // 7
		return item.trim();                                                                                                  // 8
	});                                                                                                                   // 9
};                                                                                                                     // 10
                                                                                                                       //
RocketChat.fileUploadIsValidContentType = function (type) {                                                            // 12
	var list = RocketChat.fileUploadMediaWhiteList();                                                                     // 13
                                                                                                                       //
	if (!list) {                                                                                                          // 14
		return true;                                                                                                         // 15
	}                                                                                                                     // 16
                                                                                                                       //
	if (!type) {                                                                                                          // 18
		return false;                                                                                                        // 19
	}                                                                                                                     // 20
                                                                                                                       //
	if (_.contains(list, type)) {                                                                                         // 22
		return true;                                                                                                         // 23
	} else {                                                                                                              // 24
		var wildCardGlob = '/*';                                                                                             // 25
                                                                                                                       //
		var wildcards = _.filter(list, function (item) {                                                                     // 26
			return item.indexOf(wildCardGlob) > 0;                                                                              // 27
		});                                                                                                                  // 28
                                                                                                                       //
		if (_.contains(wildcards, type.replace(/(\/.*)$/, wildCardGlob))) {                                                  // 29
			return true;                                                                                                        // 30
		}                                                                                                                    // 31
	}                                                                                                                     // 32
                                                                                                                       //
	return false;                                                                                                         // 33
};                                                                                                                     // 34
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getValidRoomName.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/getValidRoomName.js                                                                     //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.getValidRoomName = function () {                                                                            // 1
	function getValidRoomName(displayName) {                                                                              // 1
		var rid = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : '';                                    // 1
		var slugifiedName = displayName;                                                                                     // 2
                                                                                                                       //
		if (RocketChat.settings.get('UI_Allow_room_names_with_special_chars')) {                                             // 4
			var _room = RocketChat.models.Rooms.findOneByDisplayName(displayName);                                              // 5
                                                                                                                       //
			if (_room && _room._id !== rid) {                                                                                   // 6
				if (_room.archived) {                                                                                              // 7
					throw new Meteor.Error('error-archived-duplicate-name', "There's an archived channel with name " + displayName, {
						"function": 'RocketChat.getValidRoomName',                                                                       // 8
						channel_name: displayName                                                                                        // 8
					});                                                                                                               // 8
				} else {                                                                                                           // 9
					throw new Meteor.Error('error-duplicate-channel-name', "A channel with name '" + displayName + "' exists", {      // 10
						"function": 'RocketChat.getValidRoomName',                                                                       // 10
						channel_name: displayName                                                                                        // 10
					});                                                                                                               // 10
				}                                                                                                                  // 11
			}                                                                                                                   // 12
                                                                                                                       //
			slugifiedName = s.slugify(displayName);                                                                             // 13
		}                                                                                                                    // 14
                                                                                                                       //
		var nameValidation = void 0;                                                                                         // 16
                                                                                                                       //
		try {                                                                                                                // 17
			nameValidation = new RegExp("^" + RocketChat.settings.get('UTF8_Names_Validation') + "$");                          // 18
		} catch (error) {                                                                                                    // 19
			nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                   // 20
		}                                                                                                                    // 21
                                                                                                                       //
		if (!nameValidation.test(slugifiedName)) {                                                                           // 22
			throw new Meteor.Error('error-invalid-room-name', slugifiedName + " is not a valid room name.", {                   // 23
				'function': 'RocketChat.getValidRoomName',                                                                         // 24
				channel_name: slugifiedName                                                                                        // 25
			});                                                                                                                 // 23
		}                                                                                                                    // 27
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneByName(slugifiedName);                                                     // 29
                                                                                                                       //
		if (room && room._id !== rid) {                                                                                      // 30
			if (RocketChat.settings.get('UI_Allow_room_names_with_special_chars')) {                                            // 31
				var tmpName = slugifiedName;                                                                                       // 32
				var next = 0;                                                                                                      // 33
                                                                                                                       //
				while (RocketChat.models.Rooms.findOneByNameAndNotId(tmpName, rid)) {                                              // 34
					tmpName = slugifiedName + "-" + ++next;                                                                           // 35
				}                                                                                                                  // 36
                                                                                                                       //
				slugifiedName = tmpName;                                                                                           // 37
			} else if (room.archived) {                                                                                         // 38
				throw new Meteor.Error('error-archived-duplicate-name', "There's an archived channel with name " + slugifiedName, {
					"function": 'RocketChat.getValidRoomName',                                                                        // 39
					channel_name: slugifiedName                                                                                       // 39
				});                                                                                                                // 39
			} else {                                                                                                            // 40
				throw new Meteor.Error('error-duplicate-channel-name', "A channel with name '" + slugifiedName + "' exists", {     // 41
					"function": 'RocketChat.getValidRoomName',                                                                        // 41
					channel_name: slugifiedName                                                                                       // 41
				});                                                                                                                // 41
			}                                                                                                                   // 42
		}                                                                                                                    // 43
                                                                                                                       //
		return slugifiedName;                                                                                                // 45
	}                                                                                                                     // 46
                                                                                                                       //
	return getValidRoomName;                                                                                              // 1
}();                                                                                                                   // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"placeholders.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/placeholders.js                                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.placeholders = {};                                                                                          // 1
                                                                                                                       //
RocketChat.placeholders.replace = function (str, data) {                                                               // 3
	if (!str) {                                                                                                           // 4
		return '';                                                                                                           // 5
	}                                                                                                                     // 6
                                                                                                                       //
	str = str.replace(/\[Site_Name\]/g, RocketChat.settings.get('Site_Name') || '');                                      // 8
	str = str.replace(/\[Site_URL\]/g, RocketChat.settings.get('Site_Url') || '');                                        // 9
                                                                                                                       //
	if (data) {                                                                                                           // 11
		str = str.replace(/\[name\]/g, data.name || '');                                                                     // 12
		str = str.replace(/\[fname\]/g, _.strLeft(data.name, ' ') || '');                                                    // 13
		str = str.replace(/\[lname\]/g, _.strRightBack(data.name, ' ') || '');                                               // 14
		str = str.replace(/\[email\]/g, data.email || '');                                                                   // 15
		str = str.replace(/\[password\]/g, data.password || '');                                                             // 16
		str = str.replace(/\[User\]/g, data.user || '');                                                                     // 17
		str = str.replace(/\[Room\]/g, data.room || '');                                                                     // 18
                                                                                                                       //
		if (data.unsubscribe) {                                                                                              // 20
			str = str.replace(/\[unsubscribe\]/g, data.unsubscribe);                                                            // 21
		}                                                                                                                    // 22
	}                                                                                                                     // 23
                                                                                                                       //
	str = str.replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1' + '<br>' + '$2');                                             // 25
	return str;                                                                                                           // 28
};                                                                                                                     // 29
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"promises.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/promises.js                                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/*                                                                                                                     // 2
* Callback hooks provide an easy way to add extra steps to common operations.                                          //
* @namespace RocketChat.promises                                                                                       //
*/RocketChat.promises = {}; /*                                                                                         //
                            * Callback priorities                                                                      //
                            */                                                                                         //
RocketChat.promises.priority = {                                                                                       // 14
	HIGH: -1000,                                                                                                          // 15
	MEDIUM: 0,                                                                                                            // 16
	LOW: 1000                                                                                                             // 17
}; /*                                                                                                                  // 14
   * Add a callback function to a hook                                                                                 //
   * @param {String} hook - The name of the hook                                                                       //
   * @param {Function} callback - The callback function                                                                //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.promises.add = function (hook, callback) {                                                                  // 27
	var p = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : RocketChat.promises.priority.MEDIUM;      // 27
	var id = arguments[3];                                                                                                // 27
	var priority = !_.isNumber(p) ? RocketChat.promises.priority.MEDIUM : p;                                              // 28
	callback.priority = priority;                                                                                         // 29
	callback.id = id || Random.id();                                                                                      // 30
	RocketChat.promises[hook] = RocketChat.promises[hook] || [];                                                          // 31
                                                                                                                       //
	if (RocketChat.promises[hook].find(function (cb) {                                                                    // 32
		return cb.id === callback.id;                                                                                        // 32
	})) {                                                                                                                 // 32
		return;                                                                                                              // 33
	}                                                                                                                     // 34
                                                                                                                       //
	RocketChat.promises[hook].push(callback);                                                                             // 35
}; /*                                                                                                                  // 36
   * Remove a callback from a hook                                                                                     //
   * @param {string} hook - The name of the hook                                                                       //
   * @param {string} id - The callback's id                                                                            //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.promises.remove = function (hookName, id) {                                                                 // 45
	RocketChat.promises[hookName] = _.reject(RocketChat.promises[hookName], function (callback) {                         // 46
		return callback.id === id;                                                                                           // 46
	});                                                                                                                   // 46
}; /*                                                                                                                  // 47
   * Successively run all of a hook's callbacks on an item                                                             //
   * @param {String} hook - The name of the hook                                                                       //
   * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                            //
   * @param {Object} [constant] - An optional constant that will be passed along to each callback                      //
   * @returns {Object} Returns the item after it's been through all the callbacks for this hook                        //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.promises.run = function (hook, item, constant) {                                                            // 58
	var callbacks = RocketChat.promises[hook];                                                                            // 59
                                                                                                                       //
	if (callbacks == null || callbacks.length === 0) {                                                                    // 60
		return Promise.resolve(item);                                                                                        // 61
	}                                                                                                                     // 62
                                                                                                                       //
	callbacks = _.sortBy(callbacks, function (callback) {                                                                 // 63
		return callback.priority || RocketChat.promises.priority.MEDIUM;                                                     // 63
	});                                                                                                                   // 63
	return callbacks.reduce(function (previousPromise, callback) {                                                        // 64
		return new Promise(function (resolve, reject) {                                                                      // 65
			return previousPromise.then(function (result) {                                                                     // 66
				return callback(result, constant).then(resolve, reject);                                                           // 66
			});                                                                                                                 // 66
		});                                                                                                                  // 67
	}, Promise.resolve(item));                                                                                            // 68
}; /*                                                                                                                  // 69
   * Successively run all of a hook's callbacks on an item, in async mode (only works on server)                       //
   * @param {String} hook - The name of the hook                                                                       //
   * @param {Object} item - The post, comment, modifier, etc. on which to run the callbacks                            //
   * @param {Object} [constant] - An optional constant that will be passed along to each callback                      //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.promises.runAsync = function (hook, item, constant) {                                                       // 79
	var callbacks = RocketChat.promises[hook];                                                                            // 80
                                                                                                                       //
	if (!Meteor.isServer || callbacks == null || callbacks.length === 0) {                                                // 81
		return item;                                                                                                         // 82
	}                                                                                                                     // 83
                                                                                                                       //
	Meteor.defer(function () {                                                                                            // 84
		_.sortBy(callbacks, function (callback) {                                                                            // 85
			return callback.priority || RocketChat.promises.priority.MEDIUM;                                                    // 85
		}).forEach(function (callback) {                                                                                     // 85
			callback(item, constant);                                                                                           // 86
		});                                                                                                                  // 87
	});                                                                                                                   // 88
};                                                                                                                     // 89
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"roomTypesCommon.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/roomTypesCommon.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _extends2 = require("babel-runtime/helpers/extends");                                                              //
                                                                                                                       //
var _extends3 = _interopRequireDefault(_extends2);                                                                     //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals roomExit*/this.roomTypesCommon = function () {                                                              // 1
	function _class() {                                                                                                   // 3
		(0, _classCallCheck3.default)(this, _class);                                                                         // 3
		this.roomTypes = {};                                                                                                 // 4
		this.roomTypesOrder = [];                                                                                            // 5
		this.mainOrder = 1;                                                                                                  // 6
	} /* Adds a room type to app                                                                                          // 7
   @param identifier An identifier to the room type. If a real room, MUST BE the same of `db.rocketchat_room.t` field, if not, can be null
   @param order Order number of the type                                                                               //
   @param config                                                                                                       //
   icon: icon class                                                                                                    //
   label: i18n label                                                                                                   //
   route:                                                                                                              //
   name: route name                                                                                                    //
   action: route action function                                                                                       //
   identifier: room type identifier                                                                                    //
   */                                                                                                                  //
                                                                                                                       //
	_class.prototype.add = function () {                                                                                  // 2
		function add() {                                                                                                     // 2
			var identifier = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : Random.id();                   // 21
			var order = arguments[1];                                                                                           // 21
			var config = arguments[2];                                                                                          // 21
                                                                                                                       //
			if (this.roomTypes[identifier] != null) {                                                                           // 22
				return false;                                                                                                      // 23
			}                                                                                                                   // 24
                                                                                                                       //
			if (order == null) {                                                                                                // 25
				order = this.mainOrder + 10;                                                                                       // 26
				this.mainOrder += 10;                                                                                              // 27
			}                                                                                                                   // 28
                                                                                                                       //
			this.roomTypesOrder.push({                                                                                          // 29
				identifier: identifier,                                                                                            // 30
				order: order                                                                                                       // 31
			});                                                                                                                 // 29
			this.roomTypes[identifier] = (0, _extends3.default)({}, config, {                                                   // 33
				identifier: identifier                                                                                             // 33
			});                                                                                                                 // 33
                                                                                                                       //
			if (config.route && config.route.path && config.route.name && config.route.action) {                                // 34
				var routeConfig = {                                                                                                // 35
					name: config.route.name,                                                                                          // 36
					action: config.route.action                                                                                       // 37
				};                                                                                                                 // 35
                                                                                                                       //
				if (Meteor.isClient) {                                                                                             // 39
					routeConfig.triggersExit = [roomExit];                                                                            // 40
				}                                                                                                                  // 41
                                                                                                                       //
				return FlowRouter.route(config.route.path, routeConfig);                                                           // 42
			}                                                                                                                   // 43
		}                                                                                                                    // 44
                                                                                                                       //
		return add;                                                                                                          // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	_class.prototype.hasCustomLink = function () {                                                                        // 2
		function hasCustomLink(roomType) {                                                                                   // 2
			return this.roomTypes[roomType] && this.roomTypes[roomType].route && this.roomTypes[roomType].route.link != null;   // 47
		}                                                                                                                    // 48
                                                                                                                       //
		return hasCustomLink;                                                                                                // 2
	}(); /*                                                                                                               // 2
      @param roomType: room type (e.g.: c (for channels), d (for direct channels))                                     //
      @param subData: the user's subscription data                                                                     //
      */                                                                                                               //
                                                                                                                       //
	_class.prototype.getRouteLink = function () {                                                                         // 2
		function getRouteLink(roomType, subData) {                                                                           // 2
			if (this.roomTypes[roomType] == null) {                                                                             // 56
				return false;                                                                                                      // 57
			}                                                                                                                   // 58
                                                                                                                       //
			var routeData = {};                                                                                                 // 59
                                                                                                                       //
			if (this.roomTypes[roomType] && this.roomTypes[roomType].route && this.roomTypes[roomType].route.link) {            // 60
				routeData = this.roomTypes[roomType].route.link(subData);                                                          // 61
			} else if (subData && subData.name) {                                                                               // 62
				routeData = {                                                                                                      // 63
					name: subData.name                                                                                                // 64
				};                                                                                                                 // 63
			}                                                                                                                   // 66
                                                                                                                       //
			return FlowRouter.path(this.roomTypes[roomType].route.name, routeData);                                             // 67
		}                                                                                                                    // 68
                                                                                                                       //
		return getRouteLink;                                                                                                 // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	_class.prototype.openRouteLink = function () {                                                                        // 2
		function openRouteLink(roomType, subData, queryParams) {                                                             // 2
			if (this.roomTypes[roomType] == null) {                                                                             // 71
				return false;                                                                                                      // 72
			}                                                                                                                   // 73
                                                                                                                       //
			var routeData = {};                                                                                                 // 74
                                                                                                                       //
			if (this.roomTypes[roomType] && this.roomTypes[roomType].route && this.roomTypes[roomType].route.link) {            // 75
				routeData = this.roomTypes[roomType].route.link(subData);                                                          // 76
			} else if (subData && subData.name) {                                                                               // 77
				routeData = {                                                                                                      // 78
					name: subData.name                                                                                                // 79
				};                                                                                                                 // 78
			}                                                                                                                   // 81
                                                                                                                       //
			return FlowRouter.go(this.roomTypes[roomType].route.name, routeData, queryParams);                                  // 82
		}                                                                                                                    // 83
                                                                                                                       //
		return openRouteLink;                                                                                                // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	return _class;                                                                                                        // 2
}();                                                                                                                   // 2
                                                                                                                       //
module.exportDefault(this.roomTypesCommon);                                                                            // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"slashCommand.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/slashCommand.js                                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.slashCommands = {                                                                                           // 1
	commands: {}                                                                                                          // 2
};                                                                                                                     // 1
                                                                                                                       //
RocketChat.slashCommands.add = function (command, callback) {                                                          // 5
	var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                                 // 5
	var result = arguments[3];                                                                                            // 5
	RocketChat.slashCommands.commands[command] = {                                                                        // 6
		command: command,                                                                                                    // 7
		callback: callback,                                                                                                  // 8
		params: options.params,                                                                                              // 9
		description: options.description,                                                                                    // 10
		clientOnly: options.clientOnly || false,                                                                             // 11
		result: result                                                                                                       // 12
	};                                                                                                                    // 6
};                                                                                                                     // 14
                                                                                                                       //
RocketChat.slashCommands.run = function (command, params, item) {                                                      // 16
	if (RocketChat.slashCommands.commands[command] && RocketChat.slashCommands.commands[command].callback) {              // 17
		return RocketChat.slashCommands.commands[command].callback(command, params, item);                                   // 18
	}                                                                                                                     // 19
};                                                                                                                     // 20
                                                                                                                       //
Meteor.methods({                                                                                                       // 22
	slashCommand: function (command) {                                                                                    // 23
		if (!Meteor.userId()) {                                                                                              // 24
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 25
				method: 'slashCommand'                                                                                             // 26
			});                                                                                                                 // 25
		}                                                                                                                    // 28
                                                                                                                       //
		return RocketChat.slashCommands.run(command.cmd, command.params, command.msg);                                       // 29
	}                                                                                                                     // 30
});                                                                                                                    // 22
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Message.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/Message.js                                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.Message = {                                                                                                 // 1
	parse: function (msg, language) {                                                                                     // 2
		var messageType = RocketChat.MessageTypes.getType(msg);                                                              // 3
                                                                                                                       //
		if (messageType) {                                                                                                   // 4
			if (messageType.render) {                                                                                           // 5
				return messageType.render(msg);                                                                                    // 6
			} else if (messageType.template) {                                                                                  // 7
				// Render message                                                                                                  // 8
				return;                                                                                                            // 9
			} else if (messageType.message) {                                                                                   // 10
				if (!language && typeof localStorage !== 'undefined') {                                                            // 11
					language = localStorage.getItem('userLanguage');                                                                  // 12
				}                                                                                                                  // 13
                                                                                                                       //
				var data = typeof messageType.data === 'function' && messageType.data(msg) || {};                                  // 14
				return TAPi18n.__(messageType.message, data, language);                                                            // 15
			}                                                                                                                   // 16
		}                                                                                                                    // 17
                                                                                                                       //
		if (msg.u && msg.u.username === RocketChat.settings.get('Chatops_Username')) {                                       // 18
			msg.html = msg.msg;                                                                                                 // 19
			return msg.html;                                                                                                    // 20
		}                                                                                                                    // 21
                                                                                                                       //
		msg.html = msg.msg;                                                                                                  // 22
                                                                                                                       //
		if (_.trim(msg.html) !== '') {                                                                                       // 23
			msg.html = _.escapeHTML(msg.html);                                                                                  // 24
		}                                                                                                                    // 25
                                                                                                                       //
		msg.html = msg.html.replace(/\n/gm, '<br/>');                                                                        // 26
		return msg.html;                                                                                                     // 27
	}                                                                                                                     // 28
};                                                                                                                     // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"messageBox.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/messageBox.js                                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _extends2 = require("babel-runtime/helpers/extends");                                                              //
                                                                                                                       //
var _extends3 = _interopRequireDefault(_extends2);                                                                     //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.messageBox = {};                                                                                            // 1
RocketChat.messageBox.actions = new (function () {                                                                     // 3
	function _class() {                                                                                                   // 4
		(0, _classCallCheck3.default)(this, _class);                                                                         // 4
		this.actions = {};                                                                                                   // 5
	} /* Add a action to messagebox                                                                                       // 6
   @param group                                                                                                        //
   @param label                                                                                                        //
   @param config                                                                                                       //
   icon: icon class                                                                                                    //
   action: action function                                                                                             //
   condition: condition to display the action                                                                          //
   */                                                                                                                  //
                                                                                                                       //
	_class.prototype.add = function () {                                                                                  // 3
		function add(group, label, config) {                                                                                 // 3
			if (!group && !label && !config) {                                                                                  // 18
				return;                                                                                                            // 19
			}                                                                                                                   // 20
                                                                                                                       //
			if (!this.actions[group]) {                                                                                         // 22
				this.actions[group] = [];                                                                                          // 23
			}                                                                                                                   // 24
                                                                                                                       //
			var actionExists = this.actions[group].find(function (action) {                                                     // 26
				return action.label === label;                                                                                     // 27
			});                                                                                                                 // 28
                                                                                                                       //
			if (actionExists) {                                                                                                 // 30
				return;                                                                                                            // 31
			}                                                                                                                   // 32
                                                                                                                       //
			this.actions[group].push((0, _extends3.default)({}, config, {                                                       // 34
				label: label                                                                                                       // 34
			}));                                                                                                                // 34
		}                                                                                                                    // 35
                                                                                                                       //
		return add;                                                                                                          // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.get = function () {                                                                                  // 3
		function get(group) {                                                                                                // 3
			var _this = this;                                                                                                   // 37
                                                                                                                       //
			if (!group) {                                                                                                       // 38
				return Object.keys(this.actions).reduce(function (ret, key) {                                                      // 39
					var actions = _this.actions[key].filter(function (action) {                                                       // 40
						return !action.condition || action.condition();                                                                  // 40
					});                                                                                                               // 40
                                                                                                                       //
					if (actions.length) {                                                                                             // 41
						ret[key] = actions;                                                                                              // 42
					}                                                                                                                 // 43
                                                                                                                       //
					return ret;                                                                                                       // 44
				}, {});                                                                                                            // 45
			}                                                                                                                   // 46
                                                                                                                       //
			return this.actions[group].filter(function (action) {                                                               // 48
				return !action.condition || action.condition();                                                                    // 48
			});                                                                                                                 // 48
		}                                                                                                                    // 49
                                                                                                                       //
		return get;                                                                                                          // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.getById = function () {                                                                              // 3
		function getById(id) {                                                                                               // 3
			var messageActions = this.actions;                                                                                  // 52
			var actions = [];                                                                                                   // 53
			Object.keys(messageActions).forEach(function (action) {                                                             // 54
				actions = actions.concat(messageActions[action]);                                                                  // 55
			});                                                                                                                 // 56
			return actions.filter(function (action) {                                                                           // 58
				return action.id === id;                                                                                           // 58
			});                                                                                                                 // 58
		}                                                                                                                    // 59
                                                                                                                       //
		return getById;                                                                                                      // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	return _class;                                                                                                        // 3
}())();                                                                                                                // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"MessageTypes.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/MessageTypes.js                                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.MessageTypes = new (function () {                                                                           // 1
	function _class() {                                                                                                   // 2
		(0, _classCallCheck3.default)(this, _class);                                                                         // 2
		this.types = {};                                                                                                     // 3
	}                                                                                                                     // 4
                                                                                                                       //
	_class.prototype.registerType = function () {                                                                         // 1
		function registerType(options) {                                                                                     // 1
			return this.types[options.id] = options;                                                                            // 7
		}                                                                                                                    // 8
                                                                                                                       //
		return registerType;                                                                                                 // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.getType = function () {                                                                              // 1
		function getType(message) {                                                                                          // 1
			return this.types[message && message.t];                                                                            // 11
		}                                                                                                                    // 12
                                                                                                                       //
		return getType;                                                                                                      // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.isSystemMessage = function () {                                                                      // 1
		function isSystemMessage(message) {                                                                                  // 1
			var type = this.types[message && message.t];                                                                        // 15
			return type && type.system;                                                                                         // 16
		}                                                                                                                    // 17
                                                                                                                       //
		return isSystemMessage;                                                                                              // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	return _class;                                                                                                        // 1
}())();                                                                                                                // 1
Meteor.startup(function () {                                                                                           // 21
	RocketChat.MessageTypes.registerType({                                                                                // 22
		id: 'r',                                                                                                             // 23
		system: true,                                                                                                        // 24
		message: 'Room_name_changed',                                                                                        // 25
		data: function (message) {                                                                                           // 26
			return {                                                                                                            // 27
				room_name: message.msg,                                                                                            // 28
				user_by: message.u.username                                                                                        // 29
			};                                                                                                                  // 27
		}                                                                                                                    // 31
	});                                                                                                                   // 22
	RocketChat.MessageTypes.registerType({                                                                                // 33
		id: 'au',                                                                                                            // 34
		system: true,                                                                                                        // 35
		message: 'User_added_by',                                                                                            // 36
		data: function (message) {                                                                                           // 37
			return {                                                                                                            // 38
				user_added: message.msg,                                                                                           // 39
				user_by: message.u.username                                                                                        // 40
			};                                                                                                                  // 38
		}                                                                                                                    // 42
	});                                                                                                                   // 33
	RocketChat.MessageTypes.registerType({                                                                                // 44
		id: 'ru',                                                                                                            // 45
		system: true,                                                                                                        // 46
		message: 'User_removed_by',                                                                                          // 47
		data: function (message) {                                                                                           // 48
			return {                                                                                                            // 49
				user_removed: message.msg,                                                                                         // 50
				user_by: message.u.username                                                                                        // 51
			};                                                                                                                  // 49
		}                                                                                                                    // 53
	});                                                                                                                   // 44
	RocketChat.MessageTypes.registerType({                                                                                // 55
		id: 'ul',                                                                                                            // 56
		system: true,                                                                                                        // 57
		message: 'User_left',                                                                                                // 58
		data: function (message) {                                                                                           // 59
			return {                                                                                                            // 60
				user_left: message.u.username                                                                                      // 61
			};                                                                                                                  // 60
		}                                                                                                                    // 63
	});                                                                                                                   // 55
	RocketChat.MessageTypes.registerType({                                                                                // 65
		id: 'uj',                                                                                                            // 66
		system: true,                                                                                                        // 67
		message: 'User_joined_channel',                                                                                      // 68
		data: function (message) {                                                                                           // 69
			return {                                                                                                            // 70
				user: message.u.username                                                                                           // 71
			};                                                                                                                  // 70
		}                                                                                                                    // 73
	});                                                                                                                   // 65
	RocketChat.MessageTypes.registerType({                                                                                // 75
		id: 'wm',                                                                                                            // 76
		system: true,                                                                                                        // 77
		message: 'Welcome',                                                                                                  // 78
		data: function (message) {                                                                                           // 79
			return {                                                                                                            // 80
				user: message.u.username                                                                                           // 81
			};                                                                                                                  // 80
		}                                                                                                                    // 83
	});                                                                                                                   // 75
	RocketChat.MessageTypes.registerType({                                                                                // 85
		id: 'rm',                                                                                                            // 86
		system: true,                                                                                                        // 87
		message: 'Message_removed',                                                                                          // 88
		data: function (message) {                                                                                           // 89
			return {                                                                                                            // 90
				user: message.u.username                                                                                           // 91
			};                                                                                                                  // 90
		}                                                                                                                    // 93
	});                                                                                                                   // 85
	RocketChat.MessageTypes.registerType({                                                                                // 95
		id: 'rtc',                                                                                                           // 96
		render: function (message) {                                                                                         // 97
			return RocketChat.callbacks.run('renderRtcMessage', message);                                                       // 98
		}                                                                                                                    // 99
	});                                                                                                                   // 95
	RocketChat.MessageTypes.registerType({                                                                                // 101
		id: 'user-muted',                                                                                                    // 102
		system: true,                                                                                                        // 103
		message: 'User_muted_by',                                                                                            // 104
		data: function (message) {                                                                                           // 105
			return {                                                                                                            // 106
				user_muted: message.msg,                                                                                           // 107
				user_by: message.u.username                                                                                        // 108
			};                                                                                                                  // 106
		}                                                                                                                    // 110
	});                                                                                                                   // 101
	RocketChat.MessageTypes.registerType({                                                                                // 112
		id: 'user-unmuted',                                                                                                  // 113
		system: true,                                                                                                        // 114
		message: 'User_unmuted_by',                                                                                          // 115
		data: function (message) {                                                                                           // 116
			return {                                                                                                            // 117
				user_unmuted: message.msg,                                                                                         // 118
				user_by: message.u.username                                                                                        // 119
			};                                                                                                                  // 117
		}                                                                                                                    // 121
	});                                                                                                                   // 112
	RocketChat.MessageTypes.registerType({                                                                                // 123
		id: 'subscription-role-added',                                                                                       // 124
		system: true,                                                                                                        // 125
		message: '__username__was_set__role__by__user_by_',                                                                  // 126
		data: function (message) {                                                                                           // 127
			return {                                                                                                            // 128
				username: message.msg,                                                                                             // 129
				role: message.role,                                                                                                // 130
				user_by: message.u.username                                                                                        // 131
			};                                                                                                                  // 128
		}                                                                                                                    // 133
	});                                                                                                                   // 123
	RocketChat.MessageTypes.registerType({                                                                                // 135
		id: 'subscription-role-removed',                                                                                     // 136
		system: true,                                                                                                        // 137
		message: '__username__is_no_longer__role__defined_by__user_by_',                                                     // 138
		data: function (message) {                                                                                           // 139
			return {                                                                                                            // 140
				username: message.msg,                                                                                             // 141
				role: message.role,                                                                                                // 142
				user_by: message.u.username                                                                                        // 143
			};                                                                                                                  // 140
		}                                                                                                                    // 145
	});                                                                                                                   // 135
	RocketChat.MessageTypes.registerType({                                                                                // 147
		id: 'room-archived',                                                                                                 // 148
		system: true,                                                                                                        // 149
		message: 'This_room_has_been_archived_by__username_',                                                                // 150
		data: function (message) {                                                                                           // 151
			return {                                                                                                            // 152
				username: message.u.username                                                                                       // 153
			};                                                                                                                  // 152
		}                                                                                                                    // 155
	});                                                                                                                   // 147
	RocketChat.MessageTypes.registerType({                                                                                // 157
		id: 'room-unarchived',                                                                                               // 158
		system: true,                                                                                                        // 159
		message: 'This_room_has_been_unarchived_by__username_',                                                              // 160
		data: function (message) {                                                                                           // 161
			return {                                                                                                            // 162
				username: message.u.username                                                                                       // 163
			};                                                                                                                  // 162
		}                                                                                                                    // 165
	});                                                                                                                   // 157
});                                                                                                                    // 167
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"templateVarHandler.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/templateVarHandler.js                                                                   //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var logger = void 0;                                                                                                   // 1
                                                                                                                       //
if (Meteor.isServer) {                                                                                                 // 3
	logger = new Logger('TemplateVarHandler', {});                                                                        // 4
}                                                                                                                      // 5
                                                                                                                       //
RocketChat.templateVarHandler = function (variable, object) {                                                          // 7
	var templateRegex = /#{([\w\-]+)}/gi;                                                                                 // 9
	var match = templateRegex.exec(variable);                                                                             // 10
	var tmpVariable = variable;                                                                                           // 11
                                                                                                                       //
	if (match == null) {                                                                                                  // 13
		if (!object.hasOwnProperty(variable)) {                                                                              // 14
			logger && logger.debug("user does not have attribute: " + variable);                                                // 15
			return;                                                                                                             // 16
		}                                                                                                                    // 17
                                                                                                                       //
		return object[variable];                                                                                             // 18
	} else {                                                                                                              // 19
		logger && logger.debug('template found. replacing values');                                                          // 20
                                                                                                                       //
		while (match != null) {                                                                                              // 21
			var tmplVar = match[0];                                                                                             // 22
			var tmplAttrName = match[1];                                                                                        // 23
                                                                                                                       //
			if (!object.hasOwnProperty(tmplAttrName)) {                                                                         // 25
				logger && logger.debug("user does not have attribute: " + tmplAttrName);                                           // 26
				return;                                                                                                            // 27
			}                                                                                                                   // 28
                                                                                                                       //
			var attrVal = object[tmplAttrName];                                                                                 // 30
			logger && logger.debug("replacing template var: " + tmplVar + " with value: " + attrVal);                           // 31
			tmpVariable = tmpVariable.replace(tmplVar, attrVal);                                                                // 32
			match = templateRegex.exec(variable);                                                                               // 33
		}                                                                                                                    // 34
                                                                                                                       //
		return tmpVariable;                                                                                                  // 35
	}                                                                                                                     // 36
};                                                                                                                     // 37
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"startup":{"settingsOnLoadSiteUrl.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/lib/startup/settingsOnLoadSiteUrl.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals WebAppInternals */RocketChat.settings.get('Site_Url', function (key, value) {                               // 1
	if (value == null || value.trim() === '') {                                                                           // 3
		return;                                                                                                              // 4
	}                                                                                                                     // 5
                                                                                                                       //
	var host = value.replace(/\/$/, ''); // let prefix = '';                                                              // 6
                                                                                                                       //
	var match = value.match(/([^\/]+\/{2}[^\/]+)(\/.+)/);                                                                 // 8
                                                                                                                       //
	if (match != null) {                                                                                                  // 9
		host = match[1]; // prefix = match[2].replace(/\/$/, '');                                                            // 10
	}                                                                                                                     // 12
                                                                                                                       //
	__meteor_runtime_config__.ROOT_URL = value;                                                                           // 13
                                                                                                                       //
	if (Meteor.absoluteUrl.defaultOptions && Meteor.absoluteUrl.defaultOptions.rootUrl) {                                 // 15
		Meteor.absoluteUrl.defaultOptions.rootUrl = value;                                                                   // 16
	}                                                                                                                     // 17
                                                                                                                       //
	if (Meteor.isServer) {                                                                                                // 18
		RocketChat.hostname = host.replace(/^https?:\/\//, '');                                                              // 19
		process.env.MOBILE_ROOT_URL = host;                                                                                  // 20
		process.env.MOBILE_DDP_URL = host;                                                                                   // 21
                                                                                                                       //
		if (typeof WebAppInternals !== 'undefined' && WebAppInternals.generateBoilerplate) {                                 // 22
			return WebAppInternals.generateBoilerplate();                                                                       // 23
		}                                                                                                                    // 24
	}                                                                                                                     // 25
});                                                                                                                    // 26
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}},"server":{"lib":{"debug.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/debug.js                                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* global InstanceStatus */var logger = new Logger('Meteor', {                                                         // 1
	methods: {                                                                                                            // 3
		method: {                                                                                                            // 4
			type: 'debug'                                                                                                       // 5
		},                                                                                                                   // 4
		publish: {                                                                                                           // 7
			type: 'debug'                                                                                                       // 8
		}                                                                                                                    // 7
	}                                                                                                                     // 3
});                                                                                                                    // 2
                                                                                                                       //
var wrapMethods = function (name, originalHandler, methodsMap) {                                                       // 13
	methodsMap[name] = function () {                                                                                      // 14
		var args = name === 'ufsWrite' ? Array.prototype.slice.call(arguments, 1) : arguments;                               // 15
		logger.method(name, '-> userId:', Meteor.userId(), ', arguments: ', args);                                           // 16
		return originalHandler.apply(this, arguments);                                                                       // 18
	};                                                                                                                    // 19
};                                                                                                                     // 20
                                                                                                                       //
var originalMeteorMethods = Meteor.methods;                                                                            // 22
                                                                                                                       //
Meteor.methods = function (methodMap) {                                                                                // 24
	_.each(methodMap, function (handler, name) {                                                                          // 25
		wrapMethods(name, handler, methodMap);                                                                               // 26
	});                                                                                                                   // 27
                                                                                                                       //
	originalMeteorMethods(methodMap);                                                                                     // 28
};                                                                                                                     // 29
                                                                                                                       //
var originalMeteorPublish = Meteor.publish;                                                                            // 31
                                                                                                                       //
Meteor.publish = function (name, func) {                                                                               // 33
	return originalMeteorPublish(name, function () {                                                                      // 34
		logger.publish(name, '-> userId:', this.userId, ', arguments: ', arguments);                                         // 35
		return func.apply(this, arguments);                                                                                  // 37
	});                                                                                                                   // 38
};                                                                                                                     // 39
                                                                                                                       //
WebApp.rawConnectHandlers.use(function (req, res, next) {                                                              // 41
	res.setHeader('X-Instance-ID', InstanceStatus.id());                                                                  // 42
	return next();                                                                                                        // 43
});                                                                                                                    // 44
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"bugsnag.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/bugsnag.js                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var bugsnag = void 0;                                                                                                  // 1
module.watch(require("bugsnag"), {                                                                                     // 1
	"default": function (v) {                                                                                             // 1
		bugsnag = v;                                                                                                         // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
RocketChat.bugsnag = bugsnag;                                                                                          // 3
RocketChat.settings.get('Bugsnag_api_key', function (key, value) {                                                     // 5
	if (value) {                                                                                                          // 6
		bugsnag.register(value);                                                                                             // 7
	}                                                                                                                     // 8
});                                                                                                                    // 9
                                                                                                                       //
var notify = function (message, stack) {                                                                               // 11
	if (typeof stack === 'string') {                                                                                      // 12
		message += " " + stack;                                                                                              // 13
	}                                                                                                                     // 14
                                                                                                                       //
	var options = {};                                                                                                     // 15
                                                                                                                       //
	if (RocketChat.Info) {                                                                                                // 16
		options = {                                                                                                          // 17
			app: {                                                                                                              // 17
				version: RocketChat.Info.version,                                                                                  // 17
				info: RocketChat.Info                                                                                              // 17
			}                                                                                                                   // 17
		};                                                                                                                   // 17
	}                                                                                                                     // 18
                                                                                                                       //
	var error = new Error(message);                                                                                       // 19
	error.stack = stack;                                                                                                  // 20
	RocketChat.bugsnag.notify(error, options);                                                                            // 21
};                                                                                                                     // 22
                                                                                                                       //
process.on('uncaughtException', Meteor.bindEnvironment(function (error) {                                              // 24
	notify(error.message, error.stack);                                                                                   // 25
	throw error;                                                                                                          // 26
}));                                                                                                                   // 27
var originalMeteorDebug = Meteor._debug;                                                                               // 29
                                                                                                                       //
Meteor._debug = function () {                                                                                          // 30
	notify.apply(undefined, arguments);                                                                                   // 31
	return originalMeteorDebug.apply(undefined, arguments);                                                               // 32
};                                                                                                                     // 33
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"metrics.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/metrics.js                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var client = require('prom-client');                                                                                   // 1
                                                                                                                       //
RocketChat.promclient = client;                                                                                        // 3
RocketChat.metrics = {}; // one sample metrics only - a counter                                                        // 5
                                                                                                                       //
RocketChat.metrics.messagesSent = new client.Counter('messages_sent', 'cumulated number of messages sent');            // 9
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"RateLimiter.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/RateLimiter.js                                                                   //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals RateLimiter */RocketChat.RateLimiter = new (function () {                                                   // 1
	function _class() {                                                                                                   // 2
		(0, _classCallCheck3.default)(this, _class);                                                                         // 2
	}                                                                                                                     // 2
                                                                                                                       //
	_class.prototype.limitFunction = function () {                                                                        // 2
		function limitFunction(fn, numRequests, timeInterval, matchers) {                                                    // 2
			if (process.env.TEST_MODE === 'true') {                                                                             // 4
				return fn;                                                                                                         // 5
			}                                                                                                                   // 6
                                                                                                                       //
			var rateLimiter = new RateLimiter();                                                                                // 7
			rateLimiter.addRule(matchers, numRequests, timeInterval);                                                           // 8
			return function () {                                                                                                // 9
				for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {                             // 9
					args[_key] = arguments[_key];                                                                                     // 9
				}                                                                                                                  // 9
                                                                                                                       //
				var match = {};                                                                                                    // 10
                                                                                                                       //
				_.each(matchers, function (matcher, key) {                                                                         // 11
					return match[key] = args[key];                                                                                    // 12
				});                                                                                                                // 13
                                                                                                                       //
				rateLimiter.increment(match);                                                                                      // 14
				var rateLimitResult = rateLimiter.check(match);                                                                    // 15
                                                                                                                       //
				if (rateLimitResult.allowed) {                                                                                     // 16
					return fn.apply(null, arguments);                                                                                 // 17
				} else {                                                                                                           // 18
					throw new Meteor.Error('error-too-many-requests', "Error, too many requests. Please slow down. You must wait " + Math.ceil(rateLimitResult.timeToReset / 1000) + " seconds before trying again.", {
						timeToReset: rateLimitResult.timeToReset,                                                                        // 20
						seconds: Math.ceil(rateLimitResult.timeToReset / 1000)                                                           // 21
					});                                                                                                               // 19
				}                                                                                                                  // 23
			};                                                                                                                  // 24
		}                                                                                                                    // 25
                                                                                                                       //
		return limitFunction;                                                                                                // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	_class.prototype.limitMethod = function () {                                                                          // 2
		function limitMethod(methodName, numRequests, timeInterval, matchers) {                                              // 2
			if (process.env.TEST_MODE === 'true') {                                                                             // 28
				return;                                                                                                            // 29
			}                                                                                                                   // 30
                                                                                                                       //
			var match = {                                                                                                       // 31
				type: 'method',                                                                                                    // 32
				name: methodName                                                                                                   // 33
			};                                                                                                                  // 31
                                                                                                                       //
			_.each(matchers, function (matcher, key) {                                                                          // 35
				return match[key] = matchers[key];                                                                                 // 36
			});                                                                                                                 // 37
                                                                                                                       //
			return DDPRateLimiter.addRule(match, numRequests, timeInterval);                                                    // 38
		}                                                                                                                    // 39
                                                                                                                       //
		return limitMethod;                                                                                                  // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	return _class;                                                                                                        // 2
}())();                                                                                                                // 2
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"configLogger.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/configLogger.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals LoggerManager */RocketChat.settings.get('Log_Package', function (key, value) {                              // 1
	return LoggerManager.showPackage = value;                                                                             // 3
});                                                                                                                    // 4
RocketChat.settings.get('Log_File', function (key, value) {                                                            // 6
	return LoggerManager.showFileAndLine = value;                                                                         // 7
});                                                                                                                    // 8
RocketChat.settings.get('Log_Level', function (key, value) {                                                           // 10
	if (value != null) {                                                                                                  // 11
		LoggerManager.logLevel = parseInt(value);                                                                            // 12
		Meteor.setTimeout(function () {                                                                                      // 13
			return LoggerManager.enable(true);                                                                                  // 14
		}, 200);                                                                                                             // 15
	}                                                                                                                     // 16
});                                                                                                                    // 17
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"PushNotification.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/PushNotification.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals Push */var PushNotification = function () {                                                                 // 1
	function PushNotification() {                                                                                         //
		(0, _classCallCheck3.default)(this, PushNotification);                                                               //
	}                                                                                                                     //
                                                                                                                       //
	PushNotification.prototype.getNotificationId = function () {                                                          //
		function getNotificationId(roomId) {                                                                                 //
			var serverId = RocketChat.settings.get('uniqueID');                                                                 // 4
			return this.hash(serverId + "|" + roomId); // hash                                                                  // 5
		}                                                                                                                    // 6
                                                                                                                       //
		return getNotificationId;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	PushNotification.prototype.hash = function () {                                                                       //
		function hash(str) {                                                                                                 //
			var hash = 0;                                                                                                       // 9
			var i = str.length;                                                                                                 // 10
                                                                                                                       //
			while (i) {                                                                                                         // 12
				hash = (hash << 5) - hash + str.charCodeAt(--i);                                                                   // 13
				hash = hash & hash; // Convert to 32bit integer                                                                    // 14
			}                                                                                                                   // 15
                                                                                                                       //
			return hash;                                                                                                        // 16
		}                                                                                                                    // 17
                                                                                                                       //
		return hash;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	PushNotification.prototype.send = function () {                                                                       //
		function send(_ref) {                                                                                                //
			var roomName = _ref.roomName,                                                                                       // 19
			    roomId = _ref.roomId,                                                                                           // 19
			    username = _ref.username,                                                                                       // 19
			    message = _ref.message,                                                                                         // 19
			    usersTo = _ref.usersTo,                                                                                         // 19
			    payload = _ref.payload,                                                                                         // 19
			    _ref$badge = _ref.badge,                                                                                        // 19
			    badge = _ref$badge === undefined ? 1 : _ref$badge;                                                              // 19
			var title = void 0;                                                                                                 // 20
                                                                                                                       //
			if (roomName && roomName !== '') {                                                                                  // 21
				title = "" + roomName;                                                                                             // 22
				message = username + ": " + message;                                                                               // 23
			} else {                                                                                                            // 24
				title = "" + username;                                                                                             // 25
			}                                                                                                                   // 26
                                                                                                                       //
			var icon = RocketChat.settings.get('Assets_favicon_192').url || RocketChat.settings.get('Assets_favicon_192').defaultUrl;
			var config = {                                                                                                      // 28
				from: 'push',                                                                                                      // 29
				badge: badge,                                                                                                      // 30
				sound: 'default',                                                                                                  // 31
				title: title,                                                                                                      // 32
				text: message,                                                                                                     // 33
				payload: payload,                                                                                                  // 34
				query: usersTo,                                                                                                    // 35
				notId: this.getNotificationId(roomId),                                                                             // 36
				gcm: {                                                                                                             // 37
					style: 'inbox',                                                                                                   // 38
					summaryText: '%n% new messages',                                                                                  // 39
					image: RocketChat.getURL(icon, {                                                                                  // 40
						full: true                                                                                                       // 40
					})                                                                                                                // 40
				},                                                                                                                 // 37
				apn: {                                                                                                             // 42
					text: title + (title !== '' && message !== '' ? '\n' : '') + message                                              // 43
				}                                                                                                                  // 42
			};                                                                                                                  // 28
			return Push.send(config);                                                                                           // 47
		}                                                                                                                    // 48
                                                                                                                       //
		return send;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	return PushNotification;                                                                                              //
}();                                                                                                                   //
                                                                                                                       //
RocketChat.PushNotification = new PushNotification();                                                                  // 51
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"defaultBlockedDomainsList.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/defaultBlockedDomainsList.js                                                     //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.emailDomainDefaultBlackList = ['0-mail.com', '0815.ru', '0815.su', '0clickemail.com', '0wnd.net', '0wnd.org', '10mail.org', '10minut.com.pl', '10minutemail.co.za', '10minutemail.com', '10minutemail.de', '123-m.com', '1chuan.com', '1fsdfdsfsdf.tk', '1pad.de', '1zhuan.com', '20email.eu', '20mail.eu', '20mail.it', '20minutemail.com', '21cn.com', '2fdgdfgdfgdf.tk', '2prong.com', '30minutemail.com', '33mail.com', '3d-painting.com', '3trtretgfrfe.tk', '4gfdsgfdgfd.tk', '4warding.com', '4warding.net', '4warding.org', '5ghgfhfghfgh.tk', '60minutemail.com', '675hosting.com', '675hosting.net', '675hosting.org', '6hjgjhgkilkj.tk', '6ip.us', '6paq.com', '6url.com', '75hosting.com', '75hosting.net', '75hosting.org', '7days-printing.com', '7tags.com', '99experts.com', '9ox.net', 'a-bc.net', 'a45.in', 'abcmail.email', 'abyssmail.com', 'acentri.com', 'advantimo.com', 'afrobacon.com', 'ag.us.to', 'agedmail.com', 'ahk.jp', 'ajaxapp.net', 'alivance.com', 'ama-trade.de', 'amail.com', 'amilegit.com', 'amiri.net', 'amiriindustries.com', 'anappthat.com', 'ano-mail.net', 'anonbox.net', 'anonmails.de', 'anonymail.dk', 'anonymbox.com', 'antichef.com', 'antichef.net', 'antireg.ru', 'antispam.de', 'antispammail.de', 'appixie.com', 'armyspy.com', 'artman-conception.com', 'aver.com', 'azmeil.tk', 'baxomale.ht.cx', 'beddly.com', 'beefmilk.com', 'bigprofessor.so', 'bigstring.com', 'binkmail.com', 'bio-muesli.net', 'blogmyway.org', 'bobmail.info', 'bofthew.com', 'bootybay.de', 'boun.cr', 'bouncr.com', 'boxformail.in', 'breakthru.com', 'brefmail.com', 'brennendesreich.de', 'broadbandninja.com', 'bsnow.net', 'bspamfree.org', 'bu.mintemail.com', 'buffemail.com', 'bugmenot.com', 'bumpymail.com', 'bund.us', 'bundes-li.ga', 'burnthespam.info', 'burstmail.info', 'buymoreplays.com', 'buyusedlibrarybooks.org', 'byom.de', 'c2.hu', 'cachedot.net', 'card.zp.ua', 'casualdx.com', 'cbair.com', 'cek.pm', 'cellurl.com', 'centermail.com', 'centermail.net', 'chammy.info', 'cheatmail.de', 'childsavetrust.org', 'chogmail.com', 'choicemail1.com', 'chong-mail.com', 'chong-mail.net', 'chong-mail.org', 'clixser.com', 'cmail.com', 'cmail.net', 'cmail.org', 'coldemail.info', 'consumerriot.com', 'cool.fr.nf', 'correo.blogos.net', 'cosmorph.com', 'courriel.fr.nf', 'courrieltemporaire.com', 'crapmail.org', 'crazymailing.com', 'cubiclink.com', 'curryworld.de', 'cust.in', 'cuvox.de', 'd3p.dk', 'dacoolest.com', 'daintly.com', 'dandikmail.com', 'dayrep.com', 'dbunker.com', 'dcemail.com', 'deadaddress.com', 'deadspam.com', 'deagot.com', 'dealja.com', 'delikkt.de', 'despam.it', 'despammed.com', 'devnullmail.com', 'dfgh.net', 'digitalsanctuary.com', 'dingbone.com', 'discard.email', 'discardmail.com', 'discardmail.de', 'disposableaddress.com', 'disposableemailaddresses.com', 'disposableemailaddresses.emailmiser.com', 'disposableinbox.com', 'dispose.it', 'disposeamail.com', 'disposemail.com', 'dispostable.com', 'dlemail.ru', 'dm.w3internet.co.uk', 'dm.w3internet.co.ukexample.com', 'dodgeit.com', 'dodgit.com', 'dodgit.org', 'doiea.com', 'domozmail.com', 'donemail.ru', 'dontreg.com', 'dontsendmespam.de', 'dotmsg.com', 'drdrb.com', 'drdrb.net', 'droplar.com', 'dropmail.me', 'dt.com', 'duam.net', 'dudmail.com', 'dump-email.info', 'dumpandjunk.com', 'dumpmail.de', 'dumpyemail.com', 'duskmail.com', 'e-mail.com', 'e-mail.org', 'e4ward.com', 'easytrashmail.com', 'einmalmail.de', 'einrot.com', 'einrot.de', 'eintagsmail.de', 'email60.com', 'emaildienst.de', 'emailgo.de', 'emailias.com', 'emailigo.de', 'emailinfive.com', 'emaillime.com', 'emailmiser.com', 'emailproxsy.com', 'emailsensei.com', 'emailtemporanea.com', 'emailtemporanea.net', 'emailtemporar.ro', 'emailtemporario.com.br', 'emailthe.net', 'emailtmp.com', 'emailto.de', 'emailwarden.com', 'emailx.at.hm', 'emailxfer.com', 'emeil.in', 'emeil.ir', 'emil.com', 'emz.net', 'enterto.com', 'ephemail.net', 'ero-tube.org', 'etranquil.com', 'etranquil.net', 'etranquil.org', 'evopo.com', 'explodemail.com', 'express.net.ua', 'eyepaste.com', 'fakeinbox.com', 'fakeinformation.com', 'fakemail.fr', 'fakemailz.com', 'fammix.com', 'fansworldwide.de', 'fantasymail.de', 'fastacura.com', 'fastchevy.com', 'fastchrysler.com', 'fastkawasaki.com', 'fastmazda.com', 'fastmitsubishi.com', 'fastnissan.com', 'fastsubaru.com', 'fastsuzuki.com', 'fasttoyota.com', 'fastyamaha.com', 'fatflap.com', 'fdfdsfds.com', 'fightallspam.com', 'figjs.com', 'fiifke.de', 'filzmail.com', 'fivemail.de', 'fixmail.tk', 'fizmail.com', 'fleckens.hu', 'flemail.ru', 'flyspam.com', 'footard.com', 'forgetmail.com', 'fr33mail.info', 'frapmail.com', 'freundin.ru', 'friendlymail.co.uk', 'front14.org', 'fuckingduh.com', 'fudgerub.com', 'fux0ringduh.com', 'fyii.de', 'garliclife.com', 'gehensiemirnichtaufdensack.de', 'gelitik.in', 'get1mail.com', 'get2mail.fr', 'getairmail.com', 'getmails.eu', 'getonemail.com', 'getonemail.net', 'ghosttexter.de', 'giantmail.de', 'girlsundertheinfluence.com', 'gishpuppy.com', 'gmial.com', 'goemailgo.com', 'gorillaswithdirtyarmpits.com', 'gotmail.com', 'gotmail.net', 'gotmail.org', 'gotti.otherinbox.com', 'gowikibooks.com', 'gowikicampus.com', 'gowikicars.com', 'gowikifilms.com', 'gowikigames.com', 'gowikimusic.com', 'gowikimusic.great-host.in', 'gowikinetwork.com', 'gowikitravel.com', 'gowikitv.com', 'grandmamail.com', 'grandmasmail.com', 'great-host.in', 'greensloth.com', 'grr.la', 'gsrv.co.uk', 'guerillamail.biz', 'guerillamail.com', 'guerillamail.net', 'guerillamail.org', 'guerrillamail.biz', 'guerrillamail.com', 'guerrillamail.de', 'guerrillamail.info', 'guerrillamail.net', 'guerrillamail.org', 'guerrillamailblock.com', 'gustr.com', 'h.mintemail.com', 'h8s.org', 'hacccc.com', 'haltospam.com', 'harakirimail.com', 'hartbot.de', 'hat-geld.de', 'hatespam.org', 'hellodream.mobi', 'herp.in', 'hidemail.de', 'hidzz.com', 'hmamail.com', 'hochsitze.com', 'hopemail.biz', 'hotpop.com', 'hulapla.de', 'iaoss.com', 'ieatspam.eu', 'ieatspam.info', 'ieh-mail.de', 'ihateyoualot.info', 'iheartspam.org', 'ikbenspamvrij.nl', 'imails.info', 'imgof.com', 'imstations.com', 'inbax.tk', 'inbox.si', 'inboxalias.com', 'inboxclean.com', 'inboxclean.org', 'inboxproxy.com', 'incognitomail.com', 'incognitomail.net', 'incognitomail.org', 'infocom.zp.ua', 'inoutmail.de', 'inoutmail.eu', 'inoutmail.info', 'inoutmail.net', 'insorg-mail.info', 'instant-mail.de', 'ip6.li', 'ipoo.org', 'irish2me.com', 'iwi.net', 'jamit.com.au', 'jetable.com', 'jetable.fr.nf', 'jetable.net', 'jetable.org', 'jnxjn.com', 'jourrapide.com', 'jsrsolutions.com', 'junk1e.com', 'kasmail.com', 'kaspop.com', 'keepmymail.com', 'killmail.com', 'killmail.net', 'kimsdisk.com', 'kingsq.ga', 'kir.ch.tc', 'klassmaster.com', 'klassmaster.net', 'klzlk.com', 'kook.ml', 'koszmail.pl', 'kulturbetrieb.info', 'kurzepost.de', 'l33r.eu', 'lackmail.net', 'lags.us', 'lawlita.com', 'lazyinbox.com', 'letthemeatspam.com', 'lhsdv.com', 'lifebyfood.com', 'link2mail.net', 'litedrop.com', 'loadby.us', 'login-email.ml', 'lol.ovpn.to', 'lolfreak.net', 'lookugly.com', 'lopl.co.cc', 'lortemail.dk', 'lovemeleaveme.com', 'lr78.com', 'lroid.com', 'lukop.dk', 'm21.cc', 'm4ilweb.info', 'maboard.com', 'mail-filter.com', 'mail-temporaire.fr', 'mail.by', 'mail.mezimages.net', 'mail.zp.ua', 'mail114.net', 'mail1a.de', 'mail21.cc', 'mail2rss.org', 'mail333.com', 'mail4trash.com', 'mailbidon.com', 'mailbiz.biz', 'mailblocks.com', 'mailbucket.org', 'mailcat.biz', 'mailcatch.com', 'mailde.de', 'mailde.info', 'maildrop.cc', 'maildx.com', 'maileater.com', 'mailed.ro', 'maileimer.de', 'mailexpire.com', 'mailfa.tk', 'mailforspam.com', 'mailfreeonline.com', 'mailfs.com', 'mailguard.me', 'mailimate.com', 'mailin8r.com', 'mailinater.com', 'mailinator.com', 'mailinator.net', 'mailinator.org', 'mailinator.us', 'mailinator2.com', 'mailincubator.com', 'mailismagic.com', 'mailmate.com', 'mailme.ir', 'mailme.lv', 'mailme24.com', 'mailmetrash.com', 'mailmetrash.comilzilla.org', 'mailmoat.com', 'mailms.com', 'mailnator.com', 'mailnesia.com', 'mailnull.com', 'mailorg.org', 'mailpick.biz', 'mailproxsy.com', 'mailquack.com', 'mailrock.biz', 'mailscrap.com', 'mailshell.com', 'mailsiphon.com', 'mailslapping.com', 'mailslite.com', 'mailtemp.info', 'mailtome.de', 'mailtothis.com', 'mailtrash.net', 'mailtv.net', 'mailtv.tv', 'mailzilla.com', 'mailzilla.org', 'mailzilla.orgmbx.cc', 'makemetheking.com', 'manifestgenerator.com', 'manybrain.com', 'mbx.cc', 'mega.zik.dj', 'meinspamschutz.de', 'meltmail.com', 'messagebeamer.de', 'mezimages.net', 'mierdamail.com', 'migumail.com', 'ministry-of-silly-walks.de', 'mintemail.com', 'misterpinball.de', 'mjukglass.nu', 'mmailinater.com', 'moakt.com', 'mobi.web.id', 'mobileninja.co.uk', 'moburl.com', 'mohmal.com', 'moncourrier.fr.nf', 'monemail.fr.nf', 'monmail.fr.nf', 'monumentmail.com', 'msa.minsmail.com', 'mt2009.com', 'mt2014.com', 'mx0.wwwnew.eu', 'my10minutemail.com', 'mycard.net.ua', 'mycleaninbox.net', 'myemailboxy.com', 'mymail-in.net', 'mymailoasis.com', 'mynetstore.de', 'mypacks.net', 'mypartyclip.de', 'myphantomemail.com', 'mysamp.de', 'myspaceinc.com', 'myspaceinc.net', 'myspaceinc.org', 'myspacepimpedup.com', 'myspamless.com', 'mytemp.email', 'mytempemail.com', 'mytempmail.com', 'mytrashmail.com', 'nabuma.com', 'neomailbox.com', 'nepwk.com', 'nervmich.net', 'nervtmich.net', 'netmails.com', 'netmails.net', 'netzidiot.de', 'neverbox.com', 'nice-4u.com', 'nincsmail.com', 'nincsmail.hu', 'nnh.com', 'no-spam.ws', 'noblepioneer.com', 'nobulk.com', 'noclickemail.com', 'nogmailspam.info', 'nomail.pw', 'nomail.xl.cx', 'nomail2me.com', 'nomorespamemails.com', 'nonspam.eu', 'nonspammer.de', 'noref.in', 'nospam.ze.tc', 'nospam4.us', 'nospamfor.us', 'nospammail.net', 'nospamthanks.info', 'notmailinator.com', 'notsharingmy.info', 'nowhere.org', 'nowmymail.com', 'nurfuerspam.de', 'nus.edu.sg', 'nwldx.com', 'objectmail.com', 'obobbo.com', 'odaymail.com', 'odnorazovoe.ru', 'one-time.email', 'oneoffemail.com', 'oneoffmail.com', 'onewaymail.com', 'onlatedotcom.info', 'online.ms', 'oopi.org', 'opayq.com', 'ordinaryamerican.net', 'otherinbox.codupmyspace.com', 'otherinbox.com', 'ourklips.com', 'outlawspam.com', 'ovpn.to', 'owlpic.com', 'pancakemail.com', 'paplease.com', 'pcusers.otherinbox.com', 'pepbot.com', 'pfui.ru', 'pimpedupmyspace.com', 'pjjkp.com', 'plexolan.de', 'poczta.onet.pl', 'politikerclub.de', 'pooae.com', 'poofy.org', 'pookmail.com', 'privacy.net', 'privatdemail.net', 'privy-mail.com', 'privymail.de', 'proxymail.eu', 'prtnx.com', 'prtz.eu', 'punkass.com', 'putthisinyourspamdatabase.com', 'pwrby.com', 'quickinbox.com', 'quickmail.nl', 'rcpt.at', 'reallymymail.com', 'realtyalerts.ca', 'recode.me', 'recursor.net', 'recyclemail.dk', 'regbypass.com', 'regbypass.comsafe-mail.net', 'rejectmail.com', 'reliable-mail.com', 'rhyta.com', 'rklips.com', 'rmqkr.net', 'royal.net', 'rppkn.com', 'rtrtr.com', 's0ny.net', 'safe-mail.net', 'safersignup.de', 'safetymail.info', 'safetypost.de', 'sandelf.de', 'saynotospams.com', 'schafmail.de', 'schrott-email.de', 'secretemail.de', 'secure-mail.biz', 'selfdestructingmail.com', 'selfdestructingmail.org', 'sendspamhere.com', 'sendspamhere.com', 'senseless-entertainment.com', 'services391.com', 'sharedmailbox.org', 'sharklasers.com', 'shieldedmail.com', 'shieldemail.com', 'shiftmail.com', 'shitmail.me', 'shitmail.org', 'shitware.nl', 'shmeriously.com', 'shortmail.net', 'shotmail.ru', 'showslow.de', 'sibmail.com', 'sinnlos-mail.de', 'siteposter.net', 'skeefmail.com', 'slapsfromlastnight.com', 'slaskpost.se', 'slipry.net', 'slopsbox.com', 'slushmail.com', 'smashmail.de', 'smellfear.com', 'smellrear.com', 'snakemail.com', 'sneakemail.com', 'sneakmail.de', 'snkmail.com', 'sofimail.com', 'sofort-mail.de', 'softpls.asia', 'sogetthis.com', 'sohu.com', 'solvemail.info', 'soodonims.com', 'spa.com', 'spaereplease.com', 'spam.la', 'spam.su', 'spam4.me', 'spamail.de', 'spamarrest.com', 'spamavert.com', 'spambob.com', 'spambob.net', 'spambob.org', 'spambog.com', 'spambog.de', 'spambog.net', 'spambog.ru', 'spambox.info', 'spambox.irishspringrealty.com', 'spambox.us', 'spamcannon.com', 'spamcannon.net', 'spamcero.com', 'spamcon.org', 'spamcorptastic.com', 'spamcowboy.com', 'spamcowboy.net', 'spamcowboy.org', 'spamday.com', 'spamex.com', 'spamfree.eu', 'spamfree24.com', 'spamfree24.de', 'spamfree24.eu', 'spamfree24.info', 'spamfree24.net', 'spamfree24.org', 'spamgoes.in', 'spamgourmet.com', 'spamgourmet.net', 'spamgourmet.org', 'spamherelots.com', 'spamhereplease.com', 'spamhole.com', 'spamify.com', 'spaminator.de', 'spamkill.info', 'spaml.com', 'spaml.de', 'spammotel.com', 'spamobox.com', 'spamoff.de', 'spamsalad.in', 'spamslicer.com', 'spamspot.com', 'spamstack.net', 'spamthis.co.uk', 'spamthisplease.com', 'spamtrail.com', 'spamtroll.net', 'speed.1s.fr', 'spikio.com', 'spoofmail.de', 'squizzy.de', 'ssoia.com', 'startkeys.com', 'stinkefinger.net', 'stop-my-spam.com', 'stuffmail.de', 'super-auswahl.de', 'supergreatmail.com', 'supermailer.jp', 'superrito.com', 'superstachel.de', 'suremail.info', 'svk.jp', 'sweetxxx.de', 'tagyourself.com', 'talkinator.com', 'tapchicuoihoi.com', 'teewars.org', 'teleosaurs.xyz', 'teleworm.com', 'teleworm.us', 'temp-mail.org', 'temp-mail.ru', 'temp.emeraldwebmail.com', 'temp.headstrong.de', 'tempalias.com', 'tempe-mail.com', 'tempemail.biz', 'tempemail.co.za', 'tempemail.com', 'tempemail.net', 'tempemail.net', 'tempinbox.co.uk', 'tempinbox.com', 'tempmail.eu', 'tempmail.it', 'tempmail2.com', 'tempmaildemo.com', 'tempmailer.com', 'tempmailer.de', 'tempomail.fr', 'temporarily.de', 'temporarioemail.com.br', 'temporaryemail.net', 'temporaryemail.us', 'temporaryforwarding.com', 'temporaryinbox.com', 'temporarymailaddress.com', 'tempsky.com', 'tempthe.net', 'tempymail.com', 'thanksnospam.info', 'thankyou2010.com', 'thc.st', 'thecloudindex.com', 'thelimestones.com', 'thisisnotmyrealemail.com', 'thismail.net', 'thrma.com', 'throwawayemailaddress.com', 'tilien.com', 'tittbit.in', 'tizi.com', 'tmail.ws', 'tmailinator.com', 'toiea.com', 'toomail.biz', 'topranklist.de', 'tradermail.info', 'trash-amil.com', 'trash-mail.at', 'trash-mail.com', 'trash-mail.de', 'trash2009.com', 'trash2010.com', 'trash2011.com', 'trashdevil.com', 'trashdevil.de', 'trashemail.de', 'trashmail.at', 'trashmail.com', 'trashmail.de', 'trashmail.me', 'trashmail.net', 'trashmail.org', 'trashmail.ws', 'trashmailer.com', 'trashymail.com', 'trashymail.net', 'trbvm.com', 'trbvn.com', 'trialmail.de', 'trillianpro.com', 'tryalert.com', 'turual.com', 'twinmail.de', 'twoweirdtricks.com', 'tyldd.com', 'uggsrock.com', 'umail.net', 'upliftnow.com', 'uplipht.com', 'uroid.com', 'us.af', 'username.e4ward.com', 'venompen.com', 'veryrealemail.com', 'vidchart.com', 'viditag.com', 'viewcastmedia.com', 'viewcastmedia.net', 'viewcastmedia.org', 'viewcastmediae', 'viralplays.com', 'vkcode.ru', 'vomoto.com', 'vpn.st', 'vsimcard.com', 'vubby.com', 'walala.org', 'walkmail.net', 'walkmail.ru', 'wasteland.rfc822.org', 'webemail.me', 'webm4il.info', 'webuser.in', 'wee.my', 'weg-werf-email.de', 'wegwerf-email-addressen.de', 'wegwerf-emails.de', 'wegwerfadresse.de', 'wegwerfemail.com', 'wegwerfemail.de', 'wegwerfmail.de', 'wegwerfmail.info', 'wegwerfmail.net', 'wegwerfmail.org', 'wetrainbayarea.com', 'wetrainbayarea.org', 'wh4f.org', 'whatiaas.com', 'whatpaas.com', 'whatsaas.com', 'whopy.com', 'whtjddn.33mail.com', 'whyspam.me', 'wilemail.com', 'willhackforfood.biz', 'willselfdestruct.com', 'winemaven.info', 'wronghead.com', 'wuzup.net', 'wuzupmail.net', 'www.e4ward.com', 'www.gishpuppy.com', 'www.mailinator.com', 'wwwnew.eu', 'x.ip6.li', 'xagloo.com', 'xemaps.com', 'xents.com', 'xmaily.com', 'xoxy.net', 'xyzfree.net', 'yapped.net', 'yeah.net', 'yep.it', 'yogamaven.com', 'yomail.info', 'yopmail.com', 'yopmail.fr', 'yopmail.net', 'yourdomain.com', 'ypmail.webarnak.fr.eu.org', 'yuurok.com', 'z1p.biz', 'za.com', 'zehnminuten.de', 'zehnminutenmail.de', 'zetmail.com', 'zippymail.info', 'zoaxe.com', 'zoemail.com', 'zoemail.net', 'zoemail.org', 'zomg.info', 'zxcv.com', 'zxcvbnm.com', 'zzz.com'];
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"interceptDirectReplyEmails.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/interceptDirectReplyEmails.js                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
module.export({                                                                                                        // 1
	IMAPIntercepter: function () {                                                                                        // 1
		return IMAPIntercepter;                                                                                              // 1
	},                                                                                                                    // 1
	POP3Intercepter: function () {                                                                                        // 1
		return POP3Intercepter;                                                                                              // 1
	},                                                                                                                    // 1
	POP3Helper: function () {                                                                                             // 1
		return POP3Helper;                                                                                                   // 1
	}                                                                                                                     // 1
});                                                                                                                    // 1
var IMAP = void 0;                                                                                                     // 1
module.watch(require("imap"), {                                                                                        // 1
	"default": function (v) {                                                                                             // 1
		IMAP = v;                                                                                                            // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
var POP3 = void 0;                                                                                                     // 1
module.watch(require("poplib"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		POP3 = v;                                                                                                            // 1
	}                                                                                                                     // 1
}, 1);                                                                                                                 // 1
var simpleParser = void 0;                                                                                             // 1
module.watch(require("mailparser-node4"), {                                                                            // 1
	simpleParser: function (v) {                                                                                          // 1
		simpleParser = v;                                                                                                    // 1
	}                                                                                                                     // 1
}, 2);                                                                                                                 // 1
                                                                                                                       //
var IMAPIntercepter = function () {                                                                                    //
	function IMAPIntercepter() {                                                                                          // 6
		var _this = this;                                                                                                    // 6
                                                                                                                       //
		(0, _classCallCheck3.default)(this, IMAPIntercepter);                                                                // 6
		this.imap = new IMAP({                                                                                               // 7
			user: RocketChat.settings.get('Direct_Reply_Username'),                                                             // 8
			password: RocketChat.settings.get('Direct_Reply_Password'),                                                         // 9
			host: RocketChat.settings.get('Direct_Reply_Host'),                                                                 // 10
			port: RocketChat.settings.get('Direct_Reply_Port'),                                                                 // 11
			debug: RocketChat.settings.get('Direct_Reply_Debug') ? console.log : false,                                         // 12
			tls: !RocketChat.settings.get('Direct_Reply_IgnoreTLS'),                                                            // 13
			connTimeout: 30000,                                                                                                 // 14
			keepalive: true                                                                                                     // 15
		});                                                                                                                  // 7
		this.delete = RocketChat.settings.get('Direct_Reply_Delete') ? RocketChat.settings.get('Direct_Reply_Delete') : true; // On successfully connected.
                                                                                                                       //
		this.imap.on('ready', Meteor.bindEnvironment(function () {                                                           // 21
			if (_this.imap.state !== 'disconnected') {                                                                          // 22
				_this.openInbox(Meteor.bindEnvironment(function (err) {                                                            // 23
					if (err) {                                                                                                        // 24
						throw err;                                                                                                       // 25
					} // fetch new emails & wait [IDLE]                                                                               // 26
                                                                                                                       //
                                                                                                                       //
					_this.getEmails(); // If new message arrived, fetch them                                                          // 28
                                                                                                                       //
                                                                                                                       //
					_this.imap.on('mail', Meteor.bindEnvironment(function () {                                                        // 31
						_this.getEmails();                                                                                               // 32
					}));                                                                                                              // 33
				}));                                                                                                               // 34
			} else {                                                                                                            // 35
				console.log('IMAP didnot connected.');                                                                             // 36
                                                                                                                       //
				_this.imap.end();                                                                                                  // 37
			}                                                                                                                   // 38
		}));                                                                                                                 // 39
		this.imap.on('error', function (err) {                                                                               // 41
			console.log('Error occurred ...');                                                                                  // 42
			throw err;                                                                                                          // 43
		});                                                                                                                  // 44
	}                                                                                                                     // 45
                                                                                                                       //
	IMAPIntercepter.prototype.openInbox = function () {                                                                   //
		function openInbox(cb) {                                                                                             //
			this.imap.openBox('INBOX', false, cb);                                                                              // 48
		}                                                                                                                    // 49
                                                                                                                       //
		return openInbox;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	IMAPIntercepter.prototype.start = function () {                                                                       //
		function start() {                                                                                                   //
			this.imap.connect();                                                                                                // 52
		}                                                                                                                    // 53
                                                                                                                       //
		return start;                                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	IMAPIntercepter.prototype.isActive = function () {                                                                    //
		function isActive() {                                                                                                //
			if (this.imap && this.imap.state && this.imap.state === 'disconnected') {                                           // 56
				return false;                                                                                                      // 57
			}                                                                                                                   // 58
                                                                                                                       //
			return true;                                                                                                        // 60
		}                                                                                                                    // 61
                                                                                                                       //
		return isActive;                                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	IMAPIntercepter.prototype.stop = function () {                                                                        //
		function stop() {                                                                                                    //
			var callback = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : new Function();                  // 63
			this.imap.end();                                                                                                    // 64
			this.imap.once('end', callback);                                                                                    // 65
		}                                                                                                                    // 66
                                                                                                                       //
		return stop;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	IMAPIntercepter.prototype.restart = function () {                                                                     //
		function restart() {                                                                                                 //
			var _this2 = this;                                                                                                  // 68
                                                                                                                       //
			this.stop(function () {                                                                                             // 69
				console.log('Restarting IMAP ....');                                                                               // 70
                                                                                                                       //
				_this2.start();                                                                                                    // 71
			});                                                                                                                 // 72
		}                                                                                                                    // 73
                                                                                                                       //
		return restart;                                                                                                      //
	}(); // Fetch all UNSEEN messages and pass them for further processing                                                //
                                                                                                                       //
                                                                                                                       //
	IMAPIntercepter.prototype.getEmails = function () {                                                                   //
		function getEmails() {                                                                                               //
			var _this3 = this;                                                                                                  // 76
                                                                                                                       //
			this.imap.search(['UNSEEN'], Meteor.bindEnvironment(function (err, newEmails) {                                     // 77
				if (err) {                                                                                                         // 78
					console.log(err);                                                                                                 // 79
					throw err;                                                                                                        // 80
				} // newEmails => array containing serials of unseen messages                                                      // 81
                                                                                                                       //
                                                                                                                       //
				if (newEmails.length > 0) {                                                                                        // 84
					var f = _this3.imap.fetch(newEmails, {                                                                            // 85
						// fetch headers & first body part.                                                                              // 86
						bodies: ['HEADER.FIELDS (FROM TO DATE MESSAGE-ID)', '1'],                                                        // 87
						struct: true,                                                                                                    // 88
						markSeen: true                                                                                                   // 89
					});                                                                                                               // 85
                                                                                                                       //
					f.on('message', Meteor.bindEnvironment(function (msg, seqno) {                                                    // 92
						var email = {};                                                                                                  // 93
						msg.on('body', function (stream, info) {                                                                         // 95
							var headerBuffer = '';                                                                                          // 96
							var bodyBuffer = '';                                                                                            // 97
							stream.on('data', function (chunk) {                                                                            // 99
								if (info.which === '1') {                                                                                      // 100
									bodyBuffer += chunk.toString('utf8');                                                                         // 101
								} else {                                                                                                       // 102
									headerBuffer += chunk.toString('utf8');                                                                       // 103
								}                                                                                                              // 104
							});                                                                                                             // 105
							stream.once('end', function () {                                                                                // 107
								if (info.which === '1') {                                                                                      // 108
									email.body = bodyBuffer;                                                                                      // 109
								} else {                                                                                                       // 110
									// parse headers                                                                                              // 111
									email.headers = IMAP.parseHeader(headerBuffer);                                                               // 112
									email.headers.to = email.headers.to[0];                                                                       // 114
									email.headers.date = email.headers.date[0];                                                                   // 115
									email.headers.from = email.headers.from[0];                                                                   // 116
								}                                                                                                              // 117
							});                                                                                                             // 118
						}); // On fetched each message, pass it further                                                                  // 119
                                                                                                                       //
						msg.once('end', Meteor.bindEnvironment(function () {                                                             // 122
							// delete message from inbox                                                                                    // 123
							if (_this3.delete) {                                                                                            // 124
								_this3.imap.seq.addFlags(seqno, 'Deleted', function (err) {                                                    // 125
									if (err) {                                                                                                    // 126
										console.log("Mark deleted error: " + err);                                                                   // 126
									}                                                                                                             // 126
								});                                                                                                            // 127
							}                                                                                                               // 128
                                                                                                                       //
							RocketChat.processDirectEmail(email);                                                                           // 129
						}));                                                                                                             // 130
					}));                                                                                                              // 131
					f.once('error', function (err) {                                                                                  // 132
						console.log("Fetch error: " + err);                                                                              // 133
					});                                                                                                               // 134
				}                                                                                                                  // 135
			}));                                                                                                                // 136
		}                                                                                                                    // 137
                                                                                                                       //
		return getEmails;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	return IMAPIntercepter;                                                                                               //
}();                                                                                                                   //
                                                                                                                       //
var POP3Intercepter = function () {                                                                                    //
	function POP3Intercepter() {                                                                                          // 141
		var _this4 = this;                                                                                                   // 141
                                                                                                                       //
		(0, _classCallCheck3.default)(this, POP3Intercepter);                                                                // 141
		this.pop3 = new POP3(RocketChat.settings.get('Direct_Reply_Port'), RocketChat.settings.get('Direct_Reply_Host'), {   // 142
			enabletls: !RocketChat.settings.get('Direct_Reply_IgnoreTLS'),                                                      // 143
			debug: RocketChat.settings.get('Direct_Reply_Debug') ? console.log : false                                          // 144
		});                                                                                                                  // 142
		this.totalMsgCount = 0;                                                                                              // 147
		this.currentMsgCount = 0;                                                                                            // 148
		this.pop3.on('connect', Meteor.bindEnvironment(function () {                                                         // 150
			_this4.pop3.login(RocketChat.settings.get('Direct_Reply_Username'), RocketChat.settings.get('Direct_Reply_Password'));
		}));                                                                                                                 // 152
		this.pop3.on('login', Meteor.bindEnvironment(function (status) {                                                     // 154
			if (status) {                                                                                                       // 155
				// run on start                                                                                                    // 156
				_this4.pop3.list();                                                                                                // 157
			} else {                                                                                                            // 158
				console.log('Unable to Log-in ....');                                                                              // 159
			}                                                                                                                   // 160
		})); // on getting list of all emails                                                                                // 161
                                                                                                                       //
		this.pop3.on('list', Meteor.bindEnvironment(function (status, msgcount) {                                            // 164
			if (status) {                                                                                                       // 165
				if (msgcount > 0) {                                                                                                // 166
					_this4.totalMsgCount = msgcount;                                                                                  // 167
					_this4.currentMsgCount = 1; // Retrieve email                                                                     // 168
                                                                                                                       //
					_this4.pop3.retr(_this4.currentMsgCount);                                                                         // 170
				} else {                                                                                                           // 171
					_this4.pop3.quit();                                                                                               // 172
				}                                                                                                                  // 173
			} else {                                                                                                            // 174
				console.log('Cannot Get Emails ....');                                                                             // 175
			}                                                                                                                   // 176
		})); // on retrieved email                                                                                           // 177
                                                                                                                       //
		this.pop3.on('retr', Meteor.bindEnvironment(function (status, msgnumber, data) {                                     // 180
			if (status) {                                                                                                       // 181
				// parse raw email data to  JSON object                                                                            // 182
				simpleParser(data, Meteor.bindEnvironment(function (err, mail) {                                                   // 183
					_this4.initialProcess(mail);                                                                                      // 184
				}));                                                                                                               // 185
				_this4.currentMsgCount += 1; // delete email                                                                       // 187
                                                                                                                       //
				_this4.pop3.dele(msgnumber);                                                                                       // 190
			} else {                                                                                                            // 191
				console.log('Cannot Retrieve Message ....');                                                                       // 192
			}                                                                                                                   // 193
		})); // on email deleted                                                                                             // 194
                                                                                                                       //
		this.pop3.on('dele', Meteor.bindEnvironment(function (status) {                                                      // 197
			if (status) {                                                                                                       // 198
				// get next email                                                                                                  // 199
				if (_this4.currentMsgCount <= _this4.totalMsgCount) {                                                              // 200
					_this4.pop3.retr(_this4.currentMsgCount);                                                                         // 201
				} else {                                                                                                           // 202
					// parsed all messages.. so quitting                                                                              // 203
					_this4.pop3.quit();                                                                                               // 204
				}                                                                                                                  // 205
			} else {                                                                                                            // 206
				console.log('Cannot Delete Message....');                                                                          // 207
			}                                                                                                                   // 208
		})); // invalid server state                                                                                         // 209
                                                                                                                       //
		this.pop3.on('invalid-state', function (cmd) {                                                                       // 212
			console.log("Invalid state. You tried calling " + cmd);                                                             // 213
		}); // locked => command already running, not finished yet                                                           // 214
                                                                                                                       //
		this.pop3.on('locked', function (cmd) {                                                                              // 217
			console.log("Current command has not finished yet. You tried calling " + cmd);                                      // 218
		});                                                                                                                  // 219
	}                                                                                                                     // 220
                                                                                                                       //
	POP3Intercepter.prototype.initialProcess = function () {                                                              //
		function initialProcess(mail) {                                                                                      //
			var email = {                                                                                                       // 223
				headers: {                                                                                                         // 224
					from: mail.from.text,                                                                                             // 225
					to: mail.to.text,                                                                                                 // 226
					date: mail.date,                                                                                                  // 227
					'message-id': mail.messageId                                                                                      // 228
				},                                                                                                                 // 224
				body: mail.text                                                                                                    // 230
			};                                                                                                                  // 223
			RocketChat.processDirectEmail(email);                                                                               // 233
		}                                                                                                                    // 234
                                                                                                                       //
		return initialProcess;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	return POP3Intercepter;                                                                                               //
}();                                                                                                                   //
                                                                                                                       //
var POP3Helper = function () {                                                                                         //
	function POP3Helper() {                                                                                               // 238
		(0, _classCallCheck3.default)(this, POP3Helper);                                                                     // 238
		this.running = false;                                                                                                // 239
	}                                                                                                                     // 240
                                                                                                                       //
	POP3Helper.prototype.start = function () {                                                                            //
		function start() {                                                                                                   //
			// run every x-minutes                                                                                              // 243
			if (RocketChat.settings.get('Direct_Reply_Frequency')) {                                                            // 244
				RocketChat.POP3 = new POP3Intercepter();                                                                           // 245
				this.running = Meteor.setInterval(function () {                                                                    // 247
					// get new emails and process                                                                                     // 248
					RocketChat.POP3 = new POP3Intercepter();                                                                          // 249
				}, Math.max(RocketChat.settings.get('Direct_Reply_Frequency') * 60 * 1000, 2 * 60 * 1000));                        // 250
			}                                                                                                                   // 251
		}                                                                                                                    // 252
                                                                                                                       //
		return start;                                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	POP3Helper.prototype.isActive = function () {                                                                         //
		function isActive() {                                                                                                //
			return this.running;                                                                                                // 255
		}                                                                                                                    // 256
                                                                                                                       //
		return isActive;                                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	POP3Helper.prototype.stop = function () {                                                                             //
		function stop() {                                                                                                    //
			var callback = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : new Function();                  // 258
                                                                                                                       //
			if (this.isActive()) {                                                                                              // 259
				Meteor.clearInterval(this.running);                                                                                // 260
			}                                                                                                                   // 261
                                                                                                                       //
			callback();                                                                                                         // 262
		}                                                                                                                    // 263
                                                                                                                       //
		return stop;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	return POP3Helper;                                                                                                    //
}();                                                                                                                   //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"loginErrorMessageOverride.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/loginErrorMessageOverride.js                                                     //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
// Do not disclose if user exists when password is invalid                                                             // 1
var _runLoginHandlers = Accounts._runLoginHandlers;                                                                    // 2
                                                                                                                       //
Accounts._runLoginHandlers = function (methodInvocation, options) {                                                    // 3
	var result = _runLoginHandlers.call(Accounts, methodInvocation, options);                                             // 4
                                                                                                                       //
	if (result.error && result.error.reason === 'Incorrect password') {                                                   // 6
		result.error = new Meteor.Error(403, 'User not found');                                                              // 7
	}                                                                                                                     // 8
                                                                                                                       //
	return result;                                                                                                        // 10
};                                                                                                                     // 11
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"notifyUsersOnMessage.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/notifyUsersOnMessage.js                                                          //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.watch(require("moment"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
RocketChat.callbacks.add('afterSaveMessage', function (message, room) {                                                // 3
	// skips this callback if the message was edited and increments it if the edit was way in the past (aka imported)     // 4
	if (message.editedAt && Math.abs(moment(message.editedAt).diff()) > 60000) {                                          // 5
		//TODO: Review as I am not sure how else to get around this as the incrementing of the msgs count shouldn't be in this callback
		RocketChat.models.Rooms.incMsgCountById(message.rid, 1);                                                             // 7
		return message;                                                                                                      // 8
	} else if (message.editedAt) {                                                                                        // 9
		// skips this callback if the message was edited                                                                     // 10
		return message;                                                                                                      // 11
	}                                                                                                                     // 12
                                                                                                                       //
	if (message.ts && Math.abs(moment(message.ts).diff()) > 60000) {                                                      // 14
		RocketChat.models.Rooms.incMsgCountById(message.rid, 1);                                                             // 15
		return message;                                                                                                      // 16
	} /**                                                                                                                 // 17
    * Chechs if a messages contains a user highlight                                                                   //
    *                                                                                                                  //
    * @param {string} message                                                                                          //
    * @param {array|undefined} highlights                                                                              //
    *                                                                                                                  //
    * @returns {boolean}                                                                                               //
       */                                                                                                              //
                                                                                                                       //
	function messageContainsHighlight(message, highlights) {                                                              // 27
		if (!highlights || highlights.length === 0) {                                                                        // 28
			return false;                                                                                                       // 28
		}                                                                                                                    // 28
                                                                                                                       //
		var has = false;                                                                                                     // 30
		highlights.some(function (highlight) {                                                                               // 31
			var regexp = new RegExp(s.escapeRegExp(highlight), 'i');                                                            // 32
                                                                                                                       //
			if (regexp.test(message.msg)) {                                                                                     // 33
				has = true;                                                                                                        // 34
				return true;                                                                                                       // 35
			}                                                                                                                   // 36
		});                                                                                                                  // 37
		return has;                                                                                                          // 39
	}                                                                                                                     // 40
                                                                                                                       //
	if (room != null) {                                                                                                   // 42
		var toAll = false;                                                                                                   // 43
		var toHere = false;                                                                                                  // 44
		var mentionIds = [];                                                                                                 // 45
		var highlightsIds = [];                                                                                              // 46
		var highlights = RocketChat.models.Users.findUsersByUsernamesWithHighlights(room.usernames, {                        // 47
			fields: {                                                                                                           // 47
				'_id': 1,                                                                                                          // 47
				'settings.preferences.highlights': 1                                                                               // 47
			}                                                                                                                   // 47
		}).fetch();                                                                                                          // 47
                                                                                                                       //
		if (message.mentions != null) {                                                                                      // 49
			message.mentions.forEach(function (mention) {                                                                       // 50
				if (!toAll && mention._id === 'all') {                                                                             // 51
					toAll = true;                                                                                                     // 52
				}                                                                                                                  // 53
                                                                                                                       //
				if (!toHere && mention._id === 'here') {                                                                           // 54
					toHere = true;                                                                                                    // 55
				}                                                                                                                  // 56
                                                                                                                       //
				if (mention._id !== message.u._id) {                                                                               // 57
					mentionIds.push(mention._id);                                                                                     // 58
				}                                                                                                                  // 59
			});                                                                                                                 // 60
		}                                                                                                                    // 61
                                                                                                                       //
		highlights.forEach(function (user) {                                                                                 // 63
			if (user && user.settings && user.settings.preferences && messageContainsHighlight(message, user.settings.preferences.highlights)) {
				if (user._id !== message.u._id) {                                                                                  // 65
					highlightsIds.push(user._id);                                                                                     // 66
				}                                                                                                                  // 67
			}                                                                                                                   // 68
		});                                                                                                                  // 69
                                                                                                                       //
		if (room.t === 'd') {                                                                                                // 71
			var unreadCountDM = RocketChat.settings.get('Unread_Count_DM');                                                     // 72
                                                                                                                       //
			if (unreadCountDM === 'all_messages') {                                                                             // 74
				RocketChat.models.Subscriptions.incUnreadForRoomIdExcludingUserId(room._id, message.u._id);                        // 75
			} else if (toAll || toHere) {                                                                                       // 76
				RocketChat.models.Subscriptions.incGroupMentionsAndUnreadForRoomIdExcludingUserId(room._id, message.u._id, 1, 1);  // 77
			} else if (mentionIds && mentionIds.length > 0 || highlightsIds && highlightsIds.length > 0) {                      // 78
				RocketChat.models.Subscriptions.incUserMentionsAndUnreadForRoomIdAndUserIds(room._id, _.compact(_.unique(mentionIds.concat(highlightsIds))), 1, 1);
			}                                                                                                                   // 80
		} else {                                                                                                             // 81
			var unreadCount = RocketChat.settings.get('Unread_Count');                                                          // 82
                                                                                                                       //
			if (toAll || toHere) {                                                                                              // 84
				var incUnread = 0;                                                                                                 // 85
                                                                                                                       //
				if (['all_messages', 'group_mentions_only', 'user_and_group_mentions_only'].includes(unreadCount)) {               // 86
					incUnread = 1;                                                                                                    // 87
				}                                                                                                                  // 88
                                                                                                                       //
				RocketChat.models.Subscriptions.incGroupMentionsAndUnreadForRoomIdExcludingUserId(room._id, message.u._id, 1, incUnread);
			} else if (mentionIds && mentionIds.length > 0 || highlightsIds && highlightsIds.length > 0) {                      // 90
				var _incUnread = 0;                                                                                                // 91
                                                                                                                       //
				if (['all_messages', 'user_mentions_only', 'user_and_group_mentions_only'].includes(unreadCount)) {                // 92
					_incUnread = 1;                                                                                                   // 93
				}                                                                                                                  // 94
                                                                                                                       //
				RocketChat.models.Subscriptions.incUserMentionsAndUnreadForRoomIdAndUserIds(room._id, _.compact(_.unique(mentionIds.concat(highlightsIds))), 1, _incUnread);
			} else if (unreadCount === 'all_messages') {                                                                        // 96
				RocketChat.models.Subscriptions.incUnreadForRoomIdExcludingUserId(room._id, message.u._id);                        // 97
			}                                                                                                                   // 98
		}                                                                                                                    // 99
	} // Update all the room activity tracker fields                                                                      // 100
                                                                                                                       //
                                                                                                                       //
	RocketChat.models.Rooms.incMsgCountAndSetLastMessageTimestampById(message.rid, 1, message.ts); // Update all other subscriptions to alert their owners but witout incrementing
	// the unread counter, as it is only for mentions and direct messages                                                 // 106
                                                                                                                       //
	RocketChat.models.Subscriptions.setAlertForRoomIdExcludingUserId(message.rid, message.u._id);                         // 107
	return message;                                                                                                       // 109
}, RocketChat.callbacks.priority.LOW, 'notifyUsersOnMessage');                                                         // 111
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"processDirectEmail.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/processDirectEmail.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var reply = void 0;                                                                                                    // 1
module.watch(require("emailreplyparser"), {                                                                            // 1
	EmailReplyParser: function (v) {                                                                                      // 1
		reply = v;                                                                                                           // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
var moment = void 0;                                                                                                   // 1
module.watch(require("moment"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 1);                                                                                                                 // 1
                                                                                                                       //
RocketChat.processDirectEmail = function (email) {                                                                     // 4
	function sendMessage(email) {                                                                                         // 5
		var message = {                                                                                                      // 6
			ts: new Date(email.headers.date),                                                                                   // 7
			msg: email.body,                                                                                                    // 8
			sentByEmail: true,                                                                                                  // 9
			groupable: false                                                                                                    // 10
		};                                                                                                                   // 6
                                                                                                                       //
		if (message.ts) {                                                                                                    // 13
			var tsDiff = Math.abs(moment(message.ts).diff());                                                                   // 14
                                                                                                                       //
			if (tsDiff > 10000) {                                                                                               // 15
				message.ts = new Date();                                                                                           // 16
			}                                                                                                                   // 17
		} else {                                                                                                             // 18
			message.ts = new Date();                                                                                            // 19
		}                                                                                                                    // 20
                                                                                                                       //
		if (message.msg && message.msg.length > RocketChat.settings.get('Message_MaxAllowedSize')) {                         // 22
			return false;                                                                                                       // 23
		} // reduce new lines in multiline message                                                                           // 24
                                                                                                                       //
                                                                                                                       //
		message.msg = message.msg.split('\n\n').join('\n');                                                                  // 27
		var user = RocketChat.models.Users.findOneByEmailAddress(email.headers.from, {                                       // 29
			fields: {                                                                                                           // 30
				username: 1,                                                                                                       // 31
				name: 1                                                                                                            // 32
			}                                                                                                                   // 30
		});                                                                                                                  // 29
                                                                                                                       //
		if (!user) {                                                                                                         // 35
			// user not found                                                                                                   // 36
			return false;                                                                                                       // 37
		}                                                                                                                    // 38
                                                                                                                       //
		var prevMessage = RocketChat.models.Messages.findOneById(email.headers.mid, {                                        // 40
			rid: 1,                                                                                                             // 41
			u: 1                                                                                                                // 42
		});                                                                                                                  // 40
                                                                                                                       //
		if (!prevMessage) {                                                                                                  // 44
			// message doesn't exist anymore                                                                                    // 45
			return false;                                                                                                       // 46
		}                                                                                                                    // 47
                                                                                                                       //
		message.rid = prevMessage.rid;                                                                                       // 48
		var room = Meteor.call('canAccessRoom', message.rid, user._id);                                                      // 50
                                                                                                                       //
		if (!room) {                                                                                                         // 51
			return false;                                                                                                       // 52
		}                                                                                                                    // 53
                                                                                                                       //
		var roomInfo = RocketChat.models.Rooms.findOneById(message.rid, {                                                    // 55
			t: 1,                                                                                                               // 56
			name: 1                                                                                                             // 57
		}); // check mention                                                                                                 // 55
                                                                                                                       //
		if (message.msg.indexOf("@" + prevMessage.u.username) === -1 && roomInfo.t !== 'd') {                                // 61
			message.msg = "@" + prevMessage.u.username + " " + message.msg;                                                     // 62
		} // reply message link                                                                                              // 63
                                                                                                                       //
                                                                                                                       //
		var prevMessageLink = "[ ](" + Meteor.absoluteUrl().replace(/\/$/, '');                                              // 66
                                                                                                                       //
		if (roomInfo.t === 'c') {                                                                                            // 67
			prevMessageLink += "/channel/" + roomInfo.name + "?msg=" + email.headers.mid + ") ";                                // 68
		} else if (roomInfo.t === 'd') {                                                                                     // 69
			prevMessageLink += "/direct/" + prevMessage.u.username + "?msg=" + email.headers.mid + ") ";                        // 70
		} else if (roomInfo.t === 'p') {                                                                                     // 71
			prevMessageLink += "/group/" + roomInfo.name + "?msg=" + email.headers.mid + ") ";                                  // 72
		} // add reply message link                                                                                          // 73
                                                                                                                       //
                                                                                                                       //
		message.msg = prevMessageLink + message.msg;                                                                         // 75
		var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(message.rid, user._id);                  // 77
                                                                                                                       //
		if (subscription && subscription.blocked || subscription.blocker) {                                                  // 78
			// room is blocked                                                                                                  // 79
			return false;                                                                                                       // 80
		}                                                                                                                    // 81
                                                                                                                       //
		if ((room.muted || []).includes(user.username)) {                                                                    // 83
			// room is muted                                                                                                    // 84
			return false;                                                                                                       // 85
		}                                                                                                                    // 86
                                                                                                                       //
		if (message.alias == null && RocketChat.settings.get('Message_SetNameToAliasEnabled')) {                             // 88
			message.alias = user.name;                                                                                          // 89
		}                                                                                                                    // 90
                                                                                                                       //
		RocketChat.metrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736
                                                                                                                       //
		return RocketChat.sendMessage(user, message, room);                                                                  // 94
	} // Extract/parse reply from email body                                                                              // 95
                                                                                                                       //
                                                                                                                       //
	email.body = reply.parse_reply(email.body); // if 'To' email format is "Name <username@domain>"                       // 98
                                                                                                                       //
	if (email.headers.to.indexOf('<') >= 0 && email.headers.to.indexOf('>') >= 0) {                                       // 101
		email.headers.to = email.headers.to.split('<')[1].split('>')[0];                                                     // 102
	} // if 'From' email format is "Name <username@domain>"                                                               // 103
                                                                                                                       //
                                                                                                                       //
	if (email.headers.from.indexOf('<') >= 0 && email.headers.from.indexOf('>') >= 0) {                                   // 106
		email.headers.from = email.headers.from.split('<')[1].split('>')[0];                                                 // 107
	} // 'To' email format "username+messageId@domain"                                                                    // 108
                                                                                                                       //
                                                                                                                       //
	if (email.headers.to.indexOf('+') >= 0) {                                                                             // 111
		// Valid 'To' format                                                                                                 // 112
		email.headers.mid = email.headers.to.split('@')[0].split('+')[1];                                                    // 113
		sendMessage(email);                                                                                                  // 114
	} else {                                                                                                              // 115
		console.log('Invalid Email....If not. Please report it.');                                                           // 116
	}                                                                                                                     // 117
};                                                                                                                     // 118
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"roomTypes.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/roomTypes.js                                                                     //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals roomTypesCommon*/RocketChat.roomTypes = new (function (_roomTypesCommon) {                                  // 1
	(0, _inherits3.default)(roomTypesServer, _roomTypesCommon);                                                           // 2
                                                                                                                       //
	function roomTypesServer() {                                                                                          // 2
		(0, _classCallCheck3.default)(this, roomTypesServer);                                                                // 2
		return (0, _possibleConstructorReturn3.default)(this, _roomTypesCommon.apply(this, arguments));                      // 2
	}                                                                                                                     // 2
                                                                                                                       //
	/* add a publish for a room type                                                                                      // 3
 @param roomType: room type (e.g.: c (for channels), d (for direct channels))                                          //
 @param callback: function that will return the publish's data                                                         //
 */roomTypesServer.prototype.setPublish = function () {                                                                //
		function setPublish(roomType, callback) {                                                                            // 2
			if (this.roomTypes[roomType] && this.roomTypes[roomType].publish != null) {                                         // 9
				throw new Meteor.Error('route-publish-exists', 'Publish for the given type already exists');                       // 10
			}                                                                                                                   // 11
                                                                                                                       //
			if (this.roomTypes[roomType] == null) {                                                                             // 12
				this.roomTypes[roomType] = {};                                                                                     // 13
			}                                                                                                                   // 14
                                                                                                                       //
			return this.roomTypes[roomType].publish = callback;                                                                 // 15
		}                                                                                                                    // 16
                                                                                                                       //
		return setPublish;                                                                                                   // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	roomTypesServer.prototype.setRoomFind = function () {                                                                 // 2
		function setRoomFind(roomType, callback) {                                                                           // 2
			if (this.roomTypes[roomType] && this.roomTypes[roomType].roomFind != null) {                                        // 19
				throw new Meteor.Error('room-find-exists', 'Room find for the given type already exists');                         // 20
			}                                                                                                                   // 21
                                                                                                                       //
			if (this.roomTypes[roomType] == null) {                                                                             // 22
				this.roomTypes[roomType] = {};                                                                                     // 23
			}                                                                                                                   // 24
                                                                                                                       //
			return this.roomTypes[roomType].roomFind = callback;                                                                // 25
		}                                                                                                                    // 26
                                                                                                                       //
		return setRoomFind;                                                                                                  // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	roomTypesServer.prototype.getRoomFind = function () {                                                                 // 2
		function getRoomFind(roomType) {                                                                                     // 2
			return this.roomTypes[roomType] && this.roomTypes[roomType].roomFind;                                               // 28
		}                                                                                                                    // 29
                                                                                                                       //
		return getRoomFind;                                                                                                  // 2
	}(); /* run the publish for a room type                                                                               // 2
      @param scope: Meteor publish scope                                                                               //
      @param roomType: room type (e.g.: c (for channels), d (for direct channels))                                     //
      @param identifier: identifier of the room                                                                        //
      */                                                                                                               //
                                                                                                                       //
	roomTypesServer.prototype.runPublish = function () {                                                                  // 2
		function runPublish(scope, roomType, identifier) {                                                                   // 2
			return this.roomTypes[roomType] && this.roomTypes[roomType].publish && this.roomTypes[roomType].publish.call(scope, identifier);
		}                                                                                                                    // 40
                                                                                                                       //
		return runPublish;                                                                                                   // 2
	}();                                                                                                                  // 2
                                                                                                                       //
	return roomTypesServer;                                                                                               // 2
}(roomTypesCommon))();                                                                                                 // 2
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendEmailOnMessage.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/sendEmailOnMessage.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.watch(require("moment"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
RocketChat.callbacks.add('afterSaveMessage', function (message, room) {                                                // 3
	// skips this callback if the message was edited                                                                      // 4
	if (message.editedAt) {                                                                                               // 5
		return message;                                                                                                      // 6
	}                                                                                                                     // 7
                                                                                                                       //
	if (message.ts && Math.abs(moment(message.ts).diff()) > 60000) {                                                      // 9
		return message;                                                                                                      // 10
	}                                                                                                                     // 11
                                                                                                                       //
	var getMessageLink = function (room, sub) {                                                                           // 13
		var roomPath = RocketChat.roomTypes.getRouteLink(room.t, sub);                                                       // 14
		var path = Meteor.absoluteUrl(roomPath ? roomPath.replace(/^\//, '') : '');                                          // 15
		var style = ['color: #fff;', 'padding: 9px 12px;', 'border-radius: 4px;', 'background-color: #04436a;', 'text-decoration: none;'].join(' ');
                                                                                                                       //
		var message = TAPi18n.__('Offline_Link_Message');                                                                    // 23
                                                                                                                       //
		return "<p style=\"text-align:center;margin-bottom:8px;\"><a style=\"" + style + "\" href=\"" + path + "\">" + message + "</a>";
	};                                                                                                                    // 25
                                                                                                                       //
	var divisorMessage = '<hr style="margin: 20px auto; border: none; border-bottom: 1px solid #dddddd;">';               // 27
	var messageHTML = s.escapeHTML(message.msg);                                                                          // 28
	message = RocketChat.callbacks.run('renderMessage', message);                                                         // 30
                                                                                                                       //
	if (message.tokens && message.tokens.length > 0) {                                                                    // 31
		message.tokens.forEach(function (token) {                                                                            // 32
			token.text = token.text.replace(/([^\$])(\$[^\$])/gm, '$1$$$2');                                                    // 33
			messageHTML = messageHTML.replace(token.token, token.text);                                                         // 34
		});                                                                                                                  // 35
	}                                                                                                                     // 36
                                                                                                                       //
	var header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');                          // 38
	var footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');                          // 39
	messageHTML = messageHTML.replace(/\n/gm, '<br/>');                                                                   // 40
	var usersToSendEmail = {};                                                                                            // 42
                                                                                                                       //
	if (room.t === 'd') {                                                                                                 // 43
		usersToSendEmail[message.rid.replace(message.u._id, '')] = 'direct';                                                 // 44
	} else {                                                                                                              // 45
		var isMentionAll = message.mentions.find(function (mention) {                                                        // 46
			return mention._id === 'all';                                                                                       // 46
		});                                                                                                                  // 46
                                                                                                                       //
		if (isMentionAll) {                                                                                                  // 48
			var maxMembersForNotification = RocketChat.settings.get('Notifications_Max_Room_Members');                          // 49
                                                                                                                       //
			if (maxMembersForNotification !== 0 && room.usernames.length > maxMembersForNotification) {                         // 50
				isMentionAll = undefined;                                                                                          // 51
			}                                                                                                                   // 52
		}                                                                                                                    // 53
                                                                                                                       //
		var query = void 0;                                                                                                  // 55
                                                                                                                       //
		if (isMentionAll) {                                                                                                  // 56
			// Query all users in room limited by the max room members setting                                                  // 57
			query = RocketChat.models.Subscriptions.findByRoomId(room._id);                                                     // 58
		} else {                                                                                                             // 59
			// Query only mentioned users, will be always a few users                                                           // 60
			var userIds = message.mentions.map(function (mention) {                                                             // 61
				return mention._id;                                                                                                // 61
			});                                                                                                                 // 61
			query = RocketChat.models.Subscriptions.findByRoomIdAndUserIdsOrAllMessages(room._id, userIds);                     // 62
		}                                                                                                                    // 63
                                                                                                                       //
		query.forEach(function (sub) {                                                                                       // 65
			if (sub.disableNotifications) {                                                                                     // 66
				return delete usersToSendEmail[sub.u._id];                                                                         // 67
			}                                                                                                                   // 68
                                                                                                                       //
			var emailNotifications = sub.emailNotifications;                                                                    // 70
                                                                                                                       //
			if (emailNotifications === 'nothing') {                                                                             // 72
				return delete usersToSendEmail[sub.u._id];                                                                         // 73
			}                                                                                                                   // 74
                                                                                                                       //
			var mentionedUser = isMentionAll || message.mentions.find(function (mention) {                                      // 76
				return mention._id === sub.u._id;                                                                                  // 76
			});                                                                                                                 // 76
                                                                                                                       //
			if (emailNotifications === 'default' || emailNotifications == null) {                                               // 78
				if (mentionedUser) {                                                                                               // 79
					return usersToSendEmail[sub.u._id] = 'default';                                                                   // 80
				}                                                                                                                  // 81
                                                                                                                       //
				return delete usersToSendEmail[sub.u._id];                                                                         // 82
			}                                                                                                                   // 83
                                                                                                                       //
			if (emailNotifications === 'mentions' && mentionedUser) {                                                           // 85
				return usersToSendEmail[sub.u._id] = 'mention';                                                                    // 86
			}                                                                                                                   // 87
                                                                                                                       //
			if (emailNotifications === 'all') {                                                                                 // 89
				return usersToSendEmail[sub.u._id] = 'all';                                                                        // 90
			}                                                                                                                   // 91
		});                                                                                                                  // 92
	}                                                                                                                     // 93
                                                                                                                       //
	var userIdsToSendEmail = Object.keys(usersToSendEmail);                                                               // 94
	var defaultLink = void 0;                                                                                             // 96
	var linkByUser = {};                                                                                                  // 98
                                                                                                                       //
	if (RocketChat.roomTypes.hasCustomLink(room.t)) {                                                                     // 99
		RocketChat.models.Subscriptions.findByRoomIdAndUserIds(room._id, userIdsToSendEmail).forEach(function (sub) {        // 100
			linkByUser[sub.u._id] = getMessageLink(room, sub);                                                                  // 101
		});                                                                                                                  // 102
	} else {                                                                                                              // 103
		defaultLink = getMessageLink(room, {                                                                                 // 104
			name: room.name                                                                                                     // 105
		});                                                                                                                  // 104
	}                                                                                                                     // 107
                                                                                                                       //
	if (userIdsToSendEmail.length > 0) {                                                                                  // 109
		var usersOfMention = RocketChat.models.Users.getUsersToSendOfflineEmail(userIdsToSendEmail).fetch();                 // 110
                                                                                                                       //
		if (usersOfMention && usersOfMention.length > 0) {                                                                   // 112
			usersOfMention.forEach(function (user) {                                                                            // 113
				if (usersToSendEmail[user._id] === 'default') {                                                                    // 114
					if (!user.settings || !user.settings.preferences || !user.settings.preferences.emailNotificationMode || user.settings.preferences.emailNotificationMode === 'all') {
						//Mention/DM                                                                                                     // 115
						usersToSendEmail[user._id] = 'mention';                                                                          // 116
					} else {                                                                                                          // 117
						return;                                                                                                          // 118
					}                                                                                                                 // 119
				} // Checks if user is in the room he/she is mentioned (unless it's public channel)                                // 120
                                                                                                                       //
                                                                                                                       //
				if (room.t !== 'c' && room.usernames.indexOf(user.username) === -1) {                                              // 123
					return;                                                                                                           // 124
				} // Footer in case direct reply is enabled.                                                                       // 125
                                                                                                                       //
                                                                                                                       //
				if (RocketChat.settings.get('Direct_Reply_Enable')) {                                                              // 128
					footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer_Direct_Reply') || '');             // 129
				}                                                                                                                  // 130
                                                                                                                       //
				var emailSubject = void 0;                                                                                         // 132
                                                                                                                       //
				switch (usersToSendEmail[user._id]) {                                                                              // 133
					case 'all':                                                                                                       // 134
						emailSubject = RocketChat.placeholders.replace(RocketChat.settings.get('Offline_Mention_All_Email'), {           // 135
							user: message.u.username,                                                                                       // 136
							room: room.name || room.label                                                                                   // 137
						});                                                                                                              // 135
						break;                                                                                                           // 139
                                                                                                                       //
					case 'direct':                                                                                                    // 140
						emailSubject = RocketChat.placeholders.replace(RocketChat.settings.get('Offline_DM_Email'), {                    // 141
							user: message.u.username,                                                                                       // 142
							room: room.name                                                                                                 // 143
						});                                                                                                              // 141
						break;                                                                                                           // 145
                                                                                                                       //
					case 'mention':                                                                                                   // 146
						emailSubject = RocketChat.placeholders.replace(RocketChat.settings.get('Offline_Mention_Email'), {               // 147
							user: message.u.username,                                                                                       // 148
							room: room.name                                                                                                 // 149
						});                                                                                                              // 147
						break;                                                                                                           // 151
				}                                                                                                                  // 133
                                                                                                                       //
				user.emails.some(function (email) {                                                                                // 153
					if (email.verified) {                                                                                             // 154
						email = {                                                                                                        // 155
							to: email.address,                                                                                              // 156
							from: RocketChat.settings.get('From_Email'),                                                                    // 157
							subject: emailSubject,                                                                                          // 158
							html: header + messageHTML + divisorMessage + (linkByUser[user._id] || defaultLink) + footer                    // 159
						}; // If direct reply enabled, email content with headers                                                        // 155
                                                                                                                       //
						if (RocketChat.settings.get('Direct_Reply_Enable')) {                                                            // 162
							email.headers = {                                                                                               // 163
								// Reply-To header with format "username+messageId@domain"                                                     // 164
								'Reply-To': "" + RocketChat.settings.get('Direct_Reply_Username').split('@')[0].split(RocketChat.settings.get('Direct_Reply_Separator'))[0] + RocketChat.settings.get('Direct_Reply_Separator') + message._id + "@" + RocketChat.settings.get('Direct_Reply_Username').split('@')[1]
							};                                                                                                              // 163
						}                                                                                                                // 167
                                                                                                                       //
						Meteor.defer(function () {                                                                                       // 169
							Email.send(email);                                                                                              // 170
						});                                                                                                              // 171
						return true;                                                                                                     // 173
					}                                                                                                                 // 174
				});                                                                                                                // 175
			});                                                                                                                 // 176
		}                                                                                                                    // 177
	}                                                                                                                     // 178
                                                                                                                       //
	return message;                                                                                                       // 180
}, RocketChat.callbacks.priority.LOW, 'sendEmailOnMessage');                                                           // 182
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendNotificationsOnMessage.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/sendNotificationsOnMessage.js                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _toConsumableArray2 = require("babel-runtime/helpers/toConsumableArray");                                          //
                                                                                                                       //
var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);                                                 //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.watch(require("moment"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
                                                                                                                       //
/**                                                                                                                    // 4
 * Replaces @username with full name                                                                                   //
 *                                                                                                                     //
 * @param {string} message The message to replace                                                                      //
 * @param {object[]} mentions Array of mentions used to make replacements                                              //
 *                                                                                                                     //
 * @returns {string}                                                                                                   //
 */function replaceMentionedUsernamesWithFullNames(message, mentions) {                                                //
	if (!mentions || !mentions.length) {                                                                                  // 13
		return message;                                                                                                      // 14
	}                                                                                                                     // 15
                                                                                                                       //
	mentions.forEach(function (mention) {                                                                                 // 16
		var user = RocketChat.models.Users.findOneById(mention._id);                                                         // 17
                                                                                                                       //
		if (user && user.name) {                                                                                             // 18
			message = message.replace("@" + mention.username, user.name);                                                       // 19
		}                                                                                                                    // 20
	});                                                                                                                   // 21
	return message;                                                                                                       // 22
} /**                                                                                                                  // 23
   * This function returns a string ready to be shown in the notification                                              //
   *                                                                                                                   //
   * @param {object} message the message to be parsed                                                                  //
   */                                                                                                                  //
                                                                                                                       //
function parseMessageText(message, userId) {                                                                           // 30
	var user = RocketChat.models.Users.findOneById(userId);                                                               // 31
	var lng = user && user.language || RocketChat.settings.get('language') || 'en';                                       // 32
                                                                                                                       //
	if (!message.msg && message.attachments && message.attachments[0]) {                                                  // 34
		message.msg = message.attachments[0].image_type ? TAPi18n.__('User_uploaded_image', {                                // 35
			lng: lng                                                                                                            // 35
		}) : TAPi18n.__('User_uploaded_file', {                                                                              // 35
			lng: lng                                                                                                            // 35
		});                                                                                                                  // 35
	}                                                                                                                     // 36
                                                                                                                       //
	message.msg = RocketChat.callbacks.run('beforeNotifyUser', message.msg);                                              // 37
	return message.msg;                                                                                                   // 39
} /**                                                                                                                  // 40
   * Send notification to user                                                                                         //
   *                                                                                                                   //
   * @param {string} userId The user to notify                                                                         //
   * @param {object} user The sender                                                                                   //
   * @param {object} room The room send from                                                                           //
   * @param {number} duration Duration of notification                                                                 //
   */                                                                                                                  //
                                                                                                                       //
function notifyDesktopUser(userId, user, message, room, duration) {                                                    // 49
	var UI_Use_Real_Name = RocketChat.settings.get('UI_Use_Real_Name') === true;                                          // 51
	message.msg = parseMessageText(message, userId);                                                                      // 52
                                                                                                                       //
	if (UI_Use_Real_Name) {                                                                                               // 54
		message.msg = replaceMentionedUsernamesWithFullNames(message.msg, message.mentions);                                 // 55
	}                                                                                                                     // 56
                                                                                                                       //
	var title = UI_Use_Real_Name ? user.name : "@" + user.username;                                                       // 57
                                                                                                                       //
	if (room.t !== 'd' && room.name) {                                                                                    // 58
		title += " @ #" + room.name;                                                                                         // 59
	}                                                                                                                     // 60
                                                                                                                       //
	RocketChat.Notifications.notifyUser(userId, 'notification', {                                                         // 61
		title: title,                                                                                                        // 62
		text: message.msg,                                                                                                   // 63
		duration: duration,                                                                                                  // 64
		payload: {                                                                                                           // 65
			_id: message._id,                                                                                                   // 66
			rid: message.rid,                                                                                                   // 67
			sender: message.u,                                                                                                  // 68
			type: room.t,                                                                                                       // 69
			name: room.name                                                                                                     // 70
		}                                                                                                                    // 65
	});                                                                                                                   // 61
}                                                                                                                      // 73
                                                                                                                       //
function notifyAudioUser(userId, message, room) {                                                                      // 75
	RocketChat.Notifications.notifyUser(userId, 'audioNotification', {                                                    // 76
		payload: {                                                                                                           // 77
			_id: message._id,                                                                                                   // 78
			rid: message.rid,                                                                                                   // 79
			sender: message.u,                                                                                                  // 80
			type: room.t,                                                                                                       // 81
			name: room.name                                                                                                     // 82
		}                                                                                                                    // 77
	});                                                                                                                   // 76
} /**                                                                                                                  // 85
   * Checks if a message contains a user highlight                                                                     //
   *                                                                                                                   //
   * @param {string} message                                                                                           //
   * @param {array|undefined} highlights                                                                               //
   *                                                                                                                   //
   * @returns {boolean}                                                                                                //
   */                                                                                                                  //
                                                                                                                       //
function messageContainsHighlight(message, highlights) {                                                               // 95
	if (!highlights || highlights.length === 0) {                                                                         // 96
		return false;                                                                                                        // 96
	}                                                                                                                     // 96
                                                                                                                       //
	var has = false;                                                                                                      // 98
	highlights.some(function (highlight) {                                                                                // 99
		var regexp = new RegExp(s.escapeRegExp(highlight), 'i');                                                             // 100
                                                                                                                       //
		if (regexp.test(message.msg)) {                                                                                      // 101
			has = true;                                                                                                         // 102
			return true;                                                                                                        // 103
		}                                                                                                                    // 104
	});                                                                                                                   // 105
	return has;                                                                                                           // 107
}                                                                                                                      // 108
                                                                                                                       //
function getBadgeCount(userId) {                                                                                       // 110
	var subscriptions = RocketChat.models.Subscriptions.findUnreadByUserId(userId).fetch();                               // 111
	return subscriptions.reduce(function (unread, sub) {                                                                  // 113
		return sub.unread + unread;                                                                                          // 114
	}, 0);                                                                                                                // 115
}                                                                                                                      // 116
                                                                                                                       //
var sendPushNotifications = function () {                                                                              // 117
	var userIdsToPushNotify = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];                     // 117
	var message = arguments[1];                                                                                           // 117
	var room = arguments[2];                                                                                              // 117
	var push_room = arguments[3];                                                                                         // 117
	var push_username = arguments[4];                                                                                     // 117
	var push_message = arguments[5];                                                                                      // 117
                                                                                                                       //
	if (userIdsToPushNotify.length > 0 && Push.enabled === true) {                                                        // 118
		// send a push notification for each user individually (to get his/her badge count)                                  // 119
		userIdsToPushNotify.forEach(function (userIdToNotify) {                                                              // 120
			RocketChat.PushNotification.send({                                                                                  // 121
				roomId: message.rid,                                                                                               // 122
				roomName: push_room,                                                                                               // 123
				username: push_username,                                                                                           // 124
				message: push_message,                                                                                             // 125
				badge: getBadgeCount(userIdToNotify),                                                                              // 126
				payload: {                                                                                                         // 127
					host: Meteor.absoluteUrl(),                                                                                       // 128
					rid: message.rid,                                                                                                 // 129
					sender: message.u,                                                                                                // 130
					type: room.t,                                                                                                     // 131
					name: room.name                                                                                                   // 132
				},                                                                                                                 // 127
				usersTo: {                                                                                                         // 134
					userId: userIdToNotify                                                                                            // 135
				}                                                                                                                  // 134
			});                                                                                                                 // 121
		});                                                                                                                  // 138
	}                                                                                                                     // 139
};                                                                                                                     // 140
                                                                                                                       //
var callJoin = function (user, rid) {                                                                                  // 141
	return user.active && Meteor.runAsUser(user._id, function () {                                                        // 141
		return Meteor.call('joinRoom', rid);                                                                                 // 141
	});                                                                                                                   // 141
};                                                                                                                     // 141
                                                                                                                       //
RocketChat.callbacks.add('afterSaveMessage', function (message, room, userId) {                                        // 142
	// skips this callback if the message was edited                                                                      // 144
	if (message.editedAt) {                                                                                               // 145
		return message;                                                                                                      // 146
	}                                                                                                                     // 147
                                                                                                                       //
	if (message.ts && Math.abs(moment(message.ts).diff()) > 60000) {                                                      // 149
		return message;                                                                                                      // 150
	}                                                                                                                     // 151
                                                                                                                       //
	var user = RocketChat.models.Users.findOneById(message.u._id); /*                                                     // 153
                                                                Increment unread couter if direct messages             //
                                                                 */                                                    //
	var settings = {                                                                                                      // 158
		alwaysNotifyDesktopUsers: [],                                                                                        // 159
		dontNotifyDesktopUsers: [],                                                                                          // 160
		alwaysNotifyMobileUsers: [],                                                                                         // 161
		dontNotifyMobileUsers: [],                                                                                           // 162
		desktopNotificationDurations: {},                                                                                    // 163
		alwaysNotifyAudioUsers: [],                                                                                          // 164
		dontNotifyAudioUsers: [],                                                                                            // 165
		audioNotificationValues: {}                                                                                          // 166
	}; /**                                                                                                                // 158
     * Checks if a given user can be notified                                                                          //
     *                                                                                                                 //
     * @param {string} id                                                                                              //
     * @param {string} type - mobile|desktop                                                                           //
     *                                                                                                                 //
     * @returns {boolean}                                                                                              //
        */                                                                                                             //
                                                                                                                       //
	function canBeNotified(id, type) {                                                                                    // 177
		var types = {                                                                                                        // 178
			mobile: ['dontNotifyDesktopUsers', 'alwaysNotifyDesktopUsers'],                                                     // 179
			desktop: ['dontNotifyMobileUsers', 'alwaysNotifyMobileUsers'],                                                      // 180
			audio: ['dontNotifyAudioUsers', 'alwaysNotifyAudioUsers']                                                           // 181
		};                                                                                                                   // 178
		return settings[types[type][0]].indexOf(id) === -1 || settings[types[type][1]].indexOf(id) !== -1;                   // 184
	} // Don't fetch all users if room exceeds max members                                                                // 185
                                                                                                                       //
                                                                                                                       //
	var maxMembersForNotification = RocketChat.settings.get('Notifications_Max_Room_Members');                            // 188
	var disableAllMessageNotifications = room.usernames.length > maxMembersForNotification && maxMembersForNotification !== 0;
	var subscriptions = RocketChat.models.Subscriptions.findNotificationPreferencesByRoom(room._id, disableAllMessageNotifications);
	var userIds = [];                                                                                                     // 191
	subscriptions.forEach(function (s) {                                                                                  // 192
		userIds.push(s.u._id);                                                                                               // 193
	});                                                                                                                   // 194
	var userSettings = {};                                                                                                // 195
	RocketChat.models.Users.findUsersByIds(userIds, {                                                                     // 196
		fields: {                                                                                                            // 196
			'settings.preferences.audioNotifications': 1,                                                                       // 196
			'settings.preferences.desktopNotifications': 1,                                                                     // 196
			'settings.preferences.mobileNotifications': 1                                                                       // 196
		}                                                                                                                    // 196
	}).forEach(function (user) {                                                                                          // 196
		userSettings[user._id] = user.settings;                                                                              // 197
	});                                                                                                                   // 198
	subscriptions.forEach(function (subscription) {                                                                       // 200
		if (subscription.disableNotifications) {                                                                             // 201
			settings.dontNotifyDesktopUsers.push(subscription.u._id);                                                           // 202
			settings.dontNotifyMobileUsers.push(subscription.u._id);                                                            // 203
			settings.dontNotifyAudioUsers.push(subscription.u._id);                                                             // 204
			return;                                                                                                             // 205
		}                                                                                                                    // 206
                                                                                                                       //
		var preferences = userSettings[subscription.u._id] ? userSettings[subscription.u._id].preferences || {} : {};        // 207
		var userAudioNotificationPreference = preferences.audioNotifications !== 'default' ? preferences.audioNotifications : undefined;
		var userDesktopNotificationPreference = preferences.desktopNotifications !== 'default' ? preferences.desktopNotifications : undefined;
		var userMobileNotificationPreference = preferences.mobileNotifications !== 'default' ? preferences.mobileNotifications : undefined; // Set defaults if they don't exist
                                                                                                                       //
		var _subscription$audioNo = subscription.audioNotifications,                                                         // 200
		    audioNotifications = _subscription$audioNo === undefined ? userAudioNotificationPreference || RocketChat.settings.get('Audio_Notifications_Default_Alert') : _subscription$audioNo,
		    _subscription$desktop = subscription.desktopNotifications,                                                       // 200
		    desktopNotifications = _subscription$desktop === undefined ? userDesktopNotificationPreference || RocketChat.settings.get('Desktop_Notifications_Default_Alert') : _subscription$desktop,
		    _subscription$mobileP = subscription.mobilePushNotifications,                                                    // 200
		    mobilePushNotifications = _subscription$mobileP === undefined ? userMobileNotificationPreference || RocketChat.settings.get('Mobile_Notifications_Default_Alert') : _subscription$mobileP;
                                                                                                                       //
		if (audioNotifications === 'all' && !disableAllMessageNotifications) {                                               // 217
			settings.alwaysNotifyAudioUsers.push(subscription.u._id);                                                           // 218
		}                                                                                                                    // 219
                                                                                                                       //
		if (desktopNotifications === 'all' && !disableAllMessageNotifications) {                                             // 220
			settings.alwaysNotifyDesktopUsers.push(subscription.u._id);                                                         // 221
		} else if (desktopNotifications === 'nothing') {                                                                     // 222
			settings.dontNotifyDesktopUsers.push(subscription.u._id);                                                           // 223
		}                                                                                                                    // 224
                                                                                                                       //
		if (mobilePushNotifications === 'all' && !disableAllMessageNotifications) {                                          // 225
			settings.alwaysNotifyMobileUsers.push(subscription.u._id);                                                          // 226
		} else if (mobilePushNotifications === 'nothing') {                                                                  // 227
			settings.dontNotifyMobileUsers.push(subscription.u._id);                                                            // 228
		}                                                                                                                    // 229
                                                                                                                       //
		settings.audioNotificationValues[subscription.u._id] = subscription.audioNotificationValue;                          // 231
		settings.desktopNotificationDurations[subscription.u._id] = subscription.desktopNotificationDuration;                // 232
	});                                                                                                                   // 233
	var userIdsForAudio = [];                                                                                             // 234
	var userIdsToNotify = [];                                                                                             // 235
	var userIdsToPushNotify = [];                                                                                         // 236
	var mentions = [];                                                                                                    // 237
	var usersWithHighlights = RocketChat.models.Users.findUsersByUsernamesWithHighlights(room.usernames, {                // 239
		fields: {                                                                                                            // 239
			'_id': 1,                                                                                                           // 239
			'settings.preferences.highlights': 1                                                                                // 239
		}                                                                                                                    // 239
	}).fetch().filter(function (user) {                                                                                   // 239
		return messageContainsHighlight(message, user.settings.preferences.highlights);                                      // 240
	});                                                                                                                   // 240
	var push_message = ' '; //Set variables depending on Push Notification settings                                       // 242
                                                                                                                       //
	if (RocketChat.settings.get('Push_show_message')) {                                                                   // 244
		push_message = parseMessageText(message, userId);                                                                    // 245
	}                                                                                                                     // 246
                                                                                                                       //
	var push_username = '';                                                                                               // 248
	var push_room = '';                                                                                                   // 249
                                                                                                                       //
	if (RocketChat.settings.get('Push_show_username_room')) {                                                             // 250
		push_username = user.username;                                                                                       // 251
		push_room = "#" + room.name;                                                                                         // 252
	}                                                                                                                     // 253
                                                                                                                       //
	if (room.t == null || room.t === 'd') {                                                                               // 255
		var userOfMentionId = message.rid.replace(message.u._id, '');                                                        // 256
		var userOfMention = RocketChat.models.Users.findOne({                                                                // 257
			_id: userOfMentionId                                                                                                // 258
		}, {                                                                                                                 // 257
			fields: {                                                                                                           // 260
				username: 1,                                                                                                       // 261
				statusConnection: 1                                                                                                // 262
			}                                                                                                                   // 260
		}); // Always notify Sandstorm                                                                                       // 259
                                                                                                                       //
		if (userOfMention != null) {                                                                                         // 267
			RocketChat.Sandstorm.notify(message, [userOfMention._id], "@" + user.username + ": " + message.msg, 'privateMessage');
		}                                                                                                                    // 271
                                                                                                                       //
		if (userOfMention != null && canBeNotified(userOfMentionId, 'mobile')) {                                             // 272
			var duration = settings.desktopNotificationDurations[userOfMention._id];                                            // 273
			notifyDesktopUser(userOfMention._id, user, message, room, duration);                                                // 274
		}                                                                                                                    // 275
                                                                                                                       //
		if (userOfMention != null && canBeNotified(userOfMentionId, 'desktop')) {                                            // 277
			if (Push.enabled === true && userOfMention.statusConnection !== 'online') {                                         // 278
				RocketChat.PushNotification.send({                                                                                 // 279
					roomId: message.rid,                                                                                              // 280
					username: push_username,                                                                                          // 281
					message: push_message,                                                                                            // 282
					badge: getBadgeCount(userOfMention._id),                                                                          // 283
					payload: {                                                                                                        // 284
						host: Meteor.absoluteUrl(),                                                                                      // 285
						rid: message.rid,                                                                                                // 286
						sender: message.u,                                                                                               // 287
						type: room.t,                                                                                                    // 288
						name: room.name                                                                                                  // 289
					},                                                                                                                // 284
					usersTo: {                                                                                                        // 291
						userId: userOfMention._id                                                                                        // 292
					}                                                                                                                 // 291
				});                                                                                                                // 279
				return message;                                                                                                    // 295
			}                                                                                                                   // 296
		}                                                                                                                    // 297
	} else {                                                                                                              // 299
		var mentionIds = (message.mentions || []).map(function (_ref) {                                                      // 300
			var _id = _ref._id;                                                                                                 // 300
			return _id;                                                                                                         // 300
		});                                                                                                                  // 300
		var toAll = mentionIds.includes('all');                                                                              // 301
		var toHere = mentionIds.includes('here');                                                                            // 302
                                                                                                                       //
		if (mentionIds.length + settings.alwaysNotifyDesktopUsers.length > 0) {                                              // 303
			var desktopMentionIds = _.union(mentionIds, settings.alwaysNotifyDesktopUsers);                                     // 304
                                                                                                                       //
			desktopMentionIds = _.difference(desktopMentionIds, settings.dontNotifyDesktopUsers);                               // 305
			var usersOfDesktopMentions = RocketChat.models.Users.find({                                                         // 307
				_id: {                                                                                                             // 308
					$in: desktopMentionIds                                                                                            // 309
				}                                                                                                                  // 308
			}, {                                                                                                                // 307
				fields: {                                                                                                          // 312
					_id: 1,                                                                                                           // 313
					username: 1,                                                                                                      // 314
					active: 1                                                                                                         // 315
				}                                                                                                                  // 312
			}).fetch();                                                                                                         // 311
			mentions.push.apply(mentions, (0, _toConsumableArray3.default)(usersOfDesktopMentions));                            // 318
                                                                                                                       //
			if (room.t !== 'c') {                                                                                               // 319
				usersOfDesktopMentions = _.reject(usersOfDesktopMentions, function (usersOfMentionItem) {                          // 320
					return room.usernames.indexOf(usersOfMentionItem.username) === -1;                                                // 321
				});                                                                                                                // 322
			}                                                                                                                   // 323
                                                                                                                       //
			userIdsToNotify = _.pluck(usersOfDesktopMentions, '_id');                                                           // 325
		}                                                                                                                    // 326
                                                                                                                       //
		if (mentionIds.length + settings.alwaysNotifyMobileUsers.length > 0) {                                               // 328
			var mobileMentionIds = _.union(mentionIds, settings.alwaysNotifyMobileUsers);                                       // 329
                                                                                                                       //
			mobileMentionIds = _.difference(mobileMentionIds, settings.dontNotifyMobileUsers);                                  // 330
			var usersOfMobileMentions = RocketChat.models.Users.find({                                                          // 332
				_id: {                                                                                                             // 333
					$in: mobileMentionIds                                                                                             // 334
				},                                                                                                                 // 333
				statusConnection: {                                                                                                // 336
					$ne: 'online'                                                                                                     // 337
				}                                                                                                                  // 336
			}, {                                                                                                                // 332
				fields: {                                                                                                          // 340
					_id: 1,                                                                                                           // 341
					username: 1,                                                                                                      // 342
					statusConnection: 1,                                                                                              // 343
					active: 1                                                                                                         // 344
				}                                                                                                                  // 340
			}).fetch();                                                                                                         // 339
			mentions.push.apply(mentions, (0, _toConsumableArray3.default)(usersOfMobileMentions));                             // 347
                                                                                                                       //
			if (room.t !== 'c') {                                                                                               // 348
				usersOfMobileMentions = _.reject(usersOfMobileMentions, function (usersOfMentionItem) {                            // 349
					return !room.usernames.includes(usersOfMentionItem.username);                                                     // 349
				});                                                                                                                // 349
			}                                                                                                                   // 350
                                                                                                                       //
			userIdsToPushNotify = _.pluck(usersOfMobileMentions, '_id');                                                        // 352
		}                                                                                                                    // 353
                                                                                                                       //
		if (mentionIds.length + settings.alwaysNotifyAudioUsers.length > 0) {                                                // 355
			var audioMentionIds = _.union(mentionIds, settings.alwaysNotifyAudioUsers);                                         // 356
                                                                                                                       //
			audioMentionIds = _.difference(audioMentionIds, userIdsToNotify);                                                   // 357
			var usersOfAudioMentions = RocketChat.models.Users.find({                                                           // 359
				_id: {                                                                                                             // 359
					$in: audioMentionIds                                                                                              // 359
				},                                                                                                                 // 359
				statusConnection: {                                                                                                // 359
					$ne: 'offline'                                                                                                    // 360
				}                                                                                                                  // 359
			}, {                                                                                                                // 359
				fields: {                                                                                                          // 362
					_id: 1,                                                                                                           // 363
					username: 1,                                                                                                      // 364
					active: 1                                                                                                         // 365
				}                                                                                                                  // 362
			}).fetch();                                                                                                         // 361
			mentions.push.apply(mentions, (0, _toConsumableArray3.default)(usersOfAudioMentions));                              // 368
                                                                                                                       //
			if (room.t !== 'c') {                                                                                               // 369
				usersOfAudioMentions = _.reject(usersOfAudioMentions, function (usersOfMentionItem) {                              // 370
					return room.usernames.indexOf(usersOfMentionItem.username) === -1;                                                // 371
				});                                                                                                                // 372
			}                                                                                                                   // 373
                                                                                                                       //
			userIdsForAudio = _.pluck(usersOfAudioMentions, '_id');                                                             // 375
		}                                                                                                                    // 376
                                                                                                                       //
		if (room.t === 'c') {                                                                                                // 378
			mentions.filter(function (user) {                                                                                   // 379
				return !room.usernames.includes(user.username);                                                                    // 379
			}).forEach(function (user) {                                                                                        // 379
				return callJoin(user, room._id);                                                                                   // 380
			});                                                                                                                 // 380
		}                                                                                                                    // 381
                                                                                                                       //
		if ([toAll, toHere].some(function (e) {                                                                              // 384
			return e;                                                                                                           // 384
		}) && room.usernames && room.usernames.length > 0) {                                                                 // 384
			RocketChat.models.Users.find({                                                                                      // 385
				username: {                                                                                                        // 386
					$in: room.usernames                                                                                               // 386
				},                                                                                                                 // 386
				_id: {                                                                                                             // 387
					$ne: user._id                                                                                                     // 387
				}                                                                                                                  // 387
			}, {                                                                                                                // 385
				fields: {                                                                                                          // 389
					_id: 1,                                                                                                           // 390
					username: 1,                                                                                                      // 391
					status: 1,                                                                                                        // 392
					statusConnection: 1                                                                                               // 393
				}                                                                                                                  // 389
			}).forEach(function (user) {                                                                                        // 388
				if (['online', 'away', 'busy'].includes(user.status) && !(settings.dontNotifyDesktopUsers || []).includes(user._id)) {
					userIdsToNotify.push(user._id);                                                                                   // 397
					userIdsForAudio.push(user._id);                                                                                   // 398
				}                                                                                                                  // 399
                                                                                                                       //
				if (toAll && user.statusConnection !== 'online' && !(settings.dontNotifyMobileUsers || []).includes(user._id)) {   // 400
					return userIdsToPushNotify.push(user._id);                                                                        // 401
				}                                                                                                                  // 402
                                                                                                                       //
				if (toAll && user.statusConnection !== 'online') {                                                                 // 403
					userIdsForAudio.push(user._id);                                                                                   // 404
				}                                                                                                                  // 405
			});                                                                                                                 // 406
		}                                                                                                                    // 407
                                                                                                                       //
		if (usersWithHighlights.length > 0) {                                                                                // 409
			var highlightsIds = _.pluck(usersWithHighlights, '_id');                                                            // 410
                                                                                                                       //
			userIdsForAudio = userIdsForAudio.concat(highlightsIds);                                                            // 411
			userIdsToNotify = userIdsToNotify.concat(highlightsIds);                                                            // 412
			userIdsToPushNotify = userIdsToPushNotify.concat(highlightsIds);                                                    // 413
		}                                                                                                                    // 414
                                                                                                                       //
		userIdsToNotify = _.without(_.compact(_.unique(userIdsToNotify)), message.u._id);                                    // 416
		userIdsToPushNotify = _.without(_.compact(_.unique(userIdsToPushNotify)), message.u._id);                            // 417
		userIdsForAudio = _.without(_.compact(_.unique(userIdsForAudio)), message.u._id);                                    // 418
                                                                                                                       //
		for (var _iterator = userIdsToNotify, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
			var _ref2;                                                                                                          // 420
                                                                                                                       //
			if (_isArray) {                                                                                                     // 420
				if (_i >= _iterator.length) break;                                                                                 // 420
				_ref2 = _iterator[_i++];                                                                                           // 420
			} else {                                                                                                            // 420
				_i = _iterator.next();                                                                                             // 420
				if (_i.done) break;                                                                                                // 420
				_ref2 = _i.value;                                                                                                  // 420
			}                                                                                                                   // 420
                                                                                                                       //
			var usersOfMentionId = _ref2;                                                                                       // 420
			var _duration = settings.desktopNotificationDurations[usersOfMentionId];                                            // 421
			notifyDesktopUser(usersOfMentionId, user, message, room, _duration);                                                // 422
		}                                                                                                                    // 423
                                                                                                                       //
		for (var _iterator2 = userIdsForAudio, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
			var _ref3;                                                                                                          // 424
                                                                                                                       //
			if (_isArray2) {                                                                                                    // 424
				if (_i2 >= _iterator2.length) break;                                                                               // 424
				_ref3 = _iterator2[_i2++];                                                                                         // 424
			} else {                                                                                                            // 424
				_i2 = _iterator2.next();                                                                                           // 424
				if (_i2.done) break;                                                                                               // 424
				_ref3 = _i2.value;                                                                                                 // 424
			}                                                                                                                   // 424
                                                                                                                       //
			var _usersOfMentionId = _ref3;                                                                                      // 424
			notifyAudioUser(_usersOfMentionId, message, room);                                                                  // 425
		}                                                                                                                    // 426
                                                                                                                       //
		sendPushNotifications(userIdsToPushNotify, message, room, push_room, push_username, push_message);                   // 427
                                                                                                                       //
		var allUserIdsToNotify = _.unique(userIdsToNotify.concat(userIdsToPushNotify));                                      // 429
                                                                                                                       //
		RocketChat.Sandstorm.notify(message, allUserIdsToNotify, "@" + user.username + ": " + message.msg, room.t === 'p' ? 'privateMessage' : 'message');
	}                                                                                                                     // 432
                                                                                                                       //
	return message;                                                                                                       // 434
}, RocketChat.callbacks.priority.LOW, 'sendNotificationOnMessage');                                                    // 436
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"validateEmailDomain.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/lib/validateEmailDomain.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var dns = Npm.require('dns');                                                                                          // 1
                                                                                                                       //
var emailDomainBlackList = [];                                                                                         // 3
var emailDomainWhiteList = [];                                                                                         // 4
var useDefaultBlackList = false;                                                                                       // 5
var useDNSDomainCheck = false;                                                                                         // 6
RocketChat.settings.get('Accounts_BlockedDomainsList', function (key, value) {                                         // 8
	emailDomainBlackList = _.map(value.split(','), function (domain) {                                                    // 9
		return domain.trim();                                                                                                // 9
	});                                                                                                                   // 9
});                                                                                                                    // 10
RocketChat.settings.get('Accounts_AllowedDomainsList', function (key, value) {                                         // 11
	emailDomainWhiteList = _.map(value.split(','), function (domain) {                                                    // 12
		return domain.trim();                                                                                                // 12
	});                                                                                                                   // 12
});                                                                                                                    // 13
RocketChat.settings.get('Accounts_UseDefaultBlockedDomainsList', function (key, value) {                               // 14
	useDefaultBlackList = value;                                                                                          // 15
});                                                                                                                    // 16
RocketChat.settings.get('Accounts_UseDNSDomainCheck', function (key, value) {                                          // 17
	useDNSDomainCheck = value;                                                                                            // 18
});                                                                                                                    // 19
                                                                                                                       //
RocketChat.validateEmailDomain = function (email) {                                                                    // 21
	var emailValidation = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                                                                                                                       //
	if (!emailValidation.test(email)) {                                                                                   // 23
		throw new Meteor.Error('error-invalid-email', "Invalid email " + email, {                                            // 24
			"function": 'RocketChat.validateEmailDomain',                                                                       // 24
			email: email                                                                                                        // 24
		});                                                                                                                  // 24
	}                                                                                                                     // 25
                                                                                                                       //
	var emailDomain = email.substr(email.lastIndexOf('@') + 1); // if not in whitelist                                    // 27
                                                                                                                       //
	if (emailDomainWhiteList.indexOf(emailDomain) === -1) {                                                               // 30
		if (emailDomainBlackList.indexOf(emailDomain) !== -1 || useDefaultBlackList && RocketChat.emailDomainDefaultBlackList.indexOf(emailDomain) !== -1) {
			throw new Meteor.Error('error-email-domain-blacklisted', 'The email domain is blacklisted', {                       // 32
				"function": 'RocketChat.validateEmailDomain'                                                                       // 32
			});                                                                                                                 // 32
		}                                                                                                                    // 33
	}                                                                                                                     // 34
                                                                                                                       //
	if (useDNSDomainCheck) {                                                                                              // 36
		try {                                                                                                                // 37
			Meteor.wrapAsync(dns.resolveMx)(emailDomain);                                                                       // 38
		} catch (e) {                                                                                                        // 39
			throw new Meteor.Error('error-invalid-domain', 'Invalid domain', {                                                  // 40
				"function": 'RocketChat.validateEmailDomain'                                                                       // 40
			});                                                                                                                 // 40
		}                                                                                                                    // 41
	}                                                                                                                     // 42
};                                                                                                                     // 43
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"functions":{"isDocker.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/isDocker.js                                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var fs = void 0;                                                                                                       // 1
module.watch(require("fs"), {                                                                                          // 1
	"default": function (v) {                                                                                             // 1
		fs = v;                                                                                                              // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
                                                                                                                       //
function hasDockerEnv() {                                                                                              // 3
	try {                                                                                                                 // 4
		fs.statSync('/.dockerenv');                                                                                          // 5
		return true;                                                                                                         // 6
	} catch (err) {                                                                                                       // 7
		return false;                                                                                                        // 8
	}                                                                                                                     // 9
}                                                                                                                      // 10
                                                                                                                       //
function hasDockerCGroup() {                                                                                           // 12
	try {                                                                                                                 // 13
		return fs.readFileSync('/proc/self/cgroup', 'utf8').indexOf('docker') !== -1;                                        // 14
	} catch (err) {                                                                                                       // 15
		return false;                                                                                                        // 16
	}                                                                                                                     // 17
}                                                                                                                      // 18
                                                                                                                       //
function check() {                                                                                                     // 20
	return hasDockerEnv() || hasDockerCGroup();                                                                           // 21
}                                                                                                                      // 22
                                                                                                                       //
var isDocker = void 0;                                                                                                 // 24
                                                                                                                       //
RocketChat.isDocker = function () {                                                                                    // 25
	if (isDocker === undefined) {                                                                                         // 26
		isDocker = check();                                                                                                  // 27
	}                                                                                                                     // 28
                                                                                                                       //
	return isDocker;                                                                                                      // 30
};                                                                                                                     // 31
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"addUserToDefaultChannels.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/addUserToDefaultChannels.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.addUserToDefaultChannels = function (user, silenced) {                                                      // 1
	RocketChat.callbacks.run('beforeJoinDefaultChannels', user);                                                          // 2
	var defaultRooms = RocketChat.models.Rooms.findByDefaultAndTypes(true, ['c', 'p'], {                                  // 3
		fields: {                                                                                                            // 3
			usernames: 0                                                                                                        // 3
		}                                                                                                                    // 3
	}).fetch();                                                                                                           // 3
	defaultRooms.forEach(function (room) {                                                                                // 4
		// put user in default rooms                                                                                         // 6
		var muted = room.ro && !RocketChat.authz.hasPermission(user._id, 'post-readonly');                                   // 7
		RocketChat.models.Rooms.addUsernameById(room._id, user.username, muted);                                             // 8
                                                                                                                       //
		if (!RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, user._id)) {                                 // 10
			// Add a subscription to this user                                                                                  // 12
			RocketChat.models.Subscriptions.createWithRoomAndUser(room, user, {                                                 // 13
				ts: new Date(),                                                                                                    // 14
				open: true,                                                                                                        // 15
				alert: true,                                                                                                       // 16
				unread: 1,                                                                                                         // 17
				userMentions: 1,                                                                                                   // 18
				groupMentions: 0                                                                                                   // 19
			}); // Insert user joined message                                                                                   // 13
                                                                                                                       //
			if (!silenced) {                                                                                                    // 23
				RocketChat.models.Messages.createUserJoinWithRoomIdAndUser(room._id, user);                                        // 24
			}                                                                                                                   // 25
		}                                                                                                                    // 26
	});                                                                                                                   // 27
};                                                                                                                     // 28
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"addUserToRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/addUserToRoom.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.addUserToRoom = function (rid, user, inviter, silenced) {                                                   // 1
	var now = new Date();                                                                                                 // 2
	var room = RocketChat.models.Rooms.findOneById(rid); // Check if user is already in room                              // 3
                                                                                                                       //
	var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, user._id);                           // 6
                                                                                                                       //
	if (subscription) {                                                                                                   // 7
		return;                                                                                                              // 8
	}                                                                                                                     // 9
                                                                                                                       //
	if (room.t === 'c' || room.t === 'p') {                                                                               // 11
		RocketChat.callbacks.run('beforeJoinRoom', user, room);                                                              // 12
	}                                                                                                                     // 13
                                                                                                                       //
	var muted = room.ro && !RocketChat.authz.hasPermission(user._id, 'post-readonly');                                    // 15
	RocketChat.models.Rooms.addUsernameById(rid, user.username, muted);                                                   // 16
	RocketChat.models.Subscriptions.createWithRoomAndUser(room, user, {                                                   // 17
		ts: now,                                                                                                             // 18
		open: true,                                                                                                          // 19
		alert: true,                                                                                                         // 20
		unread: 1,                                                                                                           // 21
		userMentions: 1,                                                                                                     // 22
		groupMentions: 0                                                                                                     // 23
	});                                                                                                                   // 17
                                                                                                                       //
	if (!silenced) {                                                                                                      // 26
		if (inviter) {                                                                                                       // 27
			RocketChat.models.Messages.createUserAddedWithRoomIdAndUser(rid, user, {                                            // 28
				ts: now,                                                                                                           // 29
				u: {                                                                                                               // 30
					_id: inviter._id,                                                                                                 // 31
					username: inviter.username                                                                                        // 32
				}                                                                                                                  // 30
			});                                                                                                                 // 28
		} else {                                                                                                             // 35
			RocketChat.models.Messages.createUserJoinWithRoomIdAndUser(rid, user, {                                             // 36
				ts: now                                                                                                            // 36
			});                                                                                                                 // 36
		}                                                                                                                    // 37
	}                                                                                                                     // 38
                                                                                                                       //
	if (room.t === 'c' || room.t === 'p') {                                                                               // 40
		Meteor.defer(function () {                                                                                           // 41
			RocketChat.callbacks.run('afterJoinRoom', user, room);                                                              // 42
		});                                                                                                                  // 43
	}                                                                                                                     // 44
                                                                                                                       //
	return true;                                                                                                          // 46
};                                                                                                                     // 47
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"archiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/archiveRoom.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.archiveRoom = function (rid) {                                                                              // 1
	RocketChat.models.Rooms.archiveById(rid);                                                                             // 2
	RocketChat.models.Subscriptions.archiveByRoomId(rid);                                                                 // 3
	RocketChat.callbacks.run('afterRoomArchived', RocketChat.models.Rooms.findOneById(rid), Meteor.user());               // 5
};                                                                                                                     // 6
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"checkUsernameAvailability.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/checkUsernameAvailability.js                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.checkUsernameAvailability = function (username) {                                                           // 1
	return RocketChat.settings.get('Accounts_BlockedUsernameList', function (key, value) {                                // 2
		var usernameBlackList = _.map(value.split(','), function (username) {                                                // 3
			return username.trim();                                                                                             // 4
		});                                                                                                                  // 5
                                                                                                                       //
		if (usernameBlackList.length !== 0) {                                                                                // 6
			if (usernameBlackList.every(function (restrictedUsername) {                                                         // 7
				var regex = new RegExp("^" + s.escapeRegExp(restrictedUsername) + "$", 'i');                                       // 8
				return !regex.test(s.trim(s.escapeRegExp(username)));                                                              // 9
			})) {                                                                                                               // 10
				return !Meteor.users.findOne({                                                                                     // 11
					username: {                                                                                                       // 12
						$regex: new RegExp("^" + s.trim(s.escapeRegExp(username)) + "$", 'i')                                            // 13
					}                                                                                                                 // 12
				});                                                                                                                // 11
			}                                                                                                                   // 16
                                                                                                                       //
			return false;                                                                                                       // 17
		}                                                                                                                    // 18
	});                                                                                                                   // 19
};                                                                                                                     // 20
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"checkEmailAvailability.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/checkEmailAvailability.js                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.checkEmailAvailability = function (email) {                                                                 // 1
	return !Meteor.users.findOne({                                                                                        // 2
		'emails.address': {                                                                                                  // 2
			$regex: new RegExp("^" + s.trim(s.escapeRegExp(email)) + "$", 'i')                                                  // 2
		}                                                                                                                    // 2
	});                                                                                                                   // 2
};                                                                                                                     // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"createRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/createRoom.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals RocketChat */RocketChat.createRoom = function (type, name, owner, members, readOnly) {                      // 1
	var extraData = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : {};                               // 2
	name = s.trim(name);                                                                                                  // 3
	owner = s.trim(owner);                                                                                                // 4
	members = [].concat(members);                                                                                         // 5
                                                                                                                       //
	if (!name) {                                                                                                          // 7
		throw new Meteor.Error('error-invalid-name', 'Invalid name', {                                                       // 8
			"function": 'RocketChat.createRoom'                                                                                 // 8
		});                                                                                                                  // 8
	}                                                                                                                     // 9
                                                                                                                       //
	owner = RocketChat.models.Users.findOneByUsername(owner, {                                                            // 11
		fields: {                                                                                                            // 11
			username: 1                                                                                                         // 11
		}                                                                                                                    // 11
	});                                                                                                                   // 11
                                                                                                                       //
	if (!owner) {                                                                                                         // 12
		throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                       // 13
			"function": 'RocketChat.createRoom'                                                                                 // 13
		});                                                                                                                  // 13
	}                                                                                                                     // 14
                                                                                                                       //
	var slugifiedRoomName = RocketChat.getValidRoomName(name);                                                            // 16
	var now = new Date();                                                                                                 // 18
                                                                                                                       //
	if (!_.contains(members, owner.username)) {                                                                           // 19
		members.push(owner.username);                                                                                        // 20
	}                                                                                                                     // 21
                                                                                                                       //
	if (type === 'c') {                                                                                                   // 23
		RocketChat.callbacks.run('beforeCreateChannel', owner, {                                                             // 24
			t: 'c',                                                                                                             // 25
			name: slugifiedRoomName,                                                                                            // 26
			fname: name,                                                                                                        // 27
			ts: now,                                                                                                            // 28
			ro: readOnly === true,                                                                                              // 29
			sysMes: readOnly !== true,                                                                                          // 30
			usernames: members,                                                                                                 // 31
			u: {                                                                                                                // 32
				_id: owner._id,                                                                                                    // 33
				username: owner.username                                                                                           // 34
			}                                                                                                                   // 32
		});                                                                                                                  // 24
	}                                                                                                                     // 37
                                                                                                                       //
	extraData = Object.assign({}, extraData, {                                                                            // 39
		ts: now,                                                                                                             // 40
		ro: readOnly === true,                                                                                               // 41
		sysMes: readOnly !== true                                                                                            // 42
	});                                                                                                                   // 39
	var room = RocketChat.models.Rooms.createWithTypeNameUserAndUsernames(type, slugifiedRoomName, name, owner, members, extraData);
                                                                                                                       //
	for (var _iterator = members, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
		var _ref;                                                                                                            // 47
                                                                                                                       //
		if (_isArray) {                                                                                                      // 47
			if (_i >= _iterator.length) break;                                                                                  // 47
			_ref = _iterator[_i++];                                                                                             // 47
		} else {                                                                                                             // 47
			_i = _iterator.next();                                                                                              // 47
			if (_i.done) break;                                                                                                 // 47
			_ref = _i.value;                                                                                                    // 47
		}                                                                                                                    // 47
                                                                                                                       //
		var username = _ref;                                                                                                 // 47
		var member = RocketChat.models.Users.findOneByUsername(username, {                                                   // 48
			fields: {                                                                                                           // 48
				username: 1                                                                                                        // 48
			}                                                                                                                   // 48
		});                                                                                                                  // 48
                                                                                                                       //
		if (!member) {                                                                                                       // 49
			continue;                                                                                                           // 50
		} // make all room members muted by default, unless they have the post-readonly permission                           // 51
                                                                                                                       //
                                                                                                                       //
		if (readOnly === true && !RocketChat.authz.hasPermission(member._id, 'post-readonly')) {                             // 54
			RocketChat.models.Rooms.muteUsernameByRoomId(room._id, username);                                                   // 55
		}                                                                                                                    // 56
                                                                                                                       //
		var extra = {                                                                                                        // 58
			open: true                                                                                                          // 58
		};                                                                                                                   // 58
                                                                                                                       //
		if (username === owner.username) {                                                                                   // 60
			extra.ls = now;                                                                                                     // 61
		}                                                                                                                    // 62
                                                                                                                       //
		RocketChat.models.Subscriptions.createWithRoomAndUser(room, member, extra);                                          // 64
	}                                                                                                                     // 65
                                                                                                                       //
	RocketChat.authz.addUserRoles(owner._id, ['owner'], room._id);                                                        // 67
                                                                                                                       //
	if (type === 'c') {                                                                                                   // 69
		Meteor.defer(function () {                                                                                           // 70
			RocketChat.callbacks.run('afterCreateChannel', owner, room);                                                        // 71
		});                                                                                                                  // 72
	} else if (type === 'p') {                                                                                            // 73
		Meteor.defer(function () {                                                                                           // 74
			RocketChat.callbacks.run('afterCreatePrivateGroup', owner, room);                                                   // 75
		});                                                                                                                  // 76
	}                                                                                                                     // 77
                                                                                                                       //
	return {                                                                                                              // 79
		rid: room._id,                                                                                                       // 80
		name: slugifiedRoomName                                                                                              // 81
	};                                                                                                                    // 79
};                                                                                                                     // 83
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"deleteMessage.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/deleteMessage.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals FileUpload */RocketChat.deleteMessage = function (message, user) {                                          // 1
	var keepHistory = RocketChat.settings.get('Message_KeepHistory');                                                     // 3
	var showDeletedStatus = RocketChat.settings.get('Message_ShowDeletedStatus');                                         // 4
	var deletedMsg = void 0;                                                                                              // 5
                                                                                                                       //
	if (keepHistory) {                                                                                                    // 7
		if (showDeletedStatus) {                                                                                             // 8
			RocketChat.models.Messages.cloneAndSaveAsHistoryById(message._id);                                                  // 9
		} else {                                                                                                             // 10
			RocketChat.models.Messages.setHiddenById(message._id, true);                                                        // 11
		}                                                                                                                    // 12
                                                                                                                       //
		if (message.file && message.file._id) {                                                                              // 14
			RocketChat.models.Uploads.update(message.file._id, {                                                                // 15
				$set: {                                                                                                            // 15
					_hidden: true                                                                                                     // 15
				}                                                                                                                  // 15
			});                                                                                                                 // 15
		}                                                                                                                    // 16
	} else {                                                                                                              // 17
		if (!showDeletedStatus) {                                                                                            // 18
			deletedMsg = RocketChat.models.Messages.findOneById(message._id);                                                   // 19
			RocketChat.models.Messages.removeById(message._id);                                                                 // 20
		}                                                                                                                    // 21
                                                                                                                       //
		if (message.file && message.file._id) {                                                                              // 23
			FileUpload.getStore('Uploads').deleteById(message.file._id);                                                        // 24
		}                                                                                                                    // 25
                                                                                                                       //
		Meteor.defer(function () {                                                                                           // 27
			RocketChat.callbacks.run('afterDeleteMessage', deletedMsg);                                                         // 28
		});                                                                                                                  // 29
	}                                                                                                                     // 30
                                                                                                                       //
	if (showDeletedStatus) {                                                                                              // 32
		RocketChat.models.Messages.setAsDeletedByIdAndUser(message._id, user);                                               // 33
	} else {                                                                                                              // 34
		RocketChat.Notifications.notifyRoom(message.rid, 'deleteMessage', {                                                  // 35
			_id: message._id                                                                                                    // 35
		});                                                                                                                  // 35
	}                                                                                                                     // 36
};                                                                                                                     // 37
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"deleteUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/deleteUser.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.deleteUser = function (userId) {                                                                            // 1
	var user = RocketChat.models.Users.findOneById(userId);                                                               // 2
	RocketChat.models.Messages.removeByUserId(userId); // Remove user messages                                            // 4
                                                                                                                       //
	RocketChat.models.Subscriptions.findByUserId(userId).forEach(function (subscription) {                                // 5
		var room = RocketChat.models.Rooms.findOneById(subscription.rid);                                                    // 6
                                                                                                                       //
		if (room) {                                                                                                          // 7
			if (room.t !== 'c' && room.usernames.length === 1) {                                                                // 8
				RocketChat.models.Rooms.removeById(subscription.rid); // Remove non-channel rooms with only 1 user (the one being deleted)
			}                                                                                                                   // 10
                                                                                                                       //
			if (room.t === 'd') {                                                                                               // 11
				RocketChat.models.Subscriptions.removeByRoomId(subscription.rid);                                                  // 12
				RocketChat.models.Messages.removeByRoomId(subscription.rid);                                                       // 13
			}                                                                                                                   // 14
		}                                                                                                                    // 15
	});                                                                                                                   // 16
	RocketChat.models.Subscriptions.removeByUserId(userId); // Remove user subscriptions                                  // 18
                                                                                                                       //
	RocketChat.models.Rooms.removeByTypeContainingUsername('d', user.username); // Remove direct rooms with the user      // 19
                                                                                                                       //
	RocketChat.models.Rooms.removeUsernameFromAll(user.username); // Remove user from all other rooms                     // 20
	// removes user's avatar                                                                                              // 22
                                                                                                                       //
	if (user.avatarOrigin === 'upload' || user.avatarOrigin === 'url') {                                                  // 23
		FileUpload.getStore('Avatars').deleteByName(user.username);                                                          // 24
	}                                                                                                                     // 25
                                                                                                                       //
	RocketChat.models.Integrations.disableByUserId(userId); // Disables all the integrations which rely on the user being deleted.
                                                                                                                       //
	RocketChat.models.Users.removeById(userId); // Remove user from users database                                        // 29
};                                                                                                                     // 30
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getFullUserData.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/getFullUserData.js                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals RocketChat */RocketChat.getFullUserData = function (_ref) {                                                 // 1
	var userId = _ref.userId,                                                                                             // 2
	    filter = _ref.filter,                                                                                             // 2
	    limit = _ref.limit;                                                                                               // 2
	var fields = {                                                                                                        // 3
		name: 1,                                                                                                             // 4
		username: 1,                                                                                                         // 5
		status: 1,                                                                                                           // 6
		utcOffset: 1,                                                                                                        // 7
		type: 1,                                                                                                             // 8
		active: 1                                                                                                            // 9
	};                                                                                                                    // 3
                                                                                                                       //
	if (RocketChat.authz.hasPermission(userId, 'view-full-other-user-info')) {                                            // 12
		fields = _.extend(fields, {                                                                                          // 13
			emails: 1,                                                                                                          // 14
			phone: 1,                                                                                                           // 15
			statusConnection: 1,                                                                                                // 16
			createdAt: 1,                                                                                                       // 17
			lastLogin: 1,                                                                                                       // 18
			services: 1,                                                                                                        // 19
			requirePasswordChange: 1,                                                                                           // 20
			requirePasswordChangeReason: 1,                                                                                     // 21
			roles: 1,                                                                                                           // 22
			customFields: 1                                                                                                     // 23
		});                                                                                                                  // 13
	} else if (limit !== 0) {                                                                                             // 25
		limit = 1;                                                                                                           // 26
	}                                                                                                                     // 27
                                                                                                                       //
	filter = s.trim(filter);                                                                                              // 29
                                                                                                                       //
	if (!filter && limit === 1) {                                                                                         // 31
		return undefined;                                                                                                    // 32
	}                                                                                                                     // 33
                                                                                                                       //
	var options = {                                                                                                       // 35
		fields: fields,                                                                                                      // 36
		limit: limit,                                                                                                        // 37
		sort: {                                                                                                              // 38
			username: 1                                                                                                         // 38
		}                                                                                                                    // 38
	};                                                                                                                    // 35
                                                                                                                       //
	if (filter) {                                                                                                         // 41
		if (limit === 1) {                                                                                                   // 42
			return RocketChat.models.Users.findByUsername(filter, options);                                                     // 43
		} else {                                                                                                             // 44
			var filterReg = new RegExp(s.escapeRegExp(filter), 'i');                                                            // 45
			return RocketChat.models.Users.findByUsernameNameOrEmailAddress(filterReg, options);                                // 46
		}                                                                                                                    // 47
	}                                                                                                                     // 48
                                                                                                                       //
	return RocketChat.models.Users.find({}, options);                                                                     // 50
};                                                                                                                     // 51
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getRoomByNameOrIdWithOptionToJoin.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/getRoomByNameOrIdWithOptionToJoin.js                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals RocketChat */RocketChat.getRoomByNameOrIdWithOptionToJoin = function () {                                   // 1
	function _getRoomByNameOrIdWithOptionToJoin(_ref) {                                                                   // 2
		var currentUserId = _ref.currentUserId,                                                                              // 2
		    nameOrId = _ref.nameOrId,                                                                                        // 2
		    _ref$type = _ref.type,                                                                                           // 2
		    type = _ref$type === undefined ? '' : _ref$type,                                                                 // 2
		    _ref$tryDirectByUserI = _ref.tryDirectByUserIdOnly,                                                              // 2
		    tryDirectByUserIdOnly = _ref$tryDirectByUserI === undefined ? false : _ref$tryDirectByUserI,                     // 2
		    _ref$joinChannel = _ref.joinChannel,                                                                             // 2
		    joinChannel = _ref$joinChannel === undefined ? true : _ref$joinChannel,                                          // 2
		    _ref$errorOnEmpty = _ref.errorOnEmpty,                                                                           // 2
		    errorOnEmpty = _ref$errorOnEmpty === undefined ? true : _ref$errorOnEmpty;                                       // 2
		var room = void 0; //If the nameOrId starts with #, then let's try to find a channel or group                        // 3
                                                                                                                       //
		if (nameOrId.startsWith('#')) {                                                                                      // 6
			nameOrId = nameOrId.substring(1);                                                                                   // 7
			room = RocketChat.models.Rooms.findOneByIdOrName(nameOrId);                                                         // 8
		} else if (nameOrId.startsWith('@') || type === 'd') {                                                               // 9
			//If the nameOrId starts with @ OR type is 'd', then let's try just a direct message                                // 10
			nameOrId = nameOrId.replace('@', '');                                                                               // 11
			var roomUser = void 0;                                                                                              // 13
                                                                                                                       //
			if (tryDirectByUserIdOnly) {                                                                                        // 14
				roomUser = RocketChat.models.Users.findOneById(nameOrId);                                                          // 15
			} else {                                                                                                            // 16
				roomUser = RocketChat.models.Users.findOne({                                                                       // 17
					$or: [{                                                                                                           // 18
						_id: nameOrId                                                                                                    // 18
					}, {                                                                                                              // 18
						username: nameOrId                                                                                               // 18
					}]                                                                                                                // 18
				});                                                                                                                // 17
			}                                                                                                                   // 20
                                                                                                                       //
			var rid = _.isObject(roomUser) ? [currentUserId, roomUser._id].sort().join('') : nameOrId;                          // 22
			room = RocketChat.models.Rooms.findOneById(rid); //If the room hasn't been found yet, let's try some more           // 23
                                                                                                                       //
			if (!_.isObject(room)) {                                                                                            // 26
				//If the roomUser wasn't found, then there's no destination to point towards                                       // 27
				//so return out based upon errorOnEmpty                                                                            // 28
				if (!_.isObject(roomUser)) {                                                                                       // 29
					if (errorOnEmpty) {                                                                                               // 30
						throw new Meteor.Error('invalid-channel');                                                                       // 31
					} else {                                                                                                          // 32
						return;                                                                                                          // 33
					}                                                                                                                 // 34
				}                                                                                                                  // 35
                                                                                                                       //
				room = Meteor.runAsUser(currentUserId, function () {                                                               // 37
					var _Meteor$call = Meteor.call('createDirectMessage', roomUser.username),                                         // 37
					    rid = _Meteor$call.rid;                                                                                       // 37
                                                                                                                       //
					return RocketChat.models.Rooms.findOneById(rid);                                                                  // 39
				});                                                                                                                // 40
			}                                                                                                                   // 41
		} else {                                                                                                             // 42
			//Otherwise, we'll treat this as a channel or group.                                                                // 43
			room = RocketChat.models.Rooms.findOneByIdOrName(nameOrId);                                                         // 44
		} //If no room was found, handle the room return based upon errorOnEmpty                                             // 45
                                                                                                                       //
                                                                                                                       //
		if (!room && errorOnEmpty) {                                                                                         // 48
			throw new Meteor.Error('invalid-channel');                                                                          // 49
		} else if (!room) {                                                                                                  // 50
			return;                                                                                                             // 51
		} //If a room was found and they provided a type to search, then check                                               // 52
		//and if the type found isn't what we're looking for then handle                                                     // 55
		//the return based upon errorOnEmpty                                                                                 // 56
                                                                                                                       //
                                                                                                                       //
		if (type && room.t !== type) {                                                                                       // 57
			if (errorOnEmpty) {                                                                                                 // 58
				throw new Meteor.Error('invalid-channel');                                                                         // 59
			} else {                                                                                                            // 60
				return;                                                                                                            // 61
			}                                                                                                                   // 62
		} //If the room type is channel and joinChannel has been passed, try to join them                                    // 63
		//if they can't join the room, this will error out!                                                                  // 66
                                                                                                                       //
                                                                                                                       //
		if (room.t === 'c' && joinChannel) {                                                                                 // 67
			var sub = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(room._id, currentUserId);                        // 68
                                                                                                                       //
			if (!sub) {                                                                                                         // 70
				Meteor.runAsUser(currentUserId, function () {                                                                      // 71
					return Meteor.call('joinRoom', room._id);                                                                         // 72
				});                                                                                                                // 73
			}                                                                                                                   // 74
		}                                                                                                                    // 75
                                                                                                                       //
		return room;                                                                                                         // 77
	}                                                                                                                     // 78
                                                                                                                       //
	return _getRoomByNameOrIdWithOptionToJoin;                                                                            // 2
}();                                                                                                                   // 2
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"removeUserFromRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/removeUserFromRoom.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.removeUserFromRoom = function (rid, user) {                                                                 // 1
	var room = RocketChat.models.Rooms.findOneById(rid);                                                                  // 2
                                                                                                                       //
	if (room) {                                                                                                           // 4
		RocketChat.callbacks.run('beforeLeaveRoom', user, room);                                                             // 5
		RocketChat.models.Rooms.removeUsernameById(rid, user.username);                                                      // 6
                                                                                                                       //
		if (room.usernames.indexOf(user.username) !== -1) {                                                                  // 8
			var removedUser = user;                                                                                             // 9
			RocketChat.models.Messages.createUserLeaveWithRoomIdAndUser(rid, removedUser);                                      // 10
		}                                                                                                                    // 11
                                                                                                                       //
		if (room.t === 'l') {                                                                                                // 13
			RocketChat.models.Messages.createCommandWithRoomIdAndUser('survey', rid, user);                                     // 14
		}                                                                                                                    // 15
                                                                                                                       //
		RocketChat.models.Subscriptions.removeByRoomIdAndUserId(rid, user._id);                                              // 17
		Meteor.defer(function () {                                                                                           // 19
			RocketChat.callbacks.run('afterLeaveRoom', user, room);                                                             // 20
		});                                                                                                                  // 21
	}                                                                                                                     // 22
};                                                                                                                     // 23
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"saveUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/saveUser.js                                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals Gravatar */RocketChat.saveUser = function (userId, userData) {                                              // 1
	var user = RocketChat.models.Users.findOneById(userId);                                                               // 3
                                                                                                                       //
	var existingRoles = _.pluck(RocketChat.authz.getRoles(), '_id');                                                      // 4
                                                                                                                       //
	if (userData._id && userId !== userData._id && !RocketChat.authz.hasPermission(userId, 'edit-other-user-info')) {     // 6
		throw new Meteor.Error('error-action-not-allowed', 'Editing user is not allowed', {                                  // 7
			method: 'insertOrUpdateUser',                                                                                       // 7
			action: 'Editing_user'                                                                                              // 7
		});                                                                                                                  // 7
	}                                                                                                                     // 8
                                                                                                                       //
	if (!userData._id && !RocketChat.authz.hasPermission(userId, 'create-user')) {                                        // 10
		throw new Meteor.Error('error-action-not-allowed', 'Adding user is not allowed', {                                   // 11
			method: 'insertOrUpdateUser',                                                                                       // 11
			action: 'Adding_user'                                                                                               // 11
		});                                                                                                                  // 11
	}                                                                                                                     // 12
                                                                                                                       //
	if (userData.roles && _.difference(userData.roles, existingRoles).length > 0) {                                       // 14
		throw new Meteor.Error('error-action-not-allowed', 'The field Roles consist invalid role name', {                    // 15
			method: 'insertOrUpdateUser',                                                                                       // 15
			action: 'Assign_role'                                                                                               // 15
		});                                                                                                                  // 15
	}                                                                                                                     // 16
                                                                                                                       //
	if (userData.roles && _.indexOf(userData.roles, 'admin') >= 0 && !RocketChat.authz.hasPermission(userId, 'assign-admin-role')) {
		throw new Meteor.Error('error-action-not-allowed', 'Assigning admin is not allowed', {                               // 19
			method: 'insertOrUpdateUser',                                                                                       // 19
			action: 'Assign_admin'                                                                                              // 19
		});                                                                                                                  // 19
	}                                                                                                                     // 20
                                                                                                                       //
	if (!userData._id && !s.trim(userData.name)) {                                                                        // 22
		throw new Meteor.Error('error-the-field-is-required', 'The field Name is required', {                                // 23
			method: 'insertOrUpdateUser',                                                                                       // 23
			field: 'Name'                                                                                                       // 23
		});                                                                                                                  // 23
	}                                                                                                                     // 24
                                                                                                                       //
	if (!userData._id && !s.trim(userData.username)) {                                                                    // 26
		throw new Meteor.Error('error-the-field-is-required', 'The field Username is required', {                            // 27
			method: 'insertOrUpdateUser',                                                                                       // 27
			field: 'Username'                                                                                                   // 27
		});                                                                                                                  // 27
	}                                                                                                                     // 28
                                                                                                                       //
	var nameValidation = void 0;                                                                                          // 30
                                                                                                                       //
	try {                                                                                                                 // 32
		nameValidation = new RegExp("^" + RocketChat.settings.get('UTF8_Names_Validation') + "$");                           // 33
	} catch (e) {                                                                                                         // 34
		nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                    // 35
	}                                                                                                                     // 36
                                                                                                                       //
	if (userData.username && !nameValidation.test(userData.username)) {                                                   // 38
		throw new Meteor.Error('error-input-is-not-a-valid-field', _.escape(userData.username) + " is not a valid username", {
			method: 'insertOrUpdateUser',                                                                                       // 39
			input: userData.username,                                                                                           // 39
			field: 'Username'                                                                                                   // 39
		});                                                                                                                  // 39
	}                                                                                                                     // 40
                                                                                                                       //
	if (!userData._id && !userData.password) {                                                                            // 42
		throw new Meteor.Error('error-the-field-is-required', 'The field Password is required', {                            // 43
			method: 'insertOrUpdateUser',                                                                                       // 43
			field: 'Password'                                                                                                   // 43
		});                                                                                                                  // 43
	}                                                                                                                     // 44
                                                                                                                       //
	if (!userData._id) {                                                                                                  // 46
		if (!RocketChat.checkUsernameAvailability(userData.username)) {                                                      // 47
			throw new Meteor.Error('error-field-unavailable', _.escape(userData.username) + " is already in use :(", {          // 48
				method: 'insertOrUpdateUser',                                                                                      // 48
				field: userData.username                                                                                           // 48
			});                                                                                                                 // 48
		}                                                                                                                    // 49
                                                                                                                       //
		if (userData.email && !RocketChat.checkEmailAvailability(userData.email)) {                                          // 51
			throw new Meteor.Error('error-field-unavailable', _.escape(userData.email) + " is already in use :(", {             // 52
				method: 'insertOrUpdateUser',                                                                                      // 52
				field: userData.email                                                                                              // 52
			});                                                                                                                 // 52
		}                                                                                                                    // 53
                                                                                                                       //
		RocketChat.validateEmailDomain(userData.email); // insert user                                                       // 55
                                                                                                                       //
		var createUser = {                                                                                                   // 58
			username: userData.username,                                                                                        // 59
			password: userData.password,                                                                                        // 60
			joinDefaultChannels: userData.joinDefaultChannels                                                                   // 61
		};                                                                                                                   // 58
                                                                                                                       //
		if (userData.email) {                                                                                                // 63
			createUser.email = userData.email;                                                                                  // 64
		}                                                                                                                    // 65
                                                                                                                       //
		var _id = Accounts.createUser(createUser);                                                                           // 67
                                                                                                                       //
		var updateUser = {                                                                                                   // 69
			$set: {                                                                                                             // 70
				name: userData.name,                                                                                               // 71
				roles: userData.roles || ['user']                                                                                  // 72
			}                                                                                                                   // 70
		};                                                                                                                   // 69
                                                                                                                       //
		if (typeof userData.requirePasswordChange !== 'undefined') {                                                         // 76
			updateUser.$set.requirePasswordChange = userData.requirePasswordChange;                                             // 77
		}                                                                                                                    // 78
                                                                                                                       //
		if (userData.verified) {                                                                                             // 80
			updateUser.$set['emails.0.verified'] = true;                                                                        // 81
		}                                                                                                                    // 82
                                                                                                                       //
		Meteor.users.update({                                                                                                // 84
			_id: _id                                                                                                            // 84
		}, updateUser);                                                                                                      // 84
                                                                                                                       //
		if (userData.sendWelcomeEmail) {                                                                                     // 86
			var header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');                        // 87
			var footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');                        // 88
			var subject = void 0;                                                                                               // 90
			var html = void 0;                                                                                                  // 91
                                                                                                                       //
			if (RocketChat.settings.get('Accounts_UserAddedEmail_Customized')) {                                                // 93
				subject = RocketChat.settings.get('Accounts_UserAddedEmailSubject');                                               // 94
				html = RocketChat.settings.get('Accounts_UserAddedEmail');                                                         // 95
			} else {                                                                                                            // 96
				subject = TAPi18n.__('Accounts_UserAddedEmailSubject_Default', {                                                   // 97
					lng: user.language || RocketChat.settings.get('language') || 'en'                                                 // 97
				});                                                                                                                // 97
				html = TAPi18n.__('Accounts_UserAddedEmail_Default', {                                                             // 98
					lng: user.language || RocketChat.settings.get('language') || 'en'                                                 // 98
				});                                                                                                                // 98
			}                                                                                                                   // 99
                                                                                                                       //
			subject = RocketChat.placeholders.replace(subject);                                                                 // 101
			html = RocketChat.placeholders.replace(html, {                                                                      // 102
				name: userData.name,                                                                                               // 103
				email: userData.email,                                                                                             // 104
				password: userData.password                                                                                        // 105
			});                                                                                                                 // 102
			var email = {                                                                                                       // 108
				to: userData.email,                                                                                                // 109
				from: RocketChat.settings.get('From_Email'),                                                                       // 110
				subject: subject,                                                                                                  // 111
				html: header + html + footer                                                                                       // 112
			};                                                                                                                  // 108
			Meteor.defer(function () {                                                                                          // 115
				try {                                                                                                              // 116
					Email.send(email);                                                                                                // 117
				} catch (error) {                                                                                                  // 118
					throw new Meteor.Error('error-email-send-failed', "Error trying to send email: " + error.message, {               // 119
						"function": 'RocketChat.saveUser',                                                                               // 119
						message: error.message                                                                                           // 119
					});                                                                                                               // 119
				}                                                                                                                  // 120
			});                                                                                                                 // 121
		}                                                                                                                    // 122
                                                                                                                       //
		userData._id = _id;                                                                                                  // 124
                                                                                                                       //
		if (RocketChat.settings.get('Accounts_SetDefaultAvatar') === true && userData.email) {                               // 126
			var gravatarUrl = Gravatar.imageUrl(userData.email, {                                                               // 127
				"default": '404',                                                                                                  // 127
				size: 200,                                                                                                         // 127
				secure: true                                                                                                       // 127
			});                                                                                                                 // 127
                                                                                                                       //
			try {                                                                                                               // 129
				RocketChat.setUserAvatar(userData, gravatarUrl, '', 'url');                                                        // 130
			} catch (e) {//Ignore this error for now, as it not being successful isn't bad                                      // 131
			}                                                                                                                   // 133
		}                                                                                                                    // 134
                                                                                                                       //
		return _id;                                                                                                          // 136
	} else {                                                                                                              // 137
		// update user                                                                                                       // 138
		if (userData.username) {                                                                                             // 139
			RocketChat.setUsername(userData._id, userData.username);                                                            // 140
		}                                                                                                                    // 141
                                                                                                                       //
		if (userData.name) {                                                                                                 // 143
			RocketChat.setRealName(userData._id, userData.name);                                                                // 144
		}                                                                                                                    // 145
                                                                                                                       //
		if (userData.email) {                                                                                                // 147
			RocketChat.setEmail(userData._id, userData.email);                                                                  // 148
		}                                                                                                                    // 149
                                                                                                                       //
		if (userData.password && userData.password.trim() && RocketChat.authz.hasPermission(userId, 'edit-other-user-password')) {
			Accounts.setPassword(userData._id, userData.password.trim());                                                       // 152
		}                                                                                                                    // 153
                                                                                                                       //
		var _updateUser = {                                                                                                  // 155
			$set: {}                                                                                                            // 156
		};                                                                                                                   // 155
                                                                                                                       //
		if (userData.roles) {                                                                                                // 159
			_updateUser.$set.roles = userData.roles;                                                                            // 160
		}                                                                                                                    // 161
                                                                                                                       //
		if (typeof userData.requirePasswordChange !== 'undefined') {                                                         // 163
			_updateUser.$set.requirePasswordChange = userData.requirePasswordChange;                                            // 164
		}                                                                                                                    // 165
                                                                                                                       //
		if (userData.verified) {                                                                                             // 167
			_updateUser.$set['emails.0.verified'] = userData.verified;                                                          // 168
		}                                                                                                                    // 169
                                                                                                                       //
		Meteor.users.update({                                                                                                // 171
			_id: userData._id                                                                                                   // 171
		}, _updateUser);                                                                                                     // 171
		return true;                                                                                                         // 173
	}                                                                                                                     // 174
};                                                                                                                     // 175
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"saveCustomFields.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/saveCustomFields.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.saveCustomFields = function (userId, formData) {                                                            // 1
	if (s.trim(RocketChat.settings.get('Accounts_CustomFields')) !== '') {                                                // 2
		RocketChat.validateCustomFields(formData);                                                                           // 3
		return RocketChat.saveCustomFieldsWithoutValidation(userId, formData);                                               // 4
	}                                                                                                                     // 5
};                                                                                                                     // 6
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"saveCustomFieldsWithoutValidation.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/saveCustomFieldsWithoutValidation.js                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.saveCustomFieldsWithoutValidation = function (userId, formData) {                                           // 1
	if (s.trim(RocketChat.settings.get('Accounts_CustomFields')) !== '') {                                                // 2
		var customFieldsMeta = void 0;                                                                                       // 3
                                                                                                                       //
		try {                                                                                                                // 4
			customFieldsMeta = JSON.parse(RocketChat.settings.get('Accounts_CustomFields'));                                    // 5
		} catch (e) {                                                                                                        // 6
			throw new Meteor.Error('error-invalid-customfield-json', 'Invalid JSON for Custom Fields');                         // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var customFields = {};                                                                                               // 10
		Object.keys(customFieldsMeta).forEach(function (key) {                                                               // 11
			return customFields[key] = formData[key];                                                                           // 11
		});                                                                                                                  // 11
		RocketChat.models.Users.setCustomFields(userId, customFields);                                                       // 12
		Object.keys(customFields).forEach(function (fieldName) {                                                             // 14
			if (!customFieldsMeta[fieldName].modifyRecordField) {                                                               // 15
				return;                                                                                                            // 16
			}                                                                                                                   // 17
                                                                                                                       //
			var modifyRecordField = customFieldsMeta[fieldName].modifyRecordField;                                              // 19
			var update = {};                                                                                                    // 20
                                                                                                                       //
			if (modifyRecordField.array) {                                                                                      // 21
				update.$addToSet = {};                                                                                             // 22
				update.$addToSet[modifyRecordField.field] = customFields[fieldName];                                               // 23
			} else {                                                                                                            // 24
				update.$set = {};                                                                                                  // 25
				update.$set[modifyRecordField.field] = customFields[fieldName];                                                    // 26
			}                                                                                                                   // 27
                                                                                                                       //
			RocketChat.models.Users.update(userId, update);                                                                     // 29
		});                                                                                                                  // 30
	}                                                                                                                     // 31
};                                                                                                                     // 32
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendMessage.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/sendMessage.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.sendMessage = function (user, message, room) {                                                              // 1
	var upsert = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;                               // 1
                                                                                                                       //
	if (!user || !message || !room._id) {                                                                                 // 2
		return false;                                                                                                        // 3
	}                                                                                                                     // 4
                                                                                                                       //
	if (message.ts == null) {                                                                                             // 5
		message.ts = new Date();                                                                                             // 6
	}                                                                                                                     // 7
                                                                                                                       //
	message.u = _.pick(user, ['_id', 'username', 'name']);                                                                // 8
                                                                                                                       //
	if (!Match.test(message.msg, String)) {                                                                               // 9
		message.msg = '';                                                                                                    // 10
	}                                                                                                                     // 11
                                                                                                                       //
	message.rid = room._id;                                                                                               // 12
                                                                                                                       //
	if (!room.usernames || room.usernames.length === 0) {                                                                 // 13
		var updated_room = RocketChat.models.Rooms.findOneById(room._id);                                                    // 14
                                                                                                                       //
		if (updated_room != null) {                                                                                          // 15
			room = updated_room;                                                                                                // 16
		} else {                                                                                                             // 17
			room.usernames = [];                                                                                                // 18
		}                                                                                                                    // 19
	}                                                                                                                     // 20
                                                                                                                       //
	if (message.parseUrls !== false) {                                                                                    // 21
		var urls = message.msg.match(/([A-Za-z]{3,9}):\/\/([-;:&=\+\$,\w]+@{1})?([-A-Za-z0-9\.]+)+:?(\d+)?((\/[-\+=!:~%\/\.@\,\(\)\w]*)?\??([-\+=&!:;%@\/\.\,\w]+)?(?:#([^\s\)]+))?)?/g);
                                                                                                                       //
		if (urls) {                                                                                                          // 24
			message.urls = urls.map(function (url) {                                                                            // 25
				return {                                                                                                           // 26
					url: url                                                                                                          // 27
				};                                                                                                                 // 26
			});                                                                                                                 // 29
		}                                                                                                                    // 30
	}                                                                                                                     // 31
                                                                                                                       //
	message = RocketChat.callbacks.run('beforeSaveMessage', message);                                                     // 32
                                                                                                                       //
	if (message) {                                                                                                        // 33
		// Avoid saving sandstormSessionId to the database                                                                   // 34
		var sandstormSessionId = null;                                                                                       // 35
                                                                                                                       //
		if (message.sandstormSessionId) {                                                                                    // 36
			sandstormSessionId = message.sandstormSessionId;                                                                    // 37
			delete message.sandstormSessionId;                                                                                  // 38
		}                                                                                                                    // 39
                                                                                                                       //
		if (message._id && upsert) {                                                                                         // 40
			var _id = message._id;                                                                                              // 41
			delete message._id;                                                                                                 // 42
			RocketChat.models.Messages.upsert({                                                                                 // 43
				_id: _id,                                                                                                          // 44
				'u._id': message.u._id                                                                                             // 45
			}, message);                                                                                                        // 43
			message._id = _id;                                                                                                  // 47
		} else {                                                                                                             // 48
			message._id = RocketChat.models.Messages.insert(message);                                                           // 49
		} /*                                                                                                                 // 50
    Defer other updates as their return is not interesting to the user                                                 //
    */                                                                                                                 //
                                                                                                                       //
		Meteor.defer(function () {                                                                                           // 55
			// Execute all callbacks                                                                                            // 56
			message.sandstormSessionId = sandstormSessionId;                                                                    // 57
			return RocketChat.callbacks.run('afterSaveMessage', message, room, user._id);                                       // 58
		});                                                                                                                  // 59
		return message;                                                                                                      // 60
	}                                                                                                                     // 61
};                                                                                                                     // 62
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settings.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/settings.js                                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var blockedSettings = {};                                                                                              // 1
                                                                                                                       //
if (process.env.SETTINGS_BLOCKED) {                                                                                    // 3
	process.env.SETTINGS_BLOCKED.split(',').forEach(function (settingId) {                                                // 4
		return blockedSettings[settingId] = 1;                                                                               // 4
	});                                                                                                                   // 4
}                                                                                                                      // 5
                                                                                                                       //
var hiddenSettings = {};                                                                                               // 7
                                                                                                                       //
if (process.env.SETTINGS_HIDDEN) {                                                                                     // 8
	process.env.SETTINGS_HIDDEN.split(',').forEach(function (settingId) {                                                 // 9
		return hiddenSettings[settingId] = 1;                                                                                // 9
	});                                                                                                                   // 9
}                                                                                                                      // 10
                                                                                                                       //
RocketChat.settings._sorter = {}; /*                                                                                   // 12
                                  * Add a setting                                                                      //
                                  * @param {String} _id                                                                //
                                  * @param {Mixed} value                                                               //
                                  * @param {Object} setting                                                            //
                                  */                                                                                   //
                                                                                                                       //
RocketChat.settings.add = function (_id, value) {                                                                      // 22
	var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                                 // 22
                                                                                                                       //
	if (options == null) {                                                                                                // 23
		options = {};                                                                                                        // 24
	}                                                                                                                     // 25
                                                                                                                       //
	if (!_id || value == null) {                                                                                          // 26
		return false;                                                                                                        // 27
	}                                                                                                                     // 28
                                                                                                                       //
	if (RocketChat.settings._sorter[options.group] == null) {                                                             // 29
		RocketChat.settings._sorter[options.group] = 0;                                                                      // 30
	}                                                                                                                     // 31
                                                                                                                       //
	options.packageValue = value;                                                                                         // 32
	options.valueSource = 'packageValue';                                                                                 // 33
	options.hidden = options.hidden || false;                                                                             // 34
	options.blocked = options.blocked || false;                                                                           // 35
                                                                                                                       //
	if (options.sorter == null) {                                                                                         // 36
		options.sorter = RocketChat.settings._sorter[options.group]++;                                                       // 37
	}                                                                                                                     // 38
                                                                                                                       //
	if (options.enableQuery != null) {                                                                                    // 39
		options.enableQuery = JSON.stringify(options.enableQuery);                                                           // 40
	}                                                                                                                     // 41
                                                                                                                       //
	if (options.i18nDefaultQuery != null) {                                                                               // 42
		options.i18nDefaultQuery = JSON.stringify(options.i18nDefaultQuery);                                                 // 43
	}                                                                                                                     // 44
                                                                                                                       //
	if (typeof process !== 'undefined' && process.env && process.env[_id]) {                                              // 45
		value = process.env[_id];                                                                                            // 46
                                                                                                                       //
		if (value.toLowerCase() === 'true') {                                                                                // 47
			value = true;                                                                                                       // 48
		} else if (value.toLowerCase() === 'false') {                                                                        // 49
			value = false;                                                                                                      // 50
		}                                                                                                                    // 51
                                                                                                                       //
		options.processEnvValue = value;                                                                                     // 52
		options.valueSource = 'processEnvValue';                                                                             // 53
	} else if (Meteor.settings && typeof Meteor.settings[_id] !== 'undefined') {                                          // 54
		if (Meteor.settings[_id] == null) {                                                                                  // 55
			return false;                                                                                                       // 56
		}                                                                                                                    // 57
                                                                                                                       //
		value = Meteor.settings[_id];                                                                                        // 59
		options.meteorSettingsValue = value;                                                                                 // 60
		options.valueSource = 'meteorSettingsValue';                                                                         // 61
	}                                                                                                                     // 62
                                                                                                                       //
	if (options.i18nLabel == null) {                                                                                      // 63
		options.i18nLabel = _id;                                                                                             // 64
	}                                                                                                                     // 65
                                                                                                                       //
	if (options.i18nDescription == null) {                                                                                // 66
		options.i18nDescription = _id + "_Description";                                                                      // 67
	}                                                                                                                     // 68
                                                                                                                       //
	if (blockedSettings[_id] != null) {                                                                                   // 69
		options.blocked = true;                                                                                              // 70
	}                                                                                                                     // 71
                                                                                                                       //
	if (hiddenSettings[_id] != null) {                                                                                    // 72
		options.hidden = true;                                                                                               // 73
	}                                                                                                                     // 74
                                                                                                                       //
	if (typeof process !== 'undefined' && process.env && process.env["OVERWRITE_SETTING_" + _id]) {                       // 75
		var _value = process.env["OVERWRITE_SETTING_" + _id];                                                                // 76
                                                                                                                       //
		if (_value.toLowerCase() === 'true') {                                                                               // 77
			_value = true;                                                                                                      // 78
		} else if (_value.toLowerCase() === 'false') {                                                                       // 79
			_value = false;                                                                                                     // 80
		}                                                                                                                    // 81
                                                                                                                       //
		options.value = _value;                                                                                              // 82
		options.processEnvValue = _value;                                                                                    // 83
		options.valueSource = 'processEnvValue';                                                                             // 84
	}                                                                                                                     // 85
                                                                                                                       //
	var updateOperations = {                                                                                              // 86
		$set: options,                                                                                                       // 87
		$setOnInsert: {                                                                                                      // 88
			createdAt: new Date()                                                                                               // 89
		}                                                                                                                    // 88
	};                                                                                                                    // 86
                                                                                                                       //
	if (options.editor != null) {                                                                                         // 92
		updateOperations.$setOnInsert.editor = options.editor;                                                               // 93
		delete options.editor;                                                                                               // 94
	}                                                                                                                     // 95
                                                                                                                       //
	if (options.value == null) {                                                                                          // 96
		if (options.force === true) {                                                                                        // 97
			updateOperations.$set.value = options.packageValue;                                                                 // 98
		} else {                                                                                                             // 99
			updateOperations.$setOnInsert.value = value;                                                                        // 100
		}                                                                                                                    // 101
	}                                                                                                                     // 102
                                                                                                                       //
	var query = _.extend({                                                                                                // 103
		_id: _id                                                                                                             // 104
	}, updateOperations.$set);                                                                                            // 103
                                                                                                                       //
	if (options.section == null) {                                                                                        // 106
		updateOperations.$unset = {                                                                                          // 107
			section: 1                                                                                                          // 108
		};                                                                                                                   // 107
		query.section = {                                                                                                    // 110
			$exists: false                                                                                                      // 111
		};                                                                                                                   // 110
	}                                                                                                                     // 113
                                                                                                                       //
	var existantSetting = RocketChat.models.Settings.db.findOne(query);                                                   // 114
                                                                                                                       //
	if (existantSetting != null) {                                                                                        // 115
		if (existantSetting.editor == null && updateOperations.$setOnInsert.editor != null) {                                // 116
			updateOperations.$set.editor = updateOperations.$setOnInsert.editor;                                                // 117
			delete updateOperations.$setOnInsert.editor;                                                                        // 118
		}                                                                                                                    // 119
	} else {                                                                                                              // 120
		updateOperations.$set.ts = new Date();                                                                               // 121
	}                                                                                                                     // 122
                                                                                                                       //
	return RocketChat.models.Settings.upsert({                                                                            // 123
		_id: _id                                                                                                             // 124
	}, updateOperations);                                                                                                 // 123
}; /*                                                                                                                  // 126
   * Add a setting group                                                                                               //
   * @param {String} _id                                                                                               //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.settings.addGroup = function (_id) {                                                                        // 134
	var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                                 // 134
	var cb = arguments[2];                                                                                                // 134
                                                                                                                       //
	if (!_id) {                                                                                                           // 135
		return false;                                                                                                        // 136
	}                                                                                                                     // 137
                                                                                                                       //
	if (_.isFunction(options)) {                                                                                          // 138
		cb = options;                                                                                                        // 139
		options = {};                                                                                                        // 140
	}                                                                                                                     // 141
                                                                                                                       //
	if (options.i18nLabel == null) {                                                                                      // 142
		options.i18nLabel = _id;                                                                                             // 143
	}                                                                                                                     // 144
                                                                                                                       //
	if (options.i18nDescription == null) {                                                                                // 145
		options.i18nDescription = _id + "_Description";                                                                      // 146
	}                                                                                                                     // 147
                                                                                                                       //
	options.ts = new Date();                                                                                              // 148
	options.blocked = false;                                                                                              // 149
	options.hidden = false;                                                                                               // 150
                                                                                                                       //
	if (blockedSettings[_id] != null) {                                                                                   // 151
		options.blocked = true;                                                                                              // 152
	}                                                                                                                     // 153
                                                                                                                       //
	if (hiddenSettings[_id] != null) {                                                                                    // 154
		options.hidden = true;                                                                                               // 155
	}                                                                                                                     // 156
                                                                                                                       //
	RocketChat.models.Settings.upsert({                                                                                   // 157
		_id: _id                                                                                                             // 158
	}, {                                                                                                                  // 157
		$set: options,                                                                                                       // 160
		$setOnInsert: {                                                                                                      // 161
			type: 'group',                                                                                                      // 162
			createdAt: new Date()                                                                                               // 163
		}                                                                                                                    // 161
	});                                                                                                                   // 159
                                                                                                                       //
	if (cb != null) {                                                                                                     // 166
		cb.call({                                                                                                            // 167
			add: function (id, value, options) {                                                                                // 168
				if (options == null) {                                                                                             // 169
					options = {};                                                                                                     // 170
				}                                                                                                                  // 171
                                                                                                                       //
				options.group = _id;                                                                                               // 172
				return RocketChat.settings.add(id, value, options);                                                                // 173
			},                                                                                                                  // 174
			section: function (section, cb) {                                                                                   // 175
				return cb.call({                                                                                                   // 176
					add: function (id, value, options) {                                                                              // 177
						if (options == null) {                                                                                           // 178
							options = {};                                                                                                   // 179
						}                                                                                                                // 180
                                                                                                                       //
						options.group = _id;                                                                                             // 181
						options.section = section;                                                                                       // 182
						return RocketChat.settings.add(id, value, options);                                                              // 183
					}                                                                                                                 // 184
				});                                                                                                                // 176
			}                                                                                                                   // 186
		});                                                                                                                  // 167
	}                                                                                                                     // 188
}; /*                                                                                                                  // 189
   * Remove a setting by id                                                                                            //
   * @param {String} _id                                                                                               //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.settings.removeById = function (_id) {                                                                      // 197
	if (!_id) {                                                                                                           // 198
		return false;                                                                                                        // 199
	}                                                                                                                     // 200
                                                                                                                       //
	return RocketChat.models.Settings.removeById(_id);                                                                    // 201
}; /*                                                                                                                  // 202
   * Update a setting by id                                                                                            //
   * @param {String} _id                                                                                               //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.settings.updateById = function (_id, value, editor) {                                                       // 210
	if (!_id || value == null) {                                                                                          // 211
		return false;                                                                                                        // 212
	}                                                                                                                     // 213
                                                                                                                       //
	if (editor != null) {                                                                                                 // 214
		return RocketChat.models.Settings.updateValueAndEditorById(_id, value, editor);                                      // 215
	}                                                                                                                     // 216
                                                                                                                       //
	return RocketChat.models.Settings.updateValueById(_id, value);                                                        // 217
}; /*                                                                                                                  // 218
   * Update options of a setting by id                                                                                 //
   * @param {String} _id                                                                                               //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.settings.updateOptionsById = function (_id, options) {                                                      // 226
	if (!_id || options == null) {                                                                                        // 227
		return false;                                                                                                        // 228
	}                                                                                                                     // 229
                                                                                                                       //
	return RocketChat.models.Settings.updateOptionsById(_id, options);                                                    // 230
}; /*                                                                                                                  // 231
   * Update a setting by id                                                                                            //
   * @param {String} _id                                                                                               //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.settings.clearById = function (_id) {                                                                       // 239
	if (_id == null) {                                                                                                    // 240
		return false;                                                                                                        // 241
	}                                                                                                                     // 242
                                                                                                                       //
	return RocketChat.models.Settings.updateValueById(_id, undefined);                                                    // 243
}; /*                                                                                                                  // 244
   * Update a setting by id                                                                                            //
   */                                                                                                                  //
                                                                                                                       //
RocketChat.settings.init = function () {                                                                               // 251
	RocketChat.settings.initialLoad = true;                                                                               // 252
	RocketChat.models.Settings.find().observe({                                                                           // 253
		added: function (record) {                                                                                           // 254
			Meteor.settings[record._id] = record.value;                                                                         // 255
                                                                                                                       //
			if (record.env === true) {                                                                                          // 256
				process.env[record._id] = record.value;                                                                            // 257
			}                                                                                                                   // 258
                                                                                                                       //
			return RocketChat.settings.load(record._id, record.value, RocketChat.settings.initialLoad);                         // 259
		},                                                                                                                   // 260
		changed: function (record) {                                                                                         // 261
			Meteor.settings[record._id] = record.value;                                                                         // 262
                                                                                                                       //
			if (record.env === true) {                                                                                          // 263
				process.env[record._id] = record.value;                                                                            // 264
			}                                                                                                                   // 265
                                                                                                                       //
			return RocketChat.settings.load(record._id, record.value, RocketChat.settings.initialLoad);                         // 266
		},                                                                                                                   // 267
		removed: function (record) {                                                                                         // 268
			delete Meteor.settings[record._id];                                                                                 // 269
                                                                                                                       //
			if (record.env === true) {                                                                                          // 270
				delete process.env[record._id];                                                                                    // 271
			}                                                                                                                   // 272
                                                                                                                       //
			return RocketChat.settings.load(record._id, undefined, RocketChat.settings.initialLoad);                            // 273
		}                                                                                                                    // 274
	});                                                                                                                   // 253
	RocketChat.settings.initialLoad = false;                                                                              // 276
	RocketChat.settings.afterInitialLoad.forEach(function (fn) {                                                          // 277
		return fn(Meteor.settings);                                                                                          // 277
	});                                                                                                                   // 277
};                                                                                                                     // 278
                                                                                                                       //
RocketChat.settings.afterInitialLoad = [];                                                                             // 280
                                                                                                                       //
RocketChat.settings.onAfterInitialLoad = function (fn) {                                                               // 282
	RocketChat.settings.afterInitialLoad.push(fn);                                                                        // 283
                                                                                                                       //
	if (RocketChat.settings.initialLoad === false) {                                                                      // 284
		return fn(Meteor.settings);                                                                                          // 285
	}                                                                                                                     // 286
};                                                                                                                     // 287
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setUserAvatar.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/setUserAvatar.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.setUserAvatar = function (user, dataURI, contentType, service) {                                            // 1
	var encoding = void 0;                                                                                                // 2
	var image = void 0;                                                                                                   // 3
                                                                                                                       //
	if (service === 'initials') {                                                                                         // 5
		return RocketChat.models.Users.setAvatarOrigin(user._id, service);                                                   // 6
	} else if (service === 'url') {                                                                                       // 7
		var result = null;                                                                                                   // 8
                                                                                                                       //
		try {                                                                                                                // 10
			result = HTTP.get(dataURI, {                                                                                        // 11
				npmRequestOptions: {                                                                                               // 11
					encoding: 'binary'                                                                                                // 11
				}                                                                                                                  // 11
			});                                                                                                                 // 11
		} catch (error) {                                                                                                    // 12
			if (!error.response || error.response.statusCode !== 404) {                                                         // 13
				console.log("Error while handling the setting of the avatar from a url (" + dataURI + ") for " + user.username + ":", error);
				throw new Meteor.Error('error-avatar-url-handling', "Error while handling avatar setting from a URL (" + dataURI + ") for " + user.username, {
					"function": 'RocketChat.setUserAvatar',                                                                           // 15
					url: dataURI,                                                                                                     // 15
					username: user.username                                                                                           // 15
				});                                                                                                                // 15
			}                                                                                                                   // 16
		}                                                                                                                    // 17
                                                                                                                       //
		if (result.statusCode !== 200) {                                                                                     // 19
			console.log("Not a valid response, " + result.statusCode + ", from the avatar url: " + dataURI);                    // 20
			throw new Meteor.Error('error-avatar-invalid-url', "Invalid avatar URL: " + dataURI, {                              // 21
				"function": 'RocketChat.setUserAvatar',                                                                            // 21
				url: dataURI                                                                                                       // 21
			});                                                                                                                 // 21
		}                                                                                                                    // 22
                                                                                                                       //
		if (!/image\/.+/.test(result.headers['content-type'])) {                                                             // 24
			console.log("Not a valid content-type from the provided url, " + result.headers['content-type'] + ", from the avatar url: " + dataURI);
			throw new Meteor.Error('error-avatar-invalid-url', "Invalid avatar URL: " + dataURI, {                              // 26
				"function": 'RocketChat.setUserAvatar',                                                                            // 26
				url: dataURI                                                                                                       // 26
			});                                                                                                                 // 26
		}                                                                                                                    // 27
                                                                                                                       //
		encoding = 'binary';                                                                                                 // 29
		image = result.content;                                                                                              // 30
		contentType = result.headers['content-type'];                                                                        // 31
	} else if (service === 'rest') {                                                                                      // 32
		encoding = 'binary';                                                                                                 // 33
		image = dataURI;                                                                                                     // 34
	} else {                                                                                                              // 35
		var fileData = RocketChatFile.dataURIParse(dataURI);                                                                 // 36
		encoding = 'base64';                                                                                                 // 37
		image = fileData.image;                                                                                              // 38
		contentType = fileData.contentType;                                                                                  // 39
	}                                                                                                                     // 40
                                                                                                                       //
	var buffer = new Buffer(image, encoding);                                                                             // 42
	var fileStore = FileUpload.getStore('Avatars');                                                                       // 43
	fileStore.deleteByName(user.username);                                                                                // 44
	var file = {                                                                                                          // 46
		userId: user._id,                                                                                                    // 47
		type: contentType,                                                                                                   // 48
		size: buffer.length                                                                                                  // 49
	};                                                                                                                    // 46
	fileStore.insert(file, buffer, function () {                                                                          // 52
		Meteor.setTimeout(function () {                                                                                      // 53
			RocketChat.models.Users.setAvatarOrigin(user._id, service);                                                         // 54
			RocketChat.Notifications.notifyLogged('updateAvatar', {                                                             // 55
				username: user.username                                                                                            // 55
			});                                                                                                                 // 55
		}, 500);                                                                                                             // 56
	});                                                                                                                   // 57
};                                                                                                                     // 58
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setUsername.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/setUsername.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _RocketChat$RateLimit;                                                                                             //
                                                                                                                       //
RocketChat._setUsername = function (userId, u) {                                                                       // 2
	var username = s.trim(u);                                                                                             // 3
                                                                                                                       //
	if (!userId || !username) {                                                                                           // 4
		return false;                                                                                                        // 5
	}                                                                                                                     // 6
                                                                                                                       //
	var nameValidation = void 0;                                                                                          // 7
                                                                                                                       //
	try {                                                                                                                 // 8
		nameValidation = new RegExp("^" + RocketChat.settings.get('UTF8_Names_Validation') + "$");                           // 9
	} catch (error) {                                                                                                     // 10
		nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                    // 11
	}                                                                                                                     // 12
                                                                                                                       //
	if (!nameValidation.test(username)) {                                                                                 // 13
		return false;                                                                                                        // 14
	}                                                                                                                     // 15
                                                                                                                       //
	var user = RocketChat.models.Users.findOneById(userId); // User already has desired username, return                  // 16
                                                                                                                       //
	if (user.username === username) {                                                                                     // 18
		return user;                                                                                                         // 19
	}                                                                                                                     // 20
                                                                                                                       //
	var previousUsername = user.username; // Check username availability or if the user already owns a different casing of the name
                                                                                                                       //
	if (!previousUsername || !(username.toLowerCase() === previousUsername.toLowerCase())) {                              // 23
		if (!RocketChat.checkUsernameAvailability(username)) {                                                               // 24
			return false;                                                                                                       // 25
		}                                                                                                                    // 26
	} //If first time setting username, send Enrollment Email                                                             // 27
                                                                                                                       //
                                                                                                                       //
	try {                                                                                                                 // 29
		if (!previousUsername && user.emails && user.emails.length > 0 && RocketChat.settings.get('Accounts_Enrollment_Email')) {
			Accounts.sendEnrollmentEmail(user._id);                                                                             // 31
		}                                                                                                                    // 32
	} catch (e) {                                                                                                         // 33
		console.error(e);                                                                                                    // 34
	} /* globals getAvatarSuggestionForUser */                                                                            // 35
                                                                                                                       //
	user.username = username;                                                                                             // 37
                                                                                                                       //
	if (!previousUsername && RocketChat.settings.get('Accounts_SetDefaultAvatar') === true) {                             // 38
		var avatarSuggestions = getAvatarSuggestionForUser(user);                                                            // 39
		var gravatar = void 0;                                                                                               // 40
		Object.keys(avatarSuggestions).some(function (service) {                                                             // 41
			var avatarData = avatarSuggestions[service];                                                                        // 42
                                                                                                                       //
			if (service !== 'gravatar') {                                                                                       // 43
				RocketChat.setUserAvatar(user, avatarData.blob, avatarData.contentType, service);                                  // 44
				gravatar = null;                                                                                                   // 45
				return true;                                                                                                       // 46
			} else {                                                                                                            // 47
				gravatar = avatarData;                                                                                             // 48
			}                                                                                                                   // 49
		});                                                                                                                  // 50
                                                                                                                       //
		if (gravatar != null) {                                                                                              // 51
			RocketChat.setUserAvatar(user, gravatar.blob, gravatar.contentType, 'gravatar');                                    // 52
		}                                                                                                                    // 53
	} // Username is available; if coming from old username, update all references                                        // 54
                                                                                                                       //
                                                                                                                       //
	if (previousUsername) {                                                                                               // 56
		RocketChat.models.Messages.updateAllUsernamesByUserId(user._id, username);                                           // 57
		RocketChat.models.Messages.updateUsernameOfEditByUserId(user._id, username);                                         // 58
		RocketChat.models.Messages.findByMention(previousUsername).forEach(function (msg) {                                  // 59
			var updatedMsg = msg.msg.replace(new RegExp("@" + previousUsername, 'ig'), "@" + username);                         // 60
			return RocketChat.models.Messages.updateUsernameAndMessageOfMentionByIdAndOldUsername(msg._id, previousUsername, username, updatedMsg);
		});                                                                                                                  // 62
		RocketChat.models.Rooms.replaceUsername(previousUsername, username);                                                 // 63
		RocketChat.models.Rooms.replaceMutedUsername(previousUsername, username);                                            // 64
		RocketChat.models.Rooms.replaceUsernameOfUserByUserId(user._id, username);                                           // 65
		RocketChat.models.Subscriptions.setUserUsernameByUserId(user._id, username);                                         // 66
		RocketChat.models.Subscriptions.setNameForDirectRoomsWithOldName(previousUsername, username);                        // 67
		var fileStore = FileUpload.getStore('Avatars');                                                                      // 69
		var file = fileStore.model.findOneByName(previousUsername);                                                          // 70
                                                                                                                       //
		if (file) {                                                                                                          // 71
			fileStore.model.updateFileNameById(file._id, username);                                                             // 72
		}                                                                                                                    // 73
	} // Set new username*                                                                                                // 74
                                                                                                                       //
                                                                                                                       //
	RocketChat.models.Users.setUsername(user._id, username);                                                              // 76
	return user;                                                                                                          // 77
};                                                                                                                     // 78
                                                                                                                       //
RocketChat.setUsername = RocketChat.RateLimiter.limitFunction(RocketChat._setUsername, 1, 60000, (_RocketChat$RateLimit = {}, _RocketChat$RateLimit[0] = function (userId) {
	return !userId || !RocketChat.authz.hasPermission(userId, 'edit-other-user-info');                                    // 82
}, _RocketChat$RateLimit));                                                                                            // 83
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setRealName.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/setRealName.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat._setRealName = function (userId, name) {                                                                    // 1
	name = s.trim(name);                                                                                                  // 2
                                                                                                                       //
	if (!userId || !name) {                                                                                               // 3
		return false;                                                                                                        // 4
	}                                                                                                                     // 5
                                                                                                                       //
	var user = RocketChat.models.Users.findOneById(userId); // User already has desired name, return                      // 7
                                                                                                                       //
	if (user.name === name) {                                                                                             // 10
		return user;                                                                                                         // 11
	} // Set new name                                                                                                     // 12
                                                                                                                       //
                                                                                                                       //
	RocketChat.models.Users.setName(user._id, name);                                                                      // 15
	user.name = name;                                                                                                     // 16
                                                                                                                       //
	if (RocketChat.settings.get('UI_Use_Real_Name') === true) {                                                           // 18
		RocketChat.Notifications.notifyLogged('Users:NameChanged', {                                                         // 19
			_id: user._id,                                                                                                      // 20
			name: user.name,                                                                                                    // 21
			username: user.username                                                                                             // 22
		});                                                                                                                  // 19
	}                                                                                                                     // 24
                                                                                                                       //
	return user;                                                                                                          // 26
};                                                                                                                     // 27
                                                                                                                       //
RocketChat.setRealName = RocketChat.RateLimiter.limitFunction(RocketChat._setRealName, 1, 60000, {                     // 29
	0: function () {                                                                                                      // 30
		return !Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'edit-other-user-info');                 // 30
	} // Administrators have permission to change others names, so don't limit those                                      // 30
                                                                                                                       //
});                                                                                                                    // 29
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setEmail.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/setEmail.js                                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat._setEmail = function (userId, email) {                                                                      // 1
	email = s.trim(email);                                                                                                // 2
                                                                                                                       //
	if (!userId) {                                                                                                        // 3
		throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                       // 4
			"function": '_setEmail'                                                                                             // 4
		});                                                                                                                  // 4
	}                                                                                                                     // 5
                                                                                                                       //
	if (!email) {                                                                                                         // 7
		throw new Meteor.Error('error-invalid-email', 'Invalid email', {                                                     // 8
			"function": '_setEmail'                                                                                             // 8
		});                                                                                                                  // 8
	}                                                                                                                     // 9
                                                                                                                       //
	RocketChat.validateEmailDomain(email);                                                                                // 11
	var user = RocketChat.models.Users.findOneById(userId); // User already has desired username, return                  // 13
                                                                                                                       //
	if (user.emails && user.emails[0] && user.emails[0].address === email) {                                              // 16
		return user;                                                                                                         // 17
	} // Check email availability                                                                                         // 18
                                                                                                                       //
                                                                                                                       //
	if (!RocketChat.checkEmailAvailability(email)) {                                                                      // 21
		throw new Meteor.Error('error-field-unavailable', email + " is already in use :(", {                                 // 22
			"function": '_setEmail',                                                                                            // 22
			field: email                                                                                                        // 22
		});                                                                                                                  // 22
	} // Set new email                                                                                                    // 23
                                                                                                                       //
                                                                                                                       //
	RocketChat.models.Users.setEmail(user._id, email);                                                                    // 26
	user.email = email;                                                                                                   // 27
	return user;                                                                                                          // 28
};                                                                                                                     // 29
                                                                                                                       //
RocketChat.setEmail = RocketChat.RateLimiter.limitFunction(RocketChat._setEmail, 1, 60000, {                           // 31
	0: function () {                                                                                                      // 32
		return !Meteor.userId() || !RocketChat.authz.hasPermission(Meteor.userId(), 'edit-other-user-info');                 // 32
	} // Administrators have permission to change others emails, so don't limit those                                     // 32
                                                                                                                       //
});                                                                                                                    // 31
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"unarchiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/unarchiveRoom.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.unarchiveRoom = function (rid) {                                                                            // 1
	RocketChat.models.Rooms.unarchiveById(rid);                                                                           // 2
	RocketChat.models.Subscriptions.unarchiveByRoomId(rid);                                                               // 3
};                                                                                                                     // 4
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"updateMessage.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/updateMessage.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.updateMessage = function (message, user) {                                                                  // 1
	// If we keep history of edits, insert a new message to store history information                                     // 2
	if (RocketChat.settings.get('Message_KeepHistory')) {                                                                 // 3
		RocketChat.models.Messages.cloneAndSaveAsHistoryById(message._id);                                                   // 4
	}                                                                                                                     // 5
                                                                                                                       //
	message.editedAt = new Date();                                                                                        // 7
	message.editedBy = {                                                                                                  // 8
		_id: user._id,                                                                                                       // 9
		username: user.username                                                                                              // 10
	};                                                                                                                    // 8
	var urls = message.msg.match(/([A-Za-z]{3,9}):\/\/([-;:&=\+\$,\w]+@{1})?([-A-Za-z0-9\.]+)+:?(\d+)?((\/[-\+=!:~%\/\.@\,\w]*)?\??([-\+=&!:;%@\/\.\,\w]+)?(?:#([^\s\)]+))?)?/g);
                                                                                                                       //
	if (urls) {                                                                                                           // 14
		message.urls = urls.map(function (url) {                                                                             // 15
			return {                                                                                                            // 15
				url: url                                                                                                           // 15
			};                                                                                                                  // 15
		});                                                                                                                  // 15
	}                                                                                                                     // 16
                                                                                                                       //
	message = RocketChat.callbacks.run('beforeSaveMessage', message);                                                     // 18
	var tempid = message._id;                                                                                             // 20
	delete message._id;                                                                                                   // 21
	RocketChat.models.Messages.update({                                                                                   // 23
		_id: tempid                                                                                                          // 23
	}, {                                                                                                                  // 23
		$set: message                                                                                                        // 23
	});                                                                                                                   // 23
	var room = RocketChat.models.Rooms.findOneById(message.rid);                                                          // 25
	Meteor.defer(function () {                                                                                            // 27
		RocketChat.callbacks.run('afterSaveMessage', RocketChat.models.Messages.findOneById(tempid), room, user._id);        // 28
	});                                                                                                                   // 29
};                                                                                                                     // 30
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"validateCustomFields.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/validateCustomFields.js                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.validateCustomFields = function (fields) {                                                                  // 1
	// Special Case:                                                                                                      // 2
	// If an admin didn't set any custom fields there's nothing to validate against so consider any customFields valid    // 3
	if (s.trim(RocketChat.settings.get('Accounts_CustomFields')) === '') {                                                // 4
		return;                                                                                                              // 5
	}                                                                                                                     // 6
                                                                                                                       //
	var customFieldsMeta = void 0;                                                                                        // 8
                                                                                                                       //
	try {                                                                                                                 // 9
		customFieldsMeta = JSON.parse(RocketChat.settings.get('Accounts_CustomFields'));                                     // 10
	} catch (e) {                                                                                                         // 11
		throw new Meteor.Error('error-invalid-customfield-json', 'Invalid JSON for Custom Fields');                          // 12
	}                                                                                                                     // 13
                                                                                                                       //
	var customFields = {};                                                                                                // 15
	Object.keys(customFieldsMeta).forEach(function (fieldName) {                                                          // 17
		var field = customFieldsMeta[fieldName];                                                                             // 18
		customFields[fieldName] = fields[fieldName];                                                                         // 20
		var fieldValue = s.trim(fields[fieldName]);                                                                          // 21
                                                                                                                       //
		if (field.required && fieldValue === '') {                                                                           // 23
			throw new Meteor.Error('error-user-registration-custom-field', "Field " + fieldName + " is required", {             // 24
				method: 'registerUser'                                                                                             // 24
			});                                                                                                                 // 24
		}                                                                                                                    // 25
                                                                                                                       //
		if (field.type === 'select' && field.options.indexOf(fields[fieldName]) === -1) {                                    // 27
			throw new Meteor.Error('error-user-registration-custom-field', "Value for field " + fieldName + " is invalid", {    // 28
				method: 'registerUser'                                                                                             // 28
			});                                                                                                                 // 28
		}                                                                                                                    // 29
                                                                                                                       //
		if (field.maxLength && fieldValue.length > field.maxLength) {                                                        // 31
			throw new Meteor.Error('error-user-registration-custom-field', "Max length of field " + fieldName + " " + field.maxLength, {
				method: 'registerUser'                                                                                             // 32
			});                                                                                                                 // 32
		}                                                                                                                    // 33
                                                                                                                       //
		if (field.minLength && fieldValue.length < field.minLength) {                                                        // 35
			throw new Meteor.Error('error-user-registration-custom-field', "Min length of field " + fieldName + " " + field.minLength, {
				method: 'registerUser'                                                                                             // 36
			});                                                                                                                 // 36
		}                                                                                                                    // 37
	});                                                                                                                   // 38
};                                                                                                                     // 39
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Notifications.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/functions/Notifications.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _slicedToArray2 = require("babel-runtime/helpers/slicedToArray");                                                  //
                                                                                                                       //
var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);                                                         //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.Notifications = new (function () {                                                                          // 1
	function _class() {                                                                                                   // 2
		(0, _classCallCheck3.default)(this, _class);                                                                         // 2
		this.debug = false;                                                                                                  // 3
		this.streamAll = new Meteor.Streamer('notify-all');                                                                  // 4
		this.streamLogged = new Meteor.Streamer('notify-logged');                                                            // 5
		this.streamRoom = new Meteor.Streamer('notify-room');                                                                // 6
		this.streamRoomUsers = new Meteor.Streamer('notify-room-users');                                                     // 7
		this.streamUser = new Meteor.Streamer('notify-user');                                                                // 8
		this.streamAll.allowWrite('none');                                                                                   // 9
		this.streamLogged.allowWrite('none');                                                                                // 10
		this.streamRoom.allowWrite('none');                                                                                  // 11
		this.streamRoomUsers.allowWrite(function (eventName) {                                                               // 12
			for (var _len = arguments.length, args = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {           // 12
				args[_key - 1] = arguments[_key];                                                                                  // 12
			}                                                                                                                   // 12
                                                                                                                       //
			var _eventName$split = eventName.split('/'),                                                                        // 12
			    _eventName$split2 = (0, _slicedToArray3.default)(_eventName$split, 2),                                          // 12
			    roomId = _eventName$split2[0],                                                                                  // 12
			    e = _eventName$split2[1]; // const user = Meteor.users.findOne(this.userId, {                                   // 12
			// 	fields: {                                                                                                       // 15
			// 		username: 1                                                                                                    // 16
			// 	}                                                                                                               // 17
			// });                                                                                                              // 18
                                                                                                                       //
                                                                                                                       //
			if (RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(roomId, this.userId) != null) {                        // 19
				var subscriptions = RocketChat.models.Subscriptions.findByRoomIdAndNotUserId(roomId, this.userId).fetch();         // 20
				subscriptions.forEach(function (subscription) {                                                                    // 21
					var _RocketChat$Notificat;                                                                                        // 21
                                                                                                                       //
					return (_RocketChat$Notificat = RocketChat.Notifications).notifyUser.apply(_RocketChat$Notificat, [subscription.u._id, e].concat(args));
				});                                                                                                                // 21
			}                                                                                                                   // 22
                                                                                                                       //
			return false;                                                                                                       // 23
		});                                                                                                                  // 24
		this.streamUser.allowWrite('logged');                                                                                // 25
		this.streamAll.allowRead('all');                                                                                     // 26
		this.streamLogged.allowRead('logged');                                                                               // 27
		this.streamRoom.allowRead(function (eventName) {                                                                     // 28
			if (this.userId == null) {                                                                                          // 29
				return false;                                                                                                      // 30
			}                                                                                                                   // 31
                                                                                                                       //
			var _eventName$split3 = eventName.split('/'),                                                                       // 28
			    _eventName$split4 = (0, _slicedToArray3.default)(_eventName$split3, 1),                                         // 28
			    roomId = _eventName$split4[0];                                                                                  // 28
                                                                                                                       //
			var user = Meteor.users.findOne(this.userId, {                                                                      // 33
				fields: {                                                                                                          // 34
					username: 1                                                                                                       // 35
				}                                                                                                                  // 34
			});                                                                                                                 // 33
			var room = RocketChat.models.Rooms.findOneById(roomId);                                                             // 38
                                                                                                                       //
			if (!room) {                                                                                                        // 39
				console.warn("Invalid streamRoom eventName: \"" + eventName + "\"");                                               // 40
				return false;                                                                                                      // 41
			}                                                                                                                   // 42
                                                                                                                       //
			if (room.t === 'l' && room.v._id === user._id) {                                                                    // 43
				return true;                                                                                                       // 44
			}                                                                                                                   // 45
                                                                                                                       //
			return room.usernames.indexOf(user.username) > -1;                                                                  // 46
		});                                                                                                                  // 47
		this.streamRoomUsers.allowRead('none');                                                                              // 48
		this.streamUser.allowRead(function (eventName) {                                                                     // 49
			var _eventName$split5 = eventName.split('/'),                                                                       // 49
			    _eventName$split6 = (0, _slicedToArray3.default)(_eventName$split5, 1),                                         // 49
			    userId = _eventName$split6[0];                                                                                  // 49
                                                                                                                       //
			return this.userId != null && this.userId === userId;                                                               // 51
		});                                                                                                                  // 52
	}                                                                                                                     // 53
                                                                                                                       //
	_class.prototype.notifyAll = function () {                                                                            // 1
		function notifyAll(eventName) {                                                                                      // 1
			for (var _len2 = arguments.length, args = Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {    // 55
				args[_key2 - 1] = arguments[_key2];                                                                                // 55
			}                                                                                                                   // 55
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 56
				console.log('notifyAll', arguments);                                                                               // 57
			}                                                                                                                   // 58
                                                                                                                       //
			args.unshift(eventName);                                                                                            // 59
			return this.streamAll.emit.apply(this.streamAll, args);                                                             // 60
		}                                                                                                                    // 61
                                                                                                                       //
		return notifyAll;                                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.notifyLogged = function () {                                                                         // 1
		function notifyLogged(eventName) {                                                                                   // 1
			for (var _len3 = arguments.length, args = Array(_len3 > 1 ? _len3 - 1 : 0), _key3 = 1; _key3 < _len3; _key3++) {    // 63
				args[_key3 - 1] = arguments[_key3];                                                                                // 63
			}                                                                                                                   // 63
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 64
				console.log('notifyLogged', arguments);                                                                            // 65
			}                                                                                                                   // 66
                                                                                                                       //
			args.unshift(eventName);                                                                                            // 67
			return this.streamLogged.emit.apply(this.streamLogged, args);                                                       // 68
		}                                                                                                                    // 69
                                                                                                                       //
		return notifyLogged;                                                                                                 // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.notifyRoom = function () {                                                                           // 1
		function notifyRoom(room, eventName) {                                                                               // 1
			for (var _len4 = arguments.length, args = Array(_len4 > 2 ? _len4 - 2 : 0), _key4 = 2; _key4 < _len4; _key4++) {    // 71
				args[_key4 - 2] = arguments[_key4];                                                                                // 71
			}                                                                                                                   // 71
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 72
				console.log('notifyRoom', arguments);                                                                              // 73
			}                                                                                                                   // 74
                                                                                                                       //
			args.unshift(room + "/" + eventName);                                                                               // 75
			return this.streamRoom.emit.apply(this.streamRoom, args);                                                           // 76
		}                                                                                                                    // 77
                                                                                                                       //
		return notifyRoom;                                                                                                   // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.notifyUser = function () {                                                                           // 1
		function notifyUser(userId, eventName) {                                                                             // 1
			for (var _len5 = arguments.length, args = Array(_len5 > 2 ? _len5 - 2 : 0), _key5 = 2; _key5 < _len5; _key5++) {    // 79
				args[_key5 - 2] = arguments[_key5];                                                                                // 79
			}                                                                                                                   // 79
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 80
				console.log('notifyUser', arguments);                                                                              // 81
			}                                                                                                                   // 82
                                                                                                                       //
			args.unshift(userId + "/" + eventName);                                                                             // 83
			return this.streamUser.emit.apply(this.streamUser, args);                                                           // 84
		}                                                                                                                    // 85
                                                                                                                       //
		return notifyUser;                                                                                                   // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.notifyAllInThisInstance = function () {                                                              // 1
		function notifyAllInThisInstance(eventName) {                                                                        // 1
			for (var _len6 = arguments.length, args = Array(_len6 > 1 ? _len6 - 1 : 0), _key6 = 1; _key6 < _len6; _key6++) {    // 87
				args[_key6 - 1] = arguments[_key6];                                                                                // 87
			}                                                                                                                   // 87
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 88
				console.log('notifyAll', arguments);                                                                               // 89
			}                                                                                                                   // 90
                                                                                                                       //
			args.unshift(eventName);                                                                                            // 91
			return this.streamAll.emitWithoutBroadcast.apply(this.streamAll, args);                                             // 92
		}                                                                                                                    // 93
                                                                                                                       //
		return notifyAllInThisInstance;                                                                                      // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.notifyLoggedInThisInstance = function () {                                                           // 1
		function notifyLoggedInThisInstance(eventName) {                                                                     // 1
			for (var _len7 = arguments.length, args = Array(_len7 > 1 ? _len7 - 1 : 0), _key7 = 1; _key7 < _len7; _key7++) {    // 95
				args[_key7 - 1] = arguments[_key7];                                                                                // 95
			}                                                                                                                   // 95
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 96
				console.log('notifyLogged', arguments);                                                                            // 97
			}                                                                                                                   // 98
                                                                                                                       //
			args.unshift(eventName);                                                                                            // 99
			return this.streamLogged.emitWithoutBroadcast.apply(this.streamLogged, args);                                       // 100
		}                                                                                                                    // 101
                                                                                                                       //
		return notifyLoggedInThisInstance;                                                                                   // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.notifyRoomInThisInstance = function () {                                                             // 1
		function notifyRoomInThisInstance(room, eventName) {                                                                 // 1
			for (var _len8 = arguments.length, args = Array(_len8 > 2 ? _len8 - 2 : 0), _key8 = 2; _key8 < _len8; _key8++) {    // 103
				args[_key8 - 2] = arguments[_key8];                                                                                // 103
			}                                                                                                                   // 103
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 104
				console.log('notifyRoomAndBroadcast', arguments);                                                                  // 105
			}                                                                                                                   // 106
                                                                                                                       //
			args.unshift(room + "/" + eventName);                                                                               // 107
			return this.streamRoom.emitWithoutBroadcast.apply(this.streamRoom, args);                                           // 108
		}                                                                                                                    // 109
                                                                                                                       //
		return notifyRoomInThisInstance;                                                                                     // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.notifyUserInThisInstance = function () {                                                             // 1
		function notifyUserInThisInstance(userId, eventName) {                                                               // 1
			for (var _len9 = arguments.length, args = Array(_len9 > 2 ? _len9 - 2 : 0), _key9 = 2; _key9 < _len9; _key9++) {    // 111
				args[_key9 - 2] = arguments[_key9];                                                                                // 111
			}                                                                                                                   // 111
                                                                                                                       //
			if (this.debug === true) {                                                                                          // 112
				console.log('notifyUserAndBroadcast', arguments);                                                                  // 113
			}                                                                                                                   // 114
                                                                                                                       //
			args.unshift(userId + "/" + eventName);                                                                             // 115
			return this.streamUser.emitWithoutBroadcast.apply(this.streamUser, args);                                           // 116
		}                                                                                                                    // 117
                                                                                                                       //
		return notifyUserInThisInstance;                                                                                     // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	return _class;                                                                                                        // 1
}())();                                                                                                                // 1
RocketChat.Notifications.streamRoom.allowWrite(function (eventName, username) {                                        // 120
	var _eventName$split7 = eventName.split('/'),                                                                         // 120
	    _eventName$split8 = (0, _slicedToArray3.default)(_eventName$split7, 2),                                           // 120
	    e = _eventName$split8[1];                                                                                         // 120
                                                                                                                       //
	if (e === 'webrtc') {                                                                                                 // 122
		return true;                                                                                                         // 123
	}                                                                                                                     // 124
                                                                                                                       //
	if (e === 'typing') {                                                                                                 // 125
		var user = Meteor.users.findOne(this.userId, {                                                                       // 126
			fields: {                                                                                                           // 127
				username: 1                                                                                                        // 128
			}                                                                                                                   // 127
		});                                                                                                                  // 126
                                                                                                                       //
		if (user != null && user.username === username) {                                                                    // 131
			return true;                                                                                                        // 132
		}                                                                                                                    // 133
	}                                                                                                                     // 134
                                                                                                                       //
	return false;                                                                                                         // 135
});                                                                                                                    // 136
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"models":{"_Base.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/_Base.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _createClass2 = require("babel-runtime/helpers/createClass");                                                      //
                                                                                                                       //
var _createClass3 = _interopRequireDefault(_createClass2);                                                             //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var ModelsBaseDb = void 0;                                                                                             // 1
module.watch(require("./_BaseDb"), {                                                                                   // 1
	"default": function (v) {                                                                                             // 1
		ModelsBaseDb = v;                                                                                                    // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
var ModelsBaseCache = void 0;                                                                                          // 1
module.watch(require("./_BaseCache"), {                                                                                // 1
	"default": function (v) {                                                                                             // 1
		ModelsBaseCache = v;                                                                                                 // 1
	}                                                                                                                     // 1
}, 1);                                                                                                                 // 1
RocketChat.models._CacheControl = new Meteor.EnvironmentVariable();                                                    // 4
                                                                                                                       //
var ModelsBase = function () {                                                                                         //
	function ModelsBase(nameOrModel, useCache) {                                                                          // 7
		(0, _classCallCheck3.default)(this, ModelsBase);                                                                     // 7
		this._db = new ModelsBaseDb(nameOrModel, this);                                                                      // 8
		this.model = this._db.model;                                                                                         // 9
		this.collectionName = this._db.collectionName;                                                                       // 10
		this.name = this._db.name;                                                                                           // 11
		this._useCache = useCache === true;                                                                                  // 13
		this.cache = new ModelsBaseCache(this); // TODO_CACHE: remove                                                        // 15
                                                                                                                       //
		this.on = this.cache.on.bind(this.cache);                                                                            // 17
		this.emit = this.cache.emit.bind(this.cache);                                                                        // 18
		this.getDynamicView = this.cache.getDynamicView.bind(this.cache);                                                    // 19
		this.processQueryOptionsOnResult = this.cache.processQueryOptionsOnResult.bind(this.cache); // END_TODO_CACHE        // 20
                                                                                                                       //
		this.db = this;                                                                                                      // 23
                                                                                                                       //
		if (this._useCache) {                                                                                                // 25
			this.db = new this.constructor(this.model, false);                                                                  // 26
		}                                                                                                                    // 27
	}                                                                                                                     // 28
                                                                                                                       //
	ModelsBase.prototype.arrayToCursor = function () {                                                                    //
		function arrayToCursor(data) {                                                                                       //
			return {                                                                                                            // 43
				fetch: function () {                                                                                               // 44
					return data;                                                                                                      // 45
				},                                                                                                                 // 46
				count: function () {                                                                                               // 47
					return data.length;                                                                                               // 48
				},                                                                                                                 // 49
				forEach: function (fn) {                                                                                           // 50
					return data.forEach(fn);                                                                                          // 51
				}                                                                                                                  // 52
			};                                                                                                                  // 43
		}                                                                                                                    // 54
                                                                                                                       //
		return arrayToCursor;                                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.setUpdatedAt = function () {                                                                     //
		function setUpdatedAt() /*record, checkQuery, query*/{                                                               //
			var _db;                                                                                                            // 56
                                                                                                                       //
			return (_db = this._db).setUpdatedAt.apply(_db, arguments);                                                         // 57
		}                                                                                                                    // 58
                                                                                                                       //
		return setUpdatedAt;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.find = function () {                                                                             //
		function find() {                                                                                                    //
			try {                                                                                                               // 61
				var _origin;                                                                                                       // 61
                                                                                                                       //
				return (_origin = this[this.origin]).find.apply(_origin, arguments);                                               // 62
			} catch (e) {                                                                                                       // 63
				var _console;                                                                                                      // 63
                                                                                                                       //
				(_console = console).error.apply(_console, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 65
		}                                                                                                                    // 66
                                                                                                                       //
		return find;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.findOne = function () {                                                                          //
		function findOne() {                                                                                                 //
			try {                                                                                                               // 69
				var _origin2;                                                                                                      // 69
                                                                                                                       //
				return (_origin2 = this[this.origin]).findOne.apply(_origin2, arguments);                                          // 70
			} catch (e) {                                                                                                       // 71
				var _console2;                                                                                                     // 71
                                                                                                                       //
				(_console2 = console).error.apply(_console2, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 73
		}                                                                                                                    // 74
                                                                                                                       //
		return findOne;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.findOneById = function () {                                                                      //
		function findOneById() {                                                                                             //
			try {                                                                                                               // 77
				var _origin3;                                                                                                      // 77
                                                                                                                       //
				return (_origin3 = this[this.origin]).findOneById.apply(_origin3, arguments);                                      // 78
			} catch (e) {                                                                                                       // 79
				var _console3;                                                                                                     // 79
                                                                                                                       //
				(_console3 = console).error.apply(_console3, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 81
		}                                                                                                                    // 82
                                                                                                                       //
		return findOneById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.findOneByIds = function () {                                                                     //
		function findOneByIds(ids, options) {                                                                                //
			check(ids, [String]);                                                                                               // 85
                                                                                                                       //
			try {                                                                                                               // 87
				return this[this.origin].findOneByIds(ids, options);                                                               // 88
			} catch (e) {                                                                                                       // 89
				var _console4;                                                                                                     // 89
                                                                                                                       //
				(_console4 = console).error.apply(_console4, ['Exception on find', e].concat(Array.prototype.slice.call(arguments)));
			}                                                                                                                   // 91
		}                                                                                                                    // 92
                                                                                                                       //
		return findOneByIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.insert = function () {                                                                           //
		function insert() /*record*/{                                                                                        //
			var _db2;                                                                                                           // 94
                                                                                                                       //
			return (_db2 = this._db).insert.apply(_db2, arguments);                                                             // 95
		}                                                                                                                    // 96
                                                                                                                       //
		return insert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.update = function () {                                                                           //
		function update() /*query, update, options*/{                                                                        //
			var _db3;                                                                                                           // 98
                                                                                                                       //
			return (_db3 = this._db).update.apply(_db3, arguments);                                                             // 99
		}                                                                                                                    // 100
                                                                                                                       //
		return update;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.upsert = function () {                                                                           //
		function upsert() /*query, update*/{                                                                                 //
			var _db4;                                                                                                           // 102
                                                                                                                       //
			return (_db4 = this._db).upsert.apply(_db4, arguments);                                                             // 103
		}                                                                                                                    // 104
                                                                                                                       //
		return upsert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.remove = function () {                                                                           //
		function remove() /*query*/{                                                                                         //
			var _db5;                                                                                                           // 106
                                                                                                                       //
			return (_db5 = this._db).remove.apply(_db5, arguments);                                                             // 107
		}                                                                                                                    // 108
                                                                                                                       //
		return remove;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.insertOrUpsert = function () {                                                                   //
		function insertOrUpsert() {                                                                                          //
			var _db6;                                                                                                           // 110
                                                                                                                       //
			return (_db6 = this._db).insertOrUpsert.apply(_db6, arguments);                                                     // 111
		}                                                                                                                    // 112
                                                                                                                       //
		return insertOrUpsert;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.allow = function () {                                                                            //
		function allow() {                                                                                                   //
			var _db7;                                                                                                           // 114
                                                                                                                       //
			return (_db7 = this._db).allow.apply(_db7, arguments);                                                              // 115
		}                                                                                                                    // 116
                                                                                                                       //
		return allow;                                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.deny = function () {                                                                             //
		function deny() {                                                                                                    //
			var _db8;                                                                                                           // 118
                                                                                                                       //
			return (_db8 = this._db).deny.apply(_db8, arguments);                                                               // 119
		}                                                                                                                    // 120
                                                                                                                       //
		return deny;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.ensureIndex = function () {                                                                      //
		function ensureIndex() {                                                                                             //
			var _db9;                                                                                                           // 122
                                                                                                                       //
			return (_db9 = this._db).ensureIndex.apply(_db9, arguments);                                                        // 123
		}                                                                                                                    // 124
                                                                                                                       //
		return ensureIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.dropIndex = function () {                                                                        //
		function dropIndex() {                                                                                               //
			var _db10;                                                                                                          // 126
                                                                                                                       //
			return (_db10 = this._db).dropIndex.apply(_db10, arguments);                                                        // 127
		}                                                                                                                    // 128
                                                                                                                       //
		return dropIndex;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.tryEnsureIndex = function () {                                                                   //
		function tryEnsureIndex() {                                                                                          //
			var _db11;                                                                                                          // 130
                                                                                                                       //
			return (_db11 = this._db).tryEnsureIndex.apply(_db11, arguments);                                                   // 131
		}                                                                                                                    // 132
                                                                                                                       //
		return tryEnsureIndex;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.tryDropIndex = function () {                                                                     //
		function tryDropIndex() {                                                                                            //
			var _db12;                                                                                                          // 134
                                                                                                                       //
			return (_db12 = this._db).tryDropIndex.apply(_db12, arguments);                                                     // 135
		}                                                                                                                    // 136
                                                                                                                       //
		return tryDropIndex;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.trashFind = function () {                                                                        //
		function trashFind() /*query, options*/{                                                                             //
			var _db13;                                                                                                          // 138
                                                                                                                       //
			return (_db13 = this._db).trashFind.apply(_db13, arguments);                                                        // 139
		}                                                                                                                    // 140
                                                                                                                       //
		return trashFind;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBase.prototype.trashFindDeletedAfter = function () {                                                            //
		function trashFindDeletedAfter() /*deletedAt, query, options*/{                                                      //
			var _db14;                                                                                                          // 142
                                                                                                                       //
			return (_db14 = this._db).trashFindDeletedAfter.apply(_db14, arguments);                                            // 143
		}                                                                                                                    // 144
                                                                                                                       //
		return trashFindDeletedAfter;                                                                                        //
	}(); // dinamicTrashFindAfter(method, deletedAt, ...args) {                                                           //
	// 	const scope = {                                                                                                   // 147
	// 		find: (query={}) => {                                                                                            // 148
	// 			return this.trashFindDeletedAfter(deletedAt, query, { fields: {_id: 1, _deletedAt: 1} });                       // 149
	// 		}                                                                                                                // 150
	// 	};                                                                                                                // 151
	// 	scope.model = {                                                                                                   // 153
	// 		find: scope.find                                                                                                 // 154
	// 	};                                                                                                                // 155
	// 	return this[method].apply(scope, args);                                                                           // 157
	// }                                                                                                                  // 158
	// dinamicFindAfter(method, updatedAt, ...args) {                                                                     // 160
	// 	const scope = {                                                                                                   // 161
	// 		find: (query={}, options) => {                                                                                   // 162
	// 			query._updatedAt = {                                                                                            // 163
	// 				$gt: updatedAt                                                                                                 // 164
	// 			};                                                                                                              // 165
	// 			return this.find(query, options);                                                                               // 167
	// 		}                                                                                                                // 168
	// 	};                                                                                                                // 169
	// 	scope.model = {                                                                                                   // 171
	// 		find: scope.find                                                                                                 // 172
	// 	};                                                                                                                // 173
	// 	return this[method].apply(scope, args);                                                                           // 175
	// }                                                                                                                  // 176
	// dinamicFindChangesAfter(method, updatedAt, ...args) {                                                              // 178
	// 	return {                                                                                                          // 179
	// 		update: this.dinamicFindAfter(method, updatedAt, ...args).fetch(),                                               // 180
	// 		remove: this.dinamicTrashFindAfter(method, updatedAt, ...args).fetch()                                           // 181
	// 	};                                                                                                                // 182
	// }                                                                                                                  // 183
                                                                                                                       //
                                                                                                                       //
	(0, _createClass3.default)(ModelsBase, [{                                                                             //
		key: "useCache",                                                                                                     //
		get: function () {                                                                                                   //
			if (RocketChat.models._CacheControl.get() === false) {                                                              // 31
				return false;                                                                                                      // 32
			}                                                                                                                   // 33
                                                                                                                       //
			return this._useCache;                                                                                              // 35
		}                                                                                                                    // 36
	}, {                                                                                                                  //
		key: "origin",                                                                                                       //
		get: function () {                                                                                                   //
			return this.useCache === true ? 'cache' : '_db';                                                                    // 39
		}                                                                                                                    // 40
	}]);                                                                                                                  //
	return ModelsBase;                                                                                                    //
}();                                                                                                                   //
                                                                                                                       //
RocketChat.models._Base = ModelsBase;                                                                                  // 187
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Avatars.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Avatars.js                                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals InstanceStatus */RocketChat.models.Avatars = new (function (_RocketChat$models$_B) {                        // 1
	(0, _inherits3.default)(_class, _RocketChat$models$_B);                                                               // 3
                                                                                                                       //
	function _class() {                                                                                                   // 4
		(0, _classCallCheck3.default)(this, _class);                                                                         // 4
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.call(this, 'avatars'));             // 4
                                                                                                                       //
		_this.model.before.insert(function (userId, doc) {                                                                   // 7
			doc.instanceId = InstanceStatus.id();                                                                               // 8
		});                                                                                                                  // 9
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 11
			name: 1                                                                                                             // 11
		});                                                                                                                  // 11
                                                                                                                       //
		return _this;                                                                                                        // 4
	}                                                                                                                     // 12
                                                                                                                       //
	_class.prototype.insertAvatarFileInit = function () {                                                                 // 3
		function insertAvatarFileInit(name, userId, store, file, extra) {                                                    // 3
			var fileData = {                                                                                                    // 15
				_id: name,                                                                                                         // 16
				name: name,                                                                                                        // 17
				userId: userId,                                                                                                    // 18
				store: store,                                                                                                      // 19
				complete: false,                                                                                                   // 20
				uploading: true,                                                                                                   // 21
				progress: 0,                                                                                                       // 22
				extension: s.strRightBack(file.name, '.'),                                                                         // 23
				uploadedAt: new Date()                                                                                             // 24
			};                                                                                                                  // 15
                                                                                                                       //
			_.extend(fileData, file, extra);                                                                                    // 27
                                                                                                                       //
			return this.insertOrUpsert(fileData);                                                                               // 29
		}                                                                                                                    // 30
                                                                                                                       //
		return insertAvatarFileInit;                                                                                         // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.updateFileComplete = function () {                                                                   // 3
		function updateFileComplete(fileId, userId, file) {                                                                  // 3
			if (!fileId) {                                                                                                      // 33
				return;                                                                                                            // 34
			}                                                                                                                   // 35
                                                                                                                       //
			var filter = {                                                                                                      // 37
				_id: fileId,                                                                                                       // 38
				userId: userId                                                                                                     // 39
			};                                                                                                                  // 37
			var update = {                                                                                                      // 42
				$set: {                                                                                                            // 43
					complete: true,                                                                                                   // 44
					uploading: false,                                                                                                 // 45
					progress: 1                                                                                                       // 46
				}                                                                                                                  // 43
			};                                                                                                                  // 42
			update.$set = _.extend(file, update.$set);                                                                          // 50
                                                                                                                       //
			if (this.model.direct && this.model.direct.update) {                                                                // 52
				return this.model.direct.update(filter, update);                                                                   // 53
			} else {                                                                                                            // 54
				return this.update(filter, update);                                                                                // 55
			}                                                                                                                   // 56
		}                                                                                                                    // 57
                                                                                                                       //
		return updateFileComplete;                                                                                           // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.findOneByName = function () {                                                                        // 3
		function findOneByName(name) {                                                                                       // 3
			return this.findOne({                                                                                               // 60
				name: name                                                                                                         // 60
			});                                                                                                                 // 60
		}                                                                                                                    // 61
                                                                                                                       //
		return findOneByName;                                                                                                // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.updateFileNameById = function () {                                                                   // 3
		function updateFileNameById(fileId, name) {                                                                          // 3
			var filter = {                                                                                                      // 64
				_id: fileId                                                                                                        // 64
			};                                                                                                                  // 64
			var update = {                                                                                                      // 65
				$set: {                                                                                                            // 66
					name: name                                                                                                        // 67
				}                                                                                                                  // 66
			};                                                                                                                  // 65
                                                                                                                       //
			if (this.model.direct && this.model.direct.update) {                                                                // 70
				return this.model.direct.update(filter, update);                                                                   // 71
			} else {                                                                                                            // 72
				return this.update(filter, update);                                                                                // 73
			}                                                                                                                   // 74
		}                                                                                                                    // 75
                                                                                                                       //
		return updateFileNameById;                                                                                           // 3
	}(); // @TODO deprecated                                                                                              // 3
                                                                                                                       //
                                                                                                                       //
	_class.prototype.updateFileCompleteByNameAndUserId = function () {                                                    // 3
		function updateFileCompleteByNameAndUserId(name, userId, url) {                                                      // 3
			if (!name) {                                                                                                        // 79
				return;                                                                                                            // 80
			}                                                                                                                   // 81
                                                                                                                       //
			var filter = {                                                                                                      // 83
				name: name,                                                                                                        // 84
				userId: userId                                                                                                     // 85
			};                                                                                                                  // 83
			var update = {                                                                                                      // 88
				$set: {                                                                                                            // 89
					complete: true,                                                                                                   // 90
					uploading: false,                                                                                                 // 91
					progress: 1,                                                                                                      // 92
					url: url                                                                                                          // 93
				}                                                                                                                  // 89
			};                                                                                                                  // 88
                                                                                                                       //
			if (this.model.direct && this.model.direct.update) {                                                                // 97
				return this.model.direct.update(filter, update);                                                                   // 98
			} else {                                                                                                            // 99
				return this.update(filter, update);                                                                                // 100
			}                                                                                                                   // 101
		}                                                                                                                    // 102
                                                                                                                       //
		return updateFileCompleteByNameAndUserId;                                                                            // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.deleteFile = function () {                                                                           // 3
		function deleteFile(fileId) {                                                                                        // 3
			if (this.model.direct && this.model.direct.remove) {                                                                // 105
				return this.model.direct.remove({                                                                                  // 106
					_id: fileId                                                                                                       // 106
				});                                                                                                                // 106
			} else {                                                                                                            // 107
				return this.remove({                                                                                               // 108
					_id: fileId                                                                                                       // 108
				});                                                                                                                // 108
			}                                                                                                                   // 109
		}                                                                                                                    // 110
                                                                                                                       //
		return deleteFile;                                                                                                   // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	return _class;                                                                                                        // 3
}(RocketChat.models._Base))();                                                                                         // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Messages.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Messages.js                                                                   //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _slicedToArray2 = require("babel-runtime/helpers/slicedToArray");                                                  //
                                                                                                                       //
var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);                                                         //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.models.Messages = new (function (_RocketChat$models$_B) {                                                   // 1
	(0, _inherits3.default)(_class, _RocketChat$models$_B);                                                               // 1
                                                                                                                       //
	function _class() {                                                                                                   // 2
		(0, _classCallCheck3.default)(this, _class);                                                                         // 2
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.call(this, 'message'));             // 2
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 5
			'rid': 1,                                                                                                           // 5
			'ts': 1                                                                                                             // 5
		});                                                                                                                  // 5
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 6
			'ts': 1                                                                                                             // 6
		});                                                                                                                  // 6
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 7
			'u._id': 1                                                                                                          // 7
		});                                                                                                                  // 7
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 8
			'editedAt': 1                                                                                                       // 8
		}, {                                                                                                                 // 8
			sparse: 1                                                                                                           // 8
		});                                                                                                                  // 8
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 9
			'editedBy._id': 1                                                                                                   // 9
		}, {                                                                                                                 // 9
			sparse: 1                                                                                                           // 9
		});                                                                                                                  // 9
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 10
			'rid': 1,                                                                                                           // 10
			't': 1,                                                                                                             // 10
			'u._id': 1                                                                                                          // 10
		});                                                                                                                  // 10
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 11
			'expireAt': 1                                                                                                       // 11
		}, {                                                                                                                 // 11
			expireAfterSeconds: 0                                                                                               // 11
		});                                                                                                                  // 11
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 12
			'msg': 'text'                                                                                                       // 12
		});                                                                                                                  // 12
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 13
			'file._id': 1                                                                                                       // 13
		}, {                                                                                                                 // 13
			sparse: 1                                                                                                           // 13
		});                                                                                                                  // 13
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 14
			'mentions.username': 1                                                                                              // 14
		}, {                                                                                                                 // 14
			sparse: 1                                                                                                           // 14
		});                                                                                                                  // 14
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 15
			'pinned': 1                                                                                                         // 15
		}, {                                                                                                                 // 15
			sparse: 1                                                                                                           // 15
		});                                                                                                                  // 15
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 16
			'snippeted': 1                                                                                                      // 16
		}, {                                                                                                                 // 16
			sparse: 1                                                                                                           // 16
		});                                                                                                                  // 16
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 17
			'location': '2dsphere'                                                                                              // 17
		});                                                                                                                  // 17
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 18
			'slackBotId': 1,                                                                                                    // 18
			'slackTs': 1                                                                                                        // 18
		}, {                                                                                                                 // 18
			sparse: 1                                                                                                           // 18
		});                                                                                                                  // 18
                                                                                                                       //
		return _this;                                                                                                        // 2
	} // FIND                                                                                                             // 19
                                                                                                                       //
                                                                                                                       //
	_class.prototype.findByMention = function () {                                                                        // 1
		function findByMention(username, options) {                                                                          // 1
			var query = {                                                                                                       // 23
				'mentions.username': username                                                                                      // 23
			};                                                                                                                  // 23
			return this.find(query, options);                                                                                   // 25
		}                                                                                                                    // 26
                                                                                                                       //
		return findByMention;                                                                                                // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByMentionAndRoomId = function () {                                                        // 1
		function findVisibleByMentionAndRoomId(username, rid, options) {                                                     // 1
			var query = {                                                                                                       // 29
				_hidden: {                                                                                                         // 30
					$ne: true                                                                                                         // 30
				},                                                                                                                 // 30
				'mentions.username': username,                                                                                     // 31
				rid: rid                                                                                                           // 32
			};                                                                                                                  // 29
			return this.find(query, options);                                                                                   // 35
		}                                                                                                                    // 36
                                                                                                                       //
		return findVisibleByMentionAndRoomId;                                                                                // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomId = function () {                                                                  // 1
		function findVisibleByRoomId(roomId, options) {                                                                      // 1
			var query = {                                                                                                       // 39
				_hidden: {                                                                                                         // 40
					$ne: true                                                                                                         // 41
				},                                                                                                                 // 40
				rid: roomId                                                                                                        // 44
			};                                                                                                                  // 39
			return this.find(query, options);                                                                                   // 47
		}                                                                                                                    // 48
                                                                                                                       //
		return findVisibleByRoomId;                                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdNotContainingTypes = function () {                                                // 1
		function findVisibleByRoomIdNotContainingTypes(roomId, types, options) {                                             // 1
			var query = {                                                                                                       // 51
				_hidden: {                                                                                                         // 52
					$ne: true                                                                                                         // 53
				},                                                                                                                 // 52
				rid: roomId                                                                                                        // 56
			};                                                                                                                  // 51
                                                                                                                       //
			if (Match.test(types, [String]) && types.length > 0) {                                                              // 59
				query.t = {                                                                                                        // 60
					$nin: types                                                                                                       // 61
				};                                                                                                                 // 61
			}                                                                                                                   // 62
                                                                                                                       //
			return this.find(query, options);                                                                                   // 64
		}                                                                                                                    // 65
                                                                                                                       //
		return findVisibleByRoomIdNotContainingTypes;                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findInvisibleByRoomId = function () {                                                                // 1
		function findInvisibleByRoomId(roomId, options) {                                                                    // 1
			var query = {                                                                                                       // 68
				_hidden: true,                                                                                                     // 69
				rid: roomId                                                                                                        // 70
			};                                                                                                                  // 68
			return this.find(query, options);                                                                                   // 73
		}                                                                                                                    // 74
                                                                                                                       //
		return findInvisibleByRoomId;                                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdAfterTimestamp = function () {                                                    // 1
		function findVisibleByRoomIdAfterTimestamp(roomId, timestamp, options) {                                             // 1
			var query = {                                                                                                       // 77
				_hidden: {                                                                                                         // 78
					$ne: true                                                                                                         // 79
				},                                                                                                                 // 78
				rid: roomId,                                                                                                       // 81
				ts: {                                                                                                              // 82
					$gt: timestamp                                                                                                    // 83
				}                                                                                                                  // 82
			};                                                                                                                  // 77
			return this.find(query, options);                                                                                   // 87
		}                                                                                                                    // 88
                                                                                                                       //
		return findVisibleByRoomIdAfterTimestamp;                                                                            // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdBeforeTimestamp = function () {                                                   // 1
		function findVisibleByRoomIdBeforeTimestamp(roomId, timestamp, options) {                                            // 1
			var query = {                                                                                                       // 91
				_hidden: {                                                                                                         // 92
					$ne: true                                                                                                         // 93
				},                                                                                                                 // 92
				rid: roomId,                                                                                                       // 95
				ts: {                                                                                                              // 96
					$lt: timestamp                                                                                                    // 97
				}                                                                                                                  // 96
			};                                                                                                                  // 91
			return this.find(query, options);                                                                                   // 101
		}                                                                                                                    // 102
                                                                                                                       //
		return findVisibleByRoomIdBeforeTimestamp;                                                                           // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdBeforeTimestampInclusive = function () {                                          // 1
		function findVisibleByRoomIdBeforeTimestampInclusive(roomId, timestamp, options) {                                   // 1
			var query = {                                                                                                       // 105
				_hidden: {                                                                                                         // 106
					$ne: true                                                                                                         // 107
				},                                                                                                                 // 106
				rid: roomId,                                                                                                       // 109
				ts: {                                                                                                              // 110
					$lte: timestamp                                                                                                   // 111
				}                                                                                                                  // 110
			};                                                                                                                  // 105
			return this.find(query, options);                                                                                   // 115
		}                                                                                                                    // 116
                                                                                                                       //
		return findVisibleByRoomIdBeforeTimestampInclusive;                                                                  // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdBetweenTimestamps = function () {                                                 // 1
		function findVisibleByRoomIdBetweenTimestamps(roomId, afterTimestamp, beforeTimestamp, options) {                    // 1
			var query = {                                                                                                       // 119
				_hidden: {                                                                                                         // 120
					$ne: true                                                                                                         // 121
				},                                                                                                                 // 120
				rid: roomId,                                                                                                       // 123
				ts: {                                                                                                              // 124
					$gt: afterTimestamp,                                                                                              // 125
					$lt: beforeTimestamp                                                                                              // 126
				}                                                                                                                  // 124
			};                                                                                                                  // 119
			return this.find(query, options);                                                                                   // 130
		}                                                                                                                    // 131
                                                                                                                       //
		return findVisibleByRoomIdBetweenTimestamps;                                                                         // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdBetweenTimestampsInclusive = function () {                                        // 1
		function findVisibleByRoomIdBetweenTimestampsInclusive(roomId, afterTimestamp, beforeTimestamp, options) {           // 1
			var query = {                                                                                                       // 134
				_hidden: {                                                                                                         // 135
					$ne: true                                                                                                         // 136
				},                                                                                                                 // 135
				rid: roomId,                                                                                                       // 138
				ts: {                                                                                                              // 139
					$gte: afterTimestamp,                                                                                             // 140
					$lte: beforeTimestamp                                                                                             // 141
				}                                                                                                                  // 139
			};                                                                                                                  // 134
			return this.find(query, options);                                                                                   // 145
		}                                                                                                                    // 146
                                                                                                                       //
		return findVisibleByRoomIdBetweenTimestampsInclusive;                                                                // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdBeforeTimestampNotContainingTypes = function () {                                 // 1
		function findVisibleByRoomIdBeforeTimestampNotContainingTypes(roomId, timestamp, types, options) {                   // 1
			var query = {                                                                                                       // 149
				_hidden: {                                                                                                         // 150
					$ne: true                                                                                                         // 151
				},                                                                                                                 // 150
				rid: roomId,                                                                                                       // 153
				ts: {                                                                                                              // 154
					$lt: timestamp                                                                                                    // 155
				}                                                                                                                  // 154
			};                                                                                                                  // 149
                                                                                                                       //
			if (Match.test(types, [String]) && types.length > 0) {                                                              // 159
				query.t = {                                                                                                        // 160
					$nin: types                                                                                                       // 161
				};                                                                                                                 // 161
			}                                                                                                                   // 162
                                                                                                                       //
			return this.find(query, options);                                                                                   // 164
		}                                                                                                                    // 165
                                                                                                                       //
		return findVisibleByRoomIdBeforeTimestampNotContainingTypes;                                                         // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleByRoomIdBetweenTimestampsNotContainingTypes = function () {                               // 1
		function findVisibleByRoomIdBetweenTimestampsNotContainingTypes(roomId, afterTimestamp, beforeTimestamp, types, options) {
			var query = {                                                                                                       // 168
				_hidden: {                                                                                                         // 169
					$ne: true                                                                                                         // 170
				},                                                                                                                 // 169
				rid: roomId,                                                                                                       // 172
				ts: {                                                                                                              // 173
					$gt: afterTimestamp,                                                                                              // 174
					$lt: beforeTimestamp                                                                                              // 175
				}                                                                                                                  // 173
			};                                                                                                                  // 168
                                                                                                                       //
			if (Match.test(types, [String]) && types.length > 0) {                                                              // 179
				query.t = {                                                                                                        // 180
					$nin: types                                                                                                       // 181
				};                                                                                                                 // 181
			}                                                                                                                   // 182
                                                                                                                       //
			return this.find(query, options);                                                                                   // 184
		}                                                                                                                    // 185
                                                                                                                       //
		return findVisibleByRoomIdBetweenTimestampsNotContainingTypes;                                                       // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findVisibleCreatedOrEditedAfterTimestamp = function () {                                             // 1
		function findVisibleCreatedOrEditedAfterTimestamp(timestamp, options) {                                              // 1
			var query = {                                                                                                       // 188
				_hidden: {                                                                                                         // 189
					$ne: true                                                                                                         // 189
				},                                                                                                                 // 189
				$or: [{                                                                                                            // 190
					ts: {                                                                                                             // 191
						$gt: timestamp                                                                                                   // 192
					}                                                                                                                 // 191
				}, {                                                                                                               // 190
					'editedAt': {                                                                                                     // 196
						$gt: timestamp                                                                                                   // 197
					}                                                                                                                 // 196
				}]                                                                                                                 // 195
			};                                                                                                                  // 188
			return this.find(query, options);                                                                                   // 203
		}                                                                                                                    // 204
                                                                                                                       //
		return findVisibleCreatedOrEditedAfterTimestamp;                                                                     // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findStarredByUserAtRoom = function () {                                                              // 1
		function findStarredByUserAtRoom(userId, roomId, options) {                                                          // 1
			var query = {                                                                                                       // 207
				_hidden: {                                                                                                         // 208
					$ne: true                                                                                                         // 208
				},                                                                                                                 // 208
				'starred._id': userId,                                                                                             // 209
				rid: roomId                                                                                                        // 210
			};                                                                                                                  // 207
			return this.find(query, options);                                                                                   // 213
		}                                                                                                                    // 214
                                                                                                                       //
		return findStarredByUserAtRoom;                                                                                      // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findPinnedByRoom = function () {                                                                     // 1
		function findPinnedByRoom(roomId, options) {                                                                         // 1
			var query = {                                                                                                       // 217
				t: {                                                                                                               // 218
					$ne: 'rm'                                                                                                         // 218
				},                                                                                                                 // 218
				_hidden: {                                                                                                         // 219
					$ne: true                                                                                                         // 219
				},                                                                                                                 // 219
				pinned: true,                                                                                                      // 220
				rid: roomId                                                                                                        // 221
			};                                                                                                                  // 217
			return this.find(query, options);                                                                                   // 224
		}                                                                                                                    // 225
                                                                                                                       //
		return findPinnedByRoom;                                                                                             // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findSnippetedByRoom = function () {                                                                  // 1
		function findSnippetedByRoom(roomId, options) {                                                                      // 1
			var query = {                                                                                                       // 228
				_hidden: {                                                                                                         // 229
					$ne: true                                                                                                         // 229
				},                                                                                                                 // 229
				snippeted: true,                                                                                                   // 230
				rid: roomId                                                                                                        // 231
			};                                                                                                                  // 228
			return this.find(query, options);                                                                                   // 234
		}                                                                                                                    // 235
                                                                                                                       //
		return findSnippetedByRoom;                                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.getLastTimestamp = function () {                                                                     // 1
		function getLastTimestamp(options) {                                                                                 // 1
			if (options == null) {                                                                                              // 238
				options = {};                                                                                                      // 238
			}                                                                                                                   // 238
                                                                                                                       //
			var query = {                                                                                                       // 239
				ts: {                                                                                                              // 239
					$exists: 1                                                                                                        // 239
				}                                                                                                                  // 239
			};                                                                                                                  // 239
			options.sort = {                                                                                                    // 240
				ts: -1                                                                                                             // 240
			};                                                                                                                  // 240
			options.limit = 1;                                                                                                  // 241
                                                                                                                       //
			var _find$fetch = this.find(query, options).fetch(),                                                                // 237
			    _find$fetch2 = (0, _slicedToArray3.default)(_find$fetch, 1),                                                    // 237
			    message = _find$fetch2[0];                                                                                      // 237
                                                                                                                       //
			return message && message.ts;                                                                                       // 243
		}                                                                                                                    // 244
                                                                                                                       //
		return getLastTimestamp;                                                                                             // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findByRoomIdAndMessageIds = function () {                                                            // 1
		function findByRoomIdAndMessageIds(rid, messageIds, options) {                                                       // 1
			var query = {                                                                                                       // 247
				rid: rid,                                                                                                          // 248
				_id: {                                                                                                             // 249
					$in: messageIds                                                                                                   // 250
				}                                                                                                                  // 249
			};                                                                                                                  // 247
			return this.find(query, options);                                                                                   // 254
		}                                                                                                                    // 255
                                                                                                                       //
		return findByRoomIdAndMessageIds;                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findOneBySlackBotIdAndSlackTs = function () {                                                        // 1
		function findOneBySlackBotIdAndSlackTs(slackBotId, slackTs) {                                                        // 1
			var query = {                                                                                                       // 258
				slackBotId: slackBotId,                                                                                            // 259
				slackTs: slackTs                                                                                                   // 260
			};                                                                                                                  // 258
			return this.findOne(query);                                                                                         // 263
		}                                                                                                                    // 264
                                                                                                                       //
		return findOneBySlackBotIdAndSlackTs;                                                                                // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.findOneBySlackTs = function () {                                                                     // 1
		function findOneBySlackTs(slackTs) {                                                                                 // 1
			var query = {                                                                                                       // 267
				slackTs: slackTs                                                                                                   // 267
			};                                                                                                                  // 267
			return this.findOne(query);                                                                                         // 269
		}                                                                                                                    // 270
                                                                                                                       //
		return findOneBySlackTs;                                                                                             // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.cloneAndSaveAsHistoryById = function () {                                                            // 1
		function cloneAndSaveAsHistoryById(_id) {                                                                            // 1
			var me = RocketChat.models.Users.findOneById(Meteor.userId());                                                      // 273
			var record = this.findOneById(_id);                                                                                 // 274
			record._hidden = true;                                                                                              // 275
			record.parent = record._id;                                                                                         // 276
			record.editedAt = new Date();                                                                                       // 277
			record.editedBy = {                                                                                                 // 278
				_id: Meteor.userId(),                                                                                              // 279
				username: me.username                                                                                              // 280
			};                                                                                                                  // 278
			delete record._id;                                                                                                  // 282
			return this.insert(record);                                                                                         // 283
		}                                                                                                                    // 284
                                                                                                                       //
		return cloneAndSaveAsHistoryById;                                                                                    // 1
	}(); // UPDATE                                                                                                        // 1
                                                                                                                       //
                                                                                                                       //
	_class.prototype.setHiddenById = function () {                                                                        // 1
		function setHiddenById(_id, hidden) {                                                                                // 1
			if (hidden == null) {                                                                                               // 288
				hidden = true;                                                                                                     // 288
			}                                                                                                                   // 288
                                                                                                                       //
			var query = {                                                                                                       // 289
				_id: _id                                                                                                           // 289
			};                                                                                                                  // 289
			var update = {                                                                                                      // 291
				$set: {                                                                                                            // 292
					_hidden: hidden                                                                                                   // 293
				}                                                                                                                  // 292
			};                                                                                                                  // 291
			return this.update(query, update);                                                                                  // 297
		}                                                                                                                    // 298
                                                                                                                       //
		return setHiddenById;                                                                                                // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.setAsDeletedByIdAndUser = function () {                                                              // 1
		function setAsDeletedByIdAndUser(_id, user) {                                                                        // 1
			var query = {                                                                                                       // 301
				_id: _id                                                                                                           // 301
			};                                                                                                                  // 301
			var update = {                                                                                                      // 303
				$set: {                                                                                                            // 304
					msg: '',                                                                                                          // 305
					t: 'rm',                                                                                                          // 306
					urls: [],                                                                                                         // 307
					mentions: [],                                                                                                     // 308
					attachments: [],                                                                                                  // 309
					reactions: [],                                                                                                    // 310
					editedAt: new Date(),                                                                                             // 311
					editedBy: {                                                                                                       // 312
						_id: user._id,                                                                                                   // 313
						username: user.username                                                                                          // 314
					}                                                                                                                 // 312
				}                                                                                                                  // 304
			};                                                                                                                  // 303
			return this.update(query, update);                                                                                  // 319
		}                                                                                                                    // 320
                                                                                                                       //
		return setAsDeletedByIdAndUser;                                                                                      // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.setPinnedByIdAndUserId = function () {                                                               // 1
		function setPinnedByIdAndUserId(_id, pinnedBy, pinned, pinnedAt) {                                                   // 1
			if (pinned == null) {                                                                                               // 323
				pinned = true;                                                                                                     // 323
			}                                                                                                                   // 323
                                                                                                                       //
			if (pinnedAt == null) {                                                                                             // 324
				pinnedAt = 0;                                                                                                      // 324
			}                                                                                                                   // 324
                                                                                                                       //
			var query = {                                                                                                       // 325
				_id: _id                                                                                                           // 325
			};                                                                                                                  // 325
			var update = {                                                                                                      // 327
				$set: {                                                                                                            // 328
					pinned: pinned,                                                                                                   // 329
					pinnedAt: pinnedAt || new Date(),                                                                                 // 330
					pinnedBy: pinnedBy                                                                                                // 331
				}                                                                                                                  // 328
			};                                                                                                                  // 327
			return this.update(query, update);                                                                                  // 335
		}                                                                                                                    // 336
                                                                                                                       //
		return setPinnedByIdAndUserId;                                                                                       // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.setSnippetedByIdAndUserId = function () {                                                            // 1
		function setSnippetedByIdAndUserId(message, snippetName, snippetedBy, snippeted, snippetedAt) {                      // 1
			if (snippeted == null) {                                                                                            // 339
				snippeted = true;                                                                                                  // 339
			}                                                                                                                   // 339
                                                                                                                       //
			if (snippetedAt == null) {                                                                                          // 340
				snippetedAt = 0;                                                                                                   // 340
			}                                                                                                                   // 340
                                                                                                                       //
			var query = {                                                                                                       // 341
				_id: message._id                                                                                                   // 341
			};                                                                                                                  // 341
			var msg = "```" + message.msg + "```";                                                                              // 343
			var update = {                                                                                                      // 345
				$set: {                                                                                                            // 346
					msg: msg,                                                                                                         // 347
					snippeted: snippeted,                                                                                             // 348
					snippetedAt: snippetedAt || new Date(),                                                                           // 349
					snippetedBy: snippetedBy,                                                                                         // 350
					snippetName: snippetName                                                                                          // 351
				}                                                                                                                  // 346
			};                                                                                                                  // 345
			return this.update(query, update);                                                                                  // 355
		}                                                                                                                    // 356
                                                                                                                       //
		return setSnippetedByIdAndUserId;                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.setUrlsById = function () {                                                                          // 1
		function setUrlsById(_id, urls) {                                                                                    // 1
			var query = {                                                                                                       // 359
				_id: _id                                                                                                           // 359
			};                                                                                                                  // 359
			var update = {                                                                                                      // 361
				$set: {                                                                                                            // 362
					urls: urls                                                                                                        // 363
				}                                                                                                                  // 362
			};                                                                                                                  // 361
			return this.update(query, update);                                                                                  // 367
		}                                                                                                                    // 368
                                                                                                                       //
		return setUrlsById;                                                                                                  // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.updateAllUsernamesByUserId = function () {                                                           // 1
		function updateAllUsernamesByUserId(userId, username) {                                                              // 1
			var query = {                                                                                                       // 371
				'u._id': userId                                                                                                    // 371
			};                                                                                                                  // 371
			var update = {                                                                                                      // 373
				$set: {                                                                                                            // 374
					'u.username': username                                                                                            // 375
				}                                                                                                                  // 374
			};                                                                                                                  // 373
			return this.update(query, update, {                                                                                 // 379
				multi: true                                                                                                        // 379
			});                                                                                                                 // 379
		}                                                                                                                    // 380
                                                                                                                       //
		return updateAllUsernamesByUserId;                                                                                   // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.updateUsernameOfEditByUserId = function () {                                                         // 1
		function updateUsernameOfEditByUserId(userId, username) {                                                            // 1
			var query = {                                                                                                       // 383
				'editedBy._id': userId                                                                                             // 383
			};                                                                                                                  // 383
			var update = {                                                                                                      // 385
				$set: {                                                                                                            // 386
					'editedBy.username': username                                                                                     // 387
				}                                                                                                                  // 386
			};                                                                                                                  // 385
			return this.update(query, update, {                                                                                 // 391
				multi: true                                                                                                        // 391
			});                                                                                                                 // 391
		}                                                                                                                    // 392
                                                                                                                       //
		return updateUsernameOfEditByUserId;                                                                                 // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.updateUsernameAndMessageOfMentionByIdAndOldUsername = function () {                                  // 1
		function updateUsernameAndMessageOfMentionByIdAndOldUsername(_id, oldUsername, newUsername, newMessage) {            // 1
			var query = {                                                                                                       // 395
				_id: _id,                                                                                                          // 396
				'mentions.username': oldUsername                                                                                   // 397
			};                                                                                                                  // 395
			var update = {                                                                                                      // 400
				$set: {                                                                                                            // 401
					'mentions.$.username': newUsername,                                                                               // 402
					'msg': newMessage                                                                                                 // 403
				}                                                                                                                  // 401
			};                                                                                                                  // 400
			return this.update(query, update);                                                                                  // 407
		}                                                                                                                    // 408
                                                                                                                       //
		return updateUsernameAndMessageOfMentionByIdAndOldUsername;                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.updateUserStarById = function () {                                                                   // 1
		function updateUserStarById(_id, userId, starred) {                                                                  // 1
			var update = void 0;                                                                                                // 411
			var query = {                                                                                                       // 412
				_id: _id                                                                                                           // 412
			};                                                                                                                  // 412
                                                                                                                       //
			if (starred) {                                                                                                      // 414
				update = {                                                                                                         // 415
					$addToSet: {                                                                                                      // 416
						starred: {                                                                                                       // 417
							_id: userId                                                                                                     // 417
						}                                                                                                                // 417
					}                                                                                                                 // 416
				};                                                                                                                 // 415
			} else {                                                                                                            // 420
				update = {                                                                                                         // 421
					$pull: {                                                                                                          // 422
						starred: {                                                                                                       // 423
							_id: Meteor.userId()                                                                                            // 423
						}                                                                                                                // 423
					}                                                                                                                 // 422
				};                                                                                                                 // 421
			}                                                                                                                   // 426
                                                                                                                       //
			return this.update(query, update);                                                                                  // 428
		}                                                                                                                    // 429
                                                                                                                       //
		return updateUserStarById;                                                                                           // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.upgradeEtsToEditAt = function () {                                                                   // 1
		function upgradeEtsToEditAt() {                                                                                      // 1
			var query = {                                                                                                       // 432
				ets: {                                                                                                             // 432
					$exists: 1                                                                                                        // 432
				}                                                                                                                  // 432
			};                                                                                                                  // 432
			var update = {                                                                                                      // 434
				$rename: {                                                                                                         // 435
					'ets': 'editedAt'                                                                                                 // 436
				}                                                                                                                  // 435
			};                                                                                                                  // 434
			return this.update(query, update, {                                                                                 // 440
				multi: true                                                                                                        // 440
			});                                                                                                                 // 440
		}                                                                                                                    // 441
                                                                                                                       //
		return upgradeEtsToEditAt;                                                                                           // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.setMessageAttachments = function () {                                                                // 1
		function setMessageAttachments(_id, attachments) {                                                                   // 1
			var query = {                                                                                                       // 444
				_id: _id                                                                                                           // 444
			};                                                                                                                  // 444
			var update = {                                                                                                      // 446
				$set: {                                                                                                            // 447
					attachments: attachments                                                                                          // 448
				}                                                                                                                  // 447
			};                                                                                                                  // 446
			return this.update(query, update);                                                                                  // 452
		}                                                                                                                    // 453
                                                                                                                       //
		return setMessageAttachments;                                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.setSlackBotIdAndSlackTs = function () {                                                              // 1
		function setSlackBotIdAndSlackTs(_id, slackBotId, slackTs) {                                                         // 1
			var query = {                                                                                                       // 456
				_id: _id                                                                                                           // 456
			};                                                                                                                  // 456
			var update = {                                                                                                      // 458
				$set: {                                                                                                            // 459
					slackBotId: slackBotId,                                                                                           // 460
					slackTs: slackTs                                                                                                  // 461
				}                                                                                                                  // 459
			};                                                                                                                  // 458
			return this.update(query, update);                                                                                  // 465
		}                                                                                                                    // 466
                                                                                                                       //
		return setSlackBotIdAndSlackTs;                                                                                      // 1
	}(); // INSERT                                                                                                        // 1
                                                                                                                       //
                                                                                                                       //
	_class.prototype.createWithTypeRoomIdMessageAndUser = function () {                                                   // 1
		function createWithTypeRoomIdMessageAndUser(type, roomId, message, user, extraData) {                                // 1
			var room = RocketChat.models.Rooms.findOneById(roomId, {                                                            // 471
				fields: {                                                                                                          // 471
					sysMes: 1                                                                                                         // 471
				}                                                                                                                  // 471
			});                                                                                                                 // 471
                                                                                                                       //
			if ((room != null ? room.sysMes : undefined) === false) {                                                           // 472
				return;                                                                                                            // 473
			}                                                                                                                   // 474
                                                                                                                       //
			var record = {                                                                                                      // 475
				t: type,                                                                                                           // 476
				rid: roomId,                                                                                                       // 477
				ts: new Date(),                                                                                                    // 478
				msg: message,                                                                                                      // 479
				u: {                                                                                                               // 480
					_id: user._id,                                                                                                    // 481
					username: user.username                                                                                           // 482
				},                                                                                                                 // 480
				groupable: false                                                                                                   // 484
			};                                                                                                                  // 475
                                                                                                                       //
			_.extend(record, extraData);                                                                                        // 487
                                                                                                                       //
			record._id = this.insertOrUpsert(record);                                                                           // 489
			RocketChat.models.Rooms.incMsgCountById(room._id, 1);                                                               // 490
			return record;                                                                                                      // 491
		}                                                                                                                    // 492
                                                                                                                       //
		return createWithTypeRoomIdMessageAndUser;                                                                           // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createUserJoinWithRoomIdAndUser = function () {                                                      // 1
		function createUserJoinWithRoomIdAndUser(roomId, user, extraData) {                                                  // 1
			var message = user.username;                                                                                        // 495
			return this.createWithTypeRoomIdMessageAndUser('uj', roomId, message, user, extraData);                             // 496
		}                                                                                                                    // 497
                                                                                                                       //
		return createUserJoinWithRoomIdAndUser;                                                                              // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createUserLeaveWithRoomIdAndUser = function () {                                                     // 1
		function createUserLeaveWithRoomIdAndUser(roomId, user, extraData) {                                                 // 1
			var message = user.username;                                                                                        // 500
			return this.createWithTypeRoomIdMessageAndUser('ul', roomId, message, user, extraData);                             // 501
		}                                                                                                                    // 502
                                                                                                                       //
		return createUserLeaveWithRoomIdAndUser;                                                                             // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createUserRemovedWithRoomIdAndUser = function () {                                                   // 1
		function createUserRemovedWithRoomIdAndUser(roomId, user, extraData) {                                               // 1
			var message = user.username;                                                                                        // 505
			return this.createWithTypeRoomIdMessageAndUser('ru', roomId, message, user, extraData);                             // 506
		}                                                                                                                    // 507
                                                                                                                       //
		return createUserRemovedWithRoomIdAndUser;                                                                           // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createUserAddedWithRoomIdAndUser = function () {                                                     // 1
		function createUserAddedWithRoomIdAndUser(roomId, user, extraData) {                                                 // 1
			var message = user.username;                                                                                        // 510
			return this.createWithTypeRoomIdMessageAndUser('au', roomId, message, user, extraData);                             // 511
		}                                                                                                                    // 512
                                                                                                                       //
		return createUserAddedWithRoomIdAndUser;                                                                             // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createCommandWithRoomIdAndUser = function () {                                                       // 1
		function createCommandWithRoomIdAndUser(command, roomId, user, extraData) {                                          // 1
			return this.createWithTypeRoomIdMessageAndUser('command', roomId, command, user, extraData);                        // 515
		}                                                                                                                    // 516
                                                                                                                       //
		return createCommandWithRoomIdAndUser;                                                                               // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createUserMutedWithRoomIdAndUser = function () {                                                     // 1
		function createUserMutedWithRoomIdAndUser(roomId, user, extraData) {                                                 // 1
			var message = user.username;                                                                                        // 519
			return this.createWithTypeRoomIdMessageAndUser('user-muted', roomId, message, user, extraData);                     // 520
		}                                                                                                                    // 521
                                                                                                                       //
		return createUserMutedWithRoomIdAndUser;                                                                             // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createUserUnmutedWithRoomIdAndUser = function () {                                                   // 1
		function createUserUnmutedWithRoomIdAndUser(roomId, user, extraData) {                                               // 1
			var message = user.username;                                                                                        // 524
			return this.createWithTypeRoomIdMessageAndUser('user-unmuted', roomId, message, user, extraData);                   // 525
		}                                                                                                                    // 526
                                                                                                                       //
		return createUserUnmutedWithRoomIdAndUser;                                                                           // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createNewModeratorWithRoomIdAndUser = function () {                                                  // 1
		function createNewModeratorWithRoomIdAndUser(roomId, user, extraData) {                                              // 1
			var message = user.username;                                                                                        // 529
			return this.createWithTypeRoomIdMessageAndUser('new-moderator', roomId, message, user, extraData);                  // 530
		}                                                                                                                    // 531
                                                                                                                       //
		return createNewModeratorWithRoomIdAndUser;                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createModeratorRemovedWithRoomIdAndUser = function () {                                              // 1
		function createModeratorRemovedWithRoomIdAndUser(roomId, user, extraData) {                                          // 1
			var message = user.username;                                                                                        // 534
			return this.createWithTypeRoomIdMessageAndUser('moderator-removed', roomId, message, user, extraData);              // 535
		}                                                                                                                    // 536
                                                                                                                       //
		return createModeratorRemovedWithRoomIdAndUser;                                                                      // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createNewOwnerWithRoomIdAndUser = function () {                                                      // 1
		function createNewOwnerWithRoomIdAndUser(roomId, user, extraData) {                                                  // 1
			var message = user.username;                                                                                        // 539
			return this.createWithTypeRoomIdMessageAndUser('new-owner', roomId, message, user, extraData);                      // 540
		}                                                                                                                    // 541
                                                                                                                       //
		return createNewOwnerWithRoomIdAndUser;                                                                              // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createOwnerRemovedWithRoomIdAndUser = function () {                                                  // 1
		function createOwnerRemovedWithRoomIdAndUser(roomId, user, extraData) {                                              // 1
			var message = user.username;                                                                                        // 544
			return this.createWithTypeRoomIdMessageAndUser('owner-removed', roomId, message, user, extraData);                  // 545
		}                                                                                                                    // 546
                                                                                                                       //
		return createOwnerRemovedWithRoomIdAndUser;                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createNewLeaderWithRoomIdAndUser = function () {                                                     // 1
		function createNewLeaderWithRoomIdAndUser(roomId, user, extraData) {                                                 // 1
			var message = user.username;                                                                                        // 549
			return this.createWithTypeRoomIdMessageAndUser('new-leader', roomId, message, user, extraData);                     // 550
		}                                                                                                                    // 551
                                                                                                                       //
		return createNewLeaderWithRoomIdAndUser;                                                                             // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createLeaderRemovedWithRoomIdAndUser = function () {                                                 // 1
		function createLeaderRemovedWithRoomIdAndUser(roomId, user, extraData) {                                             // 1
			var message = user.username;                                                                                        // 554
			return this.createWithTypeRoomIdMessageAndUser('leader-removed', roomId, message, user, extraData);                 // 555
		}                                                                                                                    // 556
                                                                                                                       //
		return createLeaderRemovedWithRoomIdAndUser;                                                                         // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createSubscriptionRoleAddedWithRoomIdAndUser = function () {                                         // 1
		function createSubscriptionRoleAddedWithRoomIdAndUser(roomId, user, extraData) {                                     // 1
			var message = user.username;                                                                                        // 559
			return this.createWithTypeRoomIdMessageAndUser('subscription-role-added', roomId, message, user, extraData);        // 560
		}                                                                                                                    // 561
                                                                                                                       //
		return createSubscriptionRoleAddedWithRoomIdAndUser;                                                                 // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.createSubscriptionRoleRemovedWithRoomIdAndUser = function () {                                       // 1
		function createSubscriptionRoleRemovedWithRoomIdAndUser(roomId, user, extraData) {                                   // 1
			var message = user.username;                                                                                        // 564
			return this.createWithTypeRoomIdMessageAndUser('subscription-role-removed', roomId, message, user, extraData);      // 565
		}                                                                                                                    // 566
                                                                                                                       //
		return createSubscriptionRoleRemovedWithRoomIdAndUser;                                                               // 1
	}(); // REMOVE                                                                                                        // 1
                                                                                                                       //
                                                                                                                       //
	_class.prototype.removeById = function () {                                                                           // 1
		function removeById(_id) {                                                                                           // 1
			var query = {                                                                                                       // 570
				_id: _id                                                                                                           // 570
			};                                                                                                                  // 570
			return this.remove(query);                                                                                          // 572
		}                                                                                                                    // 573
                                                                                                                       //
		return removeById;                                                                                                   // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.removeByRoomId = function () {                                                                       // 1
		function removeByRoomId(roomId) {                                                                                    // 1
			var query = {                                                                                                       // 576
				rid: roomId                                                                                                        // 576
			};                                                                                                                  // 576
			return this.remove(query);                                                                                          // 578
		}                                                                                                                    // 579
                                                                                                                       //
		return removeByRoomId;                                                                                               // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.removeByUserId = function () {                                                                       // 1
		function removeByUserId(userId) {                                                                                    // 1
			var query = {                                                                                                       // 582
				'u._id': userId                                                                                                    // 582
			};                                                                                                                  // 582
			return this.remove(query);                                                                                          // 584
		}                                                                                                                    // 585
                                                                                                                       //
		return removeByUserId;                                                                                               // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	_class.prototype.getMessageByFileId = function () {                                                                   // 1
		function getMessageByFileId(fileID) {                                                                                // 1
			return this.findOne({                                                                                               // 588
				'file._id': fileID                                                                                                 // 588
			});                                                                                                                 // 588
		}                                                                                                                    // 589
                                                                                                                       //
		return getMessageByFileId;                                                                                           // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	return _class;                                                                                                        // 1
}(RocketChat.models._Base))();                                                                                         // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Reports.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Reports.js                                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.models.Reports = new (function (_RocketChat$models$_B) {                                                    // 1
	(0, _inherits3.default)(_class, _RocketChat$models$_B);                                                               // 1
                                                                                                                       //
	function _class() {                                                                                                   // 2
		(0, _classCallCheck3.default)(this, _class);                                                                         // 2
		return (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.call(this, 'reports'));                  // 2
	}                                                                                                                     // 4
                                                                                                                       //
	_class.prototype.createWithMessageDescriptionAndUserId = function () {                                                // 1
		function createWithMessageDescriptionAndUserId(message, description, userId, extraData) {                            // 1
			var record = {                                                                                                      // 6
				message: message,                                                                                                  // 7
				description: description,                                                                                          // 8
				ts: new Date(),                                                                                                    // 9
				userId: userId                                                                                                     // 10
			};                                                                                                                  // 6
                                                                                                                       //
			_.extend(record, extraData);                                                                                        // 12
                                                                                                                       //
			record._id = this.insert(record);                                                                                   // 13
			return record;                                                                                                      // 14
		}                                                                                                                    // 15
                                                                                                                       //
		return createWithMessageDescriptionAndUserId;                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	return _class;                                                                                                        // 1
}(RocketChat.models._Base))();                                                                                         // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Rooms.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Rooms.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var ModelRooms = function (_RocketChat$models$_B) {                                                                    //
	(0, _inherits3.default)(ModelRooms, _RocketChat$models$_B);                                                           //
                                                                                                                       //
	function ModelRooms() {                                                                                               // 2
		(0, _classCallCheck3.default)(this, ModelRooms);                                                                     // 2
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.apply(this, arguments));            // 2
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 5
			'name': 1                                                                                                           // 5
		}, {                                                                                                                 // 5
			unique: 1,                                                                                                          // 5
			sparse: 1                                                                                                           // 5
		});                                                                                                                  // 5
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 6
			'default': 1                                                                                                        // 6
		});                                                                                                                  // 6
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 7
			'usernames': 1                                                                                                      // 7
		});                                                                                                                  // 7
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 8
			't': 1                                                                                                              // 8
		});                                                                                                                  // 8
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 9
			'u._id': 1                                                                                                          // 9
		});                                                                                                                  // 9
                                                                                                                       //
		_this.cache.ignoreUpdatedFields = ['msgs', 'lm'];                                                                    // 11
                                                                                                                       //
		_this.cache.ensureIndex(['t', 'name'], 'unique');                                                                    // 12
                                                                                                                       //
		_this.cache.options = {                                                                                              // 13
			fields: {                                                                                                           // 13
				usernames: 0                                                                                                       // 13
			}                                                                                                                   // 13
		};                                                                                                                   // 13
		return _this;                                                                                                        // 2
	}                                                                                                                     // 14
                                                                                                                       //
	ModelRooms.prototype.findOneByIdOrName = function () {                                                                //
		function findOneByIdOrName(_idOrName, options) {                                                                     //
			var query = {                                                                                                       // 17
				$or: [{                                                                                                            // 18
					_id: _idOrName                                                                                                    // 19
				}, {                                                                                                               // 18
					name: _idOrName                                                                                                   // 21
				}]                                                                                                                 // 20
			};                                                                                                                  // 17
			return this.findOne(query, options);                                                                                // 25
		}                                                                                                                    // 26
                                                                                                                       //
		return findOneByIdOrName;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findOneByImportId = function () {                                                                //
		function findOneByImportId(_id, options) {                                                                           //
			var query = {                                                                                                       // 29
				importIds: _id                                                                                                     // 29
			};                                                                                                                  // 29
			return this.findOne(query, options);                                                                                // 31
		}                                                                                                                    // 32
                                                                                                                       //
		return findOneByImportId;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findOneByName = function () {                                                                    //
		function findOneByName(name, options) {                                                                              //
			var query = {                                                                                                       // 35
				name: name                                                                                                         // 35
			};                                                                                                                  // 35
			return this.findOne(query, options);                                                                                // 37
		}                                                                                                                    // 38
                                                                                                                       //
		return findOneByName;                                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findOneByNameAndNotId = function () {                                                            //
		function findOneByNameAndNotId(name, rid) {                                                                          //
			var query = {                                                                                                       // 41
				_id: {                                                                                                             // 42
					$ne: rid                                                                                                          // 42
				},                                                                                                                 // 42
				name: name                                                                                                         // 43
			};                                                                                                                  // 41
			return this.findOne(query);                                                                                         // 46
		}                                                                                                                    // 47
                                                                                                                       //
		return findOneByNameAndNotId;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findOneByDisplayName = function () {                                                             //
		function findOneByDisplayName(fname, options) {                                                                      //
			var query = {                                                                                                       // 50
				fname: fname                                                                                                       // 50
			};                                                                                                                  // 50
			return this.findOne(query, options);                                                                                // 52
		}                                                                                                                    // 53
                                                                                                                       //
		return findOneByDisplayName;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findOneByNameAndType = function () {                                                             //
		function findOneByNameAndType(name, type, options) {                                                                 //
			var query = {                                                                                                       // 56
				name: name,                                                                                                        // 57
				t: type                                                                                                            // 58
			};                                                                                                                  // 56
			return this.findOne(query, options);                                                                                // 61
		}                                                                                                                    // 62
                                                                                                                       //
		return findOneByNameAndType;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findOneByIdContainingUsername = function () {                                                    //
		function findOneByIdContainingUsername(_id, username, options) {                                                     //
			var query = {                                                                                                       // 65
				_id: _id,                                                                                                          // 66
				usernames: username                                                                                                // 67
			};                                                                                                                  // 65
			return this.findOne(query, options);                                                                                // 70
		}                                                                                                                    // 71
                                                                                                                       //
		return findOneByIdContainingUsername;                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findOneByNameAndTypeNotContainingUsername = function () {                                        //
		function findOneByNameAndTypeNotContainingUsername(name, type, username, options) {                                  //
			var query = {                                                                                                       // 74
				name: name,                                                                                                        // 75
				t: type,                                                                                                           // 76
				usernames: {                                                                                                       // 77
					$ne: username                                                                                                     // 78
				}                                                                                                                  // 77
			};                                                                                                                  // 74
			return this.findOne(query, options);                                                                                // 82
		}                                                                                                                    // 83
                                                                                                                       //
		return findOneByNameAndTypeNotContainingUsername;                                                                    //
	}(); // FIND                                                                                                          //
                                                                                                                       //
                                                                                                                       //
	ModelRooms.prototype.findById = function () {                                                                         //
		function findById(roomId, options) {                                                                                 //
			return this.find({                                                                                                  // 89
				_id: roomId                                                                                                        // 89
			}, options);                                                                                                        // 89
		}                                                                                                                    // 90
                                                                                                                       //
		return findById;                                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByIds = function () {                                                                        //
		function findByIds(roomIds, options) {                                                                               //
			return this.find({                                                                                                  // 93
				_id: {                                                                                                             // 93
					$in: [].concat(roomIds)                                                                                           // 93
				}                                                                                                                  // 93
			}, options);                                                                                                        // 93
		}                                                                                                                    // 94
                                                                                                                       //
		return findByIds;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByType = function () {                                                                       //
		function findByType(type, options) {                                                                                 //
			var query = {                                                                                                       // 97
				t: type                                                                                                            // 97
			};                                                                                                                  // 97
			return this.find(query, options);                                                                                   // 99
		}                                                                                                                    // 100
                                                                                                                       //
		return findByType;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByTypes = function () {                                                                      //
		function findByTypes(types, options) {                                                                               //
			var query = {                                                                                                       // 103
				t: {                                                                                                               // 104
					$in: types                                                                                                        // 105
				}                                                                                                                  // 104
			};                                                                                                                  // 103
			return this.find(query, options);                                                                                   // 109
		}                                                                                                                    // 110
                                                                                                                       //
		return findByTypes;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByUserId = function () {                                                                     //
		function findByUserId(userId, options) {                                                                             //
			var query = {                                                                                                       // 113
				'u._id': userId                                                                                                    // 113
			};                                                                                                                  // 113
			return this.find(query, options);                                                                                   // 115
		}                                                                                                                    // 116
                                                                                                                       //
		return findByUserId;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findBySubscriptionUserId = function () {                                                         //
		function findBySubscriptionUserId(userId, options) {                                                                 //
			var data = void 0;                                                                                                  // 119
                                                                                                                       //
			if (this.useCache) {                                                                                                // 120
				data = RocketChat.models.Subscriptions.findByUserId(userId).fetch();                                               // 121
				data = data.map(function (item) {                                                                                  // 122
					if (item._room) {                                                                                                 // 123
						return item._room;                                                                                               // 124
					}                                                                                                                 // 125
                                                                                                                       //
					console.log('Empty Room for Subscription', item);                                                                 // 126
					return {};                                                                                                        // 127
				});                                                                                                                // 128
				return this.arrayToCursor(this.processQueryOptionsOnResult(data, options));                                        // 129
			}                                                                                                                   // 130
                                                                                                                       //
			data = RocketChat.models.Subscriptions.findByUserId(userId, {                                                       // 132
				fields: {                                                                                                          // 132
					rid: 1                                                                                                            // 132
				}                                                                                                                  // 132
			}).fetch();                                                                                                         // 132
			data = data.map(function (item) {                                                                                   // 133
				return item.rid;                                                                                                   // 133
			});                                                                                                                 // 133
			var query = {                                                                                                       // 135
				_id: {                                                                                                             // 136
					$in: data                                                                                                         // 137
				}                                                                                                                  // 136
			};                                                                                                                  // 135
			return this.find(query, options);                                                                                   // 141
		}                                                                                                                    // 142
                                                                                                                       //
		return findBySubscriptionUserId;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findBySubscriptionUserIdUpdatedAfter = function () {                                             //
		function findBySubscriptionUserIdUpdatedAfter(userId, _updatedAt, options) {                                         //
			if (this.useCache) {                                                                                                // 145
				var data = RocketChat.models.Subscriptions.findByUserId(userId).fetch();                                           // 146
				data = data.map(function (item) {                                                                                  // 147
					if (item._room) {                                                                                                 // 148
						return item._room;                                                                                               // 149
					}                                                                                                                 // 150
                                                                                                                       //
					console.log('Empty Room for Subscription', item);                                                                 // 151
					return {};                                                                                                        // 152
				});                                                                                                                // 153
				data = data.filter(function (item) {                                                                               // 154
					return item._updatedAt > _updatedAt;                                                                              // 154
				});                                                                                                                // 154
				return this.arrayToCursor(this.processQueryOptionsOnResult(data, options));                                        // 155
			}                                                                                                                   // 156
                                                                                                                       //
			var ids = RocketChat.models.Subscriptions.findByUserId(userId, {                                                    // 158
				fields: {                                                                                                          // 158
					rid: 1                                                                                                            // 158
				}                                                                                                                  // 158
			}).fetch();                                                                                                         // 158
			ids = ids.map(function (item) {                                                                                     // 159
				return item.rid;                                                                                                   // 159
			});                                                                                                                 // 159
			var query = {                                                                                                       // 161
				_id: {                                                                                                             // 162
					$in: ids                                                                                                          // 163
				},                                                                                                                 // 162
				_updatedAt: {                                                                                                      // 165
					$gt: _updatedAt                                                                                                   // 166
				}                                                                                                                  // 165
			};                                                                                                                  // 161
			return this.find(query, options);                                                                                   // 170
		}                                                                                                                    // 171
                                                                                                                       //
		return findBySubscriptionUserIdUpdatedAfter;                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByNameContaining = function () {                                                             //
		function findByNameContaining(name, options) {                                                                       //
			var nameRegex = new RegExp(s.trim(s.escapeRegExp(name)), 'i');                                                      // 174
			var query = {                                                                                                       // 176
				$or: [{                                                                                                            // 177
					name: nameRegex                                                                                                   // 178
				}, {                                                                                                               // 178
					t: 'd',                                                                                                           // 180
					usernames: nameRegex                                                                                              // 181
				}]                                                                                                                 // 179
			};                                                                                                                  // 176
			return this.find(query, options);                                                                                   // 186
		}                                                                                                                    // 187
                                                                                                                       //
		return findByNameContaining;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByNameContainingTypesWithUsername = function () {                                            //
		function findByNameContainingTypesWithUsername(name, types, options) {                                               //
			var nameRegex = new RegExp(s.trim(s.escapeRegExp(name)), 'i');                                                      // 190
			var $or = [];                                                                                                       // 192
                                                                                                                       //
			for (var _iterator = Array.from(types), _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
				var _ref;                                                                                                          // 193
                                                                                                                       //
				if (_isArray) {                                                                                                    // 193
					if (_i >= _iterator.length) break;                                                                                // 193
					_ref = _iterator[_i++];                                                                                           // 193
				} else {                                                                                                           // 193
					_i = _iterator.next();                                                                                            // 193
					if (_i.done) break;                                                                                               // 193
					_ref = _i.value;                                                                                                  // 193
				}                                                                                                                  // 193
                                                                                                                       //
				var type = _ref;                                                                                                   // 193
				var obj = {                                                                                                        // 194
					name: nameRegex,                                                                                                  // 194
					t: type.type                                                                                                      // 194
				};                                                                                                                 // 194
                                                                                                                       //
				if (type.username != null) {                                                                                       // 195
					obj.usernames = type.username;                                                                                    // 196
				}                                                                                                                  // 197
                                                                                                                       //
				if (type.ids != null) {                                                                                            // 198
					obj._id = {                                                                                                       // 199
						$in: type.ids                                                                                                    // 199
					};                                                                                                                // 199
				}                                                                                                                  // 200
                                                                                                                       //
				$or.push(obj);                                                                                                     // 201
			}                                                                                                                   // 202
                                                                                                                       //
			var query = {                                                                                                       // 204
				$or: $or                                                                                                           // 204
			};                                                                                                                  // 204
			return this.find(query, options);                                                                                   // 206
		}                                                                                                                    // 207
                                                                                                                       //
		return findByNameContainingTypesWithUsername;                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findContainingTypesWithUsername = function () {                                                  //
		function findContainingTypesWithUsername(types, options) {                                                           //
			var $or = [];                                                                                                       // 211
                                                                                                                       //
			for (var _iterator2 = Array.from(types), _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
				var _ref2;                                                                                                         // 212
                                                                                                                       //
				if (_isArray2) {                                                                                                   // 212
					if (_i2 >= _iterator2.length) break;                                                                              // 212
					_ref2 = _iterator2[_i2++];                                                                                        // 212
				} else {                                                                                                           // 212
					_i2 = _iterator2.next();                                                                                          // 212
					if (_i2.done) break;                                                                                              // 212
					_ref2 = _i2.value;                                                                                                // 212
				}                                                                                                                  // 212
                                                                                                                       //
				var type = _ref2;                                                                                                  // 212
				var obj = {                                                                                                        // 213
					t: type.type                                                                                                      // 213
				};                                                                                                                 // 213
                                                                                                                       //
				if (type.username != null) {                                                                                       // 214
					obj.usernames = type.username;                                                                                    // 215
				}                                                                                                                  // 216
                                                                                                                       //
				if (type.ids != null) {                                                                                            // 217
					obj._id = {                                                                                                       // 218
						$in: type.ids                                                                                                    // 218
					};                                                                                                                // 218
				}                                                                                                                  // 219
                                                                                                                       //
				$or.push(obj);                                                                                                     // 220
			}                                                                                                                   // 221
                                                                                                                       //
			var query = {                                                                                                       // 223
				$or: $or                                                                                                           // 223
			};                                                                                                                  // 223
			return this.find(query, options);                                                                                   // 225
		}                                                                                                                    // 226
                                                                                                                       //
		return findContainingTypesWithUsername;                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByNameContainingAndTypes = function () {                                                     //
		function findByNameContainingAndTypes(name, types, options) {                                                        //
			var nameRegex = new RegExp(s.trim(s.escapeRegExp(name)), 'i');                                                      // 229
			var query = {                                                                                                       // 231
				t: {                                                                                                               // 232
					$in: types                                                                                                        // 233
				},                                                                                                                 // 232
				$or: [{                                                                                                            // 235
					name: nameRegex                                                                                                   // 236
				}, {                                                                                                               // 236
					t: 'd',                                                                                                           // 238
					usernames: nameRegex                                                                                              // 239
				}]                                                                                                                 // 237
			};                                                                                                                  // 231
			return this.find(query, options);                                                                                   // 244
		}                                                                                                                    // 245
                                                                                                                       //
		return findByNameContainingAndTypes;                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByNameAndTypeNotDefault = function () {                                                      //
		function findByNameAndTypeNotDefault(name, type, options) {                                                          //
			var query = {                                                                                                       // 248
				t: type,                                                                                                           // 249
				name: name,                                                                                                        // 250
				"default": {                                                                                                       // 251
					$ne: true                                                                                                         // 252
				}                                                                                                                  // 251
			}; // do not use cache                                                                                              // 248
                                                                                                                       //
			return this._db.find(query, options);                                                                               // 257
		}                                                                                                                    // 258
                                                                                                                       //
		return findByNameAndTypeNotDefault;                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByNameAndTypeNotContainingUsername = function () {                                           //
		function findByNameAndTypeNotContainingUsername(name, type, username, options) {                                     //
			var query = {                                                                                                       // 261
				t: type,                                                                                                           // 262
				name: name,                                                                                                        // 263
				usernames: {                                                                                                       // 264
					$ne: username                                                                                                     // 265
				}                                                                                                                  // 264
			}; // do not use cache                                                                                              // 261
                                                                                                                       //
			return this._db.find(query, options);                                                                               // 270
		}                                                                                                                    // 271
                                                                                                                       //
		return findByNameAndTypeNotContainingUsername;                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByNameStartingAndTypes = function () {                                                       //
		function findByNameStartingAndTypes(name, types, options) {                                                          //
			var nameRegex = new RegExp("^" + s.trim(s.escapeRegExp(name)), 'i');                                                // 274
			var query = {                                                                                                       // 276
				t: {                                                                                                               // 277
					$in: types                                                                                                        // 278
				},                                                                                                                 // 277
				$or: [{                                                                                                            // 280
					name: nameRegex                                                                                                   // 281
				}, {                                                                                                               // 281
					t: 'd',                                                                                                           // 283
					usernames: nameRegex                                                                                              // 284
				}]                                                                                                                 // 282
			};                                                                                                                  // 276
			return this.find(query, options);                                                                                   // 289
		}                                                                                                                    // 290
                                                                                                                       //
		return findByNameStartingAndTypes;                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByDefaultAndTypes = function () {                                                            //
		function findByDefaultAndTypes(defaultValue, types, options) {                                                       //
			var query = {                                                                                                       // 293
				"default": defaultValue,                                                                                           // 294
				t: {                                                                                                               // 295
					$in: types                                                                                                        // 296
				}                                                                                                                  // 295
			};                                                                                                                  // 293
			return this.find(query, options);                                                                                   // 300
		}                                                                                                                    // 301
                                                                                                                       //
		return findByDefaultAndTypes;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByTypeContainingUsername = function () {                                                     //
		function findByTypeContainingUsername(type, username, options) {                                                     //
			var query = {                                                                                                       // 304
				t: type,                                                                                                           // 305
				usernames: username                                                                                                // 306
			};                                                                                                                  // 304
			return this.find(query, options);                                                                                   // 309
		}                                                                                                                    // 310
                                                                                                                       //
		return findByTypeContainingUsername;                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByTypeContainingUsernames = function () {                                                    //
		function findByTypeContainingUsernames(type, username, options) {                                                    //
			var query = {                                                                                                       // 313
				t: type,                                                                                                           // 314
				usernames: {                                                                                                       // 315
					$all: [].concat(username)                                                                                         // 315
				}                                                                                                                  // 315
			};                                                                                                                  // 313
			return this.find(query, options);                                                                                   // 318
		}                                                                                                                    // 319
                                                                                                                       //
		return findByTypeContainingUsernames;                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByTypesAndNotUserIdContainingUsername = function () {                                        //
		function findByTypesAndNotUserIdContainingUsername(types, userId, username, options) {                               //
			var query = {                                                                                                       // 322
				t: {                                                                                                               // 323
					$in: types                                                                                                        // 324
				},                                                                                                                 // 323
				uid: {                                                                                                             // 326
					$ne: userId                                                                                                       // 327
				},                                                                                                                 // 326
				usernames: username                                                                                                // 329
			};                                                                                                                  // 322
			return this.find(query, options);                                                                                   // 332
		}                                                                                                                    // 333
                                                                                                                       //
		return findByTypesAndNotUserIdContainingUsername;                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByContainingUsername = function () {                                                         //
		function findByContainingUsername(username, options) {                                                               //
			var query = {                                                                                                       // 336
				usernames: username                                                                                                // 336
			};                                                                                                                  // 336
			return this.find(query, options);                                                                                   // 338
		}                                                                                                                    // 339
                                                                                                                       //
		return findByContainingUsername;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByTypeAndName = function () {                                                                //
		function findByTypeAndName(type, name, options) {                                                                    //
			if (this.useCache) {                                                                                                // 342
				return this.cache.findByIndex('t,name', [type, name], options);                                                    // 343
			}                                                                                                                   // 344
                                                                                                                       //
			var query = {                                                                                                       // 346
				name: name,                                                                                                        // 347
				t: type                                                                                                            // 348
			};                                                                                                                  // 346
			return this.find(query, options);                                                                                   // 351
		}                                                                                                                    // 352
                                                                                                                       //
		return findByTypeAndName;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByTypeAndNameContainingUsername = function () {                                              //
		function findByTypeAndNameContainingUsername(type, name, username, options) {                                        //
			var query = {                                                                                                       // 355
				name: name,                                                                                                        // 356
				t: type,                                                                                                           // 357
				usernames: username                                                                                                // 358
			};                                                                                                                  // 355
			return this.find(query, options);                                                                                   // 361
		}                                                                                                                    // 362
                                                                                                                       //
		return findByTypeAndNameContainingUsername;                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.findByTypeAndArchivationState = function () {                                                    //
		function findByTypeAndArchivationState(type, archivationstate, options) {                                            //
			var query = {                                                                                                       // 365
				t: type                                                                                                            // 365
			};                                                                                                                  // 365
                                                                                                                       //
			if (archivationstate) {                                                                                             // 367
				query.archived = true;                                                                                             // 368
			} else {                                                                                                            // 369
				query.archived = {                                                                                                 // 370
					$ne: true                                                                                                         // 370
				};                                                                                                                 // 370
			}                                                                                                                   // 371
                                                                                                                       //
			return this.find(query, options);                                                                                   // 373
		}                                                                                                                    // 374
                                                                                                                       //
		return findByTypeAndArchivationState;                                                                                //
	}(); // UPDATE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelRooms.prototype.addImportIds = function () {                                                                     //
		function addImportIds(_id, importIds) {                                                                              //
			importIds = [].concat(importIds);                                                                                   // 378
			var query = {                                                                                                       // 379
				_id: _id                                                                                                           // 379
			};                                                                                                                  // 379
			var update = {                                                                                                      // 381
				$addToSet: {                                                                                                       // 382
					importIds: {                                                                                                      // 383
						$each: importIds                                                                                                 // 384
					}                                                                                                                 // 383
				}                                                                                                                  // 382
			};                                                                                                                  // 381
			return this.update(query, update);                                                                                  // 389
		}                                                                                                                    // 390
                                                                                                                       //
		return addImportIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.archiveById = function () {                                                                      //
		function archiveById(_id) {                                                                                          //
			var query = {                                                                                                       // 393
				_id: _id                                                                                                           // 393
			};                                                                                                                  // 393
			var update = {                                                                                                      // 395
				$set: {                                                                                                            // 396
					archived: true                                                                                                    // 397
				}                                                                                                                  // 396
			};                                                                                                                  // 395
			return this.update(query, update);                                                                                  // 401
		}                                                                                                                    // 402
                                                                                                                       //
		return archiveById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.unarchiveById = function () {                                                                    //
		function unarchiveById(_id) {                                                                                        //
			var query = {                                                                                                       // 405
				_id: _id                                                                                                           // 405
			};                                                                                                                  // 405
			var update = {                                                                                                      // 407
				$set: {                                                                                                            // 408
					archived: false                                                                                                   // 409
				}                                                                                                                  // 408
			};                                                                                                                  // 407
			return this.update(query, update);                                                                                  // 413
		}                                                                                                                    // 414
                                                                                                                       //
		return unarchiveById;                                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.addUsernameById = function () {                                                                  //
		function addUsernameById(_id, username, muted) {                                                                     //
			var query = {                                                                                                       // 417
				_id: _id                                                                                                           // 417
			};                                                                                                                  // 417
			var update = {                                                                                                      // 419
				$addToSet: {                                                                                                       // 420
					usernames: username                                                                                               // 421
				}                                                                                                                  // 420
			};                                                                                                                  // 419
                                                                                                                       //
			if (muted) {                                                                                                        // 425
				update.$addToSet.muted = username;                                                                                 // 426
			}                                                                                                                   // 427
                                                                                                                       //
			return this.update(query, update);                                                                                  // 429
		}                                                                                                                    // 430
                                                                                                                       //
		return addUsernameById;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.addUsernamesById = function () {                                                                 //
		function addUsernamesById(_id, usernames) {                                                                          //
			var query = {                                                                                                       // 433
				_id: _id                                                                                                           // 433
			};                                                                                                                  // 433
			var update = {                                                                                                      // 435
				$addToSet: {                                                                                                       // 436
					usernames: {                                                                                                      // 437
						$each: usernames                                                                                                 // 438
					}                                                                                                                 // 437
				}                                                                                                                  // 436
			};                                                                                                                  // 435
			return this.update(query, update);                                                                                  // 443
		}                                                                                                                    // 444
                                                                                                                       //
		return addUsernamesById;                                                                                             //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.addUsernameByName = function () {                                                                //
		function addUsernameByName(name, username) {                                                                         //
			var query = {                                                                                                       // 447
				name: name                                                                                                         // 447
			};                                                                                                                  // 447
			var update = {                                                                                                      // 449
				$addToSet: {                                                                                                       // 450
					usernames: username                                                                                               // 451
				}                                                                                                                  // 450
			};                                                                                                                  // 449
			return this.update(query, update);                                                                                  // 455
		}                                                                                                                    // 456
                                                                                                                       //
		return addUsernameByName;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.removeUsernameById = function () {                                                               //
		function removeUsernameById(_id, username) {                                                                         //
			var query = {                                                                                                       // 459
				_id: _id                                                                                                           // 459
			};                                                                                                                  // 459
			var update = {                                                                                                      // 461
				$pull: {                                                                                                           // 462
					usernames: username                                                                                               // 463
				}                                                                                                                  // 462
			};                                                                                                                  // 461
			return this.update(query, update);                                                                                  // 467
		}                                                                                                                    // 468
                                                                                                                       //
		return removeUsernameById;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.removeUsernamesById = function () {                                                              //
		function removeUsernamesById(_id, usernames) {                                                                       //
			var query = {                                                                                                       // 471
				_id: _id                                                                                                           // 471
			};                                                                                                                  // 471
			var update = {                                                                                                      // 473
				$pull: {                                                                                                           // 474
					usernames: {                                                                                                      // 475
						$in: usernames                                                                                                   // 476
					}                                                                                                                 // 475
				}                                                                                                                  // 474
			};                                                                                                                  // 473
			return this.update(query, update);                                                                                  // 481
		}                                                                                                                    // 482
                                                                                                                       //
		return removeUsernamesById;                                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.removeUsernameFromAll = function () {                                                            //
		function removeUsernameFromAll(username) {                                                                           //
			var query = {                                                                                                       // 485
				usernames: username                                                                                                // 485
			};                                                                                                                  // 485
			var update = {                                                                                                      // 487
				$pull: {                                                                                                           // 488
					usernames: username                                                                                               // 489
				}                                                                                                                  // 488
			};                                                                                                                  // 487
			return this.update(query, update, {                                                                                 // 493
				multi: true                                                                                                        // 493
			});                                                                                                                 // 493
		}                                                                                                                    // 494
                                                                                                                       //
		return removeUsernameFromAll;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.removeUsernameByName = function () {                                                             //
		function removeUsernameByName(name, username) {                                                                      //
			var query = {                                                                                                       // 497
				name: name                                                                                                         // 497
			};                                                                                                                  // 497
			var update = {                                                                                                      // 499
				$pull: {                                                                                                           // 500
					usernames: username                                                                                               // 501
				}                                                                                                                  // 500
			};                                                                                                                  // 499
			return this.update(query, update);                                                                                  // 505
		}                                                                                                                    // 506
                                                                                                                       //
		return removeUsernameByName;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.setNameById = function () {                                                                      //
		function setNameById(_id, name, fname) {                                                                             //
			var query = {                                                                                                       // 509
				_id: _id                                                                                                           // 509
			};                                                                                                                  // 509
			var update = {                                                                                                      // 511
				$set: {                                                                                                            // 512
					name: name,                                                                                                       // 513
					fname: fname                                                                                                      // 514
				}                                                                                                                  // 512
			};                                                                                                                  // 511
			return this.update(query, update);                                                                                  // 518
		}                                                                                                                    // 519
                                                                                                                       //
		return setNameById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.incMsgCountById = function () {                                                                  //
		function incMsgCountById(_id, inc) {                                                                                 //
			if (inc == null) {                                                                                                  // 522
				inc = 1;                                                                                                           // 522
			}                                                                                                                   // 522
                                                                                                                       //
			var query = {                                                                                                       // 523
				_id: _id                                                                                                           // 523
			};                                                                                                                  // 523
			var update = {                                                                                                      // 525
				$inc: {                                                                                                            // 526
					msgs: inc                                                                                                         // 527
				}                                                                                                                  // 526
			};                                                                                                                  // 525
			return this.update(query, update);                                                                                  // 531
		}                                                                                                                    // 532
                                                                                                                       //
		return incMsgCountById;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.incMsgCountAndSetLastMessageTimestampById = function () {                                        //
		function incMsgCountAndSetLastMessageTimestampById(_id, inc, lastMessageTimestamp) {                                 //
			if (inc == null) {                                                                                                  // 535
				inc = 1;                                                                                                           // 535
			}                                                                                                                   // 535
                                                                                                                       //
			var query = {                                                                                                       // 536
				_id: _id                                                                                                           // 536
			};                                                                                                                  // 536
			var update = {                                                                                                      // 538
				$set: {                                                                                                            // 539
					lm: lastMessageTimestamp                                                                                          // 540
				},                                                                                                                 // 539
				$inc: {                                                                                                            // 542
					msgs: inc                                                                                                         // 543
				}                                                                                                                  // 542
			};                                                                                                                  // 538
			return this.update(query, update);                                                                                  // 547
		}                                                                                                                    // 548
                                                                                                                       //
		return incMsgCountAndSetLastMessageTimestampById;                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.replaceUsername = function () {                                                                  //
		function replaceUsername(previousUsername, username) {                                                               //
			var query = {                                                                                                       // 551
				usernames: previousUsername                                                                                        // 551
			};                                                                                                                  // 551
			var update = {                                                                                                      // 553
				$set: {                                                                                                            // 554
					'usernames.$': username                                                                                           // 555
				}                                                                                                                  // 554
			};                                                                                                                  // 553
			return this.update(query, update, {                                                                                 // 559
				multi: true                                                                                                        // 559
			});                                                                                                                 // 559
		}                                                                                                                    // 560
                                                                                                                       //
		return replaceUsername;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.replaceMutedUsername = function () {                                                             //
		function replaceMutedUsername(previousUsername, username) {                                                          //
			var query = {                                                                                                       // 563
				muted: previousUsername                                                                                            // 563
			};                                                                                                                  // 563
			var update = {                                                                                                      // 565
				$set: {                                                                                                            // 566
					'muted.$': username                                                                                               // 567
				}                                                                                                                  // 566
			};                                                                                                                  // 565
			return this.update(query, update, {                                                                                 // 571
				multi: true                                                                                                        // 571
			});                                                                                                                 // 571
		}                                                                                                                    // 572
                                                                                                                       //
		return replaceMutedUsername;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.replaceUsernameOfUserByUserId = function () {                                                    //
		function replaceUsernameOfUserByUserId(userId, username) {                                                           //
			var query = {                                                                                                       // 575
				'u._id': userId                                                                                                    // 575
			};                                                                                                                  // 575
			var update = {                                                                                                      // 577
				$set: {                                                                                                            // 578
					'u.username': username                                                                                            // 579
				}                                                                                                                  // 578
			};                                                                                                                  // 577
			return this.update(query, update, {                                                                                 // 583
				multi: true                                                                                                        // 583
			});                                                                                                                 // 583
		}                                                                                                                    // 584
                                                                                                                       //
		return replaceUsernameOfUserByUserId;                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.setJoinCodeById = function () {                                                                  //
		function setJoinCodeById(_id, joinCode) {                                                                            //
			var update = void 0;                                                                                                // 587
			var query = {                                                                                                       // 588
				_id: _id                                                                                                           // 588
			};                                                                                                                  // 588
                                                                                                                       //
			if ((joinCode != null ? joinCode.trim() : undefined) !== '') {                                                      // 590
				update = {                                                                                                         // 591
					$set: {                                                                                                           // 592
						joinCodeRequired: true,                                                                                          // 593
						joinCode: joinCode                                                                                               // 594
					}                                                                                                                 // 592
				};                                                                                                                 // 591
			} else {                                                                                                            // 597
				update = {                                                                                                         // 598
					$set: {                                                                                                           // 599
						joinCodeRequired: false                                                                                          // 600
					},                                                                                                                // 599
					$unset: {                                                                                                         // 602
						joinCode: 1                                                                                                      // 603
					}                                                                                                                 // 602
				};                                                                                                                 // 598
			}                                                                                                                   // 606
                                                                                                                       //
			return this.update(query, update);                                                                                  // 608
		}                                                                                                                    // 609
                                                                                                                       //
		return setJoinCodeById;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.setUserById = function () {                                                                      //
		function setUserById(_id, user) {                                                                                    //
			var query = {                                                                                                       // 612
				_id: _id                                                                                                           // 612
			};                                                                                                                  // 612
			var update = {                                                                                                      // 614
				$set: {                                                                                                            // 615
					u: {                                                                                                              // 616
						_id: user._id,                                                                                                   // 617
						username: user.username                                                                                          // 618
					}                                                                                                                 // 616
				}                                                                                                                  // 615
			};                                                                                                                  // 614
			return this.update(query, update);                                                                                  // 623
		}                                                                                                                    // 624
                                                                                                                       //
		return setUserById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.setTypeById = function () {                                                                      //
		function setTypeById(_id, type) {                                                                                    //
			var query = {                                                                                                       // 627
				_id: _id                                                                                                           // 627
			};                                                                                                                  // 627
			var update = {                                                                                                      // 628
				$set: {                                                                                                            // 629
					t: type                                                                                                           // 630
				}                                                                                                                  // 629
			};                                                                                                                  // 628
                                                                                                                       //
			if (type === 'p') {                                                                                                 // 633
				update.$unset = {                                                                                                  // 634
					"default": ''                                                                                                     // 634
				};                                                                                                                 // 634
			}                                                                                                                   // 635
                                                                                                                       //
			return this.update(query, update);                                                                                  // 637
		}                                                                                                                    // 638
                                                                                                                       //
		return setTypeById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.setTopicById = function () {                                                                     //
		function setTopicById(_id, topic) {                                                                                  //
			var query = {                                                                                                       // 641
				_id: _id                                                                                                           // 641
			};                                                                                                                  // 641
			var update = {                                                                                                      // 643
				$set: {                                                                                                            // 644
					topic: topic                                                                                                      // 645
				}                                                                                                                  // 644
			};                                                                                                                  // 643
			return this.update(query, update);                                                                                  // 649
		}                                                                                                                    // 650
                                                                                                                       //
		return setTopicById;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.setAnnouncementById = function () {                                                              //
		function setAnnouncementById(_id, announcement) {                                                                    //
			var query = {                                                                                                       // 653
				_id: _id                                                                                                           // 653
			};                                                                                                                  // 653
			var update = {                                                                                                      // 655
				$set: {                                                                                                            // 656
					announcement: announcement                                                                                        // 657
				}                                                                                                                  // 656
			};                                                                                                                  // 655
			return this.update(query, update);                                                                                  // 661
		}                                                                                                                    // 662
                                                                                                                       //
		return setAnnouncementById;                                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.muteUsernameByRoomId = function () {                                                             //
		function muteUsernameByRoomId(_id, username) {                                                                       //
			var query = {                                                                                                       // 665
				_id: _id                                                                                                           // 665
			};                                                                                                                  // 665
			var update = {                                                                                                      // 667
				$addToSet: {                                                                                                       // 668
					muted: username                                                                                                   // 669
				}                                                                                                                  // 668
			};                                                                                                                  // 667
			return this.update(query, update);                                                                                  // 673
		}                                                                                                                    // 674
                                                                                                                       //
		return muteUsernameByRoomId;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.unmuteUsernameByRoomId = function () {                                                           //
		function unmuteUsernameByRoomId(_id, username) {                                                                     //
			var query = {                                                                                                       // 677
				_id: _id                                                                                                           // 677
			};                                                                                                                  // 677
			var update = {                                                                                                      // 679
				$pull: {                                                                                                           // 680
					muted: username                                                                                                   // 681
				}                                                                                                                  // 680
			};                                                                                                                  // 679
			return this.update(query, update);                                                                                  // 685
		}                                                                                                                    // 686
                                                                                                                       //
		return unmuteUsernameByRoomId;                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.saveDefaultById = function () {                                                                  //
		function saveDefaultById(_id, defaultValue) {                                                                        //
			var query = {                                                                                                       // 689
				_id: _id                                                                                                           // 689
			};                                                                                                                  // 689
			var update = {                                                                                                      // 691
				$set: {                                                                                                            // 692
					"default": defaultValue === 'true'                                                                                // 693
				}                                                                                                                  // 692
			};                                                                                                                  // 691
			return this.update(query, update);                                                                                  // 697
		}                                                                                                                    // 698
                                                                                                                       //
		return saveDefaultById;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.setTopicAndTagsById = function () {                                                              //
		function setTopicAndTagsById(_id, topic, tags) {                                                                     //
			var setData = {};                                                                                                   // 701
			var unsetData = {};                                                                                                 // 702
                                                                                                                       //
			if (topic != null) {                                                                                                // 704
				if (!_.isEmpty(s.trim(topic))) {                                                                                   // 705
					setData.topic = s.trim(topic);                                                                                    // 706
				} else {                                                                                                           // 707
					unsetData.topic = 1;                                                                                              // 708
				}                                                                                                                  // 709
			}                                                                                                                   // 710
                                                                                                                       //
			if (tags != null) {                                                                                                 // 712
				if (!_.isEmpty(s.trim(tags))) {                                                                                    // 713
					setData.tags = s.trim(tags).split(',').map(function (tag) {                                                       // 714
						return s.trim(tag);                                                                                              // 714
					});                                                                                                               // 714
				} else {                                                                                                           // 715
					unsetData.tags = 1;                                                                                               // 716
				}                                                                                                                  // 717
			}                                                                                                                   // 718
                                                                                                                       //
			var update = {};                                                                                                    // 720
                                                                                                                       //
			if (!_.isEmpty(setData)) {                                                                                          // 722
				update.$set = setData;                                                                                             // 723
			}                                                                                                                   // 724
                                                                                                                       //
			if (!_.isEmpty(unsetData)) {                                                                                        // 726
				update.$unset = unsetData;                                                                                         // 727
			}                                                                                                                   // 728
                                                                                                                       //
			if (_.isEmpty(update)) {                                                                                            // 730
				return;                                                                                                            // 731
			}                                                                                                                   // 732
                                                                                                                       //
			return this.update({                                                                                                // 734
				_id: _id                                                                                                           // 734
			}, update);                                                                                                         // 734
		}                                                                                                                    // 735
                                                                                                                       //
		return setTopicAndTagsById;                                                                                          //
	}(); // INSERT                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelRooms.prototype.createWithTypeNameUserAndUsernames = function () {                                               //
		function createWithTypeNameUserAndUsernames(type, name, fname, user, usernames, extraData) {                         //
			var room = {                                                                                                        // 739
				name: name,                                                                                                        // 740
				fname: fname,                                                                                                      // 741
				t: type,                                                                                                           // 742
				usernames: usernames,                                                                                              // 743
				msgs: 0,                                                                                                           // 744
				u: {                                                                                                               // 745
					_id: user._id,                                                                                                    // 746
					username: user.username                                                                                           // 747
				}                                                                                                                  // 745
			};                                                                                                                  // 739
                                                                                                                       //
			_.extend(room, extraData);                                                                                          // 751
                                                                                                                       //
			room._id = this.insert(room);                                                                                       // 753
			return room;                                                                                                        // 754
		}                                                                                                                    // 755
                                                                                                                       //
		return createWithTypeNameUserAndUsernames;                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.createWithIdTypeAndName = function () {                                                          //
		function createWithIdTypeAndName(_id, type, name, extraData) {                                                       //
			var room = {                                                                                                        // 758
				_id: _id,                                                                                                          // 759
				ts: new Date(),                                                                                                    // 760
				t: type,                                                                                                           // 761
				name: name,                                                                                                        // 762
				usernames: [],                                                                                                     // 763
				msgs: 0                                                                                                            // 764
			};                                                                                                                  // 758
                                                                                                                       //
			_.extend(room, extraData);                                                                                          // 767
                                                                                                                       //
			this.insert(room);                                                                                                  // 769
			return room;                                                                                                        // 770
		}                                                                                                                    // 771
                                                                                                                       //
		return createWithIdTypeAndName;                                                                                      //
	}(); // REMOVE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelRooms.prototype.removeById = function () {                                                                       //
		function removeById(_id) {                                                                                           //
			var query = {                                                                                                       // 776
				_id: _id                                                                                                           // 776
			};                                                                                                                  // 776
			return this.remove(query);                                                                                          // 778
		}                                                                                                                    // 779
                                                                                                                       //
		return removeById;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelRooms.prototype.removeByTypeContainingUsername = function () {                                                   //
		function removeByTypeContainingUsername(type, username) {                                                            //
			var query = {                                                                                                       // 782
				t: type,                                                                                                           // 783
				usernames: username                                                                                                // 784
			};                                                                                                                  // 782
			return this.remove(query);                                                                                          // 787
		}                                                                                                                    // 788
                                                                                                                       //
		return removeByTypeContainingUsername;                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	return ModelRooms;                                                                                                    //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Rooms = new ModelRooms('room', true);                                                                // 791
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Settings.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Settings.js                                                                   //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var ModelSettings = function (_RocketChat$models$_B) {                                                                 //
	(0, _inherits3.default)(ModelSettings, _RocketChat$models$_B);                                                        //
                                                                                                                       //
	function ModelSettings() {                                                                                            // 2
		(0, _classCallCheck3.default)(this, ModelSettings);                                                                  // 2
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.apply(this, arguments));            // 2
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 5
			'blocked': 1                                                                                                        // 5
		}, {                                                                                                                 // 5
			sparse: 1                                                                                                           // 5
		});                                                                                                                  // 5
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 6
			'hidden': 1                                                                                                         // 6
		}, {                                                                                                                 // 6
			sparse: 1                                                                                                           // 6
		});                                                                                                                  // 6
                                                                                                                       //
		return _this;                                                                                                        // 2
	} // FIND                                                                                                             // 7
                                                                                                                       //
                                                                                                                       //
	ModelSettings.prototype.findById = function () {                                                                      //
		function findById(_id) {                                                                                             //
			var query = {                                                                                                       // 11
				_id: _id                                                                                                           // 11
			};                                                                                                                  // 11
			return this.find(query);                                                                                            // 13
		}                                                                                                                    // 14
                                                                                                                       //
		return findById;                                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findOneNotHiddenById = function () {                                                          //
		function findOneNotHiddenById(_id) {                                                                                 //
			var query = {                                                                                                       // 17
				_id: _id,                                                                                                          // 18
				hidden: {                                                                                                          // 19
					$ne: true                                                                                                         // 19
				}                                                                                                                  // 19
			};                                                                                                                  // 17
			return this.findOne(query);                                                                                         // 22
		}                                                                                                                    // 23
                                                                                                                       //
		return findOneNotHiddenById;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findByIds = function () {                                                                     //
		function findByIds() {                                                                                               //
			var _id = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];                                   // 25
                                                                                                                       //
			_id = [].concat(_id);                                                                                               // 26
			var query = {                                                                                                       // 28
				_id: {                                                                                                             // 29
					$in: _id                                                                                                          // 30
				}                                                                                                                  // 29
			};                                                                                                                  // 28
			return this.find(query);                                                                                            // 34
		}                                                                                                                    // 35
                                                                                                                       //
		return findByIds;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findByRole = function () {                                                                    //
		function findByRole(role, options) {                                                                                 //
			var query = {                                                                                                       // 38
				role: role                                                                                                         // 38
			};                                                                                                                  // 38
			return this.find(query, options);                                                                                   // 40
		}                                                                                                                    // 41
                                                                                                                       //
		return findByRole;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findPublic = function () {                                                                    //
		function findPublic(options) {                                                                                       //
			var query = {                                                                                                       // 44
				"public": true                                                                                                     // 44
			};                                                                                                                  // 44
			return this.find(query, options);                                                                                   // 46
		}                                                                                                                    // 47
                                                                                                                       //
		return findPublic;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findNotHiddenPublic = function () {                                                           //
		function findNotHiddenPublic() {                                                                                     //
			var ids = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];                                   // 49
			var filter = {                                                                                                      // 50
				hidden: {                                                                                                          // 51
					$ne: true                                                                                                         // 51
				},                                                                                                                 // 51
				"public": true                                                                                                     // 52
			};                                                                                                                  // 50
                                                                                                                       //
			if (ids.length > 0) {                                                                                               // 55
				filter._id = {                                                                                                     // 56
					$in: ids                                                                                                          // 57
				};                                                                                                                 // 57
			}                                                                                                                   // 58
                                                                                                                       //
			return this.find(filter, {                                                                                          // 60
				fields: {                                                                                                          // 60
					_id: 1,                                                                                                           // 60
					value: 1                                                                                                          // 60
				}                                                                                                                  // 60
			});                                                                                                                 // 60
		}                                                                                                                    // 61
                                                                                                                       //
		return findNotHiddenPublic;                                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findNotHiddenPublicUpdatedAfter = function () {                                               //
		function findNotHiddenPublicUpdatedAfter(updatedAt) {                                                                //
			var filter = {                                                                                                      // 64
				hidden: {                                                                                                          // 65
					$ne: true                                                                                                         // 65
				},                                                                                                                 // 65
				"public": true,                                                                                                    // 66
				_updatedAt: {                                                                                                      // 67
					$gt: updatedAt                                                                                                    // 68
				}                                                                                                                  // 67
			};                                                                                                                  // 64
			return this.find(filter, {                                                                                          // 72
				fields: {                                                                                                          // 72
					_id: 1,                                                                                                           // 72
					value: 1                                                                                                          // 72
				}                                                                                                                  // 72
			});                                                                                                                 // 72
		}                                                                                                                    // 73
                                                                                                                       //
		return findNotHiddenPublicUpdatedAfter;                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findNotHiddenPrivate = function () {                                                          //
		function findNotHiddenPrivate() {                                                                                    //
			return this.find({                                                                                                  // 76
				hidden: {                                                                                                          // 77
					$ne: true                                                                                                         // 77
				},                                                                                                                 // 77
				"public": {                                                                                                        // 78
					$ne: true                                                                                                         // 78
				}                                                                                                                  // 78
			});                                                                                                                 // 76
		}                                                                                                                    // 80
                                                                                                                       //
		return findNotHiddenPrivate;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findNotHidden = function () {                                                                 //
		function findNotHidden(options) {                                                                                    //
			return this.find({                                                                                                  // 83
				hidden: {                                                                                                          // 83
					$ne: true                                                                                                         // 83
				}                                                                                                                  // 83
			}, options);                                                                                                        // 83
		}                                                                                                                    // 84
                                                                                                                       //
		return findNotHidden;                                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.findNotHiddenUpdatedAfter = function () {                                                     //
		function findNotHiddenUpdatedAfter(updatedAt) {                                                                      //
			return this.find({                                                                                                  // 87
				hidden: {                                                                                                          // 88
					$ne: true                                                                                                         // 88
				},                                                                                                                 // 88
				_updatedAt: {                                                                                                      // 89
					$gt: updatedAt                                                                                                    // 90
				}                                                                                                                  // 89
			});                                                                                                                 // 87
		}                                                                                                                    // 93
                                                                                                                       //
		return findNotHiddenUpdatedAfter;                                                                                    //
	}(); // UPDATE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelSettings.prototype.updateValueById = function () {                                                               //
		function updateValueById(_id, value) {                                                                               //
			var query = {                                                                                                       // 97
				blocked: {                                                                                                         // 98
					$ne: true                                                                                                         // 98
				},                                                                                                                 // 98
				value: {                                                                                                           // 99
					$ne: value                                                                                                        // 99
				},                                                                                                                 // 99
				_id: _id                                                                                                           // 100
			};                                                                                                                  // 97
			var update = {                                                                                                      // 103
				$set: {                                                                                                            // 104
					value: value                                                                                                      // 105
				}                                                                                                                  // 104
			};                                                                                                                  // 103
			return this.update(query, update);                                                                                  // 109
		}                                                                                                                    // 110
                                                                                                                       //
		return updateValueById;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.updateValueAndEditorById = function () {                                                      //
		function updateValueAndEditorById(_id, value, editor) {                                                              //
			var query = {                                                                                                       // 113
				blocked: {                                                                                                         // 114
					$ne: true                                                                                                         // 114
				},                                                                                                                 // 114
				value: {                                                                                                           // 115
					$ne: value                                                                                                        // 115
				},                                                                                                                 // 115
				_id: _id                                                                                                           // 116
			};                                                                                                                  // 113
			var update = {                                                                                                      // 119
				$set: {                                                                                                            // 120
					value: value,                                                                                                     // 121
					editor: editor                                                                                                    // 122
				}                                                                                                                  // 120
			};                                                                                                                  // 119
			return this.update(query, update);                                                                                  // 126
		}                                                                                                                    // 127
                                                                                                                       //
		return updateValueAndEditorById;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.updateValueNotHiddenById = function () {                                                      //
		function updateValueNotHiddenById(_id, value) {                                                                      //
			var query = {                                                                                                       // 130
				_id: _id,                                                                                                          // 131
				hidden: {                                                                                                          // 132
					$ne: true                                                                                                         // 132
				},                                                                                                                 // 132
				blocked: {                                                                                                         // 133
					$ne: true                                                                                                         // 133
				}                                                                                                                  // 133
			};                                                                                                                  // 130
			var update = {                                                                                                      // 136
				$set: {                                                                                                            // 137
					value: value                                                                                                      // 138
				}                                                                                                                  // 137
			};                                                                                                                  // 136
			return this.update(query, update);                                                                                  // 142
		}                                                                                                                    // 143
                                                                                                                       //
		return updateValueNotHiddenById;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSettings.prototype.updateOptionsById = function () {                                                             //
		function updateOptionsById(_id, options) {                                                                           //
			var query = {                                                                                                       // 146
				blocked: {                                                                                                         // 147
					$ne: true                                                                                                         // 147
				},                                                                                                                 // 147
				_id: _id                                                                                                           // 148
			};                                                                                                                  // 146
			var update = {                                                                                                      // 151
				$set: options                                                                                                      // 151
			};                                                                                                                  // 151
			return this.update(query, update);                                                                                  // 153
		}                                                                                                                    // 154
                                                                                                                       //
		return updateOptionsById;                                                                                            //
	}(); // INSERT                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelSettings.prototype.createWithIdAndValue = function () {                                                          //
		function createWithIdAndValue(_id, value) {                                                                          //
			var record = {                                                                                                      // 158
				_id: _id,                                                                                                          // 159
				value: value,                                                                                                      // 160
				_createdAt: new Date()                                                                                             // 161
			};                                                                                                                  // 158
			return this.insert(record);                                                                                         // 164
		}                                                                                                                    // 165
                                                                                                                       //
		return createWithIdAndValue;                                                                                         //
	}(); // REMOVE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelSettings.prototype.removeById = function () {                                                                    //
		function removeById(_id) {                                                                                           //
			var query = {                                                                                                       // 169
				blocked: {                                                                                                         // 170
					$ne: true                                                                                                         // 170
				},                                                                                                                 // 170
				_id: _id                                                                                                           // 171
			};                                                                                                                  // 169
			return this.remove(query);                                                                                          // 174
		}                                                                                                                    // 175
                                                                                                                       //
		return removeById;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	return ModelSettings;                                                                                                 //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Settings = new ModelSettings('settings', true);                                                      // 178
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Subscriptions.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Subscriptions.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _slicedToArray2 = require("babel-runtime/helpers/slicedToArray");                                                  //
                                                                                                                       //
var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);                                                         //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var ModelSubscriptions = function (_RocketChat$models$_B) {                                                            //
	(0, _inherits3.default)(ModelSubscriptions, _RocketChat$models$_B);                                                   //
                                                                                                                       //
	function ModelSubscriptions() {                                                                                       // 2
		(0, _classCallCheck3.default)(this, ModelSubscriptions);                                                             // 2
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.apply(this, arguments));            // 2
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 5
			'rid': 1,                                                                                                           // 5
			'u._id': 1                                                                                                          // 5
		}, {                                                                                                                 // 5
			unique: 1                                                                                                           // 5
		});                                                                                                                  // 5
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 6
			'rid': 1,                                                                                                           // 6
			'alert': 1,                                                                                                         // 6
			'u._id': 1                                                                                                          // 6
		});                                                                                                                  // 6
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 7
			'rid': 1,                                                                                                           // 7
			'roles': 1                                                                                                          // 7
		});                                                                                                                  // 7
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 8
			'u._id': 1,                                                                                                         // 8
			'name': 1,                                                                                                          // 8
			't': 1                                                                                                              // 8
		});                                                                                                                  // 8
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 9
			'u._id': 1,                                                                                                         // 9
			'name': 1,                                                                                                          // 9
			't': 1,                                                                                                             // 9
			'code': 1                                                                                                           // 9
		}, {                                                                                                                 // 9
			unique: 1                                                                                                           // 9
		});                                                                                                                  // 9
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 10
			'open': 1                                                                                                           // 10
		});                                                                                                                  // 10
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 11
			'alert': 1                                                                                                          // 11
		});                                                                                                                  // 11
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 12
			'unread': 1                                                                                                         // 12
		});                                                                                                                  // 12
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 13
			'ts': 1                                                                                                             // 13
		});                                                                                                                  // 13
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 14
			'ls': 1                                                                                                             // 14
		});                                                                                                                  // 14
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 15
			'audioNotifications': 1                                                                                             // 15
		}, {                                                                                                                 // 15
			sparse: 1                                                                                                           // 15
		});                                                                                                                  // 15
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 16
			'desktopNotifications': 1                                                                                           // 16
		}, {                                                                                                                 // 16
			sparse: 1                                                                                                           // 16
		});                                                                                                                  // 16
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 17
			'mobilePushNotifications': 1                                                                                        // 17
		}, {                                                                                                                 // 17
			sparse: 1                                                                                                           // 17
		});                                                                                                                  // 17
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 18
			'emailNotifications': 1                                                                                             // 18
		}, {                                                                                                                 // 18
			sparse: 1                                                                                                           // 18
		});                                                                                                                  // 18
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 19
			'autoTranslate': 1                                                                                                  // 19
		}, {                                                                                                                 // 19
			sparse: 1                                                                                                           // 19
		});                                                                                                                  // 19
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 20
			'autoTranslateLanguage': 1                                                                                          // 20
		}, {                                                                                                                 // 20
			sparse: 1                                                                                                           // 20
		});                                                                                                                  // 20
                                                                                                                       //
		_this.cache.ensureIndex('rid', 'array');                                                                             // 22
                                                                                                                       //
		_this.cache.ensureIndex('u._id', 'array');                                                                           // 23
                                                                                                                       //
		_this.cache.ensureIndex('name', 'array');                                                                            // 24
                                                                                                                       //
		_this.cache.ensureIndex(['rid', 'u._id'], 'unique');                                                                 // 25
                                                                                                                       //
		_this.cache.ensureIndex(['name', 'u._id'], 'unique');                                                                // 26
                                                                                                                       //
		return _this;                                                                                                        // 2
	} // FIND ONE                                                                                                         // 27
                                                                                                                       //
                                                                                                                       //
	ModelSubscriptions.prototype.findOneByRoomIdAndUserId = function () {                                                 //
		function findOneByRoomIdAndUserId(roomId, userId) {                                                                  //
			if (this.useCache) {                                                                                                // 32
				return this.cache.findByIndex('rid,u._id', [roomId, userId]).fetch();                                              // 33
			}                                                                                                                   // 34
                                                                                                                       //
			var query = {                                                                                                       // 35
				rid: roomId,                                                                                                       // 36
				'u._id': userId                                                                                                    // 37
			};                                                                                                                  // 35
			return this.findOne(query);                                                                                         // 40
		}                                                                                                                    // 41
                                                                                                                       //
		return findOneByRoomIdAndUserId;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findOneByRoomNameAndUserId = function () {                                               //
		function findOneByRoomNameAndUserId(roomName, userId) {                                                              //
			if (this.useCache) {                                                                                                // 44
				return this.cache.findByIndex('name,u._id', [roomName, userId]).fetch();                                           // 45
			}                                                                                                                   // 46
                                                                                                                       //
			var query = {                                                                                                       // 47
				name: roomName,                                                                                                    // 48
				'u._id': userId                                                                                                    // 49
			};                                                                                                                  // 47
			return this.findOne(query);                                                                                         // 52
		}                                                                                                                    // 53
                                                                                                                       //
		return findOneByRoomNameAndUserId;                                                                                   //
	}(); // FIND                                                                                                          //
                                                                                                                       //
                                                                                                                       //
	ModelSubscriptions.prototype.findByUserId = function () {                                                             //
		function findByUserId(userId, options) {                                                                             //
			if (this.useCache) {                                                                                                // 57
				return this.cache.findByIndex('u._id', userId, options);                                                           // 58
			}                                                                                                                   // 59
                                                                                                                       //
			var query = {                                                                                                       // 61
				'u._id': userId                                                                                                    // 62
			};                                                                                                                  // 62
			return this.find(query, options);                                                                                   // 64
		}                                                                                                                    // 65
                                                                                                                       //
		return findByUserId;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByUserIdUpdatedAfter = function () {                                                 //
		function findByUserIdUpdatedAfter(userId, updatedAt, options) {                                                      //
			var query = {                                                                                                       // 68
				'u._id': userId,                                                                                                   // 69
				_updatedAt: {                                                                                                      // 70
					$gt: updatedAt                                                                                                    // 71
				}                                                                                                                  // 70
			};                                                                                                                  // 68
			return this.find(query, options);                                                                                   // 75
		}                                                                                                                    // 76
                                                                                                                       //
		return findByUserIdUpdatedAfter;                                                                                     //
	}(); // FIND                                                                                                          //
                                                                                                                       //
                                                                                                                       //
	ModelSubscriptions.prototype.findByRoomIdAndRoles = function () {                                                     //
		function findByRoomIdAndRoles(roomId, roles, options) {                                                              //
			roles = [].concat(roles);                                                                                           // 80
			var query = {                                                                                                       // 81
				'rid': roomId,                                                                                                     // 82
				'roles': {                                                                                                         // 83
					$in: roles                                                                                                        // 83
				}                                                                                                                  // 83
			};                                                                                                                  // 81
			return this.find(query, options);                                                                                   // 86
		}                                                                                                                    // 87
                                                                                                                       //
		return findByRoomIdAndRoles;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByType = function () {                                                               //
		function findByType(types, options) {                                                                                //
			var query = {                                                                                                       // 90
				t: {                                                                                                               // 91
					$in: types                                                                                                        // 92
				}                                                                                                                  // 91
			};                                                                                                                  // 90
			return this.find(query, options);                                                                                   // 96
		}                                                                                                                    // 97
                                                                                                                       //
		return findByType;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByTypeAndUserId = function () {                                                      //
		function findByTypeAndUserId(type, userId, options) {                                                                //
			var query = {                                                                                                       // 100
				t: type,                                                                                                           // 101
				'u._id': userId                                                                                                    // 102
			};                                                                                                                  // 100
			return this.find(query, options);                                                                                   // 105
		}                                                                                                                    // 106
                                                                                                                       //
		return findByTypeAndUserId;                                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByTypeNameAndUserId = function () {                                                  //
		function findByTypeNameAndUserId(type, name, userId, options) {                                                      //
			var query = {                                                                                                       // 109
				t: type,                                                                                                           // 110
				name: name,                                                                                                        // 111
				'u._id': userId                                                                                                    // 112
			};                                                                                                                  // 109
			return this.find(query, options);                                                                                   // 115
		}                                                                                                                    // 116
                                                                                                                       //
		return findByTypeNameAndUserId;                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByRoomId = function () {                                                             //
		function findByRoomId(roomId, options) {                                                                             //
			if (this.useCache) {                                                                                                // 119
				return this.cache.findByIndex('rid', roomId, options);                                                             // 120
			}                                                                                                                   // 121
                                                                                                                       //
			var query = {                                                                                                       // 123
				rid: roomId                                                                                                        // 124
			};                                                                                                                  // 124
			return this.find(query, options);                                                                                   // 126
		}                                                                                                                    // 127
                                                                                                                       //
		return findByRoomId;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByRoomIdAndNotUserId = function () {                                                 //
		function findByRoomIdAndNotUserId(roomId, userId, options) {                                                         //
			var query = {                                                                                                       // 130
				rid: roomId,                                                                                                       // 131
				'u._id': {                                                                                                         // 132
					$ne: userId                                                                                                       // 133
				}                                                                                                                  // 132
			};                                                                                                                  // 130
			return this.find(query, options);                                                                                   // 137
		}                                                                                                                    // 138
                                                                                                                       //
		return findByRoomIdAndNotUserId;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.getLastSeen = function () {                                                              //
		function getLastSeen(options) {                                                                                      //
			if (options == null) {                                                                                              // 141
				options = {};                                                                                                      // 141
			}                                                                                                                   // 141
                                                                                                                       //
			var query = {                                                                                                       // 142
				ls: {                                                                                                              // 142
					$exists: 1                                                                                                        // 142
				}                                                                                                                  // 142
			};                                                                                                                  // 142
			options.sort = {                                                                                                    // 143
				ls: -1                                                                                                             // 143
			};                                                                                                                  // 143
			options.limit = 1;                                                                                                  // 144
                                                                                                                       //
			var _find$fetch = this.find(query, options).fetch(),                                                                // 140
			    _find$fetch2 = (0, _slicedToArray3.default)(_find$fetch, 1),                                                    // 140
			    subscription = _find$fetch2[0];                                                                                 // 140
                                                                                                                       //
			return subscription && subscription.ls;                                                                             // 146
		}                                                                                                                    // 147
                                                                                                                       //
		return getLastSeen;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByRoomIdAndUserIds = function () {                                                   //
		function findByRoomIdAndUserIds(roomId, userIds) {                                                                   //
			var query = {                                                                                                       // 150
				rid: roomId,                                                                                                       // 151
				'u._id': {                                                                                                         // 152
					$in: userIds                                                                                                      // 153
				}                                                                                                                  // 152
			};                                                                                                                  // 150
			return this.find(query);                                                                                            // 157
		}                                                                                                                    // 158
                                                                                                                       //
		return findByRoomIdAndUserIds;                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findByRoomIdAndUserIdsOrAllMessages = function () {                                      //
		function findByRoomIdAndUserIdsOrAllMessages(roomId, userIds) {                                                      //
			var query = {                                                                                                       // 161
				rid: roomId,                                                                                                       // 162
				$or: [{                                                                                                            // 163
					'u._id': {                                                                                                        // 164
						$in: userIds                                                                                                     // 164
					}                                                                                                                 // 164
				}, {                                                                                                               // 164
					emailNotifications: 'all'                                                                                         // 165
				}]                                                                                                                 // 165
			};                                                                                                                  // 161
			return this.find(query);                                                                                            // 169
		}                                                                                                                    // 170
                                                                                                                       //
		return findByRoomIdAndUserIdsOrAllMessages;                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.findUnreadByUserId = function () {                                                       //
		function findUnreadByUserId(userId) {                                                                                //
			var query = {                                                                                                       // 173
				'u._id': userId,                                                                                                   // 174
				unread: {                                                                                                          // 175
					$gt: 0                                                                                                            // 176
				}                                                                                                                  // 175
			};                                                                                                                  // 173
			return this.find(query, {                                                                                           // 180
				fields: {                                                                                                          // 180
					unread: 1                                                                                                         // 180
				}                                                                                                                  // 180
			});                                                                                                                 // 180
		}                                                                                                                    // 181
                                                                                                                       //
		return findUnreadByUserId;                                                                                           //
	}(); // UPDATE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelSubscriptions.prototype.archiveByRoomId = function () {                                                          //
		function archiveByRoomId(roomId) {                                                                                   //
			var query = {                                                                                                       // 185
				rid: roomId                                                                                                        // 186
			};                                                                                                                  // 186
			var update = {                                                                                                      // 188
				$set: {                                                                                                            // 189
					alert: false,                                                                                                     // 190
					open: false,                                                                                                      // 191
					archived: true                                                                                                    // 192
				}                                                                                                                  // 189
			};                                                                                                                  // 188
			return this.update(query, update, {                                                                                 // 196
				multi: true                                                                                                        // 196
			});                                                                                                                 // 196
		}                                                                                                                    // 197
                                                                                                                       //
		return archiveByRoomId;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.unarchiveByRoomId = function () {                                                        //
		function unarchiveByRoomId(roomId) {                                                                                 //
			var query = {                                                                                                       // 200
				rid: roomId                                                                                                        // 201
			};                                                                                                                  // 201
			var update = {                                                                                                      // 203
				$set: {                                                                                                            // 204
					alert: false,                                                                                                     // 205
					open: true,                                                                                                       // 206
					archived: false                                                                                                   // 207
				}                                                                                                                  // 204
			};                                                                                                                  // 203
			return this.update(query, update, {                                                                                 // 211
				multi: true                                                                                                        // 211
			});                                                                                                                 // 211
		}                                                                                                                    // 212
                                                                                                                       //
		return unarchiveByRoomId;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.hideByRoomIdAndUserId = function () {                                                    //
		function hideByRoomIdAndUserId(roomId, userId) {                                                                     //
			var query = {                                                                                                       // 215
				rid: roomId,                                                                                                       // 216
				'u._id': userId                                                                                                    // 217
			};                                                                                                                  // 215
			var update = {                                                                                                      // 220
				$set: {                                                                                                            // 221
					alert: false,                                                                                                     // 222
					open: false                                                                                                       // 223
				}                                                                                                                  // 221
			};                                                                                                                  // 220
			return this.update(query, update);                                                                                  // 227
		}                                                                                                                    // 228
                                                                                                                       //
		return hideByRoomIdAndUserId;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.openByRoomIdAndUserId = function () {                                                    //
		function openByRoomIdAndUserId(roomId, userId) {                                                                     //
			var query = {                                                                                                       // 231
				rid: roomId,                                                                                                       // 232
				'u._id': userId                                                                                                    // 233
			};                                                                                                                  // 231
			var update = {                                                                                                      // 236
				$set: {                                                                                                            // 237
					open: true                                                                                                        // 238
				}                                                                                                                  // 237
			};                                                                                                                  // 236
			return this.update(query, update);                                                                                  // 242
		}                                                                                                                    // 243
                                                                                                                       //
		return openByRoomIdAndUserId;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setAsReadByRoomIdAndUserId = function () {                                               //
		function setAsReadByRoomIdAndUserId(roomId, userId) {                                                                //
			var query = {                                                                                                       // 246
				rid: roomId,                                                                                                       // 247
				'u._id': userId                                                                                                    // 248
			};                                                                                                                  // 246
			var update = {                                                                                                      // 251
				$set: {                                                                                                            // 252
					open: true,                                                                                                       // 253
					alert: false,                                                                                                     // 254
					unread: 0,                                                                                                        // 255
					userMentions: 0,                                                                                                  // 256
					groupMentions: 0,                                                                                                 // 257
					ls: new Date()                                                                                                    // 258
				}                                                                                                                  // 252
			};                                                                                                                  // 251
			return this.update(query, update);                                                                                  // 262
		}                                                                                                                    // 263
                                                                                                                       //
		return setAsReadByRoomIdAndUserId;                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setAsUnreadByRoomIdAndUserId = function () {                                             //
		function setAsUnreadByRoomIdAndUserId(roomId, userId, firstMessageUnreadTimestamp) {                                 //
			var query = {                                                                                                       // 266
				rid: roomId,                                                                                                       // 267
				'u._id': userId                                                                                                    // 268
			};                                                                                                                  // 266
			var update = {                                                                                                      // 271
				$set: {                                                                                                            // 272
					open: true,                                                                                                       // 273
					alert: true,                                                                                                      // 274
					ls: firstMessageUnreadTimestamp                                                                                   // 275
				}                                                                                                                  // 272
			};                                                                                                                  // 271
			return this.update(query, update);                                                                                  // 279
		}                                                                                                                    // 280
                                                                                                                       //
		return setAsUnreadByRoomIdAndUserId;                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setFavoriteByRoomIdAndUserId = function () {                                             //
		function setFavoriteByRoomIdAndUserId(roomId, userId, favorite) {                                                    //
			if (favorite == null) {                                                                                             // 283
				favorite = true;                                                                                                   // 283
			}                                                                                                                   // 283
                                                                                                                       //
			var query = {                                                                                                       // 284
				rid: roomId,                                                                                                       // 285
				'u._id': userId                                                                                                    // 286
			};                                                                                                                  // 284
			var update = {                                                                                                      // 289
				$set: {                                                                                                            // 290
					f: favorite                                                                                                       // 291
				}                                                                                                                  // 290
			};                                                                                                                  // 289
			return this.update(query, update);                                                                                  // 295
		}                                                                                                                    // 296
                                                                                                                       //
		return setFavoriteByRoomIdAndUserId;                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.updateNameAndAlertByRoomId = function () {                                               //
		function updateNameAndAlertByRoomId(roomId, name, fname) {                                                           //
			var query = {                                                                                                       // 299
				rid: roomId                                                                                                        // 300
			};                                                                                                                  // 300
			var update = {                                                                                                      // 302
				$set: {                                                                                                            // 303
					name: name,                                                                                                       // 304
					fname: fname,                                                                                                     // 305
					alert: true                                                                                                       // 306
				}                                                                                                                  // 303
			};                                                                                                                  // 302
			return this.update(query, update, {                                                                                 // 310
				multi: true                                                                                                        // 310
			});                                                                                                                 // 310
		}                                                                                                                    // 311
                                                                                                                       //
		return updateNameAndAlertByRoomId;                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.updateNameByRoomId = function () {                                                       //
		function updateNameByRoomId(roomId, name) {                                                                          //
			var query = {                                                                                                       // 314
				rid: roomId                                                                                                        // 315
			};                                                                                                                  // 315
			var update = {                                                                                                      // 317
				$set: {                                                                                                            // 318
					name: name                                                                                                        // 319
				}                                                                                                                  // 318
			};                                                                                                                  // 317
			return this.update(query, update, {                                                                                 // 323
				multi: true                                                                                                        // 323
			});                                                                                                                 // 323
		}                                                                                                                    // 324
                                                                                                                       //
		return updateNameByRoomId;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setUserUsernameByUserId = function () {                                                  //
		function setUserUsernameByUserId(userId, username) {                                                                 //
			var query = {                                                                                                       // 327
				'u._id': userId                                                                                                    // 328
			};                                                                                                                  // 328
			var update = {                                                                                                      // 330
				$set: {                                                                                                            // 331
					'u.username': username                                                                                            // 332
				}                                                                                                                  // 331
			};                                                                                                                  // 330
			return this.update(query, update, {                                                                                 // 336
				multi: true                                                                                                        // 336
			});                                                                                                                 // 336
		}                                                                                                                    // 337
                                                                                                                       //
		return setUserUsernameByUserId;                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setNameForDirectRoomsWithOldName = function () {                                         //
		function setNameForDirectRoomsWithOldName(oldName, name) {                                                           //
			var query = {                                                                                                       // 340
				name: oldName,                                                                                                     // 341
				t: 'd'                                                                                                             // 342
			};                                                                                                                  // 340
			var update = {                                                                                                      // 345
				$set: {                                                                                                            // 346
					name: name                                                                                                        // 347
				}                                                                                                                  // 346
			};                                                                                                                  // 345
			return this.update(query, update, {                                                                                 // 351
				multi: true                                                                                                        // 351
			});                                                                                                                 // 351
		}                                                                                                                    // 352
                                                                                                                       //
		return setNameForDirectRoomsWithOldName;                                                                             //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.incUnreadForRoomIdExcludingUserId = function () {                                        //
		function incUnreadForRoomIdExcludingUserId(roomId, userId, inc) {                                                    //
			if (inc == null) {                                                                                                  // 355
				inc = 1;                                                                                                           // 355
			}                                                                                                                   // 355
                                                                                                                       //
			var query = {                                                                                                       // 356
				rid: roomId,                                                                                                       // 357
				'u._id': {                                                                                                         // 358
					$ne: userId                                                                                                       // 359
				}                                                                                                                  // 358
			};                                                                                                                  // 356
			var update = {                                                                                                      // 363
				$set: {                                                                                                            // 364
					alert: true,                                                                                                      // 365
					open: true                                                                                                        // 366
				},                                                                                                                 // 364
				$inc: {                                                                                                            // 368
					unread: inc                                                                                                       // 369
				}                                                                                                                  // 368
			};                                                                                                                  // 363
			return this.update(query, update, {                                                                                 // 373
				multi: true                                                                                                        // 373
			});                                                                                                                 // 373
		}                                                                                                                    // 374
                                                                                                                       //
		return incUnreadForRoomIdExcludingUserId;                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.incGroupMentionsAndUnreadForRoomIdExcludingUserId = function () {                        //
		function incGroupMentionsAndUnreadForRoomIdExcludingUserId(roomId, userId) {                                         //
			var incGroup = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 1;                               // 376
			var incUnread = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 1;                              // 376
			var query = {                                                                                                       // 377
				rid: roomId,                                                                                                       // 378
				'u._id': {                                                                                                         // 379
					$ne: userId                                                                                                       // 380
				}                                                                                                                  // 379
			};                                                                                                                  // 377
			var update = {                                                                                                      // 384
				$set: {                                                                                                            // 385
					alert: true,                                                                                                      // 386
					open: true                                                                                                        // 387
				},                                                                                                                 // 385
				$inc: {                                                                                                            // 389
					unread: incUnread,                                                                                                // 390
					groupMentions: incGroup                                                                                           // 391
				}                                                                                                                  // 389
			};                                                                                                                  // 384
			return this.update(query, update, {                                                                                 // 395
				multi: true                                                                                                        // 395
			});                                                                                                                 // 395
		}                                                                                                                    // 396
                                                                                                                       //
		return incGroupMentionsAndUnreadForRoomIdExcludingUserId;                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.incUserMentionsAndUnreadForRoomIdAndUserIds = function () {                              //
		function incUserMentionsAndUnreadForRoomIdAndUserIds(roomId, userIds) {                                              //
			var incUser = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 1;                                // 398
			var incUnread = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : 1;                              // 398
			var query = {                                                                                                       // 399
				rid: roomId,                                                                                                       // 400
				'u._id': {                                                                                                         // 401
					$in: userIds                                                                                                      // 402
				}                                                                                                                  // 401
			};                                                                                                                  // 399
			var update = {                                                                                                      // 406
				$set: {                                                                                                            // 407
					alert: true,                                                                                                      // 408
					open: true                                                                                                        // 409
				},                                                                                                                 // 407
				$inc: {                                                                                                            // 411
					unread: incUnread,                                                                                                // 412
					userMentions: incUser                                                                                             // 413
				}                                                                                                                  // 411
			};                                                                                                                  // 406
			return this.update(query, update, {                                                                                 // 417
				multi: true                                                                                                        // 417
			});                                                                                                                 // 417
		}                                                                                                                    // 418
                                                                                                                       //
		return incUserMentionsAndUnreadForRoomIdAndUserIds;                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setAlertForRoomIdExcludingUserId = function () {                                         //
		function setAlertForRoomIdExcludingUserId(roomId, userId) {                                                          //
			var query = {                                                                                                       // 420
				rid: roomId,                                                                                                       // 421
				'u._id': {                                                                                                         // 422
					$ne: userId                                                                                                       // 423
				},                                                                                                                 // 422
				$or: [{                                                                                                            // 425
					alert: {                                                                                                          // 426
						$ne: true                                                                                                        // 426
					}                                                                                                                 // 426
				}, {                                                                                                               // 426
					open: {                                                                                                           // 427
						$ne: true                                                                                                        // 427
					}                                                                                                                 // 427
				}]                                                                                                                 // 427
			};                                                                                                                  // 420
			var update = {                                                                                                      // 431
				$set: {                                                                                                            // 432
					alert: true,                                                                                                      // 433
					open: true                                                                                                        // 434
				}                                                                                                                  // 432
			};                                                                                                                  // 431
			return this.update(query, update, {                                                                                 // 437
				multi: true                                                                                                        // 437
			});                                                                                                                 // 437
		}                                                                                                                    // 438
                                                                                                                       //
		return setAlertForRoomIdExcludingUserId;                                                                             //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setBlockedByRoomId = function () {                                                       //
		function setBlockedByRoomId(rid, blocked, blocker) {                                                                 //
			var query = {                                                                                                       // 441
				rid: rid,                                                                                                          // 442
				'u._id': blocked                                                                                                   // 443
			};                                                                                                                  // 441
			var update = {                                                                                                      // 446
				$set: {                                                                                                            // 447
					blocked: true                                                                                                     // 448
				}                                                                                                                  // 447
			};                                                                                                                  // 446
			var query2 = {                                                                                                      // 452
				rid: rid,                                                                                                          // 453
				'u._id': blocker                                                                                                   // 454
			};                                                                                                                  // 452
			var update2 = {                                                                                                     // 457
				$set: {                                                                                                            // 458
					blocker: true                                                                                                     // 459
				}                                                                                                                  // 458
			};                                                                                                                  // 457
			return this.update(query, update) && this.update(query2, update2);                                                  // 463
		}                                                                                                                    // 464
                                                                                                                       //
		return setBlockedByRoomId;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.unsetBlockedByRoomId = function () {                                                     //
		function unsetBlockedByRoomId(rid, blocked, blocker) {                                                               //
			var query = {                                                                                                       // 467
				rid: rid,                                                                                                          // 468
				'u._id': blocked                                                                                                   // 469
			};                                                                                                                  // 467
			var update = {                                                                                                      // 472
				$unset: {                                                                                                          // 473
					blocked: 1                                                                                                        // 474
				}                                                                                                                  // 473
			};                                                                                                                  // 472
			var query2 = {                                                                                                      // 478
				rid: rid,                                                                                                          // 479
				'u._id': blocker                                                                                                   // 480
			};                                                                                                                  // 478
			var update2 = {                                                                                                     // 483
				$unset: {                                                                                                          // 484
					blocker: 1                                                                                                        // 485
				}                                                                                                                  // 484
			};                                                                                                                  // 483
			return this.update(query, update) && this.update(query2, update2);                                                  // 489
		}                                                                                                                    // 490
                                                                                                                       //
		return unsetBlockedByRoomId;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.updateTypeByRoomId = function () {                                                       //
		function updateTypeByRoomId(roomId, type) {                                                                          //
			var query = {                                                                                                       // 493
				rid: roomId                                                                                                        // 494
			};                                                                                                                  // 494
			var update = {                                                                                                      // 496
				$set: {                                                                                                            // 497
					t: type                                                                                                           // 498
				}                                                                                                                  // 497
			};                                                                                                                  // 496
			return this.update(query, update, {                                                                                 // 502
				multi: true                                                                                                        // 502
			});                                                                                                                 // 502
		}                                                                                                                    // 503
                                                                                                                       //
		return updateTypeByRoomId;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.addRoleById = function () {                                                              //
		function addRoleById(_id, role) {                                                                                    //
			var query = {                                                                                                       // 506
				_id: _id                                                                                                           // 507
			};                                                                                                                  // 507
			var update = {                                                                                                      // 509
				$addToSet: {                                                                                                       // 510
					roles: role                                                                                                       // 511
				}                                                                                                                  // 510
			};                                                                                                                  // 509
			return this.update(query, update);                                                                                  // 515
		}                                                                                                                    // 516
                                                                                                                       //
		return addRoleById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.removeRoleById = function () {                                                           //
		function removeRoleById(_id, role) {                                                                                 //
			var query = {                                                                                                       // 519
				_id: _id                                                                                                           // 520
			};                                                                                                                  // 520
			var update = {                                                                                                      // 522
				$pull: {                                                                                                           // 523
					roles: role                                                                                                       // 524
				}                                                                                                                  // 523
			};                                                                                                                  // 522
			return this.update(query, update);                                                                                  // 528
		}                                                                                                                    // 529
                                                                                                                       //
		return removeRoleById;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.setArchivedByUsername = function () {                                                    //
		function setArchivedByUsername(username, archived) {                                                                 //
			var query = {                                                                                                       // 532
				t: 'd',                                                                                                            // 533
				name: username                                                                                                     // 534
			};                                                                                                                  // 532
			var update = {                                                                                                      // 537
				$set: {                                                                                                            // 538
					archived: archived                                                                                                // 539
				}                                                                                                                  // 538
			};                                                                                                                  // 537
			return this.update(query, update, {                                                                                 // 543
				multi: true                                                                                                        // 543
			});                                                                                                                 // 543
		}                                                                                                                    // 544
                                                                                                                       //
		return setArchivedByUsername;                                                                                        //
	}(); // INSERT                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelSubscriptions.prototype.createWithRoomAndUser = function () {                                                    //
		function createWithRoomAndUser(room, user, extraData) {                                                              //
			var subscription = {                                                                                                // 548
				open: false,                                                                                                       // 549
				alert: false,                                                                                                      // 550
				unread: 0,                                                                                                         // 551
				userMentions: 0,                                                                                                   // 552
				groupMentions: 0,                                                                                                  // 553
				ts: room.ts,                                                                                                       // 554
				rid: room._id,                                                                                                     // 555
				name: room.name,                                                                                                   // 556
				fname: room.fname,                                                                                                 // 557
				t: room.t,                                                                                                         // 558
				u: {                                                                                                               // 559
					_id: user._id,                                                                                                    // 560
					username: user.username,                                                                                          // 561
					name: user.name                                                                                                   // 562
				}                                                                                                                  // 559
			};                                                                                                                  // 548
                                                                                                                       //
			_.extend(subscription, extraData);                                                                                  // 566
                                                                                                                       //
			return this.insert(subscription);                                                                                   // 568
		}                                                                                                                    // 569
                                                                                                                       //
		return createWithRoomAndUser;                                                                                        //
	}(); // REMOVE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelSubscriptions.prototype.removeByUserId = function () {                                                           //
		function removeByUserId(userId) {                                                                                    //
			var query = {                                                                                                       // 574
				'u._id': userId                                                                                                    // 575
			};                                                                                                                  // 575
			return this.remove(query);                                                                                          // 577
		}                                                                                                                    // 578
                                                                                                                       //
		return removeByUserId;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.removeByRoomId = function () {                                                           //
		function removeByRoomId(roomId) {                                                                                    //
			var query = {                                                                                                       // 581
				rid: roomId                                                                                                        // 582
			};                                                                                                                  // 582
			return this.remove(query);                                                                                          // 584
		}                                                                                                                    // 585
                                                                                                                       //
		return removeByRoomId;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelSubscriptions.prototype.removeByRoomIdAndUserId = function () {                                                  //
		function removeByRoomIdAndUserId(roomId, userId) {                                                                   //
			var query = {                                                                                                       // 588
				rid: roomId,                                                                                                       // 589
				'u._id': userId                                                                                                    // 590
			};                                                                                                                  // 588
			return this.remove(query);                                                                                          // 593
		}                                                                                                                    // 594
                                                                                                                       //
		return removeByRoomIdAndUserId;                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	return ModelSubscriptions;                                                                                            //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Subscriptions = new ModelSubscriptions('subscription', true);                                        // 597
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Uploads.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Uploads.js                                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
/* globals InstanceStatus */RocketChat.models.Uploads = new (function (_RocketChat$models$_B) {                        // 1
	(0, _inherits3.default)(_class, _RocketChat$models$_B);                                                               // 3
                                                                                                                       //
	function _class() {                                                                                                   // 4
		(0, _classCallCheck3.default)(this, _class);                                                                         // 4
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.call(this, 'uploads'));             // 4
                                                                                                                       //
		_this.model.before.insert(function (userId, doc) {                                                                   // 7
			doc.instanceId = InstanceStatus.id();                                                                               // 8
		});                                                                                                                  // 9
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 11
			'rid': 1                                                                                                            // 11
		});                                                                                                                  // 11
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 12
			'uploadedAt': 1                                                                                                     // 12
		});                                                                                                                  // 12
                                                                                                                       //
		return _this;                                                                                                        // 4
	}                                                                                                                     // 13
                                                                                                                       //
	_class.prototype.findNotHiddenFilesOfRoom = function () {                                                             // 3
		function findNotHiddenFilesOfRoom(roomId, limit) {                                                                   // 3
			var fileQuery = {                                                                                                   // 16
				rid: roomId,                                                                                                       // 17
				complete: true,                                                                                                    // 18
				uploading: false,                                                                                                  // 19
				_hidden: {                                                                                                         // 20
					$ne: true                                                                                                         // 21
				}                                                                                                                  // 20
			};                                                                                                                  // 16
			var fileOptions = {                                                                                                 // 25
				limit: limit,                                                                                                      // 26
				sort: {                                                                                                            // 27
					uploadedAt: -1                                                                                                    // 28
				},                                                                                                                 // 27
				fields: {                                                                                                          // 30
					_id: 1,                                                                                                           // 31
					userId: 1,                                                                                                        // 32
					rid: 1,                                                                                                           // 33
					name: 1,                                                                                                          // 34
					description: 1,                                                                                                   // 35
					type: 1,                                                                                                          // 36
					url: 1,                                                                                                           // 37
					uploadedAt: 1                                                                                                     // 38
				}                                                                                                                  // 30
			};                                                                                                                  // 25
			return this.find(fileQuery, fileOptions);                                                                           // 42
		}                                                                                                                    // 43
                                                                                                                       //
		return findNotHiddenFilesOfRoom;                                                                                     // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.insertFileInit = function () {                                                                       // 3
		function insertFileInit(userId, store, file, extra) {                                                                // 3
			var fileData = {                                                                                                    // 46
				userId: userId,                                                                                                    // 47
				store: store,                                                                                                      // 48
				complete: false,                                                                                                   // 49
				uploading: true,                                                                                                   // 50
				progress: 0,                                                                                                       // 51
				extension: s.strRightBack(file.name, '.'),                                                                         // 52
				uploadedAt: new Date()                                                                                             // 53
			};                                                                                                                  // 46
                                                                                                                       //
			_.extend(fileData, file, extra);                                                                                    // 56
                                                                                                                       //
			if (this.model.direct && this.model.direct.insert != null) {                                                        // 58
				file = this.model.direct.insert(fileData);                                                                         // 59
			} else {                                                                                                            // 60
				file = this.insert(fileData);                                                                                      // 61
			}                                                                                                                   // 62
                                                                                                                       //
			return file;                                                                                                        // 64
		}                                                                                                                    // 65
                                                                                                                       //
		return insertFileInit;                                                                                               // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.updateFileComplete = function () {                                                                   // 3
		function updateFileComplete(fileId, userId, file) {                                                                  // 3
			var result = void 0;                                                                                                // 68
                                                                                                                       //
			if (!fileId) {                                                                                                      // 69
				return;                                                                                                            // 70
			}                                                                                                                   // 71
                                                                                                                       //
			var filter = {                                                                                                      // 73
				_id: fileId,                                                                                                       // 74
				userId: userId                                                                                                     // 75
			};                                                                                                                  // 73
			var update = {                                                                                                      // 78
				$set: {                                                                                                            // 79
					complete: true,                                                                                                   // 80
					uploading: false,                                                                                                 // 81
					progress: 1                                                                                                       // 82
				}                                                                                                                  // 79
			};                                                                                                                  // 78
			update.$set = _.extend(file, update.$set);                                                                          // 86
                                                                                                                       //
			if (this.model.direct && this.model.direct.update != null) {                                                        // 88
				result = this.model.direct.update(filter, update);                                                                 // 89
			} else {                                                                                                            // 90
				result = this.update(filter, update);                                                                              // 91
			}                                                                                                                   // 92
                                                                                                                       //
			return result;                                                                                                      // 94
		}                                                                                                                    // 95
                                                                                                                       //
		return updateFileComplete;                                                                                           // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	_class.prototype.deleteFile = function () {                                                                           // 3
		function deleteFile(fileId) {                                                                                        // 3
			if (this.model.direct && this.model.direct.remove != null) {                                                        // 98
				return this.model.direct.remove({                                                                                  // 99
					_id: fileId                                                                                                       // 99
				});                                                                                                                // 99
			} else {                                                                                                            // 100
				return this.remove({                                                                                               // 101
					_id: fileId                                                                                                       // 101
				});                                                                                                                // 101
			}                                                                                                                   // 102
		}                                                                                                                    // 103
                                                                                                                       //
		return deleteFile;                                                                                                   // 3
	}();                                                                                                                  // 3
                                                                                                                       //
	return _class;                                                                                                        // 3
}(RocketChat.models._Base))();                                                                                         // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"Users.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/Users.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _slicedToArray2 = require("babel-runtime/helpers/slicedToArray");                                                  //
                                                                                                                       //
var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);                                                         //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var ModelUsers = function (_RocketChat$models$_B) {                                                                    //
	(0, _inherits3.default)(ModelUsers, _RocketChat$models$_B);                                                           //
                                                                                                                       //
	function ModelUsers() {                                                                                               // 2
		(0, _classCallCheck3.default)(this, ModelUsers);                                                                     // 2
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _RocketChat$models$_B.apply(this, arguments));            // 2
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 5
			'roles': 1                                                                                                          // 5
		}, {                                                                                                                 // 5
			sparse: 1                                                                                                           // 5
		});                                                                                                                  // 5
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 6
			'name': 1                                                                                                           // 6
		});                                                                                                                  // 6
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 7
			'lastLogin': 1                                                                                                      // 7
		});                                                                                                                  // 7
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 8
			'status': 1                                                                                                         // 8
		});                                                                                                                  // 8
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 9
			'active': 1                                                                                                         // 9
		}, {                                                                                                                 // 9
			sparse: 1                                                                                                           // 9
		});                                                                                                                  // 9
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 10
			'statusConnection': 1                                                                                               // 10
		}, {                                                                                                                 // 10
			sparse: 1                                                                                                           // 10
		});                                                                                                                  // 10
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 11
			'type': 1                                                                                                           // 11
		});                                                                                                                  // 11
                                                                                                                       //
		_this.cache.ensureIndex('username', 'unique');                                                                       // 13
                                                                                                                       //
		return _this;                                                                                                        // 2
	}                                                                                                                     // 14
                                                                                                                       //
	ModelUsers.prototype.findOneByImportId = function () {                                                                //
		function findOneByImportId(_id, options) {                                                                           //
			return this.findOne({                                                                                               // 17
				importIds: _id                                                                                                     // 17
			}, options);                                                                                                        // 17
		}                                                                                                                    // 18
                                                                                                                       //
		return findOneByImportId;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findOneByUsername = function () {                                                                //
		function findOneByUsername(username, options) {                                                                      //
			var query = {                                                                                                       // 21
				username: username                                                                                                 // 21
			};                                                                                                                  // 21
			return this.findOne(query, options);                                                                                // 23
		}                                                                                                                    // 24
                                                                                                                       //
		return findOneByUsername;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findOneByEmailAddress = function () {                                                            //
		function findOneByEmailAddress(emailAddress, options) {                                                              //
			var query = {                                                                                                       // 27
				'emails.address': new RegExp("^" + s.escapeRegExp(emailAddress) + "$", 'i')                                        // 27
			};                                                                                                                  // 27
			return this.findOne(query, options);                                                                                // 29
		}                                                                                                                    // 30
                                                                                                                       //
		return findOneByEmailAddress;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findOneAdmin = function () {                                                                     //
		function findOneAdmin(admin, options) {                                                                              //
			var query = {                                                                                                       // 33
				admin: admin                                                                                                       // 33
			};                                                                                                                  // 33
			return this.findOne(query, options);                                                                                // 35
		}                                                                                                                    // 36
                                                                                                                       //
		return findOneAdmin;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findOneByIdAndLoginToken = function () {                                                         //
		function findOneByIdAndLoginToken(_id, token, options) {                                                             //
			var query = {                                                                                                       // 39
				_id: _id,                                                                                                          // 40
				'services.resume.loginTokens.hashedToken': Accounts._hashLoginToken(token)                                         // 41
			};                                                                                                                  // 39
			return this.findOne(query, options);                                                                                // 44
		}                                                                                                                    // 45
                                                                                                                       //
		return findOneByIdAndLoginToken;                                                                                     //
	}(); // FIND                                                                                                          //
                                                                                                                       //
                                                                                                                       //
	ModelUsers.prototype.findById = function () {                                                                         //
		function findById(userId) {                                                                                          //
			var query = {                                                                                                       // 50
				_id: userId                                                                                                        // 50
			};                                                                                                                  // 50
			return this.find(query);                                                                                            // 52
		}                                                                                                                    // 53
                                                                                                                       //
		return findById;                                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findUsersNotOffline = function () {                                                              //
		function findUsersNotOffline(options) {                                                                              //
			var query = {                                                                                                       // 56
				username: {                                                                                                        // 57
					$exists: 1                                                                                                        // 58
				},                                                                                                                 // 57
				status: {                                                                                                          // 60
					$in: ['online', 'away', 'busy']                                                                                   // 61
				}                                                                                                                  // 60
			};                                                                                                                  // 56
			return this.find(query, options);                                                                                   // 65
		}                                                                                                                    // 66
                                                                                                                       //
		return findUsersNotOffline;                                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findByUsername = function () {                                                                   //
		function findByUsername(username, options) {                                                                         //
			var query = {                                                                                                       // 70
				username: username                                                                                                 // 70
			};                                                                                                                  // 70
			return this.find(query, options);                                                                                   // 72
		}                                                                                                                    // 73
                                                                                                                       //
		return findByUsername;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findUsersByUsernamesWithHighlights = function () {                                               //
		function findUsersByUsernamesWithHighlights(usernames, options) {                                                    //
			if (this.useCache) {                                                                                                // 76
				var result = {                                                                                                     // 77
					fetch: function () {                                                                                              // 78
						return RocketChat.models.Users.getDynamicView('highlights').data().filter(function (record) {                    // 79
							return usernames.indexOf(record.username) > -1;                                                                 // 79
						});                                                                                                              // 79
					},                                                                                                                // 80
					count: function () {                                                                                              // 81
						return result.fetch().length;                                                                                    // 82
					},                                                                                                                // 83
					forEach: function (fn) {                                                                                          // 84
						return result.fetch().forEach(fn);                                                                               // 85
					}                                                                                                                 // 86
				};                                                                                                                 // 77
				return result;                                                                                                     // 88
			}                                                                                                                   // 89
                                                                                                                       //
			var query = {                                                                                                       // 91
				username: {                                                                                                        // 92
					$in: usernames                                                                                                    // 92
				},                                                                                                                 // 92
				'settings.preferences.highlights.0': {                                                                             // 93
					$exists: true                                                                                                     // 94
				}                                                                                                                  // 93
			};                                                                                                                  // 91
			return this.find(query, options);                                                                                   // 98
		}                                                                                                                    // 99
                                                                                                                       //
		return findUsersByUsernamesWithHighlights;                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findActiveByUsernameOrNameRegexWithExceptions = function () {                                    //
		function findActiveByUsernameOrNameRegexWithExceptions(searchTerm, exceptions, options) {                            //
			if (exceptions == null) {                                                                                           // 102
				exceptions = [];                                                                                                   // 102
			}                                                                                                                   // 102
                                                                                                                       //
			if (options == null) {                                                                                              // 103
				options = {};                                                                                                      // 103
			}                                                                                                                   // 103
                                                                                                                       //
			if (!_.isArray(exceptions)) {                                                                                       // 104
				exceptions = [exceptions];                                                                                         // 105
			}                                                                                                                   // 106
                                                                                                                       //
			var termRegex = new RegExp(s.escapeRegExp(searchTerm), 'i');                                                        // 108
			var query = {                                                                                                       // 109
				$or: [{                                                                                                            // 110
					username: termRegex                                                                                               // 111
				}, {                                                                                                               // 110
					name: termRegex                                                                                                   // 113
				}],                                                                                                                // 112
				active: true,                                                                                                      // 115
				type: {                                                                                                            // 116
					$in: ['user', 'bot']                                                                                              // 117
				},                                                                                                                 // 116
				$and: [{                                                                                                           // 119
					username: {                                                                                                       // 120
						$exists: true                                                                                                    // 121
					}                                                                                                                 // 120
				}, {                                                                                                               // 119
					username: {                                                                                                       // 124
						$nin: exceptions                                                                                                 // 125
					}                                                                                                                 // 124
				}]                                                                                                                 // 123
			};                                                                                                                  // 109
			return this.find(query, options);                                                                                   // 130
		}                                                                                                                    // 131
                                                                                                                       //
		return findActiveByUsernameOrNameRegexWithExceptions;                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findByActiveUsersExcept = function () {                                                          //
		function findByActiveUsersExcept(searchTerm, exceptions, options) {                                                  //
			if (exceptions == null) {                                                                                           // 134
				exceptions = [];                                                                                                   // 134
			}                                                                                                                   // 134
                                                                                                                       //
			if (options == null) {                                                                                              // 135
				options = {};                                                                                                      // 135
			}                                                                                                                   // 135
                                                                                                                       //
			if (!_.isArray(exceptions)) {                                                                                       // 136
				exceptions = [exceptions];                                                                                         // 137
			}                                                                                                                   // 138
                                                                                                                       //
			var termRegex = new RegExp(s.escapeRegExp(searchTerm), 'i');                                                        // 140
                                                                                                                       //
			var orStmt = _.reduce(RocketChat.settings.get('Accounts_SearchFields').trim().split(','), function (acc, el) {      // 142
				var _acc$push;                                                                                                     // 142
                                                                                                                       //
				acc.push((_acc$push = {}, _acc$push[el.trim()] = termRegex, _acc$push));                                           // 143
				return acc;                                                                                                        // 144
			}, []);                                                                                                             // 145
                                                                                                                       //
			var query = {                                                                                                       // 146
				$and: [{                                                                                                           // 147
					active: true,                                                                                                     // 149
					$or: orStmt                                                                                                       // 150
				}, {                                                                                                               // 148
					username: {                                                                                                       // 153
						$exists: true,                                                                                                   // 153
						$nin: exceptions                                                                                                 // 153
					}                                                                                                                 // 153
				}]                                                                                                                 // 152
			}; // do not use cache                                                                                              // 146
                                                                                                                       //
			return this._db.find(query, options);                                                                               // 159
		}                                                                                                                    // 160
                                                                                                                       //
		return findByActiveUsersExcept;                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findUsersByNameOrUsername = function () {                                                        //
		function findUsersByNameOrUsername(nameOrUsername, options) {                                                        //
			var query = {                                                                                                       // 163
				username: {                                                                                                        // 164
					$exists: 1                                                                                                        // 165
				},                                                                                                                 // 164
				$or: [{                                                                                                            // 168
					name: nameOrUsername                                                                                              // 169
				}, {                                                                                                               // 169
					username: nameOrUsername                                                                                          // 170
				}],                                                                                                                // 170
				type: {                                                                                                            // 173
					$in: ['user']                                                                                                     // 174
				}                                                                                                                  // 173
			};                                                                                                                  // 163
			return this.find(query, options);                                                                                   // 178
		}                                                                                                                    // 179
                                                                                                                       //
		return findUsersByNameOrUsername;                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findByUsernameNameOrEmailAddress = function () {                                                 //
		function findByUsernameNameOrEmailAddress(usernameNameOrEmailAddress, options) {                                     //
			var query = {                                                                                                       // 182
				$or: [{                                                                                                            // 183
					name: usernameNameOrEmailAddress                                                                                  // 184
				}, {                                                                                                               // 184
					username: usernameNameOrEmailAddress                                                                              // 185
				}, {                                                                                                               // 185
					'emails.address': usernameNameOrEmailAddress                                                                      // 186
				}],                                                                                                                // 186
				type: {                                                                                                            // 188
					$in: ['user', 'bot']                                                                                              // 189
				}                                                                                                                  // 188
			};                                                                                                                  // 182
			return this.find(query, options);                                                                                   // 193
		}                                                                                                                    // 194
                                                                                                                       //
		return findByUsernameNameOrEmailAddress;                                                                             //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findLDAPUsers = function () {                                                                    //
		function findLDAPUsers(options) {                                                                                    //
			var query = {                                                                                                       // 197
				ldap: true                                                                                                         // 197
			};                                                                                                                  // 197
			return this.find(query, options);                                                                                   // 199
		}                                                                                                                    // 200
                                                                                                                       //
		return findLDAPUsers;                                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findCrowdUsers = function () {                                                                   //
		function findCrowdUsers(options) {                                                                                   //
			var query = {                                                                                                       // 203
				crowd: true                                                                                                        // 203
			};                                                                                                                  // 203
			return this.find(query, options);                                                                                   // 205
		}                                                                                                                    // 206
                                                                                                                       //
		return findCrowdUsers;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.getLastLogin = function () {                                                                     //
		function getLastLogin(options) {                                                                                     //
			if (options == null) {                                                                                              // 209
				options = {};                                                                                                      // 209
			}                                                                                                                   // 209
                                                                                                                       //
			var query = {                                                                                                       // 210
				lastLogin: {                                                                                                       // 210
					$exists: 1                                                                                                        // 210
				}                                                                                                                  // 210
			};                                                                                                                  // 210
			options.sort = {                                                                                                    // 211
				lastLogin: -1                                                                                                      // 211
			};                                                                                                                  // 211
			options.limit = 1;                                                                                                  // 212
                                                                                                                       //
			var _find$fetch = this.find(query, options).fetch(),                                                                // 208
			    _find$fetch2 = (0, _slicedToArray3.default)(_find$fetch, 1),                                                    // 208
			    user = _find$fetch2[0];                                                                                         // 208
                                                                                                                       //
			return user && user.lastLogin;                                                                                      // 214
		}                                                                                                                    // 215
                                                                                                                       //
		return getLastLogin;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findUsersByUsernames = function () {                                                             //
		function findUsersByUsernames(usernames, options) {                                                                  //
			var query = {                                                                                                       // 218
				username: {                                                                                                        // 219
					$in: usernames                                                                                                    // 220
				}                                                                                                                  // 219
			};                                                                                                                  // 218
			return this.find(query, options);                                                                                   // 224
		}                                                                                                                    // 225
                                                                                                                       //
		return findUsersByUsernames;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.findUsersByIds = function () {                                                                   //
		function findUsersByIds(ids, options) {                                                                              //
			var query = {                                                                                                       // 228
				_id: {                                                                                                             // 229
					$in: ids                                                                                                          // 230
				}                                                                                                                  // 229
			};                                                                                                                  // 228
			return this.find(query, options);                                                                                   // 233
		}                                                                                                                    // 234
                                                                                                                       //
		return findUsersByIds;                                                                                               //
	}(); // UPDATE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelUsers.prototype.addImportIds = function () {                                                                     //
		function addImportIds(_id, importIds) {                                                                              //
			importIds = [].concat(importIds);                                                                                   // 238
			var query = {                                                                                                       // 240
				_id: _id                                                                                                           // 240
			};                                                                                                                  // 240
			var update = {                                                                                                      // 242
				$addToSet: {                                                                                                       // 243
					importIds: {                                                                                                      // 244
						$each: importIds                                                                                                 // 245
					}                                                                                                                 // 244
				}                                                                                                                  // 243
			};                                                                                                                  // 242
			return this.update(query, update);                                                                                  // 250
		}                                                                                                                    // 251
                                                                                                                       //
		return addImportIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.updateLastLoginById = function () {                                                              //
		function updateLastLoginById(_id) {                                                                                  //
			var update = {                                                                                                      // 254
				$set: {                                                                                                            // 255
					lastLogin: new Date()                                                                                             // 256
				}                                                                                                                  // 255
			};                                                                                                                  // 254
			return this.update(_id, update);                                                                                    // 260
		}                                                                                                                    // 261
                                                                                                                       //
		return updateLastLoginById;                                                                                          //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setServiceId = function () {                                                                     //
		function setServiceId(_id, serviceName, serviceId) {                                                                 //
			var update = {                                                                                                      // 264
				$set: {}                                                                                                           // 265
			};                                                                                                                  // 265
			var serviceIdKey = "services." + serviceName + ".id";                                                               // 267
			update.$set[serviceIdKey] = serviceId;                                                                              // 268
			return this.update(_id, update);                                                                                    // 270
		}                                                                                                                    // 271
                                                                                                                       //
		return setServiceId;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setUsername = function () {                                                                      //
		function setUsername(_id, username) {                                                                                //
			var update = {                                                                                                      // 274
				$set: {                                                                                                            // 275
					username: username                                                                                                // 275
				}                                                                                                                  // 275
			};                                                                                                                  // 275
			return this.update(_id, update);                                                                                    // 277
		}                                                                                                                    // 278
                                                                                                                       //
		return setUsername;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setEmail = function () {                                                                         //
		function setEmail(_id, email) {                                                                                      //
			var update = {                                                                                                      // 281
				$set: {                                                                                                            // 282
					emails: [{                                                                                                        // 283
						address: email,                                                                                                  // 284
						verified: false                                                                                                  // 285
					}]                                                                                                                // 283
				}                                                                                                                  // 282
			};                                                                                                                  // 281
			return this.update(_id, update);                                                                                    // 291
		}                                                                                                                    // 292
                                                                                                                       //
		return setEmail;                                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setEmailVerified = function () {                                                                 //
		function setEmailVerified(_id, email) {                                                                              //
			var query = {                                                                                                       // 295
				_id: _id,                                                                                                          // 296
				emails: {                                                                                                          // 297
					$elemMatch: {                                                                                                     // 298
						address: email,                                                                                                  // 299
						verified: false                                                                                                  // 300
					}                                                                                                                 // 298
				}                                                                                                                  // 297
			};                                                                                                                  // 295
			var update = {                                                                                                      // 305
				$set: {                                                                                                            // 306
					'emails.$.verified': true                                                                                         // 307
				}                                                                                                                  // 306
			};                                                                                                                  // 305
			return this.update(query, update);                                                                                  // 311
		}                                                                                                                    // 312
                                                                                                                       //
		return setEmailVerified;                                                                                             //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setName = function () {                                                                          //
		function setName(_id, name) {                                                                                        //
			var update = {                                                                                                      // 315
				$set: {                                                                                                            // 316
					name: name                                                                                                        // 317
				}                                                                                                                  // 316
			};                                                                                                                  // 315
			return this.update(_id, update);                                                                                    // 321
		}                                                                                                                    // 322
                                                                                                                       //
		return setName;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setCustomFields = function () {                                                                  //
		function setCustomFields(_id, fields) {                                                                              //
			var values = {};                                                                                                    // 325
			Object.keys(fields).forEach(function (key) {                                                                        // 326
				values["customFields." + key] = fields[key];                                                                       // 327
			});                                                                                                                 // 328
			var update = {                                                                                                      // 330
				$set: values                                                                                                       // 330
			};                                                                                                                  // 330
			return this.update(_id, update);                                                                                    // 332
		}                                                                                                                    // 333
                                                                                                                       //
		return setCustomFields;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setAvatarOrigin = function () {                                                                  //
		function setAvatarOrigin(_id, origin) {                                                                              //
			var update = {                                                                                                      // 336
				$set: {                                                                                                            // 337
					avatarOrigin: origin                                                                                              // 338
				}                                                                                                                  // 337
			};                                                                                                                  // 336
			return this.update(_id, update);                                                                                    // 342
		}                                                                                                                    // 343
                                                                                                                       //
		return setAvatarOrigin;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.unsetAvatarOrigin = function () {                                                                //
		function unsetAvatarOrigin(_id) {                                                                                    //
			var update = {                                                                                                      // 346
				$unset: {                                                                                                          // 347
					avatarOrigin: 1                                                                                                   // 348
				}                                                                                                                  // 347
			};                                                                                                                  // 346
			return this.update(_id, update);                                                                                    // 352
		}                                                                                                                    // 353
                                                                                                                       //
		return unsetAvatarOrigin;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setUserActive = function () {                                                                    //
		function setUserActive(_id, active) {                                                                                //
			if (active == null) {                                                                                               // 356
				active = true;                                                                                                     // 356
			}                                                                                                                   // 356
                                                                                                                       //
			var update = {                                                                                                      // 357
				$set: {                                                                                                            // 358
					active: active                                                                                                    // 359
				}                                                                                                                  // 358
			};                                                                                                                  // 357
			return this.update(_id, update);                                                                                    // 363
		}                                                                                                                    // 364
                                                                                                                       //
		return setUserActive;                                                                                                //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setAllUsersActive = function () {                                                                //
		function setAllUsersActive(active) {                                                                                 //
			var update = {                                                                                                      // 367
				$set: {                                                                                                            // 368
					active: active                                                                                                    // 369
				}                                                                                                                  // 368
			};                                                                                                                  // 367
			return this.update({}, update, {                                                                                    // 373
				multi: true                                                                                                        // 373
			});                                                                                                                 // 373
		}                                                                                                                    // 374
                                                                                                                       //
		return setAllUsersActive;                                                                                            //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.unsetLoginTokens = function () {                                                                 //
		function unsetLoginTokens(_id) {                                                                                     //
			var update = {                                                                                                      // 377
				$set: {                                                                                                            // 378
					'services.resume.loginTokens': []                                                                                 // 379
				}                                                                                                                  // 378
			};                                                                                                                  // 377
			return this.update(_id, update);                                                                                    // 383
		}                                                                                                                    // 384
                                                                                                                       //
		return unsetLoginTokens;                                                                                             //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.unsetRequirePasswordChange = function () {                                                       //
		function unsetRequirePasswordChange(_id) {                                                                           //
			var update = {                                                                                                      // 387
				$unset: {                                                                                                          // 388
					'requirePasswordChange': true,                                                                                    // 389
					'requirePasswordChangeReason': true                                                                               // 390
				}                                                                                                                  // 388
			};                                                                                                                  // 387
			return this.update(_id, update);                                                                                    // 394
		}                                                                                                                    // 395
                                                                                                                       //
		return unsetRequirePasswordChange;                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.resetPasswordAndSetRequirePasswordChange = function () {                                         //
		function resetPasswordAndSetRequirePasswordChange(_id, requirePasswordChange, requirePasswordChangeReason) {         //
			var update = {                                                                                                      // 398
				$unset: {                                                                                                          // 399
					'services.password': 1                                                                                            // 400
				},                                                                                                                 // 399
				$set: {                                                                                                            // 402
					requirePasswordChange: requirePasswordChange,                                                                     // 403
					requirePasswordChangeReason: requirePasswordChangeReason                                                          // 404
				}                                                                                                                  // 402
			};                                                                                                                  // 398
			return this.update(_id, update);                                                                                    // 408
		}                                                                                                                    // 409
                                                                                                                       //
		return resetPasswordAndSetRequirePasswordChange;                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setLanguage = function () {                                                                      //
		function setLanguage(_id, language) {                                                                                //
			var update = {                                                                                                      // 412
				$set: {                                                                                                            // 413
					language: language                                                                                                // 414
				}                                                                                                                  // 413
			};                                                                                                                  // 412
			return this.update(_id, update);                                                                                    // 418
		}                                                                                                                    // 419
                                                                                                                       //
		return setLanguage;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setProfile = function () {                                                                       //
		function setProfile(_id, profile) {                                                                                  //
			var update = {                                                                                                      // 422
				$set: {                                                                                                            // 423
					'settings.profile': profile                                                                                       // 424
				}                                                                                                                  // 423
			};                                                                                                                  // 422
			return this.update(_id, update);                                                                                    // 428
		}                                                                                                                    // 429
                                                                                                                       //
		return setProfile;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setPreferences = function () {                                                                   //
		function setPreferences(_id, preferences) {                                                                          //
			var update = {                                                                                                      // 432
				$set: {                                                                                                            // 433
					'settings.preferences': preferences                                                                               // 434
				}                                                                                                                  // 433
			};                                                                                                                  // 432
			return this.update(_id, update);                                                                                    // 438
		}                                                                                                                    // 439
                                                                                                                       //
		return setPreferences;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.setUtcOffset = function () {                                                                     //
		function setUtcOffset(_id, utcOffset) {                                                                              //
			var query = {                                                                                                       // 442
				_id: _id,                                                                                                          // 443
				utcOffset: {                                                                                                       // 444
					$ne: utcOffset                                                                                                    // 445
				}                                                                                                                  // 444
			};                                                                                                                  // 442
			var update = {                                                                                                      // 449
				$set: {                                                                                                            // 450
					utcOffset: utcOffset                                                                                              // 451
				}                                                                                                                  // 450
			};                                                                                                                  // 449
			return this.update(query, update);                                                                                  // 455
		}                                                                                                                    // 456
                                                                                                                       //
		return setUtcOffset;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelUsers.prototype.saveUserById = function () {                                                                     //
		function saveUserById(_id, data) {                                                                                   //
			var setData = {};                                                                                                   // 459
			var unsetData = {};                                                                                                 // 460
                                                                                                                       //
			if (data.name != null) {                                                                                            // 462
				if (!_.isEmpty(s.trim(data.name))) {                                                                               // 463
					setData.name = s.trim(data.name);                                                                                 // 464
				} else {                                                                                                           // 465
					unsetData.name = 1;                                                                                               // 466
				}                                                                                                                  // 467
			}                                                                                                                   // 468
                                                                                                                       //
			if (data.email != null) {                                                                                           // 470
				if (!_.isEmpty(s.trim(data.email))) {                                                                              // 471
					setData.emails = [{                                                                                               // 472
						address: s.trim(data.email)                                                                                      // 472
					}];                                                                                                               // 472
				} else {                                                                                                           // 473
					unsetData.emails = 1;                                                                                             // 474
				}                                                                                                                  // 475
			}                                                                                                                   // 476
                                                                                                                       //
			if (data.phone != null) {                                                                                           // 478
				if (!_.isEmpty(s.trim(data.phone))) {                                                                              // 479
					setData.phone = [{                                                                                                // 480
						phoneNumber: s.trim(data.phone)                                                                                  // 480
					}];                                                                                                               // 480
				} else {                                                                                                           // 481
					unsetData.phone = 1;                                                                                              // 482
				}                                                                                                                  // 483
			}                                                                                                                   // 484
                                                                                                                       //
			var update = {};                                                                                                    // 486
                                                                                                                       //
			if (!_.isEmpty(setData)) {                                                                                          // 488
				update.$set = setData;                                                                                             // 489
			}                                                                                                                   // 490
                                                                                                                       //
			if (!_.isEmpty(unsetData)) {                                                                                        // 492
				update.$unset = unsetData;                                                                                         // 493
			}                                                                                                                   // 494
                                                                                                                       //
			if (_.isEmpty(update)) {                                                                                            // 496
				return true;                                                                                                       // 497
			}                                                                                                                   // 498
                                                                                                                       //
			return this.update({                                                                                                // 500
				_id: _id                                                                                                           // 500
			}, update);                                                                                                         // 500
		}                                                                                                                    // 501
                                                                                                                       //
		return saveUserById;                                                                                                 //
	}(); // INSERT                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelUsers.prototype.create = function () {                                                                           //
		function create(data) {                                                                                              //
			var user = {                                                                                                        // 505
				createdAt: new Date(),                                                                                             // 506
				avatarOrigin: 'none'                                                                                               // 507
			};                                                                                                                  // 505
                                                                                                                       //
			_.extend(user, data);                                                                                               // 510
                                                                                                                       //
			return this.insert(user);                                                                                           // 512
		}                                                                                                                    // 513
                                                                                                                       //
		return create;                                                                                                       //
	}(); // REMOVE                                                                                                        //
                                                                                                                       //
                                                                                                                       //
	ModelUsers.prototype.removeById = function () {                                                                       //
		function removeById(_id) {                                                                                           //
			return this.remove(_id);                                                                                            // 518
		}                                                                                                                    // 519
                                                                                                                       //
		return removeById;                                                                                                   //
	}(); /*                                                                                                               //
      Find users to send a message by email if:                                                                        //
      - he is not online                                                                                               //
      - has a verified email                                                                                           //
      - has not disabled email notifications                                                                           //
      - `active` is equal to true (false means they were deactivated and can't login)                                  //
      */                                                                                                               //
                                                                                                                       //
	ModelUsers.prototype.getUsersToSendOfflineEmail = function () {                                                       //
		function getUsersToSendOfflineEmail(usersIds) {                                                                      //
			var query = {                                                                                                       // 529
				_id: {                                                                                                             // 530
					$in: usersIds                                                                                                     // 531
				},                                                                                                                 // 530
				active: true,                                                                                                      // 533
				status: 'offline',                                                                                                 // 534
				statusConnection: {                                                                                                // 535
					$ne: 'online'                                                                                                     // 536
				},                                                                                                                 // 535
				'emails.verified': true                                                                                            // 538
			};                                                                                                                  // 529
			return this.find(query, {                                                                                           // 541
				fields: {                                                                                                          // 541
					name: 1,                                                                                                          // 541
					username: 1,                                                                                                      // 541
					emails: 1,                                                                                                        // 541
					'settings.preferences.emailNotificationMode': 1                                                                   // 541
				}                                                                                                                  // 541
			});                                                                                                                 // 541
		}                                                                                                                    // 542
                                                                                                                       //
		return getUsersToSendOfflineEmail;                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	return ModelUsers;                                                                                                    //
}(RocketChat.models._Base);                                                                                            //
                                                                                                                       //
RocketChat.models.Users = new ModelUsers(Meteor.users, true);                                                          // 545
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"_BaseCache.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/_BaseCache.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _toConsumableArray2 = require("babel-runtime/helpers/toConsumableArray");                                          //
                                                                                                                       //
var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);                                                 //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var loki = void 0;                                                                                                     // 1
module.watch(require("lokijs"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		loki = v;                                                                                                            // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
var EventEmitter = void 0;                                                                                             // 1
module.watch(require("events"), {                                                                                      // 1
	EventEmitter: function (v) {                                                                                          // 1
		EventEmitter = v;                                                                                                    // 1
	}                                                                                                                     // 1
}, 1);                                                                                                                 // 1
var objectPath = void 0;                                                                                               // 1
module.watch(require("object-path"), {                                                                                 // 1
	"default": function (v) {                                                                                             // 1
		objectPath = v;                                                                                                      // 1
	}                                                                                                                     // 1
}, 2);                                                                                                                 // 1
var logger = new Logger('BaseCache');                                                                                  // 7
var lokiEq = loki.LokiOps.$eq;                                                                                         // 9
var lokiNe = loki.LokiOps.$ne;                                                                                         // 10
                                                                                                                       //
loki.LokiOps.$eq = function (a, b) {                                                                                   // 12
	if (Array.isArray(a)) {                                                                                               // 13
		return a.indexOf(b) !== -1;                                                                                          // 14
	}                                                                                                                     // 15
                                                                                                                       //
	return lokiEq(a, b);                                                                                                  // 16
};                                                                                                                     // 17
                                                                                                                       //
loki.LokiOps.$ne = function (a, b) {                                                                                   // 19
	if (Array.isArray(a)) {                                                                                               // 20
		return a.indexOf(b) === -1;                                                                                          // 21
	}                                                                                                                     // 22
                                                                                                                       //
	return lokiNe(a, b);                                                                                                  // 23
};                                                                                                                     // 24
                                                                                                                       //
var lokiIn = loki.LokiOps.$in;                                                                                         // 26
                                                                                                                       //
loki.LokiOps.$in = function (a, b) {                                                                                   // 27
	if (Array.isArray(a)) {                                                                                               // 28
		return a.some(function (subA) {                                                                                      // 29
			return lokiIn(subA, b);                                                                                             // 29
		});                                                                                                                  // 29
	}                                                                                                                     // 30
                                                                                                                       //
	return lokiIn(a, b);                                                                                                  // 31
};                                                                                                                     // 32
                                                                                                                       //
loki.LokiOps.$nin = function (a, b) {                                                                                  // 34
	return !loki.LokiOps.$in(a, b);                                                                                       // 35
};                                                                                                                     // 36
                                                                                                                       //
loki.LokiOps.$all = function (a, b) {                                                                                  // 38
	return b.every(function (subB) {                                                                                      // 39
		return a.includes(subB);                                                                                             // 39
	});                                                                                                                   // 39
};                                                                                                                     // 40
                                                                                                                       //
loki.LokiOps.$exists = function (a, b) {                                                                               // 42
	if (b) {                                                                                                              // 43
		return loki.LokiOps.$ne(a, undefined);                                                                               // 44
	}                                                                                                                     // 45
                                                                                                                       //
	return loki.LokiOps.$eq(a, undefined);                                                                                // 47
};                                                                                                                     // 48
                                                                                                                       //
loki.LokiOps.$elemMatch = function (a, b) {                                                                            // 50
	return _.findWhere(a, b);                                                                                             // 51
};                                                                                                                     // 52
                                                                                                                       //
var ignore = ['emit', 'load', 'on', 'addToAllIndexes'];                                                                // 54
                                                                                                                       //
function traceMethodCalls(target) {                                                                                    // 61
	target._stats = {};                                                                                                   // 62
                                                                                                                       //
	var _loop = function (property) {                                                                                     // 61
		if (typeof target[property] === 'function' && ignore.indexOf(property) === -1) {                                     // 65
			target._stats[property] = {                                                                                         // 66
				calls: 0,                                                                                                          // 67
				time: 0,                                                                                                           // 68
				avg: 0                                                                                                             // 69
			};                                                                                                                  // 66
			var origMethod = target[property];                                                                                  // 71
                                                                                                                       //
			target[property] = function () {                                                                                    // 72
				for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {                             // 72
					args[_key] = arguments[_key];                                                                                     // 72
				}                                                                                                                  // 72
                                                                                                                       //
				if (target.loaded !== true) {                                                                                      // 74
					return origMethod.apply(target, args);                                                                            // 75
				}                                                                                                                  // 76
                                                                                                                       //
				var startTime = RocketChat.statsTracker.now();                                                                     // 78
				var result = origMethod.apply(target, args);                                                                       // 79
				var time = Math.round(RocketChat.statsTracker.now() - startTime) / 1000;                                           // 80
				target._stats[property].time += time;                                                                              // 81
				target._stats[property].calls++;                                                                                   // 82
				target._stats[property].avg = target._stats[property].time / target._stats[property].calls;                        // 83
				return result;                                                                                                     // 85
			};                                                                                                                  // 86
		}                                                                                                                    // 87
	};                                                                                                                    // 61
                                                                                                                       //
	for (var property in meteorBabelHelpers.sanitizeForInObject(target)) {                                                // 64
		_loop(property);                                                                                                     // 64
	}                                                                                                                     // 88
                                                                                                                       //
	setInterval(function () {                                                                                             // 90
		for (var property in meteorBabelHelpers.sanitizeForInObject(target._stats)) {                                        // 91
			if (target._stats.hasOwnProperty(property) && target._stats[property].time > 0) {                                   // 92
				var tags = ["property:" + property, "collection:" + target.collectionName];                                        // 93
				RocketChat.statsTracker.timing('cache.methods.time', target._stats[property].avg, tags);                           // 94
				RocketChat.statsTracker.increment('cache.methods.totalTime', target._stats[property].time, tags);                  // 95
				RocketChat.statsTracker.increment('cache.methods.count', target._stats[property].calls, tags);                     // 96
				target._stats[property].avg = 0;                                                                                   // 97
				target._stats[property].time = 0;                                                                                  // 98
				target._stats[property].calls = 0;                                                                                 // 99
			}                                                                                                                   // 100
		}                                                                                                                    // 101
	}, 10000);                                                                                                            // 102
                                                                                                                       //
	target._getStatsAvg = function () {                                                                                   // 104
		var stats = [];                                                                                                      // 105
                                                                                                                       //
		for (var property in meteorBabelHelpers.sanitizeForInObject(target._stats)) {                                        // 106
			if (target._stats.hasOwnProperty(property)) {                                                                       // 107
				stats.push([Math.round(target._stats[property].avg * 100) / 100, property]);                                       // 108
			}                                                                                                                   // 109
		}                                                                                                                    // 110
                                                                                                                       //
		return _.sortBy(stats, function (record) {                                                                           // 111
			return record[0];                                                                                                   // 112
		});                                                                                                                  // 113
	};                                                                                                                    // 114
}                                                                                                                      // 115
                                                                                                                       //
var Adapter = function () {                                                                                            //
	function Adapter() {                                                                                                  //
		(0, _classCallCheck3.default)(this, Adapter);                                                                        //
	}                                                                                                                     //
                                                                                                                       //
	Adapter.prototype.loadDatabase = function () {                                                                        //
		function loadDatabase() /*dbname, callback*/{}                                                                       //
                                                                                                                       //
		return loadDatabase;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	Adapter.prototype.saveDatabase = function () {                                                                        //
		function saveDatabase() /*dbname, dbstring, callback*/{}                                                             //
                                                                                                                       //
		return saveDatabase;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	Adapter.prototype.deleteDatabase = function () {                                                                      //
		function deleteDatabase() /*dbname, callback*/{}                                                                     //
                                                                                                                       //
		return deleteDatabase;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	return Adapter;                                                                                                       //
}();                                                                                                                   //
                                                                                                                       //
var db = new loki('rocket.chat.json', {                                                                                // 123
	adapter: Adapter                                                                                                      // 123
});                                                                                                                    // 123
                                                                                                                       //
var ModelsBaseCache = function (_EventEmitter) {                                                                       //
	(0, _inherits3.default)(ModelsBaseCache, _EventEmitter);                                                              //
                                                                                                                       //
	function ModelsBaseCache(model) {                                                                                     // 126
		(0, _classCallCheck3.default)(this, ModelsBaseCache);                                                                // 126
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _EventEmitter.call(this));                                // 126
                                                                                                                       //
		traceMethodCalls(_this);                                                                                             // 129
		_this.indexes = {};                                                                                                  // 131
		_this.ignoreUpdatedFields = ['_updatedAt'];                                                                          // 132
		_this.query = {};                                                                                                    // 134
		_this.options = {};                                                                                                  // 135
                                                                                                                       //
		_this.ensureIndex('_id', 'unique');                                                                                  // 137
                                                                                                                       //
		_this.joins = {};                                                                                                    // 139
                                                                                                                       //
		_this.on('inserted', function () {                                                                                   // 141
			for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {                        // 141
				args[_key2] = arguments[_key2];                                                                                    // 141
			}                                                                                                                   // 141
                                                                                                                       //
			_this.emit.apply(_this, ['changed', 'inserted'].concat(args));                                                      // 141
		});                                                                                                                  // 141
                                                                                                                       //
		_this.on('removed', function () {                                                                                    // 142
			for (var _len3 = arguments.length, args = Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {                        // 142
				args[_key3] = arguments[_key3];                                                                                    // 142
			}                                                                                                                   // 142
                                                                                                                       //
			_this.emit.apply(_this, ['changed', 'removed'].concat(args));                                                       // 142
		});                                                                                                                  // 142
                                                                                                                       //
		_this.on('updated', function () {                                                                                    // 143
			for (var _len4 = arguments.length, args = Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {                        // 143
				args[_key4] = arguments[_key4];                                                                                    // 143
			}                                                                                                                   // 143
                                                                                                                       //
			_this.emit.apply(_this, ['changed', 'updated'].concat(args));                                                       // 143
		});                                                                                                                  // 143
                                                                                                                       //
		_this.on('beforeinsert', function () {                                                                               // 145
			for (var _len5 = arguments.length, args = Array(_len5), _key5 = 0; _key5 < _len5; _key5++) {                        // 145
				args[_key5] = arguments[_key5];                                                                                    // 145
			}                                                                                                                   // 145
                                                                                                                       //
			_this.emit.apply(_this, ['beforechange', 'inserted'].concat(args));                                                 // 145
		});                                                                                                                  // 145
                                                                                                                       //
		_this.on('beforeremove', function () {                                                                               // 146
			for (var _len6 = arguments.length, args = Array(_len6), _key6 = 0; _key6 < _len6; _key6++) {                        // 146
				args[_key6] = arguments[_key6];                                                                                    // 146
			}                                                                                                                   // 146
                                                                                                                       //
			_this.emit.apply(_this, ['beforechange', 'removed'].concat(args));                                                  // 146
		});                                                                                                                  // 146
                                                                                                                       //
		_this.on('beforeupdate', function () {                                                                               // 147
			for (var _len7 = arguments.length, args = Array(_len7), _key7 = 0; _key7 < _len7; _key7++) {                        // 147
				args[_key7] = arguments[_key7];                                                                                    // 147
			}                                                                                                                   // 147
                                                                                                                       //
			_this.emit.apply(_this, ['beforechange', 'updated'].concat(args));                                                  // 147
		});                                                                                                                  // 147
                                                                                                                       //
		_this.on('inserted', function () {                                                                                   // 149
			for (var _len8 = arguments.length, args = Array(_len8), _key8 = 0; _key8 < _len8; _key8++) {                        // 149
				args[_key8] = arguments[_key8];                                                                                    // 149
			}                                                                                                                   // 149
                                                                                                                       //
			_this.emit.apply(_this, ['sync', 'inserted'].concat(args));                                                         // 149
		});                                                                                                                  // 149
                                                                                                                       //
		_this.on('updated', function () {                                                                                    // 150
			for (var _len9 = arguments.length, args = Array(_len9), _key9 = 0; _key9 < _len9; _key9++) {                        // 150
				args[_key9] = arguments[_key9];                                                                                    // 150
			}                                                                                                                   // 150
                                                                                                                       //
			_this.emit.apply(_this, ['sync', 'updated'].concat(args));                                                          // 150
		});                                                                                                                  // 150
                                                                                                                       //
		_this.on('beforeremove', function () {                                                                               // 151
			for (var _len10 = arguments.length, args = Array(_len10), _key10 = 0; _key10 < _len10; _key10++) {                  // 151
				args[_key10] = arguments[_key10];                                                                                  // 151
			}                                                                                                                   // 151
                                                                                                                       //
			_this.emit.apply(_this, ['sync', 'removed'].concat(args));                                                          // 151
		});                                                                                                                  // 151
                                                                                                                       //
		_this.db = db;                                                                                                       // 153
		_this.model = model;                                                                                                 // 155
		_this.collectionName = _this.model._db.collectionName;                                                               // 157
		_this.collection = _this.db.addCollection(_this.collectionName);                                                     // 158
		return _this;                                                                                                        // 126
	}                                                                                                                     // 159
                                                                                                                       //
	ModelsBaseCache.prototype.hasOne = function () {                                                                      //
		function hasOne(join, _ref) {                                                                                        //
			var field = _ref.field,                                                                                             // 161
			    link = _ref.link;                                                                                               // 161
			this.join({                                                                                                         // 162
				join: join,                                                                                                        // 162
				field: field,                                                                                                      // 162
				link: link,                                                                                                        // 162
				multi: false                                                                                                       // 162
			});                                                                                                                 // 162
		}                                                                                                                    // 163
                                                                                                                       //
		return hasOne;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.hasMany = function () {                                                                     //
		function hasMany(join, _ref2) {                                                                                      //
			var field = _ref2.field,                                                                                            // 165
			    link = _ref2.link;                                                                                              // 165
			this.join({                                                                                                         // 166
				join: join,                                                                                                        // 166
				field: field,                                                                                                      // 166
				link: link,                                                                                                        // 166
				multi: true                                                                                                        // 166
			});                                                                                                                 // 166
		}                                                                                                                    // 167
                                                                                                                       //
		return hasMany;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.join = function () {                                                                        //
		function join(_ref3) {                                                                                               //
			var _this2 = this;                                                                                                  // 169
                                                                                                                       //
			var _join = _ref3.join,                                                                                             // 169
			    field = _ref3.field,                                                                                            // 169
			    link = _ref3.link,                                                                                              // 169
			    multi = _ref3.multi;                                                                                            // 169
                                                                                                                       //
			if (!RocketChat.models[_join]) {                                                                                    // 170
				console.log("Invalid cache model " + _join);                                                                       // 171
				return;                                                                                                            // 172
			}                                                                                                                   // 173
                                                                                                                       //
			RocketChat.models[_join].cache.on('inserted', function (record) {                                                   // 175
				_this2.processRemoteJoinInserted({                                                                                 // 176
					join: _join,                                                                                                      // 176
					field: field,                                                                                                     // 176
					link: link,                                                                                                       // 176
					multi: multi,                                                                                                     // 176
					record: record                                                                                                    // 176
				});                                                                                                                // 176
			});                                                                                                                 // 177
                                                                                                                       //
			RocketChat.models[_join].cache.on('beforeupdate', function (record, diff) {                                         // 179
				if (diff[link.remote]) {                                                                                           // 180
					_this2.processRemoteJoinRemoved({                                                                                 // 181
						join: _join,                                                                                                     // 181
						field: field,                                                                                                    // 181
						link: link,                                                                                                      // 181
						multi: multi,                                                                                                    // 181
						record: record                                                                                                   // 181
					});                                                                                                               // 181
				}                                                                                                                  // 182
			});                                                                                                                 // 183
                                                                                                                       //
			RocketChat.models[_join].cache.on('updated', function (record, diff) {                                              // 185
				if (diff[link.remote]) {                                                                                           // 186
					_this2.processRemoteJoinInserted({                                                                                // 187
						join: _join,                                                                                                     // 187
						field: field,                                                                                                    // 187
						link: link,                                                                                                      // 187
						multi: multi,                                                                                                    // 187
						record: record                                                                                                   // 187
					});                                                                                                               // 187
				}                                                                                                                  // 188
			});                                                                                                                 // 189
                                                                                                                       //
			RocketChat.models[_join].cache.on('removed', function (record) {                                                    // 191
				_this2.processRemoteJoinRemoved({                                                                                  // 192
					join: _join,                                                                                                      // 192
					field: field,                                                                                                     // 192
					link: link,                                                                                                       // 192
					multi: multi,                                                                                                     // 192
					record: record                                                                                                    // 192
				});                                                                                                                // 192
			});                                                                                                                 // 193
                                                                                                                       //
			this.on('inserted', function (localRecord) {                                                                        // 195
				_this2.processLocalJoinInserted({                                                                                  // 196
					join: _join,                                                                                                      // 196
					field: field,                                                                                                     // 196
					link: link,                                                                                                       // 196
					multi: multi,                                                                                                     // 196
					localRecord: localRecord                                                                                          // 196
				});                                                                                                                // 196
			});                                                                                                                 // 197
			this.on('beforeupdate', function (localRecord, diff) {                                                              // 199
				if (diff[link.local]) {                                                                                            // 200
					if (multi === true) {                                                                                             // 201
						localRecord[field] = [];                                                                                         // 202
					} else {                                                                                                          // 203
						localRecord[field] = undefined;                                                                                  // 204
					}                                                                                                                 // 205
				}                                                                                                                  // 206
			});                                                                                                                 // 207
			this.on('updated', function (localRecord, diff) {                                                                   // 209
				if (diff[link.local]) {                                                                                            // 210
					_this2.processLocalJoinInserted({                                                                                 // 211
						join: _join,                                                                                                     // 211
						field: field,                                                                                                    // 211
						link: link,                                                                                                      // 211
						multi: multi,                                                                                                    // 211
						localRecord: localRecord                                                                                         // 211
					});                                                                                                               // 211
				}                                                                                                                  // 212
			});                                                                                                                 // 213
		}                                                                                                                    // 214
                                                                                                                       //
		return join;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processRemoteJoinInserted = function () {                                                   //
		function processRemoteJoinInserted(_ref4) {                                                                          //
			var field = _ref4.field,                                                                                            // 216
			    link = _ref4.link,                                                                                              // 216
			    multi = _ref4.multi,                                                                                            // 216
			    record = _ref4.record;                                                                                          // 216
                                                                                                                       //
			var localRecords = this._findByIndex(link.local, objectPath.get(record, link.remote));                              // 217
                                                                                                                       //
			if (!localRecords) {                                                                                                // 219
				return;                                                                                                            // 220
			}                                                                                                                   // 221
                                                                                                                       //
			if (!Array.isArray(localRecords)) {                                                                                 // 223
				localRecords = [localRecords];                                                                                     // 224
			}                                                                                                                   // 225
                                                                                                                       //
			for (var i = 0; i < localRecords.length; i++) {                                                                     // 227
				var localRecord = localRecords[i];                                                                                 // 228
                                                                                                                       //
				if (multi === true && !localRecord[field]) {                                                                       // 229
					localRecord[field] = [];                                                                                          // 230
				}                                                                                                                  // 231
                                                                                                                       //
				if (typeof link.where === 'function' && link.where(localRecord, record) === false) {                               // 233
					continue;                                                                                                         // 234
				}                                                                                                                  // 235
                                                                                                                       //
				var mutableRecord = record;                                                                                        // 237
                                                                                                                       //
				if (typeof link.transform === 'function') {                                                                        // 239
					mutableRecord = link.transform(localRecord, mutableRecord);                                                       // 240
				}                                                                                                                  // 241
                                                                                                                       //
				if (multi === true) {                                                                                              // 243
					localRecord[field].push(mutableRecord);                                                                           // 244
				} else {                                                                                                           // 245
					localRecord[field] = mutableRecord;                                                                               // 246
				}                                                                                                                  // 247
                                                                                                                       //
				this.emit("join:" + field + ":inserted", localRecord, mutableRecord);                                              // 249
				this.emit("join:" + field + ":changed", 'inserted', localRecord, mutableRecord);                                   // 250
			}                                                                                                                   // 251
		}                                                                                                                    // 252
                                                                                                                       //
		return processRemoteJoinInserted;                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processLocalJoinInserted = function () {                                                    //
		function processLocalJoinInserted(_ref5) {                                                                           //
			var join = _ref5.join,                                                                                              // 254
			    field = _ref5.field,                                                                                            // 254
			    link = _ref5.link,                                                                                              // 254
			    multi = _ref5.multi,                                                                                            // 254
			    localRecord = _ref5.localRecord;                                                                                // 254
                                                                                                                       //
			var records = RocketChat.models[join].cache._findByIndex(link.remote, objectPath.get(localRecord, link.local));     // 255
                                                                                                                       //
			if (!Array.isArray(records)) {                                                                                      // 257
				records = [records];                                                                                               // 258
			}                                                                                                                   // 259
                                                                                                                       //
			for (var i = 0; i < records.length; i++) {                                                                          // 261
				var record = records[i];                                                                                           // 262
                                                                                                                       //
				if (typeof link.where === 'function' && link.where(localRecord, record) === false) {                               // 264
					continue;                                                                                                         // 265
				}                                                                                                                  // 266
                                                                                                                       //
				if (typeof link.transform === 'function') {                                                                        // 268
					record = link.transform(localRecord, record);                                                                     // 269
				}                                                                                                                  // 270
                                                                                                                       //
				if (multi === true) {                                                                                              // 272
					localRecord[field].push(record);                                                                                  // 273
				} else {                                                                                                           // 274
					localRecord[field] = record;                                                                                      // 275
				}                                                                                                                  // 276
                                                                                                                       //
				this.emit("join:" + field + ":inserted", localRecord, record);                                                     // 278
				this.emit("join:" + field + ":changed", 'inserted', localRecord, record);                                          // 279
			}                                                                                                                   // 280
		}                                                                                                                    // 281
                                                                                                                       //
		return processLocalJoinInserted;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processRemoteJoinRemoved = function () {                                                    //
		function processRemoteJoinRemoved(_ref6) {                                                                           //
			var field = _ref6.field,                                                                                            // 283
			    link = _ref6.link,                                                                                              // 283
			    multi = _ref6.multi,                                                                                            // 283
			    record = _ref6.record;                                                                                          // 283
                                                                                                                       //
			var localRecords = this._findByIndex(link.local, objectPath.get(record, link.remote));                              // 284
                                                                                                                       //
			if (!localRecords) {                                                                                                // 286
				return;                                                                                                            // 287
			}                                                                                                                   // 288
                                                                                                                       //
			if (!Array.isArray(localRecords)) {                                                                                 // 290
				localRecords = [localRecords];                                                                                     // 291
			}                                                                                                                   // 292
                                                                                                                       //
			for (var i = 0; i < localRecords.length; i++) {                                                                     // 294
				var localRecord = localRecords[i];                                                                                 // 295
                                                                                                                       //
				if (multi === true) {                                                                                              // 297
					if (Array.isArray(localRecord[field])) {                                                                          // 298
						if (typeof link.remove === 'function') {                                                                         // 299
							link.remove(localRecord[field], record);                                                                        // 300
						} else if (localRecord[field].indexOf(record) > -1) {                                                            // 301
							localRecord[field].splice(localRecord[field].indexOf(record), 1);                                               // 302
						}                                                                                                                // 303
					}                                                                                                                 // 304
				} else {                                                                                                           // 305
					localRecord[field] = undefined;                                                                                   // 306
				}                                                                                                                  // 307
                                                                                                                       //
				this.emit("join:" + field + ":removed", localRecord, record);                                                      // 309
				this.emit("join:" + field + ":changed", 'removed', localRecord, record);                                           // 310
			}                                                                                                                   // 311
		}                                                                                                                    // 312
                                                                                                                       //
		return processRemoteJoinRemoved;                                                                                     //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.ensureIndex = function () {                                                                 //
		function ensureIndex(fields) {                                                                                       //
			var type = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'array';                             // 314
                                                                                                                       //
			if (!Array.isArray(fields)) {                                                                                       // 315
				fields = [fields];                                                                                                 // 316
			}                                                                                                                   // 317
                                                                                                                       //
			this.indexes[fields.join(',')] = {                                                                                  // 319
				type: type,                                                                                                        // 320
				fields: fields,                                                                                                    // 321
				data: {}                                                                                                           // 322
			};                                                                                                                  // 319
		}                                                                                                                    // 324
                                                                                                                       //
		return ensureIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.addToAllIndexes = function () {                                                             //
		function addToAllIndexes(record) {                                                                                   //
			for (var indexName in meteorBabelHelpers.sanitizeForInObject(this.indexes)) {                                       // 327
				if (this.indexes.hasOwnProperty(indexName)) {                                                                      // 328
					this.addToIndex(indexName, record);                                                                               // 329
				}                                                                                                                  // 330
			}                                                                                                                   // 331
		}                                                                                                                    // 332
                                                                                                                       //
		return addToAllIndexes;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.addToIndex = function () {                                                                  //
		function addToIndex(indexName, record) {                                                                             //
			var index = this.indexes[indexName];                                                                                // 335
                                                                                                                       //
			if (!index) {                                                                                                       // 336
				console.error("Index not defined " + indexName);                                                                   // 337
				return;                                                                                                            // 338
			}                                                                                                                   // 339
                                                                                                                       //
			var keys = [];                                                                                                      // 341
                                                                                                                       //
			for (var _iterator = index.fields, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
				var _ref7;                                                                                                         // 342
                                                                                                                       //
				if (_isArray) {                                                                                                    // 342
					if (_i >= _iterator.length) break;                                                                                // 342
					_ref7 = _iterator[_i++];                                                                                          // 342
				} else {                                                                                                           // 342
					_i = _iterator.next();                                                                                            // 342
					if (_i.done) break;                                                                                               // 342
					_ref7 = _i.value;                                                                                                 // 342
				}                                                                                                                  // 342
                                                                                                                       //
				var field = _ref7;                                                                                                 // 342
				keys.push(objectPath.get(record, field));                                                                          // 343
			}                                                                                                                   // 344
                                                                                                                       //
			var key = keys.join('|');                                                                                           // 345
                                                                                                                       //
			if (index.type === 'unique') {                                                                                      // 347
				index.data[key] = record;                                                                                          // 348
				return;                                                                                                            // 349
			}                                                                                                                   // 350
                                                                                                                       //
			if (index.type === 'array') {                                                                                       // 352
				if (!index.data[key]) {                                                                                            // 353
					index.data[key] = [];                                                                                             // 354
				}                                                                                                                  // 355
                                                                                                                       //
				index.data[key].push(record);                                                                                      // 356
				return;                                                                                                            // 357
			}                                                                                                                   // 358
		}                                                                                                                    // 359
                                                                                                                       //
		return addToIndex;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.removeFromAllIndexes = function () {                                                        //
		function removeFromAllIndexes(record) {                                                                              //
			for (var indexName in meteorBabelHelpers.sanitizeForInObject(this.indexes)) {                                       // 362
				if (this.indexes.hasOwnProperty(indexName)) {                                                                      // 363
					this.removeFromIndex(indexName, record);                                                                          // 364
				}                                                                                                                  // 365
			}                                                                                                                   // 366
		}                                                                                                                    // 367
                                                                                                                       //
		return removeFromAllIndexes;                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.removeFromIndex = function () {                                                             //
		function removeFromIndex(indexName, record) {                                                                        //
			var index = this.indexes[indexName];                                                                                // 370
                                                                                                                       //
			if (!this.indexes[indexName]) {                                                                                     // 371
				console.error("Index not defined " + indexName);                                                                   // 372
				return;                                                                                                            // 373
			}                                                                                                                   // 374
                                                                                                                       //
			if (!index.data) {                                                                                                  // 376
				return;                                                                                                            // 377
			}                                                                                                                   // 378
                                                                                                                       //
			var key = [];                                                                                                       // 380
                                                                                                                       //
			for (var _iterator2 = index.fields, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
				var _ref8;                                                                                                         // 381
                                                                                                                       //
				if (_isArray2) {                                                                                                   // 381
					if (_i2 >= _iterator2.length) break;                                                                              // 381
					_ref8 = _iterator2[_i2++];                                                                                        // 381
				} else {                                                                                                           // 381
					_i2 = _iterator2.next();                                                                                          // 381
					if (_i2.done) break;                                                                                              // 381
					_ref8 = _i2.value;                                                                                                // 381
				}                                                                                                                  // 381
                                                                                                                       //
				var field = _ref8;                                                                                                 // 381
				key.push(objectPath.get(record, field));                                                                           // 382
			}                                                                                                                   // 383
                                                                                                                       //
			key = key.join('|');                                                                                                // 384
                                                                                                                       //
			if (index.type === 'unique') {                                                                                      // 386
				index.data[key] = undefined;                                                                                       // 387
				return;                                                                                                            // 388
			}                                                                                                                   // 389
                                                                                                                       //
			if (index.type === 'array') {                                                                                       // 391
				if (!index.data[key]) {                                                                                            // 392
					return;                                                                                                           // 393
				}                                                                                                                  // 394
                                                                                                                       //
				var i = index.data[key].indexOf(record);                                                                           // 395
                                                                                                                       //
				if (i > -1) {                                                                                                      // 396
					index.data[key].splice(i, 1);                                                                                     // 397
				}                                                                                                                  // 398
                                                                                                                       //
				return;                                                                                                            // 399
			}                                                                                                                   // 400
		}                                                                                                                    // 401
                                                                                                                       //
		return removeFromIndex;                                                                                              //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype._findByIndex = function () {                                                                //
		function _findByIndex(index, keys) {                                                                                 //
			var key = [].concat(keys).join('|');                                                                                // 404
                                                                                                                       //
			if (!this.indexes[index]) {                                                                                         // 405
				return;                                                                                                            // 406
			}                                                                                                                   // 407
                                                                                                                       //
			if (this.indexes[index].data) {                                                                                     // 409
				var result = this.indexes[index].data[key];                                                                        // 410
                                                                                                                       //
				if (result) {                                                                                                      // 411
					return result;                                                                                                    // 412
				}                                                                                                                  // 413
			}                                                                                                                   // 414
                                                                                                                       //
			if (this.indexes[index].type === 'array') {                                                                         // 416
				return [];                                                                                                         // 417
			}                                                                                                                   // 418
		}                                                                                                                    // 419
                                                                                                                       //
		return _findByIndex;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findByIndex = function () {                                                                 //
		function findByIndex(index, keys) {                                                                                  //
			var _this3 = this;                                                                                                  // 421
                                                                                                                       //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 421
			return {                                                                                                            // 422
				fetch: function () {                                                                                               // 423
					return _this3.processQueryOptionsOnResult(_this3._findByIndex(index, keys), options);                             // 424
				},                                                                                                                 // 425
				count: function () {                                                                                               // 427
					var records = _this3.findByIndex(index, keys, options).fetch();                                                   // 428
                                                                                                                       //
					if (Array.isArray(records)) {                                                                                     // 429
						return records.length;                                                                                           // 430
					}                                                                                                                 // 431
                                                                                                                       //
					return !records ? 0 : 1;                                                                                          // 432
				},                                                                                                                 // 433
				forEach: function (fn) {                                                                                           // 435
					var records = _this3.findByIndex(index, keys, options).fetch();                                                   // 436
                                                                                                                       //
					if (Array.isArray(records)) {                                                                                     // 437
						return records.forEach(fn);                                                                                      // 438
					}                                                                                                                 // 439
                                                                                                                       //
					if (records) {                                                                                                    // 440
						return fn(records);                                                                                              // 441
					}                                                                                                                 // 442
				}                                                                                                                  // 443
			};                                                                                                                  // 422
		}                                                                                                                    // 445
                                                                                                                       //
		return findByIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.load = function () {                                                                        //
		function load() {                                                                                                    //
			if (this.model._useCache === false) {                                                                               // 448
				return;                                                                                                            // 449
			}                                                                                                                   // 450
                                                                                                                       //
			console.log('Will load cache for', this.collectionName);                                                            // 452
			this.emit('beforeload');                                                                                            // 453
			this.loaded = false;                                                                                                // 454
			var time = RocketChat.statsTracker.now();                                                                           // 455
			var data = this.model.db.find(this.query, this.options).fetch();                                                    // 456
                                                                                                                       //
			for (var i = 0; i < data.length; i++) {                                                                             // 457
				this.insert(data[i]);                                                                                              // 458
			}                                                                                                                   // 459
                                                                                                                       //
			console.log(String(data.length), 'records load from', this.collectionName);                                         // 460
			RocketChat.statsTracker.timing('cache.load', RocketChat.statsTracker.now() - time, ["collection:" + this.collectionName]);
			this.startSync();                                                                                                   // 463
			this.loaded = true;                                                                                                 // 464
			this.emit('afterload');                                                                                             // 465
		}                                                                                                                    // 466
                                                                                                                       //
		return load;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.startSync = function () {                                                                   //
		function startSync() {                                                                                               //
			var _this4 = this;                                                                                                  // 468
                                                                                                                       //
			if (this.model._useCache === false) {                                                                               // 469
				return;                                                                                                            // 470
			}                                                                                                                   // 471
                                                                                                                       //
			this.model._db.on('change', function (_ref9) {                                                                      // 473
				var action = _ref9.action,                                                                                         // 473
				    id = _ref9.id,                                                                                                 // 473
				    data = _ref9.data;                                                                                             // 473
                                                                                                                       //
				switch (action) {                                                                                                  // 474
					case 'insert':                                                                                                    // 475
						data._id = id;                                                                                                   // 476
                                                                                                                       //
						_this4.insert(data);                                                                                             // 477
                                                                                                                       //
						break;                                                                                                           // 478
                                                                                                                       //
					case 'remove':                                                                                                    // 480
						_this4.removeById(id);                                                                                           // 481
                                                                                                                       //
						break;                                                                                                           // 482
                                                                                                                       //
					case 'update:record':                                                                                             // 484
						_this4.updateDiffById(id, data);                                                                                 // 485
                                                                                                                       //
						break;                                                                                                           // 486
                                                                                                                       //
					case 'update:diff':                                                                                               // 488
						_this4.updateDiffById(id, data);                                                                                 // 489
                                                                                                                       //
						break;                                                                                                           // 490
                                                                                                                       //
					case 'update:query':                                                                                              // 492
						_this4.update(data.query, data.update, data.options);                                                            // 493
                                                                                                                       //
						break;                                                                                                           // 494
				}                                                                                                                  // 474
			});                                                                                                                 // 496
		}                                                                                                                    // 497
                                                                                                                       //
		return startSync;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processQueryOptionsOnResult = function () {                                                 //
		function processQueryOptionsOnResult(result) {                                                                       //
			var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                               // 499
                                                                                                                       //
			if (result === undefined || result === null) {                                                                      // 500
				return undefined;                                                                                                  // 501
			}                                                                                                                   // 502
                                                                                                                       //
			if (Array.isArray(result)) {                                                                                        // 504
				if (options.sort) {                                                                                                // 505
					result = result.sort(function (a, b) {                                                                            // 506
						var r = 0;                                                                                                       // 507
                                                                                                                       //
						for (var field in meteorBabelHelpers.sanitizeForInObject(options.sort)) {                                        // 508
							if (options.sort.hasOwnProperty(field)) {                                                                       // 509
								var direction = options.sort[field];                                                                           // 510
								var valueA = void 0;                                                                                           // 511
								var valueB = void 0;                                                                                           // 512
                                                                                                                       //
								if (field.indexOf('.') > -1) {                                                                                 // 513
									valueA = objectPath.get(a, field);                                                                            // 514
									valueB = objectPath.get(b, field);                                                                            // 515
								} else {                                                                                                       // 516
									valueA = a[field];                                                                                            // 517
									valueB = b[field];                                                                                            // 518
								}                                                                                                              // 519
                                                                                                                       //
								if (valueA > valueB) {                                                                                         // 520
									r = direction;                                                                                                // 521
									break;                                                                                                        // 522
								}                                                                                                              // 523
                                                                                                                       //
								if (valueA < valueB) {                                                                                         // 524
									r = -direction;                                                                                               // 525
									break;                                                                                                        // 526
								}                                                                                                              // 527
							}                                                                                                               // 528
						}                                                                                                                // 529
                                                                                                                       //
						return r;                                                                                                        // 530
					});                                                                                                               // 531
				}                                                                                                                  // 532
                                                                                                                       //
				if (typeof options.skip === 'number') {                                                                            // 534
					result.splice(0, options.skip);                                                                                   // 535
				}                                                                                                                  // 536
                                                                                                                       //
				if (typeof options.limit === 'number' && options.limit !== 0) {                                                    // 538
					result.splice(options.limit);                                                                                     // 539
				}                                                                                                                  // 540
			}                                                                                                                   // 541
                                                                                                                       //
			if (!options.fields) {                                                                                              // 543
				options.fields = {};                                                                                               // 544
			}                                                                                                                   // 545
                                                                                                                       //
			var fieldsToRemove = [];                                                                                            // 547
			var fieldsToGet = [];                                                                                               // 548
                                                                                                                       //
			for (var field in meteorBabelHelpers.sanitizeForInObject(options.fields)) {                                         // 550
				if (options.fields.hasOwnProperty(field)) {                                                                        // 551
					if (options.fields[field] === 0) {                                                                                // 552
						fieldsToRemove.push(field);                                                                                      // 553
					} else if (options.fields[field] === 1) {                                                                         // 554
						fieldsToGet.push(field);                                                                                         // 555
					}                                                                                                                 // 556
				}                                                                                                                  // 557
			}                                                                                                                   // 558
                                                                                                                       //
			if (fieldsToRemove.length > 0 && fieldsToGet.length > 0) {                                                          // 560
				console.warn('Can\'t mix remove and get fields');                                                                  // 561
				fieldsToRemove.splice(0, fieldsToRemove.length);                                                                   // 562
			}                                                                                                                   // 563
                                                                                                                       //
			if (fieldsToGet.length > 0 && fieldsToGet.indexOf('_id') === -1) {                                                  // 565
				fieldsToGet.push('_id');                                                                                           // 566
			}                                                                                                                   // 567
                                                                                                                       //
			var pickFields = function (obj, fields) {                                                                           // 569
				var picked = {};                                                                                                   // 570
				fields.forEach(function (field) {                                                                                  // 571
					if (field.indexOf('.') !== -1) {                                                                                  // 572
						objectPath.set(picked, field, objectPath.get(obj, field));                                                       // 573
					} else {                                                                                                          // 574
						picked[field] = obj[field];                                                                                      // 575
					}                                                                                                                 // 576
				});                                                                                                                // 577
				return picked;                                                                                                     // 578
			};                                                                                                                  // 579
                                                                                                                       //
			if (fieldsToRemove.length > 0 || fieldsToGet.length > 0) {                                                          // 581
				if (Array.isArray(result)) {                                                                                       // 582
					result = result.map(function (record) {                                                                           // 583
						if (fieldsToRemove.length > 0) {                                                                                 // 584
							var _ref10;                                                                                                     // 584
                                                                                                                       //
							return (_ref10 = _).omit.apply(_ref10, [record].concat(fieldsToRemove));                                        // 585
						}                                                                                                                // 586
                                                                                                                       //
						if (fieldsToGet.length > 0) {                                                                                    // 588
							return pickFields(record, fieldsToGet);                                                                         // 589
						}                                                                                                                // 590
					});                                                                                                               // 591
				} else {                                                                                                           // 592
					if (fieldsToRemove.length > 0) {                                                                                  // 593
						var _ref11;                                                                                                      // 593
                                                                                                                       //
						return (_ref11 = _).omit.apply(_ref11, [result].concat(fieldsToRemove));                                         // 594
					}                                                                                                                 // 595
                                                                                                                       //
					if (fieldsToGet.length > 0) {                                                                                     // 597
						return pickFields(result, fieldsToGet);                                                                          // 598
					}                                                                                                                 // 599
				}                                                                                                                  // 600
			}                                                                                                                   // 601
                                                                                                                       //
			return result;                                                                                                      // 603
		}                                                                                                                    // 604
                                                                                                                       //
		return processQueryOptionsOnResult;                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.processQuery = function () {                                                                //
		function processQuery(query, parentField) {                                                                          //
			var _this5 = this;                                                                                                  // 606
                                                                                                                       //
			if (!query) {                                                                                                       // 607
				return query;                                                                                                      // 608
			}                                                                                                                   // 609
                                                                                                                       //
			if (Match.test(query, String)) {                                                                                    // 611
				return {                                                                                                           // 612
					_id: query                                                                                                        // 613
				};                                                                                                                 // 612
			}                                                                                                                   // 615
                                                                                                                       //
			if (Object.keys(query).length > 1 && parentField !== '$elemMatch') {                                                // 617
				var and = [];                                                                                                      // 618
                                                                                                                       //
				for (var field in meteorBabelHelpers.sanitizeForInObject(query)) {                                                 // 619
					if (query.hasOwnProperty(field)) {                                                                                // 620
						var _and$push;                                                                                                   // 620
                                                                                                                       //
						and.push((_and$push = {}, _and$push[field] = query[field], _and$push));                                          // 621
					}                                                                                                                 // 624
				}                                                                                                                  // 625
                                                                                                                       //
				query = {                                                                                                          // 626
					$and: and                                                                                                         // 626
				};                                                                                                                 // 626
			}                                                                                                                   // 627
                                                                                                                       //
			var _loop2 = function (_field) {                                                                                    // 606
				if (query.hasOwnProperty(_field)) {                                                                                // 630
					var value = query[_field];                                                                                        // 631
                                                                                                                       //
					if (value instanceof RegExp && _field !== '$regex') {                                                             // 632
						query[_field] = {                                                                                                // 633
							$regex: value                                                                                                   // 634
						};                                                                                                               // 633
					}                                                                                                                 // 636
                                                                                                                       //
					if (_field === '$and' || _field === '$or') {                                                                      // 638
						query[_field] = value.map(function (subValue) {                                                                  // 639
							return _this5.processQuery(subValue, _field);                                                                   // 640
						});                                                                                                              // 641
					}                                                                                                                 // 642
                                                                                                                       //
					if (Match.test(value, Object) && Object.keys(value).length > 0) {                                                 // 644
						query[_field] = _this5.processQuery(value, _field);                                                              // 645
					}                                                                                                                 // 646
				}                                                                                                                  // 647
			};                                                                                                                  // 606
                                                                                                                       //
			for (var _field in meteorBabelHelpers.sanitizeForInObject(query)) {                                                 // 629
				_loop2(_field);                                                                                                    // 629
			}                                                                                                                   // 648
                                                                                                                       //
			return query;                                                                                                       // 650
		}                                                                                                                    // 651
                                                                                                                       //
		return processQuery;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.find = function () {                                                                        //
		function find(query) {                                                                                               //
			var _this6 = this,                                                                                                  // 653
			    _arguments = arguments;                                                                                         // 653
                                                                                                                       //
			var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                               // 653
			return {                                                                                                            // 654
				fetch: function () {                                                                                               // 655
					try {                                                                                                             // 656
						query = _this6.processQuery(query);                                                                              // 657
						return _this6.processQueryOptionsOnResult(_this6.collection.find(query), options);                               // 658
					} catch (e) {                                                                                                     // 659
						console.error('Exception on cache find for', _this6.collectionName);                                             // 660
						console.error('Query:', JSON.stringify(query, null, 2));                                                         // 661
						console.error('Options:', JSON.stringify(options, null, 2));                                                     // 662
						console.error(e.stack);                                                                                          // 663
						throw e;                                                                                                         // 664
					}                                                                                                                 // 665
				},                                                                                                                 // 666
				count: function () {                                                                                               // 668
					try {                                                                                                             // 669
						query = _this6.processQuery(query);                                                                              // 670
						var limit = options.limit,                                                                                       // 669
						    skip = options.skip;                                                                                         // 669
						return _this6.processQueryOptionsOnResult(_this6.collection.find(query), {                                       // 672
							limit: limit,                                                                                                   // 672
							skip: skip                                                                                                      // 672
						}).length;                                                                                                       // 672
					} catch (e) {                                                                                                     // 673
						console.error('Exception on cache find for', _this6.collectionName);                                             // 674
						console.error('Query:', JSON.stringify(query, null, 2));                                                         // 675
						console.error('Options:', JSON.stringify(options, null, 2));                                                     // 676
						console.error(e.stack);                                                                                          // 677
						throw e;                                                                                                         // 678
					}                                                                                                                 // 679
				},                                                                                                                 // 680
				forEach: function (fn) {                                                                                           // 682
					return _this6.find(query, options).fetch().forEach(fn);                                                           // 683
				},                                                                                                                 // 684
				observe: function (obj) {                                                                                          // 686
					var _model$db;                                                                                                    // 686
                                                                                                                       //
					logger.debug(_this6.collectionName, 'Falling back observe to model with query:', query);                          // 687
					return (_model$db = _this6.model.db).find.apply(_model$db, _arguments).observe(obj);                              // 688
				},                                                                                                                 // 689
				observeChanges: function (obj) {                                                                                   // 691
					var _model$db2;                                                                                                   // 691
                                                                                                                       //
					logger.debug(_this6.collectionName, 'Falling back observeChanges to model with query:', query);                   // 692
					return (_model$db2 = _this6.model.db).find.apply(_model$db2, _arguments).observeChanges(obj);                     // 693
				},                                                                                                                 // 694
				_publishCursor: function (cursor, sub, collection) {                                                               // 696
					var _model$db3;                                                                                                   // 696
                                                                                                                       //
					logger.debug(_this6.collectionName, 'Falling back _publishCursor to model with query:', query);                   // 697
					return (_model$db3 = _this6.model.db).find.apply(_model$db3, _arguments)._publishCursor(cursor, sub, collection);
				}                                                                                                                  // 699
			};                                                                                                                  // 654
		}                                                                                                                    // 701
                                                                                                                       //
		return find;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findOne = function () {                                                                     //
		function findOne(query, options) {                                                                                   //
			try {                                                                                                               // 704
				query = this.processQuery(query);                                                                                  // 705
				return this.processQueryOptionsOnResult(this.collection.findOne(query), options);                                  // 706
			} catch (e) {                                                                                                       // 707
				console.error('Exception on cache findOne for', this.collectionName);                                              // 708
				console.error('Query:', JSON.stringify(query, null, 2));                                                           // 709
				console.error('Options:', JSON.stringify(options, null, 2));                                                       // 710
				console.error(e.stack);                                                                                            // 711
				throw e;                                                                                                           // 712
			}                                                                                                                   // 713
		}                                                                                                                    // 714
                                                                                                                       //
		return findOne;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findOneById = function () {                                                                 //
		function findOneById(_id, options) {                                                                                 //
			return this.findByIndex('_id', _id, options).fetch();                                                               // 717
		}                                                                                                                    // 718
                                                                                                                       //
		return findOneById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findOneByIds = function () {                                                                //
		function findOneByIds(ids, options) {                                                                                //
			var query = this.processQuery({                                                                                     // 721
				_id: {                                                                                                             // 721
					$in: ids                                                                                                          // 721
				}                                                                                                                  // 721
			});                                                                                                                 // 721
			return this.processQueryOptionsOnResult(this.collection.findOne(query), options);                                   // 722
		}                                                                                                                    // 723
                                                                                                                       //
		return findOneByIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.findWhere = function () {                                                                   //
		function findWhere(query, options) {                                                                                 //
			query = this.processQuery(query);                                                                                   // 726
			return this.processQueryOptionsOnResult(this.collection.findWhere(query), options);                                 // 727
		}                                                                                                                    // 728
                                                                                                                       //
		return findWhere;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.addDynamicView = function () {                                                              //
		function addDynamicView() {                                                                                          //
			var _collection;                                                                                                    // 730
                                                                                                                       //
			return (_collection = this.collection).addDynamicView.apply(_collection, arguments);                                // 731
		}                                                                                                                    // 732
                                                                                                                       //
		return addDynamicView;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.getDynamicView = function () {                                                              //
		function getDynamicView() {                                                                                          //
			var _collection2;                                                                                                   // 734
                                                                                                                       //
			return (_collection2 = this.collection).getDynamicView.apply(_collection2, arguments);                              // 735
		}                                                                                                                    // 736
                                                                                                                       //
		return getDynamicView;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.insert = function () {                                                                      //
		function insert(record) {                                                                                            //
			if (Array.isArray(record)) {                                                                                        // 739
				for (var _iterator3 = record, _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[Symbol.iterator]();;) {
					var _ref12;                                                                                                       // 740
                                                                                                                       //
					if (_isArray3) {                                                                                                  // 740
						if (_i3 >= _iterator3.length) break;                                                                             // 740
						_ref12 = _iterator3[_i3++];                                                                                      // 740
					} else {                                                                                                          // 740
						_i3 = _iterator3.next();                                                                                         // 740
						if (_i3.done) break;                                                                                             // 740
						_ref12 = _i3.value;                                                                                              // 740
					}                                                                                                                 // 740
                                                                                                                       //
					var item = _ref12;                                                                                                // 740
					this.insert(item);                                                                                                // 741
				}                                                                                                                  // 742
			} else {                                                                                                            // 743
				// TODO remove - ignore updates in room.usernames                                                                  // 744
				if (this.collectionName === 'rocketchat_room' && record.usernames) {                                               // 745
					delete record.usernames;                                                                                          // 746
				}                                                                                                                  // 747
                                                                                                                       //
				this.emit('beforeinsert', record);                                                                                 // 748
				this.addToAllIndexes(record);                                                                                      // 749
				this.collection.insert(record);                                                                                    // 750
				this.emit('inserted', record);                                                                                     // 751
			}                                                                                                                   // 752
		}                                                                                                                    // 753
                                                                                                                       //
		return insert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.updateDiffById = function () {                                                              //
		function updateDiffById(id, diff) {                                                                                  //
			var _ref13;                                                                                                         // 755
                                                                                                                       //
			// TODO remove - ignore updates in room.usernames                                                                   // 756
			if (this.collectionName === 'rocketchat_room' && diff.usernames) {                                                  // 757
				delete diff.usernames;                                                                                             // 758
			}                                                                                                                   // 759
                                                                                                                       //
			var record = this._findByIndex('_id', id);                                                                          // 761
                                                                                                                       //
			if (!record) {                                                                                                      // 762
				console.error('Cache.updateDiffById: No record', this.collectionName, id, diff);                                   // 763
				return;                                                                                                            // 764
			}                                                                                                                   // 765
                                                                                                                       //
			this.removeFromAllIndexes(record);                                                                                  // 766
                                                                                                                       //
			var updatedFields = (_ref13 = _).without.apply(_ref13, [Object.keys(diff)].concat((0, _toConsumableArray3.default)(this.ignoreUpdatedFields)));
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 770
				this.emit('beforeupdate', record, diff);                                                                           // 771
			}                                                                                                                   // 772
                                                                                                                       //
			for (var key in meteorBabelHelpers.sanitizeForInObject(diff)) {                                                     // 774
				if (diff.hasOwnProperty(key)) {                                                                                    // 775
					objectPath.set(record, key, diff[key]);                                                                           // 776
				}                                                                                                                  // 777
			}                                                                                                                   // 778
                                                                                                                       //
			this.collection.update(record);                                                                                     // 780
			this.addToAllIndexes(record);                                                                                       // 781
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 783
				this.emit('updated', record, diff);                                                                                // 784
			}                                                                                                                   // 785
		}                                                                                                                    // 786
                                                                                                                       //
		return updateDiffById;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.updateRecord = function () {                                                                //
		function updateRecord(record, update) {                                                                              //
			var _ref14;                                                                                                         // 788
                                                                                                                       //
			// TODO remove - ignore updates in room.usernames                                                                   // 789
			if (this.collectionName === 'rocketchat_room' && (record.usernames || record.$set && record.$set.usernames)) {      // 790
				delete record.usernames;                                                                                           // 791
                                                                                                                       //
				if (record.$set && record.$set.usernames) {                                                                        // 792
					delete record.$set.usernames;                                                                                     // 793
				}                                                                                                                  // 794
			}                                                                                                                   // 795
                                                                                                                       //
			this.removeFromAllIndexes(record);                                                                                  // 797
			var topLevelFields = Object.keys(update).map(function (field) {                                                     // 799
				return field.split('.')[0];                                                                                        // 799
			});                                                                                                                 // 799
                                                                                                                       //
			var updatedFields = (_ref14 = _).without.apply(_ref14, [topLevelFields].concat((0, _toConsumableArray3.default)(this.ignoreUpdatedFields)));
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 802
				this.emit('beforeupdate', record, record);                                                                         // 803
			}                                                                                                                   // 804
                                                                                                                       //
			if (update.$set) {                                                                                                  // 806
				_.each(update.$set, function (value, field) {                                                                      // 807
					objectPath.set(record, field, value);                                                                             // 808
				});                                                                                                                // 809
			}                                                                                                                   // 810
                                                                                                                       //
			if (update.$unset) {                                                                                                // 812
				_.each(update.$unset, function (value, field) {                                                                    // 813
					objectPath.del(record, field);                                                                                    // 814
				});                                                                                                                // 815
			}                                                                                                                   // 816
                                                                                                                       //
			if (update.$min) {                                                                                                  // 818
				_.each(update.$min, function (value, field) {                                                                      // 819
					var curValue = objectPath.get(record, field);                                                                     // 820
                                                                                                                       //
					if (curValue === undefined || value < curValue) {                                                                 // 821
						objectPath.set(record, field, value);                                                                            // 822
					}                                                                                                                 // 823
				});                                                                                                                // 824
			}                                                                                                                   // 825
                                                                                                                       //
			if (update.$max) {                                                                                                  // 827
				_.each(update.$max, function (value, field) {                                                                      // 828
					var curValue = objectPath.get(record, field);                                                                     // 829
                                                                                                                       //
					if (curValue === undefined || value > curValue) {                                                                 // 830
						objectPath.set(record, field, value);                                                                            // 831
					}                                                                                                                 // 832
				});                                                                                                                // 833
			}                                                                                                                   // 834
                                                                                                                       //
			if (update.$inc) {                                                                                                  // 836
				_.each(update.$inc, function (value, field) {                                                                      // 837
					var curValue = objectPath.get(record, field);                                                                     // 838
                                                                                                                       //
					if (curValue === undefined) {                                                                                     // 839
						curValue = value;                                                                                                // 840
					} else {                                                                                                          // 841
						curValue += value;                                                                                               // 842
					}                                                                                                                 // 843
                                                                                                                       //
					objectPath.set(record, field, curValue);                                                                          // 844
				});                                                                                                                // 845
			}                                                                                                                   // 846
                                                                                                                       //
			if (update.$mul) {                                                                                                  // 848
				_.each(update.$mul, function (value, field) {                                                                      // 849
					var curValue = objectPath.get(record, field);                                                                     // 850
                                                                                                                       //
					if (curValue === undefined) {                                                                                     // 851
						curValue = 0;                                                                                                    // 852
					} else {                                                                                                          // 853
						curValue *= value;                                                                                               // 854
					}                                                                                                                 // 855
                                                                                                                       //
					objectPath.set(record, field, curValue);                                                                          // 856
				});                                                                                                                // 857
			}                                                                                                                   // 858
                                                                                                                       //
			if (update.$rename) {                                                                                               // 860
				_.each(update.$rename, function (value, field) {                                                                   // 861
					var curValue = objectPath.get(record, field);                                                                     // 862
                                                                                                                       //
					if (curValue !== undefined) {                                                                                     // 863
						objectPath.set(record, value, curValue);                                                                         // 864
						objectPath.del(record, field);                                                                                   // 865
					}                                                                                                                 // 866
				});                                                                                                                // 867
			}                                                                                                                   // 868
                                                                                                                       //
			if (update.$pullAll) {                                                                                              // 870
				_.each(update.$pullAll, function (value, field) {                                                                  // 871
					var curValue = objectPath.get(record, field);                                                                     // 872
                                                                                                                       //
					if (Array.isArray(curValue)) {                                                                                    // 873
						curValue = _.difference(curValue, value);                                                                        // 874
						objectPath.set(record, field, curValue);                                                                         // 875
					}                                                                                                                 // 876
				});                                                                                                                // 877
			}                                                                                                                   // 878
                                                                                                                       //
			if (update.$pop) {                                                                                                  // 880
				_.each(update.$pop, function (value, field) {                                                                      // 881
					var curValue = objectPath.get(record, field);                                                                     // 882
                                                                                                                       //
					if (Array.isArray(curValue)) {                                                                                    // 883
						if (value === -1) {                                                                                              // 884
							curValue.shift();                                                                                               // 885
						} else {                                                                                                         // 886
							curValue.pop();                                                                                                 // 887
						}                                                                                                                // 888
                                                                                                                       //
						objectPath.set(record, field, curValue);                                                                         // 889
					}                                                                                                                 // 890
				});                                                                                                                // 891
			}                                                                                                                   // 892
                                                                                                                       //
			if (update.$addToSet) {                                                                                             // 894
				_.each(update.$addToSet, function (value, field) {                                                                 // 895
					var curValue = objectPath.get(record, field);                                                                     // 896
                                                                                                                       //
					if (curValue === undefined) {                                                                                     // 897
						curValue = [];                                                                                                   // 898
					}                                                                                                                 // 899
                                                                                                                       //
					if (Array.isArray(curValue)) {                                                                                    // 900
						var length = curValue.length;                                                                                    // 901
                                                                                                                       //
						if (value && value.$each && Array.isArray(value.$each)) {                                                        // 903
							for (var _iterator4 = value.$each, _isArray4 = Array.isArray(_iterator4), _i4 = 0, _iterator4 = _isArray4 ? _iterator4 : _iterator4[Symbol.iterator]();;) {
								var _ref15;                                                                                                    // 904
                                                                                                                       //
								if (_isArray4) {                                                                                               // 904
									if (_i4 >= _iterator4.length) break;                                                                          // 904
									_ref15 = _iterator4[_i4++];                                                                                   // 904
								} else {                                                                                                       // 904
									_i4 = _iterator4.next();                                                                                      // 904
									if (_i4.done) break;                                                                                          // 904
									_ref15 = _i4.value;                                                                                           // 904
								}                                                                                                              // 904
                                                                                                                       //
								var valueItem = _ref15;                                                                                        // 904
                                                                                                                       //
								if (curValue.indexOf(valueItem) === -1) {                                                                      // 905
									curValue.push(valueItem);                                                                                     // 906
								}                                                                                                              // 907
							}                                                                                                               // 908
						} else if (curValue.indexOf(value) === -1) {                                                                     // 909
							curValue.push(value);                                                                                           // 910
						}                                                                                                                // 911
                                                                                                                       //
						if (curValue.length > length) {                                                                                  // 913
							objectPath.set(record, field, curValue);                                                                        // 914
						}                                                                                                                // 915
					}                                                                                                                 // 916
				});                                                                                                                // 917
			}                                                                                                                   // 918
                                                                                                                       //
			this.collection.update(record);                                                                                     // 920
			this.addToAllIndexes(record);                                                                                       // 921
                                                                                                                       //
			if (updatedFields.length > 0) {                                                                                     // 923
				this.emit('updated', record, record);                                                                              // 924
			}                                                                                                                   // 925
		}                                                                                                                    // 926
                                                                                                                       //
		return updateRecord;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.update = function () {                                                                      //
		function update(query, _update) {                                                                                    //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 928
			var records = options.multi ? this.find(query).fetch() : this.findOne(query) || [];                                 // 929
                                                                                                                       //
			if (!Array.isArray(records)) {                                                                                      // 930
				records = [records];                                                                                               // 931
			}                                                                                                                   // 932
                                                                                                                       //
			for (var _iterator5 = records, _isArray5 = Array.isArray(_iterator5), _i5 = 0, _iterator5 = _isArray5 ? _iterator5 : _iterator5[Symbol.iterator]();;) {
				var _ref16;                                                                                                        // 934
                                                                                                                       //
				if (_isArray5) {                                                                                                   // 934
					if (_i5 >= _iterator5.length) break;                                                                              // 934
					_ref16 = _iterator5[_i5++];                                                                                       // 934
				} else {                                                                                                           // 934
					_i5 = _iterator5.next();                                                                                          // 934
					if (_i5.done) break;                                                                                              // 934
					_ref16 = _i5.value;                                                                                               // 934
				}                                                                                                                  // 934
                                                                                                                       //
				var record = _ref16;                                                                                               // 934
				this.updateRecord(record, _update);                                                                                // 935
			}                                                                                                                   // 936
		}                                                                                                                    // 937
                                                                                                                       //
		return update;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseCache.prototype.removeById = function () {                                                                  //
		function removeById(id) {                                                                                            //
			var record = this._findByIndex('_id', id);                                                                          // 940
                                                                                                                       //
			if (record) {                                                                                                       // 941
				this.emit('beforeremove', record);                                                                                 // 942
				this.collection.removeWhere({                                                                                      // 943
					_id: id                                                                                                           // 943
				});                                                                                                                // 943
				this.removeFromAllIndexes(record);                                                                                 // 944
				this.emit('removed', record);                                                                                      // 945
			}                                                                                                                   // 946
		}                                                                                                                    // 947
                                                                                                                       //
		return removeById;                                                                                                   //
	}();                                                                                                                  //
                                                                                                                       //
	return ModelsBaseCache;                                                                                               //
}(EventEmitter);                                                                                                       //
                                                                                                                       //
module.exportDefault(ModelsBaseCache);                                                                                 // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"_BaseDb.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/models/_BaseDb.js                                                                    //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
var _createClass2 = require("babel-runtime/helpers/createClass");                                                      //
                                                                                                                       //
var _createClass3 = _interopRequireDefault(_createClass2);                                                             //
                                                                                                                       //
var _possibleConstructorReturn2 = require("babel-runtime/helpers/possibleConstructorReturn");                          //
                                                                                                                       //
var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);                                 //
                                                                                                                       //
var _inherits2 = require("babel-runtime/helpers/inherits");                                                            //
                                                                                                                       //
var _inherits3 = _interopRequireDefault(_inherits2);                                                                   //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
var EventEmitter = void 0;                                                                                             // 1
module.watch(require("events"), {                                                                                      // 1
	EventEmitter: function (v) {                                                                                          // 1
		EventEmitter = v;                                                                                                    // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
/* globals MongoInternals */var baseName = 'rocketchat_';                                                              // 1
var trash = new Mongo.Collection(baseName + "_trash");                                                                 // 6
                                                                                                                       //
try {                                                                                                                  // 7
	trash._ensureIndex({                                                                                                  // 8
		collection: 1                                                                                                        // 8
	});                                                                                                                   // 8
                                                                                                                       //
	trash._ensureIndex({                                                                                                  // 9
		_deletedAt: 1                                                                                                        // 9
	}, {                                                                                                                  // 9
		expireAfterSeconds: 60 * 60 * 24 * 30                                                                                // 9
	});                                                                                                                   // 9
} catch (e) {                                                                                                          // 10
	console.log(e);                                                                                                       // 11
}                                                                                                                      // 12
                                                                                                                       //
var isOplogAvailable = MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle && !!MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle.onOplogEntry;
var isOplogEnabled = isOplogAvailable;                                                                                 // 15
RocketChat.settings.get('Force_Disable_OpLog_For_Cache', function (key, value) {                                       // 16
	isOplogEnabled = isOplogAvailable && value === false;                                                                 // 17
});                                                                                                                    // 18
                                                                                                                       //
var ModelsBaseDb = function (_EventEmitter) {                                                                          //
	(0, _inherits3.default)(ModelsBaseDb, _EventEmitter);                                                                 //
                                                                                                                       //
	function ModelsBaseDb(model, baseModel) {                                                                             // 21
		(0, _classCallCheck3.default)(this, ModelsBaseDb);                                                                   // 21
                                                                                                                       //
		var _this = (0, _possibleConstructorReturn3.default)(this, _EventEmitter.call(this));                                // 21
                                                                                                                       //
		if (Match.test(model, String)) {                                                                                     // 24
			_this.name = model;                                                                                                 // 25
			_this.collectionName = _this.baseName + _this.name;                                                                 // 26
			_this.model = new Mongo.Collection(_this.collectionName);                                                           // 27
		} else {                                                                                                             // 28
			_this.name = model._name;                                                                                           // 29
			_this.collectionName = _this.name;                                                                                  // 30
			_this.model = model;                                                                                                // 31
		}                                                                                                                    // 32
                                                                                                                       //
		_this.baseModel = baseModel;                                                                                         // 34
                                                                                                                       //
		_this.wrapModel(); // When someone start listening for changes we start oplog if available                           // 36
                                                                                                                       //
                                                                                                                       //
		_this.once('newListener', function (event /*, listener*/) {                                                          // 39
			if (event === 'change') {                                                                                           // 40
				if (isOplogEnabled) {                                                                                              // 41
					var query = {                                                                                                     // 42
						collection: _this.collectionName                                                                                 // 43
					};                                                                                                                // 42
                                                                                                                       //
					MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle.onOplogEntry(query, _this.processOplogRecord.bind(_this));
                                                                                                                       //
					MongoInternals.defaultRemoteCollectionDriver().mongo._oplogHandle._defineTooFarBehind(Number.MAX_SAFE_INTEGER);   // 47
				}                                                                                                                  // 48
			}                                                                                                                   // 49
		});                                                                                                                  // 50
                                                                                                                       //
		_this.tryEnsureIndex({                                                                                               // 52
			'_updatedAt': 1                                                                                                     // 52
		});                                                                                                                  // 52
                                                                                                                       //
		return _this;                                                                                                        // 21
	}                                                                                                                     // 53
                                                                                                                       //
	ModelsBaseDb.prototype.setUpdatedAt = function () {                                                                   //
		function setUpdatedAt() {                                                                                            //
			var record = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};                                // 59
                                                                                                                       //
			// TODO: Check if this can be deleted, Rodrigo does not rememebr WHY he added it. So he removed it to fix issue #5541
			// setUpdatedAt(record = {}, checkQuery = false, query) {                                                           // 62
			// if (checkQuery === true) {                                                                                       // 63
			// 	if (!query || Object.keys(query).length === 0) {                                                                // 64
			// 		throw new Meteor.Error('Models._Base: Empty query');                                                           // 65
			// 	}                                                                                                               // 66
			// }                                                                                                                // 67
			if (/(^|,)\$/.test(Object.keys(record).join(','))) {                                                                // 69
				record.$set = record.$set || {};                                                                                   // 70
				record.$set._updatedAt = new Date();                                                                               // 71
			} else {                                                                                                            // 72
				record._updatedAt = new Date();                                                                                    // 73
			}                                                                                                                   // 74
                                                                                                                       //
			return record;                                                                                                      // 76
		}                                                                                                                    // 77
                                                                                                                       //
		return setUpdatedAt;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.wrapModel = function () {                                                                      //
		function wrapModel() {                                                                                               //
			this.originals = {                                                                                                  // 80
				insert: this.model.insert.bind(this.model),                                                                        // 81
				update: this.model.update.bind(this.model),                                                                        // 82
				remove: this.model.remove.bind(this.model)                                                                         // 83
			};                                                                                                                  // 80
			var self = this;                                                                                                    // 85
                                                                                                                       //
			this.model.insert = function () {                                                                                   // 87
				return self.insert.apply(self, arguments);                                                                         // 88
			};                                                                                                                  // 89
                                                                                                                       //
			this.model.update = function () {                                                                                   // 91
				return self.update.apply(self, arguments);                                                                         // 92
			};                                                                                                                  // 93
                                                                                                                       //
			this.model.remove = function () {                                                                                   // 95
				return self.remove.apply(self, arguments);                                                                         // 96
			};                                                                                                                  // 97
		}                                                                                                                    // 98
                                                                                                                       //
		return wrapModel;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.find = function () {                                                                           //
		function find() {                                                                                                    //
			var _model;                                                                                                         // 100
                                                                                                                       //
			return (_model = this.model).find.apply(_model, arguments);                                                         // 101
		}                                                                                                                    // 102
                                                                                                                       //
		return find;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.findOne = function () {                                                                        //
		function findOne() {                                                                                                 //
			var _model2;                                                                                                        // 104
                                                                                                                       //
			return (_model2 = this.model).findOne.apply(_model2, arguments);                                                    // 105
		}                                                                                                                    // 106
                                                                                                                       //
		return findOne;                                                                                                      //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.findOneById = function () {                                                                    //
		function findOneById(_id, options) {                                                                                 //
			return this.model.findOne({                                                                                         // 109
				_id: _id                                                                                                           // 109
			}, options);                                                                                                        // 109
		}                                                                                                                    // 110
                                                                                                                       //
		return findOneById;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.findOneByIds = function () {                                                                   //
		function findOneByIds(ids, options) {                                                                                //
			return this.model.findOne({                                                                                         // 113
				_id: {                                                                                                             // 113
					$in: ids                                                                                                          // 113
				}                                                                                                                  // 113
			}, options);                                                                                                        // 113
		}                                                                                                                    // 114
                                                                                                                       //
		return findOneByIds;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.defineSyncStrategy = function () {                                                             //
		function defineSyncStrategy(query, modifier, options) {                                                              //
			if (this.baseModel.useCache === false) {                                                                            // 117
				return 'db';                                                                                                       // 118
			}                                                                                                                   // 119
                                                                                                                       //
			if (options.upsert === true) {                                                                                      // 121
				return 'db';                                                                                                       // 122
			} // const dbModifiers = [                                                                                          // 123
			// 	'$currentDate',                                                                                                 // 126
			// 	'$bit',                                                                                                         // 127
			// 	'$pull',                                                                                                        // 128
			// 	'$pushAll',                                                                                                     // 129
			// 	'$push',                                                                                                        // 130
			// 	'$setOnInsert'                                                                                                  // 131
			// ];                                                                                                               // 132
                                                                                                                       //
                                                                                                                       //
			var cacheAllowedModifiers = ['$set', '$unset', '$min', '$max', '$inc', '$mul', '$rename', '$pullAll', '$pop', '$addToSet'];
			var notAllowedModifiers = Object.keys(modifier).filter(function (i) {                                               // 147
				return i.startsWith('$') && cacheAllowedModifiers.includes(i) === false;                                           // 147
			});                                                                                                                 // 147
                                                                                                                       //
			if (notAllowedModifiers.length > 0) {                                                                               // 149
				return 'db';                                                                                                       // 150
			}                                                                                                                   // 151
                                                                                                                       //
			var placeholderFields = Object.keys(query).filter(function (item) {                                                 // 153
				return item.indexOf('$') > -1;                                                                                     // 153
			});                                                                                                                 // 153
                                                                                                                       //
			if (placeholderFields.length > 0) {                                                                                 // 154
				return 'db';                                                                                                       // 155
			}                                                                                                                   // 156
                                                                                                                       //
			return 'cache';                                                                                                     // 158
		}                                                                                                                    // 159
                                                                                                                       //
		return defineSyncStrategy;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.updateHasPositionalOperator = function () {                                                    //
		function updateHasPositionalOperator(update) {                                                                       //
			for (var key in meteorBabelHelpers.sanitizeForInObject(update)) {                                                   // 162
				if (key.includes('.$')) {                                                                                          // 163
					return true;                                                                                                      // 164
				}                                                                                                                  // 165
                                                                                                                       //
				var value = update[key];                                                                                           // 167
                                                                                                                       //
				if (Match.test(value, Object)) {                                                                                   // 169
					if (this.updateHasPositionalOperator(value) === true) {                                                           // 170
						return true;                                                                                                     // 171
					}                                                                                                                 // 172
				}                                                                                                                  // 173
			}                                                                                                                   // 174
                                                                                                                       //
			return false;                                                                                                       // 176
		}                                                                                                                    // 177
                                                                                                                       //
		return updateHasPositionalOperator;                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.processOplogRecord = function () {                                                             //
		function processOplogRecord(action) {                                                                                //
			if (isOplogEnabled === false) {                                                                                     // 180
				return;                                                                                                            // 181
			}                                                                                                                   // 182
                                                                                                                       //
			if (action.op.op === 'i') {                                                                                         // 184
				this.emit('change', {                                                                                              // 185
					action: 'insert',                                                                                                 // 186
					id: action.op.o._id,                                                                                              // 187
					data: action.op.o,                                                                                                // 188
					oplog: true                                                                                                       // 189
				});                                                                                                                // 185
				return;                                                                                                            // 191
			}                                                                                                                   // 192
                                                                                                                       //
			if (action.op.op === 'u') {                                                                                         // 194
				if (!action.op.o.$set && !action.op.o.$unset) {                                                                    // 195
					this.emit('change', {                                                                                             // 196
						action: 'update:record',                                                                                         // 197
						id: action.id,                                                                                                   // 198
						data: action.op.o,                                                                                               // 199
						oplog: true                                                                                                      // 200
					});                                                                                                               // 196
					return;                                                                                                           // 202
				}                                                                                                                  // 203
                                                                                                                       //
				var diff = {};                                                                                                     // 205
                                                                                                                       //
				if (action.op.o.$set) {                                                                                            // 206
					for (var key in meteorBabelHelpers.sanitizeForInObject(action.op.o.$set)) {                                       // 207
						if (action.op.o.$set.hasOwnProperty(key)) {                                                                      // 208
							diff[key] = action.op.o.$set[key];                                                                              // 209
						}                                                                                                                // 210
					}                                                                                                                 // 211
				}                                                                                                                  // 212
                                                                                                                       //
				if (action.op.o.$unset) {                                                                                          // 214
					for (var _key in meteorBabelHelpers.sanitizeForInObject(action.op.o.$unset)) {                                    // 215
						if (action.op.o.$unset.hasOwnProperty(_key)) {                                                                   // 216
							diff[_key] = undefined;                                                                                         // 217
						}                                                                                                                // 218
					}                                                                                                                 // 219
				}                                                                                                                  // 220
                                                                                                                       //
				this.emit('change', {                                                                                              // 222
					action: 'update:diff',                                                                                            // 223
					id: action.id,                                                                                                    // 224
					data: diff,                                                                                                       // 225
					oplog: true                                                                                                       // 226
				});                                                                                                                // 222
				return;                                                                                                            // 228
			}                                                                                                                   // 229
                                                                                                                       //
			if (action.op.op === 'd') {                                                                                         // 231
				this.emit('change', {                                                                                              // 232
					action: 'remove',                                                                                                 // 233
					id: action.id,                                                                                                    // 234
					oplog: true                                                                                                       // 235
				});                                                                                                                // 232
				return;                                                                                                            // 237
			}                                                                                                                   // 238
		}                                                                                                                    // 239
                                                                                                                       //
		return processOplogRecord;                                                                                           //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.insert = function () {                                                                         //
		function insert(record) {                                                                                            //
			var _originals;                                                                                                     // 241
                                                                                                                       //
			this.setUpdatedAt(record);                                                                                          // 242
                                                                                                                       //
			var result = (_originals = this.originals).insert.apply(_originals, arguments);                                     // 244
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0) {                                                          // 245
				this.emit('change', {                                                                                              // 246
					action: 'insert',                                                                                                 // 247
					id: result,                                                                                                       // 248
					data: _.extend({}, record),                                                                                       // 249
					oplog: false                                                                                                      // 250
				});                                                                                                                // 246
			}                                                                                                                   // 252
                                                                                                                       //
			record._id = result;                                                                                                // 254
			return result;                                                                                                      // 256
		}                                                                                                                    // 257
                                                                                                                       //
		return insert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.update = function () {                                                                         //
		function update(query, _update) {                                                                                    //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 259
			this.setUpdatedAt(_update, true, query);                                                                            // 260
			var strategy = this.defineSyncStrategy(query, _update, options);                                                    // 262
			var ids = [];                                                                                                       // 263
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0 && strategy === 'db') {                                     // 264
				var findOptions = {                                                                                                // 265
					fields: {                                                                                                         // 265
						_id: 1                                                                                                           // 265
					}                                                                                                                 // 265
				};                                                                                                                 // 265
				var records = options.multi ? this.find(query, findOptions).fetch() : this.findOne(query, findOptions) || [];      // 266
                                                                                                                       //
				if (!Array.isArray(records)) {                                                                                     // 267
					records = [records];                                                                                              // 268
				}                                                                                                                  // 269
                                                                                                                       //
				ids = records.map(function (item) {                                                                                // 271
					return item._id;                                                                                                  // 271
				});                                                                                                                // 271
                                                                                                                       //
				if (options.upsert !== true && this.updateHasPositionalOperator(_update) === false) {                              // 272
					query = {                                                                                                         // 273
						_id: {                                                                                                           // 274
							$in: ids                                                                                                        // 275
						}                                                                                                                // 274
					};                                                                                                                // 273
				}                                                                                                                  // 278
			}                                                                                                                   // 279
                                                                                                                       //
			var result = this.originals.update(query, _update, options);                                                        // 281
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0) {                                                          // 283
				if (strategy === 'db') {                                                                                           // 284
					if (options.upsert === true) {                                                                                    // 285
						if (result.insertedId) {                                                                                         // 286
							this.emit('change', {                                                                                           // 287
								action: 'insert',                                                                                              // 288
								id: result.insertedId,                                                                                         // 289
								data: this.findOne({                                                                                           // 290
									_id: result.insertedId                                                                                        // 290
								}),                                                                                                            // 290
								oplog: false                                                                                                   // 291
							});                                                                                                             // 287
							return;                                                                                                         // 293
						}                                                                                                                // 294
                                                                                                                       //
						query = {                                                                                                        // 296
							_id: {                                                                                                          // 297
								$in: ids                                                                                                       // 298
							}                                                                                                               // 297
						};                                                                                                               // 296
					}                                                                                                                 // 301
                                                                                                                       //
					var _records = options.multi ? this.find(query).fetch() : this.findOne(query) || [];                              // 303
                                                                                                                       //
					if (!Array.isArray(_records)) {                                                                                   // 304
						_records = [_records];                                                                                           // 305
					}                                                                                                                 // 306
                                                                                                                       //
					for (var _iterator = _records, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
						var _ref;                                                                                                        // 307
                                                                                                                       //
						if (_isArray) {                                                                                                  // 307
							if (_i >= _iterator.length) break;                                                                              // 307
							_ref = _iterator[_i++];                                                                                         // 307
						} else {                                                                                                         // 307
							_i = _iterator.next();                                                                                          // 307
							if (_i.done) break;                                                                                             // 307
							_ref = _i.value;                                                                                                // 307
						}                                                                                                                // 307
                                                                                                                       //
						var record = _ref;                                                                                               // 307
						this.emit('change', {                                                                                            // 308
							action: 'update:record',                                                                                        // 309
							id: record._id,                                                                                                 // 310
							data: record,                                                                                                   // 311
							oplog: false                                                                                                    // 312
						});                                                                                                              // 308
					}                                                                                                                 // 314
				} else {                                                                                                           // 315
					this.emit('change', {                                                                                             // 316
						action: 'update:query',                                                                                          // 317
						id: undefined,                                                                                                   // 318
						data: {                                                                                                          // 319
							query: query,                                                                                                   // 320
							update: _update,                                                                                                // 321
							options: options                                                                                                // 322
						},                                                                                                               // 319
						oplog: false                                                                                                     // 324
					});                                                                                                               // 316
				}                                                                                                                  // 326
			}                                                                                                                   // 327
                                                                                                                       //
			return result;                                                                                                      // 328
		}                                                                                                                    // 329
                                                                                                                       //
		return update;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.upsert = function () {                                                                         //
		function upsert(query, update) {                                                                                     //
			var options = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};                               // 331
			options.upsert = true;                                                                                              // 332
			options._returnObject = true;                                                                                       // 333
			return this.update(query, update, options);                                                                         // 334
		}                                                                                                                    // 335
                                                                                                                       //
		return upsert;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.remove = function () {                                                                         //
		function remove(query) {                                                                                             //
			var records = this.model.find(query).fetch();                                                                       // 338
			var ids = [];                                                                                                       // 340
                                                                                                                       //
			for (var _iterator2 = records, _isArray2 = Array.isArray(_iterator2), _i2 = 0, _iterator2 = _isArray2 ? _iterator2 : _iterator2[Symbol.iterator]();;) {
				var _ref2;                                                                                                         // 341
                                                                                                                       //
				if (_isArray2) {                                                                                                   // 341
					if (_i2 >= _iterator2.length) break;                                                                              // 341
					_ref2 = _iterator2[_i2++];                                                                                        // 341
				} else {                                                                                                           // 341
					_i2 = _iterator2.next();                                                                                          // 341
					if (_i2.done) break;                                                                                              // 341
					_ref2 = _i2.value;                                                                                                // 341
				}                                                                                                                  // 341
                                                                                                                       //
				var record = _ref2;                                                                                                // 341
				ids.push(record._id);                                                                                              // 342
				record._deletedAt = new Date();                                                                                    // 344
				record.__collection__ = this.name;                                                                                 // 345
				trash.upsert({                                                                                                     // 347
					_id: record._id                                                                                                   // 347
				}, _.omit(record, '_id'));                                                                                         // 347
			}                                                                                                                   // 348
                                                                                                                       //
			query = {                                                                                                           // 350
				_id: {                                                                                                             // 350
					$in: ids                                                                                                          // 350
				}                                                                                                                  // 350
			};                                                                                                                  // 350
			var result = this.originals.remove(query);                                                                          // 352
                                                                                                                       //
			if (!isOplogEnabled && this.listenerCount('change') > 0) {                                                          // 354
				for (var _iterator3 = records, _isArray3 = Array.isArray(_iterator3), _i3 = 0, _iterator3 = _isArray3 ? _iterator3 : _iterator3[Symbol.iterator]();;) {
					var _ref3;                                                                                                        // 355
                                                                                                                       //
					if (_isArray3) {                                                                                                  // 355
						if (_i3 >= _iterator3.length) break;                                                                             // 355
						_ref3 = _iterator3[_i3++];                                                                                       // 355
					} else {                                                                                                          // 355
						_i3 = _iterator3.next();                                                                                         // 355
						if (_i3.done) break;                                                                                             // 355
						_ref3 = _i3.value;                                                                                               // 355
					}                                                                                                                 // 355
                                                                                                                       //
					var _record = _ref3;                                                                                              // 355
					this.emit('change', {                                                                                             // 356
						action: 'remove',                                                                                                // 357
						id: _record._id,                                                                                                 // 358
						data: _.extend({}, _record),                                                                                     // 359
						oplog: false                                                                                                     // 360
					});                                                                                                               // 356
				}                                                                                                                  // 362
			}                                                                                                                   // 363
                                                                                                                       //
			return result;                                                                                                      // 365
		}                                                                                                                    // 366
                                                                                                                       //
		return remove;                                                                                                       //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.insertOrUpsert = function () {                                                                 //
		function insertOrUpsert() {                                                                                          //
			for (var _len = arguments.length, args = Array(_len), _key2 = 0; _key2 < _len; _key2++) {                           // 368
				args[_key2] = arguments[_key2];                                                                                    // 368
			}                                                                                                                   // 368
                                                                                                                       //
			if (args[0] && args[0]._id) {                                                                                       // 369
				var _id = args[0]._id;                                                                                             // 370
				delete args[0]._id;                                                                                                // 371
				args.unshift({                                                                                                     // 372
					_id: _id                                                                                                          // 373
				});                                                                                                                // 372
				this.upsert.apply(this, args);                                                                                     // 376
				return _id;                                                                                                        // 377
			} else {                                                                                                            // 378
				return this.insert.apply(this, args);                                                                              // 379
			}                                                                                                                   // 380
		}                                                                                                                    // 381
                                                                                                                       //
		return insertOrUpsert;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.allow = function () {                                                                          //
		function allow() {                                                                                                   //
			var _model3;                                                                                                        // 383
                                                                                                                       //
			return (_model3 = this.model).allow.apply(_model3, arguments);                                                      // 384
		}                                                                                                                    // 385
                                                                                                                       //
		return allow;                                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.deny = function () {                                                                           //
		function deny() {                                                                                                    //
			var _model4;                                                                                                        // 387
                                                                                                                       //
			return (_model4 = this.model).deny.apply(_model4, arguments);                                                       // 388
		}                                                                                                                    // 389
                                                                                                                       //
		return deny;                                                                                                         //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.ensureIndex = function () {                                                                    //
		function ensureIndex() {                                                                                             //
			var _model5;                                                                                                        // 391
                                                                                                                       //
			return (_model5 = this.model)._ensureIndex.apply(_model5, arguments);                                               // 392
		}                                                                                                                    // 393
                                                                                                                       //
		return ensureIndex;                                                                                                  //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.dropIndex = function () {                                                                      //
		function dropIndex() {                                                                                               //
			var _model6;                                                                                                        // 395
                                                                                                                       //
			return (_model6 = this.model)._dropIndex.apply(_model6, arguments);                                                 // 396
		}                                                                                                                    // 397
                                                                                                                       //
		return dropIndex;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.tryEnsureIndex = function () {                                                                 //
		function tryEnsureIndex() {                                                                                          //
			try {                                                                                                               // 400
				return this.ensureIndex.apply(this, arguments);                                                                    // 401
			} catch (e) {                                                                                                       // 402
				var _console;                                                                                                      // 402
                                                                                                                       //
				(_console = console).error.apply(_console, ['Error creating index:', this.name, '->'].concat(Array.prototype.slice.call(arguments), [e]));
			}                                                                                                                   // 404
		}                                                                                                                    // 405
                                                                                                                       //
		return tryEnsureIndex;                                                                                               //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.tryDropIndex = function () {                                                                   //
		function tryDropIndex() {                                                                                            //
			try {                                                                                                               // 408
				return this.dropIndex.apply(this, arguments);                                                                      // 409
			} catch (e) {                                                                                                       // 410
				var _console2;                                                                                                     // 410
                                                                                                                       //
				(_console2 = console).error.apply(_console2, ['Error dropping index:', this.name, '->'].concat(Array.prototype.slice.call(arguments), [e]));
			}                                                                                                                   // 412
		}                                                                                                                    // 413
                                                                                                                       //
		return tryDropIndex;                                                                                                 //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.trashFind = function () {                                                                      //
		function trashFind(query, options) {                                                                                 //
			query.__collection__ = this.name;                                                                                   // 416
			return trash.find(query, options);                                                                                  // 418
		}                                                                                                                    // 419
                                                                                                                       //
		return trashFind;                                                                                                    //
	}();                                                                                                                  //
                                                                                                                       //
	ModelsBaseDb.prototype.trashFindDeletedAfter = function () {                                                          //
		function trashFindDeletedAfter(deletedAt) {                                                                          //
			var query = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                                 // 421
			var options = arguments[2];                                                                                         // 421
			query.__collection__ = this.name;                                                                                   // 422
			query._deletedAt = {                                                                                                // 423
				$gt: deletedAt                                                                                                     // 424
			};                                                                                                                  // 423
			return trash.find(query, options);                                                                                  // 427
		}                                                                                                                    // 428
                                                                                                                       //
		return trashFindDeletedAfter;                                                                                        //
	}();                                                                                                                  //
                                                                                                                       //
	(0, _createClass3.default)(ModelsBaseDb, [{                                                                           //
		key: "baseName",                                                                                                     //
		get: function () {                                                                                                   //
			return baseName;                                                                                                    // 56
		}                                                                                                                    // 57
	}]);                                                                                                                  //
	return ModelsBaseDb;                                                                                                  //
}(EventEmitter);                                                                                                       //
                                                                                                                       //
module.exportDefault(ModelsBaseDb);                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"oauth":{"oauth.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/oauth/oauth.js                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var AccessTokenServices = {};                                                                                          // 1
                                                                                                                       //
RocketChat.registerAccessTokenService = function (serviceName, handleAccessTokenRequest) {                             // 3
	AccessTokenServices[serviceName] = {                                                                                  // 4
		serviceName: serviceName,                                                                                            // 5
		handleAccessTokenRequest: handleAccessTokenRequest                                                                   // 6
	};                                                                                                                    // 4
}; // Listen to calls to `login` with an oauth option set. This is where                                               // 8
// users actually get logged in to meteor via oauth.                                                                   // 11
                                                                                                                       //
                                                                                                                       //
Accounts.registerLoginHandler(function (options) {                                                                     // 12
	if (!options.accessToken) {                                                                                           // 13
		return undefined; // don't handle                                                                                    // 14
	}                                                                                                                     // 15
                                                                                                                       //
	check(options, Match.ObjectIncluding({                                                                                // 17
		serviceName: String                                                                                                  // 18
	}));                                                                                                                  // 17
	var service = AccessTokenServices[options.serviceName]; // Skip everything if there's no service set by the oauth middleware
                                                                                                                       //
	if (!service) {                                                                                                       // 24
		throw new Error("Unexpected AccessToken service " + options.serviceName);                                            // 25
	} // Make sure we're configured                                                                                       // 26
                                                                                                                       //
                                                                                                                       //
	if (!ServiceConfiguration.configurations.findOne({                                                                    // 29
		service: service.serviceName                                                                                         // 29
	})) {                                                                                                                 // 29
		throw new ServiceConfiguration.ConfigError();                                                                        // 30
	}                                                                                                                     // 31
                                                                                                                       //
	if (!_.contains(Accounts.oauth.serviceNames(), service.serviceName)) {                                                // 33
		// serviceName was not found in the registered services list.                                                        // 34
		// This could happen because the service never registered itself or                                                  // 35
		// unregisterService was called on it.                                                                               // 36
		return {                                                                                                             // 37
			type: 'oauth',                                                                                                      // 38
			error: new Meteor.Error(Accounts.LoginCancelledError.numericError, "No registered oauth service found for: " + service.serviceName)
		};                                                                                                                   // 37
	}                                                                                                                     // 44
                                                                                                                       //
	var oauthResult = service.handleAccessTokenRequest(options);                                                          // 46
	return Accounts.updateOrCreateUserFromExternalService(service.serviceName, oauthResult.serviceData, oauthResult.options);
});                                                                                                                    // 49
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"google.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/oauth/google.js                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals Google */function getIdentity(accessToken) {                                                                // 1
	try {                                                                                                                 // 4
		return HTTP.get('https://www.googleapis.com/oauth2/v1/userinfo', {                                                   // 5
			params: {                                                                                                           // 7
				access_token: accessToken                                                                                          // 7
			}                                                                                                                   // 7
		}).data;                                                                                                             // 7
	} catch (err) {                                                                                                       // 8
		throw _.extend(new Error("Failed to fetch identity from Google. " + err.message), {                                  // 9
			response: err.response                                                                                              // 9
		});                                                                                                                  // 9
	}                                                                                                                     // 10
}                                                                                                                      // 11
                                                                                                                       //
function getScopes(accessToken) {                                                                                      // 13
	try {                                                                                                                 // 14
		return HTTP.get('https://www.googleapis.com/oauth2/v1/tokeninfo', {                                                  // 15
			params: {                                                                                                           // 17
				access_token: accessToken                                                                                          // 17
			}                                                                                                                   // 17
		}).data.scope.split(' ');                                                                                            // 17
	} catch (err) {                                                                                                       // 18
		throw _.extend(new Error("Failed to fetch tokeninfo from Google. " + err.message), {                                 // 19
			response: err.response                                                                                              // 19
		});                                                                                                                  // 19
	}                                                                                                                     // 20
}                                                                                                                      // 21
                                                                                                                       //
RocketChat.registerAccessTokenService('google', function (options) {                                                   // 24
	check(options, Match.ObjectIncluding({                                                                                // 25
		accessToken: String,                                                                                                 // 26
		idToken: String,                                                                                                     // 27
		expiresIn: Match.Integer,                                                                                            // 28
		scope: Match.Maybe(String),                                                                                          // 29
		identity: Match.Maybe(Object)                                                                                        // 30
	}));                                                                                                                  // 25
	var identity = options.identity || getIdentity(options.accessToken);                                                  // 33
	var serviceData = {                                                                                                   // 35
		accessToken: options.accessToken,                                                                                    // 36
		idToken: options.idToken,                                                                                            // 37
		expiresAt: +new Date() + 1000 * parseInt(options.expiresIn, 10),                                                     // 38
		scope: options.scopes || getScopes(options.accessToken)                                                              // 39
	};                                                                                                                    // 35
                                                                                                                       //
	var fields = _.pick(identity, Google.whitelistedFields);                                                              // 42
                                                                                                                       //
	_.extend(serviceData, fields); // only set the token in serviceData if it's there. this ensures                       // 43
	// that we don't lose old ones (since we only get this on the first                                                   // 46
	// log in attempt)                                                                                                    // 47
                                                                                                                       //
                                                                                                                       //
	if (options.refreshToken) {                                                                                           // 48
		serviceData.refreshToken = options.refreshToken;                                                                     // 49
	}                                                                                                                     // 50
                                                                                                                       //
	return {                                                                                                              // 52
		serviceData: serviceData,                                                                                            // 53
		options: {                                                                                                           // 54
			profile: {                                                                                                          // 55
				name: identity.name                                                                                                // 56
			}                                                                                                                   // 55
		}                                                                                                                    // 54
	};                                                                                                                    // 52
});                                                                                                                    // 60
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"proxy.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/oauth/proxy.js                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals OAuth */OAuth._redirectUri = _.wrap(OAuth._redirectUri, function (func, serviceName) {                      // 1
	var proxy = RocketChat.settings.get('Accounts_OAuth_Proxy_services').replace(/\s/g, '').split(',');                   // 4
                                                                                                                       //
	if (proxy.includes(serviceName)) {                                                                                    // 5
		return RocketChat.settings.get('Accounts_OAuth_Proxy_host') + "/oauth_redirect";                                     // 6
	} else {                                                                                                              // 7
		for (var _len = arguments.length, args = Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {            // 7
			args[_key - 2] = arguments[_key];                                                                                   // 3
		}                                                                                                                    // 7
                                                                                                                       //
		return func.apply(undefined, [serviceName].concat(args));                                                            // 8
	}                                                                                                                     // 9
});                                                                                                                    // 11
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"startup":{"statsTracker.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/statsTracker.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _classCallCheck2 = require("babel-runtime/helpers/classCallCheck");                                                //
                                                                                                                       //
var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);                                                       //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
RocketChat.statsTracker = new (function () {                                                                           // 1
	function StatsTracker() {                                                                                             // 2
		(0, _classCallCheck3.default)(this, StatsTracker);                                                                   // 2
		this.StatsD = Npm.require('node-dogstatsd').StatsD;                                                                  // 3
		this.dogstatsd = new this.StatsD();                                                                                  // 4
	}                                                                                                                     // 5
                                                                                                                       //
	StatsTracker.prototype.track = function () {                                                                          // 1
		function track(type, stats) {                                                                                        // 1
			var _dogstatsd;                                                                                                     // 7
                                                                                                                       //
			for (var _len = arguments.length, args = Array(_len > 2 ? _len - 2 : 0), _key = 2; _key < _len; _key++) {           // 7
				args[_key - 2] = arguments[_key];                                                                                  // 7
			}                                                                                                                   // 7
                                                                                                                       //
			(_dogstatsd = this.dogstatsd)[type].apply(_dogstatsd, ["RocketChat." + stats].concat(args));                        // 8
		}                                                                                                                    // 9
                                                                                                                       //
		return track;                                                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.now = function () {                                                                            // 1
		function now() {                                                                                                     // 1
			var hrtime = process.hrtime();                                                                                      // 12
			return hrtime[0] * 1000000 + hrtime[1] / 1000;                                                                      // 13
		}                                                                                                                    // 14
                                                                                                                       //
		return now;                                                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.timing = function () {                                                                         // 1
		function timing(stats, time, tags) {                                                                                 // 1
			this.track('timing', stats, time, tags);                                                                            // 17
		}                                                                                                                    // 18
                                                                                                                       //
		return timing;                                                                                                       // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.increment = function () {                                                                      // 1
		function increment(stats, time, tags) {                                                                              // 1
			this.track('increment', stats, time, tags);                                                                         // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return increment;                                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.decrement = function () {                                                                      // 1
		function decrement(stats, time, tags) {                                                                              // 1
			this.track('decrement', stats, time, tags);                                                                         // 25
		}                                                                                                                    // 26
                                                                                                                       //
		return decrement;                                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.histogram = function () {                                                                      // 1
		function histogram(stats, time, tags) {                                                                              // 1
			this.track('histogram', stats, time, tags);                                                                         // 29
		}                                                                                                                    // 30
                                                                                                                       //
		return histogram;                                                                                                    // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.gauge = function () {                                                                          // 1
		function gauge(stats, time, tags) {                                                                                  // 1
			this.track('gauge', stats, time, tags);                                                                             // 33
		}                                                                                                                    // 34
                                                                                                                       //
		return gauge;                                                                                                        // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.unique = function () {                                                                         // 1
		function unique(stats, time, tags) {                                                                                 // 1
			this.track('unique', stats, time, tags);                                                                            // 37
		}                                                                                                                    // 38
                                                                                                                       //
		return unique;                                                                                                       // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	StatsTracker.prototype.set = function () {                                                                            // 1
		function set(stats, time, tags) {                                                                                    // 1
			this.track('set', stats, time, tags);                                                                               // 41
		}                                                                                                                    // 42
                                                                                                                       //
		return set;                                                                                                          // 1
	}();                                                                                                                  // 1
                                                                                                                       //
	return StatsTracker;                                                                                                  // 1
}())();                                                                                                                // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"cache":{"CacheLoad.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/cache/CacheLoad.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.models.Rooms.cache.hasMany('Subscriptions', {                                                               // 1
	field: 'usernames',                                                                                                   // 2
	link: {                                                                                                               // 3
		local: '_id',                                                                                                        // 4
		remote: 'rid',                                                                                                       // 5
		transform: function (room, subscription) {                                                                           // 6
			return subscription.u.username;                                                                                     // 7
		},                                                                                                                   // 8
		remove: function (arr, subscription) {                                                                               // 9
			if (arr.indexOf(subscription.u.username) > -1) {                                                                    // 10
				arr.splice(arr.indexOf(subscription.u.username), 1);                                                               // 11
			}                                                                                                                   // 12
		}                                                                                                                    // 13
	}                                                                                                                     // 3
});                                                                                                                    // 1
RocketChat.models.Subscriptions.cache.hasOne('Rooms', {                                                                // 18
	field: '_room',                                                                                                       // 19
	link: {                                                                                                               // 20
		local: 'rid',                                                                                                        // 21
		remote: '_id'                                                                                                        // 22
	}                                                                                                                     // 20
});                                                                                                                    // 18
RocketChat.models.Subscriptions.cache.hasOne('Users', {                                                                // 27
	field: '_user',                                                                                                       // 28
	link: {                                                                                                               // 29
		local: 'u._id',                                                                                                      // 30
		remote: '_id'                                                                                                        // 31
	}                                                                                                                     // 29
});                                                                                                                    // 27
RocketChat.models.Subscriptions.cache.hasOne('Users', {                                                                // 35
	field: 'fname',                                                                                                       // 36
	link: {                                                                                                               // 37
		local: 'name',                                                                                                       // 38
		remote: 'username',                                                                                                  // 39
		where: function (subscription /*, user*/) {                                                                          // 40
			return subscription.t === 'd';                                                                                      // 41
		},                                                                                                                   // 42
		transform: function (subscription, user) {                                                                           // 43
			if (user == null || subscription == null) {                                                                         // 44
				return undefined;                                                                                                  // 45
			} // Prevent client cache for old subscriptions with new names                                                      // 46
			// Cuz when a user change his name, the subscription's _updateAt                                                    // 48
			// will not change                                                                                                  // 49
                                                                                                                       //
                                                                                                                       //
			if (subscription._updatedAt < user._updatedAt) {                                                                    // 50
				subscription._updatedAt = user._updatedAt;                                                                         // 51
			}                                                                                                                   // 52
                                                                                                                       //
			return user.name;                                                                                                   // 53
		}                                                                                                                    // 54
	}                                                                                                                     // 37
});                                                                                                                    // 35
RocketChat.models.Users.cache.load();                                                                                  // 58
RocketChat.models.Rooms.cache.load();                                                                                  // 59
RocketChat.models.Subscriptions.cache.load();                                                                          // 60
RocketChat.models.Settings.cache.load();                                                                               // 61
RocketChat.models.Users.cache.addDynamicView('highlights').applyFind({                                                 // 64
	'settings.preferences.highlights': {                                                                                  // 65
		$size: {                                                                                                             // 65
			$gt: 0                                                                                                              // 65
		}                                                                                                                    // 65
	}                                                                                                                     // 65
});                                                                                                                    // 64
RocketChat.models.Subscriptions.cache.addDynamicView('notifications').applyFind({                                      // 68
	$or: [{                                                                                                               // 69
		desktopNotifications: {                                                                                              // 70
			$in: ['all', 'nothing']                                                                                             // 70
		}                                                                                                                    // 70
	}, {                                                                                                                  // 70
		mobilePushNotifications: {                                                                                           // 71
			$in: ['all', 'nothing']                                                                                             // 71
		}                                                                                                                    // 71
	}]                                                                                                                    // 71
});                                                                                                                    // 68
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"settingsOnLoadCdnPrefix.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/settingsOnLoadCdnPrefix.js                                                   //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals WebAppInternals*/function testWebAppInternals(fn) {                                                         // 1
	typeof WebAppInternals !== 'undefined' && fn(WebAppInternals);                                                        // 3
}                                                                                                                      // 4
                                                                                                                       //
RocketChat.settings.onload('CDN_PREFIX', function (key, value) {                                                       // 5
	if (_.isString(value) && value.trim()) {                                                                              // 6
		return testWebAppInternals(function (WebAppInternals) {                                                              // 7
			return WebAppInternals.setBundledJsCssPrefix(value);                                                                // 7
		});                                                                                                                  // 7
	}                                                                                                                     // 8
});                                                                                                                    // 9
Meteor.startup(function () {                                                                                           // 11
	var value = RocketChat.settings.get('CDN_PREFIX');                                                                    // 12
                                                                                                                       //
	if (_.isString(value) && value.trim()) {                                                                              // 13
		return testWebAppInternals(function (WebAppInternals) {                                                              // 14
			return WebAppInternals.setBundledJsCssPrefix(value);                                                                // 14
		});                                                                                                                  // 14
	}                                                                                                                     // 15
});                                                                                                                    // 16
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settingsOnLoadDirectReply.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/settingsOnLoadDirectReply.js                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var IMAPIntercepter = void 0;                                                                                          // 1
module.watch(require("../lib/interceptDirectReplyEmails.js"), {                                                        // 1
	IMAPIntercepter: function (v) {                                                                                       // 1
		IMAPIntercepter = v;                                                                                                 // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
var POP3Helper = void 0;                                                                                               // 1
module.watch(require("../lib/interceptDirectReplyEmails.js"), {                                                        // 1
	POP3Helper: function (v) {                                                                                            // 1
		POP3Helper = v;                                                                                                      // 1
	}                                                                                                                     // 1
}, 1);                                                                                                                 // 1
                                                                                                                       //
var startEmailIntercepter = _.debounce(Meteor.bindEnvironment(function () {                                            // 4
	console.log('Starting Email Intercepter...');                                                                         // 5
                                                                                                                       //
	if (RocketChat.settings.get('Direct_Reply_Enable') && RocketChat.settings.get('Direct_Reply_Protocol') && RocketChat.settings.get('Direct_Reply_Host') && RocketChat.settings.get('Direct_Reply_Port') && RocketChat.settings.get('Direct_Reply_Username') && RocketChat.settings.get('Direct_Reply_Password')) {
		if (RocketChat.settings.get('Direct_Reply_Protocol') === 'IMAP') {                                                   // 8
			// stop already running IMAP instance                                                                               // 9
			if (RocketChat.IMAP && RocketChat.IMAP.isActive()) {                                                                // 10
				console.log('Disconnecting already running IMAP instance...');                                                     // 11
				RocketChat.IMAP.stop(Meteor.bindEnvironment(function () {                                                          // 12
					console.log('Starting new IMAP instance......');                                                                  // 13
					RocketChat.IMAP = new IMAPIntercepter();                                                                          // 14
					RocketChat.IMAP.start();                                                                                          // 15
					return true;                                                                                                      // 16
				}));                                                                                                               // 17
			} else if (RocketChat.POP3 && RocketChat.POP3Helper && RocketChat.POP3Helper.isActive()) {                          // 18
				console.log('Disconnecting already running POP instance...');                                                      // 19
				RocketChat.POP3Helper.stop(Meteor.bindEnvironment(function () {                                                    // 20
					console.log('Starting new IMAP instance......');                                                                  // 21
					RocketChat.IMAP = new IMAPIntercepter();                                                                          // 22
					RocketChat.IMAP.start();                                                                                          // 23
					return true;                                                                                                      // 24
				}));                                                                                                               // 25
			} else {                                                                                                            // 26
				console.log('Starting new IMAP instance......');                                                                   // 27
				RocketChat.IMAP = new IMAPIntercepter();                                                                           // 28
				RocketChat.IMAP.start();                                                                                           // 29
				return true;                                                                                                       // 30
			}                                                                                                                   // 31
		} else if (RocketChat.settings.get('Direct_Reply_Protocol') === 'POP') {                                             // 32
			// stop already running POP instance                                                                                // 33
			if (RocketChat.POP3 && RocketChat.POP3Helper && RocketChat.POP3Helper.isActive()) {                                 // 34
				console.log('Disconnecting already running POP instance...');                                                      // 35
				RocketChat.POP3Helper.stop(Meteor.bindEnvironment(function () {                                                    // 36
					console.log('Starting new POP instance......');                                                                   // 37
					RocketChat.POP3Helper = new POP3Helper();                                                                         // 38
					RocketChat.POP3Helper.start();                                                                                    // 39
					return true;                                                                                                      // 40
				}));                                                                                                               // 41
			} else if (RocketChat.IMAP && RocketChat.IMAP.isActive()) {                                                         // 42
				console.log('Disconnecting already running IMAP instance...');                                                     // 43
				RocketChat.IMAP.stop(Meteor.bindEnvironment(function () {                                                          // 44
					console.log('Starting new POP instance......');                                                                   // 45
					RocketChat.POP3Helper = new POP3Helper();                                                                         // 46
					RocketChat.POP3Helper.start();                                                                                    // 47
					return true;                                                                                                      // 48
				}));                                                                                                               // 49
			} else {                                                                                                            // 50
				console.log('Starting new POP instance......');                                                                    // 51
				RocketChat.POP3Helper = new POP3Helper();                                                                          // 52
				RocketChat.POP3Helper.start();                                                                                     // 53
				return true;                                                                                                       // 54
			}                                                                                                                   // 55
		}                                                                                                                    // 56
	} else if (RocketChat.IMAP && RocketChat.IMAP.isActive()) {                                                           // 57
		// stop IMAP instance                                                                                                // 58
		RocketChat.IMAP.stop();                                                                                              // 59
	} else if (RocketChat.POP3 && RocketChat.POP3Helper.isActive()) {                                                     // 60
		// stop POP3 instance                                                                                                // 61
		RocketChat.POP3Helper.stop();                                                                                        // 62
	}                                                                                                                     // 63
}), 1000);                                                                                                             // 64
                                                                                                                       //
RocketChat.settings.onload(/^Direct_Reply_.+/, startEmailIntercepter);                                                 // 66
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settingsOnLoadSMTP.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/settingsOnLoadSMTP.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var buildMailURL = _.debounce(function () {                                                                            // 1
	console.log('Updating process.env.MAIL_URL');                                                                         // 2
                                                                                                                       //
	if (RocketChat.settings.get('SMTP_Host')) {                                                                           // 4
		process.env.MAIL_URL = RocketChat.settings.get('SMTP_Protocol') + "://";                                             // 5
                                                                                                                       //
		if (RocketChat.settings.get('SMTP_Username') && RocketChat.settings.get('SMTP_Password')) {                          // 7
			process.env.MAIL_URL += encodeURIComponent(RocketChat.settings.get('SMTP_Username')) + ":" + encodeURIComponent(RocketChat.settings.get('SMTP_Password')) + "@";
		}                                                                                                                    // 9
                                                                                                                       //
		process.env.MAIL_URL += encodeURIComponent(RocketChat.settings.get('SMTP_Host'));                                    // 11
                                                                                                                       //
		if (RocketChat.settings.get('SMTP_Port')) {                                                                          // 13
			process.env.MAIL_URL += ":" + parseInt(RocketChat.settings.get('SMTP_Port'));                                       // 14
		}                                                                                                                    // 15
                                                                                                                       //
		process.env.MAIL_URL += "?pool=" + RocketChat.settings.get('SMTP_Pool');                                             // 17
                                                                                                                       //
		if (RocketChat.settings.get('SMTP_Protocol') === 'smtp' && RocketChat.settings.get('SMTP_IgnoreTLS')) {              // 19
			process.env.MAIL_URL += '&secure=false&ignoreTLS=true';                                                             // 20
		}                                                                                                                    // 21
                                                                                                                       //
		return process.env.MAIL_URL;                                                                                         // 23
	}                                                                                                                     // 24
}, 500);                                                                                                               // 25
                                                                                                                       //
RocketChat.settings.onload('SMTP_Host', function (key, value) {                                                        // 27
	if (_.isString(value)) {                                                                                              // 28
		return buildMailURL();                                                                                               // 29
	}                                                                                                                     // 30
});                                                                                                                    // 31
RocketChat.settings.onload('SMTP_Port', function () {                                                                  // 33
	return buildMailURL();                                                                                                // 34
});                                                                                                                    // 35
RocketChat.settings.onload('SMTP_Username', function (key, value) {                                                    // 37
	if (_.isString(value)) {                                                                                              // 38
		return buildMailURL();                                                                                               // 39
	}                                                                                                                     // 40
});                                                                                                                    // 41
RocketChat.settings.onload('SMTP_Password', function (key, value) {                                                    // 43
	if (_.isString(value)) {                                                                                              // 44
		return buildMailURL();                                                                                               // 45
	}                                                                                                                     // 46
});                                                                                                                    // 47
RocketChat.settings.onload('SMTP_Protocol', function () {                                                              // 49
	return buildMailURL();                                                                                                // 50
});                                                                                                                    // 51
RocketChat.settings.onload('SMTP_Pool', function () {                                                                  // 53
	return buildMailURL();                                                                                                // 54
});                                                                                                                    // 55
RocketChat.settings.onload('SMTP_IgnoreTLS', function () {                                                             // 57
	return buildMailURL();                                                                                                // 58
});                                                                                                                    // 59
Meteor.startup(function () {                                                                                           // 61
	return buildMailURL();                                                                                                // 62
});                                                                                                                    // 63
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"oAuthServicesUpdate.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/oAuthServicesUpdate.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals CustomOAuth */var logger = new Logger('rocketchat:lib', {                                                   // 1
	methods: {                                                                                                            // 3
		oauth_updated: {                                                                                                     // 4
			type: 'info'                                                                                                        // 5
		}                                                                                                                    // 4
	}                                                                                                                     // 3
});                                                                                                                    // 2
                                                                                                                       //
function _OAuthServicesUpdate() {                                                                                      // 10
	var services = RocketChat.settings.get(/^(Accounts_OAuth_|Accounts_OAuth_Custom-)[a-z0-9_]+$/i);                      // 11
	services.forEach(function (service) {                                                                                 // 12
		logger.oauth_updated(service.key);                                                                                   // 13
		var serviceName = service.key.replace('Accounts_OAuth_', '');                                                        // 14
                                                                                                                       //
		if (serviceName === 'Meteor') {                                                                                      // 15
			serviceName = 'meteor-developer';                                                                                   // 16
		}                                                                                                                    // 17
                                                                                                                       //
		if (/Accounts_OAuth_Custom-/.test(service.key)) {                                                                    // 18
			serviceName = service.key.replace('Accounts_OAuth_Custom-', '');                                                    // 19
		}                                                                                                                    // 20
                                                                                                                       //
		if (service.value === true) {                                                                                        // 21
			var data = {                                                                                                        // 22
				clientId: RocketChat.settings.get(service.key + "_id"),                                                            // 23
				secret: RocketChat.settings.get(service.key + "_secret")                                                           // 24
			};                                                                                                                  // 22
                                                                                                                       //
			if (/Accounts_OAuth_Custom-/.test(service.key)) {                                                                   // 26
				data.custom = true;                                                                                                // 27
				data.clientId = RocketChat.settings.get(service.key + "-id");                                                      // 28
				data.secret = RocketChat.settings.get(service.key + "-secret");                                                    // 29
				data.serverURL = RocketChat.settings.get(service.key + "-url");                                                    // 30
				data.tokenPath = RocketChat.settings.get(service.key + "-token_path");                                             // 31
				data.identityPath = RocketChat.settings.get(service.key + "-identity_path");                                       // 32
				data.authorizePath = RocketChat.settings.get(service.key + "-authorize_path");                                     // 33
				data.scope = RocketChat.settings.get(service.key + "-scope");                                                      // 34
				data.buttonLabelText = RocketChat.settings.get(service.key + "-button_label_text");                                // 35
				data.buttonLabelColor = RocketChat.settings.get(service.key + "-button_label_color");                              // 36
				data.loginStyle = RocketChat.settings.get(service.key + "-login_style");                                           // 37
				data.buttonColor = RocketChat.settings.get(service.key + "-button_color");                                         // 38
				data.tokenSentVia = RocketChat.settings.get(service.key + "-token_sent_via");                                      // 39
				data.usernameField = RocketChat.settings.get(service.key + "-username_field");                                     // 40
				data.mergeUsers = RocketChat.settings.get(service.key + "-merge_users");                                           // 41
				new CustomOAuth(serviceName.toLowerCase(), {                                                                       // 42
					serverURL: data.serverURL,                                                                                        // 43
					tokenPath: data.tokenPath,                                                                                        // 44
					identityPath: data.identityPath,                                                                                  // 45
					authorizePath: data.authorizePath,                                                                                // 46
					scope: data.scope,                                                                                                // 47
					loginStyle: data.loginStyle,                                                                                      // 48
					tokenSentVia: data.tokenSentVia,                                                                                  // 49
					usernameField: data.usernameField,                                                                                // 50
					mergeUsers: data.mergeUsers                                                                                       // 51
				});                                                                                                                // 42
			}                                                                                                                   // 53
                                                                                                                       //
			if (serviceName === 'Facebook') {                                                                                   // 54
				data.appId = data.clientId;                                                                                        // 55
				delete data.clientId;                                                                                              // 56
			}                                                                                                                   // 57
                                                                                                                       //
			if (serviceName === 'Twitter') {                                                                                    // 58
				data.consumerKey = data.clientId;                                                                                  // 59
				delete data.clientId;                                                                                              // 60
			}                                                                                                                   // 61
                                                                                                                       //
			ServiceConfiguration.configurations.upsert({                                                                        // 62
				service: serviceName.toLowerCase()                                                                                 // 63
			}, {                                                                                                                // 62
				$set: data                                                                                                         // 65
			});                                                                                                                 // 64
		} else {                                                                                                             // 67
			ServiceConfiguration.configurations.remove({                                                                        // 68
				service: serviceName.toLowerCase()                                                                                 // 69
			});                                                                                                                 // 68
		}                                                                                                                    // 71
	});                                                                                                                   // 72
}                                                                                                                      // 73
                                                                                                                       //
var OAuthServicesUpdate = _.debounce(Meteor.bindEnvironment(_OAuthServicesUpdate), 2000);                              // 75
                                                                                                                       //
function OAuthServicesRemove(_id) {                                                                                    // 77
	var serviceName = _id.replace('Accounts_OAuth_Custom-', '');                                                          // 78
                                                                                                                       //
	return ServiceConfiguration.configurations.remove({                                                                   // 79
		service: serviceName.toLowerCase()                                                                                   // 80
	});                                                                                                                   // 79
}                                                                                                                      // 82
                                                                                                                       //
RocketChat.settings.get(/^Accounts_OAuth_.+/, function () {                                                            // 84
	return OAuthServicesUpdate(); // eslint-disable-line new-cap                                                          // 85
});                                                                                                                    // 86
RocketChat.settings.get(/^Accounts_OAuth_Custom-[a-z0-9_]+/, function (key, value) {                                   // 88
	if (!value) {                                                                                                         // 89
		return OAuthServicesRemove(key); // eslint-disable-line new-cap                                                      // 90
	}                                                                                                                     // 91
});                                                                                                                    // 92
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"settings.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/startup/settings.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
// Insert server unique id if it doesn't exist                                                                         // 1
RocketChat.settings.add('uniqueID', process.env.DEPLOYMENT_ID || Random.id(), {                                        // 2
	'public': true,                                                                                                       // 3
	hidden: true                                                                                                          // 4
}); // When you define a setting and want to add a description, you don't need to automatically define the i18nDescription
// if you add a node to the i18n.json with the same setting name but with `_Description` it will automatically work.   // 8
                                                                                                                       //
RocketChat.settings.addGroup('Accounts', function () {                                                                 // 10
	this.add('Accounts_AllowAnonymousRead', false, {                                                                      // 11
		type: 'boolean',                                                                                                     // 12
		"public": true                                                                                                       // 13
	});                                                                                                                   // 11
	this.add('Accounts_AllowAnonymousWrite', false, {                                                                     // 15
		type: 'boolean',                                                                                                     // 16
		"public": true,                                                                                                      // 17
		enableQuery: {                                                                                                       // 18
			_id: 'Accounts_AllowAnonymousRead',                                                                                 // 19
			value: true                                                                                                         // 20
		}                                                                                                                    // 18
	});                                                                                                                   // 15
	this.add('Accounts_AllowDeleteOwnAccount', false, {                                                                   // 23
		type: 'boolean',                                                                                                     // 24
		'public': true,                                                                                                      // 25
		enableQuery: {                                                                                                       // 26
			_id: 'Accounts_AllowUserProfileChange',                                                                             // 27
			value: true                                                                                                         // 28
		}                                                                                                                    // 26
	});                                                                                                                   // 23
	this.add('Accounts_AllowUserProfileChange', true, {                                                                   // 31
		type: 'boolean',                                                                                                     // 32
		'public': true                                                                                                       // 33
	});                                                                                                                   // 31
	this.add('Accounts_AllowUserAvatarChange', true, {                                                                    // 35
		type: 'boolean',                                                                                                     // 36
		'public': true                                                                                                       // 37
	});                                                                                                                   // 35
	this.add('Accounts_AllowUsernameChange', false, {                                                                     // 39
		type: 'boolean',                                                                                                     // 40
		'public': true                                                                                                       // 41
	});                                                                                                                   // 39
	this.add('Accounts_AllowEmailChange', false, {                                                                        // 43
		type: 'boolean',                                                                                                     // 44
		'public': true                                                                                                       // 45
	});                                                                                                                   // 43
	this.add('Accounts_AllowPasswordChange', false, {                                                                     // 47
		type: 'boolean',                                                                                                     // 48
		'public': true                                                                                                       // 49
	});                                                                                                                   // 47
	this.add('Accounts_CustomFieldsToShowInUserInfo', '', {                                                               // 51
		type: 'string',                                                                                                      // 52
		"public": true                                                                                                       // 53
	});                                                                                                                   // 51
	this.add('Accounts_LoginExpiration', 90, {                                                                            // 55
		type: 'int',                                                                                                         // 56
		'public': true                                                                                                       // 57
	});                                                                                                                   // 55
	this.add('Accounts_ShowFormLogin', true, {                                                                            // 59
		type: 'boolean',                                                                                                     // 60
		'public': true                                                                                                       // 61
	});                                                                                                                   // 59
	this.add('Accounts_EmailOrUsernamePlaceholder', '', {                                                                 // 63
		type: 'string',                                                                                                      // 64
		'public': true,                                                                                                      // 65
		i18nLabel: 'Placeholder_for_email_or_username_login_field'                                                           // 66
	});                                                                                                                   // 63
	this.add('Accounts_PasswordPlaceholder', '', {                                                                        // 68
		type: 'string',                                                                                                      // 69
		'public': true,                                                                                                      // 70
		i18nLabel: 'Placeholder_for_password_login_field'                                                                    // 71
	});                                                                                                                   // 68
	this.add('Accounts_ForgetUserSessionOnWindowClose', false, {                                                          // 73
		type: 'boolean',                                                                                                     // 74
		'public': true                                                                                                       // 75
	});                                                                                                                   // 73
	this.add('Accounts_SearchFields', 'username, name, emails.address', {                                                 // 77
		type: 'string',                                                                                                      // 78
		"public": true                                                                                                       // 79
	});                                                                                                                   // 77
	this.section('Registration', function () {                                                                            // 82
		this.add('Accounts_DefaultUsernamePrefixSuggestion', 'user', {                                                       // 83
			type: 'string'                                                                                                      // 84
		});                                                                                                                  // 83
		this.add('Accounts_RequireNameForSignUp', false, {                                                                   // 86
			type: 'boolean',                                                                                                    // 87
			'public': true                                                                                                      // 88
		});                                                                                                                  // 86
		this.add('Accounts_RequirePasswordConfirmation', true, {                                                             // 90
			type: 'boolean',                                                                                                    // 91
			'public': true                                                                                                      // 92
		});                                                                                                                  // 90
		this.add('Accounts_EmailVerification', false, {                                                                      // 94
			type: 'boolean',                                                                                                    // 95
			'public': true,                                                                                                     // 96
			enableQuery: {                                                                                                      // 97
				_id: 'SMTP_Host',                                                                                                  // 98
				value: {                                                                                                           // 99
					$exists: 1,                                                                                                       // 100
					$ne: ''                                                                                                           // 101
				}                                                                                                                  // 99
			}                                                                                                                   // 97
		});                                                                                                                  // 94
		this.add('Accounts_ManuallyApproveNewUsers', false, {                                                                // 105
			type: 'boolean'                                                                                                     // 106
		});                                                                                                                  // 105
		this.add('Accounts_AllowedDomainsList', '', {                                                                        // 108
			type: 'string',                                                                                                     // 109
			'public': true                                                                                                      // 110
		});                                                                                                                  // 108
		this.add('Accounts_BlockedDomainsList', '', {                                                                        // 112
			type: 'string'                                                                                                      // 113
		});                                                                                                                  // 112
		this.add('Accounts_BlockedUsernameList', '', {                                                                       // 115
			type: 'string'                                                                                                      // 116
		});                                                                                                                  // 115
		this.add('Accounts_UseDefaultBlockedDomainsList', true, {                                                            // 118
			type: 'boolean'                                                                                                     // 119
		});                                                                                                                  // 118
		this.add('Accounts_UseDNSDomainCheck', false, {                                                                      // 121
			type: 'boolean'                                                                                                     // 122
		});                                                                                                                  // 121
		this.add('Accounts_RegistrationForm', 'Disabled', {                                                                  // 124
			type: 'select',                                                                                                     // 125
			'public': true,                                                                                                     // 126
			values: [{                                                                                                          // 127
				key: 'Public',                                                                                                     // 129
				i18nLabel: 'Accounts_RegistrationForm_Public'                                                                      // 130
			}, {                                                                                                                // 128
				key: 'Disabled',                                                                                                   // 132
				i18nLabel: 'Accounts_RegistrationForm_Disabled'                                                                    // 133
			}, {                                                                                                                // 131
				key: 'Secret URL',                                                                                                 // 135
				i18nLabel: 'Accounts_RegistrationForm_Secret_URL'                                                                  // 136
			}]                                                                                                                  // 134
		});                                                                                                                  // 124
		this.add('Accounts_RegistrationForm_SecretURL', Random.id(), {                                                       // 140
			type: 'string'                                                                                                      // 141
		});                                                                                                                  // 140
		this.add('Accounts_RegistrationForm_LinkReplacementText', 'New user registration is currently disabled', {           // 143
			type: 'string',                                                                                                     // 144
			'public': true                                                                                                      // 145
		});                                                                                                                  // 143
		this.add('Accounts_Registration_AuthenticationServices_Enabled', true, {                                             // 147
			type: 'boolean',                                                                                                    // 148
			'public': true                                                                                                      // 149
		});                                                                                                                  // 147
		this.add('Accounts_Registration_AuthenticationServices_Default_Roles', 'user', {                                     // 151
			type: 'string',                                                                                                     // 152
			enableQuery: {                                                                                                      // 153
				_id: 'Accounts_Registration_AuthenticationServices_Enabled',                                                       // 154
				value: true                                                                                                        // 155
			}                                                                                                                   // 153
		});                                                                                                                  // 151
		this.add('Accounts_PasswordReset', false, {                                                                          // 158
			type: 'boolean',                                                                                                    // 159
			'public': true                                                                                                      // 160
		});                                                                                                                  // 158
		this.add('Accounts_CustomFields', '', {                                                                              // 162
			type: 'code',                                                                                                       // 163
			'public': true,                                                                                                     // 164
			i18nLabel: 'Custom_Fields'                                                                                          // 165
		});                                                                                                                  // 162
	});                                                                                                                   // 167
	this.section('Avatar', function () {                                                                                  // 169
		this.add('Accounts_AvatarResize', true, {                                                                            // 170
			type: 'boolean'                                                                                                     // 171
		});                                                                                                                  // 170
		this.add('Accounts_AvatarSize', 200, {                                                                               // 173
			type: 'int',                                                                                                        // 174
			enableQuery: {                                                                                                      // 175
				_id: 'Accounts_AvatarResize',                                                                                      // 176
				value: true                                                                                                        // 177
			}                                                                                                                   // 175
		});                                                                                                                  // 173
		return this.add('Accounts_SetDefaultAvatar', true, {                                                                 // 181
			type: 'boolean'                                                                                                     // 182
		});                                                                                                                  // 181
	});                                                                                                                   // 184
});                                                                                                                    // 185
RocketChat.settings.addGroup('OAuth', function () {                                                                    // 187
	this.section('Facebook', function () {                                                                                // 188
		var enableQuery = {                                                                                                  // 189
			_id: 'Accounts_OAuth_Facebook',                                                                                     // 190
			value: true                                                                                                         // 191
		};                                                                                                                   // 189
		this.add('Accounts_OAuth_Facebook', false, {                                                                         // 193
			type: 'boolean',                                                                                                    // 194
			'public': true                                                                                                      // 195
		});                                                                                                                  // 193
		this.add('Accounts_OAuth_Facebook_id', '', {                                                                         // 197
			type: 'string',                                                                                                     // 198
			enableQuery: enableQuery                                                                                            // 199
		});                                                                                                                  // 197
		this.add('Accounts_OAuth_Facebook_secret', '', {                                                                     // 201
			type: 'string',                                                                                                     // 202
			enableQuery: enableQuery                                                                                            // 203
		});                                                                                                                  // 201
		return this.add('Accounts_OAuth_Facebook_callback_url', '_oauth/facebook', {                                         // 205
			type: 'relativeUrl',                                                                                                // 206
			readonly: true,                                                                                                     // 207
			force: true,                                                                                                        // 208
			enableQuery: enableQuery                                                                                            // 209
		});                                                                                                                  // 205
	});                                                                                                                   // 211
	this.section('Google', function () {                                                                                  // 212
		var enableQuery = {                                                                                                  // 213
			_id: 'Accounts_OAuth_Google',                                                                                       // 214
			value: true                                                                                                         // 215
		};                                                                                                                   // 213
		this.add('Accounts_OAuth_Google', false, {                                                                           // 217
			type: 'boolean',                                                                                                    // 218
			'public': true                                                                                                      // 219
		});                                                                                                                  // 217
		this.add('Accounts_OAuth_Google_id', '', {                                                                           // 221
			type: 'string',                                                                                                     // 222
			enableQuery: enableQuery                                                                                            // 223
		});                                                                                                                  // 221
		this.add('Accounts_OAuth_Google_secret', '', {                                                                       // 225
			type: 'string',                                                                                                     // 226
			enableQuery: enableQuery                                                                                            // 227
		});                                                                                                                  // 225
		return this.add('Accounts_OAuth_Google_callback_url', '_oauth/google', {                                             // 229
			type: 'relativeUrl',                                                                                                // 230
			readonly: true,                                                                                                     // 231
			force: true,                                                                                                        // 232
			enableQuery: enableQuery                                                                                            // 233
		});                                                                                                                  // 229
	});                                                                                                                   // 235
	this.section('GitHub', function () {                                                                                  // 236
		var enableQuery = {                                                                                                  // 237
			_id: 'Accounts_OAuth_Github',                                                                                       // 238
			value: true                                                                                                         // 239
		};                                                                                                                   // 237
		this.add('Accounts_OAuth_Github', false, {                                                                           // 241
			type: 'boolean',                                                                                                    // 242
			'public': true                                                                                                      // 243
		});                                                                                                                  // 241
		this.add('Accounts_OAuth_Github_id', '', {                                                                           // 245
			type: 'string',                                                                                                     // 246
			enableQuery: enableQuery                                                                                            // 247
		});                                                                                                                  // 245
		this.add('Accounts_OAuth_Github_secret', '', {                                                                       // 249
			type: 'string',                                                                                                     // 250
			enableQuery: enableQuery                                                                                            // 251
		});                                                                                                                  // 249
		return this.add('Accounts_OAuth_Github_callback_url', '_oauth/github', {                                             // 253
			type: 'relativeUrl',                                                                                                // 254
			readonly: true,                                                                                                     // 255
			force: true,                                                                                                        // 256
			enableQuery: enableQuery                                                                                            // 257
		});                                                                                                                  // 253
	});                                                                                                                   // 259
	this.section('Linkedin', function () {                                                                                // 260
		var enableQuery = {                                                                                                  // 261
			_id: 'Accounts_OAuth_Linkedin',                                                                                     // 262
			value: true                                                                                                         // 263
		};                                                                                                                   // 261
		this.add('Accounts_OAuth_Linkedin', false, {                                                                         // 265
			type: 'boolean',                                                                                                    // 266
			'public': true                                                                                                      // 267
		});                                                                                                                  // 265
		this.add('Accounts_OAuth_Linkedin_id', '', {                                                                         // 269
			type: 'string',                                                                                                     // 270
			enableQuery: enableQuery                                                                                            // 271
		});                                                                                                                  // 269
		this.add('Accounts_OAuth_Linkedin_secret', '', {                                                                     // 273
			type: 'string',                                                                                                     // 274
			enableQuery: enableQuery                                                                                            // 275
		});                                                                                                                  // 273
		return this.add('Accounts_OAuth_Linkedin_callback_url', '_oauth/linkedin', {                                         // 277
			type: 'relativeUrl',                                                                                                // 278
			readonly: true,                                                                                                     // 279
			force: true,                                                                                                        // 280
			enableQuery: enableQuery                                                                                            // 281
		});                                                                                                                  // 277
	});                                                                                                                   // 283
	this.section('Meteor', function () {                                                                                  // 284
		var enableQuery = {                                                                                                  // 285
			_id: 'Accounts_OAuth_Meteor',                                                                                       // 286
			value: true                                                                                                         // 287
		};                                                                                                                   // 285
		this.add('Accounts_OAuth_Meteor', false, {                                                                           // 289
			type: 'boolean',                                                                                                    // 290
			'public': true                                                                                                      // 291
		});                                                                                                                  // 289
		this.add('Accounts_OAuth_Meteor_id', '', {                                                                           // 293
			type: 'string',                                                                                                     // 294
			enableQuery: enableQuery                                                                                            // 295
		});                                                                                                                  // 293
		this.add('Accounts_OAuth_Meteor_secret', '', {                                                                       // 297
			type: 'string',                                                                                                     // 298
			enableQuery: enableQuery                                                                                            // 299
		});                                                                                                                  // 297
		return this.add('Accounts_OAuth_Meteor_callback_url', '_oauth/meteor', {                                             // 301
			type: 'relativeUrl',                                                                                                // 302
			readonly: true,                                                                                                     // 303
			force: true,                                                                                                        // 304
			enableQuery: enableQuery                                                                                            // 305
		});                                                                                                                  // 301
	});                                                                                                                   // 307
	this.section('Twitter', function () {                                                                                 // 308
		var enableQuery = {                                                                                                  // 309
			_id: 'Accounts_OAuth_Twitter',                                                                                      // 310
			value: true                                                                                                         // 311
		};                                                                                                                   // 309
		this.add('Accounts_OAuth_Twitter', false, {                                                                          // 313
			type: 'boolean',                                                                                                    // 314
			'public': true                                                                                                      // 315
		});                                                                                                                  // 313
		this.add('Accounts_OAuth_Twitter_id', '', {                                                                          // 317
			type: 'string',                                                                                                     // 318
			enableQuery: enableQuery                                                                                            // 319
		});                                                                                                                  // 317
		this.add('Accounts_OAuth_Twitter_secret', '', {                                                                      // 321
			type: 'string',                                                                                                     // 322
			enableQuery: enableQuery                                                                                            // 323
		});                                                                                                                  // 321
		return this.add('Accounts_OAuth_Twitter_callback_url', '_oauth/twitter', {                                           // 325
			type: 'relativeUrl',                                                                                                // 326
			readonly: true,                                                                                                     // 327
			force: true,                                                                                                        // 328
			enableQuery: enableQuery                                                                                            // 329
		});                                                                                                                  // 325
	});                                                                                                                   // 331
	return this.section('Proxy', function () {                                                                            // 332
		this.add('Accounts_OAuth_Proxy_host', 'https://oauth-proxy.rocket.chat', {                                           // 333
			type: 'string',                                                                                                     // 334
			'public': true                                                                                                      // 335
		});                                                                                                                  // 333
		return this.add('Accounts_OAuth_Proxy_services', '', {                                                               // 337
			type: 'string',                                                                                                     // 338
			'public': true                                                                                                      // 339
		});                                                                                                                  // 337
	});                                                                                                                   // 341
});                                                                                                                    // 342
RocketChat.settings.addGroup('General', function () {                                                                  // 344
	this.add('Site_Url', typeof __meteor_runtime_config__ !== 'undefined' && __meteor_runtime_config__ !== null ? __meteor_runtime_config__.ROOT_URL : null, {
		type: 'string',                                                                                                      // 346
		i18nDescription: 'Site_Url_Description',                                                                             // 347
		'public': true                                                                                                       // 348
	});                                                                                                                   // 345
	this.add('Site_Name', 'Chat+', {                                                                                      // 350
		type: 'string',                                                                                                      // 351
		'public': true                                                                                                       // 352
	});                                                                                                                   // 350
	this.add('Language', '', {                                                                                            // 354
		type: 'language',                                                                                                    // 355
		'public': true                                                                                                       // 356
	});                                                                                                                   // 354
	this.add('Allow_Invalid_SelfSigned_Certs', false, {                                                                   // 358
		type: 'boolean'                                                                                                      // 359
	});                                                                                                                   // 358
	this.add('Favorite_Rooms', true, {                                                                                    // 361
		type: 'boolean',                                                                                                     // 362
		'public': true                                                                                                       // 363
	});                                                                                                                   // 361
	this.add('First_Channel_After_Login', '', {                                                                           // 365
		type: 'string',                                                                                                      // 366
		'public': true                                                                                                       // 367
	});                                                                                                                   // 365
	this.add('Unread_Count', 'user_and_group_mentions_only', {                                                            // 369
		type: 'select',                                                                                                      // 370
		values: [{                                                                                                           // 371
			key: 'all_messages',                                                                                                // 373
			i18nLabel: 'All_messages'                                                                                           // 374
		}, {                                                                                                                 // 372
			key: 'user_mentions_only',                                                                                          // 376
			i18nLabel: 'User_mentions_only'                                                                                     // 377
		}, {                                                                                                                 // 375
			key: 'group_mentions_only',                                                                                         // 379
			i18nLabel: 'Group_mentions_only'                                                                                    // 380
		}, {                                                                                                                 // 378
			key: 'user_and_group_mentions_only',                                                                                // 382
			i18nLabel: 'User_and_group_mentions_only'                                                                           // 383
		}],                                                                                                                  // 381
		'public': true                                                                                                       // 386
	});                                                                                                                   // 369
	this.add('Unread_Count_DM', 'all_messages', {                                                                         // 388
		type: 'select',                                                                                                      // 389
		values: [{                                                                                                           // 390
			key: 'all_messages',                                                                                                // 392
			i18nLabel: 'All_messages'                                                                                           // 393
		}, {                                                                                                                 // 391
			key: 'mentions_only',                                                                                               // 395
			i18nLabel: 'Mentions_only'                                                                                          // 396
		}],                                                                                                                  // 394
		'public': true                                                                                                       // 399
	});                                                                                                                   // 388
	this.add('CDN_PREFIX', '', {                                                                                          // 401
		type: 'string',                                                                                                      // 402
		'public': true                                                                                                       // 403
	});                                                                                                                   // 401
	this.add('Force_SSL', false, {                                                                                        // 405
		type: 'boolean',                                                                                                     // 406
		'public': true                                                                                                       // 407
	});                                                                                                                   // 405
	this.add('GoogleTagManager_id', '', {                                                                                 // 409
		type: 'string',                                                                                                      // 410
		'public': true                                                                                                       // 411
	});                                                                                                                   // 409
	this.add('Bugsnag_api_key', '', {                                                                                     // 413
		type: 'string',                                                                                                      // 414
		'public': false                                                                                                      // 415
	});                                                                                                                   // 413
	this.add('Force_Disable_OpLog_For_Cache', false, {                                                                    // 417
		type: 'boolean',                                                                                                     // 418
		'public': false                                                                                                      // 419
	});                                                                                                                   // 417
	this.add('Restart', 'restart_server', {                                                                               // 421
		type: 'action',                                                                                                      // 422
		actionText: 'Restart_the_server'                                                                                     // 423
	});                                                                                                                   // 421
	this.section('UTF8', function () {                                                                                    // 425
		this.add('UTF8_Names_Validation', '[0-9a-zA-Z-_.]+', {                                                               // 426
			type: 'string',                                                                                                     // 427
			'public': true,                                                                                                     // 428
			i18nDescription: 'UTF8_Names_Validation_Description'                                                                // 429
		});                                                                                                                  // 426
		return this.add('UTF8_Names_Slugify', true, {                                                                        // 431
			type: 'boolean',                                                                                                    // 432
			'public': true                                                                                                      // 433
		});                                                                                                                  // 431
	});                                                                                                                   // 435
	this.section('Reporting', function () {                                                                               // 436
		return this.add('Statistics_reporting', true, {                                                                      // 437
			type: 'boolean'                                                                                                     // 438
		});                                                                                                                  // 437
	});                                                                                                                   // 440
	this.section('Notifications', function () {                                                                           // 441
		this.add('Desktop_Notifications_Duration', 0, {                                                                      // 442
			type: 'int',                                                                                                        // 443
			'public': true,                                                                                                     // 444
			i18nDescription: 'Desktop_Notification_Durations_Description'                                                       // 445
		});                                                                                                                  // 442
		this.add('Audio_Notifications_Value', 'chime', {                                                                     // 448
			type: 'string',                                                                                                     // 449
			'public': true,                                                                                                     // 450
			i18nDescription: 'Audio_Notification_Value_Description'                                                             // 451
		});                                                                                                                  // 448
		this.add('Audio_Notifications_Default_Alert', 'mentions', {                                                          // 454
			type: 'select',                                                                                                     // 455
			values: [{                                                                                                          // 456
				key: 'all',                                                                                                        // 457
				i18nLabel: 'All_messages'                                                                                          // 458
			}, {                                                                                                                // 456
				key: 'mentions',                                                                                                   // 460
				i18nLabel: 'Mentions'                                                                                              // 461
			}, {                                                                                                                // 459
				key: 'nothing',                                                                                                    // 463
				i18nLabel: 'Nothing'                                                                                               // 464
			}],                                                                                                                 // 462
			"public": true                                                                                                      // 466
		});                                                                                                                  // 454
		this.add('Desktop_Notifications_Default_Alert', 'mentions', {                                                        // 469
			type: 'select',                                                                                                     // 470
			values: [{                                                                                                          // 471
				key: 'all',                                                                                                        // 472
				i18nLabel: 'All_messages'                                                                                          // 473
			}, {                                                                                                                // 471
				key: 'mentions',                                                                                                   // 475
				i18nLabel: 'Mentions'                                                                                              // 476
			}, {                                                                                                                // 474
				key: 'nothing',                                                                                                    // 478
				i18nLabel: 'Nothing'                                                                                               // 479
			}],                                                                                                                 // 477
			"public": true                                                                                                      // 481
		});                                                                                                                  // 469
		this.add('Mobile_Notifications_Default_Alert', 'mentions', {                                                         // 484
			type: 'select',                                                                                                     // 485
			values: [{                                                                                                          // 486
				key: 'all',                                                                                                        // 487
				i18nLabel: 'All_messages'                                                                                          // 488
			}, {                                                                                                                // 486
				key: 'mentions',                                                                                                   // 490
				i18nLabel: 'Mentions'                                                                                              // 491
			}, {                                                                                                                // 489
				key: 'nothing',                                                                                                    // 493
				i18nLabel: 'Nothing'                                                                                               // 494
			}],                                                                                                                 // 492
			"public": true                                                                                                      // 496
		});                                                                                                                  // 484
		this.add('Notifications_Max_Room_Members', 100, {                                                                    // 499
			type: 'int',                                                                                                        // 500
			"public": true,                                                                                                     // 501
			i18nDescription: 'Notifications_Max_Room_Members_Description'                                                       // 502
		});                                                                                                                  // 499
	});                                                                                                                   // 504
	this.section('REST API', function () {                                                                                // 505
		return this.add('API_User_Limit', 500, {                                                                             // 506
			type: 'int',                                                                                                        // 507
			'public': true,                                                                                                     // 508
			i18nDescription: 'API_User_Limit'                                                                                   // 509
		});                                                                                                                  // 506
	});                                                                                                                   // 511
	this.section('Iframe_Integration', function () {                                                                      // 512
		this.add('Iframe_Integration_send_enable', false, {                                                                  // 513
			type: 'boolean',                                                                                                    // 514
			'public': true                                                                                                      // 515
		});                                                                                                                  // 513
		this.add('Iframe_Integration_send_target_origin', '*', {                                                             // 517
			type: 'string',                                                                                                     // 518
			'public': true,                                                                                                     // 519
			enableQuery: {                                                                                                      // 520
				_id: 'Iframe_Integration_send_enable',                                                                             // 521
				value: true                                                                                                        // 522
			}                                                                                                                   // 520
		});                                                                                                                  // 517
		this.add('Iframe_Integration_receive_enable', false, {                                                               // 525
			type: 'boolean',                                                                                                    // 526
			'public': true                                                                                                      // 527
		});                                                                                                                  // 525
		return this.add('Iframe_Integration_receive_origin', '*', {                                                          // 529
			type: 'string',                                                                                                     // 530
			'public': true,                                                                                                     // 531
			enableQuery: {                                                                                                      // 532
				_id: 'Iframe_Integration_receive_enable',                                                                          // 533
				value: true                                                                                                        // 534
			}                                                                                                                   // 532
		});                                                                                                                  // 529
	});                                                                                                                   // 537
	this.section('Translations', function () {                                                                            // 538
		return this.add('Custom_Translations', '', {                                                                         // 539
			type: 'code',                                                                                                       // 540
			'public': true                                                                                                      // 541
		});                                                                                                                  // 539
	});                                                                                                                   // 543
	return this.section('Stream_Cast', function () {                                                                      // 544
		return this.add('Stream_Cast_Address', '', {                                                                         // 545
			type: 'string'                                                                                                      // 546
		});                                                                                                                  // 545
	});                                                                                                                   // 548
});                                                                                                                    // 549
RocketChat.settings.addGroup('Email', function () {                                                                    // 551
	this.section('Subject', function () {                                                                                 // 552
		this.add('Offline_DM_Email', '[[Site_Name]] You have been direct messaged by [User]', {                              // 553
			type: 'code',                                                                                                       // 554
			code: 'text',                                                                                                       // 555
			multiline: true,                                                                                                    // 556
			i18nLabel: 'Offline_DM_Email',                                                                                      // 557
			i18nDescription: 'Offline_Email_Subject_Description'                                                                // 558
		});                                                                                                                  // 553
		this.add('Offline_Mention_Email', '[[Site_Name]] You have been mentioned by [User] in #[Room]', {                    // 560
			type: 'code',                                                                                                       // 561
			code: 'text',                                                                                                       // 562
			multiline: true,                                                                                                    // 563
			i18nLabel: 'Offline_Mention_Email',                                                                                 // 564
			i18nDescription: 'Offline_Email_Subject_Description'                                                                // 565
		});                                                                                                                  // 560
		return this.add('Offline_Mention_All_Email', '[User] has posted a message in #[Room]', {                             // 567
			type: 'code',                                                                                                       // 568
			code: 'text',                                                                                                       // 569
			multiline: true,                                                                                                    // 570
			i18nLabel: 'Offline_Mention_All_Email',                                                                             // 571
			i18nDescription: 'Offline_Email_Subject_Description'                                                                // 572
		});                                                                                                                  // 567
	});                                                                                                                   // 574
	this.section('Header_and_Footer', function () {                                                                       // 575
		this.add('Email_Header', '<html><table border="0" cellspacing="0" cellpadding="0" width="100%" bgcolor="#f3f3f3" style="color:#4a4a4a;font-family: Helvetica,Arial,sans-serif;font-size:14px;line-height:20px;border-collapse:collapse;border-spacing:0;margin:0 auto"><tr><td style="padding:1em"><table border="0" cellspacing="0" cellpadding="0" align="center" width="100%" style="width:100%;margin:0 auto;max-width:800px"><tr><td bgcolor="#ffffff" style="background-color:#ffffff; border: 1px solid #DDD; font-size: 10pt; font-family: Helvetica,Arial,sans-serif;"><table width="100%" border="0" cellspacing="0" cellpadding="0"><tr><td style="background-color: #04436a;"><h1 style="font-family: Helvetica,Arial,sans-serif; padding: 0 1em; margin: 0; line-height: 70px; color: #FFF;">[Site_Name]</h1></td></tr><tr><td style="padding: 1em; font-size: 10pt; font-family: Helvetica,Arial,sans-serif;">', {
			type: 'code',                                                                                                       // 577
			code: 'text/html',                                                                                                  // 578
			multiline: true,                                                                                                    // 579
			i18nLabel: 'Header'                                                                                                 // 580
		});                                                                                                                  // 576
		this.add('Email_Footer', '</td></tr></table></td></tr><tr><td border="0" cellspacing="0" cellpadding="0" width="100%" style="font-family: Helvetica,Arial,sans-serif; max-width: 800px; margin: 0 auto; padding: 1.5em; text-align: center; font-size: 8pt; color: #999;"></td></tr></table></td></tr></table></html>', {
			type: 'code',                                                                                                       // 583
			code: 'text/html',                                                                                                  // 584
			multiline: true,                                                                                                    // 585
			i18nLabel: 'Footer'                                                                                                 // 586
		});                                                                                                                  // 582
		return this.add('Email_Footer_Direct_Reply', '</td></tr></table></td></tr><tr><td border="0" cellspacing="0" cellpadding="0" width="100%" style="font-family: Helvetica,Arial,sans-serif; max-width: 800px; margin: 0 auto; padding: 1.5em; text-align: center; font-size: 8pt; color: #999;">You can directly reply to this email.<br>Do not temper reply email<br>Powered by <a href="https://rocket.chat" target="_blank">Rocket.Chat</a></td></tr></table></td></tr></table></html>', {
			type: 'code',                                                                                                       // 589
			code: 'text/html',                                                                                                  // 590
			multiline: true,                                                                                                    // 591
			i18nLabel: 'Footer_Direct_Reply'                                                                                    // 592
		});                                                                                                                  // 588
	});                                                                                                                   // 594
	this.section('Direct_Reply', function () {                                                                            // 595
		this.add('Direct_Reply_Enable', false, {                                                                             // 596
			type: 'boolean',                                                                                                    // 597
			env: true,                                                                                                          // 598
			i18nLabel: 'Direct_Reply_Enable'                                                                                    // 599
		});                                                                                                                  // 596
		this.add('Direct_Reply_Debug', false, {                                                                              // 601
			type: 'boolean',                                                                                                    // 602
			env: true,                                                                                                          // 603
			i18nLabel: 'Direct_Reply_Debug',                                                                                    // 604
			i18nDescription: 'Direct_Reply_Debug_Description'                                                                   // 605
		});                                                                                                                  // 601
		this.add('Direct_Reply_Protocol', 'IMAP', {                                                                          // 607
			type: 'select',                                                                                                     // 608
			values: [{                                                                                                          // 609
				key: 'IMAP',                                                                                                       // 611
				i18nLabel: 'IMAP'                                                                                                  // 612
			}, {                                                                                                                // 610
				key: 'POP',                                                                                                        // 614
				i18nLabel: 'POP'                                                                                                   // 615
			}],                                                                                                                 // 613
			env: true,                                                                                                          // 618
			i18nLabel: 'Protocol'                                                                                               // 619
		});                                                                                                                  // 607
		this.add('Direct_Reply_Host', '', {                                                                                  // 621
			type: 'string',                                                                                                     // 622
			env: true,                                                                                                          // 623
			i18nLabel: 'Host'                                                                                                   // 624
		});                                                                                                                  // 621
		this.add('Direct_Reply_Port', '143', {                                                                               // 626
			type: 'select',                                                                                                     // 627
			values: [{                                                                                                          // 628
				key: '143',                                                                                                        // 630
				i18nLabel: '143'                                                                                                   // 631
			}, {                                                                                                                // 629
				key: '993',                                                                                                        // 633
				i18nLabel: '993'                                                                                                   // 634
			}, {                                                                                                                // 632
				key: '110',                                                                                                        // 636
				i18nLabel: '110'                                                                                                   // 637
			}, {                                                                                                                // 635
				key: '995',                                                                                                        // 639
				i18nLabel: '995'                                                                                                   // 640
			}],                                                                                                                 // 638
			env: true,                                                                                                          // 643
			i18nLabel: 'Port'                                                                                                   // 644
		});                                                                                                                  // 626
		this.add('Direct_Reply_IgnoreTLS', false, {                                                                          // 646
			type: 'boolean',                                                                                                    // 647
			env: true,                                                                                                          // 648
			i18nLabel: 'IgnoreTLS'                                                                                              // 649
		});                                                                                                                  // 646
		this.add('Direct_Reply_Frequency', 5, {                                                                              // 651
			type: 'int',                                                                                                        // 652
			env: true,                                                                                                          // 653
			i18nLabel: 'Direct_Reply_Frequency',                                                                                // 654
			enableQuery: {                                                                                                      // 655
				_id: 'Direct_Reply_Protocol',                                                                                      // 656
				value: 'POP'                                                                                                       // 657
			}                                                                                                                   // 655
		});                                                                                                                  // 651
		this.add('Direct_Reply_Delete', true, {                                                                              // 660
			type: 'boolean',                                                                                                    // 661
			env: true,                                                                                                          // 662
			i18nLabel: 'Direct_Reply_Delete',                                                                                   // 663
			enableQuery: {                                                                                                      // 664
				_id: 'Direct_Reply_Protocol',                                                                                      // 665
				value: 'IMAP'                                                                                                      // 666
			}                                                                                                                   // 664
		});                                                                                                                  // 660
		this.add('Direct_Reply_Separator', '+', {                                                                            // 669
			type: 'select',                                                                                                     // 670
			values: [{                                                                                                          // 671
				key: '!',                                                                                                          // 673
				i18nLabel: '!'                                                                                                     // 674
			}, {                                                                                                                // 672
				key: '#',                                                                                                          // 676
				i18nLabel: '#'                                                                                                     // 677
			}, {                                                                                                                // 675
				key: '$',                                                                                                          // 679
				i18nLabel: '$'                                                                                                     // 680
			}, {                                                                                                                // 678
				key: '%',                                                                                                          // 682
				i18nLabel: '%'                                                                                                     // 683
			}, {                                                                                                                // 681
				key: '&',                                                                                                          // 685
				i18nLabel: '&'                                                                                                     // 686
			}, {                                                                                                                // 684
				key: '\'',                                                                                                         // 688
				i18nLabel: '\''                                                                                                    // 689
			}, {                                                                                                                // 687
				key: '*',                                                                                                          // 691
				i18nLabel: '*'                                                                                                     // 692
			}, {                                                                                                                // 690
				key: '+',                                                                                                          // 694
				i18nLabel: '+'                                                                                                     // 695
			}, {                                                                                                                // 693
				key: '-',                                                                                                          // 697
				i18nLabel: '-'                                                                                                     // 698
			}, {                                                                                                                // 696
				key: '/',                                                                                                          // 700
				i18nLabel: '/'                                                                                                     // 701
			}, {                                                                                                                // 699
				key: '=',                                                                                                          // 703
				i18nLabel: '='                                                                                                     // 704
			}, {                                                                                                                // 702
				key: '?',                                                                                                          // 706
				i18nLabel: '?'                                                                                                     // 707
			}, {                                                                                                                // 705
				key: '^',                                                                                                          // 709
				i18nLabel: '^'                                                                                                     // 710
			}, {                                                                                                                // 708
				key: '_',                                                                                                          // 712
				i18nLabel: '_'                                                                                                     // 713
			}, {                                                                                                                // 711
				key: '`',                                                                                                          // 715
				i18nLabel: '`'                                                                                                     // 716
			}, {                                                                                                                // 714
				key: '{',                                                                                                          // 718
				i18nLabel: '{'                                                                                                     // 719
			}, {                                                                                                                // 717
				key: '|',                                                                                                          // 721
				i18nLabel: '|'                                                                                                     // 722
			}, {                                                                                                                // 720
				key: '}',                                                                                                          // 724
				i18nLabel: '}'                                                                                                     // 725
			}, {                                                                                                                // 723
				key: '~',                                                                                                          // 727
				i18nLabel: '~'                                                                                                     // 728
			}],                                                                                                                 // 726
			env: true,                                                                                                          // 731
			i18nLabel: 'Direct_Reply_Separator'                                                                                 // 732
		});                                                                                                                  // 669
		this.add('Direct_Reply_Username', '', {                                                                              // 734
			type: 'string',                                                                                                     // 735
			env: true,                                                                                                          // 736
			i18nLabel: 'Username',                                                                                              // 737
			placeholder: 'email@domain'                                                                                         // 738
		});                                                                                                                  // 734
		return this.add('Direct_Reply_Password', '', {                                                                       // 740
			type: 'password',                                                                                                   // 741
			env: true,                                                                                                          // 742
			i18nLabel: 'Password'                                                                                               // 743
		});                                                                                                                  // 740
	});                                                                                                                   // 745
	this.section('SMTP', function () {                                                                                    // 746
		this.add('SMTP_Protocol', 'smtp', {                                                                                  // 747
			type: 'select',                                                                                                     // 748
			values: [{                                                                                                          // 749
				key: 'smtp',                                                                                                       // 751
				i18nLabel: 'smtp'                                                                                                  // 752
			}, {                                                                                                                // 750
				key: 'smtps',                                                                                                      // 754
				i18nLabel: 'smtps'                                                                                                 // 755
			}],                                                                                                                 // 753
			env: true,                                                                                                          // 758
			i18nLabel: 'Protocol'                                                                                               // 759
		});                                                                                                                  // 747
		this.add('SMTP_Host', '', {                                                                                          // 761
			type: 'string',                                                                                                     // 762
			env: true,                                                                                                          // 763
			i18nLabel: 'Host'                                                                                                   // 764
		});                                                                                                                  // 761
		this.add('SMTP_Port', '', {                                                                                          // 766
			type: 'string',                                                                                                     // 767
			env: true,                                                                                                          // 768
			i18nLabel: 'Port'                                                                                                   // 769
		});                                                                                                                  // 766
		this.add('SMTP_IgnoreTLS', false, {                                                                                  // 771
			type: 'boolean',                                                                                                    // 772
			env: true,                                                                                                          // 773
			i18nLabel: 'IgnoreTLS',                                                                                             // 774
			enableQuery: {                                                                                                      // 775
				_id: 'SMTP_Protocol',                                                                                              // 776
				value: 'smtp'                                                                                                      // 777
			}                                                                                                                   // 775
		});                                                                                                                  // 771
		this.add('SMTP_Pool', true, {                                                                                        // 780
			type: 'boolean',                                                                                                    // 781
			env: true,                                                                                                          // 782
			i18nLabel: 'Pool'                                                                                                   // 783
		});                                                                                                                  // 780
		this.add('SMTP_Username', '', {                                                                                      // 785
			type: 'string',                                                                                                     // 786
			env: true,                                                                                                          // 787
			i18nLabel: 'Username'                                                                                               // 788
		});                                                                                                                  // 785
		this.add('SMTP_Password', '', {                                                                                      // 790
			type: 'password',                                                                                                   // 791
			env: true,                                                                                                          // 792
			i18nLabel: 'Password'                                                                                               // 793
		});                                                                                                                  // 790
		this.add('From_Email', '', {                                                                                         // 795
			type: 'string',                                                                                                     // 796
			placeholder: 'email@domain'                                                                                         // 797
		});                                                                                                                  // 795
		return this.add('SMTP_Test_Button', 'sendSMTPTestEmail', {                                                           // 799
			type: 'action',                                                                                                     // 800
			actionText: 'Send_a_test_mail_to_my_user'                                                                           // 801
		});                                                                                                                  // 799
	});                                                                                                                   // 803
	this.section('Invitation', function () {                                                                              // 804
		this.add('Invitation_Customized', false, {                                                                           // 805
			type: 'boolean',                                                                                                    // 806
			i18nLabel: 'Custom'                                                                                                 // 807
		});                                                                                                                  // 805
		this.add('Invitation_Subject', '', {                                                                                 // 809
			type: 'string',                                                                                                     // 810
			i18nLabel: 'Subject',                                                                                               // 811
			enableQuery: {                                                                                                      // 812
				_id: 'Invitation_Customized',                                                                                      // 813
				value: true                                                                                                        // 814
			},                                                                                                                  // 812
			i18nDefaultQuery: {                                                                                                 // 816
				_id: 'Invitation_Customized',                                                                                      // 817
				value: false                                                                                                       // 818
			}                                                                                                                   // 816
		});                                                                                                                  // 809
		return this.add('Invitation_HTML', '', {                                                                             // 821
			type: 'code',                                                                                                       // 822
			code: 'text/html',                                                                                                  // 823
			multiline: true,                                                                                                    // 824
			i18nLabel: 'Body',                                                                                                  // 825
			i18nDescription: 'Invitation_HTML_Description',                                                                     // 826
			enableQuery: {                                                                                                      // 827
				_id: 'Invitation_Customized',                                                                                      // 828
				value: true                                                                                                        // 829
			},                                                                                                                  // 827
			i18nDefaultQuery: {                                                                                                 // 831
				_id: 'Invitation_Customized',                                                                                      // 832
				value: false                                                                                                       // 833
			}                                                                                                                   // 831
		});                                                                                                                  // 821
	});                                                                                                                   // 836
	this.section('Registration', function () {                                                                            // 837
		this.add('Accounts_Enrollment_Customized', false, {                                                                  // 838
			type: 'boolean',                                                                                                    // 839
			i18nLabel: 'Custom'                                                                                                 // 840
		});                                                                                                                  // 838
		this.add('Accounts_Enrollment_Email_Subject', '', {                                                                  // 842
			type: 'string',                                                                                                     // 843
			i18nLabel: 'Subject',                                                                                               // 844
			enableQuery: {                                                                                                      // 845
				_id: 'Accounts_Enrollment_Customized',                                                                             // 846
				value: true                                                                                                        // 847
			},                                                                                                                  // 845
			i18nDefaultQuery: {                                                                                                 // 849
				_id: 'Accounts_Enrollment_Customized',                                                                             // 850
				value: false                                                                                                       // 851
			}                                                                                                                   // 849
		});                                                                                                                  // 842
		return this.add('Accounts_Enrollment_Email', '', {                                                                   // 854
			type: 'code',                                                                                                       // 855
			code: 'text/html',                                                                                                  // 856
			multiline: true,                                                                                                    // 857
			i18nLabel: 'Body',                                                                                                  // 858
			enableQuery: {                                                                                                      // 859
				_id: 'Accounts_Enrollment_Customized',                                                                             // 860
				value: true                                                                                                        // 861
			},                                                                                                                  // 859
			i18nDefaultQuery: {                                                                                                 // 863
				_id: 'Accounts_Enrollment_Customized',                                                                             // 864
				value: false                                                                                                       // 865
			}                                                                                                                   // 863
		});                                                                                                                  // 854
	});                                                                                                                   // 868
	this.section('Registration_via_Admin', function () {                                                                  // 869
		this.add('Accounts_UserAddedEmail_Customized', false, {                                                              // 870
			type: 'boolean',                                                                                                    // 871
			i18nLabel: 'Custom'                                                                                                 // 872
		});                                                                                                                  // 870
		this.add('Accounts_UserAddedEmailSubject', '', {                                                                     // 874
			type: 'string',                                                                                                     // 875
			i18nLabel: 'Subject',                                                                                               // 876
			enableQuery: {                                                                                                      // 877
				_id: 'Accounts_UserAddedEmail_Customized',                                                                         // 878
				value: true                                                                                                        // 879
			},                                                                                                                  // 877
			i18nDefaultQuery: {                                                                                                 // 881
				_id: 'Accounts_UserAddedEmail_Customized',                                                                         // 882
				value: false                                                                                                       // 883
			}                                                                                                                   // 881
		});                                                                                                                  // 874
		return this.add('Accounts_UserAddedEmail', '', {                                                                     // 886
			type: 'code',                                                                                                       // 887
			code: 'text/html',                                                                                                  // 888
			multiline: true,                                                                                                    // 889
			i18nLabel: 'Body',                                                                                                  // 890
			i18nDescription: 'Accounts_UserAddedEmail_Description',                                                             // 891
			enableQuery: {                                                                                                      // 892
				_id: 'Accounts_UserAddedEmail_Customized',                                                                         // 893
				value: true                                                                                                        // 894
			},                                                                                                                  // 892
			i18nDefaultQuery: {                                                                                                 // 896
				_id: 'Accounts_UserAddedEmail_Customized',                                                                         // 897
				value: false                                                                                                       // 898
			}                                                                                                                   // 896
		});                                                                                                                  // 886
	});                                                                                                                   // 901
	this.section('Forgot_password_section', function () {                                                                 // 902
		this.add('Forgot_Password_Customized', false, {                                                                      // 903
			type: 'boolean',                                                                                                    // 904
			i18nLabel: 'Custom'                                                                                                 // 905
		});                                                                                                                  // 903
		this.add('Forgot_Password_Email_Subject', '', {                                                                      // 907
			type: 'string',                                                                                                     // 908
			i18nLabel: 'Subject',                                                                                               // 909
			enableQuery: {                                                                                                      // 910
				_id: 'Forgot_Password_Customized',                                                                                 // 911
				value: true                                                                                                        // 912
			},                                                                                                                  // 910
			i18nDefaultQuery: {                                                                                                 // 914
				_id: 'Forgot_Password_Customized',                                                                                 // 915
				value: false                                                                                                       // 916
			}                                                                                                                   // 914
		});                                                                                                                  // 907
		return this.add('Forgot_Password_Email', '', {                                                                       // 919
			type: 'code',                                                                                                       // 920
			code: 'text/html',                                                                                                  // 921
			multiline: true,                                                                                                    // 922
			i18nLabel: 'Body',                                                                                                  // 923
			i18nDescription: 'Forgot_Password_Description',                                                                     // 924
			enableQuery: {                                                                                                      // 925
				_id: 'Forgot_Password_Customized',                                                                                 // 926
				value: true                                                                                                        // 927
			},                                                                                                                  // 925
			i18nDefaultQuery: {                                                                                                 // 929
				_id: 'Forgot_Password_Customized',                                                                                 // 930
				value: false                                                                                                       // 931
			}                                                                                                                   // 929
		});                                                                                                                  // 919
	});                                                                                                                   // 934
	return this.section('Verification', function () {                                                                     // 935
		this.add('Verification_Customized', false, {                                                                         // 936
			type: 'boolean',                                                                                                    // 937
			i18nLabel: 'Custom'                                                                                                 // 938
		});                                                                                                                  // 936
		this.add('Verification_Email_Subject', '', {                                                                         // 940
			type: 'string',                                                                                                     // 941
			i18nLabel: 'Subject',                                                                                               // 942
			enableQuery: {                                                                                                      // 943
				_id: 'Verification_Customized',                                                                                    // 944
				value: true                                                                                                        // 945
			},                                                                                                                  // 943
			i18nDefaultQuery: {                                                                                                 // 947
				_id: 'Verification_Customized',                                                                                    // 948
				value: false                                                                                                       // 949
			}                                                                                                                   // 947
		});                                                                                                                  // 940
		return this.add('Verification_Email', '', {                                                                          // 952
			type: 'code',                                                                                                       // 953
			code: 'text/html',                                                                                                  // 954
			multiline: true,                                                                                                    // 955
			i18nLabel: 'Body',                                                                                                  // 956
			i18nDescription: 'Verification_Description',                                                                        // 957
			enableQuery: {                                                                                                      // 958
				_id: 'Verification_Customized',                                                                                    // 959
				value: true                                                                                                        // 960
			},                                                                                                                  // 958
			i18nDefaultQuery: {                                                                                                 // 962
				_id: 'Verification_Customized',                                                                                    // 963
				value: false                                                                                                       // 964
			}                                                                                                                   // 962
		});                                                                                                                  // 952
	});                                                                                                                   // 967
});                                                                                                                    // 968
RocketChat.settings.addGroup('Message', function () {                                                                  // 970
	this.section('Message_Attachments', function () {                                                                     // 971
		this.add('Message_Attachments_GroupAttach', false, {                                                                 // 972
			type: 'boolean',                                                                                                    // 973
			'public': true,                                                                                                     // 974
			i18nDescription: 'Message_Attachments_GroupAttachDescription'                                                       // 975
		});                                                                                                                  // 972
		this.add('Message_AudioRecorderEnabled', true, {                                                                     // 977
			type: 'boolean',                                                                                                    // 978
			'public': true,                                                                                                     // 979
			i18nDescription: 'Message_AudioRecorderEnabledDescription'                                                          // 980
		});                                                                                                                  // 977
	});                                                                                                                   // 982
	this.add('Message_AllowEditing', true, {                                                                              // 983
		type: 'boolean',                                                                                                     // 984
		'public': true                                                                                                       // 985
	});                                                                                                                   // 983
	this.add('Message_AllowEditing_BlockEditInMinutes', 0, {                                                              // 987
		type: 'int',                                                                                                         // 988
		'public': true,                                                                                                      // 989
		i18nDescription: 'Message_AllowEditing_BlockEditInMinutesDescription'                                                // 990
	});                                                                                                                   // 987
	this.add('Message_AllowDeleting', true, {                                                                             // 992
		type: 'boolean',                                                                                                     // 993
		'public': true                                                                                                       // 994
	});                                                                                                                   // 992
	this.add('Message_AllowDeleting_BlockDeleteInMinutes', 0, {                                                           // 996
		type: 'int',                                                                                                         // 997
		'public': true,                                                                                                      // 998
		i18nDescription: 'Message_AllowDeleting_BlockDeleteInMinutes'                                                        // 999
	});                                                                                                                   // 996
	this.add('Message_AllowUnrecognizedSlashCommand', false, {                                                            // 1001
		type: 'boolean',                                                                                                     // 1002
		'public': true                                                                                                       // 1003
	});                                                                                                                   // 1001
	this.add('Message_AlwaysSearchRegExp', false, {                                                                       // 1005
		type: 'boolean'                                                                                                      // 1006
	});                                                                                                                   // 1005
	this.add('Message_ShowEditedStatus', true, {                                                                          // 1008
		type: 'boolean',                                                                                                     // 1009
		'public': true                                                                                                       // 1010
	});                                                                                                                   // 1008
	this.add('Message_ShowDeletedStatus', false, {                                                                        // 1012
		type: 'boolean',                                                                                                     // 1013
		'public': true                                                                                                       // 1014
	});                                                                                                                   // 1012
	this.add('Message_AllowBadWordsFilter', false, {                                                                      // 1016
		type: 'boolean',                                                                                                     // 1017
		'public': true                                                                                                       // 1018
	});                                                                                                                   // 1016
	this.add('Message_BadWordsFilterList', '', {                                                                          // 1020
		type: 'string',                                                                                                      // 1021
		'public': true                                                                                                       // 1022
	});                                                                                                                   // 1020
	this.add('Message_KeepHistory', false, {                                                                              // 1024
		type: 'boolean',                                                                                                     // 1025
		'public': true                                                                                                       // 1026
	});                                                                                                                   // 1024
	this.add('Message_MaxAll', 0, {                                                                                       // 1028
		type: 'int',                                                                                                         // 1029
		'public': true                                                                                                       // 1030
	});                                                                                                                   // 1028
	this.add('Message_MaxAllowedSize', 5000, {                                                                            // 1032
		type: 'int',                                                                                                         // 1033
		'public': true                                                                                                       // 1034
	});                                                                                                                   // 1032
	this.add('Message_ShowFormattingTips', true, {                                                                        // 1036
		type: 'boolean',                                                                                                     // 1037
		'public': true                                                                                                       // 1038
	});                                                                                                                   // 1036
	this.add('Message_SetNameToAliasEnabled', false, {                                                                    // 1040
		type: 'boolean',                                                                                                     // 1041
		'public': false,                                                                                                     // 1042
		i18nDescription: 'Message_SetNameToAliasEnabled_Description'                                                         // 1043
	});                                                                                                                   // 1040
	this.add('Message_GroupingPeriod', 300, {                                                                             // 1045
		type: 'int',                                                                                                         // 1046
		'public': true,                                                                                                      // 1047
		i18nDescription: 'Message_GroupingPeriodDescription'                                                                 // 1048
	});                                                                                                                   // 1045
	this.add('API_Embed', true, {                                                                                         // 1050
		type: 'boolean',                                                                                                     // 1051
		'public': true                                                                                                       // 1052
	});                                                                                                                   // 1050
	this.add('API_Embed_UserAgent', 'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2227.0 Safari/537.36', {
		type: 'string',                                                                                                      // 1055
		'public': true                                                                                                       // 1056
	});                                                                                                                   // 1054
	this.add('API_EmbedCacheExpirationDays', 30, {                                                                        // 1058
		type: 'int',                                                                                                         // 1059
		'public': false                                                                                                      // 1060
	});                                                                                                                   // 1058
	this.add('API_Embed_clear_cache_now', 'OEmbedCacheCleanup', {                                                         // 1062
		type: 'action',                                                                                                      // 1063
		actionText: 'clear',                                                                                                 // 1064
		i18nLabel: 'clear_cache_now'                                                                                         // 1065
	});                                                                                                                   // 1062
	this.add('API_EmbedDisabledFor', '', {                                                                                // 1067
		type: 'string',                                                                                                      // 1068
		'public': true,                                                                                                      // 1069
		i18nDescription: 'API_EmbedDisabledFor_Description'                                                                  // 1070
	});                                                                                                                   // 1067
	this.add('API_EmbedIgnoredHosts', 'localhost, 127.0.0.1, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16', {                // 1072
		type: 'string',                                                                                                      // 1073
		i18nDescription: 'API_EmbedIgnoredHosts_Description'                                                                 // 1074
	});                                                                                                                   // 1072
	this.add('API_EmbedSafePorts', '80, 443', {                                                                           // 1076
		type: 'string'                                                                                                       // 1077
	});                                                                                                                   // 1076
	this.add('Message_TimeFormat', 'LT', {                                                                                // 1079
		type: 'string',                                                                                                      // 1080
		'public': true,                                                                                                      // 1081
		i18nDescription: 'Message_TimeFormat_Description'                                                                    // 1082
	});                                                                                                                   // 1079
	this.add('Message_DateFormat', 'LL', {                                                                                // 1084
		type: 'string',                                                                                                      // 1085
		'public': true,                                                                                                      // 1086
		i18nDescription: 'Message_DateFormat_Description'                                                                    // 1087
	});                                                                                                                   // 1084
	this.add('Message_TimeAndDateFormat', 'LLL', {                                                                        // 1089
		type: 'string',                                                                                                      // 1090
		'public': true,                                                                                                      // 1091
		i18nDescription: 'Message_TimeAndDateFormat_Description'                                                             // 1092
	});                                                                                                                   // 1089
	this.add('Message_QuoteChainLimit', 2, {                                                                              // 1094
		type: 'int',                                                                                                         // 1095
		'public': true                                                                                                       // 1096
	});                                                                                                                   // 1094
	this.add('Message_HideType_uj', false, {                                                                              // 1098
		type: 'boolean',                                                                                                     // 1099
		'public': true                                                                                                       // 1100
	});                                                                                                                   // 1098
	this.add('Message_HideType_ul', false, {                                                                              // 1102
		type: 'boolean',                                                                                                     // 1103
		'public': true                                                                                                       // 1104
	});                                                                                                                   // 1102
	this.add('Message_HideType_ru', false, {                                                                              // 1106
		type: 'boolean',                                                                                                     // 1107
		'public': true                                                                                                       // 1108
	});                                                                                                                   // 1106
	this.add('Message_HideType_au', false, {                                                                              // 1110
		type: 'boolean',                                                                                                     // 1111
		'public': true                                                                                                       // 1112
	});                                                                                                                   // 1110
	return this.add('Message_HideType_mute_unmute', false, {                                                              // 1115
		type: 'boolean',                                                                                                     // 1116
		'public': true                                                                                                       // 1117
	});                                                                                                                   // 1115
});                                                                                                                    // 1119
RocketChat.settings.addGroup('Meta', function () {                                                                     // 1121
	this.add('Meta_language', '', {                                                                                       // 1122
		type: 'string'                                                                                                       // 1123
	});                                                                                                                   // 1122
	this.add('Meta_fb_app_id', '', {                                                                                      // 1125
		type: 'string'                                                                                                       // 1126
	});                                                                                                                   // 1125
	this.add('Meta_robots', 'INDEX,FOLLOW', {                                                                             // 1128
		type: 'string'                                                                                                       // 1129
	});                                                                                                                   // 1128
	this.add('Meta_google-site-verification', '', {                                                                       // 1131
		type: 'string'                                                                                                       // 1132
	});                                                                                                                   // 1131
	this.add('Meta_msvalidate01', '', {                                                                                   // 1134
		type: 'string'                                                                                                       // 1135
	});                                                                                                                   // 1134
	return this.add('Meta_custom', '', {                                                                                  // 1137
		type: 'code',                                                                                                        // 1138
		code: 'text/html',                                                                                                   // 1139
		multiline: true                                                                                                      // 1140
	});                                                                                                                   // 1137
});                                                                                                                    // 1142
RocketChat.settings.addGroup('Push', function () {                                                                     // 1144
	this.add('Push_enable', true, {                                                                                       // 1145
		type: 'boolean',                                                                                                     // 1146
		'public': true                                                                                                       // 1147
	});                                                                                                                   // 1145
	this.add('Push_debug', false, {                                                                                       // 1149
		type: 'boolean',                                                                                                     // 1150
		'public': true,                                                                                                      // 1151
		enableQuery: {                                                                                                       // 1152
			_id: 'Push_enable',                                                                                                 // 1153
			value: true                                                                                                         // 1154
		}                                                                                                                    // 1152
	});                                                                                                                   // 1149
	this.add('Push_enable_gateway', true, {                                                                               // 1157
		type: 'boolean',                                                                                                     // 1158
		enableQuery: {                                                                                                       // 1159
			_id: 'Push_enable',                                                                                                 // 1160
			value: true                                                                                                         // 1161
		}                                                                                                                    // 1159
	});                                                                                                                   // 1157
	this.add('Push_gateway', 'https://gateway.rocket.chat', {                                                             // 1164
		type: 'string',                                                                                                      // 1165
		enableQuery: [{                                                                                                      // 1166
			_id: 'Push_enable',                                                                                                 // 1168
			value: true                                                                                                         // 1169
		}, {                                                                                                                 // 1167
			_id: 'Push_enable_gateway',                                                                                         // 1171
			value: true                                                                                                         // 1172
		}]                                                                                                                   // 1170
	});                                                                                                                   // 1164
	this.add('Push_production', true, {                                                                                   // 1176
		type: 'boolean',                                                                                                     // 1177
		'public': true,                                                                                                      // 1178
		enableQuery: [{                                                                                                      // 1179
			_id: 'Push_enable',                                                                                                 // 1181
			value: true                                                                                                         // 1182
		}, {                                                                                                                 // 1180
			_id: 'Push_enable_gateway',                                                                                         // 1184
			value: false                                                                                                        // 1185
		}]                                                                                                                   // 1183
	});                                                                                                                   // 1176
	this.add('Push_test_push', 'push_test', {                                                                             // 1189
		type: 'action',                                                                                                      // 1190
		actionText: 'Send_a_test_push_to_my_user',                                                                           // 1191
		enableQuery: {                                                                                                       // 1192
			_id: 'Push_enable',                                                                                                 // 1193
			value: true                                                                                                         // 1194
		}                                                                                                                    // 1192
	});                                                                                                                   // 1189
	this.section('Certificates_and_Keys', function () {                                                                   // 1197
		this.add('Push_apn_passphrase', '', {                                                                                // 1198
			type: 'string'                                                                                                      // 1199
		});                                                                                                                  // 1198
		this.add('Push_apn_key', '', {                                                                                       // 1201
			type: 'string',                                                                                                     // 1202
			multiline: true                                                                                                     // 1203
		});                                                                                                                  // 1201
		this.add('Push_apn_cert', '', {                                                                                      // 1205
			type: 'string',                                                                                                     // 1206
			multiline: true                                                                                                     // 1207
		});                                                                                                                  // 1205
		this.add('Push_apn_dev_passphrase', '', {                                                                            // 1209
			type: 'string'                                                                                                      // 1210
		});                                                                                                                  // 1209
		this.add('Push_apn_dev_key', '', {                                                                                   // 1212
			type: 'string',                                                                                                     // 1213
			multiline: true                                                                                                     // 1214
		});                                                                                                                  // 1212
		this.add('Push_apn_dev_cert', '', {                                                                                  // 1216
			type: 'string',                                                                                                     // 1217
			multiline: true                                                                                                     // 1218
		});                                                                                                                  // 1216
		this.add('Push_gcm_api_key', '', {                                                                                   // 1220
			type: 'string'                                                                                                      // 1221
		});                                                                                                                  // 1220
		return this.add('Push_gcm_project_number', '', {                                                                     // 1223
			type: 'string',                                                                                                     // 1224
			'public': true                                                                                                      // 1225
		});                                                                                                                  // 1223
	});                                                                                                                   // 1227
	return this.section('Privacy', function () {                                                                          // 1228
		this.add('Push_show_username_room', true, {                                                                          // 1229
			type: 'boolean',                                                                                                    // 1230
			'public': true                                                                                                      // 1231
		});                                                                                                                  // 1229
		return this.add('Push_show_message', true, {                                                                         // 1233
			type: 'boolean',                                                                                                    // 1234
			'public': true                                                                                                      // 1235
		});                                                                                                                  // 1233
	});                                                                                                                   // 1237
});                                                                                                                    // 1238
RocketChat.settings.addGroup('Layout', function () {                                                                   // 1240
	this.section('Content', function () {                                                                                 // 1241
		this.add('Layout_Home_Title', 'Home', {                                                                              // 1242
			type: 'string',                                                                                                     // 1243
			'public': true                                                                                                      // 1244
		});                                                                                                                  // 1242
		this.add('Layout_Home_Body', 'Welcome to Chat <br> Go to APP SETTINGS -> Layout to customize this intro.', {         // 1246
			type: 'code',                                                                                                       // 1247
			code: 'text/html',                                                                                                  // 1248
			multiline: true,                                                                                                    // 1249
			'public': true                                                                                                      // 1250
		});                                                                                                                  // 1246
		this.add('Layout_Terms_of_Service', 'Terms of Service <br> Go to APP SETTINGS -> Layout to customize this page.', {  // 1252
			type: 'code',                                                                                                       // 1253
			code: 'text/html',                                                                                                  // 1254
			multiline: true,                                                                                                    // 1255
			'public': true                                                                                                      // 1256
		});                                                                                                                  // 1252
		this.add('Layout_Login_Terms', '', {                                                                                 // 1258
			type: 'string',                                                                                                     // 1259
			multiline: true,                                                                                                    // 1260
			'public': true                                                                                                      // 1261
		});                                                                                                                  // 1258
		this.add('Layout_Privacy_Policy', 'Privacy Policy <br> Go to APP SETTINGS -> Layout to customize this page.', {      // 1263
			type: 'code',                                                                                                       // 1264
			code: 'text/html',                                                                                                  // 1265
			multiline: true,                                                                                                    // 1266
			'public': true                                                                                                      // 1267
		});                                                                                                                  // 1263
		return this.add('Layout_Sidenav_Footer', '', {                                                                       // 1269
			type: 'code',                                                                                                       // 1270
			code: 'text/html',                                                                                                  // 1271
			'public': true,                                                                                                     // 1272
			i18nDescription: 'Layout_Sidenav_Footer_description'                                                                // 1273
		});                                                                                                                  // 1269
	});                                                                                                                   // 1275
	this.section('Custom_Scripts', function () {                                                                          // 1276
		this.add('Custom_Script_Logged_Out', '//Add your script', {                                                          // 1277
			type: 'code',                                                                                                       // 1278
			multiline: true,                                                                                                    // 1279
			'public': true                                                                                                      // 1280
		});                                                                                                                  // 1277
		return this.add('Custom_Script_Logged_In', '//Add your script', {                                                    // 1282
			type: 'code',                                                                                                       // 1283
			multiline: true,                                                                                                    // 1284
			'public': true                                                                                                      // 1285
		});                                                                                                                  // 1282
	});                                                                                                                   // 1287
	return this.section('User_Interface', function () {                                                                   // 1288
		this.add('UI_DisplayRoles', true, {                                                                                  // 1289
			type: 'boolean',                                                                                                    // 1290
			'public': true                                                                                                      // 1291
		});                                                                                                                  // 1289
		this.add('UI_Merge_Channels_Groups', true, {                                                                         // 1293
			type: 'boolean',                                                                                                    // 1294
			'public': true                                                                                                      // 1295
		});                                                                                                                  // 1293
		this.add('UI_Use_Name_Avatar', false, {                                                                              // 1297
			type: 'boolean',                                                                                                    // 1298
			'public': true                                                                                                      // 1299
		});                                                                                                                  // 1297
		this.add('UI_Use_Real_Name', false, {                                                                                // 1301
			type: 'boolean',                                                                                                    // 1302
			'public': true                                                                                                      // 1303
		});                                                                                                                  // 1301
		this.add('UI_Click_Direct_Message', false, {                                                                         // 1305
			type: 'boolean',                                                                                                    // 1306
			'public': true                                                                                                      // 1307
		});                                                                                                                  // 1305
		this.add('UI_Unread_Counter_Style', 'Different_Style_For_User_Mentions', {                                           // 1309
			type: 'select',                                                                                                     // 1310
			values: [{                                                                                                          // 1311
				key: 'Same_Style_For_Mentions',                                                                                    // 1313
				i18nLabel: 'Same_Style_For_Mentions'                                                                               // 1314
			}, {                                                                                                                // 1312
				key: 'Different_Style_For_User_Mentions',                                                                          // 1316
				i18nLabel: 'Different_Style_For_User_Mentions'                                                                     // 1317
			}],                                                                                                                 // 1315
			'public': true                                                                                                      // 1320
		});                                                                                                                  // 1309
		this.add('UI_Allow_room_names_with_special_chars', false, {                                                          // 1322
			type: 'boolean',                                                                                                    // 1323
			"public": true                                                                                                      // 1324
		});                                                                                                                  // 1322
	});                                                                                                                   // 1326
});                                                                                                                    // 1327
RocketChat.settings.addGroup('Logs', function () {                                                                     // 1329
	this.add('Log_Level', '0', {                                                                                          // 1330
		type: 'select',                                                                                                      // 1331
		values: [{                                                                                                           // 1332
			key: '0',                                                                                                           // 1334
			i18nLabel: '0_Errors_Only'                                                                                          // 1335
		}, {                                                                                                                 // 1333
			key: '1',                                                                                                           // 1337
			i18nLabel: '1_Errors_and_Information'                                                                               // 1338
		}, {                                                                                                                 // 1336
			key: '2',                                                                                                           // 1340
			i18nLabel: '2_Erros_Information_and_Debug'                                                                          // 1341
		}],                                                                                                                  // 1339
		'public': true                                                                                                       // 1344
	});                                                                                                                   // 1330
	this.add('Log_Package', false, {                                                                                      // 1346
		type: 'boolean',                                                                                                     // 1347
		'public': true                                                                                                       // 1348
	});                                                                                                                   // 1346
	this.add('Log_File', false, {                                                                                         // 1350
		type: 'boolean',                                                                                                     // 1351
		'public': true                                                                                                       // 1352
	});                                                                                                                   // 1350
	return this.add('Log_View_Limit', 1000, {                                                                             // 1354
		type: 'int'                                                                                                          // 1355
	});                                                                                                                   // 1354
});                                                                                                                    // 1357
RocketChat.settings.init();                                                                                            // 1359
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"publications":{"settings.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/publications/settings.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	'public-settings/get': function (updatedAt) {                                                                         // 2
		this.unblock();                                                                                                      // 3
		var records = RocketChat.models.Settings.find().fetch().filter(function (record) {                                   // 4
			return record.hidden !== true && record['public'] === true;                                                         // 5
		});                                                                                                                  // 6
                                                                                                                       //
		if (updatedAt instanceof Date) {                                                                                     // 7
			return {                                                                                                            // 8
				update: records.filter(function (record) {                                                                         // 9
					return record._updatedAt > updatedAt;                                                                             // 10
				}),                                                                                                                // 11
				remove: RocketChat.models.Settings.trashFindDeletedAfter(updatedAt, {                                              // 12
					hidden: {                                                                                                         // 13
						$ne: true                                                                                                        // 14
					},                                                                                                                // 13
					'public': true                                                                                                    // 16
				}, {                                                                                                               // 12
					fields: {                                                                                                         // 18
						_id: 1,                                                                                                          // 19
						_deletedAt: 1                                                                                                    // 20
					}                                                                                                                 // 18
				}).fetch()                                                                                                         // 17
			};                                                                                                                  // 8
		}                                                                                                                    // 24
                                                                                                                       //
		return records;                                                                                                      // 25
	},                                                                                                                    // 26
	'private-settings/get': function (updatedAt) {                                                                        // 27
		if (!Meteor.userId()) {                                                                                              // 28
			return [];                                                                                                          // 29
		}                                                                                                                    // 30
                                                                                                                       //
		this.unblock();                                                                                                      // 31
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'view-privileged-setting')) {                                   // 32
			return [];                                                                                                          // 33
		}                                                                                                                    // 34
                                                                                                                       //
		var records = RocketChat.models.Settings.find().fetch().filter(function (record) {                                   // 35
			return record.hidden !== true;                                                                                      // 36
		});                                                                                                                  // 37
                                                                                                                       //
		if (updatedAt instanceof Date) {                                                                                     // 38
			return {                                                                                                            // 39
				update: records.filter(function (record) {                                                                         // 40
					return record._updatedAt > updatedAt;                                                                             // 41
				}),                                                                                                                // 42
				remove: RocketChat.models.Settings.trashFindDeletedAfter(updatedAt, {                                              // 43
					hidden: {                                                                                                         // 44
						$ne: true                                                                                                        // 45
					}                                                                                                                 // 44
				}, {                                                                                                               // 43
					fields: {                                                                                                         // 48
						_id: 1,                                                                                                          // 49
						_deletedAt: 1                                                                                                    // 50
					}                                                                                                                 // 48
				}).fetch()                                                                                                         // 47
			};                                                                                                                  // 39
		}                                                                                                                    // 54
                                                                                                                       //
		return records;                                                                                                      // 55
	}                                                                                                                     // 56
});                                                                                                                    // 1
RocketChat.models.Settings.cache.on('changed', function (type, setting) {                                              // 59
	if (setting['public'] === true) {                                                                                     // 60
		RocketChat.Notifications.notifyAllInThisInstance('public-settings-changed', type, _.pick(setting, '_id', 'value', 'editor', 'properties'));
	}                                                                                                                     // 62
                                                                                                                       //
	return RocketChat.Notifications.notifyLoggedInThisInstance('private-settings-changed', type, setting);                // 63
});                                                                                                                    // 64
RocketChat.Notifications.streamAll.allowRead('private-settings-changed', function () {                                 // 66
	if (this.userId == null) {                                                                                            // 67
		return false;                                                                                                        // 68
	}                                                                                                                     // 69
                                                                                                                       //
	return RocketChat.authz.hasPermission(this.userId, 'view-privileged-setting');                                        // 70
});                                                                                                                    // 71
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"methods":{"addOAuthService.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/addOAuthService.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* eslint no-multi-spaces: 0 */ /* eslint comma-spacing: 0 */Meteor.methods({                                          // 1
	addOAuthService: function (name) {                                                                                    // 5
		check(name, String);                                                                                                 // 7
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 9
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 10
				method: 'addOAuthService'                                                                                          // 10
			});                                                                                                                 // 10
		}                                                                                                                    // 11
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'add-oauth-service') !== true) {                                 // 13
			throw new Meteor.Error('error-action-not-allowed', 'Adding OAuth Services is not allowed', {                        // 14
				method: 'addOAuthService',                                                                                         // 14
				action: 'Adding_OAuth_Services'                                                                                    // 14
			});                                                                                                                 // 14
		}                                                                                                                    // 15
                                                                                                                       //
		name = name.toLowerCase().replace(/[^a-z0-9_]/g, '');                                                                // 17
		name = s.capitalize(name);                                                                                           // 18
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name, false, {                                                    // 19
			type: 'boolean',                                                                                                    // 19
			group: 'OAuth',                                                                                                     // 19
			section: "Custom OAuth: " + name,                                                                                   // 19
			i18nLabel: 'Accounts_OAuth_Custom_Enable',                                                                          // 19
			persistent: true                                                                                                    // 19
		});                                                                                                                  // 19
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-url", '', {                                              // 20
			type: 'string',                                                                                                     // 20
			group: 'OAuth',                                                                                                     // 20
			section: "Custom OAuth: " + name,                                                                                   // 20
			i18nLabel: 'URL',                                                                                                   // 20
			persistent: true                                                                                                    // 20
		});                                                                                                                  // 20
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-token_path", '/oauth/token', {                           // 21
			type: 'string',                                                                                                     // 21
			group: 'OAuth',                                                                                                     // 21
			section: "Custom OAuth: " + name,                                                                                   // 21
			i18nLabel: 'Accounts_OAuth_Custom_Token_Path',                                                                      // 21
			persistent: true                                                                                                    // 21
		});                                                                                                                  // 21
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-identity_path", '/me', {                                 // 22
			type: 'string',                                                                                                     // 22
			group: 'OAuth',                                                                                                     // 22
			section: "Custom OAuth: " + name,                                                                                   // 22
			i18nLabel: 'Accounts_OAuth_Custom_Identity_Path',                                                                   // 22
			persistent: true                                                                                                    // 22
		});                                                                                                                  // 22
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-authorize_path", '/oauth/authorize', {                   // 23
			type: 'string',                                                                                                     // 23
			group: 'OAuth',                                                                                                     // 23
			section: "Custom OAuth: " + name,                                                                                   // 23
			i18nLabel: 'Accounts_OAuth_Custom_Authorize_Path',                                                                  // 23
			persistent: true                                                                                                    // 23
		});                                                                                                                  // 23
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-scope", 'openid', {                                      // 24
			type: 'string',                                                                                                     // 24
			group: 'OAuth',                                                                                                     // 24
			section: "Custom OAuth: " + name,                                                                                   // 24
			i18nLabel: 'Accounts_OAuth_Custom_Scope',                                                                           // 24
			persistent: true                                                                                                    // 24
		});                                                                                                                  // 24
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-token_sent_via", 'payload', {                            // 25
			type: 'select',                                                                                                     // 25
			group: 'OAuth',                                                                                                     // 25
			section: "Custom OAuth: " + name,                                                                                   // 25
			i18nLabel: 'Accounts_OAuth_Custom_Token_Sent_Via',                                                                  // 25
			persistent: true,                                                                                                   // 25
			values: [{                                                                                                          // 25
				key: 'header',                                                                                                     // 25
				i18nLabel: 'Header'                                                                                                // 25
			}, {                                                                                                                // 25
				key: 'payload',                                                                                                    // 25
				i18nLabel: 'Payload'                                                                                               // 25
			}]                                                                                                                  // 25
		});                                                                                                                  // 25
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-id", '', {                                               // 26
			type: 'string',                                                                                                     // 26
			group: 'OAuth',                                                                                                     // 26
			section: "Custom OAuth: " + name,                                                                                   // 26
			i18nLabel: 'Accounts_OAuth_Custom_id',                                                                              // 26
			persistent: true                                                                                                    // 26
		});                                                                                                                  // 26
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-secret", '', {                                           // 27
			type: 'string',                                                                                                     // 27
			group: 'OAuth',                                                                                                     // 27
			section: "Custom OAuth: " + name,                                                                                   // 27
			i18nLabel: 'Accounts_OAuth_Custom_Secret',                                                                          // 27
			persistent: true                                                                                                    // 27
		});                                                                                                                  // 27
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-login_style", 'popup', {                                 // 28
			type: 'select',                                                                                                     // 28
			group: 'OAuth',                                                                                                     // 28
			section: "Custom OAuth: " + name,                                                                                   // 28
			i18nLabel: 'Accounts_OAuth_Custom_Login_Style',                                                                     // 28
			persistent: true,                                                                                                   // 28
			values: [{                                                                                                          // 28
				key: 'redirect',                                                                                                   // 28
				i18nLabel: 'Redirect'                                                                                              // 28
			}, {                                                                                                                // 28
				key: 'popup',                                                                                                      // 28
				i18nLabel: 'Popup'                                                                                                 // 28
			}, {                                                                                                                // 28
				key: '',                                                                                                           // 28
				i18nLabel: 'Default'                                                                                               // 28
			}]                                                                                                                  // 28
		});                                                                                                                  // 28
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-button_label_text", '', {                                // 29
			type: 'string',                                                                                                     // 29
			group: 'OAuth',                                                                                                     // 29
			section: "Custom OAuth: " + name,                                                                                   // 29
			i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Text',                                                               // 29
			persistent: true                                                                                                    // 29
		});                                                                                                                  // 29
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-button_label_color", '#FFFFFF', {                        // 30
			type: 'string',                                                                                                     // 30
			group: 'OAuth',                                                                                                     // 30
			section: "Custom OAuth: " + name,                                                                                   // 30
			i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Color',                                                              // 30
			persistent: true                                                                                                    // 30
		});                                                                                                                  // 30
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-button_color", '#13679A', {                              // 31
			type: 'string',                                                                                                     // 31
			group: 'OAuth',                                                                                                     // 31
			section: "Custom OAuth: " + name,                                                                                   // 31
			i18nLabel: 'Accounts_OAuth_Custom_Button_Color',                                                                    // 31
			persistent: true                                                                                                    // 31
		});                                                                                                                  // 31
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-username_field", '', {                                   // 32
			type: 'string',                                                                                                     // 32
			group: 'OAuth',                                                                                                     // 32
			section: "Custom OAuth: " + name,                                                                                   // 32
			i18nLabel: 'Accounts_OAuth_Custom_Username_Field',                                                                  // 32
			persistent: true                                                                                                    // 32
		});                                                                                                                  // 32
		RocketChat.settings.add("Accounts_OAuth_Custom-" + name + "-merge_users", false, {                                   // 33
			type: 'boolean',                                                                                                    // 33
			group: 'OAuth',                                                                                                     // 33
			section: "Custom OAuth: " + name,                                                                                   // 33
			i18nLabel: 'Accounts_OAuth_Custom_Merge_Users',                                                                     // 33
			persistent: true                                                                                                    // 33
		});                                                                                                                  // 33
	}                                                                                                                     // 34
});                                                                                                                    // 4
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"refreshOAuthService.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/refreshOAuthService.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	refreshOAuthService: function () {                                                                                    // 2
		if (!Meteor.userId()) {                                                                                              // 3
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 4
				method: 'refreshOAuthService'                                                                                      // 4
			});                                                                                                                 // 4
		}                                                                                                                    // 5
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'add-oauth-service') !== true) {                                 // 7
			throw new Meteor.Error('error-action-not-allowed', 'Refresh OAuth Services is not allowed', {                       // 8
				method: 'refreshOAuthService',                                                                                     // 8
				action: 'Refreshing_OAuth_Services'                                                                                // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		ServiceConfiguration.configurations.remove({});                                                                      // 11
		RocketChat.models.Settings.update({                                                                                  // 13
			_id: /^Accounts_OAuth_.+/                                                                                           // 13
		}, {                                                                                                                 // 13
			$set: {                                                                                                             // 13
				_updatedAt: new Date()                                                                                             // 13
			}                                                                                                                   // 13
		}, {                                                                                                                 // 13
			multi: true                                                                                                         // 13
		});                                                                                                                  // 13
	}                                                                                                                     // 14
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"addUserToRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/addUserToRoom.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	addUserToRoom: function (data) {                                                                                      // 2
		return Meteor.call('addUsersToRoom', {                                                                               // 3
			rid: data.rid,                                                                                                      // 4
			users: [data.username]                                                                                              // 5
		});                                                                                                                  // 3
	}                                                                                                                     // 7
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"addUsersToRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/addUsersToRoom.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	addUsersToRoom: function () {                                                                                         // 2
		var data = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};                                   // 2
                                                                                                                       //
		// Validate user and room                                                                                            // 3
		if (!Meteor.userId()) {                                                                                              // 4
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 5
				method: 'addUsersToRoom'                                                                                           // 6
			});                                                                                                                 // 5
		}                                                                                                                    // 8
                                                                                                                       //
		if (!Match.test(data.rid, String)) {                                                                                 // 10
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 11
				method: 'addUsersToRoom'                                                                                           // 12
			});                                                                                                                 // 11
		} // Get user and room details                                                                                       // 14
                                                                                                                       //
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(data.rid);                                                            // 17
		var userId = Meteor.userId();                                                                                        // 18
		var user = Meteor.user();                                                                                            // 19
		var userInRoom = Array.isArray(room.usernames) && room.usernames.includes(user.username); // Can't add to direct room ever
                                                                                                                       //
		if (room.t === 'd') {                                                                                                // 23
			throw new Meteor.Error('error-cant-invite-for-direct-room', 'Can\'t invite user to direct rooms', {                 // 24
				method: 'addUsersToRoom'                                                                                           // 25
			});                                                                                                                 // 24
		} // Can add to any room you're in, with permission, otherwise need specific room type permission                    // 27
                                                                                                                       //
                                                                                                                       //
		var canAddUser = false;                                                                                              // 30
                                                                                                                       //
		if (userInRoom && RocketChat.authz.hasPermission(userId, 'add-user-to-joined-room', room._id)) {                     // 31
			canAddUser = true;                                                                                                  // 32
		} else if (room.t === 'c' && RocketChat.authz.hasPermission(userId, 'add-user-to-any-c-room')) {                     // 33
			canAddUser = true;                                                                                                  // 34
		} else if (room.t === 'p' && RocketChat.authz.hasPermission(userId, 'add-user-to-any-p-room')) {                     // 35
			canAddUser = true;                                                                                                  // 36
		} // Adding wasn't allowed                                                                                           // 37
                                                                                                                       //
                                                                                                                       //
		if (!canAddUser) {                                                                                                   // 40
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 41
				method: 'addUsersToRoom'                                                                                           // 42
			});                                                                                                                 // 41
		} // Missing the users to be added                                                                                   // 44
                                                                                                                       //
                                                                                                                       //
		if (!Array.isArray(data.users)) {                                                                                    // 47
			throw new Meteor.Error('error-invalid-arguments', 'Invalid arguments', {                                            // 48
				method: 'addUsersToRoom'                                                                                           // 49
			});                                                                                                                 // 48
		} // Validate each user, then add to room                                                                            // 51
                                                                                                                       //
                                                                                                                       //
		data.users.forEach(function (username) {                                                                             // 54
			var newUser = RocketChat.models.Users.findOneByUsername(username);                                                  // 55
                                                                                                                       //
			if (!newUser) {                                                                                                     // 56
				throw new Meteor.Error('error-invalid-username', 'Invalid username', {                                             // 57
					method: 'addUsersToRoom'                                                                                          // 58
				});                                                                                                                // 57
			}                                                                                                                   // 60
                                                                                                                       //
			RocketChat.addUserToRoom(data.rid, newUser, user);                                                                  // 62
		});                                                                                                                  // 63
		return true;                                                                                                         // 65
	}                                                                                                                     // 66
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"archiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/archiveRoom.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	archiveRoom: function (rid) {                                                                                         // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'archiveRoom'                                                                                              // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 12
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 13
				method: 'archiveRoom'                                                                                              // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'archive-room', room._id)) {                                    // 16
			throw new Meteor.Error('error-not-authorized', 'Not authorized', {                                                  // 17
				method: 'archiveRoom'                                                                                              // 17
			});                                                                                                                 // 17
		}                                                                                                                    // 18
                                                                                                                       //
		if (room.t === 'd') {                                                                                                // 20
			throw new Meteor.Error('error-direct-message-room', 'Direct Messages can not be archived', {                        // 21
				method: 'archiveRoom'                                                                                              // 21
			});                                                                                                                 // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return RocketChat.archiveRoom(rid);                                                                                  // 24
	}                                                                                                                     // 25
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"blockUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/blockUser.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	blockUser: function (_ref) {                                                                                          // 2
		var rid = _ref.rid,                                                                                                  // 2
		    blocked = _ref.blocked;                                                                                          // 2
		check(rid, String);                                                                                                  // 4
		check(blocked, String);                                                                                              // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 7
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 8
				method: 'blockUser'                                                                                                // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());                   // 11
		var subscription2 = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, blocked);                          // 12
                                                                                                                       //
		if (!subscription || !subscription2) {                                                                               // 14
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 15
				method: 'blockUser'                                                                                                // 15
			});                                                                                                                 // 15
		}                                                                                                                    // 16
                                                                                                                       //
		RocketChat.models.Subscriptions.setBlockedByRoomId(rid, blocked, Meteor.userId());                                   // 18
		return true;                                                                                                         // 20
	}                                                                                                                     // 21
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"checkRegistrationSecretURL.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/checkRegistrationSecretURL.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	checkRegistrationSecretURL: function (hash) {                                                                         // 2
		check(hash, String);                                                                                                 // 4
		return hash === RocketChat.settings.get('Accounts_RegistrationForm_SecretURL');                                      // 6
	}                                                                                                                     // 7
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"checkUsernameAvailability.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/checkUsernameAvailability.js                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	checkUsernameAvailability: function (username) {                                                                      // 2
		check(username, String);                                                                                             // 3
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'setUsername'                                                                                              // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		var user = Meteor.user();                                                                                            // 9
                                                                                                                       //
		if (user.username && !RocketChat.settings.get('Accounts_AllowUsernameChange')) {                                     // 11
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 12
				method: 'setUsername'                                                                                              // 12
			});                                                                                                                 // 12
		}                                                                                                                    // 13
                                                                                                                       //
		if (user.username === username) {                                                                                    // 15
			return true;                                                                                                        // 16
		}                                                                                                                    // 17
                                                                                                                       //
		return RocketChat.checkUsernameAvailability(username);                                                               // 18
	}                                                                                                                     // 19
});                                                                                                                    // 1
RocketChat.RateLimiter.limitMethod('checkUsernameAvailability', 1, 1000, {                                             // 22
	userId: function () {                                                                                                 // 23
		return true;                                                                                                         // 23
	}                                                                                                                     // 23
});                                                                                                                    // 22
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"cleanChannelHistory.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/cleanChannelHistory.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	cleanChannelHistory: function (_ref) {                                                                                // 2
		var roomId = _ref.roomId,                                                                                            // 2
		    latest = _ref.latest,                                                                                            // 2
		    oldest = _ref.oldest,                                                                                            // 2
		    inclusive = _ref.inclusive;                                                                                      // 2
		check(roomId, String);                                                                                               // 3
		check(latest, Date);                                                                                                 // 4
		check(oldest, Date);                                                                                                 // 5
		check(inclusive, Boolean);                                                                                           // 6
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 8
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 9
				method: 'cleanChannelHistory'                                                                                      // 9
			});                                                                                                                 // 9
		}                                                                                                                    // 10
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'clean-channel-history')) {                                     // 12
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 13
				method: 'cleanChannelHistory'                                                                                      // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (inclusive) {                                                                                                     // 16
			RocketChat.models.Messages.remove({                                                                                 // 17
				rid: roomId,                                                                                                       // 18
				ts: {                                                                                                              // 19
					$gte: oldest,                                                                                                     // 20
					$lte: latest                                                                                                      // 21
				}                                                                                                                  // 19
			});                                                                                                                 // 17
		} else {                                                                                                             // 24
			RocketChat.models.Messages.remove({                                                                                 // 25
				rid: roomId,                                                                                                       // 26
				ts: {                                                                                                              // 27
					$gt: oldest,                                                                                                      // 28
					$lt: latest                                                                                                       // 29
				}                                                                                                                  // 27
			});                                                                                                                 // 25
		}                                                                                                                    // 32
	}                                                                                                                     // 33
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"createChannel.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/createChannel.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	createChannel: function (name, members) {                                                                             // 2
		var readOnly = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;                            // 2
		var customFields = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};                           // 2
		check(name, String);                                                                                                 // 3
		check(members, Match.Optional([String]));                                                                            // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'createChannel'                                                                                            // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'create-c')) {                                                  // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'createChannel'                                                                                            // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		return RocketChat.createRoom('c', name, Meteor.user() && Meteor.user().username, members, readOnly, {                // 14
			customFields: customFields                                                                                          // 14
		});                                                                                                                  // 14
	}                                                                                                                     // 15
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"createToken.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/createToken.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	createToken: function (userId) {                                                                                      // 2
		if (Meteor.userId() !== userId && !RocketChat.authz.hasPermission(Meteor.userId(), 'user-generate-access-token')) {  // 3
			throw new Meteor.Error('error-not-authorized', 'Not authorized', {                                                  // 4
				method: 'createToken'                                                                                              // 4
			});                                                                                                                 // 4
		}                                                                                                                    // 5
                                                                                                                       //
		var token = Accounts._generateStampedLoginToken();                                                                   // 6
                                                                                                                       //
		Accounts._insertLoginToken(userId, token);                                                                           // 7
                                                                                                                       //
		return {                                                                                                             // 8
			userId: userId,                                                                                                     // 9
			authToken: token.token                                                                                              // 10
		};                                                                                                                   // 8
	}                                                                                                                     // 12
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"createPrivateGroup.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/createPrivateGroup.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	createPrivateGroup: function (name, members) {                                                                        // 2
		var readOnly = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;                            // 2
		var customFields = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {};                           // 2
		check(name, String);                                                                                                 // 3
		check(members, Match.Optional([String]));                                                                            // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'createPrivateGroup'                                                                                       // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'create-p')) {                                                  // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'createPrivateGroup'                                                                                       // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		return RocketChat.createRoom('p', name, Meteor.user() && Meteor.user().username, members, readOnly, {                // 14
			customFields: customFields                                                                                          // 14
		});                                                                                                                  // 14
	}                                                                                                                     // 15
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"deleteMessage.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/deleteMessage.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.watch(require("moment"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
Meteor.methods({                                                                                                       // 3
	deleteMessage: function (message) {                                                                                   // 4
		check(message, Match.ObjectIncluding({                                                                               // 5
			_id: String                                                                                                         // 6
		}));                                                                                                                 // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 8
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 9
				method: 'deleteMessage'                                                                                            // 10
			});                                                                                                                 // 9
		}                                                                                                                    // 12
                                                                                                                       //
		var originalMessage = RocketChat.models.Messages.findOneById(message._id, {                                          // 13
			fields: {                                                                                                           // 14
				u: 1,                                                                                                              // 15
				rid: 1,                                                                                                            // 16
				file: 1,                                                                                                           // 17
				ts: 1                                                                                                              // 18
			}                                                                                                                   // 14
		});                                                                                                                  // 13
                                                                                                                       //
		if (originalMessage == null) {                                                                                       // 21
			throw new Meteor.Error('error-action-not-allowed', 'Not allowed', {                                                 // 22
				method: 'deleteMessage',                                                                                           // 23
				action: 'Delete_message'                                                                                           // 24
			});                                                                                                                 // 22
		}                                                                                                                    // 26
                                                                                                                       //
		var forceDelete = RocketChat.authz.hasPermission(Meteor.userId(), 'force-delete-message', originalMessage.rid);      // 27
		var hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'delete-message', originalMessage.rid);          // 28
		var deleteAllowed = RocketChat.settings.get('Message_AllowDeleting');                                                // 29
		var deleteOwn = originalMessage && originalMessage.u && originalMessage.u._id === Meteor.userId();                   // 30
                                                                                                                       //
		if (!(hasPermission || deleteAllowed && deleteOwn) && !forceDelete) {                                                // 31
			throw new Meteor.Error('error-action-not-allowed', 'Not allowed', {                                                 // 32
				method: 'deleteMessage',                                                                                           // 33
				action: 'Delete_message'                                                                                           // 34
			});                                                                                                                 // 32
		}                                                                                                                    // 36
                                                                                                                       //
		var blockDeleteInMinutes = RocketChat.settings.get('Message_AllowDeleting_BlockDeleteInMinutes');                    // 37
                                                                                                                       //
		if (blockDeleteInMinutes != null && blockDeleteInMinutes !== 0 && !forceDelete) {                                    // 38
			if (originalMessage.ts == null) {                                                                                   // 39
				return;                                                                                                            // 40
			}                                                                                                                   // 41
                                                                                                                       //
			var msgTs = moment(originalMessage.ts);                                                                             // 42
                                                                                                                       //
			if (msgTs == null) {                                                                                                // 43
				return;                                                                                                            // 44
			}                                                                                                                   // 45
                                                                                                                       //
			var currentTsDiff = moment().diff(msgTs, 'minutes');                                                                // 46
                                                                                                                       //
			if (currentTsDiff > blockDeleteInMinutes) {                                                                         // 47
				throw new Meteor.Error('error-message-deleting-blocked', 'Message deleting is blocked', {                          // 48
					method: 'deleteMessage'                                                                                           // 49
				});                                                                                                                // 48
			}                                                                                                                   // 51
		}                                                                                                                    // 52
                                                                                                                       //
		return RocketChat.deleteMessage(originalMessage, Meteor.user());                                                     // 53
	}                                                                                                                     // 54
});                                                                                                                    // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"deleteUserOwnAccount.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/deleteUserOwnAccount.js                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	deleteUserOwnAccount: function (password) {                                                                           // 2
		check(password, String);                                                                                             // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'deleteUserOwnAccount'                                                                                     // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (!RocketChat.settings.get('Accounts_AllowDeleteOwnAccount')) {                                                    // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'deleteUserOwnAccount'                                                                                     // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		var userId = Meteor.userId();                                                                                        // 14
		var user = RocketChat.models.Users.findOneById(userId);                                                              // 15
                                                                                                                       //
		if (!user) {                                                                                                         // 17
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 18
				method: 'deleteUserOwnAccount'                                                                                     // 18
			});                                                                                                                 // 18
		}                                                                                                                    // 19
                                                                                                                       //
		if (user.services && user.services.password && s.trim(user.services.password.bcrypt)) {                              // 21
			var result = Accounts._checkPassword(user, {                                                                        // 22
				digest: password,                                                                                                  // 22
				algorithm: 'sha-256'                                                                                               // 22
			});                                                                                                                 // 22
                                                                                                                       //
			if (result.error) {                                                                                                 // 23
				throw new Meteor.Error('error-invalid-password', 'Invalid password', {                                             // 24
					method: 'deleteUserOwnAccount'                                                                                    // 24
				});                                                                                                                // 24
			}                                                                                                                   // 25
		} else if (user.username !== s.trim(password)) {                                                                     // 26
			throw new Meteor.Error('error-invalid-username', 'Invalid username', {                                              // 27
				method: 'deleteUserOwnAccount'                                                                                     // 27
			});                                                                                                                 // 27
		}                                                                                                                    // 28
                                                                                                                       //
		Meteor.defer(function () {                                                                                           // 30
			RocketChat.deleteUser(userId);                                                                                      // 31
		});                                                                                                                  // 32
		return true;                                                                                                         // 34
	}                                                                                                                     // 35
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"filterBadWords.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/filterBadWords.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var Filter = Npm.require('bad-words');                                                                                 // 1
                                                                                                                       //
RocketChat.callbacks.add('beforeSaveMessage', function (message) {                                                     // 3
	if (RocketChat.settings.get('Message_AllowBadWordsFilter')) {                                                         // 5
		var badWordsList = RocketChat.settings.get('Message_BadWordsFilterList');                                            // 6
		var options = void 0; // Add words to the blacklist                                                                  // 7
                                                                                                                       //
		if (!!badWordsList && badWordsList.length) {                                                                         // 10
			options = {                                                                                                         // 11
				list: badWordsList.split(',')                                                                                      // 12
			};                                                                                                                  // 11
		}                                                                                                                    // 14
                                                                                                                       //
		var filter = new Filter(options);                                                                                    // 15
		message.msg = filter.clean(message.msg);                                                                             // 16
	}                                                                                                                     // 17
                                                                                                                       //
	return message;                                                                                                       // 19
}, 1, 'filterBadWords');                                                                                               // 21
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"filterATAllTag.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/filterATAllTag.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.callbacks.add('beforeSaveMessage', function (message) {                                                     // 1
	// Test if the message mentions include @all.                                                                         // 2
	if (message.mentions != null && _.pluck(message.mentions, '_id').some(function (item) {                               // 3
		return item === 'all';                                                                                               // 4
	})) {                                                                                                                 // 4
		// Check if the user has permissions to use @all.                                                                    // 6
		if (!RocketChat.authz.hasPermission(message.u._id, 'mention-all')) {                                                 // 7
			// Get the language of the user for the error notification.                                                         // 9
			var language = RocketChat.models.Users.findOneById(message.u._id).language;                                         // 10
                                                                                                                       //
			var action = TAPi18n.__('Notify_all_in_this_room', {}, language); // Add a notification to the chat, informing the user that this
			// action is not allowed.                                                                                           // 14
                                                                                                                       //
                                                                                                                       //
			RocketChat.Notifications.notifyUser(message.u._id, 'message', {                                                     // 15
				_id: Random.id(),                                                                                                  // 16
				rid: message.rid,                                                                                                  // 17
				ts: new Date(),                                                                                                    // 18
				msg: TAPi18n.__('error-action-not-allowed', {                                                                      // 19
					action: action                                                                                                    // 19
				}, language)                                                                                                       // 19
			}); // Also throw to stop propagation of 'sendMessage'.                                                             // 15
                                                                                                                       //
			throw new Meteor.Error('error-action-not-allowed', 'Notify all in this room not allowed', {                         // 23
				method: 'filterATAllTag',                                                                                          // 24
				action: 'Notify_all_in_this_room'                                                                                  // 25
			});                                                                                                                 // 23
		}                                                                                                                    // 27
	}                                                                                                                     // 28
                                                                                                                       //
	return message;                                                                                                       // 30
}, 1, 'filterATAllTag');                                                                                               // 32
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getChannelHistory.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getChannelHistory.js                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getChannelHistory: function (_ref) {                                                                                  // 2
		var rid = _ref.rid,                                                                                                  // 2
		    latest = _ref.latest,                                                                                            // 2
		    oldest = _ref.oldest,                                                                                            // 2
		    inclusive = _ref.inclusive,                                                                                      // 2
		    _ref$count = _ref.count,                                                                                         // 2
		    count = _ref$count === undefined ? 20 : _ref$count,                                                              // 2
		    unreads = _ref.unreads;                                                                                          // 2
		check(rid, String);                                                                                                  // 3
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'getChannelHistory'                                                                                        // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		var fromUserId = Meteor.userId();                                                                                    // 9
		var room = Meteor.call('canAccessRoom', rid, fromUserId);                                                            // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 11
			return false;                                                                                                       // 12
		} //Make sure they can access the room                                                                               // 13
                                                                                                                       //
                                                                                                                       //
		if (room.t === 'c' && !RocketChat.authz.hasPermission(fromUserId, 'preview-c-room') && room.usernames.indexOf(room.username) === -1) {
			return false;                                                                                                       // 17
		} //Ensure latest is always defined.                                                                                 // 18
                                                                                                                       //
                                                                                                                       //
		if (_.isUndefined(latest)) {                                                                                         // 21
			latest = new Date();                                                                                                // 22
		} //Verify oldest is a date if it exists                                                                             // 23
                                                                                                                       //
                                                                                                                       //
		if (!_.isUndefined(oldest) && !_.isDate(oldest)) {                                                                   // 26
			throw new Meteor.Error('error-invalid-date', 'Invalid date', {                                                      // 27
				method: 'getChannelHistory'                                                                                        // 27
			});                                                                                                                 // 27
		}                                                                                                                    // 28
                                                                                                                       //
		var options = {                                                                                                      // 30
			sort: {                                                                                                             // 31
				ts: -1                                                                                                             // 32
			},                                                                                                                  // 31
			limit: count                                                                                                        // 34
		};                                                                                                                   // 30
                                                                                                                       //
		if (!RocketChat.settings.get('Message_ShowEditedStatus')) {                                                          // 37
			options.fields = {                                                                                                  // 38
				'editedAt': 0                                                                                                      // 38
			};                                                                                                                  // 38
		}                                                                                                                    // 39
                                                                                                                       //
		var records = [];                                                                                                    // 41
                                                                                                                       //
		if (_.isUndefined(oldest) && inclusive) {                                                                            // 42
			records = RocketChat.models.Messages.findVisibleByRoomIdBeforeTimestampInclusive(rid, latest, options).fetch();     // 43
		} else if (_.isUndefined(oldest) && !inclusive) {                                                                    // 44
			records = RocketChat.models.Messages.findVisibleByRoomIdBeforeTimestamp(rid, latest, options).fetch();              // 45
		} else if (!_.isUndefined(oldest) && inclusive) {                                                                    // 46
			records = RocketChat.models.Messages.findVisibleByRoomIdBetweenTimestampsInclusive(rid, oldest, latest, options).fetch();
		} else {                                                                                                             // 48
			records = RocketChat.models.Messages.findVisibleByRoomIdBetweenTimestamps(rid, oldest, latest, options).fetch();    // 49
		}                                                                                                                    // 50
                                                                                                                       //
		var UI_Use_Real_Name = RocketChat.settings.get('UI_Use_Real_Name') === true;                                         // 52
                                                                                                                       //
		var messages = _.map(records, function (message) {                                                                   // 54
			message.starred = _.findWhere(message.starred, {                                                                    // 55
				_id: fromUserId                                                                                                    // 55
			});                                                                                                                 // 55
                                                                                                                       //
			if (message.u && message.u._id && UI_Use_Real_Name) {                                                               // 56
				var user = RocketChat.models.Users.findOneById(message.u._id);                                                     // 57
				message.u.name = user && user.name;                                                                                // 58
			}                                                                                                                   // 59
                                                                                                                       //
			if (message.mentions && message.mentions.length && UI_Use_Real_Name) {                                              // 60
				message.mentions.forEach(function (mention) {                                                                      // 61
					var user = RocketChat.models.Users.findOneById(mention._id);                                                      // 62
					mention.name = user && user.name;                                                                                 // 63
				});                                                                                                                // 64
			}                                                                                                                   // 65
                                                                                                                       //
			return message;                                                                                                     // 66
		});                                                                                                                  // 67
                                                                                                                       //
		if (unreads) {                                                                                                       // 69
			var unreadNotLoaded = 0;                                                                                            // 70
			var firstUnread = undefined;                                                                                        // 71
                                                                                                                       //
			if (!_.isUndefined(oldest)) {                                                                                       // 73
				var firstMsg = messages[messages.length - 1];                                                                      // 74
                                                                                                                       //
				if (!_.isUndefined(firstMsg) && firstMsg.ts > oldest) {                                                            // 75
					var unreadMessages = RocketChat.models.Messages.findVisibleByRoomIdBetweenTimestamps(rid, oldest, firstMsg.ts, {  // 76
						limit: 1,                                                                                                        // 76
						sort: {                                                                                                          // 76
							ts: 1                                                                                                           // 76
						}                                                                                                                // 76
					});                                                                                                               // 76
					firstUnread = unreadMessages.fetch()[0];                                                                          // 77
					unreadNotLoaded = unreadMessages.count();                                                                         // 78
				}                                                                                                                  // 79
			}                                                                                                                   // 80
                                                                                                                       //
			return {                                                                                                            // 82
				messages: messages || [],                                                                                          // 83
				firstUnread: firstUnread,                                                                                          // 84
				unreadNotLoaded: unreadNotLoaded                                                                                   // 85
			};                                                                                                                  // 82
		}                                                                                                                    // 87
                                                                                                                       //
		return {                                                                                                             // 89
			messages: messages || []                                                                                            // 90
		};                                                                                                                   // 89
	}                                                                                                                     // 92
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getFullUserData.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getFullUserData.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getFullUserData: function (_ref) {                                                                                    // 2
		var _ref$filter = _ref.filter,                                                                                       // 2
		    filter = _ref$filter === undefined ? '' : _ref$filter,                                                           // 2
		    limit = _ref.limit;                                                                                              // 2
		var result = RocketChat.getFullUserData({                                                                            // 3
			userId: Meteor.userId(),                                                                                            // 3
			filter: filter,                                                                                                     // 3
			limit: limit                                                                                                        // 3
		});                                                                                                                  // 3
                                                                                                                       //
		if (!result) {                                                                                                       // 5
			return result;                                                                                                      // 6
		}                                                                                                                    // 7
                                                                                                                       //
		return result.fetch();                                                                                               // 9
	}                                                                                                                     // 10
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getRoomJoinCode.js":function(require){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getRoomJoinCode.js                                                           //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var _slicedToArray2 = require("babel-runtime/helpers/slicedToArray");                                                  //
                                                                                                                       //
var _slicedToArray3 = _interopRequireDefault(_slicedToArray2);                                                         //
                                                                                                                       //
function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }                      //
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getRoomJoinCode: function (rid) {                                                                                     // 2
		check(rid, String);                                                                                                  // 3
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'getJoinCode'                                                                                              // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'view-join-code')) {                                            // 9
			throw new Meteor.Error('error-not-authorized', 'Not authorized', {                                                  // 10
				method: 'getJoinCode'                                                                                              // 10
			});                                                                                                                 // 10
		}                                                                                                                    // 11
                                                                                                                       //
		var _RocketChat$models$Ro = RocketChat.models.Rooms.findById(rid).fetch(),                                           // 2
		    _RocketChat$models$Ro2 = (0, _slicedToArray3.default)(_RocketChat$models$Ro, 1),                                 // 2
		    room = _RocketChat$models$Ro2[0];                                                                                // 2
                                                                                                                       //
		return room && room.joinCode;                                                                                        // 15
	}                                                                                                                     // 16
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getRoomRoles.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getRoomRoles.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getRoomRoles: function (rid) {                                                                                        // 2
		check(rid, String);                                                                                                  // 3
                                                                                                                       //
		if (!Meteor.userId() && RocketChat.settings.get('Accounts_AllowAnonymousRead') === false) {                          // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'getRoomRoles'                                                                                             // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		check(rid, String);                                                                                                  // 9
		var options = {                                                                                                      // 11
			sort: {                                                                                                             // 12
				'u.username': 1                                                                                                    // 13
			},                                                                                                                  // 12
			fields: {                                                                                                           // 15
				rid: 1,                                                                                                            // 16
				u: 1,                                                                                                              // 17
				roles: 1                                                                                                           // 18
			}                                                                                                                   // 15
		};                                                                                                                   // 11
		var UI_Use_Real_Name = RocketChat.settings.get('UI_Use_Real_Name') === true;                                         // 22
		var roles = RocketChat.models.Roles.find({                                                                           // 24
			scope: 'Subscriptions',                                                                                             // 24
			description: {                                                                                                      // 24
				$exists: 1,                                                                                                        // 24
				$ne: ''                                                                                                            // 24
			}                                                                                                                   // 24
		}).fetch();                                                                                                          // 24
		var subscriptions = RocketChat.models.Subscriptions.findByRoomIdAndRoles(rid, _.pluck(roles, '_id'), options).fetch();
                                                                                                                       //
		if (!UI_Use_Real_Name) {                                                                                             // 27
			return subscriptions;                                                                                               // 28
		} else {                                                                                                             // 29
			return subscriptions.map(function (subscription) {                                                                  // 30
				var user = RocketChat.models.Users.findOneById(subscription.u._id);                                                // 31
				subscription.u.name = user && user.name;                                                                           // 32
				return subscription;                                                                                               // 33
			});                                                                                                                 // 34
		}                                                                                                                    // 35
	}                                                                                                                     // 36
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getServerInfo.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getServerInfo.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getServerInfo: function () {                                                                                          // 2
		return RocketChat.Info;                                                                                              // 3
	}                                                                                                                     // 4
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getSingleMessage.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getSingleMessage.js                                                          //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getSingleMessage: function (msgId) {                                                                                  // 2
		check(msgId, String);                                                                                                // 3
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'getSingleMessage'                                                                                         // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		var msg = RocketChat.models.Messages.findOneById(msgId);                                                             // 9
                                                                                                                       //
		if (!msg && !msg.rid) {                                                                                              // 11
			return undefined;                                                                                                   // 12
		}                                                                                                                    // 13
                                                                                                                       //
		Meteor.call('canAccessRoom', msg.rid, Meteor.userId());                                                              // 15
		return msg;                                                                                                          // 17
	}                                                                                                                     // 18
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"getUserRoles.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/getUserRoles.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	getUserRoles: function () {                                                                                           // 2
		if (!Meteor.userId()) {                                                                                              // 4
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 5
				method: 'getUserRoles'                                                                                             // 5
			});                                                                                                                 // 5
		}                                                                                                                    // 6
                                                                                                                       //
		var options = {                                                                                                      // 8
			sort: {                                                                                                             // 9
				'username': 1                                                                                                      // 10
			},                                                                                                                  // 9
			fields: {                                                                                                           // 12
				username: 1,                                                                                                       // 13
				roles: 1                                                                                                           // 14
			}                                                                                                                   // 12
		};                                                                                                                   // 8
		var roles = RocketChat.models.Roles.find({                                                                           // 18
			scope: 'Users',                                                                                                     // 18
			description: {                                                                                                      // 18
				$exists: 1,                                                                                                        // 18
				$ne: ''                                                                                                            // 18
			}                                                                                                                   // 18
		}).fetch();                                                                                                          // 18
                                                                                                                       //
		var roleIds = _.pluck(roles, '_id'); // Security issue: we should not send all user's roles to all clients, only the 'public' roles
		// We must remove all roles that are not part of the query from the returned users                                   // 22
                                                                                                                       //
                                                                                                                       //
		var users = RocketChat.models.Users.findUsersInRoles(roleIds, null, options).fetch();                                // 23
                                                                                                                       //
		for (var _iterator = users, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
			var _ref;                                                                                                           // 24
                                                                                                                       //
			if (_isArray) {                                                                                                     // 24
				if (_i >= _iterator.length) break;                                                                                 // 24
				_ref = _iterator[_i++];                                                                                            // 24
			} else {                                                                                                            // 24
				_i = _iterator.next();                                                                                             // 24
				if (_i.done) break;                                                                                                // 24
				_ref = _i.value;                                                                                                   // 24
			}                                                                                                                   // 24
                                                                                                                       //
			var user = _ref;                                                                                                    // 24
			user.roles = _.intersection(user.roles, roleIds);                                                                   // 25
		}                                                                                                                    // 26
                                                                                                                       //
		return users;                                                                                                        // 27
	}                                                                                                                     // 28
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"insertOrUpdateUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/insertOrUpdateUser.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	insertOrUpdateUser: function (userData) {                                                                             // 2
		check(userData, Object);                                                                                             // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'insertOrUpdateUser'                                                                                       // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		return RocketChat.saveUser(Meteor.userId(), userData);                                                               // 10
	}                                                                                                                     // 11
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"joinDefaultChannels.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/joinDefaultChannels.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	joinDefaultChannels: function (silenced) {                                                                            // 2
		check(silenced, Match.Optional(Boolean));                                                                            // 3
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'joinDefaultChannels'                                                                                      // 6
			});                                                                                                                 // 6
		}                                                                                                                    // 7
                                                                                                                       //
		this.unblock();                                                                                                      // 9
		return RocketChat.addUserToDefaultChannels(Meteor.user(), silenced);                                                 // 10
	}                                                                                                                     // 11
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"joinRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/joinRoom.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	joinRoom: function (rid, code) {                                                                                      // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'joinRoom'                                                                                                 // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 12
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 13
				method: 'joinRoom'                                                                                                 // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (room.t !== 'c' || RocketChat.authz.hasPermission(Meteor.userId(), 'view-c-room') !== true) {                     // 16
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 17
				method: 'joinRoom'                                                                                                 // 17
			});                                                                                                                 // 17
		}                                                                                                                    // 18
                                                                                                                       //
		if (room.joinCodeRequired === true && code !== room.joinCode && !RocketChat.authz.hasPermission(Meteor.userId(), 'join-without-join-code')) {
			throw new Meteor.Error('error-code-invalid', 'Invalid Room Password', {                                             // 21
				method: 'joinRoom'                                                                                                 // 21
			});                                                                                                                 // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return RocketChat.addUserToRoom(rid, Meteor.user());                                                                 // 24
	}                                                                                                                     // 25
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"leaveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/leaveRoom.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	leaveRoom: function (rid) {                                                                                           // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'leaveRoom'                                                                                                // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		this.unblock();                                                                                                      // 10
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 12
		var user = Meteor.user();                                                                                            // 13
                                                                                                                       //
		if (room.t === 'd') {                                                                                                // 15
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 16
				method: 'leaveRoom'                                                                                                // 16
			});                                                                                                                 // 16
		}                                                                                                                    // 17
                                                                                                                       //
		if (!Array.from(room.usernames || []).includes(user.username)) {                                                     // 19
			throw new Meteor.Error('error-user-not-in-room', 'You are not in this room', {                                      // 20
				method: 'leaveRoom'                                                                                                // 20
			});                                                                                                                 // 20
		} // If user is room owner, check if there are other owners. If there isn't anyone else, warn user to set a new owner.
                                                                                                                       //
                                                                                                                       //
		if (RocketChat.authz.hasRole(user._id, 'owner', room._id)) {                                                         // 24
			var numOwners = RocketChat.authz.getUsersInRole('owner', room._id).fetch().length;                                  // 25
                                                                                                                       //
			if (numOwners === 1) {                                                                                              // 26
				throw new Meteor.Error('error-you-are-last-owner', 'You are the last owner. Please set new owner before leaving the room.', {
					method: 'leaveRoom'                                                                                               // 27
				});                                                                                                                // 27
			}                                                                                                                   // 28
		}                                                                                                                    // 29
                                                                                                                       //
		return RocketChat.removeUserFromRoom(rid, Meteor.user());                                                            // 31
	}                                                                                                                     // 32
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"removeOAuthService.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/removeOAuthService.js                                                        //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	removeOAuthService: function (name) {                                                                                 // 2
		check(name, String);                                                                                                 // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'removeOAuthService'                                                                                       // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'add-oauth-service') !== true) {                                 // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'removeOAuthService'                                                                                       // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		name = name.toLowerCase().replace(/[^a-z0-9_]/g, '');                                                                // 14
		name = s.capitalize(name);                                                                                           // 15
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name);                                                     // 16
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-url");                                            // 17
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-token_path");                                     // 18
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-identity_path");                                  // 19
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-authorize_path");                                 // 20
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-scope");                                          // 21
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-token_sent_via");                                 // 22
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-id");                                             // 23
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-secret");                                         // 24
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-button_label_text");                              // 25
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-button_label_color");                             // 26
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-button_color");                                   // 27
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-login_style");                                    // 28
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-username_field");                                 // 29
		RocketChat.settings.removeById("Accounts_OAuth_Custom-" + name + "-merge_users");                                    // 30
	}                                                                                                                     // 31
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"restartServer.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/restartServer.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	restart_server: function () {                                                                                         // 2
		if (!Meteor.userId()) {                                                                                              // 3
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 4
				method: 'restart_server'                                                                                           // 4
			});                                                                                                                 // 4
		}                                                                                                                    // 5
                                                                                                                       //
		if (RocketChat.authz.hasRole(Meteor.userId(), 'admin') !== true) {                                                   // 7
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 8
				method: 'restart_server'                                                                                           // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		Meteor.setTimeout(function () {                                                                                      // 11
			Meteor.setTimeout(function () {                                                                                     // 12
				console.warn('Call to process.exit() timed out, aborting.');                                                       // 13
				process.abort();                                                                                                   // 14
			}, 1000);                                                                                                           // 15
			process.exit(1);                                                                                                    // 16
		}, 1000);                                                                                                            // 17
		return {                                                                                                             // 19
			message: 'The_server_will_restart_in_s_seconds',                                                                    // 20
			params: [2]                                                                                                         // 21
		};                                                                                                                   // 19
	}                                                                                                                     // 23
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"robotMethods.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/robotMethods.js                                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	'robot.modelCall': function (model, method, args) {                                                                   // 2
		check(model, String);                                                                                                // 3
		check(method, String);                                                                                               // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'robot.modelCall'                                                                                          // 7
			});                                                                                                                 // 6
		}                                                                                                                    // 9
                                                                                                                       //
		if (!RocketChat.authz.hasRole(Meteor.userId(), 'robot')) {                                                           // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'robot.modelCall'                                                                                          // 12
			});                                                                                                                 // 11
		}                                                                                                                    // 14
                                                                                                                       //
		var m = RocketChat.models[model];                                                                                    // 15
                                                                                                                       //
		if (!m || !_.isFunction(m[method])) {                                                                                // 17
			throw new Meteor.Error('error-invalid-method', 'Invalid method', {                                                  // 18
				method: 'robot.modelCall'                                                                                          // 19
			});                                                                                                                 // 18
		}                                                                                                                    // 21
                                                                                                                       //
		var cursor = RocketChat.models[model][method].apply(RocketChat.models[model], args);                                 // 22
		return cursor && cursor.fetch ? cursor.fetch() : cursor;                                                             // 23
	}                                                                                                                     // 24
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"saveSetting.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/saveSetting.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* eslint new-cap: 0 */Meteor.methods({                                                                                // 1
	saveSetting: function (_id, value, editor) {                                                                          // 4
		if (Meteor.userId() === null) {                                                                                      // 5
			throw new Meteor.Error('error-action-not-allowed', 'Editing settings is not allowed', {                             // 6
				method: 'saveSetting'                                                                                              // 7
			});                                                                                                                 // 6
		}                                                                                                                    // 9
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'edit-privileged-setting')) {                                   // 11
			throw new Meteor.Error('error-action-not-allowed', 'Editing settings is not allowed', {                             // 12
				method: 'saveSetting'                                                                                              // 13
			});                                                                                                                 // 12
		} //Verify the _id passed in is a string.                                                                            // 15
                                                                                                                       //
                                                                                                                       //
		check(_id, String);                                                                                                  // 18
		var setting = RocketChat.models.Settings.db.findOneById(_id); //Verify the value is what it should be                // 20
                                                                                                                       //
		switch (setting.type) {                                                                                              // 23
			case 'roomPick':                                                                                                    // 24
				check(value, Match.OneOf([Object], ''));                                                                           // 25
				break;                                                                                                             // 26
                                                                                                                       //
			case 'boolean':                                                                                                     // 27
				check(value, Boolean);                                                                                             // 28
				break;                                                                                                             // 29
                                                                                                                       //
			case 'int':                                                                                                         // 30
				check(value, Number);                                                                                              // 31
				break;                                                                                                             // 32
                                                                                                                       //
			default:                                                                                                            // 33
				check(value, String);                                                                                              // 34
				break;                                                                                                             // 35
		}                                                                                                                    // 23
                                                                                                                       //
		RocketChat.settings.updateById(_id, value, editor);                                                                  // 38
		return true;                                                                                                         // 39
	}                                                                                                                     // 40
});                                                                                                                    // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendInvitationEmail.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/sendInvitationEmail.js                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 2
	sendInvitationEmail: function (emails) {                                                                              // 3
		var _this = this;                                                                                                    // 3
                                                                                                                       //
		check(emails, [String]);                                                                                             // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 5
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 6
				method: 'sendInvitationEmail'                                                                                      // 7
			});                                                                                                                 // 6
		}                                                                                                                    // 9
                                                                                                                       //
		if (!RocketChat.authz.hasRole(Meteor.userId(), 'admin')) {                                                           // 10
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 11
				method: 'sendInvitationEmail'                                                                                      // 12
			});                                                                                                                 // 11
		}                                                                                                                    // 14
                                                                                                                       //
		var rfcMailPattern = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                                                                                                                       //
		var validEmails = _.compact(_.map(emails, function (email) {                                                         // 16
			if (rfcMailPattern.test(email)) {                                                                                   // 17
				return email;                                                                                                      // 18
			}                                                                                                                   // 19
		}));                                                                                                                 // 20
                                                                                                                       //
		var header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');                         // 21
		var footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');                         // 22
		var html = void 0;                                                                                                   // 23
		var subject = void 0;                                                                                                // 24
		var user = Meteor.user();                                                                                            // 25
		var lng = user.language || RocketChat.settings.get('language') || 'en';                                              // 26
                                                                                                                       //
		if (RocketChat.settings.get('Invitation_Customized')) {                                                              // 27
			subject = RocketChat.settings.get('Invitation_Subject');                                                            // 28
			html = RocketChat.settings.get('Invitation_HTML');                                                                  // 29
		} else {                                                                                                             // 30
			subject = TAPi18n.__('Invitation_Subject_Default', {                                                                // 31
				lng: lng                                                                                                           // 32
			});                                                                                                                 // 31
			html = TAPi18n.__('Invitation_HTML_Default', {                                                                      // 34
				lng: lng                                                                                                           // 35
			});                                                                                                                 // 34
		}                                                                                                                    // 37
                                                                                                                       //
		subject = RocketChat.placeholders.replace(subject);                                                                  // 38
		validEmails.forEach(function (email) {                                                                               // 39
			_this.unblock();                                                                                                    // 40
                                                                                                                       //
			html = RocketChat.placeholders.replace(html, {                                                                      // 41
				email: email                                                                                                       // 42
			});                                                                                                                 // 41
                                                                                                                       //
			try {                                                                                                               // 44
				Email.send({                                                                                                       // 45
					to: email,                                                                                                        // 46
					from: RocketChat.settings.get('From_Email'),                                                                      // 47
					subject: subject,                                                                                                 // 48
					html: header + html + footer                                                                                      // 49
				});                                                                                                                // 45
			} catch (_ref) {                                                                                                    // 51
				var message = _ref.message;                                                                                        // 51
				throw new Meteor.Error('error-email-send-failed', "Error trying to send email: " + message, {                      // 52
					method: 'sendInvitationEmail',                                                                                    // 53
					message: message                                                                                                  // 54
				});                                                                                                                // 52
			}                                                                                                                   // 56
		});                                                                                                                  // 57
		return validEmails;                                                                                                  // 58
	}                                                                                                                     // 59
});                                                                                                                    // 2
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendMessage.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/sendMessage.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.watch(require("moment"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
Meteor.methods({                                                                                                       // 3
	sendMessage: function (message) {                                                                                     // 4
		check(message, Object);                                                                                              // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'sendMessage'                                                                                              // 8
			});                                                                                                                 // 7
		}                                                                                                                    // 10
                                                                                                                       //
		if (message.ts) {                                                                                                    // 11
			var tsDiff = Math.abs(moment(message.ts).diff());                                                                   // 12
                                                                                                                       //
			if (tsDiff > 60000) {                                                                                               // 13
				throw new Meteor.Error('error-message-ts-out-of-sync', 'Message timestamp is out of sync', {                       // 14
					method: 'sendMessage',                                                                                            // 15
					message_ts: message.ts,                                                                                           // 16
					server_ts: new Date().getTime()                                                                                   // 17
				});                                                                                                                // 14
			} else if (tsDiff > 10000) {                                                                                        // 19
				message.ts = new Date();                                                                                           // 20
			}                                                                                                                   // 21
		} else {                                                                                                             // 22
			message.ts = new Date();                                                                                            // 23
		}                                                                                                                    // 24
                                                                                                                       //
		if (message.msg && message.msg.length > RocketChat.settings.get('Message_MaxAllowedSize')) {                         // 25
			throw new Meteor.Error('error-message-size-exceeded', 'Message size exceeds Message_MaxAllowedSize', {              // 26
				method: 'sendMessage'                                                                                              // 27
			});                                                                                                                 // 26
		}                                                                                                                    // 29
                                                                                                                       //
		var user = RocketChat.models.Users.findOneById(Meteor.userId(), {                                                    // 30
			fields: {                                                                                                           // 31
				username: 1,                                                                                                       // 32
				name: 1                                                                                                            // 33
			}                                                                                                                   // 31
		});                                                                                                                  // 30
		var room = Meteor.call('canAccessRoom', message.rid, user._id);                                                      // 36
                                                                                                                       //
		if (!room) {                                                                                                         // 37
			return false;                                                                                                       // 38
		}                                                                                                                    // 39
                                                                                                                       //
		var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(message.rid, Meteor.userId());           // 40
                                                                                                                       //
		if (subscription && subscription.blocked || subscription.blocker) {                                                  // 41
			RocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {                                                   // 42
				_id: Random.id(),                                                                                                  // 43
				rid: room._id,                                                                                                     // 44
				ts: new Date(),                                                                                                    // 45
				msg: TAPi18n.__('room_is_blocked', {}, user.language)                                                              // 46
			});                                                                                                                 // 42
			return false;                                                                                                       // 48
		}                                                                                                                    // 49
                                                                                                                       //
		if ((room.muted || []).includes(user.username)) {                                                                    // 51
			RocketChat.Notifications.notifyUser(Meteor.userId(), 'message', {                                                   // 52
				_id: Random.id(),                                                                                                  // 53
				rid: room._id,                                                                                                     // 54
				ts: new Date(),                                                                                                    // 55
				msg: TAPi18n.__('You_have_been_muted', {}, user.language)                                                          // 56
			});                                                                                                                 // 52
			return false;                                                                                                       // 58
		}                                                                                                                    // 59
                                                                                                                       //
		if (message.alias == null && RocketChat.settings.get('Message_SetNameToAliasEnabled')) {                             // 60
			message.alias = user.name;                                                                                          // 61
		}                                                                                                                    // 62
                                                                                                                       //
		if (Meteor.settings['public'].sandstorm) {                                                                           // 63
			message.sandstormSessionId = this.connection.sandstormSessionId();                                                  // 64
		}                                                                                                                    // 65
                                                                                                                       //
		RocketChat.metrics.messagesSent.inc(); // TODO This line needs to be moved to it's proper place. See the comments on: https://github.com/RocketChat/Rocket.Chat/pull/5736
                                                                                                                       //
		return RocketChat.sendMessage(user, message, room);                                                                  // 67
	}                                                                                                                     // 68
}); // Limit a user, who does not have the "bot" role, to sending 5 msgs/second                                        // 3
                                                                                                                       //
RocketChat.RateLimiter.limitMethod('sendMessage', 5, 1000, {                                                           // 71
	userId: function (userId) {                                                                                           // 72
		return !RocketChat.authz.hasPermission(userId, 'send-many-messages');                                                // 73
	}                                                                                                                     // 74
});                                                                                                                    // 71
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"sendSMTPTestEmail.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/sendSMTPTestEmail.js                                                         //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	sendSMTPTestEmail: function () {                                                                                      // 2
		if (!Meteor.userId()) {                                                                                              // 3
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 4
				method: 'sendSMTPTestEmail'                                                                                        // 5
			});                                                                                                                 // 4
		}                                                                                                                    // 7
                                                                                                                       //
		var user = Meteor.user();                                                                                            // 8
                                                                                                                       //
		if (!user.emails && !user.emails[0] && user.emails[0].address) {                                                     // 9
			throw new Meteor.Error('error-invalid-email', 'Invalid email', {                                                    // 10
				method: 'sendSMTPTestEmail'                                                                                        // 11
			});                                                                                                                 // 10
		}                                                                                                                    // 13
                                                                                                                       //
		this.unblock();                                                                                                      // 14
		var header = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Header') || '');                         // 15
		var footer = RocketChat.placeholders.replace(RocketChat.settings.get('Email_Footer') || '');                         // 16
		console.log("Sending test email to " + user.emails[0].address);                                                      // 17
                                                                                                                       //
		try {                                                                                                                // 18
			Email.send({                                                                                                        // 19
				to: user.emails[0].address,                                                                                        // 20
				from: RocketChat.settings.get('From_Email'),                                                                       // 21
				subject: 'SMTP Test Email',                                                                                        // 22
				html: header + "<p>You have successfully sent an email</p>" + footer                                               // 23
			});                                                                                                                 // 19
		} catch (_ref) {                                                                                                     // 25
			var message = _ref.message;                                                                                         // 25
			throw new Meteor.Error('error-email-send-failed', "Error trying to send email: " + message, {                       // 26
				method: 'sendSMTPTestEmail',                                                                                       // 27
				message: message                                                                                                   // 28
			});                                                                                                                 // 26
		}                                                                                                                    // 30
                                                                                                                       //
		return {                                                                                                             // 31
			message: 'Your_mail_was_sent_to_s',                                                                                 // 32
			params: [user.emails[0].address]                                                                                    // 33
		};                                                                                                                   // 31
	}                                                                                                                     // 35
});                                                                                                                    // 1
DDPRateLimiter.addRule({                                                                                               // 38
	type: 'method',                                                                                                       // 39
	name: 'sendSMTPTestEmail',                                                                                            // 40
	userId: function () {                                                                                                 // 41
		return true;                                                                                                         // 42
	}                                                                                                                     // 43
}, 1, 1000);                                                                                                           // 38
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setAdminStatus.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setAdminStatus.js                                                            //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setAdminStatus: function (userId, admin) {                                                                            // 2
		check(userId, String);                                                                                               // 4
		check(admin, Match.Optional(Boolean));                                                                               // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 7
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 8
				method: 'setAdminStatus'                                                                                           // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		if (RocketChat.authz.hasPermission(Meteor.userId(), 'assign-admin-role') !== true) {                                 // 11
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 12
				method: 'setAdminStatus'                                                                                           // 12
			});                                                                                                                 // 12
		}                                                                                                                    // 13
                                                                                                                       //
		var user = Meteor.users.findOne({                                                                                    // 15
			_id: userId                                                                                                         // 15
		}, {                                                                                                                 // 15
			fields: {                                                                                                           // 15
				username: 1                                                                                                        // 15
			}                                                                                                                   // 15
		});                                                                                                                  // 15
                                                                                                                       //
		if (admin) {                                                                                                         // 17
			return Meteor.call('authorization:addUserToRole', 'admin', user.username);                                          // 18
		} else {                                                                                                             // 19
			return Meteor.call('authorization:removeUserFromRole', 'admin', user.username);                                     // 20
		}                                                                                                                    // 21
	}                                                                                                                     // 22
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setRealName.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setRealName.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setRealName: function (name) {                                                                                        // 2
		check(name, String);                                                                                                 // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'setRealName'                                                                                              // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		if (!RocketChat.setRealName(Meteor.userId(), name)) {                                                                // 10
			throw new Meteor.Error('error-could-not-change-name', 'Could not change name', {                                    // 11
				method: 'setRealName'                                                                                              // 11
			});                                                                                                                 // 11
		}                                                                                                                    // 12
                                                                                                                       //
		return name;                                                                                                         // 14
	}                                                                                                                     // 15
});                                                                                                                    // 1
RocketChat.RateLimiter.limitMethod('setRealName', 1, 1000, {                                                           // 18
	userId: function () {                                                                                                 // 19
		return true;                                                                                                         // 19
	}                                                                                                                     // 19
});                                                                                                                    // 18
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setUsername.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setUsername.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setUsername: function (username) {                                                                                    // 2
		var param = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};                                  // 2
		var joinDefaultChannelsSilenced = param.joinDefaultChannelsSilenced;                                                 // 2
		check(username, String);                                                                                             // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'setUsername'                                                                                              // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var user = Meteor.user();                                                                                            // 10
                                                                                                                       //
		if (user.username && !RocketChat.settings.get('Accounts_AllowUsernameChange')) {                                     // 12
			throw new Meteor.Error('error-not-allowed', 'Not allowed', {                                                        // 13
				method: 'setUsername'                                                                                              // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (user.username === username || user.username && user.username.toLowerCase() === username.toLowerCase()) {         // 16
			return username;                                                                                                    // 17
		}                                                                                                                    // 18
                                                                                                                       //
		var nameValidation = void 0;                                                                                         // 20
                                                                                                                       //
		try {                                                                                                                // 21
			nameValidation = new RegExp("^" + RocketChat.settings.get('UTF8_Names_Validation') + "$");                          // 22
		} catch (error) {                                                                                                    // 23
			nameValidation = new RegExp('^[0-9a-zA-Z-_.]+$');                                                                   // 24
		}                                                                                                                    // 25
                                                                                                                       //
		if (!nameValidation.test(username)) {                                                                                // 27
			throw new Meteor.Error('username-invalid', _.escape(username) + " is not a valid username, use only letters, numbers, dots, hyphens and underscores");
		}                                                                                                                    // 29
                                                                                                                       //
		if (!RocketChat.checkUsernameAvailability(username)) {                                                               // 31
			throw new Meteor.Error('error-field-unavailable', "<strong>" + _.escape(username) + "</strong> is already in use :(", {
				method: 'setUsername',                                                                                             // 32
				field: username                                                                                                    // 32
			});                                                                                                                 // 32
		}                                                                                                                    // 33
                                                                                                                       //
		if (!RocketChat.setUsername(user._id, username)) {                                                                   // 35
			throw new Meteor.Error('error-could-not-change-username', 'Could not change username', {                            // 36
				method: 'setUsername'                                                                                              // 36
			});                                                                                                                 // 36
		}                                                                                                                    // 37
                                                                                                                       //
		if (!user.username) {                                                                                                // 39
			Meteor.runAsUser(user._id, function () {                                                                            // 40
				return Meteor.call('joinDefaultChannels', joinDefaultChannelsSilenced);                                            // 40
			});                                                                                                                 // 40
			Meteor.defer(function () {                                                                                          // 41
				return RocketChat.callbacks.run('afterCreateUser', RocketChat.models.Users.findOneById(user._id));                 // 42
			});                                                                                                                 // 43
		}                                                                                                                    // 44
                                                                                                                       //
		return username;                                                                                                     // 46
	}                                                                                                                     // 47
});                                                                                                                    // 1
RocketChat.RateLimiter.limitMethod('setUsername', 1, 1000, {                                                           // 50
	userId: function () {                                                                                                 // 51
		return true;                                                                                                         // 51
	}                                                                                                                     // 51
});                                                                                                                    // 50
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"setEmail.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/setEmail.js                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	setEmail: function (email) {                                                                                          // 2
		check(email, String);                                                                                                // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'setEmail'                                                                                                 // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var user = Meteor.user();                                                                                            // 10
                                                                                                                       //
		if (!RocketChat.settings.get('Accounts_AllowEmailChange')) {                                                         // 12
			throw new Meteor.Error('error-action-not-allowed', 'Changing email is not allowed', {                               // 13
				method: 'setEmail',                                                                                                // 13
				action: 'Changing_email'                                                                                           // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (user.emails && user.emails[0] && user.emails[0].address === email) {                                             // 16
			return email;                                                                                                       // 17
		}                                                                                                                    // 18
                                                                                                                       //
		if (!RocketChat.setEmail(user._id, email)) {                                                                         // 20
			throw new Meteor.Error('error-could-not-change-email', 'Could not change email', {                                  // 21
				method: 'setEmail'                                                                                                 // 21
			});                                                                                                                 // 21
		}                                                                                                                    // 22
                                                                                                                       //
		return email;                                                                                                        // 24
	}                                                                                                                     // 25
});                                                                                                                    // 1
RocketChat.RateLimiter.limitMethod('setEmail', 1, 1000, {                                                              // 28
	userId: function () /*userId*/{                                                                                       // 29
		return true;                                                                                                         // 29
	}                                                                                                                     // 29
});                                                                                                                    // 28
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"unarchiveRoom.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/unarchiveRoom.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	unarchiveRoom: function (rid) {                                                                                       // 2
		check(rid, String);                                                                                                  // 4
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 6
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 7
				method: 'unarchiveRoom'                                                                                            // 7
			});                                                                                                                 // 7
		}                                                                                                                    // 8
                                                                                                                       //
		var room = RocketChat.models.Rooms.findOneById(rid);                                                                 // 10
                                                                                                                       //
		if (!room) {                                                                                                         // 12
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 13
				method: 'unarchiveRoom'                                                                                            // 13
			});                                                                                                                 // 13
		}                                                                                                                    // 14
                                                                                                                       //
		if (!RocketChat.authz.hasPermission(Meteor.userId(), 'unarchive-room', room._id)) {                                  // 16
			throw new Meteor.Error('error-not-authorized', 'Not authorized', {                                                  // 17
				method: 'unarchiveRoom'                                                                                            // 17
			});                                                                                                                 // 17
		}                                                                                                                    // 18
                                                                                                                       //
		return RocketChat.unarchiveRoom(rid);                                                                                // 20
	}                                                                                                                     // 21
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"unblockUser.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/unblockUser.js                                                               //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
Meteor.methods({                                                                                                       // 1
	unblockUser: function (_ref) {                                                                                        // 2
		var rid = _ref.rid,                                                                                                  // 2
		    blocked = _ref.blocked;                                                                                          // 2
		check(rid, String);                                                                                                  // 4
		check(blocked, String);                                                                                              // 5
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 7
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 8
				method: 'blockUser'                                                                                                // 8
			});                                                                                                                 // 8
		}                                                                                                                    // 9
                                                                                                                       //
		var subscription = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, Meteor.userId());                   // 11
		var subscription2 = RocketChat.models.Subscriptions.findOneByRoomIdAndUserId(rid, blocked);                          // 12
                                                                                                                       //
		if (!subscription || !subscription2) {                                                                               // 14
			throw new Meteor.Error('error-invalid-room', 'Invalid room', {                                                      // 15
				method: 'blockUser'                                                                                                // 15
			});                                                                                                                 // 15
		}                                                                                                                    // 16
                                                                                                                       //
		RocketChat.models.Subscriptions.unsetBlockedByRoomId(rid, blocked, Meteor.userId());                                 // 18
		return true;                                                                                                         // 20
	}                                                                                                                     // 21
});                                                                                                                    // 1
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"updateMessage.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/server/methods/updateMessage.js                                                             //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var moment = void 0;                                                                                                   // 1
module.watch(require("moment"), {                                                                                      // 1
	"default": function (v) {                                                                                             // 1
		moment = v;                                                                                                          // 1
	}                                                                                                                     // 1
}, 0);                                                                                                                 // 1
Meteor.methods({                                                                                                       // 3
	updateMessage: function (message) {                                                                                   // 4
		check(message, Match.ObjectIncluding({                                                                               // 6
			_id: String                                                                                                         // 6
		}));                                                                                                                 // 6
                                                                                                                       //
		if (!Meteor.userId()) {                                                                                              // 8
			throw new Meteor.Error('error-invalid-user', 'Invalid user', {                                                      // 9
				method: 'updateMessage'                                                                                            // 9
			});                                                                                                                 // 9
		}                                                                                                                    // 10
                                                                                                                       //
		var originalMessage = RocketChat.models.Messages.findOneById(message._id);                                           // 12
                                                                                                                       //
		if (!originalMessage || !originalMessage._id) {                                                                      // 14
			return;                                                                                                             // 15
		}                                                                                                                    // 16
                                                                                                                       //
		var hasPermission = RocketChat.authz.hasPermission(Meteor.userId(), 'edit-message', message.rid);                    // 18
		var editAllowed = RocketChat.settings.get('Message_AllowEditing');                                                   // 19
		var editOwn = originalMessage.u && originalMessage.u._id === Meteor.userId();                                        // 20
                                                                                                                       //
		if (!hasPermission && (!editAllowed || !editOwn)) {                                                                  // 22
			throw new Meteor.Error('error-action-not-allowed', 'Message editing not allowed', {                                 // 23
				method: 'updateMessage',                                                                                           // 23
				action: 'Message_editing'                                                                                          // 23
			});                                                                                                                 // 23
		}                                                                                                                    // 24
                                                                                                                       //
		var blockEditInMinutes = RocketChat.settings.get('Message_AllowEditing_BlockEditInMinutes');                         // 26
                                                                                                                       //
		if (Match.test(blockEditInMinutes, Number) && blockEditInMinutes !== 0) {                                            // 27
			var currentTsDiff = void 0;                                                                                         // 28
			var msgTs = void 0;                                                                                                 // 29
                                                                                                                       //
			if (Match.test(originalMessage.ts, Number)) {                                                                       // 31
				msgTs = moment(originalMessage.ts);                                                                                // 32
			}                                                                                                                   // 33
                                                                                                                       //
			if (msgTs) {                                                                                                        // 34
				currentTsDiff = moment().diff(msgTs, 'minutes');                                                                   // 35
			}                                                                                                                   // 36
                                                                                                                       //
			if (currentTsDiff > blockEditInMinutes) {                                                                           // 37
				throw new Meteor.Error('error-message-editing-blocked', 'Message editing is blocked', {                            // 38
					method: 'updateMessage'                                                                                           // 38
				});                                                                                                                // 38
			}                                                                                                                   // 39
		} // It is possible to have an empty array as the attachments property, so ensure both things exist                  // 40
                                                                                                                       //
                                                                                                                       //
		if (originalMessage.attachments && originalMessage.attachments.length > 0 && originalMessage.attachments[0].description !== undefined) {
			message.attachments = originalMessage.attachments;                                                                  // 44
			message.attachments[0].description = message.msg;                                                                   // 45
			message.msg = originalMessage.msg;                                                                                  // 46
		}                                                                                                                    // 47
                                                                                                                       //
		message.u = originalMessage.u;                                                                                       // 49
		return RocketChat.updateMessage(message, Meteor.user());                                                             // 51
	}                                                                                                                     // 52
});                                                                                                                    // 3
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}},"startup":{"defaultRoomTypes.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/startup/defaultRoomTypes.js                                                                 //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/* globals openRoom */RocketChat.roomTypes.add('unread', 10, {                                                         // 1
	unread: true,                                                                                                         // 3
	condition: function () {                                                                                              // 4
		var user = Meteor.user();                                                                                            // 5
		var preferences = user && user.settings && user.settings.preferences && user.settings.preferences || {};             // 6
		return preferences.roomsListExhibitionMode === 'unread';                                                             // 7
	},                                                                                                                    // 8
	label: 'Unread'                                                                                                       // 9
});                                                                                                                    // 2
RocketChat.roomTypes.add('f', 20, {                                                                                    // 12
	header: 'favorite',                                                                                                   // 13
	icon: 'star',                                                                                                         // 14
	label: 'Favorites'                                                                                                    // 15
}); // activity                                                                                                        // 12
                                                                                                                       //
RocketChat.roomTypes.add('activity', 30, {                                                                             // 19
	condition: function () {                                                                                              // 20
		var user = Meteor.user();                                                                                            // 21
		var preferences = user && user.settings && user.settings.preferences && user.settings.preferences || {};             // 22
		return preferences.roomsListExhibitionMode === 'activity';                                                           // 23
	},                                                                                                                    // 24
	label: 'Conversations'                                                                                                // 25
});                                                                                                                    // 19
RocketChat.roomTypes.add('channels', 30, {                                                                             // 28
	label: 'Channels',                                                                                                    // 29
	condition: function () {                                                                                              // 30
		var user = Meteor.user();                                                                                            // 31
		var preferences = user && user.settings && user.settings.preferences && user.settings.preferences || {};             // 32
		return ['unread', 'category'].includes(preferences.roomsListExhibitionMode) && preferences.mergeChannels;            // 33
	}                                                                                                                     // 34
}); // public                                                                                                          // 28
                                                                                                                       //
RocketChat.roomTypes.add('c', 30, {                                                                                    // 37
	icon: 'hashtag',                                                                                                      // 38
	label: 'Channels',                                                                                                    // 39
	route: {                                                                                                              // 40
		name: 'channel',                                                                                                     // 41
		path: '/channel/:name',                                                                                              // 42
		action: function (params) {                                                                                          // 43
			return openRoom('c', params.name);                                                                                  // 44
		}                                                                                                                    // 45
	},                                                                                                                    // 40
	findRoom: function (identifier) {                                                                                     // 48
		var query = {                                                                                                        // 49
			t: 'c',                                                                                                             // 50
			name: identifier                                                                                                    // 51
		};                                                                                                                   // 49
		return ChatRoom.findOne(query);                                                                                      // 53
	},                                                                                                                    // 54
	roomName: function (roomData) {                                                                                       // 56
		if (RocketChat.settings.get('UI_Allow_room_names_with_special_chars')) {                                             // 57
			return roomData.fname || roomData.name;                                                                             // 58
		}                                                                                                                    // 59
                                                                                                                       //
		return roomData.name;                                                                                                // 60
	},                                                                                                                    // 61
	condition: function () {                                                                                              // 63
		var user = Meteor.user();                                                                                            // 64
		var preferences = user && user.settings && user.settings.preferences && user.settings.preferences || {};             // 65
		return !preferences.roomsListExhibitionMode || ['unread', 'category'].includes(preferences.roomsListExhibitionMode) && !preferences.mergeChannels && (RocketChat.authz.hasAtLeastOnePermission(['view-c-room', 'view-joined-room']) || RocketChat.settings.get('Accounts_AllowAnonymousRead') === true);
	},                                                                                                                    // 67
	showJoinLink: function (roomId) {                                                                                     // 69
		return !!ChatRoom.findOne({                                                                                          // 70
			_id: roomId,                                                                                                        // 70
			t: 'c'                                                                                                              // 70
		});                                                                                                                  // 70
	}                                                                                                                     // 71
}); // private                                                                                                         // 37
                                                                                                                       //
RocketChat.roomTypes.add('p', 40, {                                                                                    // 75
	icon: 'lock',                                                                                                         // 76
	label: 'Private_Groups',                                                                                              // 77
	route: {                                                                                                              // 78
		name: 'group',                                                                                                       // 79
		path: '/group/:name',                                                                                                // 80
		action: function (params) {                                                                                          // 81
			return openRoom('p', params.name);                                                                                  // 82
		}                                                                                                                    // 83
	},                                                                                                                    // 78
	findRoom: function (identifier) {                                                                                     // 86
		var query = {                                                                                                        // 87
			t: 'p',                                                                                                             // 88
			name: identifier                                                                                                    // 89
		};                                                                                                                   // 87
		return ChatRoom.findOne(query);                                                                                      // 91
	},                                                                                                                    // 92
	roomName: function (roomData) {                                                                                       // 94
		if (RocketChat.settings.get('UI_Allow_room_names_with_special_chars')) {                                             // 95
			return roomData.fname || roomData.name;                                                                             // 96
		}                                                                                                                    // 97
                                                                                                                       //
		return roomData.name;                                                                                                // 98
	},                                                                                                                    // 99
	condition: function () {                                                                                              // 101
		var user = Meteor.user();                                                                                            // 102
		var preferences = user && user.settings && user.settings.preferences && user.settings.preferences || {};             // 103
		return !preferences.roomsListExhibitionMode || ['unread', 'category'].includes(preferences.roomsListExhibitionMode) && !preferences.mergeChannels && RocketChat.authz.hasAllPermission('view-p-room');
	}                                                                                                                     // 105
}); // direct                                                                                                          // 75
                                                                                                                       //
RocketChat.roomTypes.add('d', 50, {                                                                                    // 110
	icon: false,                                                                                                          // 111
	label: 'Direct_Messages',                                                                                             // 112
	route: {                                                                                                              // 113
		name: 'direct',                                                                                                      // 114
		path: '/direct/:username',                                                                                           // 115
		action: function (params) {                                                                                          // 116
			return openRoom('d', params.username);                                                                              // 117
		},                                                                                                                   // 118
		link: function (sub) {                                                                                               // 119
			return {                                                                                                            // 120
				username: sub.name                                                                                                 // 120
			};                                                                                                                  // 120
		}                                                                                                                    // 121
	},                                                                                                                    // 113
	findRoom: function (identifier) {                                                                                     // 124
		var query = {                                                                                                        // 125
			t: 'd',                                                                                                             // 126
			name: identifier                                                                                                    // 127
		};                                                                                                                   // 125
		var subscription = ChatSubscription.findOne(query);                                                                  // 130
                                                                                                                       //
		if (subscription && subscription.rid) {                                                                              // 131
			return ChatRoom.findOne(subscription.rid);                                                                          // 132
		}                                                                                                                    // 133
	},                                                                                                                    // 134
	roomName: function (roomData) {                                                                                       // 136
		var subscription = ChatSubscription.findOne({                                                                        // 137
			rid: roomData._id                                                                                                   // 137
		}, {                                                                                                                 // 137
			fields: {                                                                                                           // 137
				name: 1,                                                                                                           // 137
				fname: 1                                                                                                           // 137
			}                                                                                                                   // 137
		});                                                                                                                  // 137
                                                                                                                       //
		if (!subscription) {                                                                                                 // 138
			return '';                                                                                                          // 139
		}                                                                                                                    // 140
                                                                                                                       //
		if (RocketChat.settings.get('UI_Use_Real_Name') && subscription.fname) {                                             // 141
			return subscription.fname;                                                                                          // 142
		}                                                                                                                    // 143
                                                                                                                       //
		return subscription.name;                                                                                            // 145
	},                                                                                                                    // 146
	secondaryRoomName: function (roomData) {                                                                              // 148
		if (RocketChat.settings.get('UI_Use_Real_Name')) {                                                                   // 149
			var subscription = ChatSubscription.findOne({                                                                       // 150
				rid: roomData._id                                                                                                  // 150
			}, {                                                                                                                // 150
				fields: {                                                                                                          // 150
					name: 1                                                                                                           // 150
				}                                                                                                                  // 150
			});                                                                                                                 // 150
			return subscription && subscription.name;                                                                           // 151
		}                                                                                                                    // 152
	},                                                                                                                    // 153
	condition: function () {                                                                                              // 155
		var user = Meteor.user();                                                                                            // 156
		var preferences = user && user.settings && user.settings.preferences && user.settings.preferences || {};             // 157
		return !preferences.roomsListExhibitionMode || ['unread', 'category'].includes(preferences.roomsListExhibitionMode) && RocketChat.authz.hasAtLeastOnePermission(['view-d-room', 'view-joined-room']);
	},                                                                                                                    // 159
	getUserStatus: function (roomId) {                                                                                    // 161
		var subscription = RocketChat.models.Subscriptions.findOne({                                                         // 162
			rid: roomId                                                                                                         // 162
		});                                                                                                                  // 162
                                                                                                                       //
		if (subscription == null) {                                                                                          // 163
			return;                                                                                                             // 163
		}                                                                                                                    // 163
                                                                                                                       //
		return Session.get("user_" + subscription.name + "_status");                                                         // 165
	}                                                                                                                     // 166
});                                                                                                                    // 110
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"rocketchat.info.js":function(){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// packages/rocketchat_lib/rocketchat.info.js                                                                          //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
RocketChat.Info = {
    "version": "0.59.1",
    "build": {
        "date": "2017-10-20T14:09:14.103Z",
        "nodeVersion": "v4.8.4",
        "arch": "x64",
        "platform": "linux",
        "osRelease": "3.13.0-55-generic",
        "totalMemory": 3156074496,
        "freeMemory": 413347840,
        "cpus": 2
    },
    "commit": {
        "hash": "187cd9f64357005d4fb81c6125b51f74a836cdd2",
        "date": "Fri Oct 20 19:28:09 2017 +0600",
        "author": "Alex Trofimov",
        "subject": "Properly process username field",
        "tag": "v.0.54.2",
        "branch": "master"
    }
};
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"node_modules":{"bugsnag":{"package.json":function(require,exports){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// .npm/package/node_modules/bugsnag/package.json                                                                      //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
exports.name = "bugsnag";
exports.version = "1.8.0";
exports.main = "./lib/bugsnag.js";

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"lib":{"bugsnag.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat_lib/node_modules/bugsnag/lib/bugsnag.js                                              //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
var domain = require("domain"),
    path = require("path"),
    Utils = require("./utils"),
    Logger = require("./logger"),
    Configuration = require("./configuration"),
    BugsnagError = require("./error"),
    Notification = require("./notification"),
    requestInfo = require("./request_info");

// Ensure we get all stack frames from thrown errors.
Error.stackTraceLimit = Infinity;

function autoNotifyCallback(notifiedError, uncaughtError) {
    if (!uncaughtError) {
        uncaughtError = notifiedError.domain;
    }
    return function(error) {
        if (error) {
            Configuration.logger.error("Bugsnag: error notifying bugsnag.com - " + error);
        }
        if (Configuration.onUncaughtError && uncaughtError) {
            return Configuration.onUncaughtError(notifiedError);
        }
    };
}

var unCaughtErrorHandlerAdded = false;

var Bugsnag = {};

// This allows people to directly play with metaData without knowledge of Configuration
Object.defineProperty(Bugsnag, 'metaData', {
    get: function() {
        return Configuration.metaData;
    },
    set: function(metaData) {
        Configuration.metaData = metaData;
    }
});

// This allows people to directly play with requestData without knowledge of domains
Object.defineProperty(Bugsnag, 'requestData', {
    get: function () {
        return process.domain && process.domain._bugsnagOptions;
    },

    set: function (requestData) {
        if (process.domain) {
            process.domain._bugsnagOptions = requestData;
        }
    }
});

// Register sets api key and will configure bugsnag based on options
Bugsnag.register = function(apiKey, options) {
    if (!options) {
        options = {};
    }
    Configuration.apiKey = apiKey;
    Bugsnag.configure(options);
    Configuration.logger.info("Registered with apiKey " + apiKey);
    return Bugsnag;
};

// Configure bugsnag using the provided options
Bugsnag.configure = function(options) {
    Configuration.configure(options);

    // If we should auto notify we also configure the uncaught exception handler, we can't do this
    // by default as it changes the way the app response by removing the default handler.
    if (Configuration.autoNotifyUncaught && !unCaughtErrorHandlerAdded) {
        unCaughtErrorHandlerAdded = true;
        Configuration.logger.info("Configuring uncaughtExceptionHandler");
        process.on("uncaughtException", function(err) {
            Bugsnag.notify(err, {
                severity: "error"
            }, autoNotifyCallback(err, true));
        });
    }
};

// Only error is required and that can be a string or error object
Bugsnag.notify = function(error, options, cb) {
    var bugsnagErrors, notification;
    if (Utils.typeOf(options) === "function") {
        cb = options;
        options = {};
    }
    if (!options) {
        options = {};
    }
    if (!Bugsnag.shouldNotify()) {
        if (cb) {
            if (!Configuration.apiKey) {
                cb(new Error("Bugsnag has not been configured with an api key!"));
            } else {
                cb(new Error("Current release stage not permitted to send events to Bugsnag."));
            }
        }
        return;
    }
    Configuration.logger.info("Notifying Bugsnag of exception...\n" + (error && error.stack || error));
    bugsnagErrors = BugsnagError.buildErrors(error, options.errorName);
    delete options.errorName;
    notification = new Notification(bugsnagErrors, options);
    if (Configuration.sendCode === true) {
        notification.loadCode(function () {
            notification.deliver(cb);
        });
    } else {
        notification.deliver(cb);
    }
};

// The error handler express/connext middleware. Performs a notify
Bugsnag.errorHandler = function(err, req, res, next) {
    Configuration.logger.info("Handling express error: " + (err.stack || err));
    Bugsnag.notify(err, {
        req: req,
        severity: "error"
    }, autoNotifyCallback(err));
    return next(err);
};

// The request middleware for express/connect. Ensures next(err) is called when there is an error, and
// tracks the request for manual notifies.
Bugsnag.requestHandler = function(req, res, next) {
    var dom;
    dom = domain.create();
    dom._bugsnagOptions = {
        cleanedRequest: requestInfo(req)
    };
    dom.on('error', next);
    return dom.run(next);
};

Bugsnag.restifyHandler = function(req, res, route, err) {
    Bugsnag.notify(err, {
        req: req,
        severity: "error"
    }, autoNotifyCallback(err));
};

Bugsnag.koaHandler = function(err, ctx) {
    var request;
    Configuration.logger.info("Handling koa error: " + (err.stack || err));
    request = ctx.req;
    request.protocol = ctx.request.protocol;
    request.host = ctx.request.host.split(':', 1)[0];
    return Bugsnag.notify(err, {
        req: request,
        severity: "error"
    }, autoNotifyCallback(err));
};

// Intercepts the first argument from a callback and interprets it as an error.
// if the error is not null it notifies bugsnag and doesn't call the callback
Bugsnag.intercept = function(cb) {
    if (!cb) {
        cb = (function() {});
    }
    if (process.domain) {
        return process.domain.intercept(cb);
    } else {
        return function() {
            var err = arguments[0];
            var args = Array.prototype.slice.call(arguments, 1);
            if (err && (err instanceof Error)) {
                return Bugsnag.notify(err, {
                    severity: "error"
                }, autoNotifyCallback(err));
            }
            if (cb) {
                return cb.apply(null, args);
            }
        };
    }
};

// Automatically notifies of uncaught exceptions in the callback and error
// event emitters. Returns an event emitter, you can hook into .on("error") if
// you want to.
Bugsnag.autoNotify = function(options, cb) {
    var dom;
    if (Utils.typeOf(options) === "function") {
        cb = options;
        options = {};
    }
    dom = domain.create();
    dom._bugsnagOptions = options;
    options.severity = "error";
    dom.on('error', function(err) {
        return Bugsnag.notify(err, options, autoNotifyCallback(err));
    });
    process.nextTick(function() {
        return dom.run(cb);
    });
    return dom;
};

Bugsnag.shouldNotify = function() {
    return (Configuration.notifyReleaseStages === null || Configuration.notifyReleaseStages.indexOf(Configuration.releaseStage) !== -1) && Configuration.apiKey;
};

Bugsnag.onBeforeNotify = function (callback) {
    if (typeof callback !== "function") {
        throw new Error("must pass a callback to onBeforeNotify");
    }

    Configuration.beforeNotifyCallbacks.push(callback);
};

module.exports = Bugsnag;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}},"prom-client":{"package.json":function(require,exports){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// .npm/package/node_modules/prom-client/package.json                                                                  //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
exports.name = "prom-client";
exports.version = "7.0.1";
exports.main = "index.js";

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"index.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat_lib/node_modules/prom-client/index.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/**
 * Prometheus client
 * @module Prometheus client
 */

'use strict';

exports.register = require('./lib/register');

exports.Counter = require('./lib/counter');
exports.Gauge = require('./lib/gauge');
exports.Histogram = require('./lib/histogram');
exports.Summary = require('./lib/summary');
exports.Pushgateway = require('./lib/pushgateway');

exports.linearBuckets = require('./lib/bucketGenerators').linearBuckets;
exports.exponentialBuckets = require('./lib/bucketGenerators').exponentialBuckets;

var defaultMetrics = require('./lib/defaultMetrics');

defaultMetrics();

exports.defaultMetrics = defaultMetrics;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}},"lokijs":{"package.json":function(require,exports){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// .npm/package/node_modules/lokijs/package.json                                                                       //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
exports.name = "lokijs";
exports.version = "1.4.1";
exports.main = "src/lokijs.js";

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

},"src":{"lokijs.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat_lib/node_modules/lokijs/src/lokijs.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
/**
 * LokiJS
 * @author Joe Minichino <joe.minichino@gmail.com>
 *
 * A lightweight document oriented javascript database
 */
(function (root, factory) {
  if (typeof define === 'function' && define.amd) {
    // AMD
    define([], factory);
  } else if (typeof exports === 'object') {
    // CommonJS
    module.exports = factory();
  } else {
    // Browser globals
    root.loki = factory();
  }
}(this, function () {

  return (function () {
    'use strict';

    var hasOwnProperty = Object.prototype.hasOwnProperty;

    var Utils = {
      copyProperties: function (src, dest) {
        var prop;
        for (prop in src) {
          dest[prop] = src[prop];
        }
      },
      // used to recursively scan hierarchical transform step object for param substitution
      resolveTransformObject: function (subObj, params, depth) {
        var prop,
          pname;

        if (typeof depth !== 'number') {
          depth = 0;
        }

        if (++depth >= 10) return subObj;

        for (prop in subObj) {
          if (typeof subObj[prop] === 'string' && subObj[prop].indexOf("[%lktxp]") === 0) {
            pname = subObj[prop].substring(8);
            if (params.hasOwnProperty(pname)) {
              subObj[prop] = params[pname];
            }
          } else if (typeof subObj[prop] === "object") {
            subObj[prop] = Utils.resolveTransformObject(subObj[prop], params, depth);
          }
        }

        return subObj;
      },
      // top level utility to resolve an entire (single) transform (array of steps) for parameter substitution
      resolveTransformParams: function (transform, params) {
        var idx,
          clonedStep,
          resolvedTransform = [];

        if (typeof params === 'undefined') return transform;

        // iterate all steps in the transform array
        for (idx = 0; idx < transform.length; idx++) {
          // clone transform so our scan and replace can operate directly on cloned transform
          clonedStep = JSON.parse(JSON.stringify(transform[idx]));
          resolvedTransform.push(Utils.resolveTransformObject(clonedStep, params));
        }

        return resolvedTransform;
      }
    };

    /** Helper function for determining 'less-than' conditions for ops, sorting, and binary indices.
     *     In the future we might want $lt and $gt ops to use their own functionality/helper.
     *     Since binary indices on a property might need to index [12, NaN, new Date(), Infinity], we
     *     need this function (as well as gtHelper) to always ensure one value is LT, GT, or EQ to another.
     */
    function ltHelper(prop1, prop2, equal) {
      var cv1, cv2;

      // 'falsy' and Boolean handling
      if (!prop1 || !prop2 || prop1 === true || prop2 === true) {
        if ((prop1 === true || prop1 === false) && (prop2 === true || prop2 === false)) {
          if (equal) {
            return prop1 === prop2;
          } else {
            if (prop1) {
              return false;
            } else {
              return prop2;
            }
          }
        }

        if (prop2 === undefined || prop2 === null || prop1 === true || prop2 === false) {
          return equal;
        }
        if (prop1 === undefined || prop1 === null || prop1 === false || prop2 === true) {
          return true;
        }
      }

      if (prop1 === prop2) {
        return equal;
      }

      if (prop1 < prop2) {
        return true;
      }

      if (prop1 > prop2) {
        return false;
      }

      // not strict equal nor less than nor gt so must be mixed types, convert to string and use that to compare
      cv1 = prop1.toString();
      cv2 = prop2.toString();

      if (cv1 == cv2) {
        return equal;
      }

      if (cv1 < cv2) {
        return true;
      }

      return false;
    }

    function gtHelper(prop1, prop2, equal) {
      var cv1, cv2;

      // 'falsy' and Boolean handling
      if (!prop1 || !prop2 || prop1 === true || prop2 === true) {
        if ((prop1 === true || prop1 === false) && (prop2 === true || prop2 === false)) {
          if (equal) {
            return prop1 === prop2;
          } else {
            if (prop1) {
              return !prop2;
            } else {
              return false;
            }
          }
        }

        if (prop1 === undefined || prop1 === null || prop1 === false || prop2 === true) {
          return equal;
        }
        if (prop2 === undefined || prop2 === null || prop1 === true || prop2 === false) {
          return true;
        }
      }

      if (prop1 === prop2) {
        return equal;
      }

      if (prop1 > prop2) {
        return true;
      }

      if (prop1 < prop2) {
        return false;
      }

      // not strict equal nor less than nor gt so must be mixed types, convert to string and use that to compare
      cv1 = prop1.toString();
      cv2 = prop2.toString();

      if (cv1 == cv2) {
        return equal;
      }

      if (cv1 > cv2) {
        return true;
      }

      return false;
    }

    function sortHelper(prop1, prop2, desc) {
      if (prop1 === prop2) {
        return 0;
      }

      if (ltHelper(prop1, prop2, false)) {
        return (desc) ? (1) : (-1);
      }

      if (gtHelper(prop1, prop2, false)) {
        return (desc) ? (-1) : (1);
      }

      // not lt, not gt so implied equality-- date compatible
      return 0;
    }

    /**
     * compoundeval() - helper function for compoundsort(), performing individual object comparisons
     *
     * @param {array} properties - array of property names, in order, by which to evaluate sort order
     * @param {object} obj1 - first object to compare
     * @param {object} obj2 - second object to compare
     * @returns {integer} 0, -1, or 1 to designate if identical (sortwise) or which should be first
     */
    function compoundeval(properties, obj1, obj2) {
      var res = 0;
      var prop, field;
      for (var i = 0, len = properties.length; i < len; i++) {
        prop = properties[i];
        field = prop[0];
        res = sortHelper(obj1[field], obj2[field], prop[1]);
        if (res !== 0) {
          return res;
        }
      }
      return 0;
    }

    /**
     * dotSubScan - helper function used for dot notation queries.
     *
     * @param {object} root - object to traverse
     * @param {array} paths - array of properties to drill into
     * @param {function} fun - evaluation function to test with
     * @param {any} value - comparative value to also pass to (compare) fun
     */
    function dotSubScan(root, paths, fun, value) {
      var path = paths[0];
      if (typeof root === 'undefined' || root === null || !root.hasOwnProperty(path)) {
        return false;
      }

      var valueFound = false;
      var element = root[path];
      if (Array.isArray(element)) {
        var index;
        for (index in element) {
          valueFound = valueFound || dotSubScan(element[index], paths.slice(1, paths.length), fun, value);
          if (valueFound === true) {
            break;
          }
        }
      } else if (typeof element === 'object') {
        valueFound = dotSubScan(element, paths.slice(1, paths.length), fun, value);
      } else {
        valueFound = fun(element, value);
      }

      return valueFound;
    }

    function containsCheckFn(a) {
      if (typeof a === 'string' || Array.isArray(a)) {
        return function (b) {
          return a.indexOf(b) !== -1;
        };
      } else if (typeof a === 'object' && a !== null) {
        return function (b) {
          return hasOwnProperty.call(a, b);
        };
      }
      return null;
    }

    function doQueryOp(val, op) {
      for (var p in op) {
        if (hasOwnProperty.call(op, p)) {
          return LokiOps[p](val, op[p]);
        }
      }
      return false;
    }

    var LokiOps = {
      // comparison operators
      // a is the value in the collection
      // b is the query value
      $eq: function (a, b) {
        return a === b;
      },

      // abstract/loose equality
      $aeq: function (a, b) {
        return a == b;
      },

      $ne: function (a, b) {
        // ecma 5 safe test for NaN
        if (b !== b) {
          // ecma 5 test value is not NaN
          return (a === a);
        }

        return a !== b;
      },

      $dteq: function (a, b) {
        if (ltHelper(a, b, false)) {
          return false;
        }
        return !gtHelper(a, b, false);
      },

      $gt: function (a, b) {
        return gtHelper(a, b, false);
      },

      $gte: function (a, b) {
        return gtHelper(a, b, true);
      },

      $lt: function (a, b) {
        return ltHelper(a, b, false);
      },

      $lte: function (a, b) {
        return ltHelper(a, b, true);
      },

      $in: function (a, b) {
        return b.indexOf(a) !== -1;
      },

      $nin: function (a, b) {
        return b.indexOf(a) === -1;
      },

      $keyin: function (a, b) {
        return a in b;
      },

      $nkeyin: function (a, b) {
        return !(a in b);
      },

      $definedin: function (a, b) {
        return b[a] !== undefined;
      },

      $undefinedin: function (a, b) {
        return b[a] === undefined;
      },

      $regex: function (a, b) {
        return b.test(a);
      },

      $containsString: function (a, b) {
        return (typeof a === 'string') && (a.indexOf(b) !== -1);
      },

      $containsNone: function (a, b) {
        return !LokiOps.$containsAny(a, b);
      },

      $containsAny: function (a, b) {
        var checkFn = containsCheckFn(a);
        if (checkFn !== null) {
          return (Array.isArray(b)) ? (b.some(checkFn)) : (checkFn(b));
        }
        return false;
      },

      $contains: function (a, b) {
        var checkFn = containsCheckFn(a);
        if (checkFn !== null) {
          return (Array.isArray(b)) ? (b.every(checkFn)) : (checkFn(b));
        }
        return false;
      },

      $type: function (a, b) {
        var type = typeof a;
        if (type === 'object') {
          if (Array.isArray(a)) {
            type = 'array';
          } else if (a instanceof Date) {
            type = 'date';
          }
        }
        return (typeof b !== 'object') ? (type === b) : doQueryOp(type, b);
      },

      $size: function (a, b) {
        if (Array.isArray(a)) {
          return (typeof b !== 'object') ? (a.length === b) : doQueryOp(a.length, b);
        }
        return false;
      },

      $len: function (a, b) {
        if (typeof a === 'string') {
          return (typeof b !== 'object') ? (a.length === b) : doQueryOp(a.length, b);
        }
        return false;
      },

      $where: function (a, b) {
        return b(a) === true;
      },

      // field-level logical operators
      // a is the value in the collection
      // b is the nested query operation (for '$not')
      //   or an array of nested query operations (for '$and' and '$or')
      $not: function (a, b) {
        return !doQueryOp(a, b);
      },

      $and: function (a, b) {
        for (var idx = 0, len = b.length; idx < len; idx += 1) {
          if (!doQueryOp(a, b[idx])) {
            return false;
          }
        }
        return true;
      },

      $or: function (a, b) {
        for (var idx = 0, len = b.length; idx < len; idx += 1) {
          if (doQueryOp(a, b[idx])) {
            return true;
          }
        }
        return false;
      }
    };

    // making indexing opt-in... our range function knows how to deal with these ops :
    var indexedOpsList = ['$eq', '$aeq', '$dteq', '$gt', '$gte', '$lt', '$lte'];

    function clone(data, method) {
      var cloneMethod = method || 'parse-stringify',
        cloned;

      switch (cloneMethod) {
      case "parse-stringify":
        cloned = JSON.parse(JSON.stringify(data));
        break;
      case "jquery-extend-deep":
        cloned = jQuery.extend(true, {}, data);
        break;
      case "shallow":
        cloned = Object.create(data.prototype || null);
        Object.keys(data).map(function (i) {
          cloned[i] = data[i];
        });
        break;
      default:
        break;
      }

      //if (cloneMethod === 'parse-stringify') {
      //  cloned = JSON.parse(JSON.stringify(data));
      //}
      return cloned;
    }

    function cloneObjectArray(objarray, method) {
      var i,
        result = [];

      if (method == "parse-stringify") {
        return clone(objarray, method);
      }

      i = objarray.length - 1;

      for (; i <= 0; i--) {
        result.push(clone(objarray[i], method));
      }

      return result;
    }

    function localStorageAvailable() {
      try {
        return (window && window.localStorage !== undefined && window.localStorage !== null);
      } catch (e) {
        return false;
      }
    }


    /**
     * LokiEventEmitter is a minimalist version of EventEmitter. It enables any
     * constructor that inherits EventEmitter to emit events and trigger
     * listeners that have been added to the event through the on(event, callback) method
     *
     * @constructor LokiEventEmitter
     */
    function LokiEventEmitter() {}

    /**
     * @prop {hashmap} events - a hashmap, with each property being an array of callbacks
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.events = {};

    /**
     * @prop {boolean} asyncListeners - boolean determines whether or not the callbacks associated with each event
     * should happen in an async fashion or not
     * Default is false, which means events are synchronous
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.asyncListeners = false;

    /**
     * on(eventName, listener) - adds a listener to the queue of callbacks associated to an event
     * @param {string} eventName - the name of the event to listen to
     * @param {function} listener - callback function of listener to attach
     * @returns {int} the index of the callback in the array of listeners for a particular event
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.on = function (eventName, listener) {
      var event = this.events[eventName];
      if (!event) {
        event = this.events[eventName] = [];
      }
      event.push(listener);
      return listener;
    };

    /**
     * emit(eventName, data) - emits a particular event
     * with the option of passing optional parameters which are going to be processed by the callback
     * provided signatures match (i.e. if passing emit(event, arg0, arg1) the listener should take two parameters)
     * @param {string} eventName - the name of the event
     * @param {object=} data - optional object passed with the event
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.emit = function (eventName, data) {
      var self = this;
      if (eventName && this.events[eventName]) {
        this.events[eventName].forEach(function (listener) {
          if (self.asyncListeners) {
            setTimeout(function () {
              listener(data);
            }, 1);
          } else {
            listener(data);
          }

        });
      } else {
        throw new Error('No event ' + eventName + ' defined');
      }
    };

    /**
     * removeListener() - removes the listener at position 'index' from the event 'eventName'
     * @param {string} eventName - the name of the event which the listener is attached to
     * @param {function} listener - the listener callback function to remove from emitter
     * @memberof LokiEventEmitter
     */
    LokiEventEmitter.prototype.removeListener = function (eventName, listener) {
      if (this.events[eventName]) {
        var listeners = this.events[eventName];
        listeners.splice(listeners.indexOf(listener), 1);
      }
    };

    /**
     * Loki: The main database class
     * @constructor Loki
     * @implements LokiEventEmitter
     * @param {string} filename - name of the file to be saved to
     * @param {object=} options - (Optional) config options object
     * @param {string} options.env - override environment detection as 'NODEJS', 'BROWSER', 'CORDOVA'
     * @param {boolean} options.verbose - enable console output (default is 'false')
     * @param {boolean} options.autosave - enables autosave
     * @param {int} options.autosaveInterval - time interval (in milliseconds) between saves (if dirty)
     * @param {boolean} options.autoload - enables autoload on loki instantiation
     * @param {function} options.autoloadCallback - user callback called after database load
     * @param {adapter} options.adapter - an instance of a loki persistence adapter
     */
    function Loki(filename, options) {
      this.filename = filename || 'loki.db';
      this.collections = [];

      // persist version of code which created the database to the database.
      // could use for upgrade scenarios
      this.databaseVersion = 1.1;
      this.engineVersion = 1.1;

      // autosave support (disabled by default)
      // pass autosave: true, autosaveInterval: 6000 in options to set 6 second autosave
      this.autosave = false;
      this.autosaveInterval = 5000;
      this.autosaveHandle = null;

      this.options = {};

      // currently keeping persistenceMethod and persistenceAdapter as loki level properties that
      // will not or cannot be deserialized.  You are required to configure persistence every time
      // you instantiate a loki object (or use default environment detection) in order to load the database anyways.

      // persistenceMethod could be 'fs', 'localStorage', or 'adapter'
      // this is optional option param, otherwise environment detection will be used
      // if user passes their own adapter we will force this method to 'adapter' later, so no need to pass method option.
      this.persistenceMethod = null;

      // retain reference to optional (non-serializable) persistenceAdapter 'instance'
      this.persistenceAdapter = null;

      // enable console output if verbose flag is set (disabled by default)
      this.verbose = options && options.hasOwnProperty('verbose') ? options.verbose : false;

      this.events = {
        'init': [],
        'loaded': [],
        'flushChanges': [],
        'close': [],
        'changes': [],
        'warning': []
      };

      var getENV = function () {
        // if (typeof global !== 'undefined' && (global.android || global.NSObject)) {
        //   //If no adapter is set use the default nativescript adapter
        //   if (!options.adapter) {
        //     var LokiNativescriptAdapter = require('./loki-nativescript-adapter');
        //     options.adapter=new LokiNativescriptAdapter();
        //   }
        //   return 'NATIVESCRIPT'; //nativescript
        // }

        if (typeof window === 'undefined') {
          return 'NODEJS';
        }

        if (typeof global !== 'undefined' && global.window) {
          return 'NODEJS'; //node-webkit
        }

        if (typeof document !== 'undefined') {
          if (document.URL.indexOf('http://') === -1 && document.URL.indexOf('https://') === -1) {
            return 'CORDOVA';
          }
          return 'BROWSER';
        }
        return 'CORDOVA';
      };

      // refactored environment detection due to invalid detection for browser environments.
      // if they do not specify an options.env we want to detect env rather than default to nodejs.
      // currently keeping two properties for similar thing (options.env and options.persistenceMethod)
      //   might want to review whether we can consolidate.
      if (options && options.hasOwnProperty('env')) {
        this.ENV = options.env;
      } else {
        this.ENV = getENV();
      }

      // not sure if this is necessary now that i have refactored the line above
      if (this.ENV === 'undefined') {
        this.ENV = 'NODEJS';
      }

      //if (typeof (options) !== 'undefined') {
      this.configureOptions(options, true);
      //}

      this.on('init', this.clearChanges);

    }

    // db class is an EventEmitter
    Loki.prototype = new LokiEventEmitter();

    // experimental support for browserify's abstract syntax scan to pick up dependency of indexed adapter.
    // Hopefully, once this hits npm a browserify require of lokijs should scan the main file and detect this indexed adapter reference.
    Loki.prototype.getIndexedAdapter = function () {
      var adapter;

      if (typeof require === 'function') {
        adapter = require("./loki-indexed-adapter.js");
      }

      return adapter;
    };


    /**
     * Allows reconfiguring database options
     *
     * @param {object} options - configuration options to apply to loki db object
     * @param {string} options.env - override environment detection as 'NODEJS', 'BROWSER', 'CORDOVA'
     * @param {boolean} options.verbose - enable console output (default is 'false')
     * @param {boolean} options.autosave - enables autosave
     * @param {int} options.autosaveInterval - time interval (in milliseconds) between saves (if dirty)
     * @param {boolean} options.autoload - enables autoload on loki instantiation
     * @param {function} options.autoloadCallback - user callback called after database load
     * @param {adapter} options.adapter - an instance of a loki persistence adapter
     * @param {boolean} initialConfig - (internal) true is passed when loki ctor is invoking
     * @memberof Loki
     */
    Loki.prototype.configureOptions = function (options, initialConfig) {
      var defaultPersistence = {
          'NODEJS': 'fs',
          'BROWSER': 'localStorage',
          'CORDOVA': 'localStorage'
        },
        persistenceMethods = {
          'fs': LokiFsAdapter,
          'localStorage': LokiLocalStorageAdapter
        };

      this.options = {};

      this.persistenceMethod = null;
      // retain reference to optional persistence adapter 'instance'
      // currently keeping outside options because it can't be serialized
      this.persistenceAdapter = null;

      // process the options
      if (typeof (options) !== 'undefined') {
        this.options = options;


        if (this.options.hasOwnProperty('persistenceMethod')) {
          // check if the specified persistence method is known
          if (typeof (persistenceMethods[options.persistenceMethod]) == 'function') {
            this.persistenceMethod = options.persistenceMethod;
            this.persistenceAdapter = new persistenceMethods[options.persistenceMethod]();
          }
          // should be throw an error here, or just fall back to defaults ??
        }

        // if user passes adapter, set persistence mode to adapter and retain persistence adapter instance
        if (this.options.hasOwnProperty('adapter')) {
          this.persistenceMethod = 'adapter';
          this.persistenceAdapter = options.adapter;
          this.options.adapter = null;
        }


        // if they want to load database on loki instantiation, now is a good time to load... after adapter set and before possible autosave initiation
        if (options.autoload && initialConfig) {
          // for autoload, let the constructor complete before firing callback
          var self = this;
          setTimeout(function () {
            self.loadDatabase(options, options.autoloadCallback);
          }, 1);
        }

        if (this.options.hasOwnProperty('autosaveInterval')) {
          this.autosaveDisable();
          this.autosaveInterval = parseInt(this.options.autosaveInterval, 10);
        }

        if (this.options.hasOwnProperty('autosave') && this.options.autosave) {
          this.autosaveDisable();
          this.autosave = true;

          if (this.options.hasOwnProperty('autosaveCallback')) {
            this.autosaveEnable(options, options.autosaveCallback);
          } else {
            this.autosaveEnable();
          }
        }
      } // end of options processing

      // if by now there is no adapter specified by user nor derived from persistenceMethod: use sensible defaults
      if (this.persistenceAdapter === null) {
        this.persistenceMethod = defaultPersistence[this.ENV];
        if (this.persistenceMethod) {
          this.persistenceAdapter = new persistenceMethods[this.persistenceMethod]();
        }
      }

    };

    /**
     * Shorthand method for quickly creating and populating an anonymous collection.
     *    This collection is not referenced internally so upon losing scope it will be garbage collected.
     *
     * @example
     * var results = new loki().anonym(myDocArray).find({'age': {'$gt': 30} });
     *
     * @param {Array} docs - document array to initialize the anonymous collection with
     * @param {object} options - configuration object, see {@link Loki#addCollection} options
     * @returns {Collection} New collection which you can query or chain
     * @memberof Loki
     */
    Loki.prototype.anonym = function (docs, options) {
      var collection = new Collection('anonym', options);
      collection.insert(docs);

      if (this.verbose)
        collection.console = console;

      return collection;
    };

    /**
     * Adds a collection to the database.
     * @param {string} name - name of collection to add
     * @param {object=} options - (optional) options to configure collection with.
     * @param {array} options.unique - array of property names to define unique constraints for
     * @param {array} options.exact - array of property names to define exact constraints for
     * @param {array} options.indices - array property names to define binary indexes for
     * @param {boolean} options.asyncListeners - default is false
     * @param {boolean} options.disableChangesApi - default is true
     * @param {boolean} options.autoupdate - use Object.observe to update objects automatically (default: false)
     * @param {boolean} options.clone - specify whether inserts and queries clone to/from user
     * @param {string} options.cloneMethod - 'parse-stringify' (default), 'jquery-extend-deep', 'shallow'
     * @param {int} options.ttlInterval - time interval for clearing out 'aged' documents; not set by default.
     * @returns {Collection} a reference to the collection which was just added
     * @memberof Loki
     */
    Loki.prototype.addCollection = function (name, options) {
      var collection = new Collection(name, options);
      this.collections.push(collection);

      if (this.verbose)
        collection.console = console;

      return collection;
    };

    Loki.prototype.loadCollection = function (collection) {
      if (!collection.name) {
        throw new Error('Collection must have a name property to be loaded');
      }
      this.collections.push(collection);
    };

    /**
     * Retrieves reference to a collection by name.
     * @param {string} collectionName - name of collection to look up
     * @returns {Collection} Reference to collection in database by that name, or null if not found
     * @memberof Loki
     */
    Loki.prototype.getCollection = function (collectionName) {
      var i,
        len = this.collections.length;

      for (i = 0; i < len; i += 1) {
        if (this.collections[i].name === collectionName) {
          return this.collections[i];
        }
      }

      // no such collection
      this.emit('warning', 'collection ' + collectionName + ' not found');
      return null;
    };

    Loki.prototype.listCollections = function () {

      var i = this.collections.length,
        colls = [];

      while (i--) {
        colls.push({
          name: this.collections[i].name,
          type: this.collections[i].objType,
          count: this.collections[i].data.length
        });
      }
      return colls;
    };

    /**
     * Removes a collection from the database.
     * @param {string} collectionName - name of collection to remove
     * @memberof Loki
     */
    Loki.prototype.removeCollection = function (collectionName) {
      var i,
        len = this.collections.length;

      for (i = 0; i < len; i += 1) {
        if (this.collections[i].name === collectionName) {
          var tmpcol = new Collection(collectionName, {});
          var curcol = this.collections[i];
          for (var prop in curcol) {
            if (curcol.hasOwnProperty(prop) && tmpcol.hasOwnProperty(prop)) {
              curcol[prop] = tmpcol[prop];
            }
          }
          this.collections.splice(i, 1);
          return;
        }
      }
    };

    Loki.prototype.getName = function () {
      return this.name;
    };

    /**
     * serializeReplacer - used to prevent certain properties from being serialized
     *
     */
    Loki.prototype.serializeReplacer = function (key, value) {
      switch (key) {
      case 'autosaveHandle':
      case 'persistenceAdapter':
      case 'constraints':
        return null;
      default:
        return value;
      }
    };

    /**
     * Serialize database to a string which can be loaded via {@link Loki#loadJSON}
     *
     * @returns {string} Stringified representation of the loki database.
     * @memberof Loki
     */
    Loki.prototype.serialize = function () {
      return JSON.stringify(this, this.serializeReplacer);
    };
    // alias of serialize
    Loki.prototype.toJson = Loki.prototype.serialize;

    /**
     * Inflates a loki database from a serialized JSON string
     *
     * @param {string} serializedDb - a serialized loki database string
     * @param {object} options - apply or override collection level settings
     * @memberof Loki
     */
    Loki.prototype.loadJSON = function (serializedDb, options) {
      var dbObject;
      if (serializedDb.length === 0) {
        dbObject = {};
      } else {
        dbObject = JSON.parse(serializedDb);
      }

      this.loadJSONObject(dbObject, options);
    };

    /**
     * Inflates a loki database from a JS object
     *
     * @param {object} dbObject - a serialized loki database string
     * @param {object} options - apply or override collection level settings
     * @memberof Loki
     */
    Loki.prototype.loadJSONObject = function (dbObject, options) {
      var i = 0,
        len = dbObject.collections ? dbObject.collections.length : 0,
        coll,
        copyColl,
        clen,
        j;

      this.name = dbObject.name;

      // restore database version
      this.databaseVersion = 1.0;
      if (dbObject.hasOwnProperty('databaseVersion')) {
        this.databaseVersion = dbObject.databaseVersion;
      }

      this.collections = [];

      for (i; i < len; i += 1) {
        coll = dbObject.collections[i];
        copyColl = this.addCollection(coll.name);

        copyColl.transactional = coll.transactional;
        copyColl.asyncListeners = coll.asyncListeners;
        copyColl.disableChangesApi = coll.disableChangesApi;
        copyColl.cloneObjects = coll.cloneObjects;
        copyColl.cloneMethod = coll.cloneMethod || "parse-stringify";
        copyColl.autoupdate = coll.autoupdate;

        // load each element individually
        clen = coll.data.length;
        j = 0;
        if (options && options.hasOwnProperty(coll.name)) {

          var loader = options[coll.name].inflate ? options[coll.name].inflate : Utils.copyProperties;

          for (j; j < clen; j++) {
            var collObj = new(options[coll.name].proto)();
            loader(coll.data[j], collObj);
            copyColl.data[j] = collObj;
            copyColl.addAutoUpdateObserver(collObj);
          }
        } else {

          for (j; j < clen; j++) {
            copyColl.data[j] = coll.data[j];
            copyColl.addAutoUpdateObserver(copyColl.data[j]);
          }
        }

        copyColl.maxId = (coll.data.length === 0) ? 0 : coll.maxId;
        copyColl.idIndex = coll.idIndex;
        if (typeof (coll.binaryIndices) !== 'undefined') {
          copyColl.binaryIndices = coll.binaryIndices;
        }
        if (typeof coll.transforms !== 'undefined') {
          copyColl.transforms = coll.transforms;
        }

        copyColl.ensureId();

        // regenerate unique indexes
        copyColl.uniqueNames = [];
        if (coll.hasOwnProperty("uniqueNames")) {
          copyColl.uniqueNames = coll.uniqueNames;
          for (j = 0; j < copyColl.uniqueNames.length; j++) {
            copyColl.ensureUniqueIndex(copyColl.uniqueNames[j]);
          }
        }

        // in case they are loading a database created before we added dynamic views, handle undefined
        if (typeof (coll.DynamicViews) === 'undefined') continue;

        // reinflate DynamicViews and attached Resultsets
        for (var idx = 0; idx < coll.DynamicViews.length; idx++) {
          var colldv = coll.DynamicViews[idx];

          var dv = copyColl.addDynamicView(colldv.name, colldv.options);
          dv.resultdata = colldv.resultdata;
          dv.resultsdirty = colldv.resultsdirty;
          dv.filterPipeline = colldv.filterPipeline;

          dv.sortCriteria = colldv.sortCriteria;
          dv.sortFunction = null;

          dv.sortDirty = colldv.sortDirty;
          dv.resultset.filteredrows = colldv.resultset.filteredrows;
          dv.resultset.searchIsChained = colldv.resultset.searchIsChained;
          dv.resultset.filterInitialized = colldv.resultset.filterInitialized;

          dv.rematerialize({
            removeWhereFilters: true
          });
        }
      }
    };

    /**
     * Emits the close event. In autosave scenarios, if the database is dirty, this will save and disable timer.
     * Does not actually destroy the db.
     *
     * @param {function=} callback - (Optional) if supplied will be registered with close event before emitting.
     * @memberof Loki
     */
    Loki.prototype.close = function (callback) {
      // for autosave scenarios, we will let close perform final save (if dirty)
      // For web use, you might call from window.onbeforeunload to shutdown database, saving pending changes
      if (this.autosave) {
        this.autosaveDisable();
        if (this.autosaveDirty()) {
          this.saveDatabase(callback);
          callback = undefined;
        }
      }

      if (callback) {
        this.on('close', callback);
      }
      this.emit('close');
    };

    /**-------------------------+
    | Changes API               |
    +--------------------------*/

    /**
     * The Changes API enables the tracking the changes occurred in the collections since the beginning of the session,
     * so it's possible to create a differential dataset for synchronization purposes (possibly to a remote db)
     */

    /**
     * (Changes API) : takes all the changes stored in each
     * collection and creates a single array for the entire database. If an array of names
     * of collections is passed then only the included collections will be tracked.
     *
     * @param {array=} optional array of collection names. No arg means all collections are processed.
     * @returns {array} array of changes
     * @see private method createChange() in Collection
     * @memberof Loki
     */
    Loki.prototype.generateChangesNotification = function (arrayOfCollectionNames) {
      function getCollName(coll) {
        return coll.name;
      }
      var changes = [],
        selectedCollections = arrayOfCollectionNames || this.collections.map(getCollName);

      this.collections.forEach(function (coll) {
        if (selectedCollections.indexOf(getCollName(coll)) !== -1) {
          changes = changes.concat(coll.getChanges());
        }
      });
      return changes;
    };

    /**
     * (Changes API) - stringify changes for network transmission
     * @returns {string} string representation of the changes
     * @memberof Loki
     */
    Loki.prototype.serializeChanges = function (collectionNamesArray) {
      return JSON.stringify(this.generateChangesNotification(collectionNamesArray));
    };

    /**
     * (Changes API) : clears all the changes in all collections.
     * @memberof Loki
     */
    Loki.prototype.clearChanges = function () {
      this.collections.forEach(function (coll) {
        if (coll.flushChanges) {
          coll.flushChanges();
        }
      });
    };

    /*------------------+
    | PERSISTENCE       |
    -------------------*/


    /** there are two build in persistence adapters for internal use
     * fs             for use in Nodejs type environments
     * localStorage   for use in browser environment
     * defined as helper classes here so its easy and clean to use
     */

    /**
     * A loki persistence adapter which persists using node fs module
     * @constructor LokiFsAdapter
     */
    function LokiFsAdapter() {
      this.fs = require('fs');
    }

    /**
     * loadDatabase() - Load data from file, will throw an error if the file does not exist
     * @param {string} dbname - the filename of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiFsAdapter
     */
    LokiFsAdapter.prototype.loadDatabase = function loadDatabase(dbname, callback) {
      this.fs.readFile(dbname, {
        encoding: 'utf8'
      }, function readFileCallback(err, data) {
        if (err) {
          callback(new Error(err));
        } else {
          callback(data);
        }
      });
    };

    /**
     * saveDatabase() - save data to file, will throw an error if the file can't be saved
     * might want to expand this to avoid dataloss on partial save
     * @param {string} dbname - the filename of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiFsAdapter
     */
    LokiFsAdapter.prototype.saveDatabase = function saveDatabase(dbname, dbstring, callback) {
      this.fs.writeFile(dbname, dbstring, callback);
    };

    /**
     * deleteDatabase() - delete the database file, will throw an error if the
     * file can't be deleted
     * @param {string} dbname - the filename of the database to delete
     * @param {function} callback - the callback to handle the result
     * @memberof LokiFsAdapter
     */
    LokiFsAdapter.prototype.deleteDatabase = function deleteDatabase(dbname, callback) {
      this.fs.unlink(dbname, function deleteDatabaseCallback(err) {
        if (err) {
          callback(new Error(err));
        } else {
          callback();
        }
      });
    };


    /**
     * A loki persistence adapter which persists to web browser's local storage object
     * @constructor LokiLocalStorageAdapter
     */
    function LokiLocalStorageAdapter() {}

    /**
     * loadDatabase() - Load data from localstorage
     * @param {string} dbname - the name of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiLocalStorageAdapter
     */
    LokiLocalStorageAdapter.prototype.loadDatabase = function loadDatabase(dbname, callback) {
      if (localStorageAvailable()) {
        callback(localStorage.getItem(dbname));
      } else {
        callback(new Error('localStorage is not available'));
      }
    };

    /**
     * saveDatabase() - save data to localstorage, will throw an error if the file can't be saved
     * might want to expand this to avoid dataloss on partial save
     * @param {string} dbname - the filename of the database to load
     * @param {function} callback - the callback to handle the result
     * @memberof LokiLocalStorageAdapter
     */
    LokiLocalStorageAdapter.prototype.saveDatabase = function saveDatabase(dbname, dbstring, callback) {
      if (localStorageAvailable()) {
        localStorage.setItem(dbname, dbstring);
        callback(null);
      } else {
        callback(new Error('localStorage is not available'));
      }
    };

    /**
     * deleteDatabase() - delete the database from localstorage, will throw an error if it
     * can't be deleted
     * @param {string} dbname - the filename of the database to delete
     * @param {function} callback - the callback to handle the result
     * @memberof LokiLocalStorageAdapter
     */
    LokiLocalStorageAdapter.prototype.deleteDatabase = function deleteDatabase(dbname, callback) {
      if (localStorageAvailable()) {
        localStorage.removeItem(dbname);
        callback(null);
      } else {
        callback(new Error('localStorage is not available'));
      }
    };

    /**
     * Handles loading from file system, local storage, or adapter (indexeddb)
     *    This method utilizes loki configuration options (if provided) to determine which
     *    persistence method to use, or environment detection (if configuration was not provided).
     *
     * @param {object} options - not currently used (remove or allow overrides?)
     * @param {function=} callback - (Optional) user supplied async callback / error handler
     * @memberof Loki
     */
    Loki.prototype.loadDatabase = function (options, callback) {
      var cFun = callback || function (err, data) {
          if (err) {
            throw err;
          }
        },
        self = this;

      // the persistenceAdapter should be present if all is ok, but check to be sure.
      if (this.persistenceAdapter !== null) {

        this.persistenceAdapter.loadDatabase(this.filename, function loadDatabaseCallback(dbString) {
          if (typeof (dbString) === 'string') {
            var parseSuccess = false;
            try {
              self.loadJSON(dbString, options || {});
              parseSuccess = true;
            } catch (err) {
              cFun(err);
            }
            if (parseSuccess) {
              cFun(null);
              self.emit('loaded', 'database ' + self.filename + ' loaded');
            }
          } else {
            // if adapter has returned an js object (other than null or error) attempt to load from JSON object
            if (typeof (dbString) === "object" && dbString !== null && !(dbString instanceof Error)) {
              self.loadJSONObject(dbString, options || {});
              cFun(null); // return null on success
              self.emit('loaded', 'database ' + self.filename + ' loaded');
            } else {
              // error from adapter (either null or instance of error), pass on to 'user' callback
              cFun(dbString);
            }
          }
        });

      } else {
        cFun(new Error('persistenceAdapter not configured'));
      }
    };

    /**
     * Handles saving to file system, local storage, or adapter (indexeddb)
     *    This method utilizes loki configuration options (if provided) to determine which
     *    persistence method to use, or environment detection (if configuration was not provided).
     *
     * @param {function=} callback - (Optional) user supplied async callback / error handler
     * @memberof Loki
     */
    Loki.prototype.saveDatabase = function (callback) {
      var cFun = callback || function (err) {
          if (err) {
            throw err;
          }
          return;
        },
        self = this;

      // the persistenceAdapter should be present if all is ok, but check to be sure.
      if (this.persistenceAdapter !== null) {
        // check if the adapter is requesting (and supports) a 'reference' mode export
        if (this.persistenceAdapter.mode === "reference" && typeof this.persistenceAdapter.exportDatabase === "function") {
          // filename may seem redundant but loadDatabase will need to expect this same filename
          this.persistenceAdapter.exportDatabase(this.filename, this, function exportDatabaseCallback(err) {
            self.autosaveClearFlags();
            cFun(err);
          });
        }
        // otherwise just pass the serialized database to adapter
        else {
          this.persistenceAdapter.saveDatabase(this.filename, self.serialize(), function saveDatabasecallback(err) {
            self.autosaveClearFlags();
            cFun(err);
          });
        }
      } else {
        cFun(new Error('persistenceAdapter not configured'));
      }
    };

    // alias
    Loki.prototype.save = Loki.prototype.saveDatabase;

    /**
     * Handles deleting a database from file system, local
     *    storage, or adapter (indexeddb)
     *    This method utilizes loki configuration options (if provided) to determine which
     *    persistence method to use, or environment detection (if configuration was not provided).
     *
     * @param {object} options - not currently used (remove or allow overrides?)
     * @param {function=} callback - (Optional) user supplied async callback / error handler
     * @memberof Loki
     */
    Loki.prototype.deleteDatabase = function (options, callback) {
      var cFun = callback || function (err, data) {
        if (err) {
          throw err;
        }
      };

      // the persistenceAdapter should be present if all is ok, but check to be sure.
      if (this.persistenceAdapter !== null) {
        this.persistenceAdapter.deleteDatabase(this.filename, function deleteDatabaseCallback(err) {
          cFun(err);
        });
      } else {
        cFun(new Error('persistenceAdapter not configured'));
      }
    };

    /**
     * autosaveDirty - check whether any collections are 'dirty' meaning we need to save (entire) database
     *
     * @returns {boolean} - true if database has changed since last autosave, false if not.
     */
    Loki.prototype.autosaveDirty = function () {
      for (var idx = 0; idx < this.collections.length; idx++) {
        if (this.collections[idx].dirty) {
          return true;
        }
      }

      return false;
    };

    /**
     * autosaveClearFlags - resets dirty flags on all collections.
     *    Called from saveDatabase() after db is saved.
     *
     */
    Loki.prototype.autosaveClearFlags = function () {
      for (var idx = 0; idx < this.collections.length; idx++) {
        this.collections[idx].dirty = false;
      }
    };

    /**
     * autosaveEnable - begin a javascript interval to periodically save the database.
     *
     * @param {object} options - not currently used (remove or allow overrides?)
     * @param {function=} callback - (Optional) user supplied async callback
     */
    Loki.prototype.autosaveEnable = function (options, callback) {
      this.autosave = true;

      var delay = 5000,
        self = this;

      if (typeof (this.autosaveInterval) !== 'undefined' && this.autosaveInterval !== null) {
        delay = this.autosaveInterval;
      }

      this.autosaveHandle = setInterval(function autosaveHandleInterval() {
        // use of dirty flag will need to be hierarchical since mods are done at collection level with no visibility of 'db'
        // so next step will be to implement collection level dirty flags set on insert/update/remove
        // along with loki level isdirty() function which iterates all collections to see if any are dirty

        if (self.autosaveDirty()) {
          self.saveDatabase(callback);
        }
      }, delay);
    };

    /**
     * autosaveDisable - stop the autosave interval timer.
     *
     */
    Loki.prototype.autosaveDisable = function () {
      if (typeof (this.autosaveHandle) !== 'undefined' && this.autosaveHandle !== null) {
        clearInterval(this.autosaveHandle);
        this.autosaveHandle = null;
      }
    };


    /**
     * Resultset class allowing chainable queries.  Intended to be instanced internally.
     *    Collection.find(), Collection.where(), and Collection.chain() instantiate this.
     *
     * @example
     *    mycollection.chain()
     *      .find({ 'doors' : 4 })
     *      .where(function(obj) { return obj.name === 'Toyota' })
     *      .data();
     *
     * @constructor Resultset
     * @param {Collection} collection - The collection which this Resultset will query against.
     * @param {Object=} options - Object containing one or more options.
     * @param {string} options.queryObj - Optional mongo-style query object to initialize resultset with.
     * @param {function} options.queryFunc - Optional javascript filter function to initialize resultset with.
     * @param {bool} options.firstOnly - Optional boolean used by collection.findOne().
     */
    function Resultset(collection, options) {
      options = options || {};

      options.queryObj = options.queryObj || null;
      options.queryFunc = options.queryFunc || null;
      options.firstOnly = options.firstOnly || false;

      // retain reference to collection we are querying against
      this.collection = collection;

      // if chain() instantiates with null queryObj and queryFunc, so we will keep flag for later
      this.searchIsChained = (!options.queryObj && !options.queryFunc);
      this.filteredrows = [];
      this.filterInitialized = false;

      // if user supplied initial queryObj or queryFunc, apply it
      if (typeof (options.queryObj) !== "undefined" && options.queryObj !== null) {
        return this.find(options.queryObj, options.firstOnly);
      }
      if (typeof (options.queryFunc) !== "undefined" && options.queryFunc !== null) {
        return this.where(options.queryFunc);
      }

      // otherwise return unfiltered Resultset for future filtering
      return this;
    }

    /**
     * reset() - Reset the resultset to its initial state.
     *
     * @returns {Resultset} Reference to this resultset, for future chain operations.
     */
    Resultset.prototype.reset = function () {
      if (this.filteredrows.length > 0) {
        this.filteredrows = [];
      }
      this.filterInitialized = false;
      return this;
    };

    /**
     * toJSON() - Override of toJSON to avoid circular references
     *
     */
    Resultset.prototype.toJSON = function () {
      var copy = this.copy();
      copy.collection = null;
      return copy;
    };

    /**
     * Allows you to limit the number of documents passed to next chain operation.
     *    A resultset copy() is made to avoid altering original resultset.
     *
     * @param {int} qty - The number of documents to return.
     * @returns {Resultset} Returns a copy of the resultset, limited by qty, for subsequent chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.limit = function (qty) {
      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var rscopy = new Resultset(this.collection);
      rscopy.filteredrows = this.filteredrows.slice(0, qty);
      rscopy.filterInitialized = true;
      return rscopy;
    };

    /**
     * Used for skipping 'pos' number of documents in the resultset.
     *
     * @param {int} pos - Number of documents to skip; all preceding documents are filtered out.
     * @returns {Resultset} Returns a copy of the resultset, containing docs starting at 'pos' for subsequent chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.offset = function (pos) {
      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var rscopy = new Resultset(this.collection);
      rscopy.filteredrows = this.filteredrows.slice(pos);
      rscopy.filterInitialized = true;
      return rscopy;
    };

    /**
     * copy() - To support reuse of resultset in branched query situations.
     *
     * @returns {Resultset} Returns a copy of the resultset (set) but the underlying document references will be the same.
     * @memberof Resultset
     */
    Resultset.prototype.copy = function () {
      var result = new Resultset(this.collection);

      if (this.filteredrows.length > 0) {
        result.filteredrows = this.filteredrows.slice();
      }
      result.filterInitialized = this.filterInitialized;

      return result;
    };

    /**
     * Alias of copy()
     * @memberof Resultset
     */
    Resultset.prototype.branch = Resultset.prototype.copy;

    /**
     * transform() - executes a named collection transform or raw array of transform steps against the resultset.
     *
     * @param transform {(string|array)} - name of collection transform or raw transform array
     * @param parameters {object=} - (Optional) object property hash of parameters, if the transform requires them.
     * @returns {Resultset} either (this) resultset or a clone of of this resultset (depending on steps)
     * @memberof Resultset
     */
    Resultset.prototype.transform = function (transform, parameters) {
      var idx,
        step,
        rs = this;

      // if transform is name, then do lookup first
      if (typeof transform === 'string') {
        if (this.collection.transforms.hasOwnProperty(transform)) {
          transform = this.collection.transforms[transform];
        }
      }

      // either they passed in raw transform array or we looked it up, so process
      if (typeof transform !== 'object' || !Array.isArray(transform)) {
        throw new Error("Invalid transform");
      }

      if (typeof parameters !== 'undefined') {
        transform = Utils.resolveTransformParams(transform, parameters);
      }

      for (idx = 0; idx < transform.length; idx++) {
        step = transform[idx];

        switch (step.type) {
        case "find":
          rs.find(step.value);
          break;
        case "where":
          rs.where(step.value);
          break;
        case "simplesort":
          rs.simplesort(step.property, step.desc);
          break;
        case "compoundsort":
          rs.compoundsort(step.value);
          break;
        case "sort":
          rs.sort(step.value);
          break;
        case "limit":
          rs = rs.limit(step.value);
          break; // limit makes copy so update reference
        case "offset":
          rs = rs.offset(step.value);
          break; // offset makes copy so update reference
        case "map":
          rs = rs.map(step.value);
          break;
        case "eqJoin":
          rs = rs.eqJoin(step.joinData, step.leftJoinKey, step.rightJoinKey, step.mapFun);
          break;
          // following cases break chain by returning array data so make any of these last in transform steps
        case "mapReduce":
          rs = rs.mapReduce(step.mapFunction, step.reduceFunction);
          break;
          // following cases update documents in current filtered resultset (use carefully)
        case "update":
          rs.update(step.value);
          break;
        case "remove":
          rs.remove();
          break;
        default:
          break;
        }
      }

      return rs;
    };

    /**
     * User supplied compare function is provided two documents to compare. (chainable)
     * @example
     *    rslt.sort(function(obj1, obj2) {
     *      if (obj1.name === obj2.name) return 0;
     *      if (obj1.name > obj2.name) return 1;
     *      if (obj1.name < obj2.name) return -1;
     *    });
     *
     * @param {function} comparefun - A javascript compare function used for sorting.
     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.
     * @memberof Resultset
     */
    Resultset.prototype.sort = function (comparefun) {
      // if this is chained resultset with no filters applied, just we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var wrappedComparer =
        (function (userComparer, data) {
          return function (a, b) {
            return userComparer(data[a], data[b]);
          };
        })(comparefun, this.collection.data);

      this.filteredrows.sort(wrappedComparer);

      return this;
    };

    /**
     * Simpler, loose evaluation for user to sort based on a property name. (chainable).
     *    Sorting based on the same lt/gt helper functions used for binary indices.
     *
     * @param {string} propname - name of property to sort by.
     * @param {bool=} isdesc - (Optional) If true, the property will be sorted in descending order
     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.
     * @memberof Resultset
     */
    Resultset.prototype.simplesort = function (propname, isdesc) {
      // if this is chained resultset with no filters applied, just we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      if (typeof (isdesc) === 'undefined') {
        isdesc = false;
      }

      var wrappedComparer =
        (function (prop, desc, data) {
          return function (a, b) {
            return sortHelper(data[a][prop], data[b][prop], desc);
          };
        })(propname, isdesc, this.collection.data);

      this.filteredrows.sort(wrappedComparer);

      return this;
    };

    /**
     * Allows sorting a resultset based on multiple columns.
     * @example
     * // to sort by age and then name (both ascending)
     * rs.compoundsort(['age', 'name']);
     * // to sort by age (ascending) and then by name (descending)
     * rs.compoundsort(['age', ['name', true]);
     *
     * @param {array} properties - array of property names or subarray of [propertyname, isdesc] used evaluate sort order
     * @returns {Resultset} Reference to this resultset, sorted, for future chain operations.
     * @memberof Resultset
     */
    Resultset.prototype.compoundsort = function (properties) {
      if (properties.length === 0) {
        throw new Error("Invalid call to compoundsort, need at least one property");
      }

      var prop;
      if (properties.length === 1) {
        prop = properties[0];
        if (Array.isArray(prop)) {
          return this.simplesort(prop[0], prop[1]);
        }
        return this.simplesort(prop, false);
      }

      // unify the structure of 'properties' to avoid checking it repeatedly while sorting
      for (var i = 0, len = properties.length; i < len; i += 1) {
        prop = properties[i];
        if (!Array.isArray(prop)) {
          properties[i] = [prop, false];
        }
      }

      // if this is chained resultset with no filters applied, just we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var wrappedComparer =
        (function (props, data) {
          return function (a, b) {
            return compoundeval(props, data[a], data[b]);
          };
        })(properties, this.collection.data);

      this.filteredrows.sort(wrappedComparer);

      return this;
    };

    /**
     * calculateRange() - Binary Search utility method to find range/segment of values matching criteria.
     *    this is used for collection.find() and first find filter of resultset/dynview
     *    slightly different than get() binary search in that get() hones in on 1 value,
     *    but we have to hone in on many (range)
     * @param {string} op - operation, such as $eq
     * @param {string} prop - name of property to calculate range for
     * @param {object} val - value to use for range calculation.
     * @returns {array} [start, end] index array positions
     */
    Resultset.prototype.calculateRange = function (op, prop, val) {
      var rcd = this.collection.data;
      var index = this.collection.binaryIndices[prop].values;
      var min = 0;
      var max = index.length - 1;
      var mid = 0;

      // when no documents are in collection, return empty range condition
      if (rcd.length === 0) {
        return [0, -1];
      }

      var minVal = rcd[index[min]][prop];
      var maxVal = rcd[index[max]][prop];

      // if value falls outside of our range return [0, -1] to designate no results
      switch (op) {
      case '$eq':
      case '$aeq':
        if (ltHelper(val, minVal, false) || gtHelper(val, maxVal, false)) {
          return [0, -1];
        }
        break;
      case '$dteq':
        if (ltHelper(val, minVal, false) || gtHelper(val, maxVal, false)) {
          return [0, -1];
        }
        break;
      case '$gt':
        if (gtHelper(val, maxVal, true)) {
          return [0, -1];
        }
        break;
      case '$gte':
        if (gtHelper(val, maxVal, false)) {
          return [0, -1];
        }
        break;
      case '$lt':
        if (ltHelper(val, minVal, true)) {
          return [0, -1];
        }
        if (ltHelper(maxVal, val, false)) {
          return [0, rcd.length - 1];
        }
        break;
      case '$lte':
        if (ltHelper(val, minVal, false)) {
          return [0, -1];
        }
        if (ltHelper(maxVal, val, true)) {
          return [0, rcd.length - 1];
        }
        break;
      }

      // hone in on start position of value
      while (min < max) {
        mid = (min + max) >> 1;

        if (ltHelper(rcd[index[mid]][prop], val, false)) {
          min = mid + 1;
        } else {
          max = mid;
        }
      }

      var lbound = min;

      // do not reset min, as the upper bound cannot be prior to the found low bound
      max = index.length - 1;

      // hone in on end position of value
      while (min < max) {
        mid = (min + max) >> 1;

        if (ltHelper(val, rcd[index[mid]][prop], false)) {
          max = mid;
        } else {
          min = mid + 1;
        }
      }

      var ubound = max;

      var lval = rcd[index[lbound]][prop];
      var uval = rcd[index[ubound]][prop];

      switch (op) {
      case '$eq':
        if (lval !== val) {
          return [0, -1];
        }
        if (uval !== val) {
          ubound--;
        }

        return [lbound, ubound];
      case '$dteq':
        if (lval > val || lval < val) {
          return [0, -1];
        }
        if (uval > val || uval < val) {
          ubound--;
        }

        return [lbound, ubound];


      case '$gt':
        if (ltHelper(uval, val, true)) {
          return [0, -1];
        }

        return [ubound, rcd.length - 1];

      case '$gte':
        if (ltHelper(lval, val, false)) {
          return [0, -1];
        }

        return [lbound, rcd.length - 1];

      case '$lt':
        if (lbound === 0 && ltHelper(lval, val, false)) {
          return [0, 0];
        }
        return [0, lbound - 1];

      case '$lte':
        if (uval !== val) {
          ubound--;
        }

        if (ubound === 0 && ltHelper(uval, val, false)) {
          return [0, 0];
        }
        return [0, ubound];

      default:
        return [0, rcd.length - 1];
      }
    };

    /**
     * findOr() - oversee the operation of OR'ed query expressions.
     *    OR'ed expression evaluation runs each expression individually against the full collection,
     *    and finally does a set OR on each expression's results.
     *    Each evaluation can utilize a binary index to prevent multiple linear array scans.
     *
     * @param {array} expressionArray - array of expressions
     * @returns {Resultset} this resultset for further chain ops.
     */
    Resultset.prototype.findOr = function (expressionArray) {
      var fr = null,
        fri = 0,
        frlen = 0,
        docset = [],
        idxset = [],
        idx = 0,
        origCount = this.count();

      // If filter is already initialized, then we query against only those items already in filter.
      // This means no index utilization for fields, so hopefully its filtered to a smallish filteredrows.
      for (var ei = 0, elen = expressionArray.length; ei < elen; ei++) {
        // we need to branch existing query to run each filter separately and combine results
        fr = this.branch().find(expressionArray[ei]).filteredrows;
        frlen = fr.length;
        // if the find operation did not reduce the initial set, then the initial set is the actual result
        if (frlen === origCount) {
          return this;
        }

        // add any document 'hits'
        for (fri = 0; fri < frlen; fri++) {
          idx = fr[fri];
          if (idxset[idx] === undefined) {
            idxset[idx] = true;
            docset.push(idx);
          }
        }
      }

      this.filteredrows = docset;
      this.filterInitialized = true;

      return this;
    };
    Resultset.prototype.$or = Resultset.prototype.findOr;

    /**
     * findAnd() - oversee the operation of AND'ed query expressions.
     *    AND'ed expression evaluation runs each expression progressively against the full collection,
     *    internally utilizing existing chained resultset functionality.
     *    Only the first filter can utilize a binary index.
     *
     * @param {array} expressionArray - array of expressions
     * @returns {Resultset} this resultset for further chain ops.
     */
    Resultset.prototype.findAnd = function (expressionArray) {
      // we have already implementing method chaining in this (our Resultset class)
      // so lets just progressively apply user supplied and filters
      for (var i = 0, len = expressionArray.length; i < len; i++) {
        if (this.count() === 0) {
          return this;
        }
        this.find(expressionArray[i]);
      }
      return this;
    };
    Resultset.prototype.$and = Resultset.prototype.findAnd;

    /**
     * Used for querying via a mongo-style query object.
     *
     * @param {object} query - A mongo-style query object used for filtering current results.
     * @param {boolean=} firstOnly - (Optional) Used by collection.findOne()
     * @returns {Resultset} this resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.find = function (query, firstOnly) {
      if (this.collection.data.length === 0) {
        if (this.searchIsChained) {
          this.filteredrows = [];
          this.filterInitialized = true;
          return this;
        }
        return [];
      }

      var queryObject = query || 'getAll',
        p,
        property,
        queryObjectOp,
        operator,
        value,
        key,
        searchByIndex = false,
        result = [],
        index = null;

      // if this was note invoked via findOne()
      firstOnly = firstOnly || false;

      if (typeof queryObject === 'object') {
        for (p in queryObject) {
          if (hasOwnProperty.call(queryObject, p)) {
            property = p;
            queryObjectOp = queryObject[p];
            break;
          }
        }
      }

      // apply no filters if they want all
      if (!property || queryObject === 'getAll') {
        // Chained queries can just do coll.chain().data() but let's
        // be versatile and allow this also coll.chain().find().data()

        // If a chained search, simply leave everything as-is.
        // Note: If no filter at this point, it will be properly
        // created by the follow-up queries or sorts that need it.
        // If not chained, then return the collection data array copy.
        return (this.searchIsChained) ? (this) : (this.collection.data.slice());
      }

      // injecting $and and $or expression tree evaluation here.
      if (property === '$and' || property === '$or') {
        if (this.searchIsChained) {
          this[property](queryObjectOp);

          // for chained find with firstonly,
          if (firstOnly && this.filteredrows.length > 1) {
            this.filteredrows = this.filteredrows.slice(0, 1);
          }

          return this;
        } else {
          // our $and operation internally chains filters
          result = this.collection.chain()[property](queryObjectOp).data();

          // if this was coll.findOne() return first object or empty array if null
          // since this is invoked from a constructor we can't return null, so we will
          // make null in coll.findOne();
          if (firstOnly) {
            return (result.length === 0) ? ([]) : (result[0]);
          }

          // not first only return all results
          return result;
        }
      }

      // see if query object is in shorthand mode (assuming eq operator)
      if (queryObjectOp === null || (typeof queryObjectOp !== 'object' || queryObjectOp instanceof Date)) {
        operator = '$eq';
        value = queryObjectOp;
      } else if (typeof queryObjectOp === 'object') {
        for (key in queryObjectOp) {
          if (hasOwnProperty.call(queryObjectOp, key)) {
            operator = key;
            value = queryObjectOp[key];
            break;
          }
        }
      } else {
        throw new Error('Do not know what you want to do.');
      }

      // for regex ops, precompile
      if (operator === '$regex') {
        if (Array.isArray(value)) {
          value = new RegExp(value[0], value[1]);
        } else if (!(value instanceof RegExp)) {
          value = new RegExp(value);
        }
      }

      // if user is deep querying the object such as find('name.first': 'odin')
      var usingDotNotation = (property.indexOf('.') !== -1);

      // if an index exists for the property being queried against, use it
      // for now only enabling for non-chained query (who's set of docs matches index)
      // or chained queries where it is the first filter applied and prop is indexed
      var doIndexCheck = !usingDotNotation &&
        (!this.searchIsChained || !this.filterInitialized);

      if (doIndexCheck && this.collection.binaryIndices[property] &&
        indexedOpsList.indexOf(operator) !== -1) {
        // this is where our lazy index rebuilding will take place
        // basically we will leave all indexes dirty until we need them
        // so here we will rebuild only the index tied to this property
        // ensureIndex() will only rebuild if flagged as dirty since we are not passing force=true param
        this.collection.ensureIndex(property);

        searchByIndex = true;
        index = this.collection.binaryIndices[property];
      }

      // the comparison function
      var fun = LokiOps[operator];

      // "shortcut" for collection data
      var t = this.collection.data;
      // filter data length
      var i = 0;

      // Query executed differently depending on :
      //    - whether it is chained or not
      //    - whether the property being queried has an index defined
      //    - if chained, we handle first pass differently for initial filteredrows[] population
      //
      // For performance reasons, each case has its own if block to minimize in-loop calculations

      // If not a chained query, bypass filteredrows and work directly against data
      if (!this.searchIsChained) {
        if (!searchByIndex) {
          i = t.length;

          if (firstOnly) {
            if (usingDotNotation) {
              property = property.split('.');
              while (i--) {
                if (dotSubScan(t[i], property, fun, value)) {
                  return (t[i]);
                }
              }
            } else {
              while (i--) {
                if (fun(t[i][property], value)) {
                  return (t[i]);
                }
              }
            }

            return [];
          }

          // if using dot notation then treat property as keypath such as 'name.first'.
          // currently supporting dot notation for non-indexed conditions only
          if (usingDotNotation) {
            property = property.split('.');
            while (i--) {
              if (dotSubScan(t[i], property, fun, value)) {
                result.push(t[i]);
              }
            }
          } else {
            while (i--) {
              if (fun(t[i][property], value)) {
                result.push(t[i]);
              }
            }
          }
        } else {
          // searching by binary index via calculateRange() utility method
          var seg = this.calculateRange(operator, property, value);

          // not chained so this 'find' was designated in Resultset constructor
          // so return object itself
          if (firstOnly) {
            if (seg[1] !== -1) {
              return t[index.values[seg[0]]];
            }
            return [];
          }

          for (i = seg[0]; i <= seg[1]; i++) {
            result.push(t[index.values[i]]);
          }
        }

        // not a chained query so return result as data[]
        return result;
      }


      // Otherwise this is a chained query

      var filter, rowIdx = 0;

      // If the filteredrows[] is already initialized, use it
      if (this.filterInitialized) {
        filter = this.filteredrows;
        i = filter.length;

        // currently supporting dot notation for non-indexed conditions only
        if (usingDotNotation) {
          property = property.split('.');
          while (i--) {
            rowIdx = filter[i];
            if (dotSubScan(t[rowIdx], property, fun, value)) {
              result.push(rowIdx);
            }
          }
        } else {
          while (i--) {
            rowIdx = filter[i];
            if (fun(t[rowIdx][property], value)) {
              result.push(rowIdx);
            }
          }
        }
      }
      // first chained query so work against data[] but put results in filteredrows
      else {
        // if not searching by index
        if (!searchByIndex) {
          i = t.length;

          if (usingDotNotation) {
            property = property.split('.');
            while (i--) {
              if (dotSubScan(t[i], property, fun, value)) {
                result.push(i);
              }
            }
          } else {
            while (i--) {
              if (fun(t[i][property], value)) {
                result.push(i);
              }
            }
          }
        } else {
          // search by index
          var segm = this.calculateRange(operator, property, value);

          for (i = segm[0]; i <= segm[1]; i++) {
            result.push(index.values[i]);
          }
        }

        this.filterInitialized = true; // next time work against filteredrows[]
      }

      this.filteredrows = result;
      return this;
    };


    /**
     * where() - Used for filtering via a javascript filter function.
     *
     * @param {function} fun - A javascript function used for filtering current results by.
     * @returns {Resultset} this resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.where = function (fun) {
      var viewFunction,
        result = [];

      if ('function' === typeof fun) {
        viewFunction = fun;
      } else {
        throw new TypeError('Argument is not a stored view or a function');
      }
      try {
        // if not a chained query then run directly against data[] and return object []
        if (!this.searchIsChained) {
          var i = this.collection.data.length;

          while (i--) {
            if (viewFunction(this.collection.data[i]) === true) {
              result.push(this.collection.data[i]);
            }
          }

          // not a chained query so returning result as data[]
          return result;
        }
        // else chained query, so run against filteredrows
        else {
          // If the filteredrows[] is already initialized, use it
          if (this.filterInitialized) {
            var j = this.filteredrows.length;

            while (j--) {
              if (viewFunction(this.collection.data[this.filteredrows[j]]) === true) {
                result.push(this.filteredrows[j]);
              }
            }

            this.filteredrows = result;

            return this;
          }
          // otherwise this is initial chained op, work against data, push into filteredrows[]
          else {
            var k = this.collection.data.length;

            while (k--) {
              if (viewFunction(this.collection.data[k]) === true) {
                result.push(k);
              }
            }

            this.filteredrows = result;
            this.filterInitialized = true;

            return this;
          }
        }
      } catch (err) {
        throw err;
      }
    };

    /**
     * count() - returns the number of documents in the resultset.
     *
     * @returns {number} The number of documents in the resultset.
     * @memberof Resultset
     */
    Resultset.prototype.count = function () {
      if (this.searchIsChained && this.filterInitialized) {
        return this.filteredrows.length;
      }
      return this.collection.count();
    };

    /**
     * Terminates the chain and returns array of filtered documents
     *
     * @param {object=} options - allows specifying 'forceClones' and 'forceCloneMethod' options.
     * @param {boolean} options.forceClones - Allows forcing the return of cloned objects even when
     *        the collection is not configured for clone object.
     * @param {string} options.forceCloneMethod - Allows overriding the default or collection specified cloning method.
     *        Possible values include 'parse-stringify', 'jquery-extend-deep', and 'shallow'
     *
     * @returns {array} Array of documents in the resultset
     * @memberof Resultset
     */
    Resultset.prototype.data = function (options) {
      var result = [],
        data = this.collection.data,
        len,
        i,
        method;

      options = options || {};

      // if this is chained resultset with no filters applied, just return collection.data
      if (this.searchIsChained && !this.filterInitialized) {
        if (this.filteredrows.length === 0) {
          // determine whether we need to clone objects or not
          if (this.collection.cloneObjects || options.forceClones) {
            len = data.length;
            method = options.forceCloneMethod || this.collection.cloneMethod;

            for (i = 0; i < len; i++) {
              result.push(clone(data[i], method));
            }
            return result;
          }
          // otherwise we are not cloning so return sliced array with same object references
          else {
            return data.slice();
          }
        } else {
          // filteredrows must have been set manually, so use it
          this.filterInitialized = true;
        }
      }

      var fr = this.filteredrows;
      len = fr.length;

      if (this.collection.cloneObjects || options.forceClones) {
        method = options.forceCloneMethod || this.collection.cloneMethod;
        for (i = 0; i < len; i++) {
          result.push(clone(data[fr[i]], method));
        }
      } else {
        for (i = 0; i < len; i++) {
          result.push(data[fr[i]]);
        }
      }
      return result;
    };

    /**
     * Used to run an update operation on all documents currently in the resultset.
     *
     * @param {function} updateFunction - User supplied updateFunction(obj) will be executed for each document object.
     * @returns {Resultset} this resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.update = function (updateFunction) {

      if (typeof (updateFunction) !== "function") {
        throw new TypeError('Argument is not a function');
      }

      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      var len = this.filteredrows.length,
        rcd = this.collection.data;

      for (var idx = 0; idx < len; idx++) {
        // pass in each document object currently in resultset to user supplied updateFunction
        updateFunction(rcd[this.filteredrows[idx]]);

        // notify collection we have changed this object so it can update meta and allow DynamicViews to re-evaluate
        this.collection.update(rcd[this.filteredrows[idx]]);
      }

      return this;
    };

    /**
     * Removes all document objects which are currently in resultset from collection (as well as resultset)
     *
     * @returns {Resultset} this (empty) resultset for further chain ops.
     * @memberof Resultset
     */
    Resultset.prototype.remove = function () {

      // if this is chained resultset with no filters applied, we need to populate filteredrows first
      if (this.searchIsChained && !this.filterInitialized && this.filteredrows.length === 0) {
        this.filteredrows = this.collection.prepareFullDocIndex();
      }

      this.collection.remove(this.data());

      this.filteredrows = [];

      return this;
    };

    /**
     * data transformation via user supplied functions
     *
     * @param {function} mapFunction - this function accepts a single document for you to transform and return
     * @param {function} reduceFunction - this function accepts many (array of map outputs) and returns single value
     * @returns {value} The output of your reduceFunction
     * @memberof Resultset
     */
    Resultset.prototype.mapReduce = function (mapFunction, reduceFunction) {
      try {
        return reduceFunction(this.data().map(mapFunction));
      } catch (err) {
        throw err;
      }
    };

    /**
     * eqJoin() - Left joining two sets of data. Join keys can be defined or calculated properties
     * eqJoin expects the right join key values to be unique.  Otherwise left data will be joined on the last joinData object with that key
     * @param {Array} joinData - Data array to join to.
     * @param {(string|function)} leftJoinKey - Property name in this result set to join on or a function to produce a value to join on
     * @param {(string|function)} rightJoinKey - Property name in the joinData to join on or a function to produce a value to join on
     * @param {function=} mapFun - (Optional) A function that receives each matching pair and maps them into output objects - function(left,right){return joinedObject}
     * @returns {Resultset} A resultset with data in the format [{left: leftObj, right: rightObj}]
     * @memberof Resultset
     */
    Resultset.prototype.eqJoin = function (joinData, leftJoinKey, rightJoinKey, mapFun) {

      var leftData = [],
        leftDataLength,
        rightData = [],
        rightDataLength,
        key,
        result = [],
        leftKeyisFunction = typeof leftJoinKey === 'function',
        rightKeyisFunction = typeof rightJoinKey === 'function',
        joinMap = {};

      //get the left data
      leftData = this.data();
      leftDataLength = leftData.length;

      //get the right data
      if (joinData instanceof Resultset) {
        rightData = joinData.data();
      } else if (Array.isArray(joinData)) {
        rightData = joinData;
      } else {
        throw new TypeError('joinData needs to be an array or result set');
      }
      rightDataLength = rightData.length;

      //construct a lookup table

      for (var i = 0; i < rightDataLength; i++) {
        key = rightKeyisFunction ? rightJoinKey(rightData[i]) : rightData[i][rightJoinKey];
        joinMap[key] = rightData[i];
      }

      if (!mapFun) {
        mapFun = function (left, right) {
          return {
            left: left,
            right: right
          };
        };
      }

      //Run map function over each object in the resultset
      for (var j = 0; j < leftDataLength; j++) {
        key = leftKeyisFunction ? leftJoinKey(leftData[j]) : leftData[j][leftJoinKey];
        result.push(mapFun(leftData[j], joinMap[key] || {}));
      }

      //return return a new resultset with no filters
      this.collection = new Collection('joinData');
      this.collection.insert(result);
      this.filteredrows = [];
      this.filterInitialized = false;

      return this;
    };

    Resultset.prototype.map = function (mapFun) {
      var data = this.data().map(mapFun);
      //return return a new resultset with no filters
      this.collection = new Collection('mappedData');
      this.collection.insert(data);
      this.filteredrows = [];
      this.filterInitialized = false;

      return this;
    };

    /**
     * DynamicView class is a versatile 'live' view class which can have filters and sorts applied.
     *    Collection.addDynamicView(name) instantiates this DynamicView object and notifies it
     *    whenever documents are add/updated/removed so it can remain up-to-date. (chainable)
     *
     * @example
     * var mydv = mycollection.addDynamicView('test');  // default is non-persistent
     * mydv.applyFind({ 'doors' : 4 });
     * mydv.applyWhere(function(obj) { return obj.name === 'Toyota'; });
     * var results = mydv.data();
     *
     * @constructor DynamicView
     * @implements LokiEventEmitter
     * @param {Collection} collection - A reference to the collection to work against
     * @param {string} name - The name of this dynamic view
     * @param {object=} options - (Optional) Pass in object with 'persistent' and/or 'sortPriority' options.
     * @param {boolean} options.persistent - indicates if view is to main internal results array in 'resultdata'
     * @param {string} options.sortPriority - 'passive' (sorts performed on call to data) or 'active' (after updates)
     * @param {number} options.minRebuildInterval - minimum rebuild interval (need clarification to docs here)
     * @see {@link Collection#addDynamicView} to construct instances of DynamicView
     */
    function DynamicView(collection, name, options) {
      this.collection = collection;
      this.name = name;
      this.rebuildPending = false;
      this.options = options || {};

      if (!this.options.hasOwnProperty('persistent')) {
        this.options.persistent = false;
      }

      // 'persistentSortPriority':
      // 'passive' will defer the sort phase until they call data(). (most efficient overall)
      // 'active' will sort async whenever next idle. (prioritizes read speeds)
      if (!this.options.hasOwnProperty('sortPriority')) {
        this.options.sortPriority = 'passive';
      }

      if (!this.options.hasOwnProperty('minRebuildInterval')) {
        this.options.minRebuildInterval = 1;
      }

      this.resultset = new Resultset(collection);
      this.resultdata = [];
      this.resultsdirty = false;

      this.cachedresultset = null;

      // keep ordered filter pipeline
      this.filterPipeline = [];

      // sorting member variables
      // we only support one active search, applied using applySort() or applySimpleSort()
      this.sortFunction = null;
      this.sortCriteria = null;
      this.sortDirty = false;

      // for now just have 1 event for when we finally rebuilt lazy view
      // once we refactor transactions, i will tie in certain transactional events

      this.events = {
        'rebuild': []
      };
    }

    DynamicView.prototype = new LokiEventEmitter();


    /**
     * rematerialize() - intended for use immediately after deserialization (loading)
     *    This will clear out and reapply filterPipeline ops, recreating the view.
     *    Since where filters do not persist correctly, this method allows
     *    restoring the view to state where user can re-apply those where filters.
     *
     * @param {Object=} options - (Optional) allows specification of 'removeWhereFilters' option
     * @returns {DynamicView} This dynamic view for further chained ops.
     * @memberof DynamicView
     * @fires DynamicView.rebuild
     */
    DynamicView.prototype.rematerialize = function (options) {
      var fpl,
        fpi,
        idx;

      options = options || {};

      this.resultdata = [];
      this.resultsdirty = true;
      this.resultset = new Resultset(this.collection);

      if (this.sortFunction || this.sortCriteria) {
        this.sortDirty = true;
      }

      if (options.hasOwnProperty('removeWhereFilters')) {
        // for each view see if it had any where filters applied... since they don't
        // serialize those functions lets remove those invalid filters
        fpl = this.filterPipeline.length;
        fpi = fpl;
        while (fpi--) {
          if (this.filterPipeline[fpi].type === 'where') {
            if (fpi !== this.filterPipeline.length - 1) {
              this.filterPipeline[fpi] = this.filterPipeline[this.filterPipeline.length - 1];
            }

            this.filterPipeline.length--;
          }
        }
      }

      // back up old filter pipeline, clear filter pipeline, and reapply pipeline ops
      var ofp = this.filterPipeline;
      this.filterPipeline = [];

      // now re-apply 'find' filterPipeline ops
      fpl = ofp.length;
      for (idx = 0; idx < fpl; idx++) {
        this.applyFind(ofp[idx].val);
      }

      // during creation of unit tests, i will remove this forced refresh and leave lazy
      this.data();

      // emit rebuild event in case user wants to be notified
      this.emit('rebuild', this);

      return this;
    };

    /**
     * branchResultset() - Makes a copy of the internal resultset for branched queries.
     *    Unlike this dynamic view, the branched resultset will not be 'live' updated,
     *    so your branched query should be immediately resolved and not held for future evaluation.
     *
     * @param {(string|array=)} transform - Optional name of collection transform, or an array of transform steps
     * @param {object=} parameters - optional parameters (if optional transform requires them)
     * @returns {Resultset} A copy of the internal resultset for branched queries.
     * @memberof DynamicView
     */
    DynamicView.prototype.branchResultset = function (transform, parameters) {
      var rs = this.resultset.branch();

      if (typeof transform === 'undefined') {
        return rs;
      }

      return rs.transform(transform, parameters);
    };

    /**
     * toJSON() - Override of toJSON to avoid circular references
     *
     */
    DynamicView.prototype.toJSON = function () {
      var copy = new DynamicView(this.collection, this.name, this.options);

      copy.resultset = this.resultset;
      copy.resultdata = []; // let's not save data (copy) to minimize size
      copy.resultsdirty = true;
      copy.filterPipeline = this.filterPipeline;
      copy.sortFunction = this.sortFunction;
      copy.sortCriteria = this.sortCriteria;
      copy.sortDirty = this.sortDirty;

      // avoid circular reference, reapply in db.loadJSON()
      copy.collection = null;

      return copy;
    };

    /**
     * removeFilters() - Used to clear pipeline and reset dynamic view to initial state.
     *     Existing options should be retained.
     * @memberof DynamicView
     */
    DynamicView.prototype.removeFilters = function () {
      this.rebuildPending = false;
      this.resultset.reset();
      this.resultdata = [];
      this.resultsdirty = false;

      this.cachedresultset = null;

      // keep ordered filter pipeline
      this.filterPipeline = [];

      // sorting member variables
      // we only support one active search, applied using applySort() or applySimpleSort()
      this.sortFunction = null;
      this.sortCriteria = null;
      this.sortDirty = false;
    };

    /**
     * applySort() - Used to apply a sort to the dynamic view
     * @example
     * dv.applySort(function(obj1, obj2) {
     *   if (obj1.name === obj2.name) return 0;
     *   if (obj1.name > obj2.name) return 1;
     *   if (obj1.name < obj2.name) return -1;
     * });
     *
     * @param {function} comparefun - a javascript compare function used for sorting
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applySort = function (comparefun) {
      this.sortFunction = comparefun;
      this.sortCriteria = null;

      this.queueSortPhase();

      return this;
    };

    /**
     * applySimpleSort() - Used to specify a property used for view translation.
     * @example
     * dv.applySimpleSort("name");
     *
     * @param {string} propname - Name of property by which to sort.
     * @param {boolean=} isdesc - (Optional) If true, the sort will be in descending order.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applySimpleSort = function (propname, isdesc) {
      this.sortCriteria = [
        [propname, isdesc || false]
      ];
      this.sortFunction = null;

      this.queueSortPhase();

      return this;
    };

    /**
     * applySortCriteria() - Allows sorting a resultset based on multiple columns.
     * @example
     * // to sort by age and then name (both ascending)
     * dv.applySortCriteria(['age', 'name']);
     * // to sort by age (ascending) and then by name (descending)
     * dv.applySortCriteria(['age', ['name', true]);
     * // to sort by age (descending) and then by name (descending)
     * dv.applySortCriteria(['age', true], ['name', true]);
     *
     * @param {array} properties - array of property names or subarray of [propertyname, isdesc] used evaluate sort order
     * @returns {DynamicView} Reference to this DynamicView, sorted, for future chain operations.
     * @memberof DynamicView
     */
    DynamicView.prototype.applySortCriteria = function (criteria) {
      this.sortCriteria = criteria;
      this.sortFunction = null;

      this.queueSortPhase();

      return this;
    };

    /**
     * startTransaction() - marks the beginning of a transaction.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.startTransaction = function () {
      this.cachedresultset = this.resultset.copy();

      return this;
    };

    /**
     * commit() - commits a transaction.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.commit = function () {
      this.cachedresultset = null;

      return this;
    };

    /**
     * rollback() - rolls back a transaction.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.rollback = function () {
      this.resultset = this.cachedresultset;

      if (this.options.persistent) {
        // for now just rebuild the persistent dynamic view data in this worst case scenario
        // (a persistent view utilizing transactions which get rolled back), we already know the filter so not too bad.
        this.resultdata = this.resultset.data();

        this.emit('rebuild', this);
      }

      return this;
    };


    /**
     * Implementation detail.
     * _indexOfFilterWithId() - Find the index of a filter in the pipeline, by that filter's ID.
     *
     * @param {(string|number)} uid - The unique ID of the filter.
     * @returns {number}: index of the referenced filter in the pipeline; -1 if not found.
     */
    DynamicView.prototype._indexOfFilterWithId = function (uid) {
      if (typeof uid === 'string' || typeof uid === 'number') {
        for (var idx = 0, len = this.filterPipeline.length; idx < len; idx += 1) {
          if (uid === this.filterPipeline[idx].uid) {
            return idx;
          }
        }
      }
      return -1;
    };

    /**
     * Implementation detail.
     * _addFilter() - Add the filter object to the end of view's filter pipeline and apply the filter to the resultset.
     *
     * @param {object} filter - The filter object. Refer to applyFilter() for extra details.
     */
    DynamicView.prototype._addFilter = function (filter) {
      this.filterPipeline.push(filter);
      this.resultset[filter.type](filter.val);
    };

    /**
     * reapplyFilters() - Reapply all the filters in the current pipeline.
     *
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     */
    DynamicView.prototype.reapplyFilters = function () {
      this.resultset.reset();

      this.cachedresultset = null;
      if (this.options.persistent) {
        this.resultdata = [];
        this.resultsdirty = true;
      }

      var filters = this.filterPipeline;
      this.filterPipeline = [];

      for (var idx = 0, len = filters.length; idx < len; idx += 1) {
        this._addFilter(filters[idx]);
      }

      if (this.sortFunction || this.sortCriteria) {
        this.queueSortPhase();
      } else {
        this.queueRebuildEvent();
      }

      return this;
    };

    /**
     * applyFilter() - Adds or updates a filter in the DynamicView filter pipeline
     *
     * @param {object} filter - A filter object to add to the pipeline.
     *    The object is in the format { 'type': filter_type, 'val', filter_param, 'uid', optional_filter_id }
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applyFilter = function (filter) {
      var idx = this._indexOfFilterWithId(filter.uid);
      if (idx >= 0) {
        this.filterPipeline[idx] = filter;
        return this.reapplyFilters();
      }

      this.cachedresultset = null;
      if (this.options.persistent) {
        this.resultdata = [];
        this.resultsdirty = true;
      }

      this._addFilter(filter);

      if (this.sortFunction || this.sortCriteria) {
        this.queueSortPhase();
      } else {
        this.queueRebuildEvent();
      }

      return this;
    };

    /**
     * applyFind() - Adds or updates a mongo-style query option in the DynamicView filter pipeline
     *
     * @param {object} query - A mongo-style query object to apply to pipeline
     * @param {(string|number)=} uid - Optional: The unique ID of this filter, to reference it in the future.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applyFind = function (query, uid) {
      this.applyFilter({
        type: 'find',
        val: query,
        uid: uid
      });
      return this;
    };

    /**
     * applyWhere() - Adds or updates a javascript filter function in the DynamicView filter pipeline
     *
     * @param {function} fun - A javascript filter function to apply to pipeline
     * @param {(string|number)=} uid - Optional: The unique ID of this filter, to reference it in the future.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.applyWhere = function (fun, uid) {
      this.applyFilter({
        type: 'where',
        val: fun,
        uid: uid
      });
      return this;
    };

    /**
     * removeFilter() - Remove the specified filter from the DynamicView filter pipeline
     *
     * @param {(string|number)} uid - The unique ID of the filter to be removed.
     * @returns {DynamicView} this DynamicView object, for further chain ops.
     * @memberof DynamicView
     */
    DynamicView.prototype.removeFilter = function (uid) {
      var idx = this._indexOfFilterWithId(uid);
      if (idx < 0) {
        throw new Error("Dynamic view does not contain a filter with ID: " + uid);
      }

      this.filterPipeline.splice(idx, 1);
      this.reapplyFilters();
      return this;
    };

    /**
     * count() - returns the number of documents representing the current DynamicView contents.
     *
     * @returns {number} The number of documents representing the current DynamicView contents.
     * @memberof DynamicView
     */
    DynamicView.prototype.count = function () {
      if (this.options.persistent) {
        return this.resultdata.length;
      }
      return this.resultset.count();
    };

    /**
     * data() - resolves and pending filtering and sorting, then returns document array as result.
     *
     * @returns {array} An array of documents representing the current DynamicView contents.
     * @memberof DynamicView
     */
    DynamicView.prototype.data = function () {
      // using final sort phase as 'catch all' for a few use cases which require full rebuild
      if (this.sortDirty || this.resultsdirty) {
        this.performSortPhase({
          suppressRebuildEvent: true
        });
      }
      return (this.options.persistent) ? (this.resultdata) : (this.resultset.data());
    };

    /**
     * queueRebuildEvent() - When the view is not sorted we may still wish to be notified of rebuild events.
     *     This event will throttle and queue a single rebuild event when batches of updates affect the view.
     */
    DynamicView.prototype.queueRebuildEvent = function () {
      if (this.rebuildPending) {
        return;
      }
      this.rebuildPending = true;

      var self = this;
      setTimeout(function () {
        if (self.rebuildPending) {
          self.rebuildPending = false;
          self.emit('rebuild', self);
        }
      }, this.options.minRebuildInterval);
    };

    /**
     * queueSortPhase : If the view is sorted we will throttle sorting to either :
     *    (1) passive - when the user calls data(), or
     *    (2) active - once they stop updating and yield js thread control
     */
    DynamicView.prototype.queueSortPhase = function () {
      // already queued? exit without queuing again
      if (this.sortDirty) {
        return;
      }
      this.sortDirty = true;

      var self = this;
      if (this.options.sortPriority === "active") {
        // active sorting... once they are done and yield js thread, run async performSortPhase()
        setTimeout(function () {
          self.performSortPhase();
        }, this.options.minRebuildInterval);
      } else {
        // must be passive sorting... since not calling performSortPhase (until data call), lets use queueRebuildEvent to
        // potentially notify user that data has changed.
        this.queueRebuildEvent();
      }
    };

    /**
     * performSortPhase() - invoked synchronously or asynchronously to perform final sort phase (if needed)
     *
     */
    DynamicView.prototype.performSortPhase = function (options) {
      // async call to this may have been pre-empted by synchronous call to data before async could fire
      if (!this.sortDirty && !this.resultsdirty) {
        return;
      }

      options = options || {};

      if (this.sortDirty) {
        if (this.sortFunction) {
          this.resultset.sort(this.sortFunction);
        } else if (this.sortCriteria) {
          this.resultset.compoundsort(this.sortCriteria);
        }

        this.sortDirty = false;
      }

      if (this.options.persistent) {
        // persistent view, rebuild local resultdata array
        this.resultdata = this.resultset.data();
        this.resultsdirty = false;
      }

      if (!options.suppressRebuildEvent) {
        this.emit('rebuild', this);
      }
    };

    /**
     * evaluateDocument() - internal method for (re)evaluating document inclusion.
     *    Called by : collection.insert() and collection.update().
     *
     * @param {int} objIndex - index of document to (re)run through filter pipeline.
     * @param {bool} isNew - true if the document was just added to the collection.
     */
    DynamicView.prototype.evaluateDocument = function (objIndex, isNew) {
      // if no filter applied yet, the result 'set' should remain 'everything'
      if (!this.resultset.filterInitialized) {
        if (this.options.persistent) {
          this.resultdata = this.resultset.data();
        }
        // need to re-sort to sort new document
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }
        return;
      }

      var ofr = this.resultset.filteredrows;
      var oldPos = (isNew) ? (-1) : (ofr.indexOf(+objIndex));
      var oldlen = ofr.length;

      // creating a 1-element resultset to run filter chain ops on to see if that doc passes filters;
      // mostly efficient algorithm, slight stack overhead price (this function is called on inserts and updates)
      var evalResultset = new Resultset(this.collection);
      evalResultset.filteredrows = [objIndex];
      evalResultset.filterInitialized = true;
      var filter;
      for (var idx = 0, len = this.filterPipeline.length; idx < len; idx++) {
        filter = this.filterPipeline[idx];
        evalResultset[filter.type](filter.val);
      }

      // not a true position, but -1 if not pass our filter(s), 0 if passed filter(s)
      var newPos = (evalResultset.filteredrows.length === 0) ? -1 : 0;

      // wasn't in old, shouldn't be now... do nothing
      if (oldPos === -1 && newPos === -1) return;

      // wasn't in resultset, should be now... add
      if (oldPos === -1 && newPos !== -1) {
        ofr.push(objIndex);

        if (this.options.persistent) {
          this.resultdata.push(this.collection.data[objIndex]);
        }

        // need to re-sort to sort new document
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }

        return;
      }

      // was in resultset, shouldn't be now... delete
      if (oldPos !== -1 && newPos === -1) {
        if (oldPos < oldlen - 1) {
          // http://dvolvr.davidwaterston.com/2013/06/09/restating-the-obvious-the-fastest-way-to-truncate-an-array-in-javascript/comment-page-1/
          ofr[oldPos] = ofr[oldlen - 1];
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata[oldPos] = this.resultdata[oldlen - 1];
            this.resultdata.length = oldlen - 1;
          }
        } else {
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata.length = oldlen - 1;
          }
        }

        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }

        return;
      }

      // was in resultset, should still be now... (update persistent only?)
      if (oldPos !== -1 && newPos !== -1) {
        if (this.options.persistent) {
          // in case document changed, replace persistent view data with the latest collection.data document
          this.resultdata[oldPos] = this.collection.data[objIndex];
        }

        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }

        return;
      }
    };

    /**
     * removeDocument() - internal function called on collection.delete()
     */
    DynamicView.prototype.removeDocument = function (objIndex) {
      // if no filter applied yet, the result 'set' should remain 'everything'
      if (!this.resultset.filterInitialized) {
        if (this.options.persistent) {
          this.resultdata = this.resultset.data();
        }
        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }
        return;
      }

      var ofr = this.resultset.filteredrows;
      var oldPos = ofr.indexOf(+objIndex);
      var oldlen = ofr.length;
      var idx;

      if (oldPos !== -1) {
        // if not last row in resultdata, swap last to hole and truncate last row
        if (oldPos < oldlen - 1) {
          ofr[oldPos] = ofr[oldlen - 1];
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata[oldPos] = this.resultdata[oldlen - 1];
            this.resultdata.length = oldlen - 1;
          }
        }
        // last row, so just truncate last row
        else {
          ofr.length = oldlen - 1;

          if (this.options.persistent) {
            this.resultdata.length = oldlen - 1;
          }
        }

        // in case changes to data altered a sort column
        if (this.sortFunction || this.sortCriteria) {
          this.queueSortPhase();
        } else {
          this.queueRebuildEvent();
        }
      }

      // since we are using filteredrows to store data array positions
      // if they remove a document (whether in our view or not),
      // we need to adjust array positions -1 for all document array references after that position
      oldlen = ofr.length;
      for (idx = 0; idx < oldlen; idx++) {
        if (ofr[idx] > objIndex) {
          ofr[idx]--;
        }
      }
    };

    /**
     * mapReduce() - data transformation via user supplied functions
     *
     * @param {function} mapFunction - this function accepts a single document for you to transform and return
     * @param {function} reduceFunction - this function accepts many (array of map outputs) and returns single value
     * @returns The output of your reduceFunction
     * @memberof DynamicView
     */
    DynamicView.prototype.mapReduce = function (mapFunction, reduceFunction) {
      try {
        return reduceFunction(this.data().map(mapFunction));
      } catch (err) {
        throw err;
      }
    };


    /**
     * Collection class that handles documents of same type
     * @constructor Collection
     * @implements LokiEventEmitter
     * @param {string} name - collection name
     * @param {(array|object)=} options - (optional) array of property names to be indicized OR a configuration object
     * @param {array} options.unique - array of property names to define unique constraints for
     * @param {array} options.exact - array of property names to define exact constraints for
     * @param {array} options.indices - array property names to define binary indexes for
     * @param {boolean} options.asyncListeners - default is false
     * @param {boolean} options.disableChangesApi - default is true
     * @param {boolean} options.autoupdate - use Object.observe to update objects automatically (default: false)
     * @param {boolean} options.clone - specify whether inserts and queries clone to/from user
     * @param {string} options.cloneMethod - 'parse-stringify' (default), 'jquery-extend-deep', 'shallow'
     * @param {int} options.ttlInterval - time interval for clearing out 'aged' documents; not set by default.
     * @see {@link Loki#addCollection} for normal creation of collections
     */
    function Collection(name, options) {
      // the name of the collection

      this.name = name;
      // the data held by the collection
      this.data = [];
      this.idIndex = []; // index of id
      this.binaryIndices = {}; // user defined indexes
      this.constraints = {
        unique: {},
        exact: {}
      };

      // unique contraints contain duplicate object references, so they are not persisted.
      // we will keep track of properties which have unique contraint applied here, and regenerate on load
      this.uniqueNames = [];

      // transforms will be used to store frequently used query chains as a series of steps
      // which itself can be stored along with the database.
      this.transforms = {};

      // the object type of the collection
      this.objType = name;

      // in autosave scenarios we will use collection level dirty flags to determine whether save is needed.
      // currently, if any collection is dirty we will autosave the whole database if autosave is configured.
      // defaulting to true since this is called from addCollection and adding a collection should trigger save
      this.dirty = true;

      // private holders for cached data
      this.cachedIndex = null;
      this.cachedBinaryIndex = null;
      this.cachedData = null;
      var self = this;

      /* OPTIONS */
      options = options || {};

      // exact match and unique constraints
      if (options.hasOwnProperty('unique')) {
        if (!Array.isArray(options.unique)) {
          options.unique = [options.unique];
        }
        options.unique.forEach(function (prop) {
          self.uniqueNames.push(prop); // used to regenerate on subsequent database loads
          self.constraints.unique[prop] = new UniqueIndex(prop);
        });
      }

      if (options.hasOwnProperty('exact')) {
        options.exact.forEach(function (prop) {
          self.constraints.exact[prop] = new ExactIndex(prop);
        });
      }

      // is collection transactional
      this.transactional = options.hasOwnProperty('transactional') ? options.transactional : false;

      // options to clone objects when inserting them
      this.cloneObjects = options.hasOwnProperty('clone') ? options.clone : false;

      // default clone method (if enabled) is parse-stringify
      this.cloneMethod = options.hasOwnProperty('cloneMethod') ? options.cloneMethod : "parse-stringify";

      // option to make event listeners async, default is sync
      this.asyncListeners = options.hasOwnProperty('asyncListeners') ? options.asyncListeners : false;

      // disable track changes
      this.disableChangesApi = options.hasOwnProperty('disableChangesApi') ? options.disableChangesApi : true;

      // option to observe objects and update them automatically, ignored if Object.observe is not supported
      this.autoupdate = options.hasOwnProperty('autoupdate') ? options.autoupdate : false;

      //option to activate a cleaner daemon - clears "aged" documents at set intervals.
      this.ttl = {
        age: null,
        ttlInterval: null,
        daemon: null
      };
      this.setTTL(options.ttl || -1, options.ttlInterval);

      // currentMaxId - change manually at your own peril!
      this.maxId = 0;

      this.DynamicViews = [];

      // events
      this.events = {
        'insert': [],
        'update': [],
        'pre-insert': [],
        'pre-update': [],
        'close': [],
        'flushbuffer': [],
        'error': [],
        'delete': [],
        'warning': []
      };

      // changes are tracked by collection and aggregated by the db
      this.changes = [];

      // initialize the id index
      this.ensureId();
      var indices = [];
      // initialize optional user-supplied indices array ['age', 'lname', 'zip']
      if (options && options.indices) {
        if (Object.prototype.toString.call(options.indices) === '[object Array]') {
          indices = options.indices;
        } else if (typeof options.indices === 'string') {
          indices = [options.indices];
        } else {
          throw new TypeError('Indices needs to be a string or an array of strings');
        }
      }

      for (var idx = 0; idx < indices.length; idx++) {
        this.ensureIndex(indices[idx]);
      }

      function observerCallback(changes) {

        var changedObjects = typeof Set === 'function' ? new Set() : [];

        if (!changedObjects.add)
          changedObjects.add = function (object) {
            if (this.indexOf(object) === -1)
              this.push(object);
            return this;
          };

        changes.forEach(function (change) {
          changedObjects.add(change.object);
        });

        changedObjects.forEach(function (object) {
          if (!hasOwnProperty.call(object, '$loki'))
            return self.removeAutoUpdateObserver(object);
          try {
            self.update(object);
          } catch (err) {}
        });
      }

      this.observerCallback = observerCallback;

      /*
       * This method creates a clone of the current status of an object and associates operation and collection name,
       * so the parent db can aggregate and generate a changes object for the entire db
       */
      function createChange(name, op, obj) {
        self.changes.push({
          name: name,
          operation: op,
          obj: JSON.parse(JSON.stringify(obj))
        });
      }

      // clear all the changes
      function flushChanges() {
        self.changes = [];
      }

      this.getChanges = function () {
        return self.changes;
      };

      this.flushChanges = flushChanges;

      /**
       * If the changes API is disabled make sure only metadata is added without re-evaluating everytime if the changesApi is enabled
       */
      function insertMeta(obj) {
        if (!obj) {
          return;
        }
        if (!obj.meta) {
          obj.meta = {};
        }

        obj.meta.created = (new Date()).getTime();
        obj.meta.revision = 0;
      }

      function updateMeta(obj) {
        if (!obj) {
          return;
        }
        obj.meta.updated = (new Date()).getTime();
        obj.meta.revision += 1;
      }

      function createInsertChange(obj) {
        createChange(self.name, 'I', obj);
      }

      function createUpdateChange(obj) {
        createChange(self.name, 'U', obj);
      }

      function insertMetaWithChange(obj) {
        insertMeta(obj);
        createInsertChange(obj);
      }

      function updateMetaWithChange(obj) {
        updateMeta(obj);
        createUpdateChange(obj);
      }


      /* assign correct handler based on ChangesAPI flag */
      var insertHandler, updateHandler;

      function setHandlers() {
        insertHandler = self.disableChangesApi ? insertMeta : insertMetaWithChange;
        updateHandler = self.disableChangesApi ? updateMeta : updateMetaWithChange;
      }

      setHandlers();

      this.setChangesApi = function (enabled) {
        self.disableChangesApi = !enabled;
        setHandlers();
      };
      /**
       * built-in events
       */
      this.on('insert', function insertCallback(obj) {
        insertHandler(obj);
      });

      this.on('update', function updateCallback(obj) {
        updateHandler(obj);
      });

      this.on('delete', function deleteCallback(obj) {
        if (!self.disableChangesApi) {
          createChange(self.name, 'R', obj);
        }
      });

      this.on('warning', function (warning) {
        self.console.warn(warning);
      });
      // for de-serialization purposes
      flushChanges();
    }

    Collection.prototype = new LokiEventEmitter();

    Collection.prototype.console = {
      log: function () {},
      warn: function () {},
      error: function () {},
    };

    Collection.prototype.addAutoUpdateObserver = function (object) {
      if (!this.autoupdate || typeof Object.observe !== 'function')
        return;

      Object.observe(object, this.observerCallback, ['add', 'update', 'delete', 'reconfigure', 'setPrototype']);
    };

    Collection.prototype.removeAutoUpdateObserver = function (object) {
      if (!this.autoupdate || typeof Object.observe !== 'function')
        return;

      Object.unobserve(object, this.observerCallback);
    };

    /**
     * Adds a named collection transform to the collection
     * @param {string} name - name to associate with transform
     * @param {array} transform - an array of transformation 'step' objects to save into the collection
     * @memberof Collection
     */
    Collection.prototype.addTransform = function (name, transform) {
      if (this.transforms.hasOwnProperty(name)) {
        throw new Error("a transform by that name already exists");
      }

      this.transforms[name] = transform;
    };

    /**
     * Updates a named collection transform to the collection
     * @param {string} name - name to associate with transform
     * @param {object} transform - a transformation object to save into collection
     * @memberof Collection
     */
    Collection.prototype.setTransform = function (name, transform) {
      this.transforms[name] = transform;
    };

    /**
     * Removes a named collection transform from the collection
     * @param {string} name - name of collection transform to remove
     * @memberof Collection
     */
    Collection.prototype.removeTransform = function (name) {
      delete this.transforms[name];
    };

    Collection.prototype.byExample = function (template) {
      var k, obj, query;
      query = [];
      for (k in template) {
        if (!template.hasOwnProperty(k)) continue;
        query.push((
          obj = {},
          obj[k] = template[k],
          obj
        ));
      }
      return {
        '$and': query
      };
    };

    Collection.prototype.findObject = function (template) {
      return this.findOne(this.byExample(template));
    };

    Collection.prototype.findObjects = function (template) {
      return this.find(this.byExample(template));
    };

    /*----------------------------+
    | TTL daemon                  |
    +----------------------------*/
    Collection.prototype.ttlDaemonFuncGen = function () {
      var collection = this;
      var age = this.ttl.age;
      return function ttlDaemon() {
        var now = Date.now();
        var toRemove = collection.chain().where(function daemonFilter(member) {
          var timestamp = member.meta.updated || member.meta.created;
          var diff = now - timestamp;
          return age < diff;
        });
        toRemove.remove();
      };
    };

    Collection.prototype.setTTL = function (age, interval) {
      if (age < 0) {
        clearInterval(this.ttl.daemon);
      } else {
        this.ttl.age = age;
        this.ttl.ttlInterval = interval;
        this.ttl.daemon = setInterval(this.ttlDaemonFuncGen(), interval);
      }
    };

    /*----------------------------+
    | INDEXING                    |
    +----------------------------*/

    /**
     * create a row filter that covers all documents in the collection
     */
    Collection.prototype.prepareFullDocIndex = function () {
      var len = this.data.length;
      var indexes = new Array(len);
      for (var i = 0; i < len; i += 1) {
        indexes[i] = i;
      }
      return indexes;
    };

    /**
     * Ensure binary index on a certain field
     * @param {string} property - name of property to create binary index on
     * @param {boolean=} force - (Optional) flag indicating whether to construct index immediately
     * @memberof Collection
     */
    Collection.prototype.ensureIndex = function (property, force) {
      // optional parameter to force rebuild whether flagged as dirty or not
      if (typeof (force) === 'undefined') {
        force = false;
      }

      if (property === null || property === undefined) {
        throw new Error('Attempting to set index without an associated property');
      }

      if (this.binaryIndices[property] && !force) {
        if (!this.binaryIndices[property].dirty) return;
      }

      var index = {
        'name': property,
        'dirty': true,
        'values': this.prepareFullDocIndex()
      };
      this.binaryIndices[property] = index;

      var wrappedComparer =
        (function (p, data) {
          return function (a, b) {
            var objAp = data[a][p],
              objBp = data[b][p];
            if (objAp !== objBp) {
              if (ltHelper(objAp, objBp, false)) return -1;
              if (gtHelper(objAp, objBp, false)) return 1;
            }
            return 0;
          };
        })(property, this.data);

      index.values.sort(wrappedComparer);
      index.dirty = false;

      this.dirty = true; // for autosave scenarios
    };

    Collection.prototype.getSequencedIndexValues = function (property) {
      var idx, idxvals = this.binaryIndices[property].values;
      var result = "";

      for (idx = 0; idx < idxvals.length; idx++) {
        result += " [" + idx + "] " + this.data[idxvals[idx]][property];
      }

      return result;
    };

    Collection.prototype.ensureUniqueIndex = function (field) {
      var index = this.constraints.unique[field];
      if (!index) {
        // keep track of new unique index for regenerate after database (re)load.
        if (this.uniqueNames.indexOf(field) == -1) {
          this.uniqueNames.push(field);
        }
      }

      // if index already existed, (re)loading it will likely cause collisions, rebuild always
      this.constraints.unique[field] = index = new UniqueIndex(field);
      this.data.forEach(function (obj) {
        index.set(obj);
      });
      return index;
    };

    /**
     * Ensure all binary indices
     */
    Collection.prototype.ensureAllIndexes = function (force) {
      var key, bIndices = this.binaryIndices;
      for (key in bIndices) {
        if (hasOwnProperty.call(bIndices, key)) {
          this.ensureIndex(key, force);
        }
      }
    };

    Collection.prototype.flagBinaryIndexesDirty = function () {
      var key, bIndices = this.binaryIndices;
      for (key in bIndices) {
        if (hasOwnProperty.call(bIndices, key)) {
          bIndices[key].dirty = true;
        }
      }
    };

    Collection.prototype.flagBinaryIndexDirty = function (index) {
      if (this.binaryIndices[index])
        this.binaryIndices[index].dirty = true;
    };

    /**
     * Quickly determine number of documents in collection (or query)
     * @param {object=} query - (optional) query object to count results of
     * @returns {number} number of documents in the collection
     * @memberof Collection
     */
    Collection.prototype.count = function (query) {
      if (!query) {
        return this.data.length;
      }

      return this.chain().find(query).filteredrows.length;
    };

    /**
     * Rebuild idIndex
     */
    Collection.prototype.ensureId = function () {
      var len = this.data.length,
        i = 0;

      this.idIndex = [];
      for (i; i < len; i += 1) {
        this.idIndex.push(this.data[i].$loki);
      }
    };

    /**
     * Rebuild idIndex async with callback - useful for background syncing with a remote server
     */
    Collection.prototype.ensureIdAsync = function (callback) {
      this.async(function () {
        this.ensureId();
      }, callback);
    };

    /**
     * Add a dynamic view to the collection
     * @param {string} name - name of dynamic view to add
     * @param {object=} options - (optional) options to configure dynamic view with
     * @param {boolean} options.persistent - indicates if view is to main internal results array in 'resultdata'
     * @param {string} options.sortPriority - 'passive' (sorts performed on call to data) or 'active' (after updates)
     * @param {number} options.minRebuildInterval - minimum rebuild interval (need clarification to docs here)
     * @returns {DynamicView} reference to the dynamic view added
     * @memberof Collection
     **/

    Collection.prototype.addDynamicView = function (name, options) {
      var dv = new DynamicView(this, name, options);
      this.DynamicViews.push(dv);

      return dv;
    };

    /**
     * Remove a dynamic view from the collection
     * @param {string} name - name of dynamic view to remove
     * @memberof Collection
     **/
    Collection.prototype.removeDynamicView = function (name) {
      for (var idx = 0; idx < this.DynamicViews.length; idx++) {
        if (this.DynamicViews[idx].name === name) {
          this.DynamicViews.splice(idx, 1);
        }
      }
    };

    /**
     * Look up dynamic view reference from within the collection
     * @param {string} name - name of dynamic view to retrieve reference of
     * @returns {DynamicView} A reference to the dynamic view with that name
     * @memberof Collection
     **/
    Collection.prototype.getDynamicView = function (name) {
      for (var idx = 0; idx < this.DynamicViews.length; idx++) {
        if (this.DynamicViews[idx].name === name) {
          return this.DynamicViews[idx];
        }
      }

      return null;
    };

    /**
     * find and update: pass a filtering function to select elements to be updated
     * and apply the updatefunctino to those elements iteratively
     * @param {function} filterFunction - filter function whose results will execute update
     * @param {function} updateFunction - update function to run against filtered documents
     * @memberof Collection
     */
    Collection.prototype.findAndUpdate = function (filterFunction, updateFunction) {
      var results = this.where(filterFunction),
        i = 0,
        obj;
      try {
        for (i; i < results.length; i++) {
          obj = updateFunction(results[i]);
          this.update(obj);
        }

      } catch (err) {
        this.rollback();
        this.console.error(err.message);
      }
    };

    /**
     * Adds object(s) to collection, ensure object(s) have meta properties, clone it if necessary, etc.
     * @param {(object|array)} doc - the document (or array of documents) to be inserted
     * @returns {(object|array)} document or documents inserted
     * @memberof Collection
     */
    Collection.prototype.insert = function (doc) {
      if (!Array.isArray(doc)) {
        return this.insertOne(doc);
      }

      // holder to the clone of the object inserted if collections is set to clone objects
      var obj;
      var results = [];
      for (var i = 0, len = doc.length; i < len; i++) {
        obj = this.insertOne(doc[i]);
        if (!obj) {
          return undefined;
        }
        results.push(obj);
      }
      return results.length === 1 ? results[0] : results;
    };

    /**
     * Adds a single object, ensures it has meta properties, clone it if necessary, etc.
     * @param {object} doc - the document to be inserted
     * @returns {object} document or 'undefined' if there was a problem inserting it
     * @memberof Collection
     */
    Collection.prototype.insertOne = function (doc) {
      var err = null;
      if (typeof doc !== 'object') {
        err = new TypeError('Document needs to be an object');
      } else if (doc === null) {
        err = new TypeError('Object cannot be null');
      }

      if (err !== null) {
        this.emit('error', err);
        throw err;
      }

      // if configured to clone, do so now... otherwise just use same obj reference
      var obj = this.cloneObjects ? clone(doc, this.cloneMethod) : doc;

      if (typeof obj.meta === 'undefined') {
        obj.meta = {
          revision: 0,
          created: 0
        };
      }

      this.emit('pre-insert', obj);
      if (!this.add(obj)) {
        return undefined;
      }

      this.addAutoUpdateObserver(obj);
      this.emit('insert', obj);
      return obj;
    };

    /**
     * Empties the collection.
     * @memberof Collection
     */
    Collection.prototype.clear = function () {
      this.data = [];
      this.idIndex = [];
      this.binaryIndices = {};
      this.cachedIndex = null;
      this.cachedBinaryIndex = null;
      this.cachedData = null;
      this.maxId = 0;
      this.DynamicViews = [];
      this.dirty = true;
    };

    /**
     * Updates an object and notifies collection that the document has changed.
     * @param {object} doc - document to update within the collection
     * @memberof Collection
     */
    Collection.prototype.update = function (doc) {
      this.flagBinaryIndexesDirty();

      if (Array.isArray(doc)) {
        var k = 0,
          len = doc.length;
        for (k; k < len; k += 1) {
          this.update(doc[k]);
        }
        return;
      }

      // verify object is a properly formed document
      if (!hasOwnProperty.call(doc, '$loki')) {
        throw new Error('Trying to update unsynced document. Please save the document first by using insert() or addMany()');
      }
      try {
        this.startTransaction();
        var arr = this.get(doc.$loki, true),
          obj,
          position,
          self = this;

        obj = arr[0]; // -internal- obj ref
        position = arr[1]; // position in data array

        if (!arr) {
          throw new Error('Trying to update a document not in collection.');
        }
        this.emit('pre-update', doc);

        Object.keys(this.constraints.unique).forEach(function (key) {
          self.constraints.unique[key].update(obj, doc);
        });

        // operate the update
        this.data[position] = doc;

        if (obj !== doc) {
          this.addAutoUpdateObserver(doc);
        }

        // now that we can efficiently determine the data[] position of newly added document,
        // submit it for all registered DynamicViews to evaluate for inclusion/exclusion
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].evaluateDocument(position, false);
        }

        this.idIndex[position] = obj.$loki;

        this.commit();
        this.dirty = true; // for autosave scenarios
        this.emit('update', doc);
        return doc;
      } catch (err) {
        this.rollback();
        this.console.error(err.message);
        this.emit('error', err);
        throw (err); // re-throw error so user does not think it succeeded
      }
    };

    /**
     * Add object to collection
     */
    Collection.prototype.add = function (obj) {
      // if parameter isn't object exit with throw
      if ('object' !== typeof obj) {
        throw new TypeError('Object being added needs to be an object');
      }
      // if object you are adding already has id column it is either already in the collection
      // or the object is carrying its own 'id' property.  If it also has a meta property,
      // then this is already in collection so throw error, otherwise rename to originalId and continue adding.
      if (typeof (obj.$loki) !== 'undefined') {
        throw new Error('Document is already in collection, please use update()');
      }

      this.flagBinaryIndexesDirty();

      /*
       * try adding object to collection
       */
      try {
        this.startTransaction();
        this.maxId++;

        if (isNaN(this.maxId)) {
          this.maxId = (this.data[this.data.length - 1].$loki + 1);
        }

        obj.$loki = this.maxId;
        obj.meta.version = 0;

        var key, constrUnique = this.constraints.unique;
        for (key in constrUnique) {
          if (hasOwnProperty.call(constrUnique, key)) {
            constrUnique[key].set(obj);
          }
        }

        // add new obj id to idIndex
        this.idIndex.push(obj.$loki);

        // add the object
        this.data.push(obj);

        // now that we can efficiently determine the data[] position of newly added document,
        // submit it for all registered DynamicViews to evaluate for inclusion/exclusion
        var addedPos = this.data.length - 1;
        var dvlen = this.DynamicViews.length;
        for (var i = 0; i < dvlen; i++) {
          this.DynamicViews[i].evaluateDocument(addedPos, true);
        }

        this.commit();
        this.dirty = true; // for autosave scenarios

        return (this.cloneObjects) ? (clone(obj, this.cloneMethod)) : (obj);
      } catch (err) {
        this.rollback();
        this.console.error(err.message);
        this.emit('error', err);
        throw (err); // re-throw error so user does not think it succeeded
      }
    };


    /**
     * Remove all documents matching supplied filter object
     * @param {object} query - query object to filter on
     * @memberof Collection
     */
    Collection.prototype.removeWhere = function (query) {
      var list;
      if (typeof query === 'function') {
        list = this.data.filter(query);
      } else {
        list = new Resultset(this, {
          queryObj: query
        });
      }
      this.remove(list);
    };

    Collection.prototype.removeDataOnly = function () {
      this.remove(this.data.slice());
    };

    /**
     * Remove a document from the collection
     * @param {object} doc - document to remove from collection
     * @memberof Collection
     */
    Collection.prototype.remove = function (doc) {
      if (typeof doc === 'number') {
        doc = this.get(doc);
      }

      if ('object' !== typeof doc) {
        throw new Error('Parameter is not an object');
      }
      if (Array.isArray(doc)) {
        var k = 0,
          len = doc.length;
        for (k; k < len; k += 1) {
          this.remove(doc[k]);
        }
        return;
      }

      if (!hasOwnProperty.call(doc, '$loki')) {
        throw new Error('Object is not a document stored in the collection');
      }

      this.flagBinaryIndexesDirty();

      try {
        this.startTransaction();
        var arr = this.get(doc.$loki, true),
          // obj = arr[0],
          position = arr[1];
        var self = this;
        Object.keys(this.constraints.unique).forEach(function (key) {
          if (doc[key] !== null && typeof doc[key] !== 'undefined') {
            self.constraints.unique[key].remove(doc[key]);
          }
        });
        // now that we can efficiently determine the data[] position of newly added document,
        // submit it for all registered DynamicViews to remove
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].removeDocument(position);
        }

        this.data.splice(position, 1);
        this.removeAutoUpdateObserver(doc);

        // remove id from idIndex
        this.idIndex.splice(position, 1);

        this.commit();
        this.dirty = true; // for autosave scenarios
        this.emit('delete', arr[0]);
        delete doc.$loki;
        delete doc.meta;
        return doc;

      } catch (err) {
        this.rollback();
        this.console.error(err.message);
        this.emit('error', err);
        return null;
      }
    };

    /*---------------------+
    | Finding methods     |
    +----------------------*/

    /**
     * Get by Id - faster than other methods because of the searching algorithm
     * @param {int} id - $loki id of document you want to retrieve
     * @param {boolean} returnPosition - if 'true' we will return [object, position]
     * @returns {(object|array|null)} Object reference if document was found, null if not,
     *     or an array if 'returnPosition' was passed.
     * @memberof Collection
     */
    Collection.prototype.get = function (id, returnPosition) {
      var retpos = returnPosition || false,
        data = this.idIndex,
        max = data.length - 1,
        min = 0,
        mid = (min + max) >> 1;

      id = typeof id === 'number' ? id : parseInt(id, 10);

      if (isNaN(id)) {
        throw new TypeError('Passed id is not an integer');
      }

      while (data[min] < data[max]) {
        mid = (min + max) >> 1;

        if (data[mid] < id) {
          min = mid + 1;
        } else {
          max = mid;
        }
      }

      if (max === min && data[min] === id) {
        if (retpos) {
          return [this.data[min], min];
        }
        return this.data[min];
      }
      return null;

    };

    /**
     * Retrieve doc by Unique index
     * @param {string} field - name of uniquely indexed property to use when doing lookup
     * @param {value} value - unique value to search for
     * @returns {object} document matching the value passed
     * @memberof Collection
     */
    Collection.prototype.by = function (field, value) {
      var self;
      if (value === undefined) {
        self = this;
        return function (value) {
          return self.by(field, value);
        };
      }

      var result = this.constraints.unique[field].get(value);
      if (!this.cloneObjects) {
        return result;
      } else {
        return clone(result, this.cloneMethod);
      }
    };

    /**
     * Find one object by index property, by property equal to value
     * @param {object} query - query object used to perform search with
     * @returns {(object|null)} First matching document, or null if none
     * @memberof Collection
     */
    Collection.prototype.findOne = function (query) {
      // Instantiate Resultset and exec find op passing firstOnly = true param
      var result = new Resultset(this, {
        queryObj: query,
        firstOnly: true
      });
      if (Array.isArray(result) && result.length === 0) {
        return null;
      } else {
        if (!this.cloneObjects) {
          return result;
        } else {
          return clone(result, this.cloneMethod);
        }
      }
    };

    /**
     * Chain method, used for beginning a series of chained find() and/or view() operations
     * on a collection.
     *
     * @param {array} transform - Ordered array of transform step objects similar to chain
     * @param {object} parameters - Object containing properties representing parameters to substitute
     * @returns {Resultset} (this) resultset, or data array if any map or join functions where called
     * @memberof Collection
     */
    Collection.prototype.chain = function (transform, parameters) {
      var rs = new Resultset(this);

      if (typeof transform === 'undefined') {
        return rs;
      }

      return rs.transform(transform, parameters);
    };

    /**
     * Find method, api is similar to mongodb.
     * for more complex queries use [chain()]{@link Collection#chain} or [where()]{@link Collection#where}.
     * @example {@tutorial Query Examples}
     * @param {object} query - 'mongo-like' query object
     * @returns {array} Array of matching documents
     * @memberof Collection
     */
    Collection.prototype.find = function (query) {
      if (typeof (query) === 'undefined') {
        query = 'getAll';
      }

      var results = new Resultset(this, {
        queryObj: query
      });
      if (!this.cloneObjects) {
        return results;
      } else {
        return cloneObjectArray(results, this.cloneMethod);
      }
    };

    /**
     * Find object by unindexed field by property equal to value,
     * simply iterates and returns the first element matching the query
     */
    Collection.prototype.findOneUnindexed = function (prop, value) {
      var i = this.data.length,
        doc;
      while (i--) {
        if (this.data[i][prop] === value) {
          doc = this.data[i];
          return doc;
        }
      }
      return null;
    };

    /**
     * Transaction methods
     */

    /** start the transation */
    Collection.prototype.startTransaction = function () {
      if (this.transactional) {
        this.cachedData = clone(this.data, this.cloneMethod);
        this.cachedIndex = this.idIndex;
        this.cachedBinaryIndex = this.binaryIndices;

        // propagate startTransaction to dynamic views
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].startTransaction();
        }
      }
    };

    /** commit the transation */
    Collection.prototype.commit = function () {
      if (this.transactional) {
        this.cachedData = null;
        this.cachedIndex = null;
        this.cachedBinaryIndex = null;

        // propagate commit to dynamic views
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].commit();
        }
      }
    };

    /** roll back the transation */
    Collection.prototype.rollback = function () {
      if (this.transactional) {
        if (this.cachedData !== null && this.cachedIndex !== null) {
          this.data = this.cachedData;
          this.idIndex = this.cachedIndex;
          this.binaryIndices = this.cachedBinaryIndex;
        }

        // propagate rollback to dynamic views
        for (var idx = 0; idx < this.DynamicViews.length; idx++) {
          this.DynamicViews[idx].rollback();
        }
      }
    };

    // async executor. This is only to enable callbacks at the end of the execution.
    Collection.prototype.async = function (fun, callback) {
      setTimeout(function () {
        if (typeof fun === 'function') {
          fun();
          callback();
        } else {
          throw new TypeError('Argument passed for async execution is not a function');
        }
      }, 0);
    };

    /**
     * Query the collection by supplying a javascript filter function.
     * @example
     * var results = coll.where(function(obj) {
     *   return obj.legs === 8;
     * });
     *
     * @param {function} fun - filter function to run against all collection docs
     * @returns {array} all documents which pass your filter function
     * @memberof Collection
     */
    Collection.prototype.where = function (fun) {
      var results = new Resultset(this, {
        queryFunc: fun
      });
      if (!this.cloneObjects) {
        return results;
      } else {
        return cloneObjectArray(results, this.cloneMethod);
      }
    };

    /**
     * Map Reduce operation
     *
     * @param {function} mapFunction - function to use as map function
     * @param {function} reduceFunction - function to use as reduce function
     * @returns {data} The result of your mapReduce operation
     * @memberof Collection
     */
    Collection.prototype.mapReduce = function (mapFunction, reduceFunction) {
      try {
        return reduceFunction(this.data.map(mapFunction));
      } catch (err) {
        throw err;
      }
    };

    /**
     * Join two collections on specified properties
     *
     * @param {array} joinData - array of documents to 'join' to this collection
     * @param {string} leftJoinProp - property name in collection
     * @param {string} rightJoinProp - property name in joinData
     * @param {function=} mapFun - (Optional) map function to use
     * @returns {Resultset} Result of the mapping operation
     * @memberof Collection
     */
    Collection.prototype.eqJoin = function (joinData, leftJoinProp, rightJoinProp, mapFun) {
      // logic in Resultset class
      return new Resultset(this).eqJoin(joinData, leftJoinProp, rightJoinProp, mapFun);
    };

    /* ------ STAGING API -------- */
    /**
     * stages: a map of uniquely identified 'stages', which hold copies of objects to be
     * manipulated without affecting the data in the original collection
     */
    Collection.prototype.stages = {};

    /**
     * (Staging API) create a stage and/or retrieve it
     * @memberof Collection
     */
    Collection.prototype.getStage = function (name) {
      if (!this.stages[name]) {
        this.stages[name] = {};
      }
      return this.stages[name];
    };
    /**
     * a collection of objects recording the changes applied through a commmitStage
     */
    Collection.prototype.commitLog = [];

    /**
     * (Staging API) create a copy of an object and insert it into a stage
     * @memberof Collection
     */
    Collection.prototype.stage = function (stageName, obj) {
      var copy = JSON.parse(JSON.stringify(obj));
      this.getStage(stageName)[obj.$loki] = copy;
      return copy;
    };

    /**
     * (Staging API) re-attach all objects to the original collection, so indexes and views can be rebuilt
     * then create a message to be inserted in the commitlog
     * @param {string} stageName - name of stage
     * @param {string} message
     * @memberof Collection
     */
    Collection.prototype.commitStage = function (stageName, message) {
      var stage = this.getStage(stageName),
        prop,
        timestamp = new Date().getTime();

      for (prop in stage) {

        this.update(stage[prop]);
        this.commitLog.push({
          timestamp: timestamp,
          message: message,
          data: JSON.parse(JSON.stringify(stage[prop]))
        });
      }
      this.stages[stageName] = {};
    };

    Collection.prototype.no_op = function () {
      return;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.extract = function (field) {
      var i = 0,
        len = this.data.length,
        isDotNotation = isDeepProperty(field),
        result = [];
      for (i; i < len; i += 1) {
        result.push(deepProperty(this.data[i], field, isDotNotation));
      }
      return result;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.max = function (field) {
      return Math.max.apply(null, this.extract(field));
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.min = function (field) {
      return Math.min.apply(null, this.extract(field));
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.maxRecord = function (field) {
      var i = 0,
        len = this.data.length,
        deep = isDeepProperty(field),
        result = {
          index: 0,
          value: undefined
        },
        max;

      for (i; i < len; i += 1) {
        if (max !== undefined) {
          if (max < deepProperty(this.data[i], field, deep)) {
            max = deepProperty(this.data[i], field, deep);
            result.index = this.data[i].$loki;
          }
        } else {
          max = deepProperty(this.data[i], field, deep);
          result.index = this.data[i].$loki;
        }
      }
      result.value = max;
      return result;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.minRecord = function (field) {
      var i = 0,
        len = this.data.length,
        deep = isDeepProperty(field),
        result = {
          index: 0,
          value: undefined
        },
        min;

      for (i; i < len; i += 1) {
        if (min !== undefined) {
          if (min > deepProperty(this.data[i], field, deep)) {
            min = deepProperty(this.data[i], field, deep);
            result.index = this.data[i].$loki;
          }
        } else {
          min = deepProperty(this.data[i], field, deep);
          result.index = this.data[i].$loki;
        }
      }
      result.value = min;
      return result;
    };

    /**
     * @memberof Collection
     */
    Collection.prototype.extractNumerical = function (field) {
      return this.extract(field).map(parseBase10).filter(Number).filter(function (n) {
        return !(isNaN(n));
      });
    };

    /**
     * Calculates the average numerical value of a property
     *
     * @param {string} field - name of property in docs to average
     * @returns {number} average of property in all docs in the collection
     * @memberof Collection
     */
    Collection.prototype.avg = function (field) {
      return average(this.extractNumerical(field));
    };

    /**
     * Calculate standard deviation of a field
     * @memberof Collection
     * @param {string} field
     */
    Collection.prototype.stdDev = function (field) {
      return standardDeviation(this.extractNumerical(field));
    };

    /**
     * @memberof Collection
     * @param {string} field
     */
    Collection.prototype.mode = function (field) {
      var dict = {},
        data = this.extract(field);
      data.forEach(function (obj) {
        if (dict[obj]) {
          dict[obj] += 1;
        } else {
          dict[obj] = 1;
        }
      });
      var max,
        prop, mode;
      for (prop in dict) {
        if (max) {
          if (max < dict[prop]) {
            mode = prop;
          }
        } else {
          mode = prop;
          max = dict[prop];
        }
      }
      return mode;
    };

    /**
     * @memberof Collection
     * @param {string} field - property name
     */
    Collection.prototype.median = function (field) {
      var values = this.extractNumerical(field);
      values.sort(sub);

      var half = Math.floor(values.length / 2);

      if (values.length % 2) {
        return values[half];
      } else {
        return (values[half - 1] + values[half]) / 2.0;
      }
    };

    /**
     * General utils, including statistical functions
     */
    function isDeepProperty(field) {
      return field.indexOf('.') !== -1;
    }

    function parseBase10(num) {
      return parseFloat(num, 10);
    }

    function isNotUndefined(obj) {
      return obj !== undefined;
    }

    function add(a, b) {
      return a + b;
    }

    function sub(a, b) {
      return a - b;
    }

    function median(values) {
      values.sort(sub);
      var half = Math.floor(values.length / 2);
      return (values.length % 2) ? values[half] : ((values[half - 1] + values[half]) / 2.0);
    }

    function average(array) {
      return (array.reduce(add, 0)) / array.length;
    }

    function standardDeviation(values) {
      var avg = average(values);
      var squareDiffs = values.map(function (value) {
        var diff = value - avg;
        var sqrDiff = diff * diff;
        return sqrDiff;
      });

      var avgSquareDiff = average(squareDiffs);

      var stdDev = Math.sqrt(avgSquareDiff);
      return stdDev;
    }

    function deepProperty(obj, property, isDeep) {
      if (isDeep === false) {
        // pass without processing
        return obj[property];
      }
      var pieces = property.split('.'),
        root = obj;
      while (pieces.length > 0) {
        root = root[pieces.shift()];
      }
      return root;
    }

    function binarySearch(array, item, fun) {
      var lo = 0,
        hi = array.length,
        compared,
        mid;
      while (lo < hi) {
        mid = (lo + hi) >> 1;
        compared = fun.apply(null, [item, array[mid]]);
        if (compared === 0) {
          return {
            found: true,
            index: mid
          };
        } else if (compared < 0) {
          hi = mid;
        } else {
          lo = mid + 1;
        }
      }
      return {
        found: false,
        index: hi
      };
    }

    function BSonSort(fun) {
      return function (array, item) {
        return binarySearch(array, item, fun);
      };
    }

    function KeyValueStore() {}

    KeyValueStore.prototype = {
      keys: [],
      values: [],
      sort: function (a, b) {
        return (a < b) ? -1 : ((a > b) ? 1 : 0);
      },
      setSort: function (fun) {
        this.bs = new BSonSort(fun);
      },
      bs: function () {
        return new BSonSort(this.sort);
      },
      set: function (key, value) {
        var pos = this.bs(this.keys, key);
        if (pos.found) {
          this.values[pos.index] = value;
        } else {
          this.keys.splice(pos.index, 0, key);
          this.values.splice(pos.index, 0, value);
        }
      },
      get: function (key) {
        return this.values[binarySearch(this.keys, key, this.sort).index];
      }
    };

    function UniqueIndex(uniqueField) {
      this.field = uniqueField;
      this.keyMap = {};
      this.lokiMap = {};
    }
    UniqueIndex.prototype.keyMap = {};
    UniqueIndex.prototype.lokiMap = {};
    UniqueIndex.prototype.set = function (obj) {
      var fieldValue = obj[this.field];
      if (fieldValue !== null && typeof (fieldValue) !== 'undefined') {
        if (this.keyMap[fieldValue]) {
          throw new Error('Duplicate key for property ' + this.field + ': ' + fieldValue);
        } else {
          this.keyMap[fieldValue] = obj;
          this.lokiMap[obj.$loki] = fieldValue;
        }
      }
    };
    UniqueIndex.prototype.get = function (key) {
      return this.keyMap[key];
    };

    UniqueIndex.prototype.byId = function (id) {
      return this.keyMap[this.lokiMap[id]];
    };
    /**
     * Updates a document's unique index given an updated object.
     * @param  {Object} obj Original document object
     * @param  {Object} doc New document object (likely the same as obj)
     */
    UniqueIndex.prototype.update = function (obj, doc) {
      if (this.lokiMap[obj.$loki] !== doc[this.field]) {
        var old = this.lokiMap[obj.$loki];
        this.set(doc);
        // make the old key fail bool test, while avoiding the use of delete (mem-leak prone)
        this.keyMap[old] = undefined;
      } else {
        this.keyMap[obj[this.field]] = doc;
      }
    };
    UniqueIndex.prototype.remove = function (key) {
      var obj = this.keyMap[key];
      if (obj !== null && typeof obj !== 'undefined') {
        this.keyMap[key] = undefined;
        this.lokiMap[obj.$loki] = undefined;
      } else {
        throw new Error('Key is not in unique index: ' + this.field);
      }
    };
    UniqueIndex.prototype.clear = function () {
      this.keyMap = {};
      this.lokiMap = {};
    };

    function ExactIndex(exactField) {
      this.index = {};
      this.field = exactField;
    }

    // add the value you want returned to the key in the index
    ExactIndex.prototype = {
      set: function add(key, val) {
        if (this.index[key]) {
          this.index[key].push(val);
        } else {
          this.index[key] = [val];
        }
      },

      // remove the value from the index, if the value was the last one, remove the key
      remove: function remove(key, val) {
        var idxSet = this.index[key];
        for (var i in idxSet) {
          if (idxSet[i] == val) {
            idxSet.splice(i, 1);
          }
        }
        if (idxSet.length < 1) {
          this.index[key] = undefined;
        }
      },

      // get the values related to the key, could be more than one
      get: function get(key) {
        return this.index[key];
      },

      // clear will zap the index
      clear: function clear(key) {
        this.index = {};
      }
    };

    function SortedIndex(sortedField) {
      this.field = sortedField;
    }

    SortedIndex.prototype = {
      keys: [],
      values: [],
      // set the default sort
      sort: function (a, b) {
        return (a < b) ? -1 : ((a > b) ? 1 : 0);
      },
      bs: function () {
        return new BSonSort(this.sort);
      },
      // and allow override of the default sort
      setSort: function (fun) {
        this.bs = new BSonSort(fun);
      },
      // add the value you want returned  to the key in the index
      set: function (key, value) {
        var pos = binarySearch(this.keys, key, this.sort);
        if (pos.found) {
          this.values[pos.index].push(value);
        } else {
          this.keys.splice(pos.index, 0, key);
          this.values.splice(pos.index, 0, [value]);
        }
      },
      // get all values which have a key == the given key
      get: function (key) {
        var bsr = binarySearch(this.keys, key, this.sort);
        if (bsr.found) {
          return this.values[bsr.index];
        } else {
          return [];
        }
      },
      // get all values which have a key < the given key
      getLt: function (key) {
        var bsr = binarySearch(this.keys, key, this.sort);
        var pos = bsr.index;
        if (bsr.found) pos--;
        return this.getAll(key, 0, pos);
      },
      // get all values which have a key > the given key
      getGt: function (key) {
        var bsr = binarySearch(this.keys, key, this.sort);
        var pos = bsr.index;
        if (bsr.found) pos++;
        return this.getAll(key, pos, this.keys.length);
      },

      // get all vals from start to end
      getAll: function (key, start, end) {
        var results = [];
        for (var i = start; i < end; i++) {
          results = results.concat(this.values[i]);
        }
        return results;
      },
      // just in case someone wants to do something smart with ranges
      getPos: function (key) {
        return binarySearch(this.keys, key, this.sort);
      },
      // remove the value from the index, if the value was the last one, remove the key
      remove: function (key, value) {
        var pos = binarySearch(this.keys, key, this.sort).index;
        var idxSet = this.values[pos];
        for (var i in idxSet) {
          if (idxSet[i] == value) idxSet.splice(i, 1);
        }
        if (idxSet.length < 1) {
          this.keys.splice(pos, 1);
          this.values.splice(pos, 1);
        }
      },
      // clear will zap the index
      clear: function () {
        this.keys = [];
        this.values = [];
      }
    };


    Loki.LokiOps = LokiOps;
    Loki.Collection = Collection;
    Loki.KeyValueStore = KeyValueStore;
    Loki.persistenceAdapters = {
      fs: LokiFsAdapter,
      localStorage: LokiLocalStorageAdapter
    };
    return Loki;
  }());

}));

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}},"object-path":{"index.js":function(require,exports,module){

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//                                                                                                                     //
// node_modules/meteor/rocketchat_lib/node_modules/object-path/index.js                                                //
//                                                                                                                     //
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
                                                                                                                       //
(function (root, factory){
  'use strict';

  /*istanbul ignore next:cant test*/
  if (typeof module === 'object' && typeof module.exports === 'object') {
    module.exports = factory();
  } else if (typeof define === 'function' && define.amd) {
    // AMD. Register as an anonymous module.
    define([], factory);
  } else {
    // Browser globals
    root.objectPath = factory();
  }
})(this, function(){
  'use strict';

  var
    toStr = Object.prototype.toString,
    _hasOwnProperty = Object.prototype.hasOwnProperty;

  function isEmpty(value){
    if (!value) {
      return true;
    }
    if (isArray(value) && value.length === 0) {
        return true;
    } else if (!isString(value)) {
        for (var i in value) {
            if (_hasOwnProperty.call(value, i)) {
                return false;
            }
        }
        return true;
    }
    return false;
  }

  function toString(type){
    return toStr.call(type);
  }

  function isNumber(value){
    return typeof value === 'number' || toString(value) === "[object Number]";
  }

  function isString(obj){
    return typeof obj === 'string' || toString(obj) === "[object String]";
  }

  function isObject(obj){
    return typeof obj === 'object' && toString(obj) === "[object Object]";
  }

  function isArray(obj){
    return typeof obj === 'object' && typeof obj.length === 'number' && toString(obj) === '[object Array]';
  }

  function isBoolean(obj){
    return typeof obj === 'boolean' || toString(obj) === '[object Boolean]';
  }

  function getKey(key){
    var intKey = parseInt(key);
    if (intKey.toString() === key) {
      return intKey;
    }
    return key;
  }

  function set(obj, path, value, doNotReplace){
    if (isNumber(path)) {
      path = [path];
    }
    if (isEmpty(path)) {
      return obj;
    }
    if (isString(path)) {
      return set(obj, path.split('.').map(getKey), value, doNotReplace);
    }
    var currentPath = path[0];

    if (path.length === 1) {
      var oldVal = obj[currentPath];
      if (oldVal === void 0 || !doNotReplace) {
        obj[currentPath] = value;
      }
      return oldVal;
    }

    if (obj[currentPath] === void 0) {
      //check if we assume an array
      if(isNumber(path[1])) {
        obj[currentPath] = [];
      } else {
        obj[currentPath] = {};
      }
    }

    return set(obj[currentPath], path.slice(1), value, doNotReplace);
  }

  function del(obj, path) {
    if (isNumber(path)) {
      path = [path];
    }

    if (isEmpty(obj)) {
      return void 0;
    }

    if (isEmpty(path)) {
      return obj;
    }
    if(isString(path)) {
      return del(obj, path.split('.'));
    }

    var currentPath = getKey(path[0]);
    var oldVal = obj[currentPath];

    if(path.length === 1) {
      if (oldVal !== void 0) {
        if (isArray(obj)) {
          obj.splice(currentPath, 1);
        } else {
          delete obj[currentPath];
        }
      }
    } else {
      if (obj[currentPath] !== void 0) {
        return del(obj[currentPath], path.slice(1));
      }
    }

    return obj;
  }

  var objectPath = function(obj) {
    return Object.keys(objectPath).reduce(function(proxy, prop) {
      if (typeof objectPath[prop] === 'function') {
        proxy[prop] = objectPath[prop].bind(objectPath, obj);
      }

      return proxy;
    }, {});
  };

  objectPath.has = function (obj, path) {
    if (isEmpty(obj)) {
      return false;
    }

    if (isNumber(path)) {
      path = [path];
    } else if (isString(path)) {
      path = path.split('.');
    }

    if (isEmpty(path) || path.length === 0) {
      return false;
    }

    for (var i = 0; i < path.length; i++) {
      var j = path[i];
      if ((isObject(obj) || isArray(obj)) && _hasOwnProperty.call(obj, j)) {
        obj = obj[j];
      } else {
        return false;
      }
    }

    return true;
  };

  objectPath.ensureExists = function (obj, path, value){
    return set(obj, path, value, true);
  };

  objectPath.set = function (obj, path, value, doNotReplace){
    return set(obj, path, value, doNotReplace);
  };

  objectPath.insert = function (obj, path, value, at){
    var arr = objectPath.get(obj, path);
    at = ~~at;
    if (!isArray(arr)) {
      arr = [];
      objectPath.set(obj, path, arr);
    }
    arr.splice(at, 0, value);
  };

  objectPath.empty = function(obj, path) {
    if (isEmpty(path)) {
      return obj;
    }
    if (isEmpty(obj)) {
      return void 0;
    }

    var value, i;
    if (!(value = objectPath.get(obj, path))) {
      return obj;
    }

    if (isString(value)) {
      return objectPath.set(obj, path, '');
    } else if (isBoolean(value)) {
      return objectPath.set(obj, path, false);
    } else if (isNumber(value)) {
      return objectPath.set(obj, path, 0);
    } else if (isArray(value)) {
      value.length = 0;
    } else if (isObject(value)) {
      for (i in value) {
        if (_hasOwnProperty.call(value, i)) {
          delete value[i];
        }
      }
    } else {
      return objectPath.set(obj, path, null);
    }
  };

  objectPath.push = function (obj, path /*, values */){
    var arr = objectPath.get(obj, path);
    if (!isArray(arr)) {
      arr = [];
      objectPath.set(obj, path, arr);
    }

    arr.push.apply(arr, Array.prototype.slice.call(arguments, 2));
  };

  objectPath.coalesce = function (obj, paths, defaultValue) {
    var value;

    for (var i = 0, len = paths.length; i < len; i++) {
      if ((value = objectPath.get(obj, paths[i])) !== void 0) {
        return value;
      }
    }

    return defaultValue;
  };

  objectPath.get = function (obj, path, defaultValue){
    if (isNumber(path)) {
      path = [path];
    }
    if (isEmpty(path)) {
      return obj;
    }
    if (isEmpty(obj)) {
      return defaultValue;
    }
    if (isString(path)) {
      return objectPath.get(obj, path.split('.'), defaultValue);
    }

    var currentPath = getKey(path[0]);

    if (path.length === 1) {
      if (obj[currentPath] === void 0) {
        return defaultValue;
      }
      return obj[currentPath];
    }

    return objectPath.get(obj[currentPath], path.slice(1), defaultValue);
  };

  objectPath.del = function(obj, path) {
    return del(obj, path);
  };

  return objectPath;
});

/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

}}}}}}},{
  "extensions": [
    ".js",
    ".json",
    ".info"
  ]
});
require("./node_modules/meteor/rocketchat:lib/lib/core.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/debug.js");
require("./node_modules/meteor/rocketchat:lib/lib/getURL.js");
require("./node_modules/meteor/rocketchat:lib/lib/settings.js");
require("./node_modules/meteor/rocketchat:lib/lib/callbacks.js");
require("./node_modules/meteor/rocketchat:lib/lib/fileUploadRestrictions.js");
require("./node_modules/meteor/rocketchat:lib/lib/getValidRoomName.js");
require("./node_modules/meteor/rocketchat:lib/lib/placeholders.js");
require("./node_modules/meteor/rocketchat:lib/lib/promises.js");
require("./node_modules/meteor/rocketchat:lib/lib/roomTypesCommon.js");
require("./node_modules/meteor/rocketchat:lib/lib/slashCommand.js");
require("./node_modules/meteor/rocketchat:lib/lib/Message.js");
require("./node_modules/meteor/rocketchat:lib/lib/messageBox.js");
require("./node_modules/meteor/rocketchat:lib/lib/MessageTypes.js");
require("./node_modules/meteor/rocketchat:lib/lib/templateVarHandler.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/bugsnag.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/metrics.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/RateLimiter.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/isDocker.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/addUserToDefaultChannels.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/addUserToRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/archiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/checkUsernameAvailability.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/checkEmailAvailability.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/createRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/deleteMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/deleteUser.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/getFullUserData.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/getRoomByNameOrIdWithOptionToJoin.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/removeUserFromRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/saveUser.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/saveCustomFields.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/saveCustomFieldsWithoutValidation.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/sendMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/settings.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/setUserAvatar.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/setUsername.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/setRealName.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/setEmail.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/unarchiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/updateMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/validateCustomFields.js");
require("./node_modules/meteor/rocketchat:lib/server/functions/Notifications.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/configLogger.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/PushNotification.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/defaultBlockedDomainsList.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/interceptDirectReplyEmails.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/loginErrorMessageOverride.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/notifyUsersOnMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/processDirectEmail.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/roomTypes.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/sendEmailOnMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/sendNotificationsOnMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/lib/validateEmailDomain.js");
require("./node_modules/meteor/rocketchat:lib/server/models/_Base.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Avatars.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Messages.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Reports.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Rooms.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Settings.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Subscriptions.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Uploads.js");
require("./node_modules/meteor/rocketchat:lib/server/models/Users.js");
require("./node_modules/meteor/rocketchat:lib/server/oauth/oauth.js");
require("./node_modules/meteor/rocketchat:lib/server/oauth/google.js");
require("./node_modules/meteor/rocketchat:lib/server/oauth/proxy.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/statsTracker.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/cache/CacheLoad.js");
require("./node_modules/meteor/rocketchat:lib/server/publications/settings.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/addOAuthService.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/refreshOAuthService.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/addUserToRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/addUsersToRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/archiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/blockUser.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/checkRegistrationSecretURL.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/checkUsernameAvailability.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/cleanChannelHistory.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/createChannel.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/createToken.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/createPrivateGroup.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/deleteMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/deleteUserOwnAccount.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/filterBadWords.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/filterATAllTag.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getChannelHistory.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getFullUserData.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getRoomJoinCode.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getRoomRoles.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getServerInfo.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getSingleMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/getUserRoles.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/insertOrUpdateUser.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/joinDefaultChannels.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/joinRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/leaveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/removeOAuthService.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/restartServer.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/robotMethods.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/saveSetting.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/sendInvitationEmail.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/sendMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/sendSMTPTestEmail.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setAdminStatus.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setRealName.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setUsername.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/setEmail.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/unarchiveRoom.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/unblockUser.js");
require("./node_modules/meteor/rocketchat:lib/server/methods/updateMessage.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/settingsOnLoadCdnPrefix.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/settingsOnLoadDirectReply.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/settingsOnLoadSMTP.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/oAuthServicesUpdate.js");
require("./node_modules/meteor/rocketchat:lib/server/startup/settings.js");
require("./node_modules/meteor/rocketchat:lib/lib/startup/settingsOnLoadSiteUrl.js");
require("./node_modules/meteor/rocketchat:lib/startup/defaultRoomTypes.js");
require("./node_modules/meteor/rocketchat:lib/rocketchat.info.js");

/* Exports */
if (typeof Package === 'undefined') Package = {};
(function (pkg, symbols) {
  for (var s in symbols)
    (s in pkg) || (pkg[s] = symbols[s]);
})(Package['rocketchat:lib'] = {}, {
  RocketChat: RocketChat,
  RocketChatTabBar: RocketChatTabBar
});

})();

//# sourceMappingURL=rocketchat_lib.js.map
