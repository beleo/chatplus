{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:cors/cors.js","meteor://ðŸ’»app/packages/rocketchat:cors/common.js"],"names":["url","module","watch","require","v","WebApp","rawConnectHandlers","use","Meteor","bindEnvironment","req","res","next","_body","headers","undefined","isNaN","indexOf","__meteor_runtime_config__","ROOT_URL_PATH_PREFIX","buf","setEncoding","on","chunk","RocketChat","debugLevel","console","log","green","method","body","JSON","parse","error","test","setHeader","key","val","toLowerCase","apply","arguments","_staticFilesMiddleware","WebAppInternals","staticFilesMiddleware","staticFiles","oldHttpServerListeners","httpServer","listeners","slice","removeAllListeners","addListener","oldListener","settings","get","remoteAddress","connection","socket","localhostRegexp","localhostTest","x","isLocal","_","all","split","isSsl","pair","host","absoluteUrl","hostname","replace","writeHead","end","startup","onload","value","defaultOptions","secure"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,IAAIA,YAAJ;AAAQC,OAAOC,KAAP,CAAaC,QAAQ,KAAR,CAAb,EAA4B;AAAA,sBAASC,CAAT,EAAW;AAACJ,QAAII,CAAJ;AAAM;AAAlB,CAA5B,EAAgD,CAAhD;AAIRC,OAAOC,kBAAP,CAA0BC,GAA1B,CAA8BC,OAAOC,eAAP,CAAuB,UAASC,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AAC7E,KAAIF,IAAIG,KAAR,EAAe;AACd,SAAOD,MAAP;AACA;;AACD,KAAIF,IAAII,OAAJ,CAAY,mBAAZ,MAAqCC,SAArC,IAAkDC,MAAMN,IAAII,OAAJ,CAAY,gBAAZ,CAAN,CAAtD,EAA4F;AAC3F,SAAOF,MAAP;AACA;;AACD,KAAIF,IAAII,OAAJ,CAAY,cAAZ,MAAgC,EAAhC,IAAsCJ,IAAII,OAAJ,CAAY,cAAZ,MAAgCC,SAA1E,EAAqF;AACpF,SAAOH,MAAP;AACA;;AACD,KAAIF,IAAIV,GAAJ,CAAQiB,OAAR,CAAoBC,0BAA0BC,oBAA9C,gBAAgF,CAApF,EAAuF;AACtF,SAAOP,MAAP;AACA;;AAED,KAAIQ,MAAM,EAAV;AACAV,KAAIW,WAAJ,CAAgB,MAAhB;AACAX,KAAIY,EAAJ,CAAO,MAAP,EAAe,UAASC,KAAT,EAAgB;AAC9B,SAAOH,OAAOG,KAAd;AACA,EAFD;AAIAb,KAAIY,EAAJ,CAAO,KAAP,EAAc,YAAW;AACxB,MAAIE,cAAcA,WAAWC,UAAX,KAA0B,OAA5C,EAAqD;AACpDC,WAAQC,GAAR,CAAY,YAAYC,KAAxB,EAA+BlB,IAAImB,MAAnC,EAA2CnB,IAAIV,GAA/C,EAAoD,cAApD,EAAoEU,IAAII,OAAxE,EAAiF,WAAjF,EAA8FM,GAA9F;AACA;;AAED,MAAI;AACHV,OAAIoB,IAAJ,GAAWC,KAAKC,KAAL,CAAWZ,GAAX,CAAX;AACA,GAFD,CAEE,OAAOa,KAAP,EAAc;AACfvB,OAAIoB,IAAJ,GAAWV,GAAX;AACA;;AACDV,MAAIG,KAAJ,GAAY,IAAZ;AAEA,SAAOD,MAAP;AACA,EAbD;AAcA,CAlC6B,CAA9B;AAoCAP,OAAOC,kBAAP,CAA0BC,GAA1B,CAA8B,UAASG,GAAT,EAAcC,GAAd,EAAmBC,IAAnB,EAAyB;AACtD,KAAI,qDAAqDsB,IAArD,CAA0DxB,IAAIV,GAA9D,CAAJ,EAAwE;AACvEW,MAAIwB,SAAJ,CAAc,6BAAd,EAA6C,GAA7C;AACA;;AAED,KAAMA,YAAYxB,IAAIwB,SAAtB;;AACAxB,KAAIwB,SAAJ,GAAgB,UAASC,GAAT,EAAcC,GAAd,EAAmB;AAClC,MAAID,IAAIE,WAAJ,OAAsB,6BAAtB,IAAuDD,QAAQ,qBAAnE,EAA0F;AACzF;AACA;;AACD,SAAOF,UAAUI,KAAV,CAAgB,IAAhB,EAAsBC,SAAtB,CAAP;AACA,EALD;;AAMA,QAAO5B,MAAP;AACA,CAbD;AAeA,IAAM6B,yBAAyBC,gBAAgBC,qBAA/C;;AAEAD,gBAAgBD,sBAAhB,GAAyC,UAASG,WAAT,EAAsBlC,GAAtB,EAA2BC,GAA3B,EAAgCC,IAAhC,EAAsC;AAC9ED,KAAIwB,SAAJ,CAAc,6BAAd,EAA6C,GAA7C;AACA,QAAOM,uBAAuBG,WAAvB,EAAoClC,GAApC,EAAyCC,GAAzC,EAA8CC,IAA9C,CAAP;AACA,CAHD;;AAKA,IAAMiC,yBAAyBxC,OAAOyC,UAAP,CAAkBC,SAAlB,CAA4B,SAA5B,EAAuCC,KAAvC,CAA6C,CAA7C,CAA/B;AAEA3C,OAAOyC,UAAP,CAAkBG,kBAAlB,CAAqC,SAArC;AAEA5C,OAAOyC,UAAP,CAAkBI,WAAlB,CAA8B,SAA9B,EAAyC,UAASxC,GAAT,EAAcC,GAAd,EAAmB;AAAA;;AAC3D,KAAMC,OAAO,YAAM;AAClB,uBAA0BiC,sBAA1B,kHAAkD;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA,OAAvCM,WAAuC;AACjDA,eAAYZ,KAAZ,CAAkBlC,OAAOyC,UAAzB;AACA;AACD,EAJD;;AAMA,KAAItB,WAAW4B,QAAX,CAAoBC,GAApB,CAAwB,WAAxB,MAAyC,IAA7C,EAAmD;AAClDzC;AACA;AACA;;AAED,KAAM0C,gBAAgB5C,IAAI6C,UAAJ,CAAeD,aAAf,IAAgC5C,IAAI8C,MAAJ,CAAWF,aAAjE;AACA,KAAMG,kBAAkB,4BAAxB;;AACA,KAAMC,gBAAgB,UAASC,CAAT,EAAY;AACjC,SAAOF,gBAAgBvB,IAAhB,CAAqByB,CAArB,CAAP;AACA,EAFD;;AAIA,KAAMC,UAAUH,gBAAgBvB,IAAhB,CAAqBoB,aAArB,MAAwC,CAAC5C,IAAII,OAAJ,CAAY,iBAAZ,CAAD,IAAmC+C,EAAEC,GAAF,CAAMpD,IAAII,OAAJ,CAAY,iBAAZ,EAA+BiD,KAA/B,CAAqC,GAArC,CAAN,EAAiDL,aAAjD,CAA3E,CAAhB;;AACA,KAAMM,QAAQtD,IAAI6C,UAAJ,CAAeU,IAAf,IAAwBvD,IAAII,OAAJ,CAAY,mBAAZ,KAAoCJ,IAAII,OAAJ,CAAY,mBAAZ,EAAiCG,OAAjC,CAAyC,OAAzC,MAAsD,CAAC,CAAjI;;AAEA,KAAIO,cAAcA,WAAWC,UAAX,KAA0B,OAA5C,EAAqD;AACpDC,UAAQC,GAAR,CAAY,SAAZ,EAAuBjB,IAAIV,GAA3B;AACA0B,UAAQC,GAAR,CAAY,eAAZ,EAA6B2B,aAA7B;AACA5B,UAAQC,GAAR,CAAY,SAAZ,EAAuBiC,OAAvB;AACAlC,UAAQC,GAAR,CAAY,OAAZ,EAAqBqC,KAArB;AACAtC,UAAQC,GAAR,CAAY,aAAZ,EAA2BjB,IAAII,OAA/B;AACA;;AAED,KAAI,CAAC8C,OAAD,IAAY,CAACI,KAAjB,EAAwB;AACvB,MAAIE,OAAOxD,IAAII,OAAJ,CAAY,MAAZ,KAAuBd,IAAIgC,KAAJ,CAAUxB,OAAO2D,WAAP,EAAV,EAAgCC,QAAlE;AACAF,SAAOA,KAAKG,OAAL,CAAa,OAAb,EAAsB,EAAtB,CAAP;AACA1D,MAAI2D,SAAJ,CAAc,GAAd,EAAmB;AAClB,4BAAwBJ,IAAxB,GAAiCxD,IAAIV;AADnB,GAAnB;AAGAW,MAAI4D,GAAJ;AACA;AACA;;AAED,QAAO3D,MAAP;AACA,CAxCD,4G;;;;;;;;;;;AClEAJ,OAAOgE,OAAP,CAAe,YAAW;AACzBhD,YAAW4B,QAAX,CAAoBqB,MAApB,CAA2B,WAA3B,EAAwC,UAASrC,GAAT,EAAcsC,KAAd,EAAqB;AAC5DlE,SAAO2D,WAAP,CAAmBQ,cAAnB,CAAkCC,MAAlC,GAA2CF,KAA3C;AACA,EAFD;AAGA,CAJD,0G","file":"/packages/rocketchat_cors.js","sourcesContent":["/* globals WebAppInternals */\n\nimport url from 'url';\n\nWebApp.rawConnectHandlers.use(Meteor.bindEnvironment(function(req, res, next) {\n\tif (req._body) {\n\t\treturn next();\n\t}\n\tif (req.headers['transfer-encoding'] === undefined && isNaN(req.headers['content-length'])) {\n\t\treturn next();\n\t}\n\tif (req.headers['content-type'] !== '' && req.headers['content-type'] !== undefined) {\n\t\treturn next();\n\t}\n\tif (req.url.indexOf(`${ __meteor_runtime_config__.ROOT_URL_PATH_PREFIX }/ufs/`) === 0) {\n\t\treturn next();\n\t}\n\n\tlet buf = '';\n\treq.setEncoding('utf8');\n\treq.on('data', function(chunk) {\n\t\treturn buf += chunk;\n\t});\n\n\treq.on('end', function() {\n\t\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\t\tconsole.log('[request]'.green, req.method, req.url, '\\nheaders ->', req.headers, '\\nbody ->', buf);\n\t\t}\n\n\t\ttry {\n\t\t\treq.body = JSON.parse(buf);\n\t\t} catch (error) {\n\t\t\treq.body = buf;\n\t\t}\n\t\treq._body = true;\n\n\t\treturn next();\n\t});\n}));\n\nWebApp.rawConnectHandlers.use(function(req, res, next) {\n\tif (/^\\/(api|_timesync|sockjs|tap-i18n|__cordova)(\\/|$)/.test(req.url)) {\n\t\tres.setHeader('Access-Control-Allow-Origin', '*');\n\t}\n\n\tconst setHeader = res.setHeader;\n\tres.setHeader = function(key, val) {\n\t\tif (key.toLowerCase() === 'access-control-allow-origin' && val === 'http://meteor.local') {\n\t\t\treturn;\n\t\t}\n\t\treturn setHeader.apply(this, arguments);\n\t};\n\treturn next();\n});\n\nconst _staticFilesMiddleware = WebAppInternals.staticFilesMiddleware;\n\nWebAppInternals._staticFilesMiddleware = function(staticFiles, req, res, next) {\n\tres.setHeader('Access-Control-Allow-Origin', '*');\n\treturn _staticFilesMiddleware(staticFiles, req, res, next);\n};\n\nconst oldHttpServerListeners = WebApp.httpServer.listeners('request').slice(0);\n\nWebApp.httpServer.removeAllListeners('request');\n\nWebApp.httpServer.addListener('request', function(req, res) {\n\tconst next = () => {\n\t\tfor (const oldListener of oldHttpServerListeners) {\n\t\t\toldListener.apply(WebApp.httpServer, arguments);\n\t\t}\n\t};\n\n\tif (RocketChat.settings.get('Force_SSL') !== true) {\n\t\tnext();\n\t\treturn;\n\t}\n\n\tconst remoteAddress = req.connection.remoteAddress || req.socket.remoteAddress;\n\tconst localhostRegexp = /^\\s*(127\\.0\\.0\\.1|::1)\\s*$/;\n\tconst localhostTest = function(x) {\n\t\treturn localhostRegexp.test(x);\n\t};\n\n\tconst isLocal = localhostRegexp.test(remoteAddress) && (!req.headers['x-forwarded-for'] || _.all(req.headers['x-forwarded-for'].split(','), localhostTest));\n\tconst isSsl = req.connection.pair || (req.headers['x-forwarded-proto'] && req.headers['x-forwarded-proto'].indexOf('https') !== -1);\n\n\tif (RocketChat && RocketChat.debugLevel === 'debug') {\n\t\tconsole.log('req.url', req.url);\n\t\tconsole.log('remoteAddress', remoteAddress);\n\t\tconsole.log('isLocal', isLocal);\n\t\tconsole.log('isSsl', isSsl);\n\t\tconsole.log('req.headers', req.headers);\n\t}\n\n\tif (!isLocal && !isSsl) {\n\t\tlet host = req.headers['host'] || url.parse(Meteor.absoluteUrl()).hostname;\n\t\thost = host.replace(/:\\d+$/, '');\n\t\tres.writeHead(302, {\n\t\t\t'Location': `https://${ host }${ req.url }`\n\t\t});\n\t\tres.end();\n\t\treturn;\n\t}\n\n\treturn next();\n});\n","Meteor.startup(function() {\n\tRocketChat.settings.onload('Force_SSL', function(key, value) {\n\t\tMeteor.absoluteUrl.defaultOptions.secure = value;\n\t});\n});\n"]}