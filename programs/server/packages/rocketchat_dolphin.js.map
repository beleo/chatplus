{"version":3,"sources":["meteor://ðŸ’»app/packages/rocketchat:dolphin/common.js","meteor://ðŸ’»app/packages/rocketchat:dolphin/startup.js"],"names":["config","serverURL","authorizePath","tokenPath","identityPath","scope","addAutopublishFields","forLoggedInUser","forOtherUsers","Dolphin","CustomOAuth","DolphinOnCreateUser","options","user","services","dolphin","NickName","username","replace","Meteor","isServer","startup","RocketChat","models","Settings","find","_id","observe","added","settings","get","configure","changed","data","buttonLabelText","buttonColor","buttonLabelColor","clientId","secret","loginStyle","siteName","ServiceConfiguration","configurations","upsert","service","$set","callbacks","add","priority","HIGH","Tracker","autorun","type","group","section","i18nLabel","persistent","values","key"],"mappings":"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","file":"/packages/rocketchat_dolphin.js","sourcesContent":["// Dolphin OAuth2\n/* globals CustomOAuth */\n\nconst config = {\n\tserverURL: '',\n\tauthorizePath: '/m/oauth2/auth/',\n\ttokenPath: '/m/oauth2/token/',\n\tidentityPath: '/m/oauth2/api/me/',\n\tscope: 'basic',\n\taddAutopublishFields: {\n\t\tforLoggedInUser: ['services.dolphin'],\n\t\tforOtherUsers: ['services.dolphin.name']\n\t}\n};\n\nconst Dolphin = new CustomOAuth('dolphin', config);\n\nfunction DolphinOnCreateUser(options, user) {\n\tif (user && user.services && user.services.dolphin && user.services.dolphin.NickName) {\n\t\tuser.username = user.services.dolphin.NickName.replace(/[^A-Za-z0-9]/g, '.').replace(/\\.+/g, '.').replace(/(^\\.)|(\\.$)/g, '');\n\t}\n\treturn user;\n}\n\nif (Meteor.isServer) {\n\tMeteor.startup(() =>\n\t\tRocketChat.models.Settings.find({ _id: 'Accounts_OAuth_Dolphin_URL' }).observe({\n\t\t\tadded() {\n\t\t\t\tconfig.serverURL = RocketChat.settings.get('Accounts_OAuth_Dolphin_URL');\n\t\t\t\treturn Dolphin.configure(config);\n\t\t\t},\n\t\t\tchanged() {\n\t\t\t\tconfig.serverURL = RocketChat.settings.get('Accounts_OAuth_Dolphin_URL');\n\t\t\t\treturn Dolphin.configure(config);\n\t\t\t}\n\t\t})\n\t);\n\n\tif (RocketChat.settings.get('Accounts_OAuth_Dolphin_URL')) {\n\t\tconst data = {\n\t\t\tbuttonLabelText: RocketChat.settings.get('Accounts_OAuth_Dolphin_button_label_text'),\n\t\t\tbuttonColor: RocketChat.settings.get('Accounts_OAuth_Dolphin_button_color'),\n\t\t\tbuttonLabelColor: RocketChat.settings.get('Accounts_OAuth_Dolphin_button_label_color'),\n\t\t\tclientId: RocketChat.settings.get('Accounts_OAuth_Dolphin_id'),\n\t\t\tsecret: RocketChat.settings.get('Accounts_OAuth_Dolphin_secret'),\n\t\t\tserverURL: RocketChat.settings.get('Accounts_OAuth_Dolphin_URL'),\n\t\t\tloginStyle: RocketChat.settings.get('Accounts_OAuth_Dolphin_login_style'),\n\t\t\tsiteName: RocketChat.settings.get('Accounts_OAuth_Dolphin_Site_Name')\n\t\t};\n\n\t\tServiceConfiguration.configurations.upsert({service: 'dolphin'}, {$set: data});\n\t}\n\n\tRocketChat.callbacks.add('beforeCreateUser', DolphinOnCreateUser, RocketChat.callbacks.priority.HIGH);\n} else {\n\tMeteor.startup(() =>\n\t\tTracker.autorun(function() {\n\t\t\tif (RocketChat.settings.get('Accounts_OAuth_Dolphin_URL')) {\n\t\t\t\tconfig.serverURL = RocketChat.settings.get('Accounts_OAuth_Dolphin_URL');\n\t\t\t\treturn Dolphin.configure(config);\n\t\t\t}\n\t\t})\n\t);\n}\n","RocketChat.settings.add('Accounts_OAuth_Dolphin_URL', '', { type: 'string', group: 'OAuth', public: true, section: 'Dolphin', i18nLabel: 'URL' });\nRocketChat.settings.add('Accounts_OAuth_Dolphin_Site_Name', 'Dolphin', { type: 'string', group: 'OAuth', public: true, section: 'Dolphin', i18nLabel: 'Site_Name' });\nRocketChat.settings.add('Accounts_OAuth_Dolphin', false, { type: 'boolean', group: 'OAuth', section: 'Dolphin', i18nLabel: 'Accounts_OAuth_Custom_Enable' });\nRocketChat.settings.add('Accounts_OAuth_Dolphin_id', '', { type: 'string', group: 'OAuth', section: 'Dolphin', i18nLabel: 'Accounts_OAuth_Custom_id' });\nRocketChat.settings.add('Accounts_OAuth_Dolphin_secret', '', { type: 'string', group: 'OAuth', section: 'Dolphin', i18nLabel: 'Accounts_OAuth_Custom_Secret' });\nRocketChat.settings.add('Accounts_OAuth_Dolphin_login_style', 'redirect', { type: 'select', group: 'OAuth', section: 'Dolphin', i18nLabel: 'Accounts_OAuth_Custom_Login_Style', persistent: true, values: [ { key: 'redirect', i18nLabel: 'Redirect' }, { key: 'popup', i18nLabel: 'Popup' }, { key: '', i18nLabel: 'Default' } ] });\nRocketChat.settings.add('Accounts_OAuth_Dolphin_button_label_text', '', { type: 'string', group: 'OAuth', section: 'Dolphin', i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Text', persistent: true });\nRocketChat.settings.add('Accounts_OAuth_Dolphin_button_label_color', '#FFFFFF', { type: 'string', group: 'OAuth', section: 'Dolphin', i18nLabel: 'Accounts_OAuth_Custom_Button_Label_Color', persistent: true });\nRocketChat.settings.add('Accounts_OAuth_Dolphin_button_color', '#13679A', { type: 'string', group: 'OAuth', section: 'Dolphin', i18nLabel: 'Accounts_OAuth_Custom_Button_Color', persistent: true });\n"]}